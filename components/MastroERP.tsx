"use client";
// =======================================================
// MASTRO ERP v2 ‚Äî PARTE 1/5
// Righe 1-1280: Costanti, Dati Demo (incluse visite/vaniList/euro/scadenza),
// Continuazione in PARTE2
// =======================================================
// components/MastroERP.tsx
// MASTRO ERP ‚Äî adattato per Next.js + Supabase
import React, { useState, useRef, useCallback, useEffect } from "react";
// import { getAziendaId, loadAllData, saveCantiere, saveEvent, deleteEvent as deleteEventDB, saveContatto, saveTeamMember, saveTask, saveAzienda, saveVano, deleteVano, saveMateriali, savePipeline } from "@/lib/supabase-sync";
import { supabase } from "@/lib/supabase";

// === CLOUD SYNC HELPERS ===
const SYNC_KEYS = ["cantieri","events","contatti","tasks","problemi","team","azienda","pipeline","sistemi","vetri","colori","coprifili","lamiere","libreria","fatture","squadre","montaggi","ordiniForn"];
let _syncQueue: Record<string, any> = {};
let _syncTimer: any = null;


import { cloudSave, cloudLoadAll, getAziendaId, loadAllData, saveCantiere, saveEvent, deleteEventDB, saveContatto, saveTeamMember, saveTask, saveAzienda, saveVanoDB, saveMateriali, savePipeline, FONT, FF, FM, tipoToMinCat, THEMES, PLANS, PIPELINE_DEFAULT, MOTIVI_BLOCCO, AFASE, CANTIERI_INIT, FATTURE_INIT, ORDINI_INIT, MONTAGGI_INIT, TASKS_INIT, AI_INBOX_INIT, MSGS_INIT, TEAM_INIT, CONTATTI_INIT, COLORI_INIT, SISTEMI_INIT, VETRI_INIT, TIPOLOGIE_RAPIDE, SETTORI, SETTORI_DEFAULT, COPRIFILI_INIT, LAMIERE_INIT, Ico, ICO, PUNTI_MISURE, useDragOrder, TIPI_EVENTO, tipoEvColor } from "./mastro-constants";

export default function MastroMisure({ user, azienda: aziendaInit }: { user?: any, azienda?: any }) {
  const [theme, setTheme] = useState("chiaro");
  const T = THEMES[theme];
  const syncReady = useRef(false);
  const userId = user?.id || null;
  
  const [tab, setTab] = useState("home");
  // === SUBSCRIPTION ===
  const [subPlan, setSubPlan] = useState<string>("trial");
  const [trialStart] = useState(() => { if (typeof window === "undefined") return new Date(); const s = localStorage.getItem("mastro_trial_start"); if (s) return new Date(s); const d = new Date(); localStorage.setItem("mastro_trial_start", d.toISOString()); return d; });
  const trialDaysLeft = subPlan === "trial" ? Math.max(0, 14 - Math.floor((Date.now() - trialStart.getTime()) / 86400000)) : 0;
  const activePlan = subPlan === "trial" && trialDaysLeft <= 0 ? "free" : subPlan;
  const plan = PLANS[activePlan] || PLANS.free;
  const [showPaywall, setShowPaywall] = useState<string | null>(null);
  const canDo = (action: string) => {
    if (action === "commessa" && cantieri.length >= plan.maxCommesse) { setShowPaywall("Hai raggiunto il limite di " + plan.maxCommesse + " commesse. Passa a un piano superiore per continuare."); return false; }
    if (action === "pdf" && !plan.pdf) { setShowPaywall("La generazione PDF √® disponibile dal piano Pro."); return false; }
    if (action === "sync" && !plan.sync) { setShowPaywall("La sync real-time √® disponibile dal piano Pro."); return false; }
    return true;
  };
  const WIDGET_IDS = ["contatori", "io", "attenzione", "programma", "settimana", "commesse", "azioni", "dashboard"];
  const drag = useDragOrder(WIDGET_IDS);
  const [homeEditMode, setHomeEditMode] = useState(false);
  const [dayOffset, setDayOffset] = useState(0);
  const [ioChecked, setIoChecked] = useState<Record<string,boolean>>({});
  const [collapsed, setCollapsed] = useState<Record<string,boolean>>({});
  const [lastOpenedCMId, setLastOpenedCMId] = useState<string|null>(null);
  // Wizard nuova visita
  const [cmSubTab, setCmSubTab] = useState("sopralluoghi"); // "sopralluoghi" | "misure" | "info"
  const [nvView, setNvView] = useState(false);
  const [nvStep, setNvStep] = useState(1);
  const [nvData, setNvData] = useState({ data: "", ora: "", rilevatore: "" });
  const [nvTipo, setNvTipo] = useState("rilievo"); // "rilievo" | "definitiva" | "modifica"
  const [nvMotivoModifica, setNvMotivoModifica] = useState("");
  const [nvVani, setNvVani] = useState([]);
  const [nvBlocchi, setNvBlocchi] = useState({});
  const [nvNote, setNvNote] = useState("");
  // Calendario griglia espandibile
  const [expandedDay, setExpandedDay] = useState(null); // ISO string del giorno espanso
  const [cantieri, setCantieri] = useState(CANTIERI_INIT);
  const [tasks, setTasks] = useState(TASKS_INIT);
  const [msgs, setMsgs] = useState(MSGS_INIT);
  const [selectedMsg, setSelectedMsg] = useState(null);
  const [replyText, setReplyText] = useState("");
  // === MODULO PROBLEMI ===
  const [problemi, setProblemi] = useState<any[]>(() => { try { const s = localStorage.getItem("mastro:problemi"); return s ? JSON.parse(s) : []; } catch { return []; } });
  const [showProblemaModal, setShowProblemaModal] = useState(false);
  const [selectedProblema, setSelectedProblema] = useState<any>(null);
  const [problemaForm, setProblemaForm] = useState({ titolo: "", descrizione: "", tipo: "materiale", priorita: "media", assegnato: "" });
  const [showProblemiView, setShowProblemiView] = useState(false);
  // Save problemi to localStorage
  useEffect(() => { try { localStorage.setItem("mastro:problemi", JSON.stringify(problemi)); } catch {} if(syncReady.current&&userId)cloudSave(userId,"problemi",problemi); }, [problemi]);
  const [team, setTeam] = useState(TEAM_INIT);
  const [coloriDB, setColoriDB] = useState(COLORI_INIT);
  const [sistemiDB, setSistemiDB] = useState(SISTEMI_INIT);
  const [vetriDB, setVetriDB] = useState(VETRI_INIT);
  const [coprifiliDB, setCoprifiliDB] = useState(COPRIFILI_INIT);
  const [lamiereDB, setLamiereDB] = useState(LAMIERE_INIT);
  const [libreriaDB, setLibreriaDB] = useState<any[]>([
    { id: 1, nome: "Controtelaio monoblocco", categoria: "Controtelaio", prezzo: 85, unita: "pz" },
    { id: 2, nome: "Davanzale marmo", categoria: "Davanzale", prezzo: 45, unita: "ml" },
    { id: 3, nome: "Soglia alluminio", categoria: "Soglia", prezzo: 25, unita: "ml" },
    { id: 4, nome: "Opere murarie", categoria: "Opere", prezzo: 120, unita: "forfait" },
    { id: 5, nome: "Cassonetto coibentato", categoria: "Cassonetto", prezzo: 95, unita: "ml" },
    { id: 6, nome: "Zoccolino raccordo", categoria: "Accessorio", prezzo: 12, unita: "ml" },
  ]);
  const [telaiPersianaDB, setTelaiPersianaDB] = useState([
    { id: "tp1", code: "L" }, { id: "tp2", code: "Z 22" }, { id: "tp3", code: "Z 27" }, { id: "tp4", code: "Z 40" }, { id: "tp5", code: "Z 50" }
  ]);
  const [posPersianaDB, setPosPersianaDB] = useState([
    { id: "pp1", code: "In battuta" }, { id: "pp2", code: "Con zoccoletto" }, { id: "pp3", code: "A filo muro" }, { id: "pp4", code: "Su controtelaio" }
  ]);
  const [tipoMisuraDB, setTipoMisuraDB] = useState([
    { id: "tm1", code: "Punta corta" }, { id: "tm2", code: "Punta lunga" }, { id: "tm3", code: "Muro finito" }, { id: "tm4", code: "Muro grezzo" }
  ]);
  const [tipoMisuraTappDB, setTipoMisuraTappDB] = useState([
    { id: "tmt1", code: "Misura luce guida" }, { id: "tmt2", code: "Misura finita tapparella" }
  ]);
  const [tipoMisuraZanzDB, setTipoMisuraZanzDB] = useState([
    { id: "tmz1", code: "Misura muro finito" }, { id: "tmz2", code: "Misura esterna zanzariera" }
  ]);
  const [tipoCassonettoDB, setTipoCassonettoDB] = useState([
    { id: "tc1", code: "Monoblocco" }, { id: "tc2", code: "Esterno" }, { id: "tc3", code: "A scomparsa" }, { id: "tc4", code: "Sopraluce" }
  ]);
  const [ctProfDB, setCtProfDB] = useState([
    { id: "cp1", code: "40" }, { id: "cp2", code: "45" }, { id: "cp3", code: "50" }, { id: "cp4", code: "55" }, { id: "cp5", code: "60" }, { id: "cp6", code: "65" }, { id: "cp7", code: "70" }
  ]);
  const [ctSezioniDB, setCtSezioniDB] = useState([
    { id: "cs1", code: "56√ó40" }, { id: "cs2", code: "56√ó50" }, { id: "cs3", code: "56√ó60" }, { id: "cs4", code: "56√ó70" }, { id: "cs5", code: "76√ó50" }, { id: "cs6", code: "76√ó60" }
  ]);
  const [ctCieliniDB, setCtCieliniDB] = useState([
    { id: "cc1", code: "A tampone" }, { id: "cc2", code: "A tappo" }, { id: "cc3", code: "Frontale" }
  ]);
  const [ctOffset, setCtOffset] = useState(10); // mm per lato (totale = x2)
  const [pipelineDB, setPipelineDB] = useState(PIPELINE_DEFAULT);
  const [faseOpen, setFaseOpen] = useState(true);
  const [sogliaDays, setSogliaDays] = useState(5);
  const [showFirmaModal, setShowFirmaModal] = useState(false);
  const [firmaDrawing, setFirmaDrawing] = useState(false);
  const [firmaDataUrl, setFirmaDataUrl] = useState(null);
  const [showPreventivoModal, setShowPreventivoModal] = useState(false);
  const [favTipologie, setFavTipologie] = useState(["F1A", "F2A", "PF2A", "SC2A", "FISDX", "VAS"]);
  
  // Fatturazione
  const [fattureDB, setFattureDB] = useState<any[]>(FATTURE_INIT);

  // ‚ïê‚ïê‚ïê FATTURE PASSIVE (ricevute da fornitori) ‚ïê‚ïê‚ïê
  const [fatturePassive, setFatturePassive] = useState<any[]>(() => {
    try { const v = localStorage.getItem("mastro:fatturePassive"); return v ? JSON.parse(v) : []; } catch(e) { return []; }
  });
  const [showFatturaPassiva, setShowFatturaPassiva] = useState(false);
  const [newFattPassiva, setNewFattPassiva] = useState({ fornitore: "", numero: "", data: "", importo: 0, iva: 22, descrizione: "", cmId: "", pagata: false, scadenza: "" });

  // ‚ïê‚ïê‚ïê CONTABILIT√Ä ‚ïê‚ïê‚ïê
  const [showContabilita, setShowContabilita] = useState(false);
  const [contabTab, setContabTab] = useState("panoramica");
  const [contabMese, setContabMese] = useState(() => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; });

  // ‚ïê‚ïê‚ïê CRONOLOGIA ‚ïê‚ïê‚ïê
  const [showCronologia, setShowCronologia] = useState(false);

  // ‚ïê‚ïê‚ïê KIT ACCESSORI ‚ïê‚ïê‚ïê
  const [kitAccessori, setKitAccessori] = useState(() => {
    try { const v = localStorage.getItem("mastro:kit"); return v ? JSON.parse(v) : [
      { id: 1, nome: "Kit Standard", items: ["Maniglia", "Cerniere x2", "Guarnizione"], prezzo: 45 },
      { id: 2, nome: "Kit Sicurezza", items: ["Maniglia con chiave", "Cerniere x3", "Defender", "Multipoint"], prezzo: 120 },
      { id: 3, nome: "Kit Scorrevole", items: ["Binario", "Carrelli x2", "Chiusura soft", "Maniglia incasso"], prezzo: 180 },
    ]; } catch(e) { return []; }
  });

  // ‚ïê‚ïê‚ïê FORNITORI PRO ‚ïê‚ïê‚ïê
  const [fornitori, setFornitori] = useState(() => {
    try { const v = localStorage.getItem("mastro:fornitori"); if (v) { const p = JSON.parse(v); if (Array.isArray(p) && p.length > 0) return p; } } catch(e) {}
    return [
    { id: "f1", nome: "Aluplast Italia", ragioneSociale: "Aluplast Italia SRL", piva: "01234567890", cf: "", tipo: "Profili PVC", categoria: "profili", indirizzo: "Via Roma 10", cap: "37100", citta: "Verona", provincia: "VR", telefono: "+39 045 123456", cellulare: "", email: "ordini@aluplast.it", pec: "aluplast@pec.it", sito: "www.aluplast.it", referente: "Marco Rossi", telReferente: "+39 333 1234567", emailReferente: "m.rossi@aluplast.it", banca: "Unicredit", iban: "IT60X0542811101000000123456", pagamento: "60gg_fm", scontoBase: 35, tempoConsegna: 18, sistemiTrattati: "Ideal 4000, Ideal 7000, Ideal 8000", note: "Fornitore principale PVC", rating: 4.6, preferito: true, attivo: true },
    { id: "f2", nome: "Sch√ºco International", ragioneSociale: "Sch√ºco International Italia SRL", piva: "09876543210", cf: "", tipo: "Profili Alluminio", categoria: "profili", indirizzo: "Via Milano 50", cap: "20100", citta: "Milano", provincia: "MI", telefono: "+39 02 654321", cellulare: "", email: "italia@schueco.com", pec: "schuco@pec.it", sito: "www.schueco.com", referente: "Luca Bianchi", telReferente: "+39 335 7654321", emailReferente: "l.bianchi@schueco.com", banca: "Intesa", iban: "", pagamento: "60gg_fm", scontoBase: 30, tempoConsegna: 22, sistemiTrattati: "AWS 75, ASS 70, ASS 77", note: "", rating: 4.8, preferito: true, attivo: true },
    { id: "f3", nome: "Pilkington Italia", ragioneSociale: "Pilkington Italia SPA", piva: "", cf: "", tipo: "Vetri", categoria: "vetri", indirizzo: "", cap: "", citta: "Napoli", provincia: "NA", telefono: "+39 081 789012", cellulare: "", email: "ordini@pilkington.it", pec: "", sito: "", referente: "", telReferente: "", emailReferente: "", banca: "", iban: "", pagamento: "30gg_fm", scontoBase: 20, tempoConsegna: 12, sistemiTrattati: "", note: "", rating: 4.3, preferito: false, attivo: true },
    { id: "f4", nome: "Roto Frank", ragioneSociale: "Roto Frank AG", piva: "", cf: "", tipo: "Ferramenta", categoria: "ferramenta", indirizzo: "", cap: "", citta: "Bolzano", provincia: "BZ", telefono: "+39 0471 345678", cellulare: "", email: "italia@roto-frank.com", pec: "", sito: "", referente: "", telReferente: "", emailReferente: "", banca: "", iban: "", pagamento: "30gg_fm", scontoBase: 25, tempoConsegna: 8, sistemiTrattati: "", note: "", rating: 4.5, preferito: false, attivo: true },
  ]; });
  const [showFornitoreDetail, setShowFornitoreDetail] = useState<any>(null);
  const [showFornitoreForm, setShowFornitoreForm] = useState(false);
  const [fornitoreEdit, setFornitoreEdit] = useState<any>(null);

  // ‚ïê‚ïê‚ïê TEMI CUSTOM ‚ïê‚ïê‚ïê
  const [customThemes, setCustomThemes] = useState(() => {
    try { const v = localStorage.getItem("mastro:customThemes"); return v ? JSON.parse(v) : []; } catch(e) { return []; }
  });

  // ‚ïê‚ïê‚ïê VOCE AI ‚ïê‚ïê‚ïê
  const [voiceActive, setVoiceActive] = useState(false);
  const [voiceTranscript, setVoiceTranscript] = useState("");
  const recognitionRef = useRef<any>(null);

  useEffect(()=>{try{localStorage.setItem("mastro:fatturePassive",JSON.stringify(fatturePassive));}catch(e){}},[fatturePassive]);
  useEffect(()=>{try{localStorage.setItem("mastro:fornitori",JSON.stringify(fornitori));}catch(e){}},[fornitori]);
  useEffect(()=>{try{localStorage.setItem("mastro:kit",JSON.stringify(kitAccessori));}catch(e){}},[kitAccessori]);
  useEffect(()=>{try{localStorage.setItem("mastro:customThemes",JSON.stringify(customThemes));}catch(e){}},[customThemes]);
  const [ordiniFornDB, setOrdiniFornDB] = useState<any[]>(ORDINI_INIT);
  const [showFatturaModal, setShowFatturaModal] = useState(false);
  const [fatturaEdit, setFatturaEdit] = useState<any>(null);
  
  // Squadre montaggio
  const [squadreDB, setSquadreDB] = useState<any[]>([
    { id: "sq1", nome: "Squadra A", membri: ["Mario", "Giuseppe"], colore: "#007aff" },
    { id: "sq2", nome: "Squadra B", membri: ["Paolo", "Andrea"], colore: "#34c759" },
  ]);
  const [montaggiDB, setMontaggiDB] = useState<any[]>(MONTAGGI_INIT);
  
  // Settori attivi + Onboarding
  const [settoriAttivi, setSettoriAttivi] = useState<string[]>(SETTORI_DEFAULT);
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [pianoAttivo, setPianoAttivo] = useState<"free"|"pro"|"business">("pro"); // default pro for dev
  
  // Tipologie filtrate per settori attivi
  const tipologieFiltrate = TIPOLOGIE_RAPIDE.filter(t => settoriAttivi.includes(t.settore));
  
  // Stato calendario montaggi
  const [calMontaggiWeek, setCalMontaggiWeek] = useState(0);
  const [showCalMontaggi, setShowCalMontaggi] = useState(false);
  const [calMontaggiTarget, setCalMontaggiTarget] = useState<string | null>(null);
  const [montFormOpen, setMontFormOpen] = useState(false);
  const [montFormData, setMontFormData] = useState({ data: "", orario: "08:00", durata: "giornata", squadraId: "", note: "" });
  const [ccConfirm, setCcConfirm] = useState<string | null>(null);
  const [ccDone, setCcDone] = useState<string | null>(null);
  const [firmaStep, setFirmaStep] = useState(0);
  const [firmaFileUrl, setFirmaFileUrl] = useState<string | null>(null);
  const [firmaFileName, setFirmaFileName] = useState("");
  const [fattPerc, setFattPerc] = useState(50);
  const [montGiorni, setMontGiorni] = useState(1);
  const [docViewer, setDocViewer] = useState<{ docs: any[], title: string } | null>(null);
  const [ccExpandStep, setCcExpandStep] = useState<string|null>(null);
  const [confSett, setConfSett] = useState(""); // settimane consegna input
  
  // Navigation
  const [selectedCM, setSelectedCM] = useState(null);
  const [selectedRilievo, setSelectedRilievo] = useState(null); // rilievo aperto
  const [showNuovoRilievo, setShowNuovoRilievo] = useState(false);
  const [nuovoRilTipo, setNuovoRilTipo] = useState("rilievo");
  const [nuovoRilData, setNuovoRilData] = useState({ data: "", ora: "", rilevatore: "", note: "", motivoModifica: "" });
  const [selectedVano, setSelectedVano] = useState(null);
  const [filterFase, setFilterFase] = useState("tutte");
  const [searchQ, setSearchQ] = useState("");
  const [showModal, setShowModal] = useState(null); // 'task' | 'commessa' | 'vano' | null
  const [settingsTab, setSettingsTab] = useState("generali");
  const [expandedPipelinePhase, setExpandedPipelinePhase] = useState(null);
  const [pipelinePhaseTab, setPipelinePhaseTab] = useState("email");
  const [showRiepilogo, setShowRiepilogo] = useState(false);
  const [riepilogoSending, setRiepilogoSending] = useState(false);

  // === ONBOARDING TUTORIAL ===
  const [tutoStep, setTutoStep] = useState(0);
  React.useEffect(() => {
    try { if (!localStorage.getItem("mastro:onboarded")) setTutoStep(1); } catch(e){}
  }, []);
  const closeTuto = () => { setTutoStep(0); try { localStorage.setItem("mastro:onboarded", "1"); } catch(e){} };
  const nextTuto = () => { if (tutoStep >= 7) closeTuto(); else setTutoStep(tutoStep + 1); };

  const [aziendaInfo, setAziendaInfo] = useState({
    ragione: aziendaInit?.ragione || "Walter Cozza Serramenti SRL",
    piva: aziendaInit?.piva || "",
    indirizzo: aziendaInit?.indirizzo || "",
    telefono: aziendaInit?.telefono || "",
    email: aziendaInit?.email || "",
    website: "",
    iban: "",
    cciaa: "",
    logo: null,
    pec: "",
    condFornitura: "",
    condPagamento: "",
    condConsegna: "",
    condContratto: "",
    condDettagli: "",
  });
  const logoInputRef = useRef(null);
  const [aiChat, setAiChat] = useState(false);
  const [aiInput, setAiInput] = useState("");
  const [aiMsgs, setAiMsgs] = useState([{ role: "ai", text: "Ciao Fabio! Sono MASTRO AI. Chiedimi qualsiasi cosa sulle tue commesse, task o misure." }]);
  
  // Send commessa modal
  const [showSendModal, setShowSendModal] = useState(false);
  const [sendOpts, setSendOpts] = useState({ misure: true, foto: true, disegno: true, note: true, accessori: true });
  const [sendConfirm, setSendConfirm] = useState(null);
  
  // Vano wizard step
  const [vanoStep, setVanoStep] = useState(0);
  const spCanvasRef = useRef(null);
  const [spDrawing, setSpDrawing] = useState(false); // "sent" | null
  
  // Agenda
  const [agendaView, setAgendaView] = useState("mese"); // "giorno" | "settimana" | "mese"
  const [agendaFilters, setAgendaFilters] = useState({ eventi: true, montaggi: true, consegne: true, scadenze: true, tasks: true });
  const [homeExpand, setHomeExpand] = useState<Record<string, boolean>>({});
  const [homeView, setHomeView] = useState<string|null>(null);
  const [montView, setMontView] = useState("lista");
  const [montExpandId, setMontExpandId] = useState<string|null>(null);
  const [montCalDate, setMontCalDate] = useState(new Date());
  const [dossierTab, setDossierTab] = useState("storia");
  const [cmFaseIdx, setCmFaseIdx] = useState(0); // filtro fase widget commesse dashboard
  const [cmView, setCmView] = useState<"card"|"list">("card"); // vista commesse: card grande | lista compatta
  const [fasePanelOpen, setFasePanelOpen] = useState<Record<string,boolean>>({}); // accordion checklist per fase
  const [catIdx, setCatIdx] = useState(0); // categoria widget allerte dashboard
  const [selDate, setSelDate] = useState(new Date());
  const [showNewEvent, setShowNewEvent] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [selectedTask, setSelectedTask] = useState(null);
  const [showMailModal, setShowMailModal] = useState<{ev: any, cm: any} | null>(null);
  const [showEmailComposer, setShowEmailComposer] = useState<any>(null); // {cm, tipo}
  const [emailDest, setEmailDest] = useState("");
  const [emailOggetto, setEmailOggetto] = useState("");
  const [emailCorpo, setEmailCorpo] = useState("");
  const [mailBody, setMailBody] = useState("");
  const [newEvent, setNewEvent] = useState({ text: "", time: "", tipo: "sopralluogo", cm: "", persona: "", date: "", reminder: "", addr: "" });
  const [events, setEvents] = useState(() => {
    const t = new Date(); const td = t.toISOString().split("T")[0];
    const tm = new Date(t); tm.setDate(tm.getDate() + 1); const tmStr = tm.toISOString().split("T")[0];
    const t2 = new Date(t); t2.setDate(t2.getDate() + 2); const t2Str = t2.toISOString().split("T")[0];
    const t3 = new Date(t); t3.setDate(t3.getDate() + 3); const t3Str = t3.toISOString().split("T")[0];
    return [
      { id: "ev1", date: td, time: "09:00", text: "Sopralluogo Verdi", tipo: "sopralluogo", persona: "Giuseppe Verdi", addr: "Via Garibaldi 12, Rende", cm: "S-0001", color: "#007aff", durata: 60 },
      { id: "ev2", date: td, time: "15:00", text: "Telefonata Bianchi ‚Äî preventivo", tipo: "controllo", persona: "Anna Bianchi", addr: "", cm: "S-0002", color: "#ff9500", durata: 30 },
      { id: "ev3", date: tmStr, time: "10:00", text: "Firma contratto Rossi", tipo: "sopralluogo", persona: "Mario Rossi", addr: "Via Roma 42, Cosenza", cm: "S-0003", color: "#34c759", durata: 45 },
      { id: "ev4", date: t3Str, time: "08:30", text: "Consegna materiale Esposito", tipo: "consegna", persona: "Laura Esposito", addr: "Viale Trieste 5, Rende", cm: "S-0004", color: "#af52de", durata: 120 },
    ];
  });
  
    // Advance fase notification
  const [faseNotif, setFaseNotif] = useState(null);
  
  // AI Photo
  const [showAIPhoto, setShowAIPhoto] = useState(false);
  const [aiPhotoStep, setAiPhotoStep] = useState(0); // 0=ready, 1=analyzing, 2=done
  const [settingsModal, setSettingsModal] = useState(null); // {type, item?}
  const [importStatus, setImportStatus] = useState(null); // {step, msg, detail, ok}
  const [importLog, setImportLog] = useState([]);
  const [settingsForm, setSettingsForm] = useState({});
  const [showAllegatiModal, setShowAllegatiModal] = useState(null); // "nota" | "vocale" | "video" | null

  // Auto-start camera preview when video modal opens
  React.useEffect(() => {
    if (showAllegatiModal === "video") {
      (async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false });
          mediaStreamRef.current = stream;
          setTimeout(() => {
            if (videoPreviewRef.current) { videoPreviewRef.current.srcObject = stream; videoPreviewRef.current.play().catch(() => {}); }
          }, 100);
        } catch (err) {
          console.warn("Camera preview failed:", err);
        }
      })();
    } else {
      // cleanup when modal closes
      if (mediaStreamRef.current && !isRecording) {
        mediaStreamRef.current.getTracks().forEach(t => t.stop());
        mediaStreamRef.current = null;
      }
    }
  }, [showAllegatiModal]);
  const [allegatiText, setAllegatiText] = useState("");
  const [isRecording, setIsRecording] = useState(false);
  const [recSeconds, setRecSeconds] = useState(0);
  const recInterval = useRef(null);
  const [playingId, setPlayingId] = useState(null);
  const [playProgress, setPlayProgress] = useState(0);
  const playInterval = useRef(null);
  const [viewingVideoId, setViewingVideoId] = useState<number|null>(null);
  const [viewingPhotoId, setViewingPhotoId] = useState<number|string|null>(null);
  const mediaRecorderRef = useRef<MediaRecorder|null>(null);
  const mediaStreamRef = useRef<MediaStream|null>(null);
  const mediaChunksRef = useRef<Blob[]>([]);
  const audioPlayRef = useRef<HTMLAudioElement|null>(null);
  const videoPreviewRef = useRef<HTMLVideoElement|null>(null);
  
  // Drawing state
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);
  const fotoInputRef = useRef(null);
  const firmaRef = useRef(null);
  const fotoVanoRef = useRef(null);
  const cameraPreviewRef = useRef<HTMLVideoElement|null>(null);
  const cameraStreamRef = useRef<MediaStream|null>(null);
  const [showCameraModal, setShowCameraModal] = useState(false);
  const [cameraMode, setCameraMode] = useState<"foto"|"video">("foto");
  const calTouchStartRef = React.useRef(0);
  const calTouchEndRef = React.useRef(0);
  const [pendingFotoCat, setPendingFotoCat] = useState(null);
  const videoVanoRef = useRef(null);
  const ripFotoRef = useRef(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [drawTool, setDrawTool] = useState<"pen"|"eraser">("pen");
  const [drawPages, setDrawPages] = useState<string[]>([""]);
  const [drawPageIdx, setDrawPageIdx] = useState(0);
  const [drawFullscreen, setDrawFullscreen] = useState(false);
  const [penColor, setPenColor] = useState("#1d1d1f");
  const [penSize, setPenSize] = useState(2);
  const [drawPaths, setDrawPaths] = useState([]);

  // New task form
  const [newTask, setNewTask] = useState({ text: "", meta: "", time: "", priority: "media", cm: "", date: "", persona: "" });
  const [taskAllegati, setTaskAllegati] = useState([]); // allegati for new task
  const [msgFilter, setMsgFilter] = useState("tutti"); // tutti/email/whatsapp/sms/telegram
  const [msgSearch, setMsgSearch] = useState("");
  const [showCompose, setShowCompose] = useState(false);
  const [composeMsg, setComposeMsg] = useState({ to: "", text: "", canale: "whatsapp", cm: "" });
  const [fabOpen, setFabOpen] = useState(false);
  const [contatti, setContatti] = useState(CONTATTI_INIT);
  const [msgSubTab, setMsgSubTab] = useState("chat"); // "chat" | "rubrica" | "ai" | "email"
  const [aiInbox, setAiInbox] = useState(AI_INBOX_INIT);
  const [selectedAiMsg, setSelectedAiMsg] = useState(null);
  // Gmail integration
  const [gmailStatus, setGmailStatus] = useState<{connected:boolean, email?:string}>({ connected: false });
  const [gmailMessages, setGmailMessages] = useState<any[]>([]);
  const [gmailLoading, setGmailLoading] = useState(false);
  const [gmailNextPage, setGmailNextPage] = useState<string|null>(null);
  const [gmailSelected, setGmailSelected] = useState<any>(null);
  const [gmailReply, setGmailReply] = useState("");
  const [gmailSending, setGmailSending] = useState(false);
  const [gmailSearch, setGmailSearch] = useState("");
  const [rubricaSearch, setRubricaSearch] = useState("");
  const [rubricaFilter, setRubricaFilter] = useState("tutti"); // tutti/preferiti/team/clienti/fornitori
  const [globalSearch, setGlobalSearch] = useState("");
  // New commessa form
  const [newCM, setNewCM] = useState<any>({ cliente: "", indirizzo: "", telefono: "", email: "", sistema: "", tipo: "nuova", difficoltaSalita: "", mezzoSalita: "", foroScale: "", pianoEdificio: "", note: "" });
  const [ripSearch, setRipSearch] = useState("");
  const [ripCMSel, setRipCMSel] = useState(null);
  const [ripProblema, setRipProblema] = useState("");
  const [ripFotos, setRipFotos] = useState([]);
  const [ripUrgenza, setRipUrgenza] = useState("media");
  // New vano form
  const [vanoInfoOpen, setVanoInfoOpen] = useState(null); // which accordion section is open
  const [tipCat, setTipCat] = useState("Finestre");
  const [newVano, setNewVano] = useState({ nome: "", tipo: "F1A", stanza: "Soggiorno", piano: "PT", sistema: "", coloreInt: "", coloreEst: "", bicolore: false, coloreAcc: "", vetro: "", telaio: "", telaioAlaZ: "", rifilato: false, rifilSx: "", rifilDx: "", rifilSopra: "", rifilSotto: "", coprifilo: "", lamiera: "", pezzi: 1 });
  const [customPiani, setCustomPiani] = useState(["S1", "PT", "P1", "P2", "P3"]);
  const [mezziSalita, setMezziSalita] = useState(["Scala interna", "Scala esterna", "Scala aerea", "Scala a mano", "Gru", "Elevatore", "Ponteggio", "Nessuno"]);
  const [showAddPiano, setShowAddPiano] = useState(false);
  const [newPiano, setNewPiano] = useState("");

  // Responsive width
  const [winW, setWinW] = useState(typeof window !== "undefined" ? window.innerWidth : 430);
  useEffect(() => {
    const h = () => setWinW(window.innerWidth);
    window.addEventListener("resize", h);
    return () => window.removeEventListener("resize", h);
  }, []);

  // == Persistence ==
  // DEMO VERSION ‚Äî FORCE RESET on every new deploy
  const DEMO_VER = "v50-gmail-email";
  useEffect(()=>{
      // Check if user chose "clean slate" ‚Äî skip demo data
      const cleanSlate = localStorage.getItem("mastro:cleanSlate");
      if (cleanSlate === "true") {
        // User wants empty data ‚Äî load from localStorage (which has empty arrays)
        try{const _v=localStorage.getItem("mastro:cantieri");if(_v){setCantieri(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:tasks");if(_v){setTasks(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:events");if(_v){setEvents(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:fatture");if(_v){setFattureDB(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:ordiniForn");if(_v){setOrdiniFornDB(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:montaggi");if(_v){setMontaggiDB(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:msgs");if(_v){setMsgs(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:contatti");if(_v){setContatti(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:pipeline");if(_v){setPipeline(JSON.parse(_v));}}catch(e){}
        try{const _v=localStorage.getItem("mastro:problemi");if(_v){setProblemi(JSON.parse(_v));}}catch(e){}
        localStorage.setItem("mastro:demoVer", DEMO_VER);
        return;
      }
      const savedVer = localStorage.getItem("mastro:demoVer");
      if (false && savedVer !== DEMO_VER) {
        // FORCE RESET ‚Äî version changed or first load
        console.log("üîÑ MASTRO: Reset demo ‚Üí", DEMO_VER);
        Object.keys(localStorage).filter(k => k.startsWith("mastro:")).forEach(k => {
          try { localStorage.removeItem(k); } catch(e) {}
        });
        localStorage.setItem("mastro:demoVer", DEMO_VER);
        // Demo data already loaded from useState defaults ‚Äî skip localStorage loading
        return;
      }
      try{const _v=localStorage.getItem("mastro:cantieri");if(_v){const p=JSON.parse(_v);if(p.length>0)setCantieri(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:tasks");if(_v){const p=JSON.parse(_v);if(p.length>0)setTasks(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:events");if(_v){const p=JSON.parse(_v);if(p.length>0)setEvents(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:colori");if(_v)setColoriDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:sistemi");if(_v){
        let parsed=JSON.parse(_v);
        // Migration: add griglia + minimiMq if missing
        const DEMO_GRIGLIE: Record<string, any[]> = {
          "Ideal 4000": [
            {l:600,h:600,prezzo:120},{l:600,h:800,prezzo:145},{l:600,h:1000,prezzo:170},{l:600,h:1200,prezzo:195},
            {l:800,h:800,prezzo:175},{l:800,h:1000,prezzo:205},{l:800,h:1200,prezzo:240},{l:800,h:1400,prezzo:270},
            {l:1000,h:1000,prezzo:250},{l:1000,h:1200,prezzo:290},{l:1000,h:1400,prezzo:330},{l:1000,h:1600,prezzo:370},
            {l:1200,h:1200,prezzo:340},{l:1200,h:1400,prezzo:385},{l:1200,h:1600,prezzo:430},{l:1200,h:1800,prezzo:480},
            {l:1400,h:1400,prezzo:430},{l:1400,h:1600,prezzo:485},{l:1400,h:2200,prezzo:580},
          ],
          "CT70": [
            {l:600,h:800,prezzo:195},{l:600,h:1200,prezzo:260},
            {l:800,h:1000,prezzo:275},{l:800,h:1400,prezzo:365},
            {l:1000,h:1200,prezzo:380},{l:1000,h:1400,prezzo:440},
            {l:1200,h:1400,prezzo:520},{l:1200,h:1600,prezzo:580},
            {l:1400,h:2200,prezzo:780},
          ],
        };
        const DEMO_MINIMI_MQ: Record<string, any> = { "Ideal 4000": { "1anta": 1.5, "2ante": 2.0, "3ante": 2.8, "scorrevole": 3.5, "fisso": 1.0 }, "CT70": { "1anta": 1.5, "2ante": 2.0, "scorrevole": 3.5 }, "S80": { "1anta": 1.5, "2ante": 2.0 }, "FIN-Project": { "1anta": 1.5, "2ante": 2.2, "scorrevole": 4.0 } };
        parsed = parsed.map(s => ({
          ...s,
          griglia: s.griglia || DEMO_GRIGLIE[s.sistema] || [],
          minimiMq: s.minimiMq || {},
        }));
        setSistemiDB(parsed);
      }}catch(e){}
      try{const _v=localStorage.getItem("mastro:vetri");if(_v)setVetriDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:coprifili");if(_v)setCoprifiliDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:lamiere");if(_v)setLamiereDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:libreria");if(_v)setLibreriaDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:fatture");if(_v){const p=JSON.parse(_v);if(p.length>0)setFattureDB(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:ordiniForn");if(_v){const p=JSON.parse(_v);if(p.length>0)setOrdiniFornDB(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:squadre");if(_v)setSquadreDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:montaggi");if(_v){const p=JSON.parse(_v);if(p.length>0)setMontaggiDB(p);}}catch(e){}
      try{const _v=localStorage.getItem("mastro:settori");if(_v)setSettoriAttivi(JSON.parse(_v));else setShowOnboarding(true);}catch(e){setShowOnboarding(true);}
      try{const _v=localStorage.getItem("mastro:piano");if(_v)setPianoAttivo(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:team");if(_v)setTeam(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:contatti");if(_v)setContatti(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:pipeline");if(_v)setPipelineDB(JSON.parse(_v));}catch(e){}
      try{const _v=localStorage.getItem("mastro:azienda");if(_v)setAziendaInfo(JSON.parse(_v));}catch(e){}
},[]);
  useEffect(()=>{try{localStorage.setItem("mastro:cantieri",JSON.stringify(cantieri));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"cantieri",cantieri);},[cantieri]);
  useEffect(()=>{try{localStorage.setItem("mastro:tasks",JSON.stringify(tasks));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"tasks",tasks);},[tasks]);
  useEffect(()=>{try{localStorage.setItem("mastro:events",JSON.stringify(events));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"events",events);},[events]);
  useEffect(()=>{try{localStorage.setItem("mastro:colori",JSON.stringify(coloriDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"colori",coloriDB);},[coloriDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:sistemi",JSON.stringify(sistemiDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"sistemi",sistemiDB);},[sistemiDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:vetri",JSON.stringify(vetriDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"vetri",vetriDB);},[vetriDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:coprifili",JSON.stringify(coprifiliDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"coprifili",coprifiliDB);},[coprifiliDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:lamiere",JSON.stringify(lamiereDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"lamiere",lamiereDB);},[lamiereDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:libreria",JSON.stringify(libreriaDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"libreria",libreriaDB);},[libreriaDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:fatture",JSON.stringify(fattureDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"fatture",fattureDB);},[fattureDB]);

  useEffect(()=>{try{localStorage.setItem("mastro:ordiniForn",JSON.stringify(ordiniFornDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"ordiniForn",ordiniFornDB);},[ordiniFornDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:squadre",JSON.stringify(squadreDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"squadre",squadreDB);},[squadreDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:montaggi",JSON.stringify(montaggiDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"montaggi",montaggiDB);},[montaggiDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:settori",JSON.stringify(settoriAttivi));}catch(e){}},[settoriAttivi]);
  useEffect(()=>{try{localStorage.setItem("mastro:piano",JSON.stringify(pianoAttivo));}catch(e){}},[pianoAttivo]);
  useEffect(()=>{try{localStorage.setItem("mastro:team",JSON.stringify(team));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"team",team);},[team]);
  useEffect(()=>{try{localStorage.setItem("mastro:contatti",JSON.stringify(contatti));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"contatti",contatti);},[contatti]);
  useEffect(()=>{try{localStorage.setItem("mastro:pipeline",JSON.stringify(pipelineDB));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"pipeline",pipelineDB);},[pipelineDB]);
  useEffect(()=>{try{localStorage.setItem("mastro:azienda",JSON.stringify(aziendaInfo));}catch(e){} if(syncReady.current&&userId)cloudSave(userId,"azienda",aziendaInfo);},[aziendaInfo]);
  useEffect(() => { if (selectedCM?.id) setLastOpenedCMId(selectedCM.id); }, [selectedCM]);

  // === CLOUD SYNC (user_data key-value) ===

  // Reusable cloud load function
  const applyCloud = useCallback(async () => {
    if (!userId) return;
    try {
      const cloud = await cloudLoadAll(userId);
      if (Object.keys(cloud).length === 0) return;
      // Safety: filter out null/invalid entries from arrays
      const safeArr = (arr: any) => Array.isArray(arr) ? arr.filter(x => x && typeof x === "object") : null;
      const sa = (k: string) => safeArr(cloud[k]);
      // Ensure cantieri always have .fase
      const safeCantieri = sa("cantieri")?.map(c => ({ fase: "sopralluogo", ...c })) || null;
      if (safeCantieri) { setCantieri(safeCantieri); localStorage.setItem("mastro:cantieri", JSON.stringify(safeCantieri)); }
      if (sa("events")) { setEvents(sa("events")!); localStorage.setItem("mastro:events", JSON.stringify(sa("events"))); }
      if (sa("contatti")) { setContatti(sa("contatti")!); localStorage.setItem("mastro:contatti", JSON.stringify(sa("contatti"))); }
      if (sa("tasks")) { setTasks(sa("tasks")!); localStorage.setItem("mastro:tasks", JSON.stringify(sa("tasks"))); }
      if (sa("problemi")) { setProblemi(sa("problemi")!); localStorage.setItem("mastro:problemi", JSON.stringify(sa("problemi"))); }
      if (sa("team")) { setTeam(sa("team")!); localStorage.setItem("mastro:team", JSON.stringify(sa("team"))); }
      if (cloud.azienda) { setAziendaInfo(cloud.azienda); localStorage.setItem("mastro:azienda", JSON.stringify(cloud.azienda)); }
      if (sa("pipeline")) { setPipelineDB(sa("pipeline")!); localStorage.setItem("mastro:pipeline", JSON.stringify(sa("pipeline"))); }
      if (sa("sistemi")) {
        const DEMO_GRIGLIE: Record<string, any[]> = {
          "Ideal 4000": [{l:600,h:600,prezzo:120},{l:600,h:800,prezzo:145},{l:600,h:1000,prezzo:170},{l:600,h:1200,prezzo:195},{l:800,h:800,prezzo:175},{l:800,h:1000,prezzo:205},{l:800,h:1200,prezzo:240},{l:800,h:1400,prezzo:270},{l:1000,h:1000,prezzo:250},{l:1000,h:1200,prezzo:290},{l:1000,h:1400,prezzo:330},{l:1000,h:1600,prezzo:370},{l:1200,h:1200,prezzo:340},{l:1200,h:1400,prezzo:385},{l:1200,h:1600,prezzo:430},{l:1200,h:1800,prezzo:480},{l:1400,h:1400,prezzo:430},{l:1400,h:1600,prezzo:485},{l:1400,h:2200,prezzo:580}],
          "CT70": [{l:600,h:800,prezzo:195},{l:600,h:1200,prezzo:260},{l:800,h:1000,prezzo:275},{l:800,h:1400,prezzo:365},{l:1000,h:1200,prezzo:380},{l:1000,h:1400,prezzo:440},{l:1200,h:1400,prezzo:520},{l:1200,h:1600,prezzo:580},{l:1400,h:2200,prezzo:780}],
        };
        const DEMO_MINIMI_MQ: Record<string, any> = { "Ideal 4000": { "1anta": 1.5, "2ante": 2.0, "3ante": 2.8, "scorrevole": 3.5, "fisso": 1.0 }, "CT70": { "1anta": 1.5, "2ante": 2.0, "scorrevole": 3.5 }, "S80": { "1anta": 1.5, "2ante": 2.0 }, "FIN-Project": { "1anta": 1.5, "2ante": 2.2, "scorrevole": 4.0 } };
        const migrated = sa("sistemi")!.map(s => ({ ...s, griglia: s.griglia || DEMO_GRIGLIE[s.sistema] || [], minimiMq: s.minimiMq || {} }));
        setSistemiDB(migrated); localStorage.setItem("mastro:sistemi", JSON.stringify(migrated));
      }
      if (sa("vetri")) { setVetriDB(sa("vetri")!); localStorage.setItem("mastro:vetri", JSON.stringify(sa("vetri"))); }
      if (sa("colori")) { setColoriDB(sa("colori")!); localStorage.setItem("mastro:colori", JSON.stringify(sa("colori"))); }
      if (sa("coprifili")) { setCoprifiliDB(sa("coprifili")!); localStorage.setItem("mastro:coprifili", JSON.stringify(sa("coprifili"))); }
      if (sa("lamiere")) { setLamiereDB(sa("lamiere")!); localStorage.setItem("mastro:lamiere", JSON.stringify(sa("lamiere"))); }
      if (sa("libreria")) { setLibreriaDB(sa("libreria")!); localStorage.setItem("mastro:libreria", JSON.stringify(sa("libreria"))); }
      if (sa("fatture")) { setFattureDB(sa("fatture")!); localStorage.setItem("mastro:fatture", JSON.stringify(sa("fatture"))); }
      if (sa("ordiniForn")) { setOrdiniFornDB(sa("ordiniForn")!); localStorage.setItem("mastro:ordiniForn", JSON.stringify(sa("ordiniForn"))); }
      if (sa("squadre")) { setSquadreDB(sa("squadre")!); localStorage.setItem("mastro:squadre", JSON.stringify(sa("squadre"))); }
      if (sa("montaggi")) { setMontaggiDB(sa("montaggi")!); localStorage.setItem("mastro:montaggi", JSON.stringify(sa("montaggi"))); }
    } catch (e) { console.warn("Cloud sync error:", e); }
  }, [userId]);

  // Load from cloud on mount (after localStorage)
  useEffect(() => {
    if (!userId) { syncReady.current = true; return; }
    let mounted = true;
    (async () => {
      await applyCloud();
      setTimeout(() => { if (mounted) syncReady.current = true; }, 2000);
    })();
    return () => { mounted = false; };
  }, [userId]);

  // Auto-refresh when tab becomes visible (no manual refresh needed!)
  useEffect(() => {
    if (!userId) return;
    const onVisible = () => {
      if (!document.hidden && syncReady.current) {
        syncReady.current = false;
        applyCloud().then(() => { syncReady.current = true; });
      }
    };
    document.addEventListener("visibilitychange", onVisible);

    // Polling: ogni 10 secondi controlla aggiornamenti dal cloud
    const poll = setInterval(() => {
      if (!document.hidden && syncReady.current) {
        applyCloud();
      }
    }, 10000);

    return () => { document.removeEventListener("visibilitychange", onVisible); clearInterval(poll); };
  }, [userId, applyCloud]);


  const PIPELINE = pipelineDB.filter(p => p.attiva !== false);
  const parseDataCM = (s) => {
    const oggi0 = new Date(); oggi0.setHours(0,0,0,0);
    if(!s) return null;
    if(s==="oggi"||s==="Oggi"||s==="Adesso") return oggi0;
    const mesi2 = {gen:0,feb:1,mar:2,apr:3,mag:4,giu:5,lug:6,ago:7,set:8,ott:9,nov:10,dic:11};
    const m2 = s.toLowerCase().match(/(\d+)\s+([a-z]+)/);
    if(m2) return new Date(oggi0.getFullYear(), mesi2[m2[2]]??0, parseInt(m2[1]));
    return null;
  };
  const giorniFermaCM = (c) => {
    const oggi0 = new Date(); oggi0.setHours(0,0,0,0);
    const d = parseDataCM(c.aggiornato);
    if(!d) return 0;
    return Math.floor((oggi0 - d) / 86400000);
  };

  // === GMAIL INTEGRATION ===
  const gmailCheckStatus = useCallback(async () => {
    try {
      const res = await fetch("/api/gmail/status");
      const data = await res.json();
      setGmailStatus(data);
      if (data.connected) gmailFetchMessages();
    } catch {}
  }, []);

  const gmailFetchMessages = useCallback(async (query?: string, page?: string) => {
    setGmailLoading(true);
    try {
      let url = "/api/gmail/messages?max=20";
      if (query) url += `&q=${encodeURIComponent(query)}`;
      if (page) url += `&page=${page}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.messages) {
        if (page) setGmailMessages(prev => [...prev, ...data.messages]);
        else setGmailMessages(data.messages);
        setGmailNextPage(data.nextPage);
      }
    } catch {}
    setGmailLoading(false);
  }, []);

  const gmailSendReply = useCallback(async (to: string, subject: string, body: string, threadId?: string) => {
    setGmailSending(true);
    try {
      const res = await fetch("/api/gmail/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to, subject: subject.startsWith("Re:") ? subject : `Re: ${subject}`, body, threadId }),
      });
      const data = await res.json();
      if (data.success) {
        setGmailReply("");
        alert("‚úÖ Email inviata!");
        gmailFetchMessages();
      } else {
        alert("‚ùå Errore: " + (data.error || "invio fallito"));
      }
    } catch { alert("‚ùå Errore di rete"); }
    setGmailSending(false);
  }, []);

  const gmailMatchCommessa = useCallback((email: any) => {
    if (!email) return null;
    const fromLower = (email.from || "").toLowerCase();
    const subLower = (email.subject || "").toLowerCase();
    const bodyLower = (email.body || "").substring(0, 500).toLowerCase();
    const all = fromLower + " " + subLower + " " + bodyLower;
    // Match by commessa code (S-XXXX)
    const codeMatch = all.match(/s-\d{4}/i);
    if (codeMatch) {
      const cm = cantieri.find(c => c.code.toLowerCase() === codeMatch[0].toLowerCase());
      if (cm) return cm;
    }
    // Match by client email
    for (const cm of cantieri) {
      if (cm.email && fromLower.includes(cm.email.toLowerCase())) return cm;
    }
    // Match by client name
    for (const cm of cantieri) {
      const nome = (cm.cliente || "").toLowerCase();
      const cognome = (cm.cognome || "").toLowerCase();
      if (nome.length > 2 && (fromLower.includes(nome) || subLower.includes(nome))) return cm;
      if (cognome.length > 2 && (fromLower.includes(cognome) || subLower.includes(cognome))) return cm;
    }
    return null;
  }, [cantieri]);

  // Check Gmail on mount
  useEffect(() => { gmailCheckStatus(); }, []);
  const isTablet = winW >= 768;
  const isDesktop = winW >= 1024;

  const goBack = () => {
    if (homeView) { setHomeView(null); return; }
    if (showRiepilogo) { setShowRiepilogo(false); return; }
    if (selectedVano) { setSelectedVano(null); setVanoStep(0); return; }
    if (showNuovoRilievo) { setShowNuovoRilievo(false); return; }
    if (selectedRilievo) {
      setSelectedRilievo(null);
      // SYNC: rileggi selectedCM da cantieri per evitare dati stale (bug misure che spariscono)
      if (selectedCM) {
        setCantieri(cs => {
          const fresh = cs.find(c => c.id === selectedCM.id);
          if (fresh) setTimeout(() => setSelectedCM(fresh), 0);
          return cs;
        });
      }
      return;
    }
    if (selectedCM) { setSelectedCM(null); return; }
  };

  /* == Helpers == */
  // Ritorna i vani del rilievo attivo (o dell'ultimo se nessuno selezionato)
  const getVaniCM = (c) => {
    if (!c?.rilievi || c.rilievi.length === 0) return [];
    if (selectedRilievo && selectedCM?.id === c.id) return selectedRilievo.vani || [];
    return c.rilievi[c.rilievi.length - 1]?.vani || [];
  };
  const getVaniAttivi = (c) => {
    if (!c?.rilievi || c.rilievi.length === 0) return [];
    return c.rilievi[c.rilievi.length - 1]?.vani || [];
  };

  // === CALCOLO PREZZO VANO ‚Äî usato da Centro Comando, creaFattura, PDF ===
  const calcolaVanoPrezzo = (v, c) => {
    const m = v.misure || {};
    const lc = (m.lCentro || 0) / 1000, hc = (m.hCentro || 0) / 1000;
    const lmm = m.lCentro || 0, hmm = m.hCentro || 0;
    const mq = lc * hc, perim = 2 * (lc + hc);
    if (mq <= 0) return 0; // niente misure = niente prezzo
    const sysRec = sistemiDB.find(s => (s.marca + " " + s.sistema) === v.sistema || s.sistema === v.sistema);
    // Minimo mq
    const minCat = tipoToMinCat ? tipoToMinCat(v.tipo || "F1A") : "";
    const minimoMq = sysRec?.minimiMq?.[minCat] || 0;
    const mqCalc = (minimoMq > 0 && mq > 0 && mq < minimoMq) ? minimoMq : mq;
    // Grid or ‚Ç¨/mq
    let tot = 0;
    const gridPrice = sysRec?.griglia ? (() => {
      const g = sysRec.griglia;
      const exact = g.find(p => p.l >= lmm && p.h >= hmm);
      return exact ? exact.prezzo : (g.length > 0 ? g[g.length - 1].prezzo : null);
    })() : null;
    tot = gridPrice !== null ? gridPrice : mqCalc * parseFloat(sysRec?.prezzoMq || sysRec?.euroMq || c?.prezzoMq || 350);
    // Vetro
    const vetroRec = vetriDB.find(g => g.code === v.vetro || g.nome === v.vetro);
    if (vetroRec?.prezzoMq) tot += mq * parseFloat(vetroRec.prezzoMq);
    // Coprifilo
    const copRec = coprifiliDB.find(cp => cp.cod === v.coprifilo);
    if (copRec?.prezzoMl) tot += perim * parseFloat(copRec.prezzoMl);
    // Lamiera
    const lamRec = lamiereDB.find(l => l.cod === v.lamiera);
    if (lamRec?.prezzoMl) tot += lc * parseFloat(lamRec.prezzoMl);
    // Accessori
    const tapp = v.accessori?.tapparella; if (tapp?.attivo && c?.prezzoTapparella) { const tmq = ((tapp.l || lmm) / 1000) * ((tapp.h || hmm) / 1000); tot += tmq * parseFloat(c.prezzoTapparella); }
    const pers = v.accessori?.persiana; if (pers?.attivo && c?.prezzoPersiana) { const pmq = ((pers.l || lmm) / 1000) * ((pers.h || hmm) / 1000); tot += pmq * parseFloat(c.prezzoPersiana); }
    const zanz = v.accessori?.zanzariera; if (zanz?.attivo && c?.prezzoZanzariera) { const zmq = ((zanz.l || lmm) / 1000) * ((zanz.h || hmm) / 1000); tot += zmq * parseFloat(c.prezzoZanzariera); }
    // Voci libere del vano
    if (v.vociLibere?.length > 0) v.vociLibere.forEach(vl => { tot += (vl.prezzo || 0) * (vl.qta || 1); });
    return Math.round(tot * 100) / 100;
  };

  // Totale commessa calcolato = somma vani + voci libere della commessa
  const calcolaTotaleCommessa = (c) => {
    const vani = getVaniAttivi(c);
    const totVani = vani.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0);
    const totVoci = (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
    return totVani + totVoci;
  };
  const countVani = () => cantieri.reduce((s, c) => s + getVaniAttivi(c).length, 0);
  // Safety: ensure every cantiere has required fields
  const cantieriSafe = cantieri.filter(c => c && c.id && c.fase);
  if (cantieriSafe.length !== cantieri.length && cantieri.length > 0) {
    // Auto-fix: remove invalid entries
    setTimeout(() => setCantieri(cantieriSafe), 0);
  }
  const urgentCount = () => cantieriSafe.filter(c => c.alert).length;
  const readyCount = () => cantieriSafe.filter(c => c.fase === "posa" || c.fase === "chiusura").length;
  const faseIndex = (fase) => PIPELINE.findIndex(p => p.id === fase);
  const priColor = (p) => p === "alta" ? T.red : p === "media" ? T.orange : T.sub2;

  const toggleTask = (id) => setTasks(ts => ts.map(t => t.id === id ? { ...t, done: !t.done } : t));

  const addTask = () => {
    if (!newTask.text.trim()) return;
    setTasks(ts => [...ts, { id: Date.now(), ...newTask, done: false, allegati: [...taskAllegati] }]);
    setTaskAllegati([]);
    setNewTask({ text: "", meta: "", time: "", priority: "media", cm: "", date: "", persona: "" });
    setShowModal(null);
  };

  const addCommessa = () => {
    if (!newCM.cliente.trim()) return;
    if (!canDo("commessa")) return;
    const code = "S-" + String(cantieri.length + 1).padStart(4, "0");
    const nc = { id: Date.now(), code, cliente: newCM.cliente, cognome: newCM.cognome||"", indirizzo: newCM.indirizzo, telefono: newCM.telefono, email: newCM.email||"", fase: "sopralluogo", rilievi: [], sistema: newCM.sistema, tipo: newCM.tipo, difficoltaSalita: newCM.difficoltaSalita, mezzoSalita: newCM.mezzoSalita, foroScale: newCM.foroScale, pianoEdificio: newCM.pianoEdificio, note: newCM.note, allegati: [], creato: new Date().toLocaleDateString("it-IT",{day:"numeric",month:"short"}), aggiornato: new Date().toLocaleDateString("it-IT",{day:"numeric",month:"short"}), log: [{ chi: "Fabio", cosa: "creato la commessa", quando: "Adesso", color: T.sub }] };
    setCantieri(cs => [nc, ...cs]);
    setNewCM({ cliente: "", cognome: "", indirizzo: "", telefono: "", email: "", sistema: "", tipo: "nuova", difficoltaSalita: "", mezzoSalita: "", foroScale: "", pianoEdificio: "", note: "" });
    setShowModal(null);
    setSelectedCM(nc);
    setTab("commesse");
  };

  const addVano = () => {
    if (!selectedCM || !selectedRilievo) return;
    const tipObj = TIPOLOGIE_RAPIDE.find(t => t.code === newVano.tipo);
    const nome = newVano.nome.trim() || `${tipObj?.label || newVano.tipo} ${(selectedRilievo.vani?.length || 0) + 1}`;
    const v = { id: Date.now(), nome, tipo: newVano.tipo, stanza: newVano.stanza, piano: newVano.piano, sistema: newVano.sistema, pezzi: newVano.pezzi||1, coloreInt: newVano.coloreInt, coloreEst: newVano.coloreEst, bicolore: newVano.bicolore, coloreAcc: newVano.coloreAcc, vetro: newVano.vetro, telaio: newVano.telaio, telaioAlaZ: newVano.telaioAlaZ, rifilato: newVano.rifilato, rifilSx: newVano.rifilSx, rifilDx: newVano.rifilDx, rifilSopra: newVano.rifilSopra, rifilSotto: newVano.rifilSotto, coprifilo: newVano.coprifilo, lamiera: newVano.lamiera, misure: {}, foto: {}, note: "", cassonetto: false, accessori: { tapparella: { attivo: false }, persiana: { attivo: false }, zanzariera: { attivo: false } } };
    const updRilievo = { ...selectedRilievo, vani: [...(selectedRilievo.vani || []), v] };
    setCantieri(cs => cs.map(c => c.id === selectedCM.id ? { ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? updRilievo : r), aggiornato: "Oggi" } : c));
    setSelectedRilievo(updRilievo);
    setSelectedCM(prev => ({ ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo.id ? updRilievo : r) }));
    setNewVano(prev => ({ nome: "", tipo: prev.tipo, stanza: "Soggiorno", piano: prev.piano, sistema: prev.sistema, coloreInt: prev.coloreInt, coloreEst: prev.coloreEst, bicolore: prev.bicolore, coloreAcc: prev.coloreAcc, vetro: prev.vetro, telaio: prev.telaio, telaioAlaZ: prev.telaioAlaZ, rifilato: prev.rifilato, rifilSx: prev.rifilSx, rifilDx: prev.rifilDx, rifilSopra: prev.rifilSopra, rifilSotto: prev.rifilSotto, coprifilo: prev.coprifilo, lamiera: prev.lamiera }));
    setShowModal(null);
    setSelectedVano(v);
    setVanoStep(0);
  };

  const updateMisura = (vanoId, key, value) => {
    const numVal = parseInt(value) || 0;
    // Capture IDs NOW to prevent stale closures
    const cmId = selectedCM?.id;
    const rilId = selectedRilievo?.id;
    if (!cmId || !rilId) return;
    const updateVani = (vani) => vani.map(v => v.id === vanoId ? { ...v, misure: { ...v.misure, [key]: numVal } } : v);
    setCantieri(cs => cs.map(c => c.id === cmId ? {
      ...c, rilievi: c.rilievi.map(r => r.id === rilId ? { ...r, vani: updateVani(r.vani) } : r)
    } : c));
    setSelectedRilievo(prev => prev ? ({ ...prev, vani: updateVani(prev.vani) }) : prev);
    setSelectedCM(prev => prev ? ({
      ...prev, rilievi: prev.rilievi.map(r => r.id === rilId ? { ...r, vani: updateVani(r.vani) } : r)
    }) : prev);
    if (selectedVano?.id === vanoId) setSelectedVano(prev => ({ ...prev, misure: { ...prev.misure, [key]: numVal } }));
  };

  // Batch update: set multiple misure keys at once (no race conditions)
  const updateMisureBatch = (vanoId, updates: Record<string, number>) => {
    if (selectedRilievo) {
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? {
        ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? {
          ...r, vani: r.vani.map(v => v.id === vanoId ? { ...v, misure: { ...v.misure, ...updates } } : v)
        } : r)
      } : c));
      setSelectedRilievo(prev => prev ? ({
        ...prev, vani: prev.vani.map(v => v.id === vanoId ? { ...v, misure: { ...v.misure, ...updates } } : v)
      }) : prev);
      setSelectedCM(prev => prev ? ({
        ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo.id ? {
          ...r, vani: r.vani.map(v => v.id === vanoId ? { ...v, misure: { ...v.misure, ...updates } } : v)
        } : r)
      }) : prev);
    }
    if (selectedVano?.id === vanoId) setSelectedVano(prev => ({ ...prev, misure: { ...prev.misure, ...updates } }));
  };

  const toggleAccessorio = (vanoId, acc) => {
    if (selectedRilievo) {
      const updRil = { ...selectedRilievo, vani: selectedRilievo.vani.map(v => v.id === vanoId ? { ...v, accessori: { ...v.accessori, [acc]: { ...v.accessori[acc], attivo: !v.accessori[acc].attivo } } } : v) };
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) } : c));
      setSelectedRilievo(updRil);
    }
    if (selectedVano?.id === vanoId) setSelectedVano(prev => ({ ...prev, accessori: { ...prev.accessori, [acc]: { ...prev.accessori[acc], attivo: !prev.accessori[acc].attivo } } }));
  };

  const updateAccessorio = (vanoId, acc, field, value) => {
    if (selectedRilievo) {
      const updRil = { ...selectedRilievo, vani: selectedRilievo.vani.map(v => v.id === vanoId ? { ...v, accessori: { ...v.accessori, [acc]: { ...v.accessori[acc], [field]: value } } } : v) };
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) } : c));
      setSelectedRilievo(updRil);
      setSelectedCM(prev => prev ? ({ ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) }) : prev);
    }
    if (selectedVano?.id === vanoId) setSelectedVano(prev => ({ ...prev, accessori: { ...prev.accessori, [acc]: { ...prev.accessori[acc], [field]: value } } }));
  };

  const updateVanoField = (vanoId, field, value) => {
    if (selectedRilievo) {
      const updRil = { ...selectedRilievo, vani: selectedRilievo.vani.map(v => v.id === vanoId ? { ...v, [field]: value } : v) };
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) } : c));
      setSelectedRilievo(updRil);
      setSelectedCM(prev => prev ? ({ ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) }) : prev);
    }
    if (selectedVano?.id === vanoId) setSelectedVano(prev => ({ ...prev, [field]: value }));
  };

  // DELETE functions
  const deleteTask = (taskId) => { if ((()=>{try{return window.confirm("Eliminare questo task?");}catch(e){return false;}})()) setTasks(ts => ts.filter(t => t.id !== taskId)); };
  const deleteVano = (vanoId) => {
    if (!(()=>{try{return window.confirm("Eliminare questo vano e tutte le sue misure?");}catch(e){return false;}})()) return;
    if (selectedRilievo) {
      const updRil = { ...selectedRilievo, vani: selectedRilievo.vani.filter(v => v.id !== vanoId) };
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) } : c));
      setSelectedRilievo(updRil);
      setSelectedCM(prev => prev ? ({ ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo.id ? updRil : r) }) : prev);
    }
    if (selectedVano?.id === vanoId) { setSelectedVano(null); setVanoStep(0); }
  };
  const deleteCommessa = (cmId) => {
    if (!(()=>{try{return window.confirm("Eliminare questa commessa e tutti i suoi vani?");}catch(e){return false;}})()) return;
    setCantieri(cs => cs.filter(c => c.id !== cmId));
    if (selectedCM?.id === cmId) { setSelectedCM(null); setSelectedVano(null); }
  };
  const deleteEvent = (evId) => { if ((()=>{try{return window.confirm("Eliminare questo evento?");}catch(e){return false;}})()) setEvents(ev => ev.filter(e => e.id !== evId)); };
  const deleteMsg = (msgId) => { if ((()=>{try{return window.confirm("Eliminare questo messaggio?");}catch(e){return false;}})()) setMsgs(ms => ms.filter(m => m.id !== msgId)); };

  const addAllegato = (tipo, content, dataUrl?: string, durata?: string) => {
    if (!selectedCM) return;
    const a = { id: Date.now(), tipo, nome: content || (tipo === "file" ? "Allegato" : tipo === "vocale" ? "Nota vocale" : tipo === "video" ? "Video" : "Nota"), data: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), durata: durata || "", dataUrl: dataUrl || "" };
    setCantieri(cs => cs.map(x => x.id === selectedCM.id ? { ...x, allegati: [...(x.allegati || []), a] } : x));
    setSelectedCM(p => ({ ...p, allegati: [...(p.allegati || []), a] }));
  };

  const playAllegato = (id) => {
    if (playingId === id) {
      if (audioPlayRef.current) { audioPlayRef.current.pause(); audioPlayRef.current = null; }
      clearInterval(playInterval.current); setPlayingId(null); setPlayProgress(0); return;
    }
    clearInterval(playInterval.current);
    // find allegato dataUrl
    const allAllegati = (selectedCM?.allegati || []);
    const found = allAllegati.find(a => a.id === id);
    if (found?.dataUrl) {
      const audio = new Audio(found.dataUrl);
      audioPlayRef.current = audio;
      setPlayingId(id); setPlayProgress(0);
      audio.onended = () => { setPlayingId(null); setPlayProgress(0); audioPlayRef.current = null; };
      audio.ontimeupdate = () => { if (audio.duration) setPlayProgress((audio.currentTime / audio.duration) * 100); };
      audio.play().catch(() => {});
    } else {
      // fallback: fake progress for old entries without dataUrl
      setPlayingId(id); setPlayProgress(0);
      let prog = 0;
      playInterval.current = setInterval(() => { prog += 2; setPlayProgress(prog); if (prog >= 100) { clearInterval(playInterval.current); setPlayingId(null); setPlayProgress(0); } }, 100);
    }
  };

  const stopAllMedia = () => {
    if (mediaStreamRef.current) { mediaStreamRef.current.getTracks().forEach(t => t.stop()); mediaStreamRef.current = null; }
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== "inactive") { mediaRecorderRef.current.stop(); }
    mediaRecorderRef.current = null;
    mediaChunksRef.current = [];
  };

  const startMediaRecording = async (tipo: "vocale" | "video") => {
    try {
      let stream: MediaStream;
      if (tipo === "video" && mediaStreamRef.current) {
        // Camera preview already running ‚Äî add audio track to existing video stream
        const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const videoTrack = mediaStreamRef.current.getVideoTracks()[0];
        const audioTrack = audioStream.getAudioTracks()[0];
        stream = new MediaStream([videoTrack, audioTrack]);
        mediaStreamRef.current = stream;
      } else {
        const constraints = tipo === "video" 
          ? { audio: true, video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } } 
          : { audio: true };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        mediaStreamRef.current = stream;
      }
      if (tipo === "video" && videoPreviewRef.current) { videoPreviewRef.current.srcObject = stream; videoPreviewRef.current.play().catch(() => {}); }
      const mimeType = tipo === "video" 
        ? (MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus") ? "video/webm;codecs=vp9,opus" : "video/webm")
        : (MediaRecorder.isTypeSupported("audio/webm;codecs=opus") ? "audio/webm;codecs=opus" : "audio/webm");
      const recorder = new MediaRecorder(stream, { mimeType });
      mediaChunksRef.current = [];
      recorder.ondataavailable = (e) => { if (e.data.size > 0) mediaChunksRef.current.push(e.data); };
      recorder.start(200);
      mediaRecorderRef.current = recorder;
      setIsRecording(true); setRecSeconds(0);
      recInterval.current = setInterval(() => setRecSeconds(s => s + 1), 1000);
    } catch (err) {
      alert("‚ö†Ô∏è Impossibile accedere al " + (tipo === "video" ? "camera/microfono" : "microfono") + ". Controlla i permessi del browser.\n\n" + (err as Error).message);
    }
  };

  const stopMediaRecording = (tipo: "vocale" | "video") => {
    clearInterval(recInterval.current);
    const secs = recSeconds;
    return new Promise<void>((resolve) => {
      if (mediaRecorderRef.current && mediaRecorderRef.current.state !== "inactive") {
        mediaRecorderRef.current.onstop = () => {
          const blob = new Blob(mediaChunksRef.current, { type: tipo === "video" ? "video/webm" : "audio/webm" });
          const url = URL.createObjectURL(blob);
          const durStr = Math.floor(secs / 60) + ":" + String(secs % 60).padStart(2, "0");
          const nome = tipo === "video" 
            ? "Video " + new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" })
            : "Nota vocale " + new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
          addAllegato(tipo, nome, url, durStr);
          stopAllMedia();
          setIsRecording(false); setRecSeconds(0); setShowAllegatiModal(null);
          resolve();
        };
        mediaRecorderRef.current.stop();
      } else { setIsRecording(false); setRecSeconds(0); resolve(); }
      if (mediaStreamRef.current) { mediaStreamRef.current.getTracks().forEach(t => t.stop()); mediaStreamRef.current = null; }
    });
  };

  // CAMERA MODAL ‚Äî for taking photos and recording videos in vano
  // Image compression utility ‚Äî max 1200px wide, 0.7 JPEG quality
  const compressImage = (dataUrl: string, maxW = 1200, quality = 0.7): Promise<string> => {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => {
        const ratio = Math.min(maxW / img.width, maxW / img.height, 1);
        const w = Math.round(img.width * ratio), h = Math.round(img.height * ratio);
        const cv = document.createElement("canvas"); cv.width = w; cv.height = h;
        cv.getContext("2d")!.drawImage(img, 0, 0, w, h);
        resolve(cv.toDataURL("image/jpeg", quality));
      };
      img.src = dataUrl;
    });
  };

  const openCamera = async (mode: "foto" | "video", cat?: string) => {
    if (cat !== undefined) setPendingFotoCat(cat);
    setCameraMode(mode);
    setShowCameraModal(true);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }, 
        audio: mode === "video" 
      });
      cameraStreamRef.current = stream;
      setTimeout(() => {
        if (cameraPreviewRef.current) { cameraPreviewRef.current.srcObject = stream; cameraPreviewRef.current.play().catch(() => {}); }
      }, 100);
    } catch (err) {
      alert("‚ö†Ô∏è Impossibile accedere alla fotocamera. Controlla i permessi.\n\n" + (err as Error).message);
      setShowCameraModal(false);
    }
  };

  const capturePhoto = async () => {
    const video = cameraPreviewRef.current;
    if (!video) return;
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    const ctx = canvas.getContext("2d");
    if (ctx) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
    // Compress to max 1200px
    const compressed = await compressImage(dataUrl);
    const cat = pendingFotoCat;
    const key = "foto_" + Date.now();
    const fotoObj = { dataUrl: compressed, nome: "Foto " + new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), tipo: "foto", categoria: cat || null };
    if (selectedVano && selectedCM && selectedRilievo) {
      const v = selectedVano;
      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? { ...r2, vani: r2.vani.map(vn => vn.id === v.id ? { ...vn, foto: { ...(vn.foto||{}), [key]: fotoObj } } : vn) } : r2) } : c));
      setSelectedVano(prev => ({ ...prev, foto: { ...(prev.foto||{}), [key]: fotoObj } }));
    }
    // Flash effect + don't close (allow multiple shots)
  };

  const startCameraVideoRec = () => {
    const stream = cameraStreamRef.current;
    if (!stream) return;
    const mimeType = MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus") ? "video/webm;codecs=vp9,opus" : "video/webm";
    const recorder = new MediaRecorder(stream, { mimeType });
    mediaChunksRef.current = [];
    recorder.ondataavailable = (e) => { if (e.data.size > 0) mediaChunksRef.current.push(e.data); };
    recorder.start(200);
    mediaRecorderRef.current = recorder;
    setIsRecording(true); setRecSeconds(0);
    recInterval.current = setInterval(() => setRecSeconds(s => s + 1), 1000);
  };

  const stopCameraVideoRec = () => {
    clearInterval(recInterval.current);
    const secs = recSeconds;
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== "inactive") {
      mediaRecorderRef.current.onstop = () => {
        const blob = new Blob(mediaChunksRef.current, { type: "video/webm" });
        const dataUrl = URL.createObjectURL(blob);
        const key = "video_" + Date.now();
        const durStr = Math.floor(secs / 60) + ":" + String(secs % 60).padStart(2, "0");
        const vObj = { nome: "Video " + new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), tipo: "video", dataUrl, durata: durStr };
        if (selectedVano && selectedCM && selectedRilievo) {
          const v = selectedVano;
          setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? { ...r2, vani: r2.vani.map(vn => vn.id === v.id ? { ...vn, foto: { ...(vn.foto||{}), [key]: vObj } } : vn) } : r2) } : c));
          setSelectedVano(prev => ({ ...prev, foto: { ...(prev.foto||{}), [key]: vObj } }));
        }
        mediaChunksRef.current = [];
      };
      mediaRecorderRef.current.stop();
    }
    setIsRecording(false); setRecSeconds(0);
  };

  const closeCamera = () => {
    if (isRecording) stopCameraVideoRec();
    if (cameraStreamRef.current) { cameraStreamRef.current.getTracks().forEach(t => t.stop()); cameraStreamRef.current = null; }
    setShowCameraModal(false);
    setPendingFotoCat(null);
  };

  // IMPORT EXCEL CATALOG
  const importExcelCatalog = async (file) => {
    setImportStatus({ step: "loading", msg: "Caricamento file...", ok: false });
    setImportLog([]);
    const log = [];
    try {
      const XLSX = require("xlsx");
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      log.push("‚úÖ File letto: " + wb.SheetNames.length + " fogli trovati");
      setImportLog([...log]);

      const parseSheet = (name, requiredCols) => {
        const ws = wb.Sheets[name];
        if (!ws) { log.push("‚ö†Ô∏è Foglio '" + name + "' non trovato ‚Äî saltato"); return []; }
        const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });
        // Skip hint/example rows (first rows might be hints or green examples)
        const rows = raw.filter(r => {
          const vals = Object.values(r).map(v => String(v).trim()).filter(Boolean);
          return vals.length >= 2; // at least 2 non-empty values
        });
        log.push("üìã " + name + ": " + rows.length + " righe");
        return rows;
      };

      // SISTEMI
      setImportStatus({ step: "sistemi", msg: "Importazione sistemi...", ok: false });
      const sistRows = parseSheet("SISTEMI");
      if (sistRows.length > 0) {
        const newSist = sistRows.map((r, i) => ({
          id: 10000 + i,
          marca: r["Nome Sistema"] ? String(r["Marca"] || "").trim() : String(r["Marca"] || r["marca"] || "").trim(),
          sistema: String(r["Nome Sistema"] || r["sistema"] || "").trim(),
          euroMq: parseFloat(r["Uf (W/m¬≤K)"] || 0) || 0, // Will be set from TIPOLOGIE prices
          prezzoMq: 0,
          sovRAL: 15,
          sovLegno: 25,
          colori: [],
          sottosistemi: []
        })).filter(s => s.marca && s.sistema);
        if (newSist.length > 0) { setSistemiDB(newSist); log.push("‚úÖ " + newSist.length + " sistemi importati (catalogo sostituito)"); }
      }
      setImportLog([...log]);

      // COLORI
      setImportStatus({ step: "colori", msg: "Importazione colori...", ok: false });
      const colRows = parseSheet("COLORI");
      if (colRows.length > 0) {
        const newCol = colRows.map((r, i) => ({
          id: 20000 + i,
          nome: String(r["Nome"] || r["nome"] || "").trim(),
          code: String(r["RAL/Codice"] || r["Codice"] || r["code"] || "").trim() || String(r["Nome"] || "").trim(),
          hex: "#888888",
          tipo: String(r["Tipo"] || r["tipo"] || "RAL").trim()
        })).filter(c => c.nome);
        if (newCol.length > 0) { setColoriDB(newCol); log.push("‚úÖ " + newCol.length + " colori importati (catalogo sostituito)"); }
      }
      setImportLog([...log]);

      // VETRI
      setImportStatus({ step: "vetri", msg: "Importazione vetri...", ok: false });
      const vetRows = parseSheet("VETRI");
      if (vetRows.length > 0) {
        const newVet = vetRows.map((r, i) => ({
          id: 30000 + i,
          nome: String(r["Descrizione"] || r["nome"] || "").trim(),
          code: String(r["Composizione"] || r["Codice"] || r["code"] || "").trim(),
          ug: parseFloat(r["Ug (W/m¬≤K)"] || r["ug"] || 0) || 0,
          prezzoMq: parseFloat(r["Prezzo ‚Ç¨/mq"] || r["prezzoMq"] || 0) || 0,
        })).filter(v => v.nome || v.code);
        if (newVet.length > 0) { setVetriDB(newVet); log.push("‚úÖ " + newVet.length + " vetri importati (catalogo sostituito)"); }
      }
      setImportLog([...log]);

      // COPRIFILI
      setImportStatus({ step: "coprifili", msg: "Importazione coprifili...", ok: false });
      const copRows = parseSheet("COPRIFILI");
      if (copRows.length > 0) {
        const newCop = copRows.map((r, i) => ({
          id: 40000 + i,
          nome: String(r["Descrizione"] || r["nome"] || "").trim(),
          cod: String(r["Codice"] || r["cod"] || "").trim(),
          prezzoMl: parseFloat(r["Prezzo ‚Ç¨/ml"] || r["prezzoMl"] || 0) || 0,
        })).filter(c => c.nome || c.cod);
        if (newCop.length > 0) { setCoprifiliDB(newCop); log.push("‚úÖ " + newCop.length + " coprifili importati (catalogo sostituito)"); }
      }
      setImportLog([...log]);

      // LAMIERE
      setImportStatus({ step: "lamiere", msg: "Importazione lamiere...", ok: false });
      const lamRows = parseSheet("LAMIERE");
      if (lamRows.length > 0) {
        const newLam = lamRows.map((r, i) => ({
          id: 50000 + i,
          nome: String(r["Descrizione"] || r["nome"] || "").trim(),
          cod: String(r["Codice"] || r["cod"] || "").trim(),
          prezzoMl: parseFloat(r["Prezzo ‚Ç¨/ml"] || r["prezzoMl"] || 0) || 0,
        })).filter(l => l.nome || l.cod);
        if (newLam.length > 0) { setLamiereDB(newLam); log.push("‚úÖ " + newLam.length + " lamiere importate (catalogo sostituito)"); }
      }
      setImportLog([...log]);

      // ACCESSORI, TIPOLOGIE, CONTROTELAI, TAPPARELLE, ZANZARIERE, PERSIANE, SERVIZI, SAGOME
      const otherSheets = ["ACCESSORI", "TIPOLOGIE", "CONTROTELAI", "TAPPARELLE", "ZANZARIERE", "PERSIANE", "SERVIZI", "SAGOME_TELAIO", "PROFILI"];
      for (const sn of otherSheets) {
        const rows = parseSheet(sn);
        if (rows.length > 0) log.push("üì¶ " + sn + ": " + rows.length + " righe pronte (saranno usate nei prossimi aggiornamenti)");
      }
      setImportLog([...log]);

      log.push("");
      log.push("üéâ IMPORTAZIONE COMPLETATA!");
      log.push("I dati sono stati aggiunti al tuo catalogo.");
      log.push("Vai nelle singole sezioni per verificare.");
      setImportLog([...log]);
      setImportStatus({ step: "done", msg: "Importazione completata!", ok: true });
    } catch (err) {
      log.push("‚ùå ERRORE: " + err.message);
      setImportLog([...log]);
      setImportStatus({ step: "error", msg: "Errore durante l'importazione", ok: false, detail: err.message });
    }
  };

  // SETTINGS CRUD
  const addSettingsItem = () => {
    const f = settingsForm;
    if (settingsModal === "sistema" && f.marca && f.sistema) {
      setSistemiDB(s => [...s, { id: Date.now(), marca: f.marca, sistema: f.sistema, euroMq: parseInt(f.euroMq)||0, prezzoMq: parseFloat(f.prezzoMq||f.euroMq)||0, sovRAL: parseInt(f.sovRAL)||0, sovLegno: parseInt(f.sovLegno)||0, minimiMq: {}, colori: [], sottosistemi: f.sottosistemi ? f.sottosistemi.split(",").map(s => s.trim()) : [], griglia: [] }]);
    } else if (settingsModal === "colore" && f.nome && f.code) {
      setColoriDB(c => [...c, { id: Date.now(), nome: f.nome, code: f.code, hex: f.hex || "#888888", tipo: f.tipo || "RAL" }]);
    } else if (settingsModal === "vetro" && f.nome && f.code) {
      setVetriDB(v => [...v, { id: Date.now(), nome: f.nome, code: f.code, ug: parseFloat(f.ug)||1.0, prezzoMq: parseFloat(f.prezzoMq)||0 }]);
    } else if (settingsModal === "coprifilo" && f.nome && f.cod) {
      setCoprifiliDB(c => [...c, { id: Date.now(), nome: f.nome, cod: f.cod, prezzoMl: parseFloat(f.prezzoMl)||0 }]);
    } else if (settingsModal === "lamiera" && f.nome && f.cod) {
      setLamiereDB(l => [...l, { id: Date.now(), nome: f.nome, cod: f.cod, prezzoMl: parseFloat(f.prezzoMl)||0 }]);
    } else if (settingsModal === "tipologia" && f.code && f.label) {
      TIPOLOGIE_RAPIDE.push({ code: f.code, label: f.label, icon: f.icon || "ü™ü", cat: f.cat || "Altro", forma: f.forma || "rettangolare" });
    } else if (settingsModal === "membro" && f.nome) {
      const colori = ["#007aff","#34c759","#af52de","#ff9500","#ff3b30","#5ac8fa"];
      setTeam(t => [...t, { id: Date.now(), nome: f.nome, ruolo: f.ruolo || "Posatore", compiti: f.compiti || "", colore: colori[t.length % colori.length] }]);
    } else return;
    setSettingsModal(null); setSettingsForm({});
  };
  const deleteSettingsItem = (type, id) => {
    if (!(()=>{try{return window.confirm("Eliminare?");}catch(e){return false;}})()) return;
    if (type === "sistema") setSistemiDB(s => s.filter(x => x.id !== id));
    if (type === "colore") setColoriDB(c => c.filter(x => x.id !== id));
    if (type === "vetro") setVetriDB(v => v.filter(x => x.id !== id));
    if (type === "coprifilo") setCoprifiliDB(c => c.filter(x => x.id !== id));
    if (type === "lamiera") setLamiereDB(l => l.filter(x => x.id !== id));
  };

  const advanceFase = (cmId) => {
    const FASE_TEAM = { preventivo: "Sara Greco", conferma: "Sara Greco", misure: "Marco Ferraro", ordini: "Sara Greco", produzione: "Marco Ferraro", posa: "Marco Ferraro", chiusura: "Fabio Cozza" };
    setCantieri(cs => cs.map(c => {
      if (c.id !== cmId) return c;
      const idx = faseIndex(c.fase);
      if (idx < PIPELINE.length - 1) {
        const next = PIPELINE[idx + 1];
        return { ...c, fase: next.id, log: [{ chi: "Fabio", cosa: `avanzato a ${next.nome}`, quando: "Adesso", color: next.color }, ...(c.log||[])] };
      }
      return c;
    }));
    if (selectedCM?.id === cmId) {
      const idx = faseIndex(selectedCM.fase);
      if (idx < PIPELINE.length - 1) {
        const next = PIPELINE[idx + 1];
        const addetto = FASE_TEAM[next.id] || "Fabio Cozza";
        setSelectedCM(prev => ({ ...prev, fase: next.id, log: [{ chi: "Fabio", cosa: `avanzato a ${next.nome}`, quando: "Adesso", color: next.color }, ...prev.log] }));
        setFaseNotif({ fase: next.nome, addetto, color: next.color });
        setTimeout(() => setFaseNotif(null), 4000);
      }
    }
  };

  // === AUTO-ADVANCE: sincronizza fase pipeline con azioni reali ===
  const setFaseTo = (cmId: string, targetFase: string) => {
    const targetIdx = faseIndex(targetFase);
    setCantieri(cs => cs.map(c => {
      if (c.id !== cmId) return c;
      const curIdx = faseIndex(c.fase);
      if (targetIdx > curIdx) {
        return { ...c, fase: targetFase, log: [{ chi: "MASTRO", cosa: `auto ‚Üí ${PIPELINE.find(p=>p.id===targetFase)?.nome}`, quando: "Adesso", color: PIPELINE.find(p=>p.id===targetFase)?.color || "#007aff" }, ...(c.log||[])] };
      }
      return c;
    }));
    if (selectedCM?.id === cmId) {
      const curIdx = faseIndex(selectedCM.fase);
      if (targetIdx > curIdx) {
        const next = PIPELINE.find(p => p.id === targetFase);
        setSelectedCM(prev => ({ ...prev, fase: targetFase, log: [{ chi: "MASTRO", cosa: `auto ‚Üí ${next?.nome}`, quando: "Adesso", color: next?.color || "#007aff" }, ...(prev?.log||[])] }));
        setFaseNotif({ fase: next?.nome || targetFase, addetto: "Auto", color: next?.color || "#007aff" });
        setTimeout(() => setFaseNotif(null), 3000);
      }
    }
  };


  const addEvent = () => {
    const _evTitle = newEvent.text.trim() || (newEvent.persona ? "Appuntamento " + newEvent.persona : "");
    if (!_evTitle) return;
    newEvent.text = _evTitle;
    // If tipo is "task", create a task instead of an event
    if (newEvent.tipo === "task") {
      const taskDate = newEvent.date || selDate.toISOString().split("T")[0];
      setTasks(ts => [...ts, { id: Date.now(), text: newEvent.text, meta: (newEvent as any)._taskMeta || "", time: newEvent.time, priority: (newEvent as any)._taskPriority || "media", cm: newEvent.cm, date: taskDate, persona: newEvent.persona, done: false, allegati: [] }]);
      setNewEvent({ text: "", time: "", tipo: "sopralluogo", cm: "", persona: "", date: "", reminder: "", addr: "" });
      setShowNewEvent(false);
      return;
    }
    if ((newEvent as any)._newCliente && (newEvent as any)._nomeCliente) {
      const nc = { id: "CT-" + Date.now(), nome: (newEvent as any)._nomeCliente, cognome: (newEvent as any)._cognomeCliente || "", tipo: "cliente", telefono: (newEvent as any)._telCliente || "", indirizzo: (newEvent as any)._addrCliente || "" };
      setContatti(prev => [...prev, nc]);
      newEvent.persona = nc.nome + (nc.cognome ? " " + nc.cognome : "");
    }
    if (!newEvent.time) newEvent.time = "09:00";
    setEvents(ev => [...ev, { id: Date.now(), ...newEvent, date: newEvent.date || selDate.toISOString().split("T")[0], addr: newEvent.addr || "", color: tipoEvColor(newEvent.tipo) }]);
    setNewEvent({ text: "", time: "", tipo: "sopralluogo", cm: "", persona: "", date: "", reminder: "", addr: "" });
    setShowNewEvent(false);
  };


  // ‚ïê‚ïê‚ïê CONVERTI EVENTO ‚ïê‚ïê‚ïê
  const convertEvent = (evId, newTipo) => {
    setEvents(prev => prev.map(e => e.id === evId ? { ...e, tipo: newTipo, color: tipoEvColor(newTipo) } : e));
  };
  const linkEventToCM = (evId, cmId) => {
    setEvents(prev => prev.map(e => e.id === evId ? { ...e, cm: cmId } : e));
  };

  // ‚ïê‚ïê‚ïê FATTURE PASSIVE ‚ïê‚ïê‚ïê
  const creaFatturaPassiva = () => {
    const fp = { ...newFattPassiva, id: "fp_" + Date.now(), importo: parseFloat(String(newFattPassiva.importo)) || 0, dataISO: newFattPassiva.data || new Date().toISOString().split("T")[0] };
    setFatturePassive(prev => [...prev, fp]);
    setNewFattPassiva({ fornitore: "", numero: "", data: "", importo: 0, iva: 22, descrizione: "", cmId: "", pagata: false, scadenza: "" });
    setShowFatturaPassiva(false);
  };

  // ‚ïê‚ïê‚ïê VOCE AI ‚ïê‚ïê‚ïê
  const startVoice = () => {
    if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) { alert("Browser non supporta riconoscimento vocale"); return; }
    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
    const recog = new SR();
    recog.continuous = true; recog.interimResults = true; recog.lang = "it-IT";
    recog.onresult = (e: any) => {
      let t = ""; for (let i = e.resultIndex; i < e.results.length; i++) t += e.results[i][0].transcript;
      setVoiceTranscript(t);
    };
    recog.onerror = () => setVoiceActive(false);
    recog.onend = () => setVoiceActive(false);
    recog.start(); recognitionRef.current = recog; setVoiceActive(true);
  };
  const stopVoice = () => { recognitionRef.current?.stop(); setVoiceActive(false); };


  const sendCommessa = () => {
    setSendConfirm("sent");
    setTimeout(() => { setSendConfirm(null); setShowSendModal(false); }, 2500);
  };

  const handleAI = () => {
    if (!aiInput.trim()) return;
    const q = aiInput.toLowerCase();
    setAiMsgs(m => [...m, { role: "user", text: aiInput }]);
    setAiInput("");
    let resp = "Non ho capito, prova a riformulare la domanda.";
    if (q.includes("oggi") || q.includes("programma")) {
      const t = tasks.filter(x => !x.done);
      resp = `Oggi hai ${t.length} task aperti:\n${t.map((x, i) => `${i + 1}. ${x.text}${x.time ? ` (${x.time})` : ""}`).join("\n")}`;
    } else if (q.includes("commess") || q.includes("stato") || q.includes("pipeline")) {
      resp = `Hai ${cantieri.length} commesse:\n${cantieri.map(c => `‚Ä¢ ${c.code} ${c.cliente} ‚Äî ${PIPELINE.find(p => p.id === c.fase)?.nome}`).join("\n")}`;
    } else if (q.includes("vani") || q.includes("misur")) {
      resp = `Totale vani: ${countVani()}\nCommesse con vani da misurare:\n${cantieri.filter(c => getVaniAttivi(c).some(v => Object.keys(v.misure || {}).length < 6)).map(c => `‚Ä¢ ${c.code}: ${getVaniAttivi(c).filter(v => Object.keys(v.misure || {}).length < 6).length} vani incompleti`).join("\n")}`;
    } else if (q.includes("urgent") || q.includes("priorit")) {
      const u = tasks.filter(x => x.priority === "alta" && !x.done);
      resp = u.length ? `Task urgenti:\n${u.map(x => `‚Ä¢ ${x.text}`).join("\n")}` : "Nessun task urgente!";
    }
    setTimeout(() => setAiMsgs(m => [...m, { role: "ai", text: resp }]), 300);
  };

  const exportPDF = () => {
    if (!selectedCM) return;
    const cm = selectedCM;
    let html = `<html><head><title>MASTRO MISURE ‚Äî ${cm.code}</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px}h1{color:#0066cc;border-bottom:3px solid #0066cc;padding-bottom:10px}h2{color:#333;margin-top:30px}.vano{border:1px solid #ddd;border-radius:8px;padding:15px;margin:10px 0;page-break-inside:avoid}.misure-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}.m-item{background:#f5f5f7;padding:6px 10px;border-radius:4px;font-size:13px}.m-label{color:#666;font-size:11px}.m-val{font-weight:700;color:#1d1d1f}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.info{color:#666;font-size:13px}@media print{body{padding:0}}</style></head><body>`;
    html += `<div class="header"><div><h1>MASTRO MISURE</h1><p class="info">Report Misure ‚Äî ${cm.code}</p></div><div style="text-align:right"><p><strong>${cm.cliente}</strong></p><p class="info">${cm.indirizzo}</p><p class="info">Sistema: ${cm.sistema || "N/D"} | Tipo: ${cm.tipo === "riparazione" ? "Riparazione" : "Nuova"}</p></div></div>`;
    const vaniExport = getVaniAttivi(cm);
    vaniExport.forEach((v, i) => {
      const m = v.misure || {};
      html += `<div class="vano"><h3>${i + 1}. ${v.nome} ‚Äî ${v.tipo} (${v.stanza}, ${v.piano})</h3><div class="misure-grid">`;
      [["L alto", m.lAlto], ["L centro", m.lCentro], ["L basso", m.lBasso], ["H sinistra", m.hSx], ["H centro", m.hCentro], ["H destra", m.hDx], ["Diag. 1", m.d1], ["Diag. 2", m.d2], ["Spall. SX", m.spSx], ["Spall. DX", m.spDx], ["Architrave", m.arch], ["Dav. int.", m.davInt], ["Dav. est.", m.davEst]].forEach(([l, val]) => {
        html += `<div class="m-item"><div class="m-label">${l}</div><div class="m-val">${val || "‚Äî"} mm</div></div>`;
      });
      html += `</div>`;
      if (v.cassonetto) html += `<p style="margin-top:8px;font-size:13px">Cassonetto${v.casTipo ? " " + v.casTipo : ""}: ${(v.misure||{}).casL || "‚Äî"}√ó${(v.misure||{}).casH || "‚Äî"}√ó${(v.misure||{}).casP || "‚Äî"} mm</p>`;
      if (v.note) html += `<p style="margin-top:4px;font-size:12px;color:#666">Note: ${v.note}</p>`;
      html += `</div>`;
    });
    html += `<div style="margin-top:40px;border-top:1px solid #ddd;padding-top:20px;display:flex;justify-content:space-between"><div><p class="info">Firma tecnico</p><div style="border-bottom:1px solid #333;width:200px;height:40px"></div></div><div><p class="info">Firma cliente</p><div style="border-bottom:1px solid #333;width:200px;height:40px"></div></div></div>`;
    html += `<p style="text-align:center;margin-top:30px;color:#999;font-size:11px">Generato da MASTRO MISURE ‚Äî ${new Date().toLocaleDateString("it-IT")}</p></body></html>`;
    const w = window.open("", "_blank");
    w.document.write(html);
    w.document.close();
    setTimeout(() => w.print(), 500);
  };

  /* ======= STYLES ======= */
  const fs = isDesktop ? 1.1 : isTablet ? 1.05 : 1;
  const S = {
    app: { fontFamily: FF, background: T.bg, color: T.text, width: "100%", minHeight: "100vh", position: "relative", WebkitFontSmoothing: "antialiased" },
    header: { padding: `${14*fs}px ${16*fs}px ${12*fs}px`, background: T.card, borderBottom: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 10 },
    headerTitle: { fontSize: 19*fs, fontWeight: 700, letterSpacing: -0.3, color: T.text },
    headerSub: { fontSize: 12*fs, color: T.sub, marginTop: 1 },
    section: { margin: `0 ${16*fs}px`, padding: "10px 0 4px", display: "flex", justifyContent: "space-between", alignItems: "center" },
    sectionTitle: { fontSize: 13*fs, fontWeight: 700, color: T.text },
    sectionBtn: { fontSize: 12*fs, color: T.acc, fontWeight: 600, background: "none", border: "none", cursor: "pointer" },
    card: { background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, overflow: "hidden", marginBottom: 8, cursor: "pointer", transition: "box-shadow 0.15s" },
    cardInner: { padding: `${12*fs}px ${14*fs}px` },
    chip: (active) => ({ padding: `${6*fs}px ${12*fs}px`, borderRadius: 8, border: `1px solid ${active ? T.acc : T.bdr}`, background: active ? T.acc : T.card, color: active ? "#fff" : T.text, fontSize: 12*fs, fontWeight: 600, cursor: "pointer", whiteSpace: "nowrap", flexShrink: 0, transition: "all 0.15s" }),
    stat: { flex: 1, textAlign: "center", padding: `${10*fs}px 4px`, background: T.card, cursor: "pointer" },
    statNum: { fontSize: 18*fs, fontWeight: 700 },
    statLabel: { fontSize: 9*fs, color: T.sub, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.3, marginTop: 1 },
    badge: (bg, color) => ({ fontSize: 11*fs, fontWeight: 600, padding: `${3*fs}px ${8*fs}px`, borderRadius: 6, background: bg, color, display: "inline-block" }),
    input: { width: "100%", padding: `${10*fs}px ${12*fs}px`, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 14*fs, color: T.text, outline: "none", fontFamily: FF, boxSizing: "border-box" },
    select: { width: "100%", padding: `${10*fs}px ${12*fs}px`, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 14*fs, color: T.text, outline: "none", fontFamily: FF, boxSizing: "border-box" },
    btn: { width: "100%", padding: `${14*fs}px`, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 15*fs, fontWeight: 700, cursor: "pointer", fontFamily: FF },
    btnCancel: { width: "100%", padding: `${12*fs}px`, borderRadius: 10, border: "none", background: "none", color: T.sub, fontSize: 14*fs, fontWeight: 600, cursor: "pointer", fontFamily: FF },
    tabBar: { position: "fixed", bottom: 0, left: 0, right: 0, width: "100%", background: T.card + "ee", backdropFilter: "blur(20px)", borderTop: `1px solid ${T.bdr}`, display: "flex", padding: `${6*fs}px 0 ${8*fs}px`, zIndex: 100 },
    tabItem: (active) => ({ flex: 1, textAlign: "center", padding: "4px 0", cursor: "pointer", opacity: active ? 1 : 0.5, transition: "opacity 0.15s" }),
    tabLabel: (active) => ({ fontSize: 10*fs, fontWeight: 600, color: active ? T.acc : T.sub, marginTop: 1 }),
    modal: { position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.4)", zIndex: 200, display: "flex", justifyContent: "center", alignItems: "flex-end" },
    modalInner: { background: T.card, borderRadius: "16px 16px 0 0", width: "100%", maxWidth: isDesktop ? 600 : 500, padding: `${20*fs}px ${16*fs}px ${30*fs}px`, maxHeight: "85vh", overflowY: "auto" },
    modalTitle: { fontSize: 17*fs, fontWeight: 700, marginBottom: 16, color: T.text },
    fieldLabel: { fontSize: 12*fs, fontWeight: 600, color: T.sub, marginBottom: 4, display: "block" },
    pipeStep: (done, current) => ({ display: "flex", flexDirection: "column", alignItems: "center", minWidth: 52, cursor: "pointer" }),
    pipeCircle: (done, current, color) => ({ width: current ? 32 : 26, height: current ? 32 : 26, borderRadius: "50%", background: done ? color : "transparent", border: done ? "none" : current ? `3px solid ${color}` : `2px dashed ${T.bdr}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: current ? 14 : 12, boxShadow: current ? `0 0 12px ${color}40` : "none", transition: "all 0.2s" }),
    pipeLine: (done) => ({ flex: 1, height: 2, background: done ? T.grn : T.bdr, minWidth: 12, alignSelf: "center", marginTop: -14 }),
    pipeLabel: (current) => ({ fontSize: 9*fs, fontWeight: current ? 700 : 500, color: current ? T.text : T.sub, marginTop: 4, textAlign: "center", maxWidth: 52 }),
  };

  /* ======= CALENDAR STRIP ======= */
  const today = new Date();
  const calDays = Array.from({ length: 9 }, (_, i) => {
    const d = new Date(today); d.setDate(d.getDate() + i - 2);
    return { day: d.getDate(), name: ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"][d.getDay()], isToday: i === 2, hasDot: [0, 2, 4, 6].includes(i) };
  });

  /* ======= PIPELINE COMPONENT ======= */
  const PipelineBar = ({ fase }) => {
    const idx = faseIndex(fase);
    return (
      <div style={{ display: "flex", alignItems: "flex-start", gap: 0, overflowX: "auto", padding: "8px 0", WebkitOverflowScrolling: "touch" }}>
        {PIPELINE.map((p, i) => {
          const done = i < idx;
          const current = i === idx;
          return (
            <div key={p.id} style={{ display: "flex", alignItems: "flex-start", flex: i < PIPELINE.length - 1 ? 1 : "none" }}>
              <div style={S.pipeStep(done, current)}>
                <div style={S.pipeCircle(done, current, p.color)}>
                  {done ? <span style={{ color: "#fff", fontSize: 12, fontWeight: 700 }}>‚úì</span> : <span>{p.ico}</span>}
                </div>
                <div style={S.pipeLabel(current)}>{p.nome}</div>
              </div>
              {i < PIPELINE.length - 1 && <div style={S.pipeLine(done)} />}
            </div>
          );
        })}
      </div>
    );
  };

  /* ======= VANO SVG SCHEMA ======= */
  const VanoSVG = ({ v, onTap }) => {
    const m = v.misure || {};
    return (
      <svg viewBox="0 0 200 260" style={{ width: "100%", maxWidth: 280, display: "block", margin: "0 auto" }}>
        {/* Vano outline */}
        <rect x="30" y="15" width="140" height="220" fill={T.accLt} stroke={T.acc} strokeWidth={1.5} rx={2} />
        {/* Spallette */}
        <rect x="15" y="12" width="15" height="226" fill={T.blueLt} stroke={T.blue} strokeWidth={0.5} rx={1} strokeDasharray="3,2" />
        <rect x="170" y="12" width="15" height="226" fill={T.blueLt} stroke={T.blue} strokeWidth={0.5} rx={1} strokeDasharray="3,2" />
        {/* Cassonetto */}
        {v.cassonetto && <rect x="28" y="0" width="144" height="15" fill={T.orangeLt} stroke={T.orange} strokeWidth={0.5} rx={2} />}
        {v.cassonetto && <text x="100" y="11" textAnchor="middle" fontSize={7} fill={T.orange} fontFamily={FM}>CASSONETTO</text>}
        {/* Davanzale */}
        <line x1="25" y1="237" x2="175" y2="237" stroke={T.sub2} strokeWidth={1} strokeDasharray="4,3" />
        <text x="100" y="252" textAnchor="middle" fontSize={8} fill={T.sub2} fontFamily={FM}>Davanzale</text>
        {/* 3 Larghezze lines */}
        <line x1="35" y1="28" x2="165" y2="28" stroke={T.acc + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        <line x1="35" y1="125" x2="165" y2="125" stroke={T.acc + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        <line x1="35" y1="222" x2="165" y2="222" stroke={T.acc + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        {/* 3 Altezze lines */}
        <line x1="35" y1="20" x2="35" y2="232" stroke={T.blue + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        <line x1="100" y1="20" x2="100" y2="232" stroke={T.blue + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        <line x1="165" y1="20" x2="165" y2="232" stroke={T.blue + "40"} strokeWidth={0.5} strokeDasharray="3,3" />
        {/* Diagonals */}
        <line x1="35" y1="20" x2="165" y2="232" stroke={T.purple + "30"} strokeWidth={0.5} strokeDasharray="4,3" />
        <line x1="165" y1="20" x2="35" y2="232" stroke={T.purple + "30"} strokeWidth={0.5} strokeDasharray="4,3" />
        {/* Tap points */}
        {PUNTI_MISURE.map(p => {
          const val = m[p.key];
          const col = T[p.color] || T.acc;
          return (
            <g key={p.key} onClick={() => onTap && onTap(p.key)} style={{ cursor: "pointer" }}>
              <circle cx={p.x} cy={p.y} r={val ? 14 : 12} fill={val ? col + "20" : T.bdr + "60"} stroke={val ? col : T.sub2} strokeWidth={val ? 1.5 : 1} />
              <text x={p.x} y={p.y + (val ? 1 : 4)} textAnchor="middle" fontSize={val ? 8 : 7} fill={val ? col : T.sub} fontWeight={val ? 700 : 500} fontFamily={FM} dominantBaseline="middle">
                {val || p.label}
              </text>
            </g>
          );
        })}
        {/* Spalletta labels */}
        <text x="22" y="130" textAnchor="middle" fontSize={7} fill={T.sub} fontFamily={FM} transform="rotate(-90,22,130)">
          Sp.SX {m.spSx || ""}
        </text>
        <text x="178" y="130" textAnchor="middle" fontSize={7} fill={T.sub} fontFamily={FM} transform="rotate(90,178,130)">
          Sp.DX {m.spDx || ""}
        </text>
      </svg>
    );
  };

  /* ======= FILTERED CANTIERI ======= */
  const filtered = cantieri.filter(c => {
    if (filterFase !== "tutte" && c.fase !== filterFase) return false;
    if (searchQ && !c.cliente.toLowerCase().includes(searchQ.toLowerCase()) && !c.code.toLowerCase().includes(searchQ.toLowerCase())) return false;
    return true;
  });

  /* ==================================== */
  /* ====       RENDER SECTIONS       == */
  /* ==================================== */

  /* == HOME TAB == */
  const toggleCollapse = (id: string) => setCollapsed(prev => ({ ...prev, [id]: !prev[id] }));
  const SectionHead = ({ id, icon, title, count, countColor, extra }: { id: string; icon: string; title: string; count?: number; countColor?: string; extra?: any }) => (
    <div style={{ ...S.section, margin: "0 16px" }}>
      <div onClick={() => toggleCollapse(id)} style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer", flex: 1 }}>
        <span style={{ fontSize: 13 }}>{icon}</span>
        <span style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{title}</span>
        {count !== undefined && count > 0 && (
          <span style={{ ...S.badge(countColor ? countColor + "18" : T.acc + "18", countColor || T.acc), fontSize: 10, fontWeight: 800 }}>{count}</span>
        )}
        <span style={{ fontSize: 8, color: T.sub, marginLeft: 2, transform: collapsed[id] ? "rotate(-90deg)" : "rotate(0deg)", transition: "transform 0.15s", display: "inline-block" }}>‚ñº</span>
      </div>
      {extra}
    </div>
  );

  // === üéØ CARICA DEMO COMPLETO ‚Äî forza TUTTI i dati per vedere il ciclo ===
  const caricaDemoCompleto = () => {
    const oggi = new Date().toISOString().split("T")[0];
    const ieri = (() => { const d = new Date(); d.setDate(d.getDate()-1); return d.toISOString().split("T")[0]; })();
    const domani = (() => { const d = new Date(); d.setDate(d.getDate()+1); return d.toISOString().split("T")[0]; })();
    const fra3 = (() => { const d = new Date(); d.setDate(d.getDate()+3); return d.toISOString().split("T")[0]; })();
    const fra7 = (() => { const d = new Date(); d.setDate(d.getDate()+7); return d.toISOString().split("T")[0]; })();
    const fra14 = (() => { const d = new Date(); d.setDate(d.getDate()+14); return d.toISOString().split("T")[0]; })();

    // Vano factory
    const mkVano = (id, nome, tipo, stanza, piano, l, h, sys = "Aluplast Ideal 4000", colEst = "RAL 7016") => ({
      id, nome, tipo, stanza, piano, sistema: sys, pezzi: 1,
      coloreInt: "RAL 9010", coloreEst: colEst, bicolore: colEst !== "RAL 9010",
      coloreAcc: "", vetro: "", telaio: "", coprifilo: "", lamiera: "",
      misure: { lAlto: l+3, lCentro: l, lBasso: l-2, hSx: h, hCentro: h, hDx: h-3, d1: Math.round(Math.sqrt(l*l+h*h)), d2: Math.round(Math.sqrt(l*l+h*h))-2 },
      foto: {}, note: "", cassonetto: false,
      accessori: { tapparella: { attivo: false }, persiana: { attivo: false }, zanzariera: { attivo: false } },
    });

    // 4 COMMESSE a stadi diversi
    const cm1 = {
      id: 9001, code: "S-0001", cliente: "Giuseppe", cognome: "Verdi",
      indirizzo: "Via Garibaldi 12, Rende (CS)", telefono: "347 555 1234", email: "giuseppe.verdi@email.it",
      fase: "sopralluogo", sistema: "Aluplast Ideal 4000", tipo: "nuova",
      note: "Appartamento 2¬∞ piano. 5 finestre da sostituire.", prezzoMq: 180,
      rilievi: [], allegati: [], cf: "VRDGPP80A01D086Z", ivaPerc: 10,
      creato: "25 feb", aggiornato: oggi,
      log: [{ chi: "Fabio", cosa: "creato la commessa", quando: "2 giorni fa", color: "#86868b" }],
    };

    const vaniAnna = [
      mkVano(9101, "Finestra Soggiorno", "F2A", "Soggiorno", "1¬∞", 1200, 1400),
      mkVano(9102, "Portafinestra Camera", "PF2A", "Camera", "1¬∞", 1400, 2200),
      mkVano(9103, "Vasistas Bagno", "VAS", "Bagno", "1¬∞", 600, 600),
      mkVano(9104, "Scorrevole Salone", "SC2A", "Salone", "1¬∞", 1800, 2200),
    ];
    const cm2 = {
      id: 9002, code: "S-0002", cliente: "Anna", cognome: "Bianchi",
      indirizzo: "Corso Mazzini 88, Cosenza (CS)", telefono: "339 888 5678", email: "anna.bianchi@gmail.com",
      fase: "preventivo", sistema: "Aluplast Ideal 4000", tipo: "nuova", prezzoMq: 180,
      note: "Ristrutturazione. IVA 10%. RAL 7016 esterno.",
      rilievi: [{ id: 9201, n: 1, data: "2026-02-20", ora: "09:30", rilevatore: "Fabio", tipo: "rilievo", stato: "completato", motivoModifica: "", note: "", vani: vaniAnna }],
      allegati: [], cf: "BNCNNA85C41D086Y", ivaPerc: 10,
      creato: "20 feb", aggiornato: "22 feb",
      log: [
        { chi: "Fabio", cosa: "completato rilievo ‚Äî 4 vani", quando: "5 giorni fa", color: "#5856d6" },
        { chi: "Fabio", cosa: "creato la commessa", quando: "7 giorni fa", color: "#86868b" },
      ],
    };

    const vaniMario = [
      mkVano(9111, "Finestra Soggiorno", "F2A", "Soggiorno", "3¬∞", 1200, 1400, "Aluplast Ideal 4000", "RAL 9010"),
      mkVano(9112, "Finestra Camera 1", "F2A", "Camera", "3¬∞", 1000, 1200, "Aluplast Ideal 4000", "RAL 9010"),
      mkVano(9113, "Portafinestra Salone", "PF2A", "Salone", "3¬∞", 1400, 2200, "Aluplast Ideal 4000", "RAL 9010"),
      mkVano(9114, "Vasistas Bagno", "VAS", "Bagno", "3¬∞", 600, 600, "Aluplast Ideal 4000", "RAL 9010"),
    ];
    const cm3 = {
      id: 9003, code: "S-0003", cliente: "Mario", cognome: "Rossi",
      indirizzo: "Via Roma 42, Cosenza (CS)", telefono: "338 123 4567", email: "mario.rossi@libero.it",
      fase: "ordini", sistema: "Aluplast Ideal 4000", tipo: "nuova", prezzoMq: 180,
      note: "4 vani. Bonus 50%.",
      firmaCliente: true, dataFirma: "2026-02-15", confermato: true,
      rilievi: [{ id: 9202, n: 1, data: "2026-02-10", ora: "10:00", rilevatore: "Fabio", tipo: "rilievo", stato: "completato", motivoModifica: "", note: "", vani: vaniMario }],
      allegati: [], cf: "RSSMRA75D15D086X", ivaPerc: 10,
      creato: "10 feb", aggiornato: "15 feb",
      log: [
        { chi: "Fabio", cosa: "fattura acconto emessa", quando: "12 giorni fa", color: "#5856d6" },
        { chi: "Fabio", cosa: "cliente ha firmato", quando: "12 giorni fa", color: "#34c759" },
        { chi: "Fabio", cosa: "creato la commessa", quando: "17 giorni fa", color: "#86868b" },
      ],
    };

    const vaniLaura = [
      mkVano(9121, "Finestra Cucina", "F2A", "Cucina", "PT", 1200, 1400, "Aluplast Ideal 4000", "Noce"),
      mkVano(9122, "Portafinestra Soggiorno", "PF2A", "Soggiorno", "PT", 1400, 2200, "Aluplast Ideal 4000", "Noce"),
      mkVano(9123, "Finestra Camera", "F1A", "Camera", "PT", 800, 1200, "Aluplast Ideal 4000", "Noce"),
    ];
    const cm4 = {
      id: 9004, code: "S-0004", cliente: "Laura", cognome: "Esposito",
      indirizzo: "Viale Trieste 5, Rende (CS)", telefono: "340 999 8765", email: "laura.esposito@outlook.it",
      fase: "posa", sistema: "Aluplast Ideal 4000", tipo: "nuova", prezzoMq: 180,
      note: "PT villa. Colore noce.",
      firmaCliente: true, dataFirma: "2026-01-20", confermato: true,
      rilievi: [{ id: 9203, n: 1, data: "2026-01-15", ora: "14:00", rilevatore: "Fabio", tipo: "rilievo", stato: "completato", motivoModifica: "", note: "", vani: vaniLaura }],
      allegati: [], cf: "SPSLRA82E45D086W", ivaPerc: 10,
      creato: "15 gen", aggiornato: "10 feb",
      log: [
        { chi: "Fabio", cosa: "montaggio pianificato", quando: "3 giorni fa", color: "#34c759" },
        { chi: "Fabio", cosa: "conferma fornitore approvata", quando: "17 giorni fa", color: "#af52de" },
        { chi: "Fabio", cosa: "ordine inviato", quando: "25 giorni fa", color: "#ff2d55" },
        { chi: "Fabio", cosa: "creato la commessa", quando: "43 giorni fa", color: "#86868b" },
      ],
    };

    setCantieri([cm1, cm2, cm3, cm4]);

    // FATTURE
    setFattureDB([
      {
        id: "fat_d1", numero: 1, anno: 2026, data: "15/02/2026", dataISO: "2026-02-15", tipo: "acconto",
        cmId: 9003, cmCode: "S-0003", cliente: "Mario", cognome: "Rossi",
        indirizzo: "Via Roma 42, Cosenza", cf: "RSSMRA75D15D086X",
        importo: 593, imponibile: 539, iva: 10, ivaAmt: 54,
        pagata: true, dataPagamento: "2026-02-18", scadenza: "2026-03-17", note: "Acconto 50%",
      },
      {
        id: "fat_d2", numero: 2, anno: 2026, data: "20/01/2026", dataISO: "2026-01-20", tipo: "acconto",
        cmId: 9004, cmCode: "S-0004", cliente: "Laura", cognome: "Esposito",
        indirizzo: "Viale Trieste 5, Rende", cf: "SPSLRA82E45D086W",
        importo: 474, imponibile: 431, iva: 10, ivaAmt: 43,
        pagata: true, dataPagamento: "2026-01-25", scadenza: "2026-02-19", note: "Acconto 50%",
      },
    ]);

    // ORDINI
    setOrdiniFornDB([
      {
        id: "ord_d1", cmId: 9003, cmCode: "S-0003", cliente: "Mario Rossi",
        numero: 1, anno: 2026, dataOrdine: "2026-02-18",
        fornitore: { nome: "Aluplast Italia", email: "ordini@aluplast.it", tel: "0444 123456", referente: "Marco Ferro" },
        righe: vaniMario.map((v, i) => ({
          id: "r" + i, desc: `${v.nome}`, misure: `${v.misure.lCentro}√ó${v.misure.hCentro}`,
          qta: 1, prezzoUnit: 0, totale: 0, note: v.coloreEst,
        })),
        totale: 795, iva: 22, totaleIva: 970, sconto: 0,
        stato: "inviato",
        conferma: { ricevuta: false, dataRicezione: "", verificata: false, differenze: "", firmata: false, dataFirma: "" },
        consegna: { prevista: "", settimane: 0 }, pagamento: { termini: "", stato: "da_pagare" },
      },
      {
        id: "ord_d2", cmId: 9004, cmCode: "S-0004", cliente: "Laura Esposito",
        numero: 2, anno: 2026, dataOrdine: "2026-01-25",
        fornitore: { nome: "Aluplast Italia", email: "ordini@aluplast.it", tel: "0444 123456", referente: "Marco Ferro" },
        righe: vaniLaura.map((v, i) => ({
          id: "r" + i, desc: `${v.nome}`, misure: `${v.misure.lCentro}√ó${v.misure.hCentro}`,
          qta: 1, prezzoUnit: [210, 320, 140][i] || 0, totale: [210, 320, 140][i] || 0, note: v.coloreEst,
        })),
        totale: 670, iva: 22, totaleIva: 817, sconto: 0,
        stato: "confermato",
        conferma: { ricevuta: true, dataRicezione: "2026-02-01", verificata: true, firmata: true, dataFirma: "2026-02-01", nomeFile: "conferma_aluplast.pdf",
          datiEstratti: { totale: 817, settimane: 6, dataConsegna: "2026-03-15", pagamento: "30gg_fm" } },
        consegna: { prevista: "2026-03-15", settimane: 6 }, pagamento: { termini: "30gg_fm", stato: "da_pagare" },
      },
    ]);

    // MONTAGGI
    setMontaggiDB([{
      id: "m_d1", cmId: 9004, cmCode: "S-0004", cliente: "Laura Esposito",
      vani: 3, data: fra7, orario: "08:00", durata: "giornata",
      squadraId: "sq1", stato: "programmato", note: "3 vani PT villa ‚Äî portare scala e silicone",
    }]);

    // EVENTI calendario
    setEvents([
      { id: "ev1", date: oggi, time: "09:00", text: "Sopralluogo Verdi", persona: "Giuseppe Verdi", addr: "Via Garibaldi 12, Rende", cm: "S-0001", color: "#007aff", durata: 60 },
      { id: "ev2", date: oggi, time: "15:00", text: "Telefonata Bianchi ‚Äî preventivo", persona: "Anna Bianchi", addr: "", cm: "S-0002", color: "#ff9500", durata: 30 },
      { id: "ev3", date: domani, time: "10:00", text: "Incontro Rossi ‚Äî firma ordine", persona: "Mario Rossi", addr: "Via Roma 42, Cosenza", cm: "S-0003", color: "#34c759", durata: 45 },
      { id: "ev4", date: fra3, time: "08:30", text: "Consegna materiale Esposito", persona: "Laura Esposito", addr: "Viale Trieste 5, Rende", cm: "S-0004", color: "#af52de", durata: 120 },
      { id: "ev5", date: fra7, time: "08:00", text: "üîß MONTAGGIO Esposito ‚Äî 3 vani", persona: "Squadra A", addr: "Viale Trieste 5, Rende", cm: "S-0004", color: "#ff6b00", durata: 480 },
      { id: "ev6", date: fra14, time: "09:00", text: "Sopralluogo nuovo cliente", persona: "Sig.ra Ferraro", addr: "Via De Seta 15, Cosenza", color: "#007aff", durata: 60 },
    ]);

    // TASKS
    setTasks([
      { id: "t1", text: "Inviare preventivo Bianchi", done: false, priority: "alta", meta: "S-0002 ¬∑ Scade venerd√¨" },
      { id: "t2", text: "Preparare sopralluogo Verdi", done: false, priority: "media", meta: "S-0001 ¬∑ Oggi ore 9" },
      { id: "t3", text: "Chiamare Aluplast per conferma Rossi", done: false, priority: "alta", meta: "S-0003 ¬∑ Ordine 18/02" },
      { id: "t4", text: "Verificare consegna Esposito", done: true, priority: "media", meta: "S-0004 ¬∑ 15 marzo" },
    ]);

    setSelectedCM(null);
    setSelectedRilievo(null);
    setSelectedVano(null);
    setTab("home");
  };

  const renderHome = () => {
    const todayISO = today.toISOString().split("T")[0];
    const h = today.getHours();
    const saluto = h < 12 ? "Buongiorno" : h < 18 ? "Buon pomeriggio" : "Buonasera";
    const SOGLIA_GIORNI = sogliaDays;
    const ferme = cantieri.filter(c => c.fase !== "chiusura" && giorniFermaCM(c) >= SOGLIA_GIORNI);
    const misureInAttesa = cantieri.filter(c => c.fase === "misure" && getVaniAttivi(c).some(v => Object.keys(v.misure || {}).length < 4));
    const preventiviDaFare = cantieri.filter(c => c.fase === "preventivo");
    const todayEvents = events.filter(e => e.date === todayISO).sort((a, b) => (a.time || "99").localeCompare(b.time || "99"));
    const taskUrgenti = tasks.filter(t => !t.done && t.priority === "alta");

    // Build IO actions
    const ioActions: Array<{ id: string; titolo: string; sotto: string; urgenza: string; color: string; icon: string }> = [];
    ferme.slice(0, 2).forEach(c => ioActions.push({ id: "f-" + c.id, titolo: `Sbloccare ${c.cliente}`, sotto: `${c.code} ¬∑ ferma ${giorniFermaCM(c)}gg ¬∑ fase ${PIPELINE.find(p => p.id === c.fase)?.nome || c.fase}`, urgenza: "alta", color: T.red, icon: "‚ö†Ô∏è" }));
    preventiviDaFare.slice(0, 1).forEach(c => ioActions.push({ id: "p-" + c.id, titolo: `Inviare preventivo ${c.cliente}`, sotto: `${c.code} ¬∑ ${c.indirizzo || "‚Äî"}`, urgenza: "alta", color: "#af52de", icon: "üìã" }));
    misureInAttesa.slice(0, 1).forEach(c => { const tot = getVaniAttivi(c).length; const ok = getVaniAttivi(c).filter(v => Object.keys(v.misure || {}).length >= 4).length; ioActions.push({ id: "m-" + c.id, titolo: `Completare misure ${c.cliente}`, sotto: `${c.code} ¬∑ ${ok}/${tot} vani misurati`, urgenza: "media", color: "#ff9500", icon: "üìê" }); });
    todayEvents.slice(0, 1).forEach(e => ioActions.push({ id: "e-" + e.id, titolo: e.text, sotto: `${e.time || "‚Äî"} ¬∑ ${e.persona || "‚Äî"} ¬∑ ${e.addr || "‚Äî"}`, urgenza: "media", color: e.color || "#007aff", icon: "üìç" }));
    taskUrgenti.slice(0, 1).forEach(t => ioActions.push({ id: "t-" + t.id, titolo: t.text, sotto: t.meta || "Task urgente", urgenza: "alta", color: T.red, icon: "‚òëÔ∏è" }));
    const ioRemaining = ioActions.filter(a => !ioChecked[a.id]);
    const ioDone = ioActions.filter(a => ioChecked[a.id]);

    // Day navigation for programma
    const getDateForOffset = (off: number) => { const d = new Date(today); d.setDate(d.getDate() + off); return d; };
    const dayDate = getDateForOffset(dayOffset);
    const dayISO = dayDate.toISOString().split("T")[0];
    const dayEvents = events.filter(e => e.date === dayISO).sort((a, b) => (a.time || "99").localeCompare(b.time || "99"));
    const dayLabel = dayOffset === 0 ? "Oggi" : dayOffset === -1 ? "Ieri" : dayOffset === 1 ? "Domani" : dayDate.toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "short" });
    const isPast = dayOffset < 0;

    // Week strip
    const weekDays: Date[] = [];
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    for (let i = 0; i < 7; i++) { const d = new Date(monday); d.setDate(monday.getDate() + i); weekDays.push(d); }
    const dayNames = ["lun", "mar", "mer", "gio", "ven", "sab", "dom"];

    // Commesse filtered
    const fasi = ["tutte", ...PIPELINE.filter(p => p.attiva).map(p => p.id)];
    const faseSel = fasi[cmFaseIdx];
    const cmFiltrate = faseSel === "tutte" ? cantieri : cantieri.filter(c => c.fase === faseSel);

    const sections: Record<string, any> = {
      // ‚ïê‚ïê‚ïê CONTATORI ‚ïê‚ïê‚ïê
      contatori: (
        <div key="contatori">
          <SectionHead id="contatori" icon="" title="Stato lavori" />
          {!collapsed["contatori"] && (
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, padding: "0 16px", marginBottom: 8 }}>
              {[
                { id: "misure", icon: "üìê", label: "In misure", count: cantieri.filter(c => c.fase === "misure").length, color: "#ff9500", sub: `${misureInAttesa.length} da completare` },
                { id: "prev", icon: "üìã", label: "Preventivi", count: preventiviDaFare.length, color: "#af52de", sub: preventiviDaFare.length > 0 ? `${preventiviDaFare[0]?.cliente}` : "Nessuno" },
                { id: "ferme", icon: "‚ö†Ô∏è", label: "Ferme", count: ferme.length, color: T.red, sub: ferme.length > 0 ? `da ${ferme[0] ? giorniFermaCM(ferme[0]) : 0}gg` : "Tutto ok" },
                { id: "oggi", icon: "üìÖ", label: "Oggi", count: todayEvents.length, color: "#007aff", sub: todayEvents[0] ? `Prossimo: ${todayEvents[0].time || "‚Äî"}` : "Nessun evento" },
              ].map(c => (
                <div key={c.id} onClick={() => {
                  if (c.id === "misure") { setFilterFase("misure"); setTab("commesse"); }
                  else if (c.id === "prev") { setFilterFase("preventivo"); setTab("commesse"); }
                  else if (c.id === "ferme") { setFilterFase("tutte"); setTab("commesse"); }
                  else if (c.id === "oggi") { setTab("agenda"); }
                }} style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, padding: "10px 12px", cursor: "pointer", position: "relative", overflow: "hidden" }}>
                  <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: `linear-gradient(135deg, ${c.color}, ${c.color}80)` }} />
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                    <div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: c.color, fontFamily: FM, lineHeight: 1 }}>{c.count}</div>
                      <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, textTransform: "uppercase" as const, letterSpacing: 0.5, marginTop: 2 }}>{c.label}</div>
                      <div style={{ fontSize: 9, color: T.sub, marginTop: 1 }}>{c.sub}</div>
                    </div>
                    <div style={{ width: 32, height: 32, borderRadius: 8, background: c.color + "12", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 }}>{c.icon}</div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      ),

      // ‚ïê‚ïê‚ïê IO ‚Äî briefing personale ‚ïê‚ïê‚ïê
      io: (() => {
        if (ioActions.length === 0) return null;
        return (
          <div key="io">
            <SectionHead id="io" icon="üë§" title="IO ¬∑ Da fare oggi" count={ioRemaining.length} countColor={ioRemaining.some(a => a.urgenza === "alta") ? T.red : "#ff9500"} />
            {!collapsed["io"] && (
              <div style={{ padding: "0 16px", marginBottom: 8 }}>
                <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, overflow: "hidden" }}>
                  <div style={{ padding: "8px 12px", background: T.acc + "08", borderBottom: `1px solid ${T.bdr}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <span style={{ fontSize: 10, fontWeight: 700, color: T.acc }}>Completamento giornata</span>
                    <span style={{ fontSize: 10, fontWeight: 800, color: T.acc, fontFamily: FM }}>{ioDone.length}/{ioActions.length}</span>
                  </div>
                  <div style={{ height: 3, background: T.bg }}><div style={{ height: "100%", background: T.acc, width: `${ioActions.length > 0 ? (ioDone.length / ioActions.length) * 100 : 0}%`, transition: "width 0.3s", borderRadius: 2 }} /></div>
                  {ioRemaining.map(a => (
                    <div key={a.id} style={{ padding: "10px 12px", borderBottom: `1px solid ${T.bg}`, display: "flex", alignItems: "center", gap: 10 }}>
                      <div onClick={() => setIoChecked(prev => ({ ...prev, [a.id]: true }))}
                        style={{ width: 20, height: 20, borderRadius: "50%", border: `2px solid ${a.color}`, flexShrink: 0, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }} />
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 4, marginBottom: 1 }}>
                          <span style={{ fontSize: 12 }}>{a.icon}</span>
                          {a.urgenza === "alta" && <span style={{ ...S.badge(T.red + "15", T.red), fontSize: 8, fontWeight: 800, padding: "1px 5px" }}>URGENTE</span>}
                        </div>
                        <div style={{ fontSize: 12, fontWeight: 600, color: T.text }}>{a.titolo}</div>
                        <div style={{ fontSize: 10, color: T.sub }}>{a.sotto}</div>
                      </div>
                    </div>
                  ))}
                  {ioDone.length > 0 && (
                    <div style={{ padding: "6px 12px", background: T.grn + "08" }}>
                      <div style={{ fontSize: 9, fontWeight: 700, color: T.grn, marginBottom: 4 }}>‚úì COMPLETATE ({ioDone.length})</div>
                      {ioDone.map(a => (
                        <div key={a.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "4px 0", opacity: 0.5 }}>
                          <span style={{ fontSize: 10, color: T.grn }}>‚úì</span>
                          <span style={{ fontSize: 10, color: T.sub, textDecoration: "line-through" }}>{a.titolo}</span>
                          <span onClick={() => setIoChecked(prev => { const n = { ...prev }; delete n[a.id]; return n; })} style={{ fontSize: 8, color: T.sub, cursor: "pointer", marginLeft: "auto" }}>‚Ü©</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      })(),

      // ‚ïê‚ïê‚ïê ATTENZIONE ‚ïê‚ïê‚ïê
      attenzione: (ferme.length > 0 || problemi.filter(p => p.stato !== "risolto").length > 0) ? (
        <div key="attenzione">
          <div style={{ margin: "0 16px 8px" }}>
            <div onClick={() => toggleCollapse("attenzione")} style={{
              display: "flex", alignItems: "center", justifyContent: "space-between",
              padding: "10px 14px", borderRadius: !collapsed["attenzione"] ? `${T.r}px ${T.r}px 0 0` : T.r,
              background: T.red + "10", border: `1px solid ${T.red}18`, cursor: "pointer"
            }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ fontSize: 9, fontWeight: 800, color: T.red, textTransform: "uppercase" as const, letterSpacing: "0.1em", fontFamily: FM }}>‚ö†Ô∏è ATTENZIONE</span>
                <span style={{ ...S.badge(T.red, "#fff") }}>{ferme.length + problemi.filter(p => p.stato !== "risolto").length}</span>
              </div>
              <span style={{ fontSize: 9, color: T.sub, display: "inline-block", transform: collapsed["attenzione"] ? "rotate(-90deg)" : "none", transition: "transform 0.15s" }}>‚ñº</span>
            </div>
            {!collapsed["attenzione"] && (<>
            {/* Problemi aperti */}
            {problemi.filter(p => p.stato !== "risolto").map((p, i) => (
              <div key={p.id} onClick={() => { const cm = cantieri.find(c => c.id === p.commessaId); if (cm) { setSelectedCM(cm); setTab("commesse"); setTimeout(() => setShowProblemiView(true), 200); } }}
                style={{
                  padding: "10px 14px", background: T.card,
                  borderLeft: `3px solid #FF3B30`, borderRight: `1px solid ${T.red}18`,
                  borderBottom: `1px solid ${T.red}18`,
                  borderRadius: i === 0 && ferme.length === 0 ? 0 : 0,
                  cursor: "pointer", display: "flex", alignItems: "center", gap: 10
                }}>
                <div style={{ flex: 1 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                    <span style={{ ...S.badge("#FF3B3015", "#FF3B30"), fontSize: 9, fontWeight: 800, fontFamily: FM }}>üö® {p.stato === "in_corso" ? "IN CORSO" : "APERTO"}</span>
                    <span style={{ fontSize: 10, color: T.sub, fontFamily: FM }}>{p.commessaCode}</span>
                  </div>
                  <div style={{ fontSize: 13, fontWeight: 700 }}>{p.titolo}</div>
                  <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{p.cliente}{p.assegnatoA ? ` ¬∑ üë§ ${p.assegnatoA}` : ""}</div>
                </div>
                <span style={{ color: T.sub, fontSize: 16 }}>‚Ä∫</span>
              </div>
            ))}
            {/* Commesse ferme */}
            {ferme.map((c, i) => (
              <div key={c.id} onClick={() => { setSelectedCM(c); setTab("commesse"); }}
                style={{
                  padding: "10px 14px", background: T.card,
                  borderLeft: `3px solid ${T.red}`, borderRight: `1px solid ${T.red}18`,
                  borderBottom: `1px solid ${T.red}18`,
                  borderRadius: i === ferme.length - 1 ? `0 0 ${T.r}px ${T.r}px` : 0,
                  cursor: "pointer", display: "flex", alignItems: "center", gap: 10
                }}>
                <div style={{ flex: 1 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                    <span style={{ ...S.badge(T.red + "15", T.red), fontSize: 9, fontWeight: 800, fontFamily: FM }}>FERMA {giorniFermaCM(c)}gg</span>
                    <span style={{ fontSize: 10, color: T.sub, fontFamily: FM }}>{c.code}</span>
                  </div>
                  <div style={{ fontSize: 13, fontWeight: 700 }}>{c.cliente}</div>
                  <div style={{ fontSize: 11, color: T.acc, fontWeight: 600, marginTop: 2 }}>‚Üí {PIPELINE.find(p => p.id === c.fase)?.nome || c.fase}</div>
                </div>
                <span style={{ color: T.sub, fontSize: 16 }}>‚Ä∫</span>
              </div>
            ))}
            </>)}
          </div>
        </div>
      ) : null,

      // ‚ïê‚ïê‚ïê PROGRAMMA OGGI ‚Äî swipeable ‚ïê‚ïê‚ïê
      programma: (() => {
        return (
          <div key="programma">
            <SectionHead id="programma" icon="üìã" title="Programma" count={todayEvents.length} countColor="#007aff" />
            {!collapsed["programma"] && (
              <div style={{ padding: "0 16px", marginBottom: 8 }}>
                <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, overflow: "hidden" }}>
                  {/* Day navigation */}
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 12px", borderBottom: `1px solid ${T.bdr}`, background: T.bg }}>
                    <div onClick={() => setDayOffset(d => d - 1)} style={{ padding: "4px 10px", cursor: "pointer", fontSize: 14, color: T.sub }}>‚Äπ</div>
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 12, fontWeight: 700, color: dayOffset === 0 ? T.acc : T.text }}>{dayLabel}</div>
                      <div style={{ fontSize: 9, color: T.sub }}>{dayDate.toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })}</div>
                    </div>
                    <div onClick={() => setDayOffset(d => d + 1)} style={{ padding: "4px 10px", cursor: "pointer", fontSize: 14, color: T.sub }}>‚Ä∫</div>
                  </div>
                  {dayOffset !== 0 && (
                    <div onClick={() => setDayOffset(0)} style={{ textAlign: "center", padding: "4px", fontSize: 10, color: T.acc, fontWeight: 600, cursor: "pointer", background: T.acc + "06" }}>
                      ‚Üê Torna a oggi
                    </div>
                  )}
                  {dayEvents.length === 0 ? (
                    <div style={{ padding: "24px 16px", textAlign: "center" }}>
                      <div style={{ fontSize: 24, marginBottom: 6 }}>{isPast ? "‚úì" : "‚òÄÔ∏è"}</div>
                      <div style={{ fontSize: 12, color: T.sub }}>
                        {isPast ? "Nessuna attivit√† registrata" : "Nessuna attivit√† programmata"}
                      </div>
                    </div>
                  ) : (
                    <div style={{ position: "relative", padding: "8px 0" }}>
                      <div style={{ position: "absolute", left: 33, top: 16, bottom: 16, width: 2, background: T.bdr, zIndex: 0 }} />
                      {dayEvents.map(ev => (
                        <div key={ev.id} onClick={() => setSelectedEvent(ev)}
                          style={{ display: "flex", gap: 12, position: "relative", zIndex: 1, cursor: "pointer", padding: "0 12px" }}>
                          <div style={{ display: "flex", flexDirection: "column" as const, alignItems: "center", width: 44, flexShrink: 0, paddingTop: 10 }}>
                            <div style={{ width: 10, height: 10, borderRadius: "50%", background: ev.color || "#007aff", border: `2px solid ${T.card}`, boxShadow: `0 0 0 2px ${(ev.color || "#007aff")}40`, zIndex: 2 }} />
                            {ev.time && <div style={{ fontSize: 9, fontWeight: 700, color: ev.color || "#007aff", fontFamily: FM, marginTop: 3 }}>{ev.time}</div>}
                          </div>
                          <div style={{
                            flex: 1, padding: "8px 12px", borderRadius: T.r, background: T.card,
                            border: `1px solid ${T.bdr}`, borderLeft: `3px solid ${ev.color || "#007aff"}`,
                            marginBottom: 6, boxShadow: T.cardSh, opacity: isPast ? 0.6 : 1
                          }}>
                            {isPast && <span style={{ ...S.badge(T.grn + "15", T.grn), fontSize: 8, fontWeight: 800, marginBottom: 4, display: "inline-block" }}>‚úì FATTO</span>}
                            <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{ev.text}</div>
                            <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>
                              {ev.persona && `${ev.persona} ¬∑ `}{ev.addr || ""}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      })(),

      // ‚ïê‚ïê‚ïê SETTIMANA ‚ïê‚ïê‚ïê
      settimana: (
        <div key="settimana">
          <SectionHead id="settimana" icon="üìÖ" title="Questa settimana" extra={<button onClick={() => setTab("agenda")} style={S.sectionBtn}>Apri agenda</button>} />
          {!collapsed["settimana"] && (
            <div style={{ padding: "0 16px", marginBottom: 8 }}>
              <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, padding: "10px 6px", display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 4 }}>
                {weekDays.map((d, i) => {
                  const dISO = d.toISOString().split("T")[0];
                  const isToday = dISO === todayISO;
                  const evs = events.filter(e => e.date === dISO);
                  return (
                    <div key={i} onClick={() => { setDayOffset(Math.round((d.getTime() - today.getTime()) / 86400000)); }} style={{ textAlign: "center" as const, cursor: "pointer", padding: "4px 0" }}>
                      <div style={{ fontSize: 9, fontWeight: 600, color: i >= 5 ? "#ff9500" : T.sub, textTransform: "uppercase" as const }}>{dayNames[i]}</div>
                      <div style={{
                        width: 28, height: 28, borderRadius: "50%", margin: "4px auto",
                        display: "flex", alignItems: "center", justifyContent: "center",
                        fontSize: 13, fontWeight: isToday ? 800 : 500,
                        background: isToday ? T.acc : "transparent", color: isToday ? "#fff" : T.text,
                      }}>{d.getDate()}</div>
                      <div style={{ display: "flex", justifyContent: "center", gap: 2, minHeight: 6, marginTop: 2 }}>
                        {evs.slice(0, 3).map((ev, j) => (
                          <div key={j} style={{ width: 5, height: 5, borderRadius: "50%", background: ev.color || "#007aff" }} />
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      ),

      // ‚ïê‚ïê‚ïê COMMESSE ‚ïê‚ïê‚ïê
      commesse: (
        <div key="commesse">
          <SectionHead id="commesse" icon="üìÅ" title={`Commesse ${cmFiltrate.length}`} extra={<button onClick={() => setTab("commesse")} style={S.sectionBtn}>Vedi tutte</button>} />
          {!collapsed["commesse"] && (
            <div>
              <div style={{ display: "flex", gap: 5, padding: "0 16px 8px", overflowX: "auto" as const }}>
                {fasi.map((f, i) => {
                  const p = PIPELINE.find(x => x.id === f);
                  const n = f === "tutte" ? cantieri.length : cantieri.filter(c => c.fase === f).length;
                  if (n === 0 && f !== "tutte") return null;
                  return (
                    <div key={f} onClick={() => setCmFaseIdx(i)} style={{
                      padding: "5px 10px", borderRadius: 20, fontSize: 11, fontWeight: 700,
                      cursor: "pointer", flexShrink: 0, whiteSpace: "nowrap" as const,
                      background: cmFaseIdx === i ? (p?.color || T.acc) : T.card,
                      color: cmFaseIdx === i ? "#fff" : T.sub,
                      border: `1px solid ${cmFaseIdx === i ? (p?.color || T.acc) : T.bdr}`,
                    }}>
                      {p?.ico || "üìÅ"} {p?.nome || "Tutte"} {n > 0 && <span style={{ fontWeight: 800 }}>{n}</span>}
                    </div>
                  );
                })}
              </div>
              <div style={{ padding: "0 16px" }}>
                {cmFiltrate.slice(0, 5).map(c => {
                  const p = PIPELINE.find(x => x.id === c.fase);
                  const isFerma = giorniFermaCM(c) >= SOGLIA_GIORNI;
                  const vaniTot = getVaniAttivi(c).length;
                  const vaniOk = getVaniAttivi(c).filter(v => Object.keys(v.misure || {}).length >= 4).length;
                  const faseIdx = PIPELINE.findIndex(x => x.id === c.fase);
                  const progFase = faseIdx >= 0 ? Math.round((faseIdx + 1) / PIPELINE.length * 100) : 0;
                  return (
                    <div key={c.id} onClick={() => { setSelectedCM(c); setTab("commesse"); }}
                      style={{
                        background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh,
                        padding: "11px 13px", cursor: "pointer", marginBottom: 8, overflow: "hidden",
                        borderLeft: `3px solid ${isFerma ? T.red : p?.color || T.acc}`,
                      }}>
                      <div style={{ display: "flex", alignItems: "flex-start", gap: 8 }}>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" as const }}>
                            <span style={{ fontSize: 11, color: T.sub, fontFamily: FM }}>{c.code}</span>
                            <span style={{ fontSize: 14, fontWeight: 700, color: T.text }}>{c.cliente}</span>
                            {isFerma && <span style={{ ...S.badge(T.red + "15", T.red), fontSize: 9, fontWeight: 800 }}>FERMA {giorniFermaCM(c)}gg</span>}
                          </div>
                          <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{c.indirizzo || "‚Äî"}</div>
                          <div style={{ display: "flex", gap: 5, marginTop: 5, flexWrap: "wrap" as const, alignItems: "center" }}>
                            <span style={{ ...S.badge((p?.color || T.acc) + "18", p?.color || T.acc), fontSize: 10 }}>{p?.ico} {p?.nome}</span>
                            {vaniTot > 0 && <span style={{ fontSize: 10, color: T.sub }}>{vaniOk}/{vaniTot} vani</span>}
                          </div>
                          {/* Prossima azione */}
                          <div style={{ marginTop: 8, padding: "6px 10px", borderRadius: 8, background: T.acc + "08", border: `1px solid ${T.acc}15`, display: "flex", alignItems: "center", gap: 6 }}>
                            <span style={{ fontSize: 11, color: T.acc, fontWeight: 800 }}>‚Üí</span>
                            <span style={{ fontSize: 11, color: T.acc, fontWeight: 600, lineHeight: "1.3" }}>
                              {c.fase === "misure" ? `Completare misure (${vaniOk}/${vaniTot})` :
                               c.fase === "preventivo" ? "Preparare e inviare preventivo" :
                               c.fase === "sopralluogo" ? "Eseguire sopralluogo" :
                               c.fase === "ordini" ? "Verificare ordini materiali" :
                               c.fase === "produzione" ? "Seguire produzione" :
                               c.fase === "posa" ? "Programmare posa in opera" :
                               `Fase: ${p?.nome || c.fase}`}
                            </span>
                          </div>
                        </div>
                        <span style={{ color: T.sub, fontSize: 16, flexShrink: 0 }}>‚Ä∫</span>
                      </div>
                      {/* Progress bar */}
                      <div style={{ marginTop: 8 }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 3 }}>
                          <span style={{ fontSize: 10, color: T.sub }}>Pipeline</span>
                          <span style={{ fontSize: 10, fontWeight: 700, color: isFerma ? T.red : p?.color || T.acc }}>{progFase}%</span>
                        </div>
                        <div style={{ height: 4, borderRadius: 2, background: T.bg, overflow: "hidden" }}>
                          <div style={{ height: "100%", borderRadius: 2, background: isFerma ? T.red : p?.color || T.acc, width: `${progFase}%`, transition: "width 0.3s" }} />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      ),

      // ‚ïê‚ïê‚ïê WORKFLOW COMMESSE ‚ïê‚ïê‚ïê
      azioni: (() => {
        const totale = cantieri.length;
        const faseData = PIPELINE.filter(p => p.attiva).map(p => ({
          ...p, count: cantieri.filter(c => c.fase === p.id).length
        }));
        const maxCount = Math.max(...faseData.map(f => f.count), 1);
        return (
          <div key="azioni">
            <SectionHead id="azioni" icon="üîÑ" title="Workflow commesse" count={totale} countColor={T.acc} extra={<button onClick={() => setTab("commesse")} style={S.sectionBtn}>Vedi tutte</button>} />
            {!collapsed["azioni"] && (
              <div style={{ padding: "0 16px", marginBottom: 16 }}>
                <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, boxShadow: T.cardSh, overflow: "hidden" }}>
                  {/* Pipeline flow */}
                  <div style={{ display: "flex", alignItems: "center", padding: "10px 12px 6px", gap: 2, overflowX: "auto" as const, WebkitOverflowScrolling: "touch" as any, scrollbarWidth: "none" as any }}>
                    {faseData.map((f, i) => (
                      <div key={f.id} style={{ display: "flex", alignItems: "center", flexShrink: 0, minWidth: 56 }}>
                        <div onClick={() => { setFilterFase(f.id); setTab("commesse"); }}
                          style={{ width: 56, textAlign: "center" as const, cursor: "pointer", padding: "4px 2px", borderRadius: 6, background: f.count > 0 ? f.color + "10" : "transparent", transition: "background 0.15s" }}>
                          <div style={{ fontSize: 16 }}>{f.ico}</div>
                          <div style={{ fontSize: 16, fontWeight: 800, color: f.count > 0 ? f.color : T.sub + "60", fontFamily: FM, lineHeight: 1 }}>{f.count}</div>
                          <div style={{ fontSize: 7, fontWeight: 700, color: f.count > 0 ? f.color : T.sub, textTransform: "uppercase" as const, letterSpacing: 0.3, marginTop: 1, whiteSpace: "nowrap" as const, overflow: "hidden", textOverflow: "ellipsis" }}>{f.nome}</div>
                        </div>
                        {i < faseData.length - 1 && <span style={{ fontSize: 8, color: T.bdr, flexShrink: 0, margin: "0 1px" }}>‚Ä∫</span>}
                      </div>
                    ))}
                  </div>
                  {/* Bar chart */}
                  <div style={{ display: "flex", gap: 3, padding: "4px 12px 10px", alignItems: "flex-end", height: 32, overflowX: "auto" as const, scrollbarWidth: "none" as any }}>
                    {faseData.map(f => (
                      <div key={f.id} style={{ flexShrink: 0, minWidth: 56, display: "flex", flexDirection: "column" as const, alignItems: "center", gap: 0 }}>
                        <div style={{
                          width: "100%", borderRadius: "3px 3px 0 0",
                          height: f.count > 0 ? Math.max(4, (f.count / maxCount) * 28) : 2,
                          background: f.count > 0 ? f.color : T.bdr,
                          opacity: f.count > 0 ? 0.7 : 0.3,
                          transition: "height 0.3s"
                        }} />
                      </div>
                    ))}
                  </div>
                  {/* Ferme alert inline */}
                  {ferme.length > 0 && (
                    <div style={{ padding: "6px 12px", background: T.red + "06", borderTop: `1px solid ${T.red}12`, display: "flex", alignItems: "center", gap: 6 }}>
                      <span style={{ fontSize: 10 }}>‚ö†Ô∏è</span>
                      <span style={{ fontSize: 10, fontWeight: 700, color: T.red }}>{ferme.length} ferme da &gt;{SOGLIA_GIORNI}gg</span>
                      <span style={{ fontSize: 9, color: T.sub, marginLeft: "auto" }}>{ferme.map(c => c.code).join(", ")}</span>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      })(),

      // ‚ïê‚ïê‚ïê DASHBOARD ECONOMICA ‚ïê‚ïê‚ïê
      dashboard: (() => {
        const cmConf = cantieri.filter(c => c.confermato);
        const cmChiuse = cantieri.filter(c => c.fase === "chiusura");
        const fattMese = cantieri.filter(c => {
          if (!c.euro) return false;
          const d = c.dataConferma || "";
          const now = new Date();
          return d.includes("/" + (now.getMonth() + 1).toString().padStart(2,"0") + "/" + now.getFullYear()) || c.fase === "chiusura";
        }).reduce((s, c) => s + (parseFloat(c.euro) || 0), 0);
        const totPrev = cantieri.filter(c => c.euro && c.fase !== "chiusura").reduce((s, c) => s + (parseFloat(c.euro) || 0), 0);
        const totConf = cmConf.reduce((s, c) => s + (parseFloat(c.euro) || 0), 0);
        const totChiuse = cmChiuse.reduce((s, c) => s + (parseFloat(c.euro) || 0), 0);
        const convRate = cantieri.length > 0 ? Math.round(cmConf.length / cantieri.length * 100) : 0;
        return (
          <div key="dashboard">
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <SectionHead id="dashboard" icon="üìä" title="Dashboard" />
                <div onClick={() => setShowContabilita(true)} style={{ padding: "4px 10px", borderRadius: 6, background: T.accLt, color: T.acc, fontSize: 10, fontWeight: 700, cursor: "pointer", marginRight: 16 }}>üí∞ Contabilit√† ‚Üí</div>
              </div>
            {!collapsed["dashboard"] && (
              <div style={{ padding: "0 16px", marginBottom: 8 }}>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
                  <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: "10px 12px" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase", fontWeight: 700 }}>Preventivi aperti</div>
                    <div style={{ fontSize: 18, fontWeight: 900, color: T.text }}>‚Ç¨{totPrev.toLocaleString("it-IT")}</div>
                    <div style={{ fontSize: 9, color: T.sub }}>{cantieri.filter(c => c.euro && c.fase !== "chiusura").length} commesse</div>
                  </div>
                  <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: "10px 12px" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase", fontWeight: 700 }}>Confermati</div>
                    <div style={{ fontSize: 18, fontWeight: 900, color: "#34c759" }}>‚Ç¨{totConf.toLocaleString("it-IT")}</div>
                    <div style={{ fontSize: 9, color: T.sub }}>{cmConf.length} commesse ¬∑ {convRate}% conv.</div>
                  </div>
                  <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: "10px 12px" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase", fontWeight: 700 }}>Chiusi/Fatturati</div>
                    <div style={{ fontSize: 18, fontWeight: 900, color: "#007aff" }}>‚Ç¨{totChiuse.toLocaleString("it-IT")}</div>
                    <div style={{ fontSize: 9, color: T.sub }}>{cmChiuse.length} commesse</div>
                  </div>
                  <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: "10px 12px" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase", fontWeight: 700 }}>In produzione</div>
                    <div style={{ fontSize: 18, fontWeight: 900, color: "#5856d6" }}>{cantieri.filter(c => c.trackingStato && !["montato"].includes(c.trackingStato)).length}</div>
                    <div style={{ fontSize: 9, color: T.sub }}>{cantieri.filter(c => c.trackingStato === "pronto").length} pronti da consegnare</div>
                  </div>
                </div>
                {/* Scadenzario rapido */}
                {cantieri.filter(c => c.confermato && c.euro && c.fase !== "chiusura").length > 0 && (
                  <div style={{ marginTop: 8, background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: "10px 12px" }}>
                    <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 6 }}>üí∞ Da incassare</div>
                    {cantieri.filter(c => c.confermato && c.euro && c.fase !== "chiusura").slice(0, 5).map(c => (
                      <div key={c.id} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", borderBottom: `1px solid ${T.bdr}`, fontSize: 11 }}>
                        <span style={{ color: T.text }}>{c.cliente} <span style={{ color: T.sub, fontSize: 9 }}>{c.code}</span></span>
                        <span style={{ fontWeight: 700, color: "#34c759" }}>‚Ç¨{parseFloat(c.euro).toLocaleString("it-IT")}</span>
                      </div>
                    ))}
                  </div>
                )}
                {/* ‚ïê‚ïê‚ïê QUICK ACCESS CARDS ‚ïê‚ïê‚ïê */}
                {(() => {
                  const ordAtt = ordiniFornDB.filter(o => o.stato !== "consegnato");
                  const montAtt = montaggiDB.filter(m => m.stato !== "completato");
                  const fatAtt = fattureDB.filter(f => !f.pagata);
                  const totFat = fatAtt.reduce((s,f) => s + f.importo, 0);
                  const cards = [
                    ordAtt.length > 0 && { key: "ordini", ico: "üì¶", title: "Ordini Fornitore", count: ordAtt.length, sub: ordAtt.filter(o => o.conferma?.ricevuta).length + " confermati", col: "#ff9500" },
                    montAtt.length > 0 && { key: "montaggi", ico: "üîß", title: "Prossimi Montaggi", count: montAtt.length, sub: montAtt[0]?.data ? new Date(montAtt[0].data).toLocaleDateString("it-IT",{day:"numeric",month:"short"}) + " prossimo" : "", col: "#007aff" },
                    fatAtt.length > 0 && { key: "fatture", ico: "‚è≥", title: "Fatture da Incassare", count: fatAtt.length, sub: "‚Ç¨" + totFat.toLocaleString("it-IT"), col: "#ff3b30" },
                  ].filter(Boolean);
                  if (cards.length === 0) return null;
                  return (
                    <div style={{ display: "grid", gridTemplateColumns: cards.length >= 3 ? "1fr 1fr 1fr" : cards.length === 2 ? "1fr 1fr" : "1fr", gap: 6, marginTop: 8 }}>
                      {cards.map(cd => (
                        <div key={cd.key} onClick={() => setHomeView(cd.key)}
                          style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "12px 10px", cursor: "pointer", textAlign: "center", transition: "all .15s" }}>
                          <div style={{ fontSize: 22 }}>{cd.ico}</div>
                          <div style={{ fontSize: 20, fontWeight: 900, color: cd.col, marginTop: 2 }}>{cd.count}</div>
                          <div style={{ fontSize: 9, fontWeight: 700, color: T.text, marginTop: 1 }}>{cd.title}</div>
                          <div style={{ fontSize: 8, color: T.sub }}>{cd.sub}</div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        );
      })(),
    };

    // ‚ïê‚ïê‚ïê PAGINE DEDICATE ‚Äî Ordini / Montaggi / Fatture ‚ïê‚ïê‚ïê
    if (homeView) {
      const backBtn = <div onClick={() => setHomeView(null)} style={{ cursor:"pointer", padding:4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>;
      
      if (homeView === "ordini") {
        const allOrd = ordiniFornDB.sort((a,b) => (a.consegna?.prevista||"z").localeCompare(b.consegna?.prevista||"z"));
        return (
          <div style={{ paddingBottom: 80 }}>
            <div style={S.header}>
              {backBtn}
              <div style={{ flex:1 }}><div style={S.headerTitle}>üì¶ Ordini Fornitore</div><div style={S.headerSub}>{allOrd.length} totali ¬∑ {allOrd.filter(o=>o.stato!=="consegnato").length} attivi</div></div>
            </div>
            <div style={{ padding:"0 16px" }}>
              {allOrd.map(o => {
                const st = ORDINE_STATI.find(s => s.id === o.stato) || ORDINE_STATI[0];
                const isLate = o.consegna?.prevista && new Date(o.consegna.prevista) < new Date();
                const cm = cantieri.find(cc => cc.id === o.cmId);
                return (
                  <div key={o.id} onClick={() => { if(cm) { setSelectedCM(cm); setHomeView(null); setTab("commesse"); } }}
                    style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:"12px 14px", marginBottom:8, cursor:"pointer",
                      borderLeft:"4px solid "+st.color }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                      <div>
                        <div style={{ fontSize:13, fontWeight:700, color:T.text }}>{st.icon} {o.fornitore?.nome||"‚Äî"}</div>
                        <div style={{ fontSize:11, color:T.sub }}>{o.cmCode} ¬∑ {cm?.cliente||""} {cm?.cognome||""}</div>
                      </div>
                      <span style={{ padding:"3px 8px", borderRadius:6, fontSize:9, fontWeight:700, background:st.color+"18", color:st.color }}>{st.label}</span>
                    </div>
                    <div style={{ display:"flex", justifyContent:"space-between", marginTop:6, fontSize:11 }}>
                      <span style={{ color:T.sub }}>Totale: <b style={{ color:T.text }}>‚Ç¨{(o.totaleIva||o.totale||0).toLocaleString("it-IT")}</b></span>
                      {o.consegna?.prevista && <span style={{ color:isLate?"#ff3b30":T.sub, fontWeight:isLate?700:400 }}>{isLate?"‚ö†Ô∏è ":""}Consegna: {new Date(o.consegna.prevista).toLocaleDateString("it-IT",{day:"numeric",month:"short"})}</span>}
                    </div>
                    {o.conferma?.ricevuta && <div style={{ fontSize:10, color:"#34c759", marginTop:4 }}>‚úÖ Conferma ricevuta{o.conferma.dataRicezione ? " il "+o.conferma.dataRicezione : ""}</div>}
                  </div>
                );
              })}
              {allOrd.length === 0 && <div style={{ textAlign:"center", padding:30, color:T.sub }}>Nessun ordine</div>}
            </div>
          </div>
        );
      }

      if (homeView === "montaggi") {
        const allMont = montaggiDB.sort((a,b) => {
          if(a.stato==="completato" && b.stato!=="completato") return 1;
          if(a.stato!=="completato" && b.stato==="completato") return -1;
          return (a.data||"z").localeCompare(b.data||"z");
        });
        const daFare = allMont.filter(m => m.stato !== "completato").length;

        // Calendar helpers
        const mcd = montCalDate;
        const mcdY = mcd.getFullYear(), mcdM = mcd.getMonth();
        const daysInMonth = new Date(mcdY, mcdM + 1, 0).getDate();
        const firstDow = (new Date(mcdY, mcdM, 1).getDay() + 6) % 7; // Mon=0
        const montByDate: Record<string, typeof allMont> = {};
        allMont.forEach(m => { if (m.data) { (montByDate[m.data] = montByDate[m.data] || []).push(m); } });
        const todayStr = new Date().toISOString().split("T")[0];

        // Week view
        const weekStart = new Date(mcd);
        weekStart.setDate(weekStart.getDate() - ((weekStart.getDay() + 6) % 7));
        const weekDays: Date[] = [];
        for (let i = 0; i < 7; i++) { const d = new Date(weekStart); d.setDate(d.getDate() + i); weekDays.push(d); }

        // Render a montaggio card
        const renderMontCard = (m: any, expanded: boolean) => {
          const sq = squadreDB.find(s => s.id === m.squadraId);
          const cm = cantieri.find(cc => cc.id === m.cmId);
          const done = m.stato === "completato";
          const isExp = expanded;
          return (
            <div key={m.id} style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, marginBottom:8,
              borderLeft:"4px solid "+(done?"#34c759":"#007aff"), opacity:done?0.7:1 }}>
              <div onClick={() => setMontExpandId(isExp ? null : m.id)}
                style={{ padding:"12px 14px", cursor:"pointer" }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                  <div>
                    <div style={{ fontSize:13, fontWeight:700, color:T.text }}>{done?"‚úÖ":"üîß"} {m.cliente}</div>
                    <div style={{ fontSize:11, color:T.sub }}>{m.cmCode} ¬∑ {m.vani||"?"} vani ¬∑ {m.durata||""}</div>
                  </div>
                  <div style={{ textAlign:"right" }}>
                    <div style={{ fontSize:11, fontWeight:700, color:done?"#34c759":"#007aff" }}>{m.data ? new Date(m.data).toLocaleDateString("it-IT",{weekday:"short",day:"numeric",month:"short"}) : "‚Äî"}</div>
                    {sq && <div style={{ fontSize:10, color:sq.colore||T.sub, fontWeight:600 }}>{sq.nome}</div>}
                  </div>
                </div>
              </div>
              {isExp && (
                <div style={{ padding:"0 14px 14px", borderTop:"1px solid "+T.bdr }}>
                  {/* Detail grid */}
                  <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginTop:10 }}>
                    <div style={{ padding:8, borderRadius:8, background:T.bg }}>
                      <div style={{ fontSize:8, color:T.sub, fontWeight:700 }}>CLIENTE</div>
                      <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{m.cliente}</div>
                      {cm?.indirizzo && <div style={{ fontSize:10, color:T.sub }}>üìç {cm.indirizzo}</div>}
                      {cm?.telefono && <div onClick={(e) => { e.stopPropagation(); window.location.href="tel:"+cm.telefono; }} style={{ fontSize:10, color:T.acc, cursor:"pointer", marginTop:2 }}>üìû {cm.telefono}</div>}
                    </div>
                    <div style={{ padding:8, borderRadius:8, background:T.bg }}>
                      <div style={{ fontSize:8, color:T.sub, fontWeight:700 }}>PROGRAMMAZIONE</div>
                      <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{m.data ? new Date(m.data).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"}) : "Da programmare"}</div>
                      <div style={{ fontSize:10, color:T.sub }}>Ore: {m.orario||"‚Äî"} ¬∑ Durata: {m.durata||m.giorni+"g"||"‚Äî"}</div>
                    </div>
                  </div>
                  <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginTop:6 }}>
                    <div style={{ padding:8, borderRadius:8, background:T.bg }}>
                      <div style={{ fontSize:8, color:T.sub, fontWeight:700 }}>SQUADRA</div>
                      <div style={{ fontSize:12, fontWeight:700, color:sq?.colore||T.text }}>{sq?.nome||"Da assegnare"}</div>
                      <div style={{ fontSize:10, color:T.sub }}>{m.vani||"?"} vani</div>
                    </div>
                    <div style={{ padding:8, borderRadius:8, background:done?"#34c75910":"#007aff10" }}>
                      <div style={{ fontSize:8, color:T.sub, fontWeight:700 }}>STATO</div>
                      <div style={{ fontSize:12, fontWeight:700, color:done?"#34c759":"#007aff" }}>{done?"‚úÖ Completato":"‚è≥ "+m.stato}</div>
                    </div>
                  </div>
                  {m.note && <div style={{ marginTop:8, padding:8, borderRadius:8, background:"#ff950008", border:"1px solid #ff950020" }}>
                    <div style={{ fontSize:8, color:"#ff9500", fontWeight:700 }}>NOTE</div>
                    <div style={{ fontSize:11, color:T.text }}>{m.note}</div>
                  </div>}
                  {cm && <div onClick={(e) => { e.stopPropagation(); setSelectedCM(cm); setHomeView(null); setTab("commesse"); }}
                    style={{ marginTop:8, padding:10, borderRadius:8, background:T.acc+"10", textAlign:"center", fontSize:11, fontWeight:700, color:T.acc, cursor:"pointer", border:"1px solid "+T.acc+"30" }}>
                    üìÅ Apri commessa {cm.code}
                  </div>}
                </div>
              )}
            </div>
          );
        };

        return (
          <div style={{ paddingBottom: 80 }}>
            <div style={S.header}>
              {backBtn}
              <div style={{ flex:1 }}><div style={S.headerTitle}>üîß Montaggi</div><div style={S.headerSub}>{allMont.length} totali ¬∑ {daFare} da fare</div></div>
            </div>
            {/* View switcher */}
            <div style={{ display:"flex", gap:2, padding:"0 16px 8px" }}>
              {[{id:"lista",l:"üìã Lista"},{id:"mese",l:"üìÖ Mese"},{id:"settimana",l:"üìÜ Settimana"},{id:"giorno",l:"üìå Giorno"}].map(v => (
                <div key={v.id} onClick={() => setMontView(v.id)}
                  style={{ flex:1, padding:"7px 4px", borderRadius:8, textAlign:"center", fontSize:10, fontWeight:700, cursor:"pointer",
                    background:montView===v.id?"#007aff15":T.bg, color:montView===v.id?"#007aff":T.sub,
                    border:"1.5px solid "+(montView===v.id?"#007aff":T.bdr) }}>{v.l}</div>
              ))}
            </div>

            {/* ‚ïê‚ïê‚ïê LISTA ‚ïê‚ïê‚ïê */}
            {montView === "lista" && (
              <div style={{ padding:"0 16px" }}>
                {allMont.map(m => renderMontCard(m, montExpandId === m.id))}
                {allMont.length === 0 && <div style={{ textAlign:"center", padding:30, color:T.sub }}>Nessun montaggio</div>}
              </div>
            )}

            {/* ‚ïê‚ïê‚ïê MESE ‚ïê‚ïê‚ïê */}
            {montView === "mese" && (
              <div style={{ padding:"0 16px" }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <div onClick={() => setMontCalDate(new Date(mcdY, mcdM-1, 1))} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚óÄ</div>
                  <div style={{ fontSize:14, fontWeight:800, color:T.text }}>{mcd.toLocaleDateString("it-IT",{month:"long",year:"numeric"})}</div>
                  <div onClick={() => setMontCalDate(new Date(mcdY, mcdM+1, 1))} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚ñ∂</div>
                </div>
                <div style={{ display:"grid", gridTemplateColumns:"repeat(7,1fr)", gap:2 }}>
                  {["Lu","Ma","Me","Gi","Ve","Sa","Do"].map(d => <div key={d} style={{ textAlign:"center", fontSize:9, fontWeight:700, color:T.sub, padding:4 }}>{d}</div>)}
                  {Array.from({length: firstDow}).map((_,i) => <div key={"e"+i}/>)}
                  {Array.from({length: daysInMonth}).map((_,i) => {
                    const day = i + 1;
                    const dateStr = `${mcdY}-${String(mcdM+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                    const monts = montByDate[dateStr] || [];
                    const isToday = dateStr === todayStr;
                    return (
                      <div key={day} onClick={() => { if(monts.length > 0) { setMontCalDate(new Date(dateStr)); setMontView("giorno"); } }}
                        style={{ minHeight:40, padding:3, borderRadius:6, background:monts.length>0?"#007aff08":isToday?"#ff950008":"transparent",
                          border:isToday?"1.5px solid #ff9500":"1px solid "+T.bdr+"40", cursor:monts.length>0?"pointer":"default", position:"relative" as const }}>
                        <div style={{ fontSize:10, fontWeight:isToday?800:600, color:isToday?"#ff9500":T.text, textAlign:"center" }}>{day}</div>
                        {monts.map((m,mi) => {
                          const sq = squadreDB.find(s => s.id === m.squadraId);
                          const done = m.stato === "completato";
                          return <div key={mi} style={{ fontSize:7, fontWeight:700, padding:"1px 3px", borderRadius:3, marginTop:1,
                            background:done?"#34c75920":"#007aff20", color:done?"#34c759":"#007aff", overflow:"hidden", whiteSpace:"nowrap" as const, textOverflow:"ellipsis" }}>
                            {m.cliente?.split(" ")[0]}
                          </div>;
                        })}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* ‚ïê‚ïê‚ïê SETTIMANA ‚ïê‚ïê‚ïê */}
            {montView === "settimana" && (
              <div style={{ padding:"0 16px" }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <div onClick={() => { const d = new Date(montCalDate); d.setDate(d.getDate()-7); setMontCalDate(d); }} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚óÄ</div>
                  <div style={{ fontSize:13, fontWeight:800, color:T.text }}>
                    {weekDays[0].toLocaleDateString("it-IT",{day:"numeric",month:"short"})} ‚Äî {weekDays[6].toLocaleDateString("it-IT",{day:"numeric",month:"short",year:"numeric"})}
                  </div>
                  <div onClick={() => { const d = new Date(montCalDate); d.setDate(d.getDate()+7); setMontCalDate(d); }} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚ñ∂</div>
                </div>
                {weekDays.map(wd => {
                  const dateStr = wd.toISOString().split("T")[0];
                  const monts = montByDate[dateStr] || [];
                  const isToday = dateStr === todayStr;
                  const isSun = wd.getDay() === 0;
                  return (
                    <div key={dateStr} style={{ marginBottom:6, borderRadius:10, border:"1px solid "+(isToday?"#ff9500":T.bdr), background:isToday?"#ff950005":isSun?T.bg+"80":"transparent", overflow:"hidden" }}>
                      <div style={{ padding:"8px 12px", display:"flex", justifyContent:"space-between", alignItems:"center",
                        background:isToday?"#ff950010":"transparent", borderBottom:monts.length>0?"1px solid "+T.bdr:"none" }}>
                        <div style={{ fontSize:12, fontWeight:isToday?800:600, color:isToday?"#ff9500":isSun?T.sub:T.text }}>
                          {wd.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"short"})}
                        </div>
                        {monts.length > 0 && <span style={{ fontSize:9, fontWeight:700, color:"#007aff", background:"#007aff12", padding:"2px 6px", borderRadius:4 }}>{monts.length} mont.</span>}
                      </div>
                      {monts.map(m => renderMontCard(m, montExpandId === m.id))}
                      {monts.length === 0 && <div style={{ padding:"4px 12px 8px", fontSize:10, color:T.sub }}>‚Äî</div>}
                    </div>
                  );
                })}
              </div>
            )}

            {/* ‚ïê‚ïê‚ïê GIORNO ‚ïê‚ïê‚ïê */}
            {montView === "giorno" && (
              <div style={{ padding:"0 16px" }}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <div onClick={() => { const d = new Date(montCalDate); d.setDate(d.getDate()-1); setMontCalDate(d); }} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚óÄ</div>
                  <div style={{ fontSize:14, fontWeight:800, color:T.text }}>
                    {montCalDate.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}
                  </div>
                  <div onClick={() => { const d = new Date(montCalDate); d.setDate(d.getDate()+1); setMontCalDate(d); }} style={{ padding:"6px 12px", cursor:"pointer", fontSize:16 }}>‚ñ∂</div>
                </div>
                <div onClick={() => setMontCalDate(new Date())} style={{ textAlign:"center", fontSize:10, color:T.acc, cursor:"pointer", marginBottom:8, fontWeight:700 }}>üìå Oggi</div>
                {(() => {
                  const dateStr = montCalDate.toISOString().split("T")[0];
                  const monts = montByDate[dateStr] || [];
                  if (monts.length === 0) return <div style={{ textAlign:"center", padding:30, color:T.sub }}>Nessun montaggio per questa data</div>;
                  return monts.map(m => renderMontCard(m, montExpandId === m.id));
                })()}
              </div>
            )}
          </div>
        );
      }

      if (homeView === "fatture") {
        const allFat = fattureDB.sort((a,b) => (a.pagata===b.pagata ? (a.scadenza||"z").localeCompare(b.scadenza||"z") : a.pagata ? 1 : -1));
        const totInc = allFat.filter(f=>f.pagata).reduce((s,f)=>s+f.importo,0);
        const totDaInc = allFat.filter(f=>!f.pagata).reduce((s,f)=>s+f.importo,0);
        return (
          <div style={{ paddingBottom: 80 }}>
            <div style={S.header}>
              {backBtn}
              <div style={{ flex:1 }}><div style={S.headerTitle}>üìÑ Fatture</div><div style={S.headerSub}>{allFat.length} totali ¬∑ ‚Ç¨{totInc.toLocaleString("it-IT")} incassato ¬∑ ‚Ç¨{totDaInc.toLocaleString("it-IT")} da incassare</div></div>
            </div>
            <div style={{ padding:"0 16px" }}>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginBottom:12 }}>
                <div style={{ padding:12, borderRadius:10, background:"#34c75910", textAlign:"center", border:"1px solid #34c75930" }}>
                  <div style={{ fontSize:8, fontWeight:700, color:"#34c759" }}>INCASSATO</div>
                  <div style={{ fontSize:18, fontWeight:900, color:"#34c759" }}>‚Ç¨{totInc.toLocaleString("it-IT")}</div>
                </div>
                <div style={{ padding:12, borderRadius:10, background:"#ff3b3010", textAlign:"center", border:"1px solid #ff3b3030" }}>
                  <div style={{ fontSize:8, fontWeight:700, color:"#ff3b30" }}>DA INCASSARE</div>
                  <div style={{ fontSize:18, fontWeight:900, color:"#ff3b30" }}>‚Ç¨{totDaInc.toLocaleString("it-IT")}</div>
                </div>
              </div>
              {allFat.map(f => {
                const scaduta = !f.pagata && f.scadenza && f.scadenza < new Date().toISOString().split("T")[0];
                const cm = cantieri.find(cc => cc.id === f.cmId);
                return (
                  <div key={f.id} onClick={() => { if(cm) { setSelectedCM(cm); setHomeView(null); setTab("commesse"); } }}
                    style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:"12px 14px", marginBottom:8, cursor:"pointer",
                      borderLeft:"4px solid "+(f.pagata?"#34c759":scaduta?"#ff3b30":"#ff9500"), opacity:f.pagata?0.7:1 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                      <div>
                        <div style={{ fontSize:13, fontWeight:700, color:T.text }}>{f.pagata?"‚úÖ":"üìÑ"} {f.cliente}</div>
                        <div style={{ fontSize:11, color:T.sub }}>N.{f.numero}/{f.anno} ¬∑ {f.tipo} ¬∑ {f.cmCode}</div>
                      </div>
                      <div style={{ textAlign:"right" }}>
                        <div style={{ fontSize:15, fontWeight:900, color:f.pagata?"#34c759":scaduta?"#ff3b30":T.text }}>‚Ç¨{f.importo.toLocaleString("it-IT")}</div>
                        {f.scadenza && !f.pagata && <div style={{ fontSize:9, color:scaduta?"#ff3b30":"#ff9500", fontWeight:600 }}>{scaduta?"‚ö†Ô∏è Scaduta":"Scad."} {new Date(f.scadenza).toLocaleDateString("it-IT",{day:"numeric",month:"short"})}</div>}
                        {f.pagata && <div style={{ fontSize:9, color:"#34c759" }}>Pagata{f.dataPagamento?" il "+f.dataPagamento:""}</div>}
                      </div>
                    </div>
                  </div>
                );
              })}
              {allFat.length === 0 && <div style={{ textAlign:"center", padding:30, color:T.sub }}>Nessuna fattura</div>}
            </div>
          </div>
        );
      }

      setHomeView(null);
    }

    return (
      <div style={{ paddingBottom: 80 }}>
        {/* Header */}
        <div style={{ padding: "14px 16px 12px", background: T.card, borderBottom: `1px solid ${T.bdr}` }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 44, height: 44, borderRadius: 10, background: T.text, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>
                <span style={{ fontSize: 22, fontWeight: 800, color: T.card, fontFamily: FF, letterSpacing: -1 }}>M</span>
              </div>
              <div>
                <div style={{ fontSize: 17, fontWeight: 800, color: T.text, letterSpacing: -0.3, lineHeight: 1.1 }}>MASTRO</div>
                <div style={{ fontSize: 11, color: T.sub, marginTop: 1 }}>misure</div>
              </div>
            </div>
            <div style={{ display: "flex", flexDirection: "column" as const, alignItems: "flex-end", gap: 6 }}>
              <div style={{ textAlign: "right" as const }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span style={{ fontSize: 20 }}>‚õÖ</span>
                  <span style={{ fontSize: 18, fontWeight: 600 }}>12¬∞</span>
                </div>
                <div style={{ fontSize: 11, color: T.sub }}>Cosenza</div>
              </div>
              <div onClick={() => setHomeEditMode(e => !e)}
                style={{ padding: "4px 10px", borderRadius: 7, background: homeEditMode ? T.acc : T.bg, border: `1px solid ${homeEditMode ? T.acc : T.bdr}`, fontSize: 11, fontWeight: 700, color: homeEditMode ? "#fff" : T.sub, cursor: "pointer" }}>
                {homeEditMode ? "‚úì Fine" : "‚úè Riordina"}
              </div>
            </div>
          </div>
          <div style={{ fontSize: 22, fontWeight: 700, letterSpacing: -0.3 }}>{saluto}, Fabio</div>
          <div style={{ fontSize: 12, color: T.sub, marginTop: 1 }}>
            {today.toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long", year: "numeric" })}
          </div>
        </div>

        {/* Trial banner */}
        {activePlan === "trial" && (
          <div onClick={() => { setSettingsTab("piano"); setTab("settings"); }}
            style={{ margin: "0 16px 8px", padding: "8px 14px", borderRadius: 10, background: `linear-gradient(135deg, ${T.acc}20, ${T.acc}08)`, border: `1px solid ${T.acc}30`, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 14 }}>üíé</span>
              <div>
                <div style={{ fontSize: 11, fontWeight: 700, color: T.acc }}>Trial gratuito ¬∑ {trialDaysLeft} giorni rimasti</div>
                <div style={{ fontSize: 9, color: T.sub }}>Tutte le funzionalit√† sbloccate</div>
              </div>
            </div>
            <span style={{ fontSize: 10, fontWeight: 700, color: T.acc }}>Vedi piani ‚Ä∫</span>
          </div>
        )}
        {activePlan === "free" && (
          <div onClick={() => { setSettingsTab("piano"); setTab("settings"); }}
            style={{ margin: "0 16px 8px", padding: "8px 14px", borderRadius: 10, background: T.red + "10", border: `1px solid ${T.red}30`, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 14 }}>‚ö†Ô∏è</span>
              <div>
                <div style={{ fontSize: 11, fontWeight: 700, color: T.red }}>Trial scaduto</div>
                <div style={{ fontSize: 9, color: T.sub }}>Funzionalit√† limitate ¬∑ {cantieri.length}/5 commesse</div>
              </div>
            </div>
            <span style={{ fontSize: 10, fontWeight: 700, color: T.acc }}>Attiva piano ‚Ä∫</span>
          </div>
        )}

        {/* Search */}
        <div style={{ padding: "0 16px", marginBottom: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 14px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>
            <Ico d={ICO.search} s={16} c={T.sub} />
            <input style={{ flex: 1, border: "none", background: "transparent", fontSize: 13, color: T.text, outline: "none", fontFamily: FF }}
              placeholder="Cerca commesse, clienti, vani..." value={globalSearch} onChange={e => setGlobalSearch(e.target.value)} />
            {globalSearch && <div onClick={() => setGlobalSearch("")} style={{ cursor: "pointer", fontSize: 14, color: T.sub }}>‚úï</div>}
          </div>
          {globalSearch.trim().length > 1 && (() => {
            const q = globalSearch.toLowerCase();
            const cmResults = cantieri.filter(c => c.cliente?.toLowerCase().includes(q) || c.code?.toLowerCase().includes(q) || c.indirizzo?.toLowerCase().includes(q));
            const vanoResults = cantieri.flatMap(c => getVaniAttivi(c).filter(v => v.nome?.toLowerCase().includes(q) || v.tipo?.toLowerCase().includes(q) || v.stanza?.toLowerCase().includes(q)).map(v => ({ ...v, cmCode: c.code, cmCliente: c.cliente, cmId: c.id, cm: c })));
            const total = cmResults.length + vanoResults.length;
            return total > 0 ? (
              <div style={{ background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}`, marginTop: 6, maxHeight: 280, overflowY: "auto" as const }}>
                {cmResults.map(c => (
                  <div key={c.id} onClick={() => { setSelectedCM(c); setTab("commesse"); setGlobalSearch(""); }} style={{ padding: "10px 14px", borderBottom: `1px solid ${T.bg}`, cursor: "pointer", display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 16 }}>üìÅ</span>
                    <div><div style={{ fontSize: 12, fontWeight: 600 }}>{c.cliente}</div><div style={{ fontSize: 10, color: T.sub }}>{c.code} ¬∑ {c.indirizzo}</div></div>
                  </div>
                ))}
                {vanoResults.map(v => (
                  <div key={v.id} onClick={() => { setSelectedCM(v.cm); setSelectedVano(v); setTab("commesse"); setGlobalSearch(""); }} style={{ padding: "10px 14px", borderBottom: `1px solid ${T.bg}`, cursor: "pointer", display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 16 }}>ü™ü</span>
                    <div><div style={{ fontSize: 12, fontWeight: 600 }}>{v.nome}</div><div style={{ fontSize: 10, color: T.sub }}>{v.cmCode} ¬∑ {v.stanza} ¬∑ {v.tipo}</div></div>
                  </div>
                ))}
              </div>
            ) : (
              <div style={{ padding: "10px 14px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}`, marginTop: 6, fontSize: 12, color: T.sub, textAlign: "center" as const }}>Nessun risultato per "{globalSearch}"</div>
            );
          })()}
        </div>

        {/* üì• INBOX RAPIDO ‚Äî ordini in attesa di conferma */}
        {(() => {
          const ordiniInAttesa = ordiniFornDB.filter(o => o.stato && o.stato !== "bozza" && !o.conferma?.ricevuta);
          if (ordiniInAttesa.length === 0) return null;
          return (
            <div style={{ margin: "0 16px 10px" }}>
              <div onClick={() => apriInboxDocumento()} style={{
                padding: "14px 16px", borderRadius: 14, cursor: "pointer",
                background: "linear-gradient(135deg, #af52de15, #af52de08)",
                border: "2px solid #af52de30", display: "flex", alignItems: "center", gap: 12,
              }}>
                <div style={{ width: 44, height: 44, borderRadius: 12, background: "#af52de", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 22, position: "relative" }}>
                  üì•
                  <div style={{ position: "absolute", top: -4, right: -4, width: 18, height: 18, borderRadius: "50%", background: T.red, color: "#fff", fontSize: 10, fontWeight: 800, display: "flex", alignItems: "center", justifyContent: "center" }}>{ordiniInAttesa.length}</div>
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 800, color: "#af52de" }}>
                    {ordiniInAttesa.length} conferma{ordiniInAttesa.length > 1 ? "e" : ""} in attesa
                  </div>
                  <div style={{ fontSize: 11, color: T.sub, marginTop: 1 }}>
                    Carica PDF/foto da email, WhatsApp o portale ‚Üí AI legge tutto
                  </div>
                </div>
                <div style={{ fontSize: 16, color: "#af52de" }}>‚Üí</div>
              </div>
            </div>
          );
        })()}

        {/* Composable sections */}
        {drag.order.map(id => {
          if (!sections[id]) return null;
          return (
            <div key={id}
              draggable={homeEditMode}
              onDragStart={() => { if(homeEditMode) drag.start(id); }}
              onDragOver={e => { e.preventDefault(); if(homeEditMode) drag.onOver(id); }}
              onDrop={e => { e.preventDefault(); if(homeEditMode) drag.drop(id); }}
              onDragEnd={() => { if(homeEditMode) drag.end(); }}
              style={{ opacity: drag.dragging === id ? 0.4 : 1, borderTop: drag.over === id ? `2px solid ${T.acc}` : "none", transition: "opacity 0.15s" }}>
              {homeEditMode && (
                <div style={{ display: "flex", justifyContent: "center", padding: "2px 0" }}>
                  <span style={{ fontSize: 14, color: T.sub, cursor: "grab" }}>‚†ø</span>
                </div>
              )}
              <div style={{ filter: homeEditMode ? "brightness(0.97)" : "none", transition: "filter 0.15s" }}>
                {sections[id]}
              </div>
            </div>
          );
        })}
      </div>
    );
  };
// =======================================================
// MASTRO ERP v2 ‚Äî PARTE 2/5
// Righe 1281-2638: renderCMCard (con AFASE+euro+scadenza+borderLeft),
//                 renderCommesse, renderCMDetail (wizard 4-step + 3 tab
//                 sopralluoghi/misure/info + cronologia visite),
//                 renderRiepilogo, renderFasePanel
// =======================================================
  /* == COMMESSA CARD == */
  const renderCMCard = (c, inGrid) => {
    const fase = PIPELINE.find(p => p.id === c.fase);
    const progress = ((faseIndex(c.fase) + 1) / PIPELINE.length) * 100;
    const az = AFASE[c.fase] || AFASE["sopralluogo"];
    const TODAY_ISO = new Date().toISOString().split("T")[0];
    const isScad = c.scadenza && c.scadenza < TODAY_ISO;
    const isUrgente = (giorniFermaCM(c) >= sogliaDays && c.fase !== "chiusura") || isScad;
    // Conta vani misurati da visite
    const vaniMisurati = c.vaniList?.length > 0
      ? [...new Set((c.visite || []).flatMap(v => v.vaniMisurati))].length
      : null;
    return (
      <div key={c.id} style={{
        ...S.card,
        margin: inGrid ? "0" : "0 16px 8px",
        borderLeft: `3px solid ${isUrgente ? T.red : progress > 50 ? T.grn : T.blue}`
      }} onClick={() => { setSelectedCM(c); setTab("commesse"); }}>
        <div style={S.cardInner}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 11, fontWeight: 700, color: T.sub, fontFamily: FM }}>{c.code}</span>
                <span style={{ fontSize: 15, fontWeight: 600 }}>{c.cliente}</span>
              </div>
              <div style={{ fontSize: 12, color: T.sub, marginTop: 3 }}>
                {c.indirizzo}
                {vaniMisurati !== null
                  ? ` ¬∑ ${vaniMisurati}/${c.vaniList.length} vani rilevati`
                  : ` ¬∑ ${(c.rilievi||[]).length} rilievi`}
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 4, flexShrink: 0 }}>
              {isUrgente && <span style={{ ...S.badge(T.redLt, T.red), fontSize: 9 }}>FERMA</span>}
              {c.tipo === "riparazione" && <span style={S.badge(T.orangeLt, T.orange)}>üîß</span>}
              <span style={S.badge(fase?.color + "18", fase?.color)}>{fase?.nome}</span>
            </div>
          </div>
          {c.alert && <div style={{ ...S.badge(c.alert.includes("Nessun") ? T.orangeLt : T.redLt, c.alert.includes("Nessun") ? T.orange : T.red), marginTop: 6 }}>{c.alert}</div>}
          <div style={{ height: 3, background: T.bdr, borderRadius: 2, marginTop: 8 }}>
            <div style={{ height: "100%", borderRadius: 2, background: isUrgente ? T.red : fase?.color, width: `${progress}%`, transition: "width 0.3s" }} />
          </div>
          {/* Box azione suggerita per fase */}
          <div style={{
            display: "flex", alignItems: "center", justifyContent: "space-between",
            padding: "7px 10px", borderRadius: 7, marginTop: 8,
            background: isUrgente ? T.redLt : az.c + "12",
            border: `1px solid ${isUrgente ? T.red + "30" : az.c + "30"}`
          }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ fontSize: 14 }}>{isUrgente ? "üî¥" : az.i}</span>
              <div>
                <div style={{ fontSize: 11, fontWeight: 700, color: isUrgente ? T.red : az.c }}>
                  {isUrgente ? "Commessa bloccata" : az.t}
                </div>
                <div style={{ fontSize: 10, color: T.sub, marginTop: 1 }}>
                  {Math.round(progress)}%
                  {c.euro ? ` ¬∑ ‚Ç¨${c.euro.toLocaleString("it-IT")}` : ""}
                  {c.scadenza ? <span style={{ color: isScad ? T.red : T.sub }}>
                    {` ¬∑ scad. ${new Date(c.scadenza + "T12:00:00").toLocaleDateString("it-IT", { day: "numeric", month: "short" })}`}
                  </span> : null}
                </div>
              </div>
            </div>
            <div style={{ padding: "5px 10px", borderRadius: 6, background: isUrgente ? T.red : az.c, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer", flexShrink: 0 }}>
              {isUrgente ? "Sblocca" : "‚Üí"}
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* == COMMESSE TAB == */
  // ============================================================
  // RENDER LISTA RILIEVI (livello intermedio: commessa ‚Üí rilievi)
  // ============================================================
  const renderRilieviList = () => {
    const c = selectedCM;
    const rilievi = c.rilievi || [];

    const salvaRilievo = () => {
      const n = rilievi.length + 1;
      const nr = {
        id: Date.now(), n,
        data: nuovoRilData.data || new Date().toISOString().split("T")[0],
        ora: nuovoRilData.ora || "",
        rilevatore: nuovoRilData.rilevatore || "",
        tipo: nuovoRilTipo,
        motivoModifica: nuovoRilData.motivoModifica || "",
        note: nuovoRilData.note || "",
        stato: "nuovo",
        vani: [],
      };
      const updCM = { ...c, rilievi: [...rilievi, nr], aggiornato: "Oggi" };
      setCantieri(cs => cs.map(x => x.id === c.id ? updCM : x));
      setSelectedCM(updCM);
      setShowNuovoRilievo(false);
      setNuovoRilData({ data: "", ora: "", rilevatore: "", note: "", motivoModifica: "" });
      setNuovoRilTipo("rilievo");
      setSelectedRilievo(nr);
    };

    // == WIZARD NUOVO RILIEVO ==
    if (showNuovoRilievo) return (
      <div style={{ paddingBottom: 80 }}>
        <div style={S.header}>
          <div onClick={() => setShowNuovoRilievo(false)} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>Nuovo Rilievo</div>
            <div style={S.headerSub}>{c.code} ¬∑ {c.cliente} {c.cognome}</div>
          </div>
        </div>
        <div style={{ padding: 16 }}>
          {/* Tipo */}
          <div style={{ fontSize: 12, fontWeight: 700, color: T.sub, marginBottom: 8, textTransform: "uppercase", letterSpacing: 0.5 }}>Tipo di visita</div>
          {[
            { k: "rilievo",    ico: "üìê", l: "Rilievo misure",    d: "Misuri i vani del cantiere" },
            { k: "definitiva", ico: "‚úÖ", l: "Misure definitive", d: "Conferma finale ‚Äî si va in produzione" },
            { k: "modifica",   ico: "üîß", l: "Modifica",          d: "Cliente cambia configurazione o aggiunge vani" },
          ].map(t => (
            <div key={t.k} onClick={() => setNuovoRilTipo(t.k)}
              style={{ ...S.card, padding: "12px 14px", marginBottom: 8, cursor: "pointer",
                border: `1.5px solid ${nuovoRilTipo === t.k ? T.acc : T.bdr}`,
                background: nuovoRilTipo === t.k ? T.accLt : T.card,
                display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ fontSize: 22 }}>{t.ico}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: nuovoRilTipo === t.k ? T.acc : T.text }}>{t.l}</div>
                <div style={{ fontSize: 11, color: T.sub }}>{t.d}</div>
              </div>
              {nuovoRilTipo === t.k && <div style={{ width: 18, height: 18, borderRadius: "50%", background: T.acc, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 11 }}>‚úì</div>}
            </div>
          ))}
          {nuovoRilTipo === "modifica" && (
            <div style={{ marginBottom: 14 }}>
              <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>MOTIVO MODIFICA</div>
              <input style={S.input} placeholder="Es: cliente cambia 3 balconi in finestre..." value={nuovoRilData.motivoModifica} onChange={e => setNuovoRilData(d => ({...d, motivoModifica: e.target.value}))} />
            </div>
          )}
          {/* Dati */}
          <div style={{ fontSize: 12, fontWeight: 700, color: T.sub, marginBottom: 8, marginTop: 16, textTransform: "uppercase", letterSpacing: 0.5 }}>Data e rilevatore</div>
          <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 11, color: T.sub, marginBottom: 4 }}>DATA</div>
              <input style={S.input} type="date" value={nuovoRilData.data} onChange={e => setNuovoRilData(d => ({...d, data: e.target.value}))} />
            </div>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 11, color: T.sub, marginBottom: 4 }}>ORA</div>
              <input style={S.input} type="time" value={nuovoRilData.ora} onChange={e => setNuovoRilData(d => ({...d, ora: e.target.value}))} />
            </div>
          </div>
          <div style={{ marginBottom: 10 }}>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 4 }}>RILEVATORE</div>
            <input style={S.input} placeholder="Chi esegue il rilievo..." value={nuovoRilData.rilevatore} onChange={e => setNuovoRilData(d => ({...d, rilevatore: e.target.value}))} />
          </div>
          <div>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 4 }}>NOTE</div>
            <textarea style={{ ...S.input, minHeight: 60, resize: "vertical" }} placeholder="Note preliminari..." value={nuovoRilData.note} onChange={e => setNuovoRilData(d => ({...d, note: e.target.value}))} />
          </div>
          <button onClick={salvaRilievo} style={{ ...S.btn, width: "100%", marginTop: 20, background: T.grn }}>‚úì Crea Rilievo</button>
        </div>
      </div>
    );

    // == REPORT DIFFERENZE ==
    const renderReportDiff = () => {
      if (rilievi.length < 2) return (
        <div style={{ padding: 20, textAlign: "center", color: T.sub, fontSize: 12 }}>
          Servono almeno 2 rilievi per generare il report differenze.
        </div>
      );
      return (
        <div style={{ padding: "0 16px 80px" }}>
          {rilievi.slice(1).map((r, idx) => {
            const prev = rilievi[idx];
            const prevVani = prev?.vani || [];
            const currVani = r.vani || [];
            const aggiunti = currVani.filter(v => !prevVani.some(p => p.nome.replace(" ‚ùå","") === v.nome.replace(" ‚ùå","")));
            const rimossi  = prevVani.filter(p => !currVani.some(v => v.nome.replace(" ‚ùå","") === p.nome.replace(" ‚ùå","")));
            const modificati = currVani.filter(v => {
              const match = prevVani.find(p => p.nome.replace(" ‚ùå","") === v.nome.replace(" ‚ùå",""));
              if (!match) return false;
              return JSON.stringify(v.misure) !== JSON.stringify(match.misure) ||
                     v.sistema !== match.sistema || v.tipo !== match.tipo;
            });
            return (
              <div key={r.id} style={{ ...S.card, marginBottom: 12 }}>
                <div style={{ padding: "11px 14px", borderBottom: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 8 }}>
                  <div style={{ fontSize: 20 }}>üîÄ</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, fontWeight: 700 }}>R{prev.n} ‚Üí R{r.n}</div>
                    <div style={{ fontSize: 11, color: T.sub }}>
                      {new Date(prev.data + "T12:00:00").toLocaleDateString("it-IT", { day:"numeric", month:"short" })} ‚Üí {new Date(r.data + "T12:00:00").toLocaleDateString("it-IT", { day:"numeric", month:"short" })}
                    </div>
                  </div>
                  {aggiunti.length + rimossi.length + modificati.length === 0
                    ? <span style={S.badge(T.grnLt, T.grn)}>Nessuna differenza</span>
                    : <span style={S.badge(T.orangeLt, T.orange)}>{aggiunti.length + rimossi.length + modificati.length} diff</span>}
                </div>
                <div style={{ padding: "10px 14px" }}>
                  {aggiunti.length > 0 && (
                    <div style={{ marginBottom: 8 }}>
                      <div style={{ fontSize: 10, fontWeight: 700, color: T.grn, marginBottom: 4 }}>+ AGGIUNTI</div>
                      {aggiunti.map(v => <span key={v.id} style={{ ...S.badge(T.grnLt, T.grn), marginRight: 4, marginBottom: 4, display: "inline-block" }}>+ {v.nome.replace(" ‚ùå","")}</span>)}
                    </div>
                  )}
                  {rimossi.length > 0 && (
                    <div style={{ marginBottom: 8 }}>
                      <div style={{ fontSize: 10, fontWeight: 700, color: T.red, marginBottom: 4 }}>- RIMOSSI</div>
                      {rimossi.map(v => <span key={v.id} style={{ ...S.badge(T.redLt, T.red), marginRight: 4, marginBottom: 4, display: "inline-block" }}>- {v.nome.replace(" ‚ùå","")}</span>)}
                    </div>
                  )}
                  {modificati.length > 0 && (
                    <div>
                      <div style={{ fontSize: 10, fontWeight: 700, color: T.orange, marginBottom: 6 }}>~ MODIFICATI</div>
                      {modificati.map(v => {
                        const match = prevVani.find(p => p.nome.replace(" ‚ùå","") === v.nome.replace(" ‚ùå",""));
                        const diffMisure = Object.entries(v.misure || {}).filter(([k, val]) => match?.misure?.[k] !== val);
                        return (
                          <div key={v.id} style={{ marginBottom: 8, padding: "8px 10px", background: T.orangeLt, borderRadius: 8, border: `1px solid ${T.orange}30` }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.orange, marginBottom: 4 }}>~ {v.nome.replace(" ‚ùå","")}</div>
                            {v.sistema !== match?.sistema && <div style={{ fontSize: 11, color: T.text, marginBottom: 2 }}>Sistema: <strong>{match?.sistema || "‚Äî"}</strong> ‚Üí <strong>{v.sistema}</strong></div>}
                            {v.tipo !== match?.tipo && <div style={{ fontSize: 11, color: T.text, marginBottom: 2 }}>Tipo: <strong>{match?.tipo || "‚Äî"}</strong> ‚Üí <strong>{v.tipo}</strong></div>}
                            {diffMisure.slice(0, 5).map(([k, val]) => (
                              <div key={k} style={{ fontSize: 11, color: T.sub }}>
                                {k}: <span style={{ color: T.red }}>{match?.misure?.[k] || 0}</span> ‚Üí <span style={{ color: T.grn }}>{val as any}</span>
                              </div>
                            ))}
                          </div>
                        );
                      })}
                    </div>
                  )}
                  {aggiunti.length + rimossi.length + modificati.length === 0 && (
                    <div style={{ fontSize: 12, color: T.sub }}>Nessuna variazione tra i due rilievi.</div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê COMMESSA CHIUSA ‚Üí DOSSIER COMPLETO ‚ïê‚ïê‚ïê
    if (c.fase === "chiusura") {
      const allVD = getVaniAttivi(c);
      const fattD = fattureDB.filter(f => f.cmId === c.id);
      const ordD = (ordiniFornDB || []).filter(o => o.cmId === c.id);
      const montD = (montaggiDB || []).filter(m => m.cmId === c.id);
      const totPD = allVD.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0) + (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
      const ivaP = c.ivaPerc || 10;
      const totID = totPD * (1 + ivaP / 100);
      const incD = fattD.filter(f => f.pagata).reduce((s, f) => s + f.importo, 0);
      const costD = ordD.reduce((s, o) => s + (o.totaleIva || o.totale || 0), 0);
      const restD = totID - incD;
      const fD = (n: number) => "‚Ç¨" + n.toLocaleString("it-IT", { minimumFractionDigits: 2 });
      // dossierTab is defined at component top level

      // Timeline events
      const timeline: Array<{data:string;iso:string;ico:string;titolo:string;desc:string;col:string;ora?:string}> = [];
      timeline.push({ data: c.creato || "", iso: "0000", ico: "üìÅ", titolo: "Commessa creata", desc: c.code + " ¬∑ " + c.cliente + " " + (c.cognome||""), col: "#86868b", ora: "09:00" });
      (c.rilievi||[]).forEach(r => timeline.push({ data: r.data || "", iso: r.data || "", ico: "üìê", titolo: "Rilievo #" + r.n + " ‚Äî " + (r.tipo||"rilievo"), desc: (r.vani||[]).length + " vani ¬∑ " + (r.rilevatore||"Fabio"), col: "#5856d6", ora: r.ora || "10:00" }));
      if(c.firmaCliente) timeline.push({ data: c.dataFirma || "", iso: c.dataFirma || "", ico: "‚úçÔ∏è", titolo: "Preventivo firmato", desc: "Importo: " + fD(totID) + " (IVA " + ivaP + "%)", col: "#34c759", ora: "11:00" });
      ordD.forEach(o => timeline.push({ data: o.dataInvio || "", iso: o.dataInvio || "", ico: "üì¶", titolo: "Ordine " + (o.fornitore?.nome||""), desc: fD(o.totaleIva||o.totale||0) + " ¬∑ " + (o.conferma?.ricevuta ? "Confermato" : o.stato), col: "#ff9500", ora: "09:30" }));
      ordD.filter(o => o.conferma?.ricevuta && o.conferma?.dataRicezione).forEach(o => timeline.push({ data: o.conferma.dataRicezione, iso: o.conferma.dataRicezione, ico: "‚úÖ", titolo: "Conferma ricevuta " + (o.fornitore?.nome||""), desc: o.conferma.nomeFile || "", col: "#34c759", ora: "14:00" }));
      montD.forEach(m => timeline.push({ data: m.data || "", iso: m.data || "", ico: "üîß", titolo: "Montaggio", desc: (m.vani||"?") + " vani ¬∑ " + ((squadreDB||[]).find(s=>s.id===m.squadraId)?.nome||"") + " ¬∑ " + m.stato, col: "#007aff", ora: m.orario || "08:00" }));
      fattD.forEach(f => timeline.push({ data: f.dataISO || f.data || "", iso: f.dataISO || "", ico: "üìÑ", titolo: "Fattura N." + f.numero + "/" + f.anno + " ‚Äî " + f.tipo, desc: fD(f.importo) + (f.pagata ? " ¬∑ ‚úÖ Pagata" : " ¬∑ ‚è≥ Da incassare"), col: f.pagata ? "#34c759" : "#ff3b30", ora: "10:00" }));
      // Messaggi e email collegati alla commessa
      const chIcoD = { email: "üìß", whatsapp: "üí¨", sms: "üì±", telegram: "‚úàÔ∏è" };
      const chColD = { email: "#5856d6", whatsapp: "#25d366", sms: "#ff9500", telegram: "#0088cc" };
      const msgsCm = msgs.filter(m => m.cm === c.code);
      msgsCm.forEach(m => {
        (m.thread || []).forEach(t => {
          timeline.push({ data: t.date || m.date || "", iso: m.date || "", ico: chIcoD[t.canale || m.canale] || "üí¨", titolo: (t.who === "Tu" ? "Inviato a " + m.from : "Ricevuto da " + m.from) + " ¬∑ " + (t.canale || m.canale), desc: t.text?.substring(0, 80) + (t.text?.length > 80 ? "..." : ""), col: chColD[t.canale || m.canale] || "#86868b", ora: t.time || m.time || "" });
        });
      });
      (c.log||[]).forEach(l => timeline.push({ data: l.quando || "", iso: "", ico: "üìù", titolo: l.cosa, desc: l.chi || "", col: l.color || "#86868b", ora: l.ora || "" }));
      timeline.sort((a,b) => (a.iso||"").localeCompare(b.iso||""));

      // Foto from rilievi
      const fotoVani: Array<{vano:string;stanza:string;tipo:string;url:string}> = [];
      allVD.forEach(v => {
        if(v.foto) Object.values(v.foto).forEach((url: any) => { if(url && typeof url === "string") fotoVani.push({ vano: v.nome||v.tipo, stanza: v.stanza||"", tipo: v.tipo, url }); });
      });

      // Print report
      const stampaReport = () => {
        const w = window.open("", "_blank");
        if(!w) return;
        const vaniHTML = allVD.map(v => {
          const m = v.misure || {};
          return `<tr><td>${v.nome||v.tipo}</td><td>${v.stanza||""}</td><td>${v.tipo}</td><td>${v.sistema||c.sistema||""}</td><td>${m.lCentro||"‚Äî"}√ó${m.hCentro||"‚Äî"}</td><td>${fD(calcolaVanoPrezzo(v,c))}</td></tr>`;
        }).join("");
        const fatHTML = fattD.map(f => `<tr><td>N.${f.numero}/${f.anno}</td><td>${f.tipo}</td><td>${fD(f.importo)}</td><td>${f.pagata?"‚úÖ Pagata":"‚è≥ Da incassare"}</td><td>${f.data||""}</td></tr>`).join("");
        const ordHTML = ordD.map(o => `<tr><td>${o.fornitore?.nome||""}</td><td>${fD(o.totaleIva||o.totale||0)}</td><td>${o.stato}</td><td>${o.consegna?.prevista||""}</td></tr>`).join("");
        const timeHTML = timeline.map(t => `<tr><td>${t.data}${t.ora ? "<br><small>" + t.ora + "</small>" : ""}</td><td>${t.ico} ${t.titolo}</td><td>${t.desc}</td></tr>`).join("");
        const msgHTML = msgsCm.length > 0 ? msgsCm.map(m => {
          const threads = (m.thread||[]).map(t => `<div style="margin:4px 0;padding:6px 10px;border-radius:8px;background:${t.who==="Tu"?"#e8f5e9":"#f5f5f5"};font-size:11px"><b>${t.who}</b> ¬∑ ${t.date} ${t.time}<br>${t.text}</div>`).join("");
          return `<div style="margin-bottom:12px;border:1px solid #ddd;border-radius:8px;overflow:hidden"><div style="padding:8px 12px;background:#f8f8f8;border-bottom:1px solid #ddd"><b>${m.from}</b> ¬∑ ${m.canale} ¬∑ ${(m.thread||[]).length} msg</div><div style="padding:8px 12px">${threads}</div></div>`;
        }).join("") : "";
        w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Dossier ${c.code}</title>
<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:0 auto;padding:20px;color:#1a1a1c}
h1{color:#34c759;border-bottom:3px solid #34c759;padding-bottom:8px}h2{color:#555;margin-top:24px;border-bottom:1px solid #ddd;padding-bottom:4px}
table{width:100%;border-collapse:collapse;margin:8px 0}th,td{border:1px solid #ddd;padding:6px 8px;text-align:left;font-size:12px}
th{background:#f5f5f5;font-weight:700}.grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:12px 0}
.kpi{background:#f8f8f8;padding:12px;border-radius:8px;text-align:center}.kpi b{font-size:18px;display:block}
.green{color:#34c759}.red{color:#ff3b30}.orange{color:#ff9500}
@media print{body{padding:0}h1{font-size:18px}}</style></head><body>
<h1>üìã DOSSIER COMMESSA ${c.code}</h1>
<p><b>Cliente:</b> ${c.cliente} ${c.cognome||""}<br>
<b>Indirizzo:</b> ${c.indirizzo||""}<br>
<b>Telefono:</b> ${c.telefono||""} ¬∑ <b>Email:</b> ${c.email||""}<br>
<b>CF:</b> ${c.cf||""} ¬∑ <b>P.IVA:</b> ${c.piva||""}<br>
<b>Sistema:</b> ${c.sistema||""} ¬∑ <b>Tipo:</b> ${c.tipo||""}<br>
<b>Pratica Fiscale:</b> ${c.praticaFiscale||"Nessuna"}</p>
<h2>üí∞ Riepilogo Economico</h2>
<div class="grid">
<div class="kpi"><small>PREVENTIVO</small><b>${fD(totID)}</b></div>
<div class="kpi"><small>INCASSATO</small><b class="green">${fD(incD)}</b></div>
<div class="kpi"><small>MARGINE</small><b class="${(incD-costD)>=0?"green":"red"}">${fD(incD-costD)}</b></div>
</div>
<p>Imponibile: ${fD(totPD)} ¬∑ IVA ${ivaP}% ¬∑ Totale: ${fD(totID)}<br>
Costi fornitori: ${fD(costD)} ¬∑ Margine: ${fD(incD-costD)} (${totPD>0?Math.round((incD-costD)/totPD*100):0}%)</p>
<h2>üìê Vani (${allVD.length})</h2>
<table><tr><th>Nome</th><th>Stanza</th><th>Tipo</th><th>Sistema</th><th>L√óH mm</th><th>Prezzo</th></tr>${vaniHTML}</table>
<h2>üìÑ Fatture (${fattD.length})</h2>
<table><tr><th>Numero</th><th>Tipo</th><th>Importo</th><th>Stato</th><th>Data</th></tr>${fatHTML}</table>
<h2>üì¶ Ordini (${ordD.length})</h2>
<table><tr><th>Fornitore</th><th>Importo</th><th>Stato</th><th>Consegna</th></tr>${ordHTML}</table>
<h2>üìÖ Timeline</h2>
<table><tr><th>Data/Ora</th><th>Evento</th><th>Dettaglio</th></tr>${timeHTML}</table>
${msgsCm.length > 0 ? "<h2>üí¨ Comunicazioni (" + msgsCm.length + " conversazioni)</h2>" + msgHTML : ""}
<hr><p style="font-size:10px;color:#999">Generato da MASTRO ERP ¬∑ Walter Cozza Serramenti SRL ¬∑ ${new Date().toLocaleDateString("it-IT")}</p>
</body></html>`);
        w.document.close();
        setTimeout(() => w.print(), 500);
      };

      return (
        <div style={{ paddingBottom: 80 }}>
          {/* Header */}
          <div style={S.header}>
            <div onClick={() => { setSelectedCM(null); setSelectedRilievo(null); }} style={{ cursor:"pointer", padding:4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
            <div style={{ flex:1 }}>
              <div style={S.headerTitle}>{c.code} ¬∑ {c.cliente} {c.cognome||""}</div>
              <div style={S.headerSub}>{c.indirizzo}</div>
            </div>
            <div style={{ display:"flex", gap:6, alignItems:"center" }}>
              <div onClick={stampaReport} style={{ padding:"6px 12px", borderRadius:8, background:"#007aff", color:"#fff", fontSize:10, fontWeight:700, cursor:"pointer" }}>üñ® Stampa</div>
              <span style={{ padding:"6px 12px", borderRadius:9, background:"#34c75918", color:"#34c759", fontSize:11, fontWeight:800, border:"1.5px solid #34c759" }}>‚úÖ ARCHIVIATA</span>
            </div>
          </div>

          {/* Banner verde */}
          <div style={{ margin:"0 16px 8px", background:"#34c759", borderRadius:14, padding:"16px 18px", display:"flex", alignItems:"center", gap:12 }}>
            <div style={{ fontSize:28 }}>üìã</div>
            <div style={{ flex:1 }}>
              <div style={{ fontSize:18, fontWeight:900, color:"#fff" }}>DOSSIER COMMESSA</div>
              <div style={{ fontSize:12, color:"#ffffffcc" }}>{c.code} ¬∑ Completata ¬∑ {allVD.length} vani ¬∑ {fD(totID)}</div>
            </div>
          </div>

          {/* Tab navigation */}
          <div style={{ display:"flex", gap:2, padding:"0 16px 8px" }}>
            {[
              { id:"storia", l:"üìÖ Storia", col:"#5856d6" },
              { id:"economico", l:"üí∞ Economico", col:"#34c759" },
              { id:"vani", l:"üìê Vani", col:"#007aff" },
              { id:"documenti", l:"üìÅ Documenti", col:"#ff9500" },
            ].map(t => (
              <div key={t.id} onClick={() => setDossierTab(t.id)}
                style={{ flex:1, padding:"8px 4px", borderRadius:8, textAlign:"center", fontSize:10, fontWeight:700, cursor:"pointer",
                  background: dossierTab === t.id ? t.col + "15" : T.bg,
                  color: dossierTab === t.id ? t.col : T.sub,
                  border: "1.5px solid " + (dossierTab === t.id ? t.col : T.bdr),
                }}>{t.l}</div>
            ))}
          </div>

          {/* ‚ïê‚ïê‚ïê TAB: STORIA (Timeline) ‚ïê‚ïê‚ïê */}
          {dossierTab === "storia" && (
            <div style={{ padding:"0 16px" }}>
              {/* Cliente card */}
              <div style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:14, marginBottom:10 }}>
                <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6 }}>üë§ DATI CLIENTE</div>
                <div style={{ fontSize:14, fontWeight:700, color:T.text }}>{c.cliente} {c.cognome||""}</div>
                {c.indirizzo && <div style={{ fontSize:12, color:T.sub, marginTop:2 }}>üìç {c.indirizzo}</div>}
                <div style={{ display:"flex", gap:12, marginTop:6, flexWrap:"wrap" as const }}>
                  {c.telefono && <span onClick={() => window.location.href="tel:"+c.telefono} style={{ fontSize:11, color:T.acc, cursor:"pointer" }}>üìû {c.telefono}</span>}
                  {c.email && <span style={{ fontSize:11, color:T.acc }}>‚úâÔ∏è {c.email}</span>}
                </div>
                <div style={{ display:"flex", gap:12, marginTop:4, flexWrap:"wrap" as const }}>
                  {c.cf && <span style={{ fontSize:10, color:T.sub }}>CF: {c.cf}</span>}
                  {c.piva && <span style={{ fontSize:10, color:T.sub }}>P.IVA: {c.piva}</span>}
                  {c.pec && <span style={{ fontSize:10, color:T.sub }}>PEC: {c.pec}</span>}
                  {c.sdi && <span style={{ fontSize:10, color:T.sub }}>SDI: {c.sdi}</span>}
                </div>
                <div style={{ display:"flex", gap:6, marginTop:6, flexWrap:"wrap" as const }}>
                  {c.sistema && <span style={S.badge(T.blueLt, T.blue)}>{c.sistema}</span>}
                  {c.tipo && <span style={S.badge(T.grnLt, T.grn)}>{c.tipo}</span>}
                  {c.praticaFiscale && <span style={S.badge("#ff950018", "#ff9500")}>üèõ {c.praticaFiscale}</span>}
                </div>
              </div>

              {/* Timeline */}
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:8 }}>üìÖ TIMELINE COMPLETA ({timeline.length} eventi)</div>
              {timeline.map((ev, i) => (
                <div key={i} style={{ display:"flex", gap:10, marginBottom:2 }}>
                  <div style={{ display:"flex", flexDirection:"column" as const, alignItems:"center", width:24 }}>
                    <div style={{ width:24, height:24, borderRadius:12, background:ev.col+"18", display:"flex", alignItems:"center", justifyContent:"center", fontSize:11, flexShrink:0 }}>{ev.ico}</div>
                    {i < timeline.length - 1 && <div style={{ width:2, flex:1, background:T.bdr, marginTop:2 }}/>}
                  </div>
                  <div style={{ flex:1, paddingBottom:12 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                      <div style={{ fontSize:12, fontWeight:700, color:T.text, flex:1 }}>{ev.titolo}</div>
                      <div style={{ fontSize:9, color:ev.col, fontWeight:600, textAlign:"right" as const, flexShrink:0, marginLeft:8 }}>
                        {ev.data}{ev.ora ? " ¬∑ " + ev.ora : ""}
                      </div>
                    </div>
                    <div style={{ fontSize:10, color:T.sub, marginTop:1 }}>{ev.desc}</div>
                  </div>
                </div>
              ))}

              {/* Note */}
              {c.note && (
                <div style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:14, marginTop:8 }}>
                  <div style={{ fontSize:10, fontWeight:800, color:T.sub, marginBottom:4 }}>üìù NOTE</div>
                  <div style={{ fontSize:12, color:T.text, whiteSpace:"pre-wrap" as const }}>{c.note}</div>
                </div>
              )}

              {/* Messaggi collegati */}
              {msgsCm.length > 0 && (
                <div style={{ marginTop:12 }}>
                  <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:8 }}>üí¨ COMUNICAZIONI ({msgsCm.length} conversazioni ¬∑ {msgsCm.reduce((s,m) => s + (m.thread?.length||0), 0)} messaggi)</div>
                  {msgsCm.map(m => {
                    const chIcoM = { email: "üìß", whatsapp: "üí¨", sms: "üì±", telegram: "‚úàÔ∏è" };
                    const chColM = { email: "#5856d6", whatsapp: "#25d366", sms: "#ff9500", telegram: "#0088cc" };
                    const mcol = chColM[m.canale] || "#86868b";
                    return (
                      <div key={m.id} style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, marginBottom:8, overflow:"hidden" }}>
                        <div style={{ padding:"10px 14px", borderBottom:"1px solid "+T.bdr, display:"flex", alignItems:"center", gap:10, background:mcol+"06" }}>
                          <div style={{ width:32, height:32, borderRadius:"50%", background:mcol+"18", display:"flex", alignItems:"center", justifyContent:"center", fontSize:14 }}>{chIcoM[m.canale]||"üí¨"}</div>
                          <div style={{ flex:1 }}>
                            <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{m.from}</div>
                            <div style={{ fontSize:9, color:T.sub }}>{m.canale} ¬∑ {m.date||""} ¬∑ {(m.thread||[]).length} messaggi</div>
                          </div>
                        </div>
                        <div style={{ padding:"8px 14px" }}>
                          {(m.thread||[]).map((t, ti) => {
                            const isMe = t.who === "Tu";
                            return (
                              <div key={ti} style={{ display:"flex", justifyContent:isMe?"flex-end":"flex-start", marginBottom:4 }}>
                                <div style={{ maxWidth:"85%", padding:"8px 12px", borderRadius:isMe?"12px 12px 4px 12px":"12px 12px 12px 4px",
                                  background:isMe?mcol+"15":T.bg, fontSize:11, color:T.text }}>
                                  <div style={{ fontSize:9, fontWeight:700, color:isMe?mcol:T.sub, marginBottom:2 }}>{t.who} ¬∑ {t.date} {t.time}</div>
                                  {t.text}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: ECONOMICO ‚ïê‚ïê‚ïê */}
          {dossierTab === "economico" && (
            <div style={{ padding:"0 16px" }}>
              {/* KPI */}
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:8, marginBottom:12 }}>
                {[{l:"PREVENTIVO",v:fD(totID),cl:T.text},{l:"INCASSATO",v:fD(incD),cl:"#34c759"},{l:"MARGINE",v:fD(incD-costD),cl:(incD-costD)>=0?"#34c759":"#ff3b30"}].map((k,i) => (
                  <div key={i} style={{ padding:12, borderRadius:10, background:T.card, textAlign:"center", border:"1px solid "+T.bdr }}>
                    <div style={{ fontSize:8, color:T.sub, fontWeight:700 }}>{k.l}</div>
                    <div style={{ fontSize:18, fontWeight:900, color:k.cl }}>{k.v}</div>
                  </div>
                ))}
              </div>
              {/* Detail */}
              <div style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:14, marginBottom:10 }}>
                <div style={{ fontSize:10, fontWeight:800, color:T.sub, marginBottom:8 }}>DETTAGLIO</div>
                {[
                  { l: "Imponibile", v: fD(totPD) },
                  { l: "IVA " + ivaP + "%", v: fD(totID - totPD) },
                  { l: "Totale preventivo", v: fD(totID), bold: true },
                  { l: "Costi fornitori", v: fD(costD), cl: "#ff9500" },
                  { l: "Margine lordo", v: fD(incD - costD), cl: (incD-costD) >= 0 ? "#34c759" : "#ff3b30", bold: true },
                  { l: "% Margine", v: totPD > 0 ? Math.round((incD-costD)/totPD*100) + "%" : "‚Äî" },
                ].map((r, i) => (
                  <div key={i} style={{ display:"flex", justifyContent:"space-between", padding:"5px 0", borderBottom: "1px solid " + T.bdr + "30", fontSize:12 }}>
                    <span style={{ color:T.sub, fontWeight: r.bold ? 700 : 400 }}>{r.l}</span>
                    <span style={{ color: r.cl || T.text, fontWeight: r.bold ? 800 : 600 }}>{r.v}</span>
                  </div>
                ))}
              </div>
              {restD > 0 && <div style={{ background:"#ff950010", borderRadius:12, border:"1px solid #ff950030", padding:14, textAlign:"center", marginBottom:10 }}>
                <div style={{ fontSize:10, fontWeight:700, color:"#ff9500" }}>‚ö†Ô∏è RESTA DA INCASSARE</div>
                <div style={{ fontSize:22, fontWeight:900, color:"#ff9500" }}>{fD(restD)}</div>
              </div>}
              {/* Fatture */}
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6 }}>üìÑ FATTURE ({fattD.length})</div>
              {fattD.map(f => (
                <div key={f.id} style={{ background:T.card, borderRadius:10, border:"1px solid "+T.bdr, padding:"10px 12px", marginBottom:6, borderLeft:"4px solid "+(f.pagata?"#34c759":"#ff3b30") }}>
                  <div style={{ display:"flex", justifyContent:"space-between" }}>
                    <div>
                      <div style={{ fontSize:12, fontWeight:700, color:T.text }}>N.{f.numero}/{f.anno} ‚Äî {f.tipo}</div>
                      <div style={{ fontSize:10, color:T.sub }}>{f.data} ¬∑ {f.cliente}</div>
                    </div>
                    <div style={{ textAlign:"right" }}>
                      <div style={{ fontSize:14, fontWeight:900, color:f.pagata?"#34c759":"#ff3b30" }}>{fD(f.importo)}</div>
                      <div style={{ fontSize:9, color:f.pagata?"#34c759":"#ff9500" }}>{f.pagata?"‚úÖ Pagata"+(f.dataPagamento?" "+f.dataPagamento:""):"‚è≥ Scad. "+(f.scadenza||"")}</div>
                    </div>
                  </div>
                </div>
              ))}
              {/* Ordini */}
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6, marginTop:10 }}>üì¶ ORDINI FORNITORI ({ordD.length})</div>
              {ordD.map(o => {
                const st = ORDINE_STATI.find(s => s.id === o.stato) || ORDINE_STATI[0];
                return (
                  <div key={o.id} style={{ background:T.card, borderRadius:10, border:"1px solid "+T.bdr, padding:"10px 12px", marginBottom:6, borderLeft:"4px solid "+st.color }}>
                    <div style={{ display:"flex", justifyContent:"space-between" }}>
                      <div>
                        <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{st.icon} {o.fornitore?.nome||""}</div>
                        <div style={{ fontSize:10, color:T.sub }}>Inviato: {o.dataInvio||""} ¬∑ Consegna: {o.consegna?.prevista||"‚Äî"}</div>
                      </div>
                      <div style={{ textAlign:"right" }}>
                        <div style={{ fontSize:14, fontWeight:900, color:T.text }}>{fD(o.totaleIva||o.totale||0)}</div>
                        <span style={{ fontSize:8, fontWeight:700, padding:"2px 6px", borderRadius:4, background:st.color+"18", color:st.color }}>{st.label}</span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: VANI ‚ïê‚ïê‚ïê */}
          {dossierTab === "vani" && (
            <div style={{ padding:"0 16px" }}>
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:8 }}>üìê VANI RILEVATI ({allVD.length})</div>
              {(c.rilievi||[]).map(r => (
                <div key={r.id}>
                  <div onClick={() => setSelectedRilievo(r)} style={{ fontSize:11, fontWeight:700, color:"#5856d6", marginBottom:6, cursor:"pointer" }}>
                    üìê Rilievo #{r.n} ‚Äî {r.data} ¬∑ {r.rilevatore||"Fabio"} ¬∑ {(r.vani||[]).length} vani
                  </div>
                  {(r.vani||[]).map(v => {
                    const m = v.misure || {};
                    const prezzo = calcolaVanoPrezzo(v, c);
                    return (
                      <div key={v.id} style={{ background:T.card, borderRadius:12, border:"1px solid "+T.bdr, padding:12, marginBottom:8 }}>
                        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div>
                            <div style={{ fontSize:13, fontWeight:700, color:T.text }}>{v.nome || v.tipo}</div>
                            <div style={{ fontSize:10, color:T.sub }}>{v.stanza||""} ¬∑ {v.piano||""} ¬∑ {v.tipo} ¬∑ {v.sistema||c.sistema||""}</div>
                          </div>
                          <div style={{ textAlign:"right" }}>
                            <div style={{ fontSize:13, fontWeight:900, color:T.acc }}>{fD(prezzo)}</div>
                            <div style={{ fontSize:9, color:T.sub }}>{m.lCentro||"‚Äî"}√ó{m.hCentro||"‚Äî"} mm</div>
                          </div>
                        </div>
                        {/* Colors */}
                        <div style={{ display:"flex", gap:6, marginTop:6, flexWrap:"wrap" as const }}>
                          {v.coloreInt && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:T.bg, color:T.sub }}>Int: {v.coloreInt}</span>}
                          {v.coloreEst && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:T.bg, color:T.sub }}>Est: {v.coloreEst}</span>}
                          {v.bicolore && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:"#af52de18", color:"#af52de" }}>Bicolore</span>}
                        </div>
                        {/* Accessories */}
                        <div style={{ display:"flex", gap:4, marginTop:4, flexWrap:"wrap" as const }}>
                          {v.accessori?.tapparella?.attivo && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:"#007aff12", color:"#007aff" }}>ü™ü Tapparella</span>}
                          {v.accessori?.persiana?.attivo && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:"#ff950012", color:"#ff9500" }}>üö™ Persiana</span>}
                          {v.accessori?.zanzariera?.attivo && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:"#34c75912", color:"#34c759" }}>ü¶ü Zanzariera</span>}
                          {v.cassonetto && <span style={{ fontSize:9, padding:"2px 6px", borderRadius:4, background:"#86868b12", color:"#86868b" }}>üì¶ Cassonetto</span>}
                        </div>
                        {/* Measures detail */}
                        {Object.keys(m).length > 0 && (
                          <div style={{ marginTop:6, padding:8, borderRadius:8, background:T.bg, display:"grid", gridTemplateColumns:"1fr 1fr 1fr 1fr", gap:4 }}>
                            {[{l:"L alto",v:m.lAlto},{l:"L centro",v:m.lCentro},{l:"L basso",v:m.lBasso},{l:"H sx",v:m.hSx},{l:"H centro",v:m.hCentro},{l:"H dx",v:m.hDx},{l:"D1",v:m.d1},{l:"D2",v:m.d2}].map((mi,idx) => mi.v ? (
                              <div key={idx} style={{ textAlign:"center" }}>
                                <div style={{ fontSize:7, color:T.sub }}>{mi.l}</div>
                                <div style={{ fontSize:10, fontWeight:700, color:T.text }}>{mi.v}</div>
                              </div>
                            ) : null)}
                          </div>
                        )}
                        {v.note && <div style={{ fontSize:10, color:T.sub, marginTop:4, fontStyle:"italic" }}>{v.note}</div>}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          )}

          {/* ‚ïê‚ïê‚ïê TAB: DOCUMENTI ‚ïê‚ïê‚ïê */}
          {dossierTab === "documenti" && (
            <div style={{ padding:"0 16px" }}>
              {/* Pratica Fiscale */}
              {c.praticaFiscale && (
                <div style={{ background:"#ff950010", borderRadius:12, border:"1px solid #ff950030", padding:14, marginBottom:10 }}>
                  <div style={{ fontSize:12, fontWeight:800, color:"#ff9500" }}>üèõ Pratica Fiscale: {c.praticaFiscale}</div>
                  {(c.docFiscali||[]).map((d: any, i: number) => (
                    <div key={i} style={{ display:"flex", alignItems:"center", gap:8, padding:"6px 0", borderBottom:"1px solid #ff950020" }}>
                      <span style={{ fontSize:14 }}>üìë</span>
                      <div><div style={{ fontSize:11, fontWeight:700, color:T.text }}>{typeof d === "string" ? d : d.nome}</div>{d.data && <div style={{ fontSize:9, color:T.sub }}>{d.data}</div>}</div>
                    </div>
                  ))}
                </div>
              )}
              {/* Doc identita */}
              {(c.docIdentita||[]).length > 0 && (
                <div style={{ background:"#5856d610", borderRadius:12, border:"1px solid #5856d630", padding:14, marginBottom:10 }}>
                  <div style={{ fontSize:12, fontWeight:800, color:"#5856d6", marginBottom:6 }}>ü™™ Documenti di Riconoscimento</div>
                  {(c.docIdentita||[]).map((d: any, i: number) => (
                    <div key={i} style={{ display:"flex", alignItems:"center", gap:10, padding:"8px 0", borderBottom:"1px solid #5856d620" }}>
                      <div style={{ width:36, height:36, borderRadius:8, background:"#5856d618", display:"flex", alignItems:"center", justifyContent:"center", fontSize:16 }}>{d.tipo==="CI"?"ü™™":"üí≥"}</div>
                      <div style={{ flex:1 }}>
                        <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{d.tipo==="CI"?"Carta d'Identit√†":"Codice Fiscale"}</div>
                        <div style={{ fontSize:10, color:T.sub }}>{d.nome} ¬∑ {d.data||""}</div>
                      </div>
                      {d.dataUrl && <img src={d.dataUrl} style={{ width:48, height:48, borderRadius:6, objectFit:"cover" as const }} />}
                    </div>
                  ))}
                </div>
              )}
              {/* Allegati */}
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6 }}>üìé ALLEGATI ({(c.allegati||[]).length})</div>
              {(c.allegati||[]).map((a: any, i: number) => (
                <div key={i} style={{ display:"flex", alignItems:"center", gap:10, padding:"8px 0", borderBottom:"1px solid "+T.bdr+"20" }}>
                  <div style={{ width:32, height:32, borderRadius:8, background:T.bg, display:"flex", alignItems:"center", justifyContent:"center", fontSize:14 }}>
                    {a.tipo==="firma"?"‚úçÔ∏è":a.tipo==="fattura"?"üìÑ":a.tipo==="ordine"?"üì¶":a.tipo==="conferma"?"‚úÖ":a.tipo==="verbale"?"üìã":"üìé"}
                  </div>
                  <div style={{ flex:1 }}>
                    <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{a.nome}</div>
                    <div style={{ fontSize:10, color:T.sub }}>{a.tipo||"allegato"} ¬∑ {a.data||""}</div>
                  </div>
                </div>
              ))}
              {(c.allegati||[]).length === 0 && <div style={{ fontSize:11, color:T.sub, textAlign:"center", padding:16 }}>Nessun allegato</div>}
              {/* Foto Vani */}
              {fotoVani.length > 0 && (
                <div style={{ marginTop:12 }}>
                  <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6 }}>üì∑ FOTO VANI ({fotoVani.length})</div>
                  <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:6 }}>
                    {fotoVani.map((f, i) => (
                      <div key={i} style={{ borderRadius:8, overflow:"hidden", border:"1px solid "+T.bdr }}>
                        <img src={f.url} style={{ width:"100%", height:80, objectFit:"cover" as const }} />
                        <div style={{ padding:"3px 6px", fontSize:8, color:T.sub }}>{f.vano}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Montaggi */}
          {montD.length > 0 && (
            <div style={{ padding:"8px 16px" }}>
              <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", marginBottom:6 }}>üîß MONTAGGI ({montD.length})</div>
              {montD.map(m => { const sq=(squadreDB||[]).find(s=>s.id===m.squadraId); return (
                <div key={m.id} style={{ background:T.card, borderRadius:10, border:"1px solid "+T.bdr, padding:"10px 12px", marginBottom:6 }}>
                  <div style={{ display:"flex", justifyContent:"space-between" }}>
                    <div><div style={{ fontSize:12, fontWeight:700, color:T.text }}>{m.data||"‚Äî"} ¬∑ {sq?.nome||""}</div><div style={{ fontSize:10, color:T.sub }}>{m.vani||"?"} vani ¬∑ {m.durata||""}</div></div>
                    <span style={{ fontSize:10, fontWeight:700, color:m.stato==="completato"?"#34c759":"#007aff" }}>{m.stato==="completato"?"‚úÖ Completato":m.stato}</span>
                  </div>
                  {m.note && <div style={{ fontSize:10, color:T.sub, marginTop:3 }}>{m.note}</div>}
                </div>
              );})}
            </div>
          )}

          {/* Actions */}
          <div style={{ padding:"12px 16px", display:"flex", gap:8, justifyContent:"center" }}>
            <div onClick={stampaReport} style={{ padding:"10px 20px", borderRadius:10, background:"#007aff", color:"#fff", fontSize:12, fontWeight:700, cursor:"pointer" }}>üñ® Stampa Report Completo</div>
            <div onClick={() => { setCantieri(cs => cs.map(cm => cm.id===c.id?{...cm,fase:"posa"}:cm)); setSelectedCM(p => ({...p,fase:"posa"})); }}
              style={{ padding:"10px 20px", borderRadius:10, background:"#ff950018", color:"#ff9500", fontSize:12, fontWeight:700, cursor:"pointer", border:"1px solid #ff950040" }}>‚Ü© Riapri</div>
          </div>
          <div style={{ padding:"8px 16px", textAlign:"center" }}>
            <span onClick={() => deleteCommessa(c.id)} style={{ fontSize:11, color:T.sub2||T.sub, cursor:"pointer", textDecoration:"underline" }}>Elimina commessa</span>
          </div>
        </div>
      );
    }

    // == LISTA RILIEVI ==
    const tipoColor = { rilievo: T.blue, definitiva: T.grn, modifica: T.orange };
    const tipoIco   = { rilievo: "üìê", definitiva: "‚úÖ", modifica: "üîß" };
    const [rilTab, setRilTab] = (window as any).__rilTab__ || [null, null];
    // Use local state via component trick: riutilizza cmSubTab per il tab rilievi/report
    return (
      <div style={{ paddingBottom: 80 }}>
        {/* Header */}
        <div style={S.header}>
          <div onClick={() => { setSelectedCM(null); setSelectedRilievo(null); }} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>{c.code} ¬∑ {c.cliente} {c.cognome || ""}</div>
            <div style={S.headerSub}>{c.indirizzo}</div>
          </div>
          {c.fase === "chiusura" ? (
            <span style={{ padding: "6px 14px", borderRadius: 9, background: "#34c75918", color: "#34c759", fontSize: 11, fontWeight: 800, border: "1.5px solid #34c759" }}>‚úÖ ARCHIVIATA</span>
          ) : (
          <div onClick={() => setShowNuovoRilievo(true)}
            style={{ padding: "7px 14px", borderRadius: 9, background: T.acc, color: "#fff", fontSize: 12, fontWeight: 700, cursor: "pointer", display: "flex", alignItems: "center", gap: 6 }}>
            + Rilievo
          </div>
          )}
        </div>

        {/* Info badges */}
        <div style={{ padding: "8px 16px", display: "flex", gap: 6, flexWrap: "wrap" }}>
          <PipelineBar fase={c.fase} />
        </div>
        <div style={{ padding: "0 16px 8px", display: "flex", gap: 6, flexWrap: "wrap" }}>
          {c.sistema && <span style={S.badge(T.blueLt, T.blue)}>{c.sistema}</span>}
          {c.tipo === "nuova" && <span style={S.badge(T.grnLt, T.grn)}>üÜï Nuova</span>}
          {c.tipo === "riparazione" && <span style={S.badge(T.orangeLt, T.orange)}>üîß Riparazione</span>}
          {c.telefono && <span onClick={() => window.location.href=`tel:${c.telefono}`} style={{ ...S.badge(T.grnLt, T.grn), cursor: "pointer" }}>üìû {c.telefono}</span>}
          {c.euro > 0 && <span style={S.badge(T.accLt, T.acc)}>‚Ç¨{c.euro.toLocaleString("it-IT")}</span>}
        </div>


        {/* ‚ïê‚ïê‚ïê DOSSIER COMMESSA CHIUSA ‚ïê‚ïê‚ïê */}
        {c.fase === "chiusura" && (() => {
          const rilievi = c.rilievi || [];
          const allVani = getVaniAttivi(c);
          const fattCm = fattureDB.filter(f => f.cmId === c.id);
          const ordCm = (ordiniFornDB || []).filter(o => o.cmId === c.id);
          const montCm = (montaggiDB || []).filter(m => m.cmId === c.id);
          const totPrev = allVani.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0) + (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
          const totIvaD = totPrev * (1 + (c.ivaPerc || 10) / 100);
          const incassato = fattCm.filter(f => f.pagata).reduce((s, f) => s + f.importo, 0);
          const costoForn = ordCm.reduce((s, o) => s + (o.totaleIva || o.totale || 0), 0);
          const fmtE = (n: number) => "‚Ç¨" + n.toLocaleString("it-IT", { minimumFractionDigits: 2 });
          const docs: Array<{ico:string;nome:string;detail:string;col:string}> = [];
          rilievi.forEach(r => docs.push({ ico: "üìè", nome: `Rilievo #${r.n} ‚Äî ${r.tipo || "rilievo"}`, detail: `${(r.vani || []).length} vani ¬∑ ${r.data || ""}`, col: T.blue }));
          if (c.firmaCliente) docs.push({ ico: "‚úçÔ∏è", nome: "Preventivo Firmato", detail: c.dataFirma || "", col: T.grn });
          fattCm.forEach(f => docs.push({ ico: "üìÑ", nome: `Fattura N.${f.numero}/${f.anno} ‚Äî ${f.tipo}`, detail: `${fmtE(f.importo)} ¬∑ ${f.pagata ? "‚úÖ Pagata" : "‚è≥ Da incassare"}`, col: f.pagata ? T.grn : T.red }));
          ordCm.forEach(o => docs.push({ ico: "üì¶", nome: `Ordine ${o.fornitore?.nome || ""}`, detail: `${fmtE(o.totaleIva || o.totale || 0)} ¬∑ ${o.conferma?.ricevuta ? "‚úÖ Confermato" : "‚è≥"}`, col: T.purple }));
          montCm.forEach(m => { const sq = (squadreDB || []).find(s => s.id === m.squadraId); docs.push({ ico: "üîß", nome: `Montaggio ${m.data || ""}`, detail: `${sq?.nome || ""} ¬∑ ${m.stato === "completato" ? "‚úÖ Completato" : m.stato}`, col: "#007aff" }); });
          if (c.praticaFiscale) docs.push({ ico: "üèõ", nome: `Pratica Fiscale: ${c.praticaFiscale}`, detail: `${(c.docFiscali || []).length} documenti`, col: T.orange });
          (c.docIdentita || []).forEach(d => docs.push({ ico: d.tipo === "CI" ? "ü™™" : "üí≥", nome: d.tipo === "CI" ? "Carta d'Identit√†" : "Codice Fiscale", detail: `${d.nome} ¬∑ ${d.data || ""}`, col: "#5856d6" }));
          (c.docFiscali || []).forEach(d => docs.push({ ico: "üìë", nome: d.nome, detail: d.data || "", col: T.orange }));
          (c.allegati || []).forEach(a => docs.push({ ico: a.tipo === "firma" ? "‚úçÔ∏è" : a.tipo === "fattura" ? "üìÑ" : a.tipo === "ordine" ? "üì¶" : a.tipo === "conferma" ? "‚úÖ" : a.tipo === "verbale" ? "üìã" : "üìé", nome: a.nome, detail: a.data || "", col: "#86868b" }));
          
          return <div style={{ margin: "0 16px 12px", background: "linear-gradient(135deg, #34c75908, #34c75912)", borderRadius: 16, border: "2px solid #34c759", overflow: "hidden" }}>
            {/* Banner */}
            <div style={{ background: "#34c759", padding: "14px 16px", display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ fontSize: 24 }}>üìã</div>
              <div>
                <div style={{ fontSize: 16, fontWeight: 900, color: "#fff" }}>DOSSIER COMMESSA</div>
                <div style={{ fontSize: 11, color: "#ffffffcc" }}>{c.code} ¬∑ {c.cliente} {c.cognome || ""} ¬∑ Completata</div>
              </div>
            </div>
            
            {/* Dati Cliente */}
            <div style={{ padding: "12px 16px", borderBottom: "1px solid #34c75920" }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>üë§ CLIENTE</div>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{c.cliente} {c.cognome || ""}</div>
              {c.indirizzo && <div style={{ fontSize: 11, color: T.sub }}>üìç {c.indirizzo}</div>}
              <div style={{ display: "flex", gap: 12, marginTop: 4 }}>
                {c.telefono && <span style={{ fontSize: 11, color: T.acc }}>üìû {c.telefono}</span>}
                {c.email && <span style={{ fontSize: 11, color: T.acc }}>‚úâÔ∏è {c.email}</span>}
                {c.cf && <span style={{ fontSize: 11, color: T.sub }}>CF: {c.cf}</span>}
              </div>
            </div>
            
            {/* Riepilogo Economico */}
            <div style={{ padding: "12px 16px", borderBottom: "1px solid #34c75920" }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üí∞ RIEPILOGO ECONOMICO</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6 }}>
                <div style={{ padding: 8, borderRadius: 8, background: "#fff", textAlign: "center" }}>
                  <div style={{ fontSize: 7, color: T.sub, fontWeight: 700 }}>PREVENTIVO</div>
                  <div style={{ fontSize: 14, fontWeight: 900, color: T.text }}>{fmtE(totIvaD)}</div>
                </div>
                <div style={{ padding: 8, borderRadius: 8, background: "#fff", textAlign: "center" }}>
                  <div style={{ fontSize: 7, color: T.sub, fontWeight: 700 }}>INCASSATO</div>
                  <div style={{ fontSize: 14, fontWeight: 900, color: T.grn }}>{fmtE(incassato)}</div>
                </div>
                <div style={{ padding: 8, borderRadius: 8, background: "#fff", textAlign: "center" }}>
                  <div style={{ fontSize: 7, color: T.sub, fontWeight: 700 }}>MARGINE</div>
                  <div style={{ fontSize: 14, fontWeight: 900, color: (incassato - costoForn) >= 0 ? T.grn : T.red }}>{fmtE(incassato - costoForn)}</div>
                </div>
              </div>
            </div>
            
            {/* Tutti i Documenti */}
            <div style={{ padding: "12px 16px" }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üìÅ DOCUMENTI E ATTIVIT√Ä ({docs.length})</div>
              {docs.map((d, i) => (
                <div key={i} style={{ display: "flex", alignItems: "center", padding: "8px 0", borderBottom: i < docs.length - 1 ? "1px solid #34c75915" : "none" }}>
                  <div style={{ width: 28, height: 28, borderRadius: 8, background: d.col + "18", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, flexShrink: 0 }}>{d.ico}</div>
                  <div style={{ flex: 1, marginLeft: 8 }}>
                    <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{d.nome}</div>
                    <div style={{ fontSize: 9, color: T.sub }}>{d.detail}</div>
                  </div>
                </div>
              ))}
            </div>
            
            {/* Riapri */}
            <div style={{ padding: "8px 16px 12px", textAlign: "center" }}>
              <div onClick={() => { setCantieri(cs => cs.map(cm => cm.id === c.id ? {...cm, fase: "posa"} : cm)); setSelectedCM(p => ({...p, fase: "posa"})); }}
                style={{ fontSize: 11, color: "#ff9500", cursor: "pointer", textDecoration: "underline" }}>‚Ü© Riapri commessa</div>
            </div>
          </div>;
        })()}

        {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
        {/* ‚ïê‚ïê‚ïê CENTRO COMANDO v4 ‚Äî TIMELINE COMPLETA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
        {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
        {c.fase !== "chiusura" && (() => {
          const vani = getVaniAttivi(c);
          const rilievi = c.rilievi || [];
          const hasRilievi = rilievi.length > 0;
          const hasVani = vani.length > 0;
          const vaniConMisure = vani.filter(v => Object.keys(v.misure || {}).length >= 4);
          const vaniConPrezzo = vani.filter(v => calcolaVanoPrezzo(v, c) > 0);
          const totVani = vani.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0);
          const totVoci = (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
          const totPreventivo = totVani + totVoci;
          const ivaPerc = c.ivaPerc || 10;
          const totIva = totPreventivo * (1 + ivaPerc / 100);
          const hasFirma = !!c.firmaCliente;
          const fattureCommessa = fattureDB.filter(f => f.cmId === c.id);
          const hasAcconto = fattureCommessa.some(f => f.tipo === "acconto");
          const hasUnica = fattureCommessa.some(f => f.tipo === "unica");
          const hasFattura = hasAcconto || hasUnica;
          const incassato = fattureCommessa.filter(f => f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
          const ordiniCommessa = ordiniFornDB.filter(o => o.cmId === c.id);
          const hasOrdine = ordiniCommessa.length > 0;
          const ordineConfermato = ordiniCommessa.some(o => o.conferma?.ricevuta);
          const confermaFirmata = ordiniCommessa.some(o => o.conferma?.firmata);
          const montaggiCommessa = montaggiDB.filter(m => m.cmId === c.id);
          const hasMontaggio = montaggiCommessa.length > 0;
          const hasSaldo = fattureCommessa.some(f => f.tipo === "saldo");
          const saldoPagato = fattureCommessa.find(f => f.tipo === "saldo")?.pagata;
          const unicaPagata = fattureCommessa.find(f => f.tipo === "unica")?.pagata;
          const tuttoChiuso = (hasSaldo && saldoPagato) || (hasUnica && unicaPagata) || (c.fase === "chiusura" && incassato >= totIva) || (incassato >= totIva && fattureCommessa.length > 0 && fattureCommessa.every(f => f.pagata));

          const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";

          const steps = [
            { id: "rilievo", icon: "üìê", label: "Rilievo", done: hasRilievi,
              detail: hasRilievi ? `${rilievi.length} rilievo ¬∑ ${vani.length} vani ¬∑ ${rilievi[0]?.data || ""}` : null },
            { id: "misure", icon: "üìè", label: "Misure e Preventivo", done: hasVani && vaniConPrezzo.length > 0,
              detail: vaniConPrezzo.length > 0 ? `${vaniConPrezzo.length}/${vani.length} vani prezzati ¬∑ Totale ‚Ç¨${fmt(totPreventivo)}` : hasVani ? `${vaniConMisure.length}/${vani.length} vani misurati` : null },
            { id: "firma", icon: "‚úçÔ∏è", label: "Firma Cliente", done: hasFirma,
              detail: hasFirma ? `Firmato il ${c.dataFirma || "‚Äî"} ¬∑ ‚Ç¨${fmt(totIva)} IVA incl.` : null },
            { id: "fattura", icon: "üí∞", label: "Fattura Acconto", done: hasFattura,
              detail: hasFattura ? fattureCommessa.map(f => `${f.tipo} ‚Ç¨${fmt(f.importo)} ${f.pagata ? "‚úÖ pagata" : "‚è≥ in attesa"}`).join(" ¬∑ ") : null },
            { id: "ordine", icon: "üì¶", label: "Ordine Fornitore", done: hasOrdine,
              detail: hasOrdine ? `${ordiniCommessa[0]?.fornitore?.nome || "Fornitore da inserire"} ¬∑ ‚Ç¨${fmt(ordiniCommessa[0]?.totaleIva || 0)} ¬∑ ${ordiniCommessa[0]?.stato || "bozza"}` : null },
            { id: "conferma", icon: "üìÑ", label: "Conferma Fornitore", done: confermaFirmata,
              detail: ordineConfermato ? `Ricevuta ¬∑ ${ordiniCommessa[0]?.consegna?.settimane || "?"} sett. ¬∑ consegna ${ordiniCommessa[0]?.consegna?.prevista ? new Date(ordiniCommessa[0].consegna.prevista).toLocaleDateString("it-IT") : "da definire"}` : null },
            { id: "montaggio", icon: "üîß", label: "Montaggio", done: hasMontaggio,
              detail: hasMontaggio ? `${montaggiCommessa[0]?.data ? new Date(montaggiCommessa[0].data).toLocaleDateString("it-IT") : "Da pianificare"} ¬∑ Squadra ${squadreDB.find(s => s.id === montaggiCommessa[0]?.squadraId)?.nome || "‚Äî"}` : null },
            { id: "saldo", icon: "üí∂", label: "Chiusura", done: tuttoChiuso,
              detail: tuttoChiuso ? `Incassato ‚Ç¨${fmt(incassato)} ¬∑ ‚úÖ Completata` : null },
          ];

          const doneCount = steps.filter(s => s.done).length;
          const currentIdx = steps.findIndex(s => !s.done);
          const current = currentIdx >= 0 ? steps[currentIdx] : null;
          const progress = Math.round((doneCount / steps.length) * 100);

          return (
            <div style={{ margin: "0 16px 12px" }}>
              {/* Header with progress */}
              <div style={{ background: T.card, borderRadius: "16px 16px 0 0", border: `1px solid ${T.bdr}`, borderBottom: "none", padding: "14px 16px" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                  <div style={{ fontSize: 14, fontWeight: 800, color: T.text }}>üéØ Centro Comando</div>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.acc, fontFamily: FM }}>{doneCount}/{steps.length} ¬∑ {progress}%</div>
                </div>
                <div style={{ height: 6, background: T.bg, borderRadius: 3, overflow: "hidden" }}>
                  <div style={{ height: "100%", background: `linear-gradient(90deg, #34c759, ${T.acc})`, width: `${progress}%`, borderRadius: 3, transition: "width 0.5s" }} />
                </div>
                {/* Success flash */}
                {ccDone && (
                  <div style={{ marginTop: 6, padding: "10px 12px", borderRadius: 8, background: "#34c75918", border: "1px solid #34c75940", fontSize: 13, fontWeight: 700, color: "#34c759", textAlign: "center", animation: "fadeIn 0.3s" }}>
                    {ccDone}
                  </div>
                )}
                {/* Step dots */}
                <div style={{ display: "flex", justifyContent: "space-between", marginTop: 6, padding: "0 2px" }}>
                  {steps.map((s, i) => (
                    <div key={s.id} style={{
                      width: 24, height: 24, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12,
                      background: s.done ? "#34c759" : i === currentIdx ? T.acc : T.bg,
                      color: s.done || i === currentIdx ? "#fff" : T.sub, fontWeight: 700,
                      boxShadow: i === currentIdx ? `0 0 0 3px ${T.acc}40` : "none",
                    }}>{s.done ? "‚úì" : s.icon}</div>
                  ))}
                </div>
              </div>

              {/* Timeline ‚Äî ALL steps visible */}
              <div style={{ background: T.card, border: `1px solid ${T.bdr}`, borderTop: "none", borderRadius: "0 0 16px 16px", overflow: "hidden" }}>
                {steps.map((step, idx) => {
                  const isCurrent = idx === currentIdx;
                  const isFuture = !step.done && !isCurrent;
                  const borderColor = step.done ? "#34c759" : isCurrent ? T.acc : T.bg;

                  // Collect docs for this step
                  const stepDocs: any[] = [];
                  if (step.id === "rilievo") { rilievi.forEach(r => stepDocs.push({ nome: `Rilievo #${r.n} ‚Äî ${r.data}`, tipo: "rilievo", data: r.data, detail: `${(r.vani||[]).length} vani ¬∑ ${r.rilevatore||"Fabio"}` })); }
                  else if (step.id === "misure") { stepDocs.push({ nome: `Preventivo ${c.code}`, tipo: "preventivo", detail: `${vaniConPrezzo.length} vani ¬∑ ‚Ç¨${fmt(totPreventivo)}` }); }
                  else if (step.id === "firma") { stepDocs.push({ nome: "Preventivo firmato", tipo: "firma", data: c.dataFirma||"‚Äî", detail: `‚Ç¨${fmt(totIva)} IVA incl.` }); (c.allegati||[]).filter(a => a.tipo === "firma").forEach(a => stepDocs.push({ nome: a.nome, tipo: a.tipo, data: a.data, detail: "" })); }
                  else if (step.id === "fattura") { fattureCommessa.forEach(f => stepDocs.push({ nome: `Fattura N.${f.numero}/${f.anno} ‚Äî ${f.tipo}`, tipo: "fattura", data: f.data, detail: `‚Ç¨${fmt(f.importo)} ¬∑ ${f.pagata?"‚úÖ Pagata":"‚è≥ In attesa"}` })); }
                  else if (step.id === "ordine") { ordiniCommessa.forEach(o => stepDocs.push({ nome: `Ordine ${o.fornitore?.nome||""}`, tipo: "ordine", data: o.dataInvio, detail: `‚Ç¨${fmt(o.totaleIva||0)} ¬∑ ${o.stato}` })); }
                  else if (step.id === "conferma") { ordiniCommessa.filter(o => o.conferma?.ricevuta).forEach(o => stepDocs.push({ nome: o.conferma?.nomeFile||`Conferma ${o.fornitore?.nome}`, tipo: "conferma", data: o.conferma?.dataRicezione, detail: `${o.consegna?.settimane||"?"} sett.` })); }
                  else if (step.id === "montaggio") { montaggiCommessa.forEach(m => stepDocs.push({ nome: `Montaggio ${m.data?new Date(m.data).toLocaleDateString("it-IT"):"‚Äî"}`, tipo: "montaggio", data: m.data, detail: `${squadreDB.find(s=>s.id===m.squadraId)?.nome||"‚Äî"} ¬∑ ${m.stato}` })); }
                  else if (step.id === "saldo") { fattureCommessa.filter(f => f.tipo==="saldo"||f.tipo==="unica").forEach(f => stepDocs.push({ nome: `Fattura ${f.numero}/${f.anno}`, tipo: "fattura", data: f.data, detail: `‚Ç¨${fmt(f.importo)} ¬∑ ${f.pagata?"‚úÖ Pagata":"‚è≥"}` })); }
                  // Generic allegati
                  (c.allegati||[]).filter(a => a.tipo === step.id && !stepDocs.find(d => d.nome === a.nome)).forEach(a => stepDocs.push({ ...a, detail: a.data||"" }));
                  const isExpanded = ccExpandStep === step.id;

                  return (
                    <div key={step.id} style={{
                      padding: isCurrent ? "14px 14px 16px" : "10px 14px",
                      borderLeft: `4px solid ${borderColor}`,
                      borderBottom: idx < steps.length - 1 ? `1px solid ${T.bg}` : "none",
                      background: isExpanded ? "#34c75908" : isCurrent ? `${T.acc}06` : "transparent",
                      opacity: isFuture ? 0.4 : 1,
                      cursor: step.done ? "pointer" : "default",
                    }}
                    onClick={() => { if (step.done && stepDocs.length > 0) setCcExpandStep(isExpanded ? null : step.id); }}
                    >
                      {/* Step header */}
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{ fontSize: isCurrent ? 18 : 14 }}>{step.icon}</span>
                        <span style={{ fontSize: isCurrent ? 14 : 12, fontWeight: 700, color: T.text, flex: 1 }}>{step.label}</span>
                        {step.done && (
                            <span style={{ fontSize: 10, fontWeight: 700, color: "#34c759", background: "#34c75912", padding: "2px 8px", borderRadius: 6 }}>
                              ‚úÖ Fatto {stepDocs.length > 0 && <span style={{ fontSize: 8 }}>üìé{stepDocs.length}</span>}
                            </span>
                        )}
                        {isCurrent && <span style={{ fontSize: 10, fontWeight: 700, color: T.acc, background: `${T.acc}15`, padding: "2px 8px", borderRadius: 6 }}>üëâ DA FARE</span>}
                      </div>

                      {/* Done detail */}
                      {step.done && step.detail && (
                        <div style={{ fontSize: 10, color: T.sub, marginTop: 3, marginLeft: 26 }}>{step.detail}</div>
                      )}

                      {/* ‚ïê‚ïê‚ïê DOCUMENTI ESPANSI ‚ïê‚ïê‚ïê */}
                      {isExpanded && stepDocs.length > 0 && (
                        <div style={{ marginTop: 8, marginLeft: 26, background: T.card, borderRadius: 10, border: "1px solid #34c75930", overflow: "hidden" }}>
                          <div style={{ padding: "8px 12px", background: "#34c75910", borderBottom: "1px solid #34c75920" }}>
                            <div style={{ fontSize: 10, fontWeight: 800, color: "#34c759" }}>üìé DOCUMENTI ‚Äî {step.label.toUpperCase()}</div>
                          </div>
                          {stepDocs.map((doc, di) => (
                            <div key={di} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 12px", borderBottom: di < stepDocs.length-1 ? "1px solid " + T.bdr + "30" : "none" }}>
                              <div style={{ width: 32, height: 32, borderRadius: 8, background: "#34c75912", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, flexShrink: 0 }}>
                                {doc.tipo === "rilievo" ? "üìê" : doc.tipo === "preventivo" ? "üìù" : doc.tipo === "firma" ? "‚úçÔ∏è" : doc.tipo === "fattura" ? "üìÑ" : doc.tipo === "ordine" ? "üì¶" : doc.tipo === "conferma" ? "‚úÖ" : doc.tipo === "montaggio" ? "üîß" : "üìé"}
                              </div>
                              <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{doc.nome}</div>
                                <div style={{ fontSize: 10, color: T.sub }}>{doc.detail}{doc.data ? " ¬∑ " + doc.data : ""}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {/* ========== CURRENT STEP ACTIONS ========== */}
                      {isCurrent && step.id === "rilievo" && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Crea il primo rilievo con i vani da misurare</div>
                          <button onClick={() => setShowNuovoRilievo(true)} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                            üìê CREA RILIEVO ‚Üí
                          </button>
                        </div>
                      )}

                      {isCurrent && step.id === "misure" && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>
                            {!hasVani ? "Aggiungi i vani e inserisci le misure" :
                             vaniConMisure.length < vani.length ? `${vaniConMisure.length}/${vani.length} vani misurati ‚Äî completa le misure` :
                             vaniConPrezzo.length === 0 ? "Misure OK ‚Äî imposta il prezzo ‚Ç¨/mq nelle impostazioni o nella griglia" :
                             `${vaniConPrezzo.length} vani prezzati ¬∑ Totale: ‚Ç¨${fmt(totPreventivo)}`}
                          </div>
                          {hasRilievi && (
                            <button onClick={() => {
                              const ril = rilievi[rilievi.length - 1];
                              setSelectedRilievo(ril);
                              if (ril.vani?.length > 0) { setSelectedVano(ril.vani[0]); }
                            }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                              üìè {!hasVani ? "AGGIUNGI VANI ‚Üí" : vaniConMisure.length < vani.length ? "COMPLETA MISURE ‚Üí" : "APRI RILIEVO ‚Üí"}
                            </button>
                          )}
                        </div>
                      )}

                      {isCurrent && step.id === "firma" && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: T.acc, marginBottom: 8 }}>
                            Preventivo: ‚Ç¨{fmt(totPreventivo)} + IVA {ivaPerc}% = <b>‚Ç¨{fmt(totIva)}</b>
                          </div>
                          {/* Sub-step 1: Invia preventivo */}
                          {firmaStep === 0 && (
                            <div>
                              <div style={{ display: "flex", gap: 6, marginBottom: 8 }}>
                                <button onClick={() => generaPreventivoPDF(c)} style={{ flex: 1, padding: 10, borderRadius: 8, border: `1px solid ${T.acc}`, background: `${T.acc}08`, color: T.acc, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                                  üìÑ Scarica PDF
                                </button>
                                <button onClick={() => setShowPreventivoModal(true)} style={{ flex: 1, padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                                  üëÅ Anteprima
                                </button>
                              </div>
                              <button onClick={() => {
                                const tel = (c.telefono || "").replace(/\D/g, "");
                                window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(`Gentile ${c.cliente}, in allegato il preventivo per la commessa ${c.code}.\nTotale: ‚Ç¨${fmt(totIva)} IVA inclusa.\nPrego firmare e rinviare. Grazie!`)}`, "_blank");
                                setFirmaStep(1);
                              }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#25d366", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                üì§ INVIA PREVENTIVO AL CLIENTE ‚Üí
                              </button>
                              <div style={{ textAlign: "center", marginTop: 6 }}>
                                <span onClick={() => setFirmaStep(1)} style={{ fontSize: 11, color: T.sub, cursor: "pointer", textDecoration: "underline" }}>Gi√† inviato? Vai al caricamento firma</span>
                              </div>
                            </div>
                          )}
                          {/* Sub-step 2: Carica documento firmato */}
                          {firmaStep === 1 && (
                            <div>
                              <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>‚úÖ Preventivo inviato. Ora carica il documento firmato dal cliente.</div>
                              {!firmaFileUrl ? (
                                <div>
                                  <button onClick={() => {
                                    const inp = document.createElement("input");
                                    inp.type = "file"; inp.accept = "application/pdf,image/*,.jpg,.jpeg,.png";
                                    inp.onchange = (ev: any) => {
                                      const file = ev.target.files?.[0];
                                      if (!file) return;
                                      setFirmaFileName(file.name);
                                      const reader = new FileReader();
                                      reader.onload = (e) => setFirmaFileUrl(e.target?.result as string);
                                      reader.readAsDataURL(file);
                                    };
                                    inp.click();
                                  }} style={{ width: "100%", padding: 14, borderRadius: 10, border: `2px dashed ${T.acc}`, background: `${T.acc}08`, color: T.acc, fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                    üì• CARICA DOCUMENTO FIRMATO
                                  </button>
                                  <div style={{ fontSize: 10, color: T.sub, textAlign: "center", marginTop: 4 }}>PDF, foto o scansione del preventivo firmato</div>
                                </div>
                              ) : (
                                <div>
                                  <div style={{ padding: 10, borderRadius: 8, background: "#34c75912", border: "1px solid #34c75930", marginBottom: 8, display: "flex", alignItems: "center", gap: 8 }}>
                                    <span style={{ fontSize: 20 }}>üìé</span>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: 12, fontWeight: 700, color: "#34c759" }}>‚úÖ Documento caricato</div>
                                      <div style={{ fontSize: 11, color: T.sub }}>{firmaFileName}</div>
                                    </div>
                                    <span onClick={() => { setFirmaFileUrl(null); setFirmaFileName(""); }} style={{ fontSize: 18, cursor: "pointer", color: T.sub }}>‚úï</span>
                                  </div>
                                  <button onClick={() => {
                                    const allegato = { id: Date.now(), tipo: "firma", nome: firmaFileName, data: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), dataUrl: firmaFileUrl };
                                    setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0], firmaDocumento: allegato, allegati: [...(cm.allegati || []), allegato], log: [{ chi: "Fabio", cosa: "documento firmato caricato", quando: "Adesso", color: "#34c759" }, ...(cm.log || [])] } : cm));
                                    setSelectedCM(prev => ({ ...prev, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0] }));
                                    setFirmaStep(0); setFirmaFileUrl(null); setFirmaFileName("");
                                    setCcDone("‚úÖ Firma registrata con documento!"); setTimeout(() => setCcDone(null), 3000);
                                  }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                    ‚úÖ CONFERMA FIRMA ‚Üí
                                  </button>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {isCurrent && step.id === "fattura" && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 4 }}>Totale commessa: <b style={{ color: T.acc }}>‚Ç¨{fmt(totIva)}</b></div>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 10 }}>Scegli la modalit√† di fatturazione:</div>
                          {/* Percentage chips */}
                          <div style={{ display: "flex", gap: 6, marginBottom: 10, flexWrap: "wrap" as any }}>
                            {[30, 40, 50, 60, 100].map(p => (
                              <div key={p} onClick={() => setFattPerc(p)} style={{
                                padding: "10px 16px", borderRadius: 10, cursor: "pointer", fontSize: 13, fontWeight: 800,
                                background: fattPerc === p ? T.acc : T.card,
                                color: fattPerc === p ? "#fff" : T.text,
                                border: `2px solid ${fattPerc === p ? T.acc : T.bdr}`,
                                transition: "all 0.15s",
                              }}>
                                {p === 100 ? "Unica 100%" : `Acconto ${p}%`}
                              </div>
                            ))}
                          </div>
                          {/* Amount preview */}
                          <div style={{ background: T.bg, borderRadius: 10, padding: 12, marginBottom: 10 }}>
                            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                              <span style={{ fontSize: 12, color: T.sub }}>{fattPerc === 100 ? "Fattura unica" : `Acconto ${fattPerc}%`}</span>
                              <span style={{ fontSize: 16, fontWeight: 900, color: T.acc }}>‚Ç¨{fmt(Math.round(totIva * fattPerc / 100))}</span>
                            </div>
                            {fattPerc < 100 && (
                              <div style={{ display: "flex", justifyContent: "space-between" }}>
                                <span style={{ fontSize: 11, color: T.sub }}>Saldo restante ({100 - fattPerc}%)</span>
                                <span style={{ fontSize: 12, fontWeight: 700, color: T.sub }}>‚Ç¨{fmt(totIva - Math.round(totIva * fattPerc / 100))}</span>
                              </div>
                            )}
                          </div>
                          <button onClick={() => {
                            creaFattura(c, fattPerc === 100 ? "unica" : "acconto");
                            setCcDone(`‚úÖ Fattura ${fattPerc === 100 ? "unica" : "acconto " + fattPerc + "%"} creata! ‚Ç¨${fmt(Math.round(totIva * fattPerc / 100))}`);
                            setTimeout(() => setCcDone(null), 3000);
                          }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                            üí∞ CREA FATTURA ‚Ç¨{fmt(Math.round(totIva * fattPerc / 100))} ‚Üí
                          </button>
                        </div>
                      )}

                      {isCurrent && step.id === "ordine" && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 4 }}>
                            Fornitore: <b style={{ color: T.acc }}>{c.sistema?.split(" ")[0] || "‚Äî"}</b> ¬∑ Sistema: {c.sistema || "‚Äî"}
                          </div>
                          {/* Order lines preview */}
                          <div style={{ background: T.bg, borderRadius: 10, padding: 10, marginBottom: 10 }}>
                            <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>üìã RIGHE ORDINE ({vani.length} vani)</div>
                            {vani.map((v, vi) => {
                              const larg = v.larghezza || v.l || 0;
                              const alt = v.altezza || v.h || 0;
                              const mq = ((larg * alt) / 1000000).toFixed(2);
                              return (
                                <div key={vi} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: vi < vani.length - 1 ? `1px solid ${T.bdr}` : "none" }}>
                                  <div>
                                    <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{v.nome || v.tipo || `Vano ${vi + 1}`}</div>
                                    <div style={{ fontSize: 10, color: T.sub }}>{larg}√ó{alt}mm ¬∑ {mq}m¬≤ ¬∑ {v.apertura || "‚Äî"}</div>
                                  </div>
                                  <div style={{ fontSize: 12, fontWeight: 800, color: T.acc }}>‚Ç¨{fmt(calcolaVanoPrezzo(v, c))}</div>
                                </div>
                              );
                            })}
                            <div style={{ display: "flex", justifyContent: "space-between", marginTop: 8, paddingTop: 6, borderTop: `2px solid ${T.bdr}` }}>
                              <span style={{ fontSize: 13, fontWeight: 800, color: T.text }}>Totale ordine</span>
                              <span style={{ fontSize: 15, fontWeight: 900, color: T.acc }}>‚Ç¨{fmt(totPreventivo)}</span>
                            </div>
                          </div>
                          <div style={{ fontSize: 10, color: T.sub, marginBottom: 8, textAlign: "center" }}>Controlla le righe sopra. Se tutto OK, conferma l'ordine.</div>
                          <div style={{ display: "flex", gap: 8 }}>
                            <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                              ‚úèÔ∏è Modifica vani
                            </button>
                            <button onClick={() => {
                              const ord = creaOrdineFornitore(c, c.sistema?.split(" ")[0] || "");
                              if (ord) setSelectedCM(prev => ({ ...prev }));
                              setCcDone("‚úÖ Ordine fornitore creato!"); setTimeout(() => setCcDone(null), 3000);
                            }} style={{ flex: 2, padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                              üì¶ CONFERMA ORDINE ‚Üí
                            </button>
                          </div>
                        </div>
                      )}

                      {isCurrent && step.id === "conferma" && (() => {
                        const ord = ordiniCommessa[0];
                        const hasSett = ord?.consegna?.settimane && ord.consegna.settimane > 0;
                        const hasData = ord?.consegna?.prevista;
                        const infoComplete = hasSett || hasData;
                        return (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>
                            Ordine: {ord?.fornitore?.nome || "‚Äî"} ¬∑ ‚Ç¨{fmt(ord?.totaleIva || 0)}
                          </div>
                          {!ordineConfermato ? (
                            <div>
                              <button onClick={() => apriInboxDocumento()} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#af52de", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                üì• CARICA CONFERMA (PDF/Foto) ‚Üí
                              </button>
                              <div style={{ fontSize: 10, color: T.sub, marginTop: 4, textAlign: "center" }}>Da email, WhatsApp o portale fornitore</div>
                            </div>
                          ) : ccConfirm !== "conferma_ok" ? (
                            <div>
                              <div style={{ padding: 10, borderRadius: 8, background: infoComplete ? "#34c75912" : "#ff950012", marginBottom: 6, fontSize: 11, color: infoComplete ? "#34c759" : "#ff9500", fontWeight: 700 }}>
                                {infoComplete ? `‚úÖ Conferma ricevuta ‚Äî ${ord?.consegna?.settimane || "?"} settimane ¬∑ consegna ${hasData ? new Date(ord.consegna.prevista).toLocaleDateString("it-IT") : "da calcolare"}` : "‚ö†Ô∏è Conferma ricevuta ma MANCA la data di consegna"}
                              </div>
                              <button onClick={() => { setCcConfirm("conferma_ok"); setConfSett(ord?.consegna?.settimane?.toString() || ""); }} style={{ width: "100%", padding: 12, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                ‚úÖ APPROVA E CONFERMA ‚Üí
                              </button>
                            </div>
                          ) : (
                            <div style={{ background: "#34c75912", borderRadius: 10, padding: 12, border: "1px solid #34c75930" }}>
                              <div style={{ fontSize: 13, fontWeight: 800, color: "#34c759", marginBottom: 8 }}>‚úÖ Conferma approvazione</div>
                              <div style={{ fontSize: 12, color: T.text, marginBottom: 3 }}>Fornitore: <b>{ord?.fornitore?.nome || "‚Äî"}</b></div>
                              <div style={{ fontSize: 12, color: T.text, marginBottom: 8 }}>Importo: <b>‚Ç¨{fmt(ord?.totaleIva || 0)}</b></div>
                              
                              {/* Settimane / data consegna ‚Äî ALWAYS show, editable */}
                              <div style={{ background: !infoComplete ? "#ff950015" : T.bg, borderRadius: 10, padding: 10, marginBottom: 10, border: !infoComplete ? "2px solid #ff9500" : `1px solid ${T.bdr}` }}>
                                {!infoComplete && (
                                  <div style={{ fontSize: 11, fontWeight: 700, color: "#ff9500", marginBottom: 6 }}>
                                    ‚ö†Ô∏è Devi inserire i tempi di consegna prima di approvare
                                  </div>
                                )}
                                <div style={{ display: "flex", gap: 8, marginBottom: 6 }}>
                                  <div style={{ flex: 1 }}>
                                    <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3 }}>üìÖ SETTIMANE</div>
                                    <input type="number" min="1" max="52" placeholder="es. 6" value={confSett} onChange={e => setConfSett(e.target.value)} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${!confSett ? "#ff9500" : T.bdr}`, fontSize: 14, fontWeight: 800, fontFamily: "inherit", boxSizing: "border-box", textAlign: "center" }} />
                                  </div>
                                  <div style={{ flex: 2 }}>
                                    <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3 }}>üìÜ DATA PREVISTA</div>
                                    <div style={{ padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 13, fontWeight: 700, color: T.text, textAlign: "center" }}>
                                      {confSett ? (() => { const d = new Date(); d.setDate(d.getDate() + parseInt(confSett) * 7); return d.toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "long", year: "numeric" }); })() : "Inserisci settimane ‚Üí"}
                                    </div>
                                  </div>
                                </div>
                                {confSett && (
                                  <div style={{ fontSize: 11, color: "#34c759", fontWeight: 700, textAlign: "center" }}>
                                    ‚úÖ Materiale previsto per {(() => { const d = new Date(); d.setDate(d.getDate() + parseInt(confSett) * 7); return d.toLocaleDateString("it-IT"); })()}
                                  </div>
                                )}
                              </div>
                              
                              <div style={{ display: "flex", gap: 8 }}>
                                <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                                <button onClick={() => {
                                  if (!confSett || parseInt(confSett) < 1) { alert("Inserisci le settimane di consegna"); return; }
                                  const settNum = parseInt(confSett);
                                  const dataPrev = new Date(); dataPrev.setDate(dataPrev.getDate() + settNum * 7);
                                  setOrdiniFornDB(prev => prev.map(o => o.cmId === c.id ? { ...o, conferma: { ...o.conferma, firmata: true, dataFirma: new Date().toISOString().split("T")[0] }, consegna: { ...o.consegna, settimane: settNum, prevista: dataPrev.toISOString().split("T")[0] } } : o));
                                  setCcConfirm(null); setConfSett("");
                                  setCcDone(`‚úÖ Conferma approvata! Consegna prevista: ${dataPrev.toLocaleDateString("it-IT")}`);
                                  setTimeout(() => setCcDone(null), 3000);
                                }} style={{ flex: 2, padding: 12, borderRadius: 10, border: "none", background: confSett ? "#34c759" : "#ccc", color: "#fff", fontSize: 14, fontWeight: 800, cursor: confSett ? "pointer" : "not-allowed", fontFamily: "inherit" }}>‚úÖ APPROVO</button>
                              </div>
                            </div>
                          )}
                        </div>
                        );
                      })()}

                      {isCurrent && step.id === "montaggio" && (() => {
                        // Contesto: montaggi pianificati questa settimana e prossima
                        const oggi = new Date();
                        const giorniSettimana = Array.from({ length: 28 }, (_, i) => {
                          const d = new Date(oggi); d.setDate(d.getDate() + i);
                          return d.toISOString().split("T")[0];
                        });
                        const montaggiAll = montaggiDB;
                        const giorniOccupatiMap = new Map(); // date ‚Üí [{ cliente, giorni }]
                        montaggiAll.forEach(m => {
                          const gg = m.giorni || 1;
                          for (let d = 0; d < Math.ceil(gg); d++) {
                            const dt = new Date(m.data); dt.setDate(dt.getDate() + d);
                            const ds = dt.toISOString().split("T")[0];
                            if (!giorniOccupatiMap.has(ds)) giorniOccupatiMap.set(ds, []);
                            giorniOccupatiMap.get(ds).push({ cliente: m.cliente, gg, squadra: m.squadraId });
                          }
                        });
                        // Selected block
                        const selBlock = new Set<string>();
                        if (montFormData.data && montGiorni > 0) {
                          for (let d = 0; d < Math.ceil(montGiorni); d++) {
                            const dt = new Date(montFormData.data); dt.setDate(dt.getDate() + d);
                            selBlock.add(dt.toISOString().split("T")[0]);
                          }
                        }
                        const nomiGiorni = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
                        
                        return (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          {/* Context: this job info */}
                          <div style={{ background: T.bg, borderRadius: 10, padding: 10, marginBottom: 10 }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 4 }}>üîß {c.cliente} ‚Äî {c.indirizzo || "‚Äî"}</div>
                            <div style={{ fontSize: 11, color: T.sub }}>{vani.length} vani ¬∑ {c.sistema || "‚Äî"} ¬∑ {ordiniCommessa[0]?.consegna?.prevista ? `Materiale previsto: ${new Date(ordiniCommessa[0].consegna.prevista).toLocaleDateString("it-IT")}` : "Consegna da confermare"}</div>
                          </div>

                          {!montFormOpen ? (
                            <button onClick={() => { setMontFormOpen(true); setMontGiorni(1); setMontFormData({ data: "", orario: "08:00", durata: "giornata", squadraId: squadreDB[0]?.id || "", note: "" }); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                              üîß PIANIFICA MONTAGGIO ‚Üí
                            </button>
                          ) : (
                            <div style={{ background: T.bg, borderRadius: 10, padding: 12, border: `1px solid ${T.bdr}` }}>
                              {/* Mini calendar 2 weeks */}
                              <div style={{ marginBottom: 10 }}>
                                <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>üìÖ SCEGLI DATA (prossime 4 settimane)</div>
                                <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 3 }}>
                                  {giorniSettimana.map(g => {
                                    const dt = new Date(g);
                                    const isSel = selBlock.has(g);
                                    const isStart = montFormData.data === g;
                                    const isBusy = giorniOccupatiMap.has(g);
                                    const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;
                                    const busyMont = giorniOccupatiMap.get(g) || [];
                                    return (
                                      <div key={g} onClick={() => !isWeekend && setMontFormData(p => ({ ...p, data: g }))} title={busyMont.map(m => m.cliente + " (" + m.gg + "g)").join(", ")} style={{
                                        padding: "6px 2px", borderRadius: 8, textAlign: "center", cursor: isWeekend ? "not-allowed" : "pointer",
                                        background: isStart ? T.acc : isSel ? `${T.acc}30` : isBusy ? "#ff950020" : T.card,
                                        color: isStart ? "#fff" : isSel ? T.acc : isWeekend ? T.bdr : isBusy ? "#ff9500" : T.text,
                                        border: `2px solid ${isStart ? T.acc : isSel ? `${T.acc}60` : "transparent"}`,
                                        opacity: isWeekend ? 0.4 : 1,
                                      }}>
                                        <div style={{ fontSize: 8, fontWeight: 700 }}>{nomiGiorni[dt.getDay()]}</div>
                                        <div style={{ fontSize: 14, fontWeight: 800 }}>{dt.getDate()}</div>
                                        {isBusy && !isSel && <div style={{ width: 4, height: 4, borderRadius: "50%", background: "#ff9500", margin: "2px auto 0" }} />}
                                      </div>
                                    );
                                  })}
                                </div>
                                {/* Legend */}
                                {montaggiAll.length > 0 && (
                                  <div style={{ marginTop: 6 }}>
                                    <div style={{ fontSize: 10, color: T.sub, marginBottom: 4 }}>üü† Montaggi pianificati:</div>
                                    {montaggiAll.filter(m => m.data >= oggi.toISOString().split("T")[0]).slice(0, 6).map((m, mi) => {
                                      const d = new Date(m.data);
                                      const sq = squadreDB.find(s => s.id === m.squadraId);
                                      return (
                                        <div key={mi} style={{ fontSize: 10, color: m.stato === "completato" ? "#34c759" : "#ff9500", padding: "2px 0", display: "flex", gap: 4 }}>
                                          <span style={{ fontWeight: 800, minWidth: 44 }}>{d.getDate()}/{d.getMonth() + 1}</span>
                                          <span style={{ flex: 1 }}>{m.cliente} ¬∑ {m.giorni || 1}g ¬∑ {sq?.nome || "‚Äî"}</span>
                                          {m.stato === "completato" && <span>‚úÖ</span>}
                                        </div>
                                      );
                                    })}
                                  </div>
                                )}
                              </div>

                              {/* Ora + Durata */}
                              <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3 }}>‚è∞ ORARIO</div>
                                  <select value={montFormData.orario} onChange={e => setMontFormData(p => ({ ...p, orario: e.target.value }))} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, fontSize: 13, fontFamily: "inherit" }}>
                                    {["06:00","06:30","07:00","07:30","08:00","08:30","09:00","09:30","10:00","14:00","15:00"].map(h => <option key={h} value={h}>{h}</option>)}
                                  </select>
                                </div>
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3 }}>‚è± GIORNI</div>
                                  <div style={{ display: "flex", alignItems: "center", gap: 0 }}>
                                    <button onClick={() => setMontGiorni(Math.max(0.5, montGiorni - 0.5))} style={{ width: 36, height: 40, borderRadius: "8px 0 0 8px", border: `1px solid ${T.bdr}`, background: T.card, fontSize: 18, cursor: "pointer", fontFamily: "inherit" }}>‚àí</button>
                                    <div style={{ flex: 1, height: 40, display: "flex", alignItems: "center", justifyContent: "center", borderTop: `1px solid ${T.bdr}`, borderBottom: `1px solid ${T.bdr}`, fontSize: 15, fontWeight: 800, background: "#fff" }}>
                                      {montGiorni === 0.5 ? "¬Ω" : montGiorni}
                                    </div>
                                    <button onClick={() => setMontGiorni(montGiorni + 0.5)} style={{ width: 36, height: 40, borderRadius: "0 8px 8px 0", border: `1px solid ${T.bdr}`, background: T.card, fontSize: 18, cursor: "pointer", fontFamily: "inherit" }}>+</button>
                                  </div>
                                </div>
                              </div>

                              {/* Squadra */}
                              <div style={{ marginBottom: 8 }}>
                                <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3 }}>üë∑ SQUADRA</div>
                                {squadreDB.length > 0 ? (
                                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" as any }}>
                                    {squadreDB.map(sq => (
                                      <div key={sq.id} onClick={() => setMontFormData(p => ({ ...p, squadraId: sq.id }))} style={{
                                        padding: "8px 14px", borderRadius: 8, cursor: "pointer", fontSize: 12, fontWeight: 700,
                                        background: montFormData.squadraId === sq.id ? T.acc : T.card,
                                        color: montFormData.squadraId === sq.id ? "#fff" : T.text,
                                        border: `1px solid ${montFormData.squadraId === sq.id ? T.acc : T.bdr}`,
                                      }}>{sq.nome || sq.id}</div>
                                    ))}
                                  </div>
                                ) : (
                                  <input placeholder="Nome squadra" value={montFormData.note} onChange={e => setMontFormData(p => ({ ...p, note: e.target.value }))} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, fontSize: 13, fontFamily: "inherit", boxSizing: "border-box" }} />
                                )}
                              </div>

                              {/* Note */}
                              <div style={{ marginBottom: 10 }}>
                                <input placeholder="Note (opzionale)" value={montFormData.note} onChange={e => setMontFormData(p => ({ ...p, note: e.target.value }))} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, fontSize: 12, fontFamily: "inherit", boxSizing: "border-box" }} />
                              </div>

                              {/* === CONTESTO SQUADRE ‚Äî cosa fanno le squadre === */}
                              <div style={{ marginBottom: 10, background: T.card, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
                                <div style={{ fontSize: 9, fontWeight: 800, color: T.sub, textTransform: "uppercase", marginBottom: 6, letterSpacing: "0.5px" }}>üìã Impegni squadre ‚Äî prossime 4 settimane</div>
                                {squadreDB.map(sq => {
                                  const sqMont = montaggiAll.filter(m => m.squadraId === sq.id && m.data >= oggi.toISOString().split("T")[0] && m.stato !== "completato").sort((a,b) => a.data.localeCompare(b.data));
                                  const isSel = montFormData.squadraId === sq.id;
                                  return (
                                    <div key={sq.id} style={{ marginBottom: 6, padding: "6px 8px", borderRadius: 8, background: isSel ? T.acc + "08" : "transparent", border: isSel ? `1px solid ${T.acc}30` : `1px solid transparent` }}>
                                      <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: sqMont.length > 0 ? 4 : 0 }}>
                                        <div style={{ width: 8, height: 8, borderRadius: "50%", background: sq.colore || T.acc, flexShrink: 0 }} />
                                        <div style={{ fontSize: 11, fontWeight: 700, color: isSel ? T.acc : T.text, flex: 1 }}>{sq.nome}</div>
                                        <div style={{ fontSize: 9, color: T.sub, fontWeight: 600 }}>{sqMont.length === 0 ? "‚úÖ Libera" : `${sqMont.length} lavori`}</div>
                                      </div>
                                      {sqMont.map((m, mi) => {
                                        const d = new Date(m.data);
                                        const conflitto = montFormData.data && (() => {
                                          for (let i = 0; i < Math.ceil(montGiorni); i++) {
                                            const selD = new Date(montFormData.data); selD.setDate(selD.getDate() + i);
                                            for (let j = 0; j < Math.ceil(m.giorni || 1); j++) {
                                              const mD = new Date(m.data); mD.setDate(mD.getDate() + j);
                                              if (selD.toISOString().split("T")[0] === mD.toISOString().split("T")[0]) return true;
                                            }
                                          }
                                          return false;
                                        })();
                                        return (
                                          <div key={mi} style={{ display: "flex", gap: 6, alignItems: "center", padding: "2px 0 2px 14px", fontSize: 10 }}>
                                            <span style={{ fontWeight: 700, color: conflitto && isSel ? "#ff3b30" : T.sub, minWidth: 38 }}>
                                              {d.toLocaleDateString("it-IT", { day: "2-digit", month: "short" })}
                                            </span>
                                            <span style={{ color: conflitto && isSel ? "#ff3b30" : T.text, flex: 1 }}>
                                              {m.cliente} ¬∑ {m.giorni||1}g ¬∑ {m.vani||"?"}v
                                            </span>
                                            {conflitto && isSel && <span style={{ fontSize: 8, fontWeight: 800, color: "#ff3b30", background: "#ff3b3015", padding: "1px 5px", borderRadius: 4 }}>‚ö†Ô∏è CONFLITTO</span>}
                                          </div>
                                        );
                                      })}
                                    </div>
                                  );
                                })}
                              </div>

                              {/* Summary */}
                              {montFormData.data && (
                                <div style={{ background: T.card, borderRadius: 8, padding: 8, marginBottom: 8, fontSize: 12, color: T.text }}>
                                  üìÖ <b>{new Date(montFormData.data).toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })}</b> ore {montFormData.orario} ¬∑ {montGiorni === 0.5 ? "mezza giornata" : montGiorni + (montGiorni === 1 ? " giorno" : " giorni")} ¬∑ {squadreDB.find(s => s.id === montFormData.squadraId)?.nome || "‚Äî"}
                                </div>
                              )}

                              <div style={{ display: "flex", gap: 8 }}>
                                <button onClick={() => setMontFormOpen(false)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                                <button onClick={() => {
                                  if (!montFormData.data) { alert("Scegli una data dal calendario"); return; }
                                  const durataStr = montGiorni === 0.5 ? "mezza" : montGiorni === 1 ? "giornata" : montGiorni + "giorni";
                                  const nuovoM = {
                                    id: "m_" + Date.now(), cmId: c.id, cmCode: c.code, cliente: c.cliente,
                                    indirizzo: c.indirizzo || "", vani: vani.length,
                                    data: montFormData.data, orario: montFormData.orario, durata: durataStr, giorni: montGiorni,
                                    squadraId: montFormData.squadraId, stato: "programmato", note: montFormData.note,
                                  };
                                  setMontaggiDB(prev => [...prev, nuovoM]);
                                  setMontFormOpen(false);
                                  const evMont = {
                                    id: "ev_mont_" + Date.now(), date: montFormData.data, time: montFormData.orario,
                                    text: `üîß Montaggio ${c.cliente} (${montGiorni === 0.5 ? "¬Ωg" : montGiorni + "g"})`, tipo: "montaggio", persona: c.cliente,
                                    cm: c.code, addr: c.indirizzo || "", done: false,
                                  };
                                  setEvents(prev => [...prev, evMont]);
                                  setCcDone(`‚úÖ Montaggio pianificato per il ${new Date(montFormData.data).toLocaleDateString("it-IT")}`);
                                  setTimeout(() => setCcDone(null), 3000);
                                }} style={{ flex: 2, padding: 12, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                  ‚úÖ CONFERMA MONTAGGIO
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                        );
                      })()}

                      {isCurrent && step.id === "saldo" && (() => {
                        const saldoFat = fattureCommessa.find(f => f.tipo === "saldo");
                        const unicaFat = fattureCommessa.find(f => f.tipo === "unica");
                        const fatNonPagata = fattureCommessa.find(f => !f.pagata);
                        const restoSaldo = totIva - incassato;
                        const hasFatSaldo = !!saldoFat || !!unicaFat;
                        const isPagata = saldoFat?.pagata || unicaFat?.pagata;
                        
                        return (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          {/* Context box */}
                          <div style={{ background: T.bg, borderRadius: 10, padding: 10, marginBottom: 10 }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 4 }}>üí∂ Riepilogo pagamenti</div>
                            <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "2px 0" }}>
                              <span style={{ color: T.sub }}>Totale commessa</span>
                              <b>‚Ç¨{fmt(totIva)}</b>
                            </div>
                            {incassato > 0 && (
                              <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "2px 0" }}>
                                <span style={{ color: "#34c759" }}>‚úÖ Gi√† incassato</span>
                                <b style={{ color: "#34c759" }}>‚Ç¨{fmt(incassato)}</b>
                              </div>
                            )}
                            <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, fontWeight: 900, padding: "4px 0", borderTop: `1px solid ${T.bdr}`, marginTop: 4 }}>
                              <span style={{ color: restoSaldo > 0 ? "#ff9500" : "#34c759" }}>{restoSaldo > 0 ? "‚è≥ Resta da incassare" : "‚úÖ Tutto incassato"}</span>
                              <b style={{ color: restoSaldo > 0 ? "#ff9500" : "#34c759" }}>‚Ç¨{fmt(restoSaldo)}</b>
                            </div>
                            {fattureCommessa.length > 0 && (
                              <div style={{ marginTop: 6, fontSize: 10, color: T.sub }}>
                                {fattureCommessa.map(f => `Fat.${f.numero} ${f.tipo} ‚Ç¨${fmt(f.importo)} ${f.pagata ? "‚úÖ" : "‚è≥"}`).join(" ¬∑ ")}
                              </div>
                            )}
                          </div>

                          {/* PHASE 1: No saldo fattura yet ‚Üí Create it */}
                          {!hasFatSaldo && restoSaldo > 0 && (
                            ccConfirm !== "saldo" ? (
                              <button onClick={() => setCcConfirm("saldo")} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                üí∂ CREA FATTURA SALDO ‚Ç¨{fmt(restoSaldo)} ‚Üí
                              </button>
                            ) : (
                              <div style={{ background: T.acc + "10", borderRadius: 10, padding: 12, border: `1px solid ${T.acc}30` }}>
                                <div style={{ fontSize: 13, fontWeight: 800, color: T.acc, marginBottom: 6 }}>üí∂ Conferma fattura saldo</div>
                                <div style={{ fontSize: 20, fontWeight: 900, color: T.acc, marginBottom: 3, textAlign: "center" }}>‚Ç¨{fmt(restoSaldo)}</div>
                                <div style={{ fontSize: 11, color: T.sub, marginBottom: 10, textAlign: "center" }}>{c.cliente} {c.cognome || ""} ¬∑ {c.code}</div>
                                <div style={{ display: "flex", gap: 8 }}>
                                  <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                                  <button onClick={() => {
                                    creaFattura(c, restoSaldo === totIva ? "unica" : "saldo");
                                    setCcConfirm(null); setCcDone("‚úÖ Fattura saldo creata! ‚Ç¨" + fmt(restoSaldo));
                                    setTimeout(() => setCcDone(null), 3000);
                                  }} style={{ flex: 2, padding: 12, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CREA FATTURA SALDO</button>
                                </div>
                              </div>
                            )
                          )}

                          {/* PHASE 2: Saldo created but not paid ‚Üí Mark as paid */}
                          {hasFatSaldo && !isPagata && (
                            ccConfirm !== "pagata" ? (
                              <div>
                                <div style={{ padding: 10, borderRadius: 8, background: "#ff950012", marginBottom: 8, fontSize: 12, color: "#ff9500", fontWeight: 700 }}>
                                  ‚è≥ Fattura saldo emessa ‚Äî in attesa di pagamento
                                </div>
                                <button onClick={() => setCcConfirm("pagata")} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                  ‚úÖ IL CLIENTE HA PAGATO ‚Äî SEGNA COME INCASSATA ‚Üí
                                </button>
                                <div style={{ fontSize: 10, color: T.sub, marginTop: 4, textAlign: "center" }}>Oppure carica la ricevuta dal üì• inbox</div>
                              </div>
                            ) : (
                              <div style={{ background: "#34c75912", borderRadius: 10, padding: 12, border: "1px solid #34c75930" }}>
                                <div style={{ fontSize: 13, fontWeight: 800, color: "#34c759", marginBottom: 6 }}>‚úÖ Conferma pagamento ricevuto</div>
                                <div style={{ fontSize: 20, fontWeight: 900, color: "#34c759", marginBottom: 3, textAlign: "center" }}>‚Ç¨{fmt(restoSaldo)}</div>
                                <div style={{ fontSize: 11, color: T.sub, marginBottom: 6, textAlign: "center" }}>Metodo di pagamento:</div>
                                <div style={{ display: "flex", gap: 6, justifyContent: "center", marginBottom: 10, flexWrap: "wrap" as any }}>
                                  {["Bonifico", "Assegno", "Contanti", "Carta"].map(m => (
                                    <span key={m} onClick={() => setCcConfirm("pagata_" + m)} style={{
                                      padding: "8px 14px", borderRadius: 8, fontSize: 12, fontWeight: 700, cursor: "pointer",
                                      background: ccConfirm === "pagata_" + m ? "#34c759" : T.card,
                                      color: ccConfirm === "pagata_" + m ? "#fff" : T.text,
                                      border: `1px solid ${ccConfirm === "pagata_" + m ? "#34c759" : T.bdr}`,
                                    }}>{m}</span>
                                  ))}
                                </div>
                                <div style={{ display: "flex", gap: 8 }}>
                                  <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                                  <button onClick={() => {
                                    const metodo = (ccConfirm || "").replace("pagata_", "") || "Bonifico";
                                    const fat = fattureCommessa.find(f => (f.tipo === "saldo" || f.tipo === "unica") && !f.pagata);
                                    if (fat) {
                                      setFattureDB(prev => prev.map(f => f.id === fat.id ? { ...f, pagata: true, dataPagamento: new Date().toISOString().split("T")[0], metodoPagamento: metodo } : f));
                                    }
                                    // Also mark any other unpaid fatture
                                    setFattureDB(prev => prev.map(f => f.cmId === c.id && !f.pagata ? { ...f, pagata: true, dataPagamento: new Date().toISOString().split("T")[0], metodoPagamento: metodo } : f));
                                    setFaseTo(c.id, "chiusura");
                                    setCcConfirm(null); setCcDone("üéâ Pagamento registrato! Commessa completata.");
                                    setTimeout(() => setCcDone(null), 3000);
                                  }} style={{ flex: 2, padding: 12, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CONFERMO INCASSO</button>
                                </div>
                              </div>
                            )
                          )}

                          {/* PHASE 3: Everything paid but fatture missing ‚Üí allow closing directly */}
                          {!hasFatSaldo && restoSaldo <= 0 && (
                            <div>
                              <div style={{ padding: 10, borderRadius: 8, background: "#34c75912", marginBottom: 8, fontSize: 12, color: "#34c759", fontWeight: 700 }}>
                                ‚úÖ Tutto incassato ‚Äî ‚Ç¨{fmt(incassato)}
                              </div>
                              <button onClick={() => {
                                setFaseTo(c.id, "chiusura");
                                setCcDone("üéâ Commessa chiusa!");
                                setTimeout(() => setCcDone(null), 3000);
                              }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                                üéâ CHIUDI COMMESSA ‚Üí
                              </button>
                            </div>
                          )}
                        </div>
                        );
                      })()}

                      {/* Completed: all done ‚Äî DOSSIER COMMESSA */}
                      {!current && idx === steps.length - 1 && tuttoChiuso && (
                        <div style={{ marginTop: 10, marginLeft: 26 }}>
                          <div style={{ textAlign: "center", marginBottom: 12 }}>
                            <div style={{ fontSize: 20, fontWeight: 900, color: "#34c759" }}>üéâ Commessa Completata!</div>
                            <div style={{ fontSize: 12, color: T.sub, marginTop: 2 }}>Incassato ‚Ç¨{fmt(incassato)} ¬∑ Margine ‚Ç¨{fmt(incassato - ordiniCommessa.reduce((s, o) => s + (o.totaleIva || 0), 0))}</div>
                          </div>
                          {/* DOSSIER */}
                          <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 14 }}>
                            <div style={{ fontSize: 12, fontWeight: 800, color: T.text, marginBottom: 10 }}>üìÅ Dossier Commessa</div>
                            {[
                              { ico: "üìê", l: "Rilievo", v: `${rilievi.length} rilievo ¬∑ ${vani.length} vani`, d: rilievi[0]?.data || "" },
                              { ico: "üìè", l: "Misure", v: `${vaniConMisure.length}/${vani.length} vani completi`, d: "" },
                              { ico: "üìã", l: "Preventivo", v: `‚Ç¨${fmt(totPreventivo)} + IVA = ‚Ç¨${fmt(totIva)}`, d: "" },
                              { ico: "‚úçÔ∏è", l: "Firma cliente", v: c.dataFirma || "‚Äî", d: "" },
                              ...fattureCommessa.map(f => ({ ico: f.pagata ? "‚úÖ" : "‚è≥", l: `Fattura ${f.tipo} #${f.numero}`, v: `‚Ç¨${fmt(f.importo)} ${f.pagata ? "pagata" : "in attesa"}`, d: f.data || "" })),
                              ...ordiniCommessa.map(o => ({ ico: "üì¶", l: `Ordine ${o.fornitore?.nome || ""}`, v: `‚Ç¨${fmt(o.totaleIva || 0)} ¬∑ ${o.stato || ""}`, d: "" })),
                              ...(ordiniCommessa[0]?.conferma?.ricevuta ? [{ ico: "üìÑ", l: "Conferma fornitore", v: `Ricevuta ¬∑ ${ordiniCommessa[0]?.consegna?.settimane || "?"} sett.`, d: "" }] : []),
                              ...montaggiCommessa.map(m => ({ ico: "üîß", l: "Montaggio", v: `${m.data ? new Date(m.data).toLocaleDateString("it-IT") : "‚Äî"} ¬∑ ${squadreDB.find(s => s.id === m.squadraId)?.nome || ""}`, d: "" })),
                              ...(c.praticaFiscale ? [{ ico: "üèõÔ∏è", l: "Pratica fiscale", v: c.praticaFiscale === "iva10" ? "IVA agevolata 10%" : c.praticaFiscale === "detrazione50" ? "Detrazione 50%" : c.praticaFiscale === "ecobonus65" ? "Ecobonus 65%" : c.praticaFiscale, d: "" }] : []),
                            ].map((row, ri) => (
                              <div key={ri} style={{ display: "flex", alignItems: "center", gap: 8, padding: "7px 0", borderBottom: `1px solid ${T.bdr}20` }}>
                                <span style={{ fontSize: 14, width: 22, textAlign: "center" }}>{row.ico}</span>
                                <span style={{ fontSize: 11, fontWeight: 700, color: T.text, flex: 1 }}>{row.l}</span>
                                <span style={{ fontSize: 11, color: T.sub, textAlign: "right" }}>{row.v}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              {/* üí∞ RIEPILOGO ECONOMICO ‚Äî sempre visibile */}
              {totPreventivo > 0 && (
                <div style={{ marginTop: 8, background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 14 }}>
                  <div style={{ fontSize: 11, fontWeight: 800, color: T.sub, textTransform: "uppercase", marginBottom: 8 }}>üí∞ Riepilogo Economico</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "6px 12px" }}>
                    <div style={{ fontSize: 11, color: T.sub }}>Preventivo</div>
                    <div style={{ fontSize: 12, fontWeight: 700, textAlign: "right" }}>‚Ç¨{fmt(totPreventivo)}</div>
                    <div style={{ fontSize: 11, color: T.sub }}>IVA {ivaPerc}%</div>
                    <div style={{ fontSize: 12, fontWeight: 700, textAlign: "right" }}>‚Ç¨{fmt(totPreventivo * ivaPerc / 100)}</div>
                    <div style={{ fontSize: 12, fontWeight: 800, color: T.text, borderTop: `1px solid ${T.bdr}`, paddingTop: 4 }}>TOTALE</div>
                    <div style={{ fontSize: 14, fontWeight: 900, color: T.acc, textAlign: "right", borderTop: `1px solid ${T.bdr}`, paddingTop: 4 }}>‚Ç¨{fmt(totIva)}</div>
                    {incassato > 0 && <>
                      <div style={{ fontSize: 11, color: "#34c759" }}>‚úÖ Incassato</div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: "#34c759", textAlign: "right" }}>‚Ç¨{fmt(incassato)}</div>
                    </>}
                    {incassato > 0 && incassato < totIva && <>
                      <div style={{ fontSize: 11, color: T.orange }}>‚è≥ Resta</div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: T.orange, textAlign: "right" }}>‚Ç¨{fmt(totIva - incassato)}</div>
                    </>}
                    {hasOrdine && <>
                      <div style={{ fontSize: 11, color: T.sub, borderTop: `1px solid ${T.bdr}`, paddingTop: 4 }}>üì¶ Costo fornitore</div>
                      <div style={{ fontSize: 12, fontWeight: 700, textAlign: "right", borderTop: `1px solid ${T.bdr}`, paddingTop: 4 }}>‚Ç¨{fmt(ordiniCommessa.reduce((s, o) => s + (o.totaleIva || 0), 0))}</div>
                      <div style={{ fontSize: 11, color: "#34c759" }}>üìä Margine</div>
                      <div style={{ fontSize: 12, fontWeight: 800, color: "#34c759", textAlign: "right" }}>‚Ç¨{fmt(totIva - ordiniCommessa.reduce((s, o) => s + (o.totaleIva || 0), 0))} ({Math.round((1 - ordiniCommessa.reduce((s, o) => s + (o.totaleIva || 0), 0) / (totIva || 1)) * 100)}%)</div>
                    </>}
                  </div>
                </div>
              )}
            </div>
          );
        })()}


        {/* üèõÔ∏è PRATICA FISCALE */}
        {(() => {
          const c = selectedCM;
          if (!c) return null;
          const vaniPF = getVaniAttivi(c);
          const totPF = vaniPF.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0) + (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
          const ivaPF = c.ivaPerc || 10;
          const totIvaPF = totPF * (1 + ivaPF / 100);
          const fmtPF = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";
          return (
            <div style={{ margin: "8px 16px 0", background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 14 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                <div style={{ fontSize: 11, fontWeight: 800, color: T.sub, textTransform: "uppercase" }}>üèõÔ∏è Pratica Fiscale</div>
                {c.praticaFiscale && <span style={{ fontSize: 10, fontWeight: 700, color: "#34c759", background: "#34c75912", padding: "2px 8px", borderRadius: 6 }}>‚úÖ Attiva</span>}
              </div>
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap" as any, marginBottom: c.praticaFiscale ? 8 : 0 }}>
                {[
                  { id: "", l: "Nessuna", color: T.sub },
                  { id: "iva10", l: "IVA 10%", color: "#ff9500" },
                  { id: "detrazione50", l: "Detraz. 50%", color: "#007aff" },
                  { id: "ecobonus65", l: "Ecobonus 65%", color: "#34c759" },
                  { id: "superbonus", l: "Superbonus", color: "#af52de" },
                ].map(opt => (
                  <div key={opt.id} onClick={() => {
                    const newIva = opt.id ? 10 : 22;
                    setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, praticaFiscale: opt.id || undefined, ivaPerc: newIva } : cm));
                    setSelectedCM(prev => ({ ...prev, praticaFiscale: opt.id || undefined, ivaPerc: newIva }));
                  }} style={{
                    padding: "6px 10px", borderRadius: 8, fontSize: 10, fontWeight: 700, cursor: "pointer",
                    background: (c.praticaFiscale || "") === opt.id ? opt.color + "18" : T.bg,
                    color: (c.praticaFiscale || "") === opt.id ? opt.color : T.sub,
                    border: `1.5px solid ${(c.praticaFiscale || "") === opt.id ? opt.color : T.bdr}`,
                  }}>{opt.l}</div>
                ))}
              </div>
              {c.praticaFiscale && (
                <div>
                  <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>Documenti necessari:</div>
                  {[
                    ...(c.praticaFiscale === "iva10" ? [
                      { l: "Dichiarazione IVA agevolata 10%", desc: "Autocertificazione cliente per ristrutturazione", key: "dich_iva10" },
                      { l: "Titolo abilitativo (CILA/SCIA)", desc: "Numero protocollo e data", key: "titolo_abit" },
                    ] : []),
                    ...(c.praticaFiscale === "detrazione50" ? [
                      { l: "Dichiarazione IVA agevolata 10%", desc: "Autocertificazione", key: "dich_iva10" },
                      { l: "Titolo abilitativo (CILA/SCIA)", desc: "Protocollo e data", key: "titolo_abit" },
                      { l: "Dati Bonifico Parlante", desc: "CF beneficiario, P.IVA ditta, causale", key: "bonifico" },
                      { l: "Comunicazione ENEA", desc: "Entro 90gg da fine lavori", key: "enea" },
                    ] : []),
                    ...(c.praticaFiscale === "ecobonus65" ? [
                      { l: "Dichiarazione IVA agevolata 10%", desc: "Autocertificazione", key: "dich_iva10" },
                      { l: "Titolo abilitativo (CILA/SCIA)", desc: "Protocollo e data", key: "titolo_abit" },
                      { l: "Dati Bonifico Parlante", desc: "CF, P.IVA, causale", key: "bonifico" },
                      { l: "Comunicazione ENEA (obbligatoria)", desc: "Entro 90gg", key: "enea" },
                      { l: "Asseverazione tecnico", desc: "Prestazione energetica", key: "asseverazione" },
                      { l: "APE ante e post intervento", desc: "Attestato energetico", key: "ape" },
                    ] : []),
                    ...(c.praticaFiscale === "superbonus" ? [
                      { l: "Dichiarazione IVA agevolata", key: "dich_iva10", desc: "Autocertificazione" },
                      { l: "CILAS (Superbonus)", key: "titolo_abit", desc: "Titolo specifico" },
                      { l: "Bonifico Parlante", key: "bonifico", desc: "CF, P.IVA, causale" },
                      { l: "ENEA", key: "enea", desc: "Obbligatoria" },
                      { l: "Asseverazione tecnico", key: "asseverazione", desc: "Congruit√† spese" },
                      { l: "Visto di conformit√†", key: "visto", desc: "Commercialista/CAF" },
                      { l: "APE ante e post", key: "ape", desc: "Salto 2 classi" },
                    ] : []),
                  ].map((doc, di) => {
                    const done = (c.docFiscali || []).includes(doc.key);
                    return (
                      <div key={di} onClick={() => {
                        const docs = c.docFiscali || [];
                        const newDocs = done ? docs.filter(d => d !== doc.key) : [...docs, doc.key];
                        setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, docFiscali: newDocs } : cm));
                        setSelectedCM(prev => ({ ...prev, docFiscali: newDocs }));
                      }} style={{ display: "flex", alignItems: "center", gap: 8, padding: "7px 0", borderBottom: `1px solid ${T.bdr}15`, cursor: "pointer" }}>
                        <div style={{ width: 20, height: 20, borderRadius: 5, border: `1.5px solid ${done ? "#34c759" : T.bdr}`, background: done ? "#34c75918" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 9, color: "#34c759", fontWeight: 800, flexShrink: 0 }}>
                          {done && "‚úì"}
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 11, fontWeight: 600, color: done ? "#34c759" : T.text }}>{doc.l}</div>
                          <div style={{ fontSize: 9, color: T.sub }}>{doc.desc}</div>
                        </div>
                      </div>
                    );
                  })}
                  {/* ‚ïê‚ïê‚ïê DOCUMENTI IDENTIT√Ä ‚ïê‚ïê‚ïê */}
                  <div style={{ marginTop: 12, paddingTop: 10, borderTop: "1px solid " + T.bdr }}>
                    <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>ü™™ Documenti di riconoscimento:</div>
                    {(c.docIdentita || []).map((doc, i) => (
                      <div key={doc.id || i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: "1px solid " + T.bdr + "15" }}>
                        <div style={{ width: 28, height: 28, borderRadius: 8, background: "#5856d618", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14 }}>
                          {doc.tipo === "CI" ? "ü™™" : "üí≥"}
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 11, fontWeight: 700, color: T.text }}>{doc.tipo === "CI" ? "Carta d'Identit√†" : "Codice Fiscale"}</div>
                          <div style={{ fontSize: 9, color: T.sub }}>{doc.nome} ¬∑ {doc.data || ""}</div>
                        </div>
                        <div onClick={() => {
                          const newDI = (c.docIdentita || []).filter((_, idx) => idx !== i);
                          setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, docIdentita: newDI } : cm));
                          setSelectedCM(prev => ({ ...prev, docIdentita: newDI }));
                        }} style={{ cursor: "pointer", fontSize: 10, color: "#ff3b30" }}>‚úï</div>
                      </div>
                    ))}
                    <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
                      {[
                        { tipo: "CI", l: "üì∑ Scansiona CI", col: "#5856d6" },
                        { tipo: "CF", l: "üì∑ Scansiona CF", col: "#007aff" },
                      ].map(btn => (
                        <label key={btn.tipo} style={{ flex: 1, padding: "8px 6px", borderRadius: 8, border: "1.5px dashed " + btn.col + "60", background: btn.col + "08", textAlign: "center", fontSize: 10, fontWeight: 700, color: btn.col, cursor: "pointer" }}>
                          {btn.l}
                          <input type="file" accept="image/*" capture="environment" style={{ display: "none" }} onChange={e => {
                            const file = e.target.files?.[0]; if (!file) return;
                            const reader = new FileReader();
                            reader.onload = () => {
                              const newDoc = { id: "di_" + Date.now(), tipo: btn.tipo, nome: file.name, data: new Date().toLocaleDateString("it-IT"), dataUrl: reader.result };
                              const newDI = [...(c.docIdentita || []), newDoc];
                              setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, docIdentita: newDI } : cm));
                              setSelectedCM(prev => ({ ...prev, docIdentita: newDI }));
                            };
                            reader.readAsDataURL(file);
                            e.target.value = "";
                          }} />
                        </label>
                      ))}
                    </div>
                    <div style={{ fontSize: 8, color: T.sub, marginTop: 3, textAlign: "center" }}>Obbligatori per pratiche fiscali con detrazione/bonus</div>
                  </div>
                  <button onClick={() => {
                    const tipoL = c.praticaFiscale === "iva10" ? "IVA Agevolata 10%" : c.praticaFiscale === "detrazione50" ? "Detrazione 50%" : c.praticaFiscale === "ecobonus65" ? "Ecobonus 65%" : "Superbonus";
                    const txt = [
                      `DICHIARAZIONE PER ${tipoL.toUpperCase()}`, `(ai sensi del DPR 445/2000)`, ``,
                      `Il/La sottoscritto/a: ${c.cliente} ${c.cognome || ""}`,
                      `C.F.: ${c.cf || "________________"}`,
                      `Residente in: ${c.indirizzo || "________________"}`, ``,
                      `DICHIARA`, ``,
                      `che i lavori di sostituzione infissi presso:`,
                      `${c.indirizzo || "________________"}`, ``,
                      `rientrano in intervento di manutenzione straordinaria/ristrutturazione`,
                      `ai sensi dell'art. 3 c.1 lett. b) DPR 380/2001`, ``,
                      `Titolo abilitativo: CILA/SCIA n. ________ del ________`,
                      `Comune di: ________`, ``,
                      ...(c.praticaFiscale === "iva10" ? [`CHIEDE l'applicazione dell'IVA agevolata al 10%`, `(art. 7 c.1 lett. b L. 488/99)`, ``] : []),
                      ...(c.praticaFiscale !== "iva10" ? [
                        `DATI PER BONIFICO PARLANTE:`,
                        `Beneficiario: ${c.cliente} ${c.cognome || ""} - CF: ${c.cf || "________"}`,
                        `Ditta: Walter Cozza Serramenti SRL - P.IVA: ________`,
                        `Causale: ${c.praticaFiscale === "detrazione50" ? "Art.16-bis TUIR - Detrazione 50%" : c.praticaFiscale === "ecobonus65" ? "L.296/2006 - Ecobonus 65%" : "DL 34/2020 - Superbonus"} - Fat. n. ___`, ``,
                        `NOTA: Comunicazione ENEA entro 90gg da fine lavori`, ``,
                      ] : []),
                      `Data: ________     Firma: ________________________`, ``,
                      `--- Commessa ${c.code} ---`,
                      `Importo: ‚Ç¨${fmtPF(totPF)} ¬∑ IVA ${ivaPF}% ¬∑ Totale: ‚Ç¨${fmtPF(totIvaPF)}`,
                    ].join("\n");
                    const blob = new Blob([txt], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a"); a.href = url;
                    a.download = `Pratica_${c.code}_${c.cliente}.txt`;
                    a.click(); URL.revokeObjectURL(url);
                  }} style={{ width: "100%", marginTop: 8, padding: 11, borderRadius: 10, border: "none", background: "#007aff", color: "#fff", fontSize: 12, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                    üìÑ SCARICA MODULI PRESTAMPATI
                  </button>
                  <div style={{ fontSize: 9, color: T.sub, marginTop: 3, textAlign: "center" }}>Genera dichiarazione da far compilare e firmare al cliente</div>
                </div>
              )}
            </div>
          );
        })()}

        {/* Tab: Rilievi | Report */}
        <div style={{ display: "flex", borderBottom: `1px solid ${T.bdr}`, margin: "0 0 4px 0" }}>
          {["rilievi", "report"].map(t => (
            <div key={t} onClick={() => setCmSubTab(t)}
              style={{ flex: 1, padding: "9px 4px", textAlign: "center", fontSize: 12, fontWeight: 600, cursor: "pointer",
                borderBottom: `2px solid ${cmSubTab === t ? T.acc : "transparent"}`,
                color: cmSubTab === t ? T.acc : T.sub, textTransform: "capitalize" }}>
              {t === "rilievi" ? `üìÅ Rilievi (${rilievi.length})` : "üìä Report Differenze"}
            </div>
          ))}
        </div>

        {/* TAB REPORT */}
        {cmSubTab === "report" && renderReportDiff()}

        {/* TAB RILIEVI */}
        {cmSubTab !== "report" && (
          <div style={{ padding: "8px 16px" }}>
            {rilievi.length === 0 && (
              <div style={{ textAlign: "center", padding: "32px 16px" }}>
                <div style={{ fontSize: 40, marginBottom: 12 }}>üìÇ</div>
                <div style={{ fontSize: 15, fontWeight: 700, color: T.text, marginBottom: 6 }}>Nessun rilievo ancora</div>
                <div style={{ fontSize: 12, color: T.sub, marginBottom: 20 }}>Crea il primo rilievo per iniziare a misurare i vani</div>
                <button onClick={() => setShowNuovoRilievo(true)} style={{ ...S.btn, margin: "0 auto" }}>+ Crea primo rilievo</button>
              </div>
            )}
            {[...rilievi].reverse().map((r, idx) => {
              const vaniCount = (r.vani || []).length;
              const vaniMisurati = (r.vani || []).filter(v => Object.values(v.misure || {}).filter(x => (x as number) > 0).length >= 6).length;
              const colore = tipoColor[r.tipo] || T.blue;
              const ico = tipoIco[r.tipo] || "üìê";
              const isUltimo = idx === 0;
              return (
                <div key={r.id} onClick={() => { setSelectedRilievo(r); setCmSubTab("sopralluoghi"); }}
                  style={{ ...S.card, marginBottom: 10, cursor: "pointer", overflow: "hidden",
                    border: `1.5px solid ${isUltimo ? colore + "50" : T.bdr}`,
                    background: isUltimo ? colore + "06" : T.card }}>
                  {/* Header rilievo */}
                  <div style={{ padding: "13px 14px", display: "flex", alignItems: "center", gap: 12 }}>
                    <div style={{ width: 42, height: 42, borderRadius: 10, background: colore + "15", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", flexShrink: 0, border: `1.5px solid ${colore}30` }}>
                      <div style={{ fontSize: 10, fontWeight: 800, color: colore, fontFamily: FM }}>R{r.n}</div>
                      <div style={{ fontSize: 14 }}>{ico}</div>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                        <div style={{ fontSize: 14, fontWeight: 700 }}>
                          {new Date(r.data + "T12:00:00").toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "long", year: "numeric" })}
                        </div>
                        {isUltimo && <span style={{ fontSize: 9, fontWeight: 700, padding: "2px 6px", borderRadius: 4, background: colore, color: "#fff" }}>ULTIMO</span>}
                      </div>
                      <div style={{ fontSize: 11, color: T.sub }}>
                        {r.ora && `üïê ${r.ora} ¬∑ `}üë§ {r.rilevatore || "‚Äî"}
                      </div>
                      {r.motivoModifica && <div style={{ fontSize: 11, color: T.orange, marginTop: 2 }}>üîß {r.motivoModifica}</div>}
                    </div>
                    <div style={{ textAlign: "right" }}>
                      <div style={{ fontSize: 13, fontWeight: 700, color: colore }}>{vaniCount}</div>
                      <div style={{ fontSize: 10, color: T.sub }}>vani</div>
                    </div>
                    <span style={{ transform: "rotate(180deg)", display:"inline-flex", marginLeft: 4 }}><Ico d={ICO.back} s={14} c={T.sub} /></span>
                  </div>
                  {/* Barra progresso vani */}
                  {vaniCount > 0 && (
                    <div style={{ padding: "0 14px 12px" }}>
                      <div style={{ height: 4, background: T.bdr, borderRadius: 2, overflow: "hidden", marginBottom: 3 }}>
                        <div style={{ height: "100%", width: `${Math.round(vaniMisurati / vaniCount * 100)}%`, background: vaniMisurati === vaniCount ? T.grn : colore, borderRadius: 2 }} />
                      </div>
                      <div style={{ fontSize: 10, color: T.sub }}>{vaniMisurati}/{vaniCount} vani con misure</div>
                    </div>
                  )}
                  {/* Note */}
                  {r.note && <div style={{ padding: "0 14px 10px", fontSize: 11, color: T.sub, fontStyle: "italic" }}>"{r.note}"</div>}
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  };

  // Card compatta per vista lista
  const renderCMCardCompact = (c) => {
    const fase = PIPELINE.find(p => p.id === c.fase);
    const TODAY_ISO = new Date().toISOString().split("T")[0];
    const isScad = c.scadenza && c.scadenza < TODAY_ISO;
    const isFerma = giorniFermaCM(c) >= sogliaDays && c.fase !== "chiusura";
    const vaniA = getVaniAttivi(c);
    const vaniMis = vaniA.filter(v => Object.values(v.misure||{}).filter(x=>(x as number)>0).length >= 6).length;
    const vaniInc = vaniA.filter(v => { const n=Object.values(v.misure||{}).filter(x=>(x as number)>0).length; return n>0&&n<6; }).length;
    const vaniBloc = vaniA.filter(v => v.note?.startsWith("üî¥ BLOCCATO")).length;
    const az = AFASE[c.fase] || AFASE["sopralluogo"];
    const faseIdx = PIPELINE.findIndex(x => x.id === c.fase);
    const progFase = faseIdx >= 0 ? Math.round((faseIdx+1)/PIPELINE.length*100) : 0;
    return (
      <div key={c.id} onClick={() => { setSelectedCM(c); setTab("commesse"); }}
        style={{ display:"flex", alignItems:"center", gap:10, padding:"10px 14px", borderBottom:`1px solid ${T.bdr}`,
          borderLeft:`3px solid ${isFerma?T.red:isScad?T.orange:fase?.color||T.acc}`,
          background: isFerma ? "rgba(255,59,48,0.03)" : T.card, cursor:"pointer" }}>
        {/* Colonna sinistra: codice + cliente */}
        <div style={{ flex:1, minWidth:0 }}>
          <div style={{ display:"flex", alignItems:"center", gap:6, flexWrap:"wrap" }}>
            <span style={{ fontSize:10, color:T.sub, fontFamily:FM }}>{c.code}</span>
            <span style={{ fontSize:14, fontWeight:700 }}>{c.cliente}</span>
            {isFerma && <span style={{ fontSize:9, fontWeight:800, color:T.red, background:T.redLt, borderRadius:6, padding:"1px 5px" }}>FERMA {giorniFermaCM(c)}gg</span>}
            {isScad && !isFerma && <span style={{ fontSize:9, fontWeight:800, color:T.orange, background:T.orangeLt, borderRadius:6, padding:"1px 5px" }}>SCAD</span>}
          </div>
          <div style={{ display:"flex", gap:8, marginTop:3, alignItems:"center", flexWrap:"wrap" }}>
            <span style={{ ...S.badge(fase?.color+"18"||T.accLt, fase?.color||T.acc), fontSize:10 }}>{fase?.ico} {fase?.nome}</span>
            {c.trackingStato && <span style={{ fontSize:9, fontWeight:700, padding:"1px 5px", borderRadius:4, background: c.trackingStato==="montato"?"#34c75920":c.trackingStato==="pronto"?"#34c75920":"#5856d620", color: c.trackingStato==="montato"?"#34c759":c.trackingStato==="pronto"?"#34c759":"#5856d6" }}>{{ordinato:"üì¶",produzione:"üè≠",pronto:"‚úÖ",consegnato:"üöõ",montato:"üîß"}[c.trackingStato]} {c.trackingStato}</span>}
            {c.confermato && <span style={{ fontSize:9, fontWeight:700, padding:"1px 5px", borderRadius:4, background:"#34c75920", color:"#34c759" }}>‚úçÔ∏è Confermato</span>}
            {c.euro && <span style={{ fontSize:11, color:T.grn, fontWeight:700 }}>‚Ç¨{c.euro.toLocaleString("it-IT")}</span>}
            {c.scadenza && <span style={{ fontSize:10, color: isScad ? T.red : T.sub }}>üìÖ {c.scadenza}</span>}
          </div>
        </div>
        {/* Colonna destra: info mancanti */}
        <div style={{ textAlign:"right", flexShrink:0, minWidth:80 }}>
          {vaniA.length > 0 ? (
            <div style={{ fontSize:11, fontWeight:600 }}>
              {vaniBloc > 0 && <div style={{ color:T.red }}>üî¥ {vaniBloc} bloccati</div>}
              {vaniInc > 0 && <div style={{ color:T.orange }}>‚ö† {vaniInc} incompleti</div>}
              {vaniBloc===0 && vaniInc===0 && <div style={{ color:T.grn }}>‚úÖ {vaniMis}/{vaniA.length}</div>}
            </div>
          ) : (
            <div style={{ fontSize:10, color:T.sub }}>Nessun vano</div>
          )}
          <div style={{ marginTop:4, fontSize:10, color: isFerma?T.red:fase?.color||T.acc, fontWeight:700 }}>{progFase}%</div>
          <div style={{ marginTop:3, height:3, width:60, background:T.bdr, borderRadius:2, marginLeft:"auto" }}>
            <div style={{ height:"100%", width:`${progFase}%`, background:isFerma?T.red:fase?.color||T.acc, borderRadius:2 }}/>
          </div>
        </div>
        <span style={{ color:T.sub, fontSize:16 }}>‚Ä∫</span>
      </div>
    );
  };

  
  const renderCommesse = () => {
    if (showRiepilogo && selectedCM) return renderRiepilogo();
    if (selectedVano) return renderVanoDetail();

      if (selectedRilievo) return renderCMDetail();
    if (selectedCM) return renderRilieviList();
    return (
      <div style={{ paddingBottom: 80 }}>
        <div style={S.header}>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>Commesse</div>
            <div style={S.headerSub}>{cantieri.length} totali ¬∑ {filtered.length} visibili</div>
          </div>
          <div style={{ display:"flex", gap:6, alignItems:"center" }}>
            {/* Toggle vista */}
            <div style={{ display:"flex", background:T.bg, borderRadius:8, padding:2, gap:1 }}>
              <div onClick={() => setCmView("list")} style={{ padding:"4px 8px", borderRadius:6, background:cmView==="list"?T.card:"transparent", cursor:"pointer", fontSize:14 }} title="Lista compatta">‚ò∞</div>
              <div onClick={() => setCmView("card")} style={{ padding:"4px 8px", borderRadius:6, background:cmView==="card"?T.card:"transparent", cursor:"pointer", fontSize:14 }} title="Card grandi">‚ñ¶</div>
            </div>
            <div onClick={() => apriInboxDocumento()} style={{ width:36, height:36, borderRadius:10, background:"#af52de", color:"#fff", display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", fontSize:18 }} title="Carica documento fornitore">üì•</div>
            <div onClick={() => setShowModal("commessa")} style={{ width:36, height:36, borderRadius:10, background:T.acc, color:"#fff", display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", fontSize:20, fontWeight:300 }}>+</div>
          </div>
        </div>

        {/* Filtri fase */}
        <div style={{ display:"flex", gap:6, padding:"4px 16px 10px", overflowX:"auto", WebkitOverflowScrolling:"touch" }}>
          <div style={S.chip(filterFase === "tutte")} onClick={() => setFilterFase("tutte")}>Tutte ({cantieri.length})</div>
          {PIPELINE.map(p => {
            const n = cantieri.filter(c => c.fase === p.id).length;
            return n > 0 ? <div key={p.id} style={S.chip(filterFase === p.id)} onClick={() => setFilterFase(p.id)}>{p.ico} {p.nome} ({n})</div> : null;
          })}
        </div>

        {/* Search */}
        <div style={{ padding:"0 16px", marginBottom:10 }}>
          <input style={{ ...S.input, width:"100%", boxSizing:"border-box" }} placeholder="Cerca per cliente, codice, indirizzo..." value={searchQ} onChange={e => setSearchQ(e.target.value)} />
        </div>

        {/* Lista o Card */}
        {cmView === "list" ? (
          <div style={{ background:T.card, margin:"0 16px", borderRadius:T.r, border:`1px solid ${T.bdr}`, overflow:"hidden" }}>
            {filtered.length === 0
              ? <div style={{ padding:"24px", textAlign:"center", color:T.sub }}>Nessuna commessa trovata</div>
              : filtered.map(c => renderCMCardCompact(c))
            }
          </div>
        ) : (
          <div style={isDesktop ? { display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:8, padding:"0 16px" } : isTablet ? { display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, padding:"0 16px" } : {}}>
            {filtered.map(c => renderCMCard(c, isTablet || isDesktop))}
          </div>
        )}
      </div>
    );
  };

  /* == COMMESSA DETAIL == */
  const renderCMDetail = () => {
    const c = selectedCM;
    const r = selectedRilievo; // rilievo corrente
    const fase = PIPELINE.find(p => p.id === c.fase);

    // Vani del rilievo corrente
    const vaniList = r?.vani || [];
    // Compatibilit√† wizard vecchio
    const viste = []; // non pi√π usato con nuova arch
    const vaniM: number[] = [];
    const vaniA = vaniList;
    const tipoRil = r?.tipo || "rilievo";
    const tipoColRil = tipoRil === "definitiva" ? T.grn : tipoRil === "modifica" ? T.orange : T.blue;
    const tipoIcoRil = tipoRil === "definitiva" ? "‚úÖ" : tipoRil === "modifica" ? "üîß" : "üìê";
    const tipoLblRil = tipoRil === "definitiva" ? "Misure Definitive" : tipoRil === "modifica" ? "Modifica" : "Rilievo Misure";

    // Calcolo avanzamento misure
    const vaniMisurati = vaniList.filter(v => Object.values(v.misure || {}).filter(x => (x as number) > 0).length >= 6);
    const vaniBloccati = vaniList.filter(v => v.note?.startsWith("üî¥ BLOCCATO"));
    const vaniDaFare   = vaniList.filter(v => vaniMisurati.every(m => m.id !== v.id));
    const progVani = vaniList.length > 0 ? Math.round(vaniMisurati.length / vaniList.length * 100) : 0;
    const tutteMis = vaniMisurati.length === vaniList.length && vaniList.length > 0;

    // == Wizard helpers (legacy) ==
    function togV(id) { setNvVani(s => s.includes(id) ? s.filter(x => x !== id) : [...s, id]); }
    function togB(id) {
      setNvBlocchi(b => b[id]
        ? (()=>{ const n = {...b}; delete n[id]; return n; })()
        : { ...b, [id]: { motivo: "", note: "" } }
      );
    }
    function sbF(id, f, v) { setNvBlocchi(b => ({ ...b, [id]: { ...b[id], [f]: v } })); }
    function salvaVisita() {
      const vaniBloccati = Object.entries(nvBlocchi).map(([id, b]) => ({
        vanoId: parseInt(id), motivo: b.motivo || "Altro", note: b.note || ""
      }));
      const stato = nvTipo === "modifica" ? "modifica" :
        nvVani.length === vaniA.length && vaniBloccati.length === 0 ? "completo" : "parziale";
      const nuova = {
        id: Date.now(), n: viste.length + 1,
        data: nvData.data || new Date().toISOString().split("T")[0],
        ora: nvData.ora || "", rilevatore: nvData.rilevatore || "",
        tipo: nvTipo, motivoModifica: nvMotivoModifica,
        stato, vaniMisurati: nvVani.map(Number), vaniBloccati, note: nvNote
      };
      setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, visite: [...(x.visite||[]), nuova] } : x));
      setSelectedCM(prev => ({ ...prev, visite: [...(prev.visite||[]), nuova] }));
      setNvView(false); setNvStep(1);
      setNvData({ data: "", ora: "", rilevatore: "" });
      setNvTipo("rilievo"); setNvMotivoModifica("");
      setNvVani([]); setNvBlocchi({}); setNvNote("");
    }

    // == VISTA WIZARD ==
    if (nvView) return (
      <div style={{ paddingBottom: 80 }}>
        {/* Header wizard */}
        <div style={{ ...S.header }}>
          <div onClick={() => { setNvView(false); setNvStep(1); }} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>Nuova visita</div>
            <div style={S.headerSub}>{c.code} ¬∑ {c.cliente}</div>
          </div>
          <div style={{ fontSize: 11, color: T.sub }}>Step {nvStep}/5</div>
        </div>
        {/* Tab step */}
        <div style={{ display: "flex", background: T.card, borderBottom: `1px solid ${T.bdr}` }}>
          {["Tipo", "Dati", "Vani", "Blocchi", "Salva"].map((l, i) => (
            <div key={i} onClick={() => i < nvStep && setNvStep(i+1)}
              style={{ flex: 1, padding: "8px 4px", textAlign: "center", fontSize: 10, fontWeight: 600,
                borderBottom: `2px solid ${nvStep===i+1 ? T.acc : "transparent"}`,
                color: nvStep===i+1 ? T.acc : T.sub, cursor: i < nvStep ? "pointer" : "default" }}>
              {l}
            </div>
          ))}
        </div>
        <div style={{ padding: "16px" }}>
          {/* STEP 1 ‚Äî Tipo visita */}
          {nvStep === 1 && <>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 6 }}>üè∑ Tipo di visita</div>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 16 }}>Seleziona il tipo di sopralluogo</div>
            {[
              { k: "rilievo",    ico: "üìê", label: "Rilievo misure",     desc: "Prima visita o misure di vani mancanti" },
              { k: "definitiva", ico: "‚úÖ", label: "Misure definitive",  desc: "Conferma finale di tutte le misure" },
              { k: "modifica",   ico: "üîß", label: "Modifica cantiere",  desc: "Variazione, problema o sopralluogo post-vendita" },
            ].map(t => (
              <div key={t.k} onClick={() => setNvTipo(t.k)}
                style={{ ...S.card, padding: "13px 14px", marginBottom: 10, cursor: "pointer",
                  border: `1.5px solid ${nvTipo === t.k ? T.acc : T.bdr}`,
                  background: nvTipo === t.k ? T.accLt : T.card,
                  display: "flex", alignItems: "center", gap: 12 }}>
                <div style={{ fontSize: 24 }}>{t.ico}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, fontWeight: 700, color: nvTipo === t.k ? T.acc : T.text }}>{t.label}</div>
                  <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{t.desc}</div>
                </div>
                <div style={{ width: 20, height: 20, borderRadius: "50%",
                  border: `2px solid ${nvTipo === t.k ? T.acc : T.bdr}`,
                  background: nvTipo === t.k ? T.acc : "transparent",
                  display: "flex", alignItems: "center", justifyContent: "center",
                  color: "#fff", fontSize: 12 }}>{nvTipo === t.k ? "‚úì" : ""}</div>
              </div>
            ))}
            {nvTipo === "modifica" && (
              <div style={{ marginBottom: 10 }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>MOTIVO MODIFICA</div>
                <input style={S.input} placeholder="Es: cliente ha cambiato idea su un vano, problema rilevato..." value={nvMotivoModifica} onChange={e => setNvMotivoModifica(e.target.value)} />
              </div>
            )}
            <button onClick={() => setNvStep(2)} style={{ ...S.btn, marginTop: 12, width: "100%" }}>Avanti ‚Üí</button>
          </>}
          {/* STEP 2 ‚Äî Dati */}
          {nvStep === 2 && <>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 14 }}>üìã Dati della visita</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              <div>
                <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>DATA</div>
                <input style={S.input} type="date" value={nvData.data} onChange={e => setNvData(d => ({...d, data: e.target.value}))} />
              </div>
              <div>
                <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>ORA</div>
                <input style={S.input} type="time" value={nvData.ora} onChange={e => setNvData(d => ({...d, ora: e.target.value}))} />
              </div>
              <div>
                <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>RILEVATORE</div>
                <input style={S.input} placeholder="Chi ha eseguito il rilievo..." value={nvData.rilevatore} onChange={e => setNvData(d => ({...d, rilevatore: e.target.value}))} />
              </div>
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 20 }}>
              <button onClick={() => setNvStep(1)} style={{ ...S.btnCancel, flex: 1, border: `1px solid ${T.bdr}` }}>‚Üê Indietro</button>
              <button onClick={() => setNvStep(3)} style={{ ...S.btn, flex: 2 }}>Avanti ‚Üí</button>
            </div>
          </>}
          {/* STEP 2 ‚Äî Vani misurati */}
          {nvStep === 3 && <>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 4 }}>‚úÖ Vani misurati</div>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 14 }}>Seleziona i vani che hai misurato</div>
            {vaniA.length === 0
              ? <div style={{ textAlign: "center", padding: "20px", color: T.sub }}>Tutti gi√† misurati!</div>
              : vaniA.map(v => (
                <div key={v.id} onClick={() => togV(v.id)} style={{
                  ...S.card, padding: "12px 14px", marginBottom: 8, cursor: "pointer",
                  border: `1.5px solid ${nvVani.includes(v.id) ? T.grn : T.bdr}`,
                  background: nvVani.includes(v.id) ? T.grnLt : T.card,
                  display: "flex", alignItems: "center", justifyContent: "space-between"
                }}>
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600 }}>{v.nome}</div>
                    <div style={{ fontSize: 11, color: T.sub }}>~{v.mq}m¬≤</div>
                  </div>
                  <div style={{ width: 24, height: 24, borderRadius: 6,
                    border: `2px solid ${nvVani.includes(v.id) ? T.grn : T.bdr}`,
                    background: nvVani.includes(v.id) ? T.grn : "transparent",
                    display: "flex", alignItems: "center", justifyContent: "center",
                    color: "#fff", fontSize: 14 }}>
                    {nvVani.includes(v.id) ? "‚úì" : ""}
                  </div>
                </div>
              ))
            }
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <button onClick={() => setNvStep(2)} style={{ ...S.btnCancel, flex: 1, border: `1px solid ${T.bdr}` }}>‚Üê Indietro</button>
              <button onClick={() => setNvStep(4)} style={{ ...S.btn, flex: 2 }}>Avanti ‚Üí</button>
            </div>
          </>}
          {/* STEP 4 ‚Äî Vani bloccati */}
          {nvStep === 4 && <>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 4 }}>üî¥ Vani non misurati</div>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 14 }}>Indica il motivo per ogni vano saltato</div>
            {vaniA.filter(v => !nvVani.includes(v.id)).map(v => {
              const hB = !!nvBlocchi[v.id];
              return (
                <div key={v.id} style={{ ...S.card, marginBottom: 10, overflow: "hidden", border: `1.5px solid ${hB ? T.red : T.bdr}` }}>
                  <div onClick={() => togB(v.id)} style={{ padding: "11px 14px", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between", background: hB ? T.redLt : T.card }}>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600 }}>{v.nome}</div>
                      <div style={{ fontSize: 11, color: T.sub }}>{hB ? "Indica motivo" : "Tocca per segnare bloccato"}</div>
                    </div>
                    <div style={{ width: 24, height: 24, borderRadius: 6, border: `2px solid ${hB ? T.red : T.bdr}`, background: hB ? T.red : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 14 }}>
                      {hB ? "‚úì" : ""}
                    </div>
                  </div>
                  {hB && (
                    <div style={{ padding: "0 14px 12px", background: T.redLt }}>
                      <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 8, paddingTop: 8 }}>
                        {MOTIVI_BLOCCO.map(m => (
                          <div key={m} onClick={() => sbF(v.id, "motivo", m)} style={{
                            padding: "4px 8px", borderRadius: 6, fontSize: 10, fontWeight: 600, cursor: "pointer",
                            background: nvBlocchi[v.id]?.motivo === m ? T.red : T.card,
                            border: `1.5px solid ${nvBlocchi[v.id]?.motivo === m ? T.red : T.bdr}`,
                            color: nvBlocchi[v.id]?.motivo === m ? "#fff" : T.sub
                          }}>{m}</div>
                        ))}
                      </div>
                      <input style={S.input} placeholder="Note aggiuntive..." value={nvBlocchi[v.id]?.note || ""} onChange={e => sbF(v.id, "note", e.target.value)} />
                    </div>
                  )}
                </div>
              );
            })}
            <div style={{ marginTop: 8 }}>
              <div style={{ fontSize: 11, fontWeight: 600, color: T.sub, marginBottom: 5 }}>NOTE GENERALI</div>
              <textarea style={{ ...S.input, minHeight: 70, resize: "vertical" }} placeholder="Osservazioni sull'intera visita..." value={nvNote} onChange={e => setNvNote(e.target.value)} />
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
              <button onClick={() => setNvStep(3)} style={{ ...S.btnCancel, flex: 1, border: `1px solid ${T.bdr}` }}>‚Üê Indietro</button>
              <button onClick={() => setNvStep(5)} style={{ ...S.btn, flex: 2 }}>Avanti ‚Üí</button>
            </div>
          </>}
          {/* STEP 5 ‚Äî Riepilogo */}
          {nvStep === 5 && <>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 14 }}>üìã Riepilogo</div>
            <div style={{ ...S.card, padding: "12px 14px", marginBottom: 10 }}>
              <div style={{ fontSize: 11, color: T.sub }}>üìÖ {nvData.data ? new Date(nvData.data + "T12:00:00").toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" }) : "‚Äî"} ¬∑ üïê {nvData.ora || "--:--"}</div>
              <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>üë§ {nvData.rilevatore || "Non specificato"}</div>
            </div>
            {nvVani.length > 0 && (
              <div style={{ ...S.card, padding: "12px 14px", marginBottom: 10, border: `1px solid ${T.grn}40` }}>
                <div style={{ fontSize: 11, fontWeight: 700, color: T.grn, marginBottom: 7 }}>‚úÖ Misurati</div>
                <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
                  {nvVani.map(id => { const v = vaniA.find(x => x.id === id); return <span key={id} style={S.badge(T.grnLt, T.grn)}>{v?.nome}</span>; })}
                </div>
              </div>
            )}
            {Object.keys(nvBlocchi).length > 0 && (
              <div style={{ ...S.card, padding: "12px 14px", marginBottom: 10, border: `1px solid ${T.red}40` }}>
                <div style={{ fontSize: 11, fontWeight: 700, color: T.red, marginBottom: 7 }}>üî¥ Bloccati</div>
                {Object.entries(nvBlocchi).map(([id, b]) => {
                  const v = vaniA.find(x => x.id === parseInt(id));
                  return <div key={id} style={{ fontSize: 11, marginBottom: 4 }}><strong>{v?.nome}</strong>: {b.motivo || "‚Äî"}{b.note && ` ‚Äî ${b.note}`}</div>;
                })}
              </div>
            )}
            {nvNote && <div style={{ ...S.card, padding: "12px 14px", marginBottom: 10, fontStyle: "italic", fontSize: 11, color: T.sub }}>"{nvNote}"</div>}
            <div style={{ ...S.card, padding: "10px 14px", marginBottom: 10, background: T.accLt, border: `1px solid ${T.acc}30` }}>
              <div style={{ fontSize: 9, fontWeight: 700, color: T.acc, textTransform: "uppercase", letterSpacing: 0.5, marginBottom: 3 }}>Tipo visita</div>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.acc }}>
                {nvTipo === "rilievo" ? "üìê Rilievo misure" : nvTipo === "definitiva" ? "‚úÖ Misure definitive" : "üîß Modifica cantiere"}
              </div>
              {nvTipo === "modifica" && nvMotivoModifica && <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{nvMotivoModifica}</div>}
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={() => setNvStep(4)} style={{ ...S.btnCancel, flex: 1, border: `1px solid ${T.bdr}` }}>‚Üê Modifica</button>
              <button onClick={salvaVisita} style={{ ...S.btn, flex: 2, background: T.grn }}>‚úì Salva visita</button>
            </div>
          </>}
        </div>
      </div>
    );

    // == VISTA RILIEVO CON VANI ==
    return (
      <div style={{ paddingBottom: 80 }}>
        {/* Header rilievo */}
        <div style={{ ...S.header }}>
          <div onClick={() => { setSelectedRilievo(null); setCmSubTab("rilievi"); }} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
          <div style={{ flex: 1 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ fontSize: 14 }}>{tipoIcoRil}</span>
              <div style={S.headerTitle}>{tipoLblRil} ‚Äî R{r?.n}</div>
            </div>
            <div style={S.headerSub}>{c.code} ¬∑ {c.cliente} {c.cognome || ""} ¬∑ {r?.data ? new Date(r.data + "T12:00:00").toLocaleDateString("it-IT", { day:"numeric", month:"short", year:"numeric" }) : ""}</div>
          </div>
          {vaniList.length > 0 && (
            <div style={{ textAlign: "right" }}>
              <div style={{ fontSize: 12, fontWeight: 700, color: tipoColRil }}>{progVani}%</div>
              <div style={{ fontSize: 10, color: T.sub }}>{vaniMisurati.length}/{vaniList.length} vani</div>
            </div>
          )}
          <div onClick={() => setShowRiepilogo(true)} style={{ padding: "6px 10px", borderRadius: 6, background: T.accLt, cursor: "pointer", marginLeft: 6 }}>
            <span style={{ fontSize: 14 }}>üìã</span>
          </div>
          <div onClick={exportPDF} style={{ padding: "6px 10px", borderRadius: 6, background: T.redLt, cursor: "pointer" }}>
            <Ico d={ICO.file} s={16} c={T.red} />
          </div>
        </div>

        {/* Banner rilievo info */}
        {r?.motivoModifica && (
          <div style={{ margin: "4px 16px 0", padding: "8px 12px", background: T.orangeLt, borderRadius: 8, border: `1px solid ${T.orange}30`, fontSize: 12, color: T.orange }}>
            üîß <strong>Modifica:</strong> {r.motivoModifica}
          </div>
        )}

        {/* Barra progresso vani */}
        {vaniList.length > 0 && (
          <div style={{ padding: "8px 16px" }}>
            <div style={{ height: 5, background: T.bdr, borderRadius: 3, overflow: "hidden", marginBottom: 4 }}>
              <div style={{ height: "100%", width: `${progVani}%`, background: progVani === 100 ? T.grn : tipoColRil, borderRadius: 3 }} />
            </div>
            {vaniDaFare.filter(v => !v.note?.startsWith("üî¥")).length > 0 && <div style={{ fontSize: 11, color: T.red, fontWeight: 600 }}>Mancano misure: {vaniDaFare.filter(v => !v.note?.startsWith("üî¥")).map(v => v.nome).join(", ")}</div>}
            {tutteMis && <div style={{ fontSize: 11, color: T.grn, fontWeight: 600 }}>‚úÖ Tutte le misure raccolte</div>}
          </div>
        )}

        {/* Info badges */}
        <div style={{ padding: "8px 16px", display: "flex", gap: 6, flexWrap: "wrap" }}>
          {c.tipo === "riparazione" && <span style={S.badge(T.orangeLt, T.orange)}>üîß Riparazione</span>}
          {c.tipo === "nuova" && <span style={S.badge(T.grnLt, T.grn)}>üÜï Nuova</span>}
          {c.sistema && <span style={S.badge(T.blueLt, T.blue)}>{c.sistema}</span>}
          {c.difficoltaSalita && <span style={S.badge(c.difficoltaSalita === "facile" ? T.grnLt : c.difficoltaSalita === "media" ? T.orangeLt : T.redLt, c.difficoltaSalita === "facile" ? T.grn : c.difficoltaSalita === "media" ? T.orange : T.red)}>Salita: {c.difficoltaSalita}</span>}
          {c.mezzoSalita && <span style={S.badge(T.purpleLt, T.purple)}>ü™ú {c.mezzoSalita}</span>}
          {c.pianoEdificio && <span style={S.badge(T.blueLt, T.blue)}>Piano: {c.pianoEdificio}</span>}
          {c.foroScale && <span style={S.badge(T.redLt, T.red)}>Foro: {c.foroScale}</span>}
          {c.telefono && <span onClick={() => window.location.href=`tel:${c.telefono}`} style={{ ...S.badge(T.grnLt, T.grn), cursor: "pointer" }}>üìû {c.telefono}</span>}
        </div>
        {c.note && <div style={{ padding: "0 16px", marginBottom: 6 }}><div style={{ padding: "8px 12px", borderRadius: 8, background: T.card, border: `1px solid ${T.bdr}`, fontSize: 12, color: T.sub, lineHeight: 1.4 }}>üìù {c.note}</div></div>}

        {/* Centro Comando inline ‚Äî replaces old phase panels */}
        {(() => {
          const vaniCC = getVaniAttivi(c);
          const rilieviCC = c.rilievi || [];
          const vaniConPrezzoCC = vaniCC.filter(v => calcolaVanoPrezzo(v, c) > 0);
          const totVaniCC = vaniCC.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0);
          const totVociCC = (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
          const totPrevCC = totVaniCC + totVociCC;
          const ivaPercCC = c.ivaPerc || 10;
          const totIvaCC = totPrevCC * (1 + ivaPercCC / 100);
          const hasFirmaCC = !!c.firmaCliente;
          const fattCC = fattureDB.filter(f => f.cmId === c.id);
          const hasFattCC = fattCC.some(f => f.tipo === "acconto" || f.tipo === "unica");
          const ordCC = ordiniFornDB.filter(o => o.cmId === c.id);
          const hasOrdCC = ordCC.length > 0;
          const ordConfCC = ordCC.some(o => o.conferma?.ricevuta);
          const confFirmCC = ordCC.some(o => o.conferma?.firmata);
          const montCC = montaggiDB.filter(m => m.cmId === c.id);
          const hasMontCC = montCC.length > 0;
          const hasSaldoCC = fattCC.some(f => f.tipo === "saldo");
          const saldoPagCC = fattCC.find(f => f.tipo === "saldo")?.pagata;
          const unicaPagCC = fattCC.find(f => f.tipo === "unica")?.pagata;
          const incassatoCC = fattCC.filter(f => f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
          const tuttoCC = (hasSaldoCC && saldoPagCC) || (fattCC.some(f => f.tipo === "unica") && unicaPagCC) || (c.fase === "chiusura" && incassatoCC >= totIvaCC) || (incassatoCC >= totIvaCC && fattCC.length > 0 && fattCC.every(f => f.pagata));
          const fmtCC = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";

          const stepsCC = [
            { id: "rilievo", icon: "üìê", l: "Rilievo", done: rilieviCC.length > 0 },
            { id: "misure", icon: "üìè", l: "Preventivo", done: vaniCC.length > 0 && vaniConPrezzoCC.length > 0 },
            { id: "firma", icon: "‚úçÔ∏è", l: "Firma", done: hasFirmaCC },
            { id: "fattura", icon: "üí∞", l: "Fattura", done: hasFattCC },
            { id: "ordine", icon: "üì¶", l: "Ordine", done: hasOrdCC },
            { id: "conferma", icon: "üìÑ", l: "Conferma", done: confFirmCC },
            { id: "montaggio", icon: "üîß", l: "Montaggio", done: hasMontCC },
            { id: "saldo", icon: "üí∂", l: "Chiusura", done: tuttoCC },
          ];
          const doneCC = stepsCC.filter(s => s.done).length;
          const curIdxCC = stepsCC.findIndex(s => !s.done);
          const curCC = curIdxCC >= 0 ? stepsCC[curIdxCC] : null;
          const progCC = Math.round((doneCC / stepsCC.length) * 100);

          return (
            <div style={{ margin: "8px 16px 4px" }}>
              {/* Progress dots */}
              <div style={{ display: "flex", gap: 3, marginBottom: 6, justifyContent: "center" }}>
                {stepsCC.map((s, i) => (
                  <div key={s.id} style={{ display: "flex", alignItems: "center", gap: 3 }}>
                    <div style={{
                      width: 22, height: 22, borderRadius: "50%", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 10,
                      background: s.done ? "#34c759" : i === curIdxCC ? T.acc : T.bg,
                      color: s.done || i === curIdxCC ? "#fff" : T.sub, fontWeight: 700,
                    }}>{s.done ? "‚úì" : s.icon}</div>
                    {i < stepsCC.length - 1 && <div style={{ width: 8, height: 2, background: s.done ? "#34c759" : T.bdr }} />}
                  </div>
                ))}
              </div>
              {/* Current action */}
              {curCC && (
                <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: "12px 14px" }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                    <span style={{ fontSize: 18 }}>{curCC.icon}</span>
                    <span style={{ fontSize: 13, fontWeight: 800, color: T.text, flex: 1 }}>{curCC.l}</span>
                    <span style={{ fontSize: 10, fontWeight: 700, color: T.acc }}>{doneCC}/{stepsCC.length}</span>
                  </div>
                  {/* Success flash */}
                  {ccDone && <div style={{ marginBottom: 8, padding: "8px 10px", borderRadius: 8, background: "#34c75918", border: "1px solid #34c75940", fontSize: 12, fontWeight: 700, color: "#34c759", textAlign: "center" }}>{ccDone}</div>}
                  {/* FIRMA */}
                  {curCC.id === "firma" && (
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: T.acc, marginBottom: 8 }}>‚Ç¨{fmtCC(totPrevCC)} + IVA = ‚Ç¨{fmtCC(totIvaCC)}</div>
                      {firmaStep === 0 ? (
                        <div>
                          <div style={{ display: "flex", gap: 6, marginBottom: 6 }}>
                            <button onClick={() => generaPreventivoPDF(c)} style={{ flex: 1, padding: 10, borderRadius: 8, border: `1px solid ${T.acc}`, background: `${T.acc}08`, color: T.acc, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üìÑ PDF</button>
                            <button onClick={() => setShowPreventivoModal(true)} style={{ flex: 1, padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üëÅ Anteprima</button>
                          </div>
                          <button onClick={() => {
                            const tel = (c.telefono || "").replace(/\D/g, "");
                            window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(`Gentile ${c.cliente}, in allegato il preventivo. Totale: ‚Ç¨${fmtCC(totIvaCC)} IVA inclusa. Prego firmare e rinviare.`)}`, "_blank");
                            setFirmaStep(1);
                          }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#25d366", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üì§ INVIA AL CLIENTE ‚Üí</button>
                          <div style={{ textAlign: "center", marginTop: 4 }}><span onClick={() => setFirmaStep(1)} style={{ fontSize: 10, color: T.sub, cursor: "pointer", textDecoration: "underline" }}>Gi√† inviato?</span></div>
                        </div>
                      ) : !firmaFileUrl ? (
                        <div>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>Carica il documento firmato</div>
                          <button onClick={() => { const inp = document.createElement("input"); inp.type = "file"; inp.accept = "application/pdf,image/*"; inp.onchange = (ev: any) => { const f = ev.target.files?.[0]; if (!f) return; setFirmaFileName(f.name); const r = new FileReader(); r.onload = (e) => setFirmaFileUrl(e.target?.result as string); r.readAsDataURL(f); }; inp.click(); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: `2px dashed ${T.acc}`, background: `${T.acc}08`, color: T.acc, fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üì• CARICA FIRMATO</button>
                        </div>
                      ) : (
                        <div>
                          <div style={{ padding: 8, borderRadius: 8, background: "#34c75912", marginBottom: 6, fontSize: 11, color: "#34c759", fontWeight: 700 }}>üìé {firmaFileName} <span onClick={() => { setFirmaFileUrl(null); setFirmaFileName(""); }} style={{ cursor: "pointer", marginLeft: 6 }}>‚úï</span></div>
                          <button onClick={() => {
                            const all = { id: Date.now(), tipo: "firma", nome: firmaFileName, dataUrl: firmaFileUrl };
                            setCantieri(cs => cs.map(cm => cm.id === c.id ? { ...cm, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0], firmaDocumento: all, allegati: [...(cm.allegati || []), all] } : cm));
                            setSelectedCM(prev => ({ ...prev, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0] }));
                            setFirmaStep(0); setFirmaFileUrl(null); setFirmaFileName("");
                            setCcDone("‚úÖ Firma registrata!"); setTimeout(() => setCcDone(null), 3000);
                          }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CONFERMA FIRMA ‚Üí</button>
                        </div>
                      )}
                    </div>
                  )}
                  {/* FATTURA */}
                  {curCC.id === "fattura" && (
                    <div>
                      <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>Totale: ‚Ç¨{fmtCC(totIvaCC)}</div>
                      <div style={{ display: "flex", gap: 4, marginBottom: 8, flexWrap: "wrap" as any }}>
                        {[30, 40, 50, 60, 100].map(p => (
                          <div key={p} onClick={() => setFattPerc(p)} style={{ padding: "8px 12px", borderRadius: 8, cursor: "pointer", fontSize: 11, fontWeight: 800, background: fattPerc === p ? T.acc : T.card, color: fattPerc === p ? "#fff" : T.text, border: `2px solid ${fattPerc === p ? T.acc : T.bdr}` }}>
                            {p === 100 ? "100%" : p + "%"}
                          </div>
                        ))}
                      </div>
                      <div style={{ fontSize: 14, fontWeight: 900, color: T.acc, textAlign: "center", marginBottom: 8 }}>‚Ç¨{fmtCC(Math.round(totIvaCC * fattPerc / 100))}</div>
                      <button onClick={() => { creaFattura(c, fattPerc === 100 ? "unica" : "acconto"); setCcDone("‚úÖ Fattura creata!"); setTimeout(() => setCcDone(null), 3000); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üí∞ CREA FATTURA ‚Üí</button>
                    </div>
                  )}
                  {/* ORDINE */}
                  {curCC.id === "ordine" && (
                    <div>
                      <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>{vaniCC.length} vani ¬∑ {c.sistema || "‚Äî"}</div>
                      <div style={{ background: T.bg, borderRadius: 8, padding: 8, marginBottom: 8, maxHeight: 120, overflow: "auto" }}>
                        {vaniCC.map((v, vi) => (
                          <div key={vi} style={{ display: "flex", justifyContent: "space-between", fontSize: 11, padding: "3px 0", borderBottom: vi < vaniCC.length - 1 ? `1px solid ${T.bdr}` : "none" }}>
                            <span style={{ color: T.text, fontWeight: 600 }}>{v.nome || v.tipo || `Vano ${vi + 1}`}</span>
                            <span style={{ color: T.acc, fontWeight: 700 }}>{(v.larghezza || v.l || 0)}√ó{(v.altezza || v.h || 0)}</span>
                          </div>
                        ))}
                      </div>
                      <button onClick={() => { creaOrdineFornitore(c, c.sistema?.split(" ")[0] || ""); setSelectedCM(prev => ({ ...prev })); setCcDone("‚úÖ Ordine creato!"); setTimeout(() => setCcDone(null), 3000); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üì¶ CONFERMA ORDINE ‚Üí</button>
                    </div>
                  )}
                  {/* CONFERMA */}
                  {curCC.id === "conferma" && (
                    <div>
                      {!ordConfCC ? (
                        <button onClick={() => apriInboxDocumento()} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#af52de", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üì• CARICA CONFERMA ‚Üí</button>
                      ) : ccConfirm !== "conferma_ok" ? (
                        <button onClick={() => setCcConfirm("conferma_ok")} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ APPROVA CONFERMA ‚Üí</button>
                      ) : (
                        <div style={{ background: "#34c75912", borderRadius: 10, padding: 12, border: "1px solid #34c75930" }}>
                          <div style={{ fontSize: 13, fontWeight: 800, color: "#34c759", marginBottom: 4 }}>Approvi la conferma?</div>
                          <div style={{ display: "flex", gap: 8 }}>
                            <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 11, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                            <button onClick={() => { setOrdiniFornDB(prev => prev.map(o => o.cmId === c.id ? { ...o, conferma: { ...o.conferma, firmata: true } } : o)); setCcConfirm(null); setCcDone("‚úÖ Confermato!"); setTimeout(() => setCcDone(null), 3000); }} style={{ flex: 2, padding: 11, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ APPROVO</button>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  {/* MONTAGGIO */}
                  {curCC.id === "montaggio" && (
                    <div>
                      {!montFormOpen ? (
                        <div>
                          <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>{vaniCC.length} vani ¬∑ {c.indirizzo || "‚Äî"}</div>
                          <button onClick={() => { setMontFormOpen(true); setMontGiorni(1); setMontFormData({ data: "", orario: "08:00", durata: "giornata", squadraId: squadreDB[0]?.id || "", note: "" }); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üîß PIANIFICA MONTAGGIO ‚Üí</button>
                        </div>
                      ) : (
                        <div style={{ background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
                          <input type="date" value={montFormData.data} onChange={e => setMontFormData(p => ({ ...p, data: e.target.value }))} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, fontSize: 14, fontFamily: "inherit", boxSizing: "border-box" as any, marginBottom: 6 }} />
                          <div style={{ display: "flex", gap: 6, marginBottom: 6 }}>
                            <select value={montFormData.orario} onChange={e => setMontFormData(p => ({ ...p, orario: e.target.value }))} style={{ flex: 1, padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, fontSize: 12, fontFamily: "inherit" }}>
                              {["06:00","07:00","07:30","08:00","08:30","09:00","10:00","14:00"].map(h => <option key={h} value={h}>{h}</option>)}
                            </select>
                            <div style={{ flex: 1, display: "flex", alignItems: "center" }}>
                              <button onClick={() => setMontGiorni(Math.max(0.5, montGiorni - 0.5))} style={{ width: 32, height: 38, border: `1px solid ${T.bdr}`, borderRadius: "8px 0 0 8px", background: T.card, fontSize: 16, cursor: "pointer" }}>‚àí</button>
                              <div style={{ flex: 1, height: 38, display: "flex", alignItems: "center", justifyContent: "center", borderTop: `1px solid ${T.bdr}`, borderBottom: `1px solid ${T.bdr}`, fontSize: 14, fontWeight: 800 }}>{montGiorni === 0.5 ? "¬Ω" : montGiorni}g</div>
                              <button onClick={() => setMontGiorni(montGiorni + 0.5)} style={{ width: 32, height: 38, border: `1px solid ${T.bdr}`, borderRadius: "0 8px 8px 0", background: T.card, fontSize: 16, cursor: "pointer" }}>+</button>
                            </div>
                          </div>
                          {squadreDB.length > 0 && <div style={{ display: "flex", gap: 4, marginBottom: 6, flexWrap: "wrap" as any }}>{squadreDB.map(sq => (
                            <div key={sq.id} onClick={() => setMontFormData(p => ({ ...p, squadraId: sq.id }))} style={{ padding: "6px 12px", borderRadius: 8, cursor: "pointer", fontSize: 11, fontWeight: 700, background: montFormData.squadraId === sq.id ? T.acc : T.card, color: montFormData.squadraId === sq.id ? "#fff" : T.text, border: `1px solid ${montFormData.squadraId === sq.id ? T.acc : T.bdr}` }}>{sq.nome || sq.id}</div>
                          ))}</div>}
                          <div style={{ display: "flex", gap: 6 }}>
                            <button onClick={() => setMontFormOpen(false)} style={{ flex: 1, padding: 11, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                            <button onClick={() => {
                              if (!montFormData.data) { alert("Scegli una data"); return; }
                              const nuovoM = { id: "m_" + Date.now(), cmId: c.id, cmCode: c.code, cliente: c.cliente, indirizzo: c.indirizzo || "", vani: vaniCC.length, data: montFormData.data, orario: montFormData.orario, durata: montGiorni + "g", giorni: montGiorni, squadraId: montFormData.squadraId, stato: "programmato", note: montFormData.note };
                              setMontaggiDB(prev => [...prev, nuovoM]);
                              setEvents(prev => [...prev, { id: "ev_m_" + Date.now(), date: montFormData.data, time: montFormData.orario, text: `üîß Montaggio ${c.cliente} (${montGiorni}g)`, tipo: "montaggio", persona: c.cliente, cm: c.code, addr: c.indirizzo || "", done: false }]);
                              setMontFormOpen(false);
                              setCcDone("‚úÖ Montaggio pianificato!"); setTimeout(() => setCcDone(null), 3000);
                            }} style={{ flex: 2, padding: 11, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CONFERMA</button>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  {/* SALDO */}
                  {curCC.id === "saldo" && (() => {
                    const saldoFatCC = fattCC.find(f => f.tipo === "saldo" || f.tipo === "unica");
                    const saldoPagatoCC = saldoFatCC?.pagata;
                    const restoCC = totIvaCC - incassatoCC;
                    return (
                    <div>
                      <div style={{ fontSize: 11, color: T.sub, marginBottom: 6 }}>
                        Incassato ‚Ç¨{fmtCC(incassatoCC)} su ‚Ç¨{fmtCC(totIvaCC)} {restoCC > 0 ? `¬∑ Resta ‚Ç¨${fmtCC(restoCC)}` : "¬∑ ‚úÖ Tutto incassato"}
                      </div>
                      {/* Phase 1: Create saldo fattura */}
                      {!saldoFatCC && restoCC > 0 && (
                        ccConfirm !== "saldo" ? (
                          <button onClick={() => setCcConfirm("saldo")} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üí∂ FATTURA SALDO ‚Ç¨{fmtCC(restoCC)} ‚Üí</button>
                        ) : (
                          <div style={{ background: T.acc + "10", borderRadius: 10, padding: 12, border: `1px solid ${T.acc}30` }}>
                            <div style={{ fontSize: 13, fontWeight: 800, color: T.acc, marginBottom: 4 }}>Fattura saldo ‚Ç¨{fmtCC(restoCC)}</div>
                            <div style={{ display: "flex", gap: 8 }}>
                              <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 11, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                              <button onClick={() => { creaFattura(c, restoCC === totIvaCC ? "unica" : "saldo"); setCcConfirm(null); setCcDone("‚úÖ Fattura saldo creata!"); setTimeout(() => setCcDone(null), 3000); }} style={{ flex: 2, padding: 11, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CREA FATTURA</button>
                            </div>
                          </div>
                        )
                      )}
                      {/* Phase 2: Mark as paid */}
                      {saldoFatCC && !saldoPagatoCC && (
                        ccConfirm !== "pagata" ? (
                          <button onClick={() => setCcConfirm("pagata")} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ SEGNA PAGATA ‚Ç¨{fmtCC(restoCC)} ‚Üí</button>
                        ) : (
                          <div style={{ background: "#34c75912", borderRadius: 10, padding: 12, border: "1px solid #34c75930" }}>
                            <div style={{ fontSize: 13, fontWeight: 800, color: "#34c759", marginBottom: 4 }}>Conferma pagamento ‚Ç¨{fmtCC(restoCC)}</div>
                            <div style={{ display: "flex", gap: 8 }}>
                              <button onClick={() => setCcConfirm(null)} style={{ flex: 1, padding: 11, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, color: T.sub, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                              <button onClick={() => {
                                setFattureDB(prev => prev.map(f => f.cmId === c.id && !f.pagata ? { ...f, pagata: true, dataPagamento: new Date().toISOString().split("T")[0], metodoPagamento: "Bonifico" } : f));
                                setFaseTo(c.id, "chiusura");
                                setCcConfirm(null); setCcDone("üéâ Commessa chiusa!"); setTimeout(() => setCcDone(null), 3000);
                              }} style={{ flex: 2, padding: 11, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>‚úÖ CONFERMO INCASSO</button>
                            </div>
                          </div>
                        )
                      )}
                      {/* Phase 3: All paid, just close */}
                      {!saldoFatCC && restoCC <= 0 && (
                        <button onClick={() => { setFaseTo(c.id, "chiusura"); setCcDone("üéâ Commessa chiusa!"); setTimeout(() => setCcDone(null), 3000); }} style={{ width: "100%", padding: 14, borderRadius: 10, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üéâ CHIUDI COMMESSA ‚Üí</button>
                      )}
                    </div>
                    );
                  })()}
                  {/* MISURE ‚Äî solo se √® il passo corrente */}
                  {curCC.id === "misure" && vaniConPrezzoCC.length > 0 && (
                    <div style={{ fontSize: 12, color: T.acc, fontWeight: 700, textAlign: "center" }}>‚úÖ Prezzi OK ¬∑ Totale ‚Ç¨{fmtCC(totPrevCC)} ‚Äî Pronto per la firma</div>
                  )}
                </div>
              )}
              {/* Totale */}
              {totPrevCC > 0 && (
                <div style={{ marginTop: 6, display: "flex", justifyContent: "space-between", padding: "8px 12px", background: T.card, borderRadius: 8, border: `1px solid ${T.bdr}` }}>
                  <span style={{ fontSize: 12, fontWeight: 700 }}>Totale IVA incl.</span>
                  <span style={{ fontSize: 14, fontWeight: 900, color: T.acc }}>‚Ç¨{fmtCC(totIvaCC)}</span>
                </div>
              )}
            </div>
          );
        })()}

        {/* Contact actions */}
        <div style={{ display: "flex", gap: 8, padding: "12px 16px" }}>
          {[
            { ico: ICO.phone, label: "Chiama",   col: T.grn,  act: () => window.location.href=`tel:${c.telefono || ""}` },
            { ico: ICO.map,   label: "Naviga",   col: T.blue, act: () => window.open(`https://maps.google.com/?q=${encodeURIComponent(c.indirizzo || "")}`) },
            { ico: ICO.send,  label: "WhatsApp", col: "#25d366", act: () => window.open(`https://wa.me/?text=${encodeURIComponent(`Commessa ${c.code} - ${c.cliente}`)}`) },
          ].map((a, i) => (
            <div key={i} onClick={a.act} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4, padding: "10px 0", background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, cursor: "pointer" }}>
              <Ico d={a.ico} s={18} c={a.col} />
              <span style={{ fontSize: 10, fontWeight: 600, color: T.sub }}>{a.label}</span>
            </div>
          ))}
        </div>

        {/* == TAB: vani / info == */}
        <div style={{ display: "flex", borderBottom: `1px solid ${T.bdr}`, margin: "0 0 0 0" }}>
          {[{k:"sopralluoghi",l:`ü™ü Vani (${vaniList.length})`},{k:"info",l:"‚Ñπ Info rilievo"}].map(t => (
            <div key={t.k} onClick={() => setCmSubTab(t.k)} style={{
              flex: 1, padding: "8px 4px", textAlign: "center", fontSize: 12, fontWeight: 600, cursor: "pointer",
              borderBottom: `2px solid ${cmSubTab === t.k ? T.acc : "transparent"}`,
              color: cmSubTab === t.k ? T.acc : T.sub
            }}>{t.l}</div>
          ))}
        </div>

        {/* == TAB VANI (lista vani del rilievo) == */}
        {cmSubTab === "sopralluoghi" && (
          <div style={{ padding: "0 16px 14px" }}>
            {vaniList.length === 0 ? (
              <div style={{ textAlign: "center", padding: "28px 16px" }}>
                <div style={{ fontSize: 36, marginBottom: 10 }}>ü™ü</div>
                <div style={{ fontSize: 14, fontWeight: 700, color: T.text, marginBottom: 6 }}>Nessun vano in questo rilievo</div>
                <div style={{ fontSize: 12, color: T.sub, marginBottom: 18 }}>Aggiungi i vani da misurare</div>
                <button onClick={() => setShowModal("vano")} style={{ ...S.btn, margin: "0 auto" }}>+ Aggiungi vano</button>
              </div>
            ) : vaniList.map(v => {
              const nMisure = Object.values(v.misure||{}).filter(x=>(x as number)>0).length;
              const completo = nMisure >= 6;
              const bloccato = v.note?.startsWith("üî¥ BLOCCATO");
              const colore = bloccato ? T.red : completo ? T.grn : T.orange;
              return (
                <div key={v.id} onClick={() => { setSelectedVano(v); setVanoStep(0); }}
                  style={{ ...S.card, marginBottom: 8, padding: "12px 14px", cursor: "pointer",
                    display: "flex", alignItems: "center", gap: 12,
                    borderLeft: `3px solid ${colore}` }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ display:"flex", alignItems:"center", gap:6, marginBottom:2 }}>
                      <span style={{ fontSize: 13, fontWeight: 700 }}>{v.nome}</span>
                      {/* Badge rilievo di appartenenza */}
                      {(() => {
                        const rIdx = c.rilievi?.findIndex(r => r.vani?.some(vv => vv.id === v.id));
                        if (rIdx < 0) return null;
                        const ril = c.rilievi[rIdx];
                        const questoBloccato = v.note?.startsWith("üî¥ BLOCCATO");
                        const questoIncompleto = !questoBloccato && Object.values(v.misure||{}).filter(x=>(x as number)>0).length > 0 && Object.values(v.misure||{}).filter(x=>(x as number)>0).length < 6;
                        const haProblema = questoBloccato || questoIncompleto;
                        return (
                          <span style={{
                            fontSize: 9, fontWeight: 800, borderRadius: 6, padding: "1px 6px",
                            background: haProblema ? T.redLt : T.bg,
                            color: haProblema ? T.red : T.sub,
                            border: `1px solid ${haProblema ? T.red+"40" : T.bdr}`
                          }}>
                            R{rIdx + 1} ¬∑ {ril.data || ril.dataRilievo || "‚Äî"}
                            {haProblema && " ‚ö†"}
                          </span>
                        );
                      })()}
                    </div>
                    <div style={{ fontSize: 11, color: T.sub }}>{v.tipo} ¬∑ {v.stanza} ¬∑ {v.piano}</div>
                    {bloccato && <div style={{ fontSize: 11, color: T.red, marginTop: 2 }}>{v.note?.replace("üî¥ BLOCCATO: ","")}</div>}
                  </div>
                  <div style={{ textAlign: "right", display:"flex", flexDirection:"column", alignItems:"flex-end", gap:4 }}>
                    {/* Badge pezzi */}
                    <span style={{ fontSize:12, fontWeight:800, color:"#fff",
                      background: bloccato ? T.red : completo ? T.grn : T.orange,
                      borderRadius:8, padding:"2px 8px", minWidth:28, textAlign:"center" }}>
                      {v.pezzi||1} pz
                    </span>
                    {bloccato
                      ? <span style={S.badge(T.redLt, T.red)}>üî¥ Bloccato</span>
                      : completo
                      ? <span style={S.badge(T.grnLt, T.grn)}>‚úÖ {nMisure} mis.</span>
                      : <span style={S.badge(T.orangeLt, T.orange)}>‚ö† {nMisure} mis.</span>}
                  </div>
                  <span style={{ color: T.sub, fontSize: 14 }}>‚Ä∫</span>
                </div>
              );
            })}
            {vaniList.length > 0 && (
              <div onClick={() => setShowModal("vano")}
                style={{ ...S.card, padding: "11px 14px", marginTop: 6, cursor: "pointer",
                  border: `1px dashed ${T.bdr}`, background: "transparent",
                  display: "flex", alignItems: "center", gap: 10, justifyContent: "center" }}>
                <span style={{ fontSize: 18, color: T.acc }}>+</span>
                <span style={{ fontSize: 13, fontWeight: 600, color: T.acc }}>Aggiungi vano</span>
              </div>
            )}
          </div>
        )}

        {/* == TAB MISURE (stato per vano) == */}
        {vaniList.length > 0 && cmSubTab === "misure_tab" && (
          <div style={{ padding: "14px 16px" }}>
            <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 10 }}>Stato per vano</div>
            {vaniList.map(v => {
              const mis = vaniM.includes(v.id);
              const blk = !mis && ulB(v.id);
              let daV = null;
              for (let i = viste.length - 1; i >= 0; i--) {
                if (viste[i].vaniMisurati?.includes(v.id)) { daV = viste[i]; break; }
              }
              return (
                <div key={v.id} style={{ ...S.card, marginBottom: 8 }}>
                  <div style={{ padding: "11px 14px", display: "flex", alignItems: "center", gap: 12 }}>
                    <div style={{ width: 36, height: 36, borderRadius: 8, flexShrink: 0, background: mis ? T.grnLt : blk ? T.redLt : T.bdr, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18 }}>
                      {mis ? "‚úÖ" : blk ? "üî¥" : "‚è≥"}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 3 }}>
                        <div style={{ fontSize: 14, fontWeight: 700 }}>{v.nome}</div>
                        <span style={{ fontSize: 10, color: T.sub }}>~{v.mq}m¬≤</span>
                      </div>
                      {mis && daV && <div style={{ fontSize: 11, color: T.sub }}>{daV.n}¬™ visita ¬∑ {new Date(daV.data + "T12:00:00").toLocaleDateString("it-IT", { day: "numeric", month: "short" })}</div>}
                      {!mis && blk && <div style={{ fontSize: 11, color: T.red }}>{blk.motivo}{blk.note && <span style={{ color: T.sub }}> ‚Äî {blk.note}</span>}</div>}
                      {!mis && !blk && <div style={{ fontSize: 11, color: T.sub }}>Non ancora visitato</div>}
                    </div>
                    {!mis && <span style={{ ...S.badge(T.redLt, T.red), flexShrink: 0, fontSize: 9 }}>DA FARE</span>}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* == TAB INFO RILIEVO == */}
        {cmSubTab === "info" && (
          <div style={{ padding: "14px 16px" }}>
            {/* Info rilievo */}
            <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 8 }}>Dettagli Rilievo</div>
            {[
              ["Tipo",       tipoLblRil],
              ["Data",       r?.data ? new Date(r.data + "T12:00:00").toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long", year:"numeric" }) : "‚Äî"],
              ["Ora",        r?.ora || "‚Äî"],
              ["Rilevatore", r?.rilevatore || "‚Äî"],
              ["N. vani",    `${vaniList.length} vani`],
              ["Avanzamento",`${progVani}% (${vaniMisurati.length}/${vaniList.length})`],
              ...(r?.motivoModifica ? [["Motivo", r.motivoModifica]] : []),
              ...(r?.note ? [["Note", r.note]] : []),
            ].map(([k, v]) => (
              <div key={k} style={{ ...S.card, padding: "11px 14px", marginBottom: 6, display: "flex", justifyContent: "space-between", alignItems: "center", gap: 8 }}>
                <div style={{ fontSize: 12, color: T.sub, fontWeight: 600, flexShrink: 0 }}>{k}</div>
                <div style={{ fontSize: 12, fontWeight: 600, textAlign: "right" }}>{v}</div>
              </div>
            ))}
            <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 8, marginTop: 16 }}>Commessa</div>
            {[
              ["Cliente",   `${c.cliente} ${c.cognome || ""}`],
              ["Codice",    c.code],
              ["Indirizzo", c.indirizzo],
              ["Telefono",  c.telefono || "‚Äî"],
              ["Sistema",   c.sistema || "‚Äî"],
              ...(c.euro ? [["Importo", `‚Ç¨${c.euro.toLocaleString("it-IT")}`]] : []),
              ["Rilievi",   `${(c.rilievi||[]).length} totali`],
            ].map(([k, v]) => (
              <div key={k} style={{ ...S.card, padding: "11px 14px", marginBottom: 6, display: "flex", justifyContent: "space-between", alignItems: "center", gap: 8 }}>
                <div style={{ fontSize: 12, color: T.sub, fontWeight: 600, flexShrink: 0 }}>{k}</div>
                <div style={{ fontSize: 12, fontWeight: 600, textAlign: "right" }}>{v}</div>
              </div>
            ))}
          </div>
        )}

        {/* Hidden file inputs */}
        <input ref={fileInputRef} type="file" style={{display:"none"}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const a={id:Date.now(),tipo:"file",nome:f.name,data:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}),dataUrl:ev.target.result};setCantieri(cs=>cs.map(x=>x.id===selectedCM.id?{...x,allegati:[...(x.allegati||[]),a]}:x));setSelectedCM(p=>({...p,allegati:[...(p.allegati||[]),a]}));};r.readAsDataURL(f);e.target.value="";}}/> 
        <input ref={fotoInputRef} type="file" accept="image/*" capture="environment" style={{display:"none"}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const a={id:Date.now(),tipo:"foto",nome:f.name,data:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}),dataUrl:ev.target.result};setCantieri(cs=>cs.map(x=>x.id===selectedCM.id?{...x,allegati:[...(x.allegati||[]),a]}:x));setSelectedCM(p=>({...p,allegati:[...(p.allegati||[]),a]}));};r.readAsDataURL(f);e.target.value="";}}/> 


        {/* SEGNALA PROBLEMA */}
        <div style={{ padding: "0 16px", marginBottom: 8, display: "flex", gap: 8 }}>
          <button onClick={() => { setProblemaForm({ titolo: "", descrizione: "", tipo: "materiale", priorita: "media", assegnato: "" }); setShowProblemaModal(true); }} style={{ flex: 1, padding: "10px", borderRadius: 10, border: "1.5px solid #FF3B30", background: "#FF3B3008", color: "#FF3B30", fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: FF, display: "flex", alignItems: "center", justifyContent: "center", gap: 6, position: "relative" }}>
            üö® Segnala problema
            {problemi.filter(p => p.commessaId === c.id && p.stato !== "risolto").length > 0 && <span style={{ position: "absolute", top: -4, right: -4, minWidth: 18, height: 18, borderRadius: "50%", background: "#FF3B30", color: "#fff", fontSize: 10, fontWeight: 900, display: "flex", alignItems: "center", justifyContent: "center", padding: "0 4px" }}>{problemi.filter(p => p.commessaId === c.id && p.stato !== "risolto").length}</span>}
          </button>
          {problemi.filter(p => p.commessaId === c.id).length > 0 && (
            <button onClick={() => { setShowProblemiView(true); }} style={{ padding: "10px 14px", borderRadius: 10, border: `1.5px solid ${T.bdr}`, background: T.card, color: T.text, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: FF, display: "flex", alignItems: "center", gap: 6 }}>
              üìã {problemi.filter(p => p.commessaId === c.id).length}
            </button>
          )}
        </div>

        {/* Allegati / Note / Vocali / Video */}
        <div style={{ padding: "0 16px", marginBottom: 8 }}>
          <div style={{ display: "flex", gap: 6 }}>
            {[
              { ico: "üìé", label: "File", act: () => fileInputRef.current?.click() },
              { ico: "üì∑", label: "Foto", act: () => fotoInputRef.current?.click() },
              { ico: "üìù", label: "Nota", act: () => { setShowAllegatiModal("nota"); setAllegatiText(""); }},
              { ico: "üé§", label: "Vocale", act: () => { setShowAllegatiModal("vocale"); }},
              { ico: "üé¨", label: "Video", act: () => { setShowAllegatiModal("video"); }},
            ].map((b, i) => (
              <div key={i} onClick={b.act} style={{ flex: 1, padding: "10px 4px", background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, textAlign: "center", cursor: "pointer" }}>
                <div style={{ fontSize: 18 }}>{b.ico}</div>
                <div style={{ fontSize: 10, fontWeight: 600, color: T.sub, marginTop: 2 }}>{b.label}</div>
              </div>
            ))}
          </div>
          {/* Lista allegati */}
          {(c.allegati || []).length > 0 && (
            <div style={{ marginTop: 6, background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, overflow: "hidden" }}>
              {(c.allegati || []).map(a => (
                <div key={a.id} style={{ borderBottom: `1px solid ${T.bg}` }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px" }}>
                    <span style={{ fontSize: 16 }}>{a.tipo === "nota" ? "üìù" : a.tipo === "vocale" ? "üé§" : a.tipo === "video" ? "üé¨" : a.tipo === "foto" ? "üì∑" : "üìé"}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 12, fontWeight: 600, color: T.text }}>{a.nome}</div>
                      <div style={{ fontSize: 10, color: T.sub }}>{a.data}{a.durata ? ` ¬∑ ${a.durata}` : ""}</div>
                    </div>
                    {/* Audio: play inline */}
                    {a.tipo === "vocale" && (
                      <div onClick={() => playAllegato(a.id)} style={{ padding: "3px 8px", borderRadius: 6, background: playingId === a.id ? T.redLt : T.accLt, fontSize: 10, fontWeight: 600, color: playingId === a.id ? T.red : T.acc, cursor: "pointer" }}>
                        {playingId === a.id ? "‚è∏ Stop" : "‚ñ∂ Play"}
                      </div>
                    )}
                    {/* Video: open/close inline player */}
                    {a.tipo === "video" && a.dataUrl && (
                      <div onClick={() => setViewingVideoId(viewingVideoId === a.id ? null : a.id)} style={{ padding: "3px 8px", borderRadius: 6, background: viewingVideoId === a.id ? T.blueLt : T.accLt, fontSize: 10, fontWeight: 600, color: viewingVideoId === a.id ? T.blue : T.acc, cursor: "pointer" }}>
                        {viewingVideoId === a.id ? "‚úï Chiudi" : "‚ñ∂ Guarda"}
                      </div>
                    )}
                    {a.tipo === "video" && a.dataUrl && (
                      <a href={a.dataUrl} download={a.nome || "video.webm"} style={{ padding: "3px 8px", borderRadius: 6, background: T.bg, fontSize: 10, fontWeight: 600, color: T.sub, cursor: "pointer", textDecoration: "none" }}>‚¨á</a>
                    )}
                    {/* Photo: toggle inline preview */}
                    {a.tipo === "foto" && a.dataUrl && (
                      <div onClick={() => setViewingPhotoId(viewingPhotoId === a.id ? null : a.id)} style={{ padding: "3px 8px", borderRadius: 6, background: T.accLt, fontSize: 10, fontWeight: 600, color: T.acc, cursor: "pointer" }}>
                        {viewingPhotoId === a.id ? "‚úï Chiudi" : "üëÅ Vedi"}
                      </div>
                    )}
                    {a.tipo === "foto" && a.dataUrl && <img src={a.dataUrl} style={{ width: 44, height: 44, objectFit: "cover", borderRadius: 6, flexShrink: 0 }} alt="" />}
                    {a.tipo === "file" && a.dataUrl && <a href={a.dataUrl} download={a.nome} style={{ padding: "3px 8px", borderRadius: 6, background: T.accLt, fontSize: 10, fontWeight: 600, color: T.acc, cursor: "pointer", textDecoration: "none" }}>üìÇ Apri</a>}
                    {/* Delete */}
                    <div onClick={() => { setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, allegati: (x.allegati || []).filter(al => al.id !== a.id) } : x)); setSelectedCM(p => ({ ...p, allegati: (p.allegati || []).filter(al => al.id !== a.id) })); }} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={12} c={T.sub} /></div>
                  </div>
                  {/* Audio progress bar */}
                  {a.tipo === "vocale" && playingId === a.id && (
                    <div style={{ height: 3, background: T.bdr, margin: "0 12px 6px" }}>
                      <div style={{ height: "100%", background: T.acc, borderRadius: 2, width: `${playProgress}%`, transition: "width 0.1s linear" }} />
                    </div>
                  )}
                  {/* Inline VIDEO player */}
                  {a.tipo === "video" && viewingVideoId === a.id && a.dataUrl && (
                    <div style={{ padding: "6px 12px 10px" }}>
                      <video src={a.dataUrl} controls playsInline autoPlay
                        style={{ width: "100%", maxHeight: 280, borderRadius: 10, background: "#000" }} />
                    </div>
                  )}
                  {/* Inline PHOTO full preview */}
                  {a.tipo === "foto" && viewingPhotoId === a.id && a.dataUrl && (
                    <div style={{ padding: "6px 12px 10px" }}>
                      <img src={a.dataUrl} style={{ width: "100%", borderRadius: 10 }} alt={a.nome} />
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Vani */}
        <div style={S.section}>
          <div style={S.sectionTitle}>Vani R{r?.n} ({vaniList.length})</div>
          <button style={S.sectionBtn} onClick={() => {
              if (!selectedCM) return;
              const tipObj = TIPOLOGIE_RAPIDE[0];
              if (!selectedRilievo) return;
              const v = { id: Date.now(), nome: `Vano ${(selectedRilievo.vani?.length||0)+1}`, tipo: "F1A", stanza: "Soggiorno", piano: "PT", sistema: "", coloreInt: "", coloreEst: "", bicolore: false, coloreAcc: "", vetro: "", telaio: "", telaioAlaZ: "", rifilato: false, rifilSx: "", rifilDx: "", rifilSopra: "", rifilSotto: "", coprifilo: "", lamiera: "", difficoltaSalita: "", mezzoSalita: "", misure: {}, foto: {}, note: "", cassonetto: false, accessori: { tapparella: { attivo: false }, persiana: { attivo: false }, zanzariera: { attivo: false } } };
              const updR1 = { ...selectedRilievo, vani: [...(selectedRilievo.vani||[]), v] };
              setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo.id ? updR1 : r2), aggiornato: "Oggi" } : c));
              setSelectedRilievo(updR1);
              setSelectedCM(prev => ({ ...prev, rilievi: prev.rilievi.map(r2 => r2.id === selectedRilievo.id ? updR1 : r2) }));
              setSelectedVano(v);
              setVanoStep(0);
            }}>+ Nuovo vano</button>
        </div>
        <div style={{ padding: "0 16px", ...((isTablet || isDesktop) && vaniList.length > 0 ? { display: "grid", gridTemplateColumns: isDesktop ? "1fr 1fr 1fr" : "1fr 1fr", gap: 8 } : {}) }}>
          {vaniList.length === 0 ? (
            <div onClick={() => {
              if (!selectedCM) return;
              const v = { id: Date.now(), nome: `Vano 1`, tipo: "F1A", stanza: "Soggiorno", piano: "PT", sistema: "", coloreInt: "", coloreEst: "", bicolore: false, coloreAcc: "", vetro: "", telaio: "", telaioAlaZ: "", rifilato: false, rifilSx: "", rifilDx: "", rifilSopra: "", rifilSotto: "", coprifilo: "", lamiera: "", difficoltaSalita: "", mezzoSalita: "", misure: {}, foto: {}, note: "", cassonetto: false, accessori: { tapparella: { attivo: false }, persiana: { attivo: false }, zanzariera: { attivo: false } } };
              if (selectedRilievo) { const updR2 = { ...selectedRilievo, vani: [...(selectedRilievo.vani||[]), v] }; setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo.id ? updR2 : r2) } : c)); setSelectedRilievo(updR2); setSelectedCM(prev => ({ ...prev, rilievi: prev.rilievi.map(r2 => r2.id === selectedRilievo.id ? updR2 : r2) })); }
              setSelectedVano(v);
              setVanoStep(0);
            }} style={{ padding: "20px", textAlign: "center", background: T.card, borderRadius: T.r, border: `1px dashed ${T.bdr}`, cursor: "pointer", color: T.sub, fontSize: 13 }}>
              Nessun vano. Tocca per aggiungerne uno.
            </div>
          ) : vaniList.map(v => {
            const filled = Object.values(v.misure || {}).filter(x => (x as number) > 0).length;
            const total = 8;
            const fotoCount = Object.values(v.foto || {}).filter(Boolean).length;
            return (
              <div key={v.id} style={{ ...S.card, margin: "0 0 8px" }} onClick={() => setSelectedVano(v)}>
                <div style={S.cardInner}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <div style={{ width: 36, height: 36, borderRadius: 8, background: T.accLt, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, flexShrink: 0 }}>
                        {TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo)?.icon || "ü™ü"}
                      </div>
                      <div>
                        <div style={{ fontSize: 14, fontWeight: 600 }}>{v.nome}</div>
                        <div style={{ fontSize: 11, color: T.sub }}>{TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo)?.label || v.tipo} ¬∑ {v.stanza} ¬∑ {v.piano}</div>
                      </div>
                    </div>
                    <div style={{ textAlign: "right", display: "flex", alignItems: "center", gap: 8 }}>
                      <div style={{ fontSize: 12, fontWeight: 700, color: filled >= 6 ? T.grn : T.orange }}>{filled}/{total}<div style={{ fontSize: 10, color: T.sub, fontWeight: 400 }}>misure</div></div>
                      <div onClick={e => { e.stopPropagation(); deleteVano(v.id); }} style={{ width: 28, height: 28, borderRadius: 6, display: "flex", alignItems: "center", justifyContent: "center", background: T.redLt, cursor: "pointer" }}><Ico d={ICO.trash} s={13} c={T.red} /></div>
                    </div>
                  </div>
                  {/* Tags */}
                  <div style={{ display: "flex", gap: 4, marginTop: 6, flexWrap: "wrap" }}>
                    {fotoCount > 0 && <span style={S.badge(T.blueLt, T.blue)}>{fotoCount} foto</span>}
                    {v.controtelaio?.tipo && <span style={S.badge("#dbeafe", "#2563eb")}>üî≤ CT {v.controtelaio.tipo==="singolo"?"Sing.":v.controtelaio.tipo==="doppio"?"Doppio":"Cass."}</span>}
                    {v.cassonetto && <span style={S.badge(T.orangeLt, T.orange)}>Cassonetto</span>}
                    {v.accessori?.tapparella?.attivo && <span style={S.badge(T.grnLt, T.grn)}>Tapparella</span>}
                    {v.accessori?.zanzariera?.attivo && <span style={S.badge(T.purpleLt, T.purple)}>Zanzariera</span>}
                    {v.vociLibere?.length > 0 && <span style={S.badge("#fff3e0", "#ff9500")}>üì¶ {v.vociLibere.length} voci</span>}
                    {v.note && <span style={S.badge(T.cyanLt, T.cyan)}>Note</span>}
                  </div>
                  {/* Progress bar */}
                  <div style={{ height: 3, background: T.bdr, borderRadius: 2, marginTop: 8 }}>
                    <div style={{ height: "100%", borderRadius: 2, background: filled >= 6 ? T.grn : T.acc, width: `${(filled / total) * 100}%` }} />
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Timeline/Log */}
        {c.log && c.log.length > 0 && (
          <>
            <div style={{ ...S.section, marginTop: 8 }}>
              <div style={S.sectionTitle}>Cronologia</div>
            </div>
            <div style={{ padding: "0 16px" }}>
              {c.log.map((l, i) => (
                <div key={i} style={{ display: "flex", gap: 10, padding: "8px 0" }}>
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                    <div style={{ width: 8, height: 8, borderRadius: "50%", background: l.color, flexShrink: 0 }} />
                    {i < c.log.length - 1 && <div style={{ width: 1, flex: 1, background: T.bdr, marginTop: 4 }} />}
                  </div>
                  <div>
                    <div style={{ fontSize: 12, color: T.text, lineHeight: 1.3 }}><strong>{l.chi}</strong> {l.cosa}</div>
                    <div style={{ fontSize: 10, color: T.sub2, marginTop: 1 }}>{l.quando}</div>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        {/* Chiudi + Elimina */}
        <div style={{ padding: "16px", display: "flex", flexDirection: "column", alignItems: "center", gap: 12 }}>
          {c.fase !== "chiusura" && (
            <button onClick={() => { if(confirm("Chiudi commessa " + c.code + "?")) setFaseTo(c.id, "chiusura"); }}
              style={{ padding: "10px 24px", borderRadius: 10, border: "2px solid #34c759", background: "#34c75912", color: "#34c759", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit", width: "100%" }}>
              ‚úÖ Chiudi Commessa
            </button>
          )}
          {c.fase === "chiusura" && <div style={{ fontSize: 12, fontWeight: 700, color: T.grn }}>‚úÖ Commessa chiusa</div>}
          <span onClick={() => deleteCommessa(c.id)} style={{ fontSize: 11, color: T.sub2, cursor: "pointer", textDecoration: "underline" }}>Elimina commessa</span>
        </div>
      </div>
    );
  };

  /* == RIEPILOGO COMMESSA ‚Äî SCHERMATA INVIO == */

  /* ===============================================
     PANNELLI DI FASE ‚Äî renderFasePanel(c)
     Appare nella commessa detail, sotto la pipeline
     Un pannello specifico per ogni fase
  =============================================== */
  const renderFasePanel = (c) => {
    const fi = faseIndex(c.fase);
    const nextFase = PIPELINE[fi + 1];
    const fase = PIPELINE[fi];

    // Helper: aggiorna campo dentro la commessa selezionata
    const updateCM = (field, val) => {
      setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, [field]: val } : x));
      setSelectedCM(prev => ({ ...prev, [field]: val }));
    };
    const updateCMNested = (obj) => {
      setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, ...obj } : x));
      setSelectedCM(prev => ({ ...prev, ...obj }));
    };

    // Chip checklist riusabile
    const Chip = ({ label, done, onClick }) => (
      <div onClick={onClick} style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 12px",
        borderRadius:8, border:`1.5px solid ${done ? T.grn : T.bdr}`, background: done ? T.grn+"12" : T.card,
        cursor:"pointer", marginBottom:6 }}>
        <div style={{ width:18, height:18, borderRadius:"50%", border:`2px solid ${done ? T.grn : T.bdr}`,
          background: done ? T.grn : "transparent", display:"flex", alignItems:"center", justifyContent:"center",
          flexShrink:0 }}>
          {done && <span style={{fontSize:10,color:"white",fontWeight:800}}>‚úì</span>}
        </div>
        <span style={{fontSize:12, fontWeight:600, color: done ? T.grn : T.text}}>{label}</span>
      </div>
    );

    // Campo input riusabile ‚Äî defaultValue+onBlur per evitare focus loss
    const Field = ({ label, field, placeholder, type="text" }) => (
      <div style={{marginBottom:8}}>
        <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3,textTransform:"uppercase",letterSpacing:"0.05em"}}>{label}</div>
        <input type={type} placeholder={placeholder||""} defaultValue={c[field]||""}
          key={`${c.id}-${field}`}
          onBlur={e => { const v = e.target.value; if (v !== (c[field]||"")) updateCM(field, v); }}
          style={{width:"100%",padding:"9px 12px",borderRadius:8,border:`1px solid ${T.bdr}`,
            background:T.card,fontSize:13,color:T.text,fontFamily:FF,boxSizing:"border-box"}}/>
      </div>
    );

    const panelStyle = {
      margin:"0 16px 12px", borderRadius:12, border:`1.5px solid ${fase?.color}30`,
      background:T.card, overflow:"hidden"
    };
    const headerStyle = {
      padding:"10px 14px", background:fase?.color+"15", borderBottom:`1px solid ${fase?.color}25`,
      display:"flex", alignItems:"center", gap:8
    };

    // Toggle accordion per id fase
    const isOpen = (id) => fasePanelOpen[id] !== false; // default aperto
    const togglePanel = (id) => setFasePanelOpen(s => ({...s, [id]: !isOpen(id)}));

    // Wrapper accordion semplice ‚Äî stessa UI di prima, solo con toggle
    const FasePanel = ({ id, children, taskNonFatti = 0 }) => (
      <div style={panelStyle}>
        <div onClick={() => togglePanel(id)} style={{ ...headerStyle, cursor:"pointer",
          borderBottom: isOpen(id) ? `1px solid ${fase?.color}25` : "none", userSelect:"none" }}>
          {/* Contenuto header originale passato come primo child */}
          <div style={{display:"flex",alignItems:"center",gap:8,flex:1,pointerEvents:"none"}}>
            {(children as any[])[0]}
          </div>
          {/* Badge alert se task non completati */}
          {taskNonFatti > 0 && (
            <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6,flexShrink:0}}/>
          )}
          <span style={{fontSize:13,color:T.sub,transform:isOpen(id)?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s",flexShrink:0}}>‚ñæ</span>
        </div>
        {isOpen(id) && (
          <div style={{padding:"12px 14px"}}>
            {(children as any[]).slice(1)}
          </div>
        )}
      </div>
    );

    // === SOPRALLUOGO ===
    if (c.fase === "sopralluogo") {
      const vaniAttivi2 = getVaniAttivi(c); const vaniCompletati = vaniAttivi2.filter(v => Object.values(v.misure||{}).filter(x=>(x as number)>0).length >= 6).length;
      const tuttiCompletati = vaniCompletati === vaniAttivi2.length && vaniAttivi2.length > 0;
      const ndone = [!c.ck_foto, !c.ck_accesso, !c.ck_riepilogo_inviato, !tuttiCompletati].filter(Boolean).length;
      const open_sopr = fasePanelOpen["sopralluogo"] !== false;
      return (
        <div style={panelStyle}>
          <div onClick={()=>togglePanel("sopralluogo")} style={{...headerStyle,cursor:"pointer",borderBottom:open_sopr?`1px solid ${fase?.color}25`:"none",userSelect:"none"}}>
            <span style={{fontSize:16}}>üîç</span>
            <span style={{fontSize:13,fontWeight:700,color:T.text,flex:1}}>Sopralluogo</span>
            <span style={{fontSize:11,fontWeight:700,color:tuttiCompletati?T.grn:T.orange,marginRight:4}}>{vaniCompletati}/{vaniAttivi2.length} vani ‚úì</span>
            {ndone>0 && <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6}}/>}
            <span style={{fontSize:13,color:T.sub,transform:open_sopr?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s"}}>‚ñæ</span>
          </div>
          {open_sopr && <div style={{padding:"12px 14px"}}>
            <Chip label="Fotografie scattate" done={c.ck_foto} onClick={()=>updateCM("ck_foto",!c.ck_foto)}/>
            <Chip label="Difficolt√† accesso rilevata" done={c.ck_accesso} onClick={()=>updateCM("ck_accesso",!c.ck_accesso)}/>
            <Chip label="Riepilogo inviato al cliente" done={c.ck_riepilogo_inviato} onClick={()=>updateCM("ck_riepilogo_inviato",!c.ck_riepilogo_inviato)}/>
            <Chip label={`Tutte le misure inserite (${vaniCompletati}/${vaniAttivi2.length})`} done={tuttiCompletati} onClick={()=>{}}/>
            <Field label="Data sopralluogo" field="dataSopralluogo" type="date"/>
            <Field label="Note sopralluogo" field="noteSopralluogo" placeholder="Annotazioni rapide..."/>
            {tuttiCompletati && (
              <div style={{marginTop:8,padding:"10px 12px",borderRadius:8,background:T.grn+"15",border:`1px solid ${T.grn}30`,fontSize:12,color:T.grn,fontWeight:600,textAlign:"center"}}>
                ‚úÖ Pronto per il preventivo
              </div>
            )}
          </div>}
        </div>
      );
    }

    // === PREVENTIVO ===
    if (c.fase === "preventivo") {
      const vaniCalc = getVaniAttivi(c); const totale = vaniCalc.reduce((sum, v) => sum + calcolaVanoPrezzo(v, c), 0);
      const iva = totale * 0.1;
      return (
        <div style={panelStyle}>
          <div style={headerStyle}>
            <span style={{fontSize:16}}>üìã</span>
            <span style={{fontSize:13,fontWeight:700,color:T.text}}>Preventivo</span>
          </div>
          <div style={{padding:"12px 14px"}}>
            <Field label="Prezzo base ‚Ç¨/mq" field="prezzoMq" placeholder="350" type="number"/>
            <Field label="Sconto %" field="sconto" placeholder="0" type="number"/>
            <Field label="Note preventivo" field="notePreventivo" placeholder="Condizioni, garanzie..."/>
            <div style={{padding:"10px 12px",borderRadius:8,background:T.bg,border:`1px solid ${T.bdr}`,marginBottom:8}}>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:T.sub,marginBottom:4}}>
                <span>Totale imponibile</span><span style={{fontWeight:700,color:T.text}}>‚Ç¨ {totale.toFixed(2)}</span>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:T.sub,marginBottom:4}}>
                <span>IVA 10%</span><span>‚Ç¨ {iva.toFixed(2)}</span>
              </div>
              {c.sconto > 0 && (
                <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:T.orange,marginBottom:4}}>
                  <span>Sconto {c.sconto}%</span><span>- ‚Ç¨ {(totale * c.sconto/100).toFixed(2)}</span>
                </div>
              )}
              <div style={{borderTop:`1px solid ${T.bdr}`,marginTop:6,paddingTop:6,display:"flex",justifyContent:"space-between",fontSize:14,fontWeight:800}}>
                <span>TOTALE IVA inclusa</span>
                <span style={{color:T.acc}}>‚Ç¨ {(totale + iva - (totale*(c.sconto||0)/100)).toFixed(2)}</span>
              </div>
            </div>
            <Chip label="Preventivo inviato al cliente" done={c.ck_prev_inviato} onClick={()=>updateCM("ck_prev_inviato",!c.ck_prev_inviato)}/>
            <Chip label="Cliente ha accettato verbalmente" done={c.ck_prev_accettato} onClick={()=>updateCM("ck_prev_accettato",!c.ck_prev_accettato)}/>
          </div>
        </div>
      );
    }

    // === CONFERMA ===
    if (c.fase === "conferma") {
      return (
        <div style={panelStyle}>
          <div style={headerStyle}>
            <span style={{fontSize:16}}>‚úçÔ∏è</span>
            <span style={{fontSize:13,fontWeight:700,color:T.text}}>Conferma Ordine</span>
          </div>
          <div style={{padding:"12px 14px"}}>
            <Field label="Data conferma" field="dataConferma" type="date"/>
            <Field label="Acconto ricevuto ‚Ç¨" field="accontoRicevuto" placeholder="0" type="number"/>
            <Field label="Metodo pagamento" field="metodoPagamento" placeholder="Bonifico / Contanti / Carta..."/>
            <Field label="Data prevista posa" field="dataPosaPrevista" type="date"/>
            <Chip label="Contratto firmato" done={c.ck_contratto} onClick={()=>updateCM("ck_contratto",!c.ck_contratto)}/>
            <Chip label="Acconto incassato" done={c.ck_acconto_inc} onClick={()=>updateCM("ck_acconto_inc",!c.ck_acconto_inc)}/>
            <Chip label="Data posa concordata" done={c.ck_data_posa} onClick={()=>updateCM("ck_data_posa",!c.ck_data_posa)}/>
          </div>
        </div>
      );
    }

    // === MISURE ===
    if (c.fase === "misure") {
      const vaniCalc = getVaniAttivi(c);
      const vaniOk = vaniCalc.filter(v => Object.values(v.misure||{}).filter(x=>(x as number)>0).length >= 9).length;
      return (
        (() => {
          const ndone = [!c.ck_misure_ok,!c.ck_diag_ok,!c.ck_pdf_prod,!c.ck_sistema_ok].filter(Boolean).length;
          const open = fasePanelOpen["misure"] !== false;
          return (
            <div style={panelStyle}>
              <div onClick={()=>togglePanel("misure")} style={{...headerStyle,cursor:"pointer",borderBottom:open?`1px solid ${fase?.color}25`:"none",userSelect:"none"}}>
                <span style={{fontSize:16}}>üìê</span>
                <span style={{fontSize:13,fontWeight:700,color:T.text,flex:1}}>Rilievo Misure Definitivo</span>
                <span style={{fontSize:11,fontWeight:700,color:vaniOk===vaniCalc.length?T.grn:T.orange,marginRight:4}}>{vaniOk}/{vaniCalc.length}</span>
                {ndone>0 && <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6}}/>}
                <span style={{fontSize:13,color:T.sub,transform:open?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s"}}>‚ñæ</span>
              </div>
              {open && <div style={{padding:"12px 14px"}}>
                <Chip label="Tutte le misure verificate" done={c.ck_misure_ok} onClick={()=>updateCM("ck_misure_ok",!c.ck_misure_ok)}/>
                <Chip label="Diagonali controllate" done={c.ck_diag_ok} onClick={()=>updateCM("ck_diag_ok",!c.ck_diag_ok)}/>
                <Chip label="Riepilogo PDF inviato a produzione" done={c.ck_pdf_prod} onClick={()=>updateCM("ck_pdf_prod",!c.ck_pdf_prod)}/>
                <Chip label="Conferma sistema/colori approvata" done={c.ck_sistema_ok} onClick={()=>updateCM("ck_sistema_ok",!c.ck_sistema_ok)}/>
                <Field label="Tecnico misuratore" field="tecnicoMisure" placeholder="Nome tecnico..."/>
                <Field label="Data rilievo definitivo" field="dataRilievo" type="date"/>
              </div>}
            </div>
          );
        })()
      );
    }

    // === ORDINI ===
    if (c.fase === "ordini") {
      return (
        (() => {
          const ndone = [!c.ck_ordine_inviato,!c.ck_ordine_confermato,!c.ck_cliente_avvisato].filter(Boolean).length;
          const open = fasePanelOpen["ordini"] !== false;
          return (
            <div style={panelStyle}>
              <div onClick={()=>togglePanel("ordini")} style={{...headerStyle,cursor:"pointer",borderBottom:open?`1px solid ${fase?.color}25`:"none",userSelect:"none"}}>
                <span style={{fontSize:16}}>üì¶</span>
                <span style={{fontSize:13,fontWeight:700,color:T.text,flex:1}}>Ordini Fornitore</span>
                {ndone>0 && <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6}}/>}
                <span style={{fontSize:13,color:T.sub,transform:open?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s"}}>‚ñæ</span>
              </div>
              {open && <div style={{padding:"12px 14px"}}>
                <Field label="Fornitore" field="fornitore" placeholder="Es. Sch√ºco, Rehau..."/>
                <Field label="N¬∞ Ordine fornitore" field="numOrdine" placeholder="ORD-2026-XXXX"/>
                <Field label="Data ordine" field="dataOrdine" type="date"/>
                <Field label="Data consegna prevista" field="dataConsegna" type="date"/>
                <Chip label="Ordine inviato" done={c.ck_ordine_inviato} onClick={()=>updateCM("ck_ordine_inviato",!c.ck_ordine_inviato)}/>
                <Chip label="Conferma ricezione da fornitore" done={c.ck_ordine_confermato} onClick={()=>updateCM("ck_ordine_confermato",!c.ck_ordine_confermato)}/>
                <Chip label="Materiale in arrivo comunicato al cliente" done={c.ck_cliente_avvisato} onClick={()=>updateCM("ck_cliente_avvisato",!c.ck_cliente_avvisato)}/>
              </div>}
            </div>
          );
        })()
      );
    }

    // === PRODUZIONE ===
    if (c.fase === "produzione") {
      return (
        (() => {
          const ndone = [!c.ck_mat_ricevuto,!c.ck_colori_ok,!c.ck_accessori_ok,!c.ck_posa_confermata].filter(Boolean).length;
          const open = fasePanelOpen["produzione"] !== false;
          return (
            <div style={panelStyle}>
              <div onClick={()=>togglePanel("produzione")} style={{...headerStyle,cursor:"pointer",borderBottom:open?`1px solid ${fase?.color}25`:"none",userSelect:"none"}}>
                <span style={{fontSize:16}}>üè≠</span>
                <span style={{fontSize:13,fontWeight:700,color:T.text,flex:1}}>Produzione</span>
                {ndone>0 && <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6}}/>}
                <span style={{fontSize:13,color:T.sub,transform:open?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s"}}>‚ñæ</span>
              </div>
              {open && <div style={{padding:"12px 14px"}}>
                <Field label="Data consegna in magazzino" field="dataInMagazzino" type="date"/>
                <Chip label="Materiale ricevuto e controllato" done={c.ck_mat_ricevuto} onClick={()=>updateCM("ck_mat_ricevuto",!c.ck_mat_ricevuto)}/>
                <Chip label="Colori verificati" done={c.ck_colori_ok} onClick={()=>updateCM("ck_colori_ok",!c.ck_colori_ok)}/>
                <Chip label="Accessori completi (maniglie, guarnizioni)" done={c.ck_accessori_ok} onClick={()=>updateCM("ck_accessori_ok",!c.ck_accessori_ok)}/>
                <Chip label="Data posa confermata al cliente" done={c.ck_posa_confermata} onClick={()=>updateCM("ck_posa_confermata",!c.ck_posa_confermata)}/>
                <Field label="Note magazzino" field="noteMagazzino" placeholder="Anomalie, sostituzioni..."/>
              </div>}
            </div>
          );
        })()
      );
    }

    // === POSA ===
    if (c.fase === "posa") {
      return (
        (() => {
          const ndone = [!c.ck_posati,!c.ck_finiture,!c.ck_pulizia,!c.ck_test,!c.ck_foto_posa,!c.ck_cliente_ok].filter(Boolean).length;
          const open = fasePanelOpen["posa"] !== false;
          return (
            <div style={panelStyle}>
              <div onClick={()=>togglePanel("posa")} style={{...headerStyle,cursor:"pointer",borderBottom:open?`1px solid ${fase?.color}25`:"none",userSelect:"none"}}>
                <span style={{fontSize:16}}>üîß</span>
                <span style={{fontSize:13,fontWeight:700,color:T.text,flex:1}}>Posa in Opera</span>
                {ndone>0 && <span style={{width:8,height:8,borderRadius:"50%",background:T.red,display:"inline-block",marginRight:6}}/>}
                <span style={{fontSize:13,color:T.sub,transform:open?"rotate(0deg)":"rotate(-90deg)",transition:"transform 0.2s"}}>‚ñæ</span>
              </div>
              {open && <div style={{padding:"12px 14px"}}>
                <Field label="Data posa effettiva" field="dataPosa" type="date"/>
                <Field label="Squadra posatori" field="squadraPosa" placeholder="Marco + Luigi..."/>
                <Chip label="Tutti i vani posati" done={c.ck_posati} onClick={()=>updateCM("ck_posati",!c.ck_posati)}/>
                <Chip label="Sigillature e finiture completate" done={c.ck_finiture} onClick={()=>updateCM("ck_finiture",!c.ck_finiture)}/>
                <Chip label="Pulizia cantiere" done={c.ck_pulizia} onClick={()=>updateCM("ck_pulizia",!c.ck_pulizia)}/>
                <Chip label="Test funzionamento maniglie/chiusure" done={c.ck_test} onClick={()=>updateCM("ck_test",!c.ck_test)}/>
                <Chip label="Foto lavoro completato scattate" done={c.ck_foto_posa} onClick={()=>updateCM("ck_foto_posa",!c.ck_foto_posa)}/>
                <Chip label="Cliente presente e soddisfatto" done={c.ck_cliente_ok} onClick={()=>updateCM("ck_cliente_ok",!c.ck_cliente_ok)}/>
                <Field label="Note posa" field="notePosa" placeholder="Problemi riscontrati, extra..."/>
              </div>}
            </div>
          );
        })()
      );
    }

    // === CHIUSURA ===
    if (c.fase === "chiusura") {
      const vaniCalc2 = getVaniAttivi(c); const totale = vaniCalc2.reduce((sum, v) => {
        const m = v.misure||{};
        const mq = ((m.lCentro||0)/1000) * ((m.hCentro||0)/1000);
        return sum + mq * parseFloat(c.prezzoMq||350);
      }, 0);
      const iva = totale * 0.1;
      const totIva = totale + iva - (totale*(c.sconto||0)/100);
      const saldo = totIva - parseFloat(c.accontoRicevuto||0);
      return (
        <div style={panelStyle}>
          <div style={headerStyle}>
            <span style={{fontSize:16}}>‚úÖ</span>
            <span style={{fontSize:13,fontWeight:700,color:T.text}}>Chiusura Commessa</span>
          </div>
          <div style={{padding:"12px 14px"}}>
            <div style={{padding:"10px 12px",borderRadius:8,background:T.bg,border:`1px solid ${T.bdr}`,marginBottom:10}}>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:12,marginBottom:4}}>
                <span style={{color:T.sub}}>Totale commessa</span><span style={{fontWeight:700}}>‚Ç¨ {totIva.toFixed(2)}</span>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:12,marginBottom:4}}>
                <span style={{color:T.sub}}>Acconto ricevuto</span><span style={{color:T.grn,fontWeight:700}}>- ‚Ç¨ {parseFloat(c.accontoRicevuto||0).toFixed(2)}</span>
              </div>
              <div style={{borderTop:`1px solid ${T.bdr}`,paddingTop:6,marginTop:2,display:"flex",justifyContent:"space-between",fontSize:15,fontWeight:800}}>
                <span>Saldo da incassare</span><span style={{color:saldo>0?T.red:T.grn}}>‚Ç¨ {saldo.toFixed(2)}</span>
              </div>
            </div>
            <Field label="Data chiusura" field="dataChiusura" type="date"/>
            <Field label="Saldo incassato ‚Ç¨" field="saldoIncassato" placeholder="0" type="number"/>
            <Field label="Metodo saldo" field="metodoSaldo" placeholder="Bonifico / Contanti..."/>
            <Chip label="Saldo incassato" done={c.ck_saldo} onClick={()=>updateCM("ck_saldo",!c.ck_saldo)}/>
            <Chip label="Fattura emessa" done={c.ck_fattura} onClick={()=>updateCM("ck_fattura",!c.ck_fattura)}/>
            <Chip label="Garanzia consegnata al cliente" done={c.ck_garanzia} onClick={()=>updateCM("ck_garanzia",!c.ck_garanzia)}/>
            <Chip label="Scheda commessa archiviata" done={c.ck_archiviata} onClick={()=>updateCM("ck_archiviata",!c.ck_archiviata)}/>
            {c.ck_saldo && c.ck_fattura && (
              <div style={{marginTop:8,padding:"12px",borderRadius:8,background:T.grn+"15",border:`1px solid ${T.grn}30`,textAlign:"center"}}>
                <div style={{fontSize:22}}>üéâ</div>
                <div style={{fontSize:13,fontWeight:800,color:T.grn,marginTop:4}}>Commessa completata!</div>
                <div style={{fontSize:11,color:T.sub,marginTop:2}}>{c.code} ¬∑ {c.cliente} {c.cognome||""}</div>
              </div>
            )}
          </div>
        </div>
      );
    }

    return null;
  };

  const renderRiepilogo = () => {
    const c = selectedCM;
    if (!c) return null;
    const today = new Date().toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric"});
    const vaniR = getVaniAttivi(c); const vaniFilled = vaniR.filter(v=>Object.values(v.misure||{}).filter(x=>(x as number)>0).length>=6).length;
    const fuoriSqN = vaniR.filter(v=>{const d=(v.misure?.d1 as number)>0&&(v.misure?.d2 as number)>0?Math.abs(v.misure.d1-v.misure.d2):null;return (d as number)>5;}).length;
    const totPezzi = vaniR.reduce((s,v) => s + (v.pezzi||1), 0);
    const probAperti = problemi.filter(p => p.commessaId === c.id && p.stato !== "risolto");

    // Info rilievo attivo
    const rilAttivo = c.rilievi?.find(r => r.vani?.length > 0);

    const SEP = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
    const waMsg = [
      "üìã *RIEPILOGO COMMESSA "+c.code+"*",
      "üìÖ "+today+" ¬∑ Fase: *"+(PIPELINE.find(p=>p.id===c.fase)?.nome||c.fase).toUpperCase()+"*",
      SEP,
      "",
      "üë§ *CLIENTE*",
      c.cliente+" "+(c.cognome||""),
      c.telefono?"üìû "+c.telefono:"",
      c.email?"üìß "+c.email:"",
      "üìç "+c.indirizzo,
      [c.pianoEdificio?"üè¢ "+c.pianoEdificio:"", c.mezzoSalita?"Salita: "+c.mezzoSalita:"", c.foroScale?"Foro scale: "+c.foroScale:"", c.difficoltaSalita?"Difficolt√†: "+c.difficoltaSalita:""].filter(Boolean).join(" ¬∑ "),
      "",
      "‚öôÔ∏è *CONFIGURAZIONE*",
      c.sistema?"Sistema: *"+c.sistema+"*":"",
      "Tipo: "+(c.tipo==="riparazione"?"Riparazione":"Nuova installazione"),
      "",
      rilAttivo?"üìê *RILIEVO*":"",
      rilAttivo?("Data: "+(rilAttivo.data||rilAttivo.dataRilievo||"‚Äî")+" ¬∑ Rilevatore: "+(rilAttivo.rilevatore||"‚Äî")):"",
      rilAttivo&&rilAttivo.note?"Note rilievo: "+rilAttivo.note:"",
      "",
      "üìä *RIEPILOGO: "+vaniR.length+" vani ¬∑ "+totPezzi+" pezzi totali*",
      vaniFilled < vaniR.length ? "‚ö†Ô∏è "+(vaniR.length - vaniFilled)+" vani incompleti" : "‚úÖ Tutti i vani completi",
      fuoriSqN > 0 ? "‚ö†Ô∏è "+fuoriSqN+" vani fuorisquadra" : "",
      SEP,
      "",
      ...vaniR.map((v,i)=>{
        const m=v.misure||{};
        const tl=TIPOLOGIE_RAPIDE.find(tp=>tp.code===v.tipo)?.label||v.tipo||"‚Äî";
        const diff=m.d1>0&&m.d2>0?Math.abs(m.d1-m.d2):null;
        const fuori=diff!==null&&(diff as number)>5;
        const ct = v.controtelaio || {};
        const lines=[
          SEP,
          "*"+(i+1)+". "+v.nome.toUpperCase()+"*"+(v.pezzi>1?" √ó *"+v.pezzi+" PZ*":""),
          tl+" ¬∑ "+v.tipo+" ¬∑ "+(v.stanza||"‚Äî")+" ¬∑ "+(v.piano||"‚Äî")+" "+(fuori?"‚ö†Ô∏è":"‚úÖ"),
          SEP,
          "",
          "üìè *MISURE VANO*",
          "L: "+(m.lAlto||"‚Äî")+" / *"+(m.lCentro||"‚Äî")+"* / "+(m.lBasso||"‚Äî")+" mm",
          "H: "+(m.hSx||"‚Äî")+" / *"+(m.hCentro||"‚Äî")+"* / "+(m.hDx||"‚Äî")+" mm",
          "",
          (m.d1>0||m.d2>0)?"‚Üó *DIAGONALI*":"",
          (m.d1>0&&m.d2>0)
            ?(fuori?"‚ö†Ô∏è D1: "+m.d1+" / D2: "+m.d2+" ‚Äî *FUORI SQUADRA Œî"+diff+"mm*":"D1: "+m.d1+" / D2: "+m.d2+" ‚úÖ OK")
            :(m.d1>0?"D1: "+m.d1+" (D2 mancante)":""),
          "",
          (m.spSx>0||m.spDx>0||m.spSopra>0||m.spSotto>0)?"‚¨õ *SPALLETTE*":"",
          (m.spSx>0||m.spDx>0||m.spSopra>0||m.spSotto>0)?[
            m.spSx?"Sx: "+m.spSx:"",
            m.spDx?"Dx: "+m.spDx:"",
            m.spSopra?"Sopra: "+m.spSopra:"",
            m.spSotto?"Sotto: "+m.spSotto:"",
          ].filter(Boolean).join(" ¬∑ ")+" mm":"",
          m.davanzale?"ü™® Davanzale: "+m.davanzale+" mm":"",
          m.soglia?"üö™ Soglia: "+m.soglia+" mm":"",
          "",
          "üîß *PRODOTTO*",
          v.sistema?"Sistema: *"+v.sistema+"*":"‚ö†Ô∏è Sistema NON specificato",
          v.vetro?"Vetro: "+v.vetro:"",
          v.coloreInt?"üé® Colore: "+(v.bicolore?"INT: *"+v.coloreInt+"* / EST: *"+(v.coloreEst||"‚Äî")+"*":"*"+v.coloreInt+"*"):"‚ö†Ô∏è Colore NON specificato",
          v.coloreAcc?"Colore accessori: "+v.coloreAcc:"",
          "",
          (v.telaio||v.rifilato)?"üìê *TELAIO*":"",
          v.telaio?"Tipo: "+v.telaio+(v.telaioAlaZ?" ¬∑ Ala Z: "+v.telaioAlaZ+"mm":""):"",
          v.rifilato?("Rifilatura: "+(v.rifilSx?"Sx:"+v.rifilSx:"")+(v.rifilDx?" Dx:"+v.rifilDx:"")+(v.rifilSopra?" Sop:"+v.rifilSopra:"")+(v.rifilSotto?" Sot:"+v.rifilSotto:"")+" mm"):"",
          "",
          (v.coprifilo||v.lamiera)?"üî© *FINITURA*":"",
          v.coprifilo?"Coprifilo: "+v.coprifilo:"",
          v.lamiera?"Lamiera: "+v.lamiera:"",
          "",
          ct.tipo?"üî≤ *CONTROTELAIO*":"",
          ct.tipo?("Tipo: "+(ct.tipo==="singolo"?"Singolo":ct.tipo==="doppio"?"Doppio":"Con cassonetto")):"",
          ct.tipo?(ct.l&&ct.h?"Dimensioni CT: "+ct.l+"√ó"+ct.h+" mm"+(ct.prof?" ¬∑ Prof: "+ct.prof+" mm":""):""):"",
          ct.tipo&&ct.offset?"Offset: "+ct.offset+" mm/lato":"",
          ct.tipo&&ct.infissoL?"‚Üí Infisso calcolato: "+ct.infissoL+"√ó"+ct.infissoH+" mm":"",
          ct.tipo==="cassonetto"&&ct.casH?"Cassonetto: H "+ct.casH+"√óP "+(ct.casP||"‚Äî")+" mm":"",
          ct.tipo==="cassonetto"&&ct.cielino?"Cielino: "+ct.cielino:"",
          "",
          v.cassonetto?"üì¶ *CASSONETTO ESTERNO*":"",
          v.cassonetto?((m.casL||"")+"√ó"+(m.casH||"")+"√ó"+(m.casP||"")+" mm"+(v.casTipo?" ¬∑ "+v.casTipo:"")):"",
          "",
          "üìé *ACCESSORI*",
          v.accessori?.tapparella?.attivo?("‚¨á Tapparella: "+(v.accessori.tapparella.colore||"‚Äî")+" ¬∑ "+(v.accessori.tapparella.l||"‚Äî")+"√ó"+(v.accessori.tapparella.h||"‚Äî")+" mm"+(v.accessori.tapparella.motorizzata?" ¬∑ MOTORIZZATA":"")):"‚¨á Tapparella: NO",
          v.accessori?.persiana?.attivo?("ü™ü Persiana: "+(v.accessori.persiana.colore||"‚Äî")+(v.accessori.persiana.tipo?" ¬∑ "+v.accessori.persiana.tipo:"")):"ü™ü Persiana: NO",
          v.accessori?.zanzariera?.attivo?("üï∏ Zanzariera: "+(v.accessori.zanzariera.l||"‚Äî")+"√ó"+(v.accessori.zanzariera.h||"‚Äî")+" mm"+(v.accessori.zanzariera.tipo?" ¬∑ "+v.accessori.zanzariera.tipo:"")):"üï∏ Zanzariera: NO",
          "",
          v.note?"üìù *NOTE VANO:* "+v.note:"",
          fuori?"‚ö†Ô∏è *ATTENZIONE: FUORISQUADRA ‚Äî Verificare con muratore prima dell'ordine*":"",
        ].filter(x=>x!==undefined&&x!==null&&x!=="");
        return lines.join("\n");
      }),
      SEP,
      "",
      probAperti.length > 0 ? "üö® *PROBLEMI APERTI ("+probAperti.length+")*" : "",
      ...probAperti.map(p => "‚Ä¢ "+p.titolo+" ("+(p.tipo||"")+" ¬∑ "+(p.priorita==="alta"?"üî¥ ALTA":p.priorita==="media"?"üü† MEDIA":"‚ö™ BASSA")+")"+(p.descrizione?" ‚Äî "+p.descrizione:"")),
      probAperti.length > 0 ? "" : "",
      c.note?"üìù *NOTE GENERALI*\n"+c.note+"\n"+SEP:"",
      c.tecnicoMisure?"üë§ Tecnico: "+c.tecnicoMisure:"",
      c.dataRilievo?"üìÖ Data rilievo: "+c.dataRilievo:"",
      "",
      SEP,
      "üìä Totale: *"+vaniR.length+"* vani ¬∑ *"+totPezzi+"* pezzi"+(fuoriSqN>0?" ¬∑ ‚ö†Ô∏è *"+fuoriSqN+"* fuorisquadra":""),
      "",
      "_Generato con MASTRO ¬∑ "+today+"_",
    ].filter(Boolean).join("\n");

    const BLU="#2563eb", VRD="#059669", ROS="#dc2626", GRY="#94a3b8", AMB="#d97706", VIO="#7c3aed";
    const FM="'DM Mono',monospace";

    // Disegno SVG per ogni tipologia
    const DrawVano = ({v}) => {
      const m = v.misure||{};
      const lc = m.lCentro||0, hc = m.hCentro||0, hasM = lc>0&&hc>0;
      const diff = m.d1>0&&m.d2>0 ? Math.abs(m.d1-m.d2) : null;
      const fuori = diff!==null && diff>5;
      const t = v.tipo||"";
      // dimensioni fisse proporzionate al tipo
      const isPorta = t==="PF1A"||t==="PF2A"||t==="PF3A"||t==="PF4A"||t==="BLI"||t==="PF2AFISDX"||t==="PF2AFISSX";
      const isSC = t==="SC2A"||t==="SC4A"||t==="SCRDX"||t==="SCRSX"||t==="ALZDX"||t==="ALZSX"||t==="ALZSC";
      const W = isSC ? 260 : (t==="F4A"||t==="PF4A"||t==="SC4A") ? 340 : (t==="F3A"||t==="PF3A"||t==="F2AFISDX"||t==="F2AFISSX"||t==="PF2AFISDX"||t==="PF2AFISSX") ? 300 : (t==="F2A"||t==="PF2A"||t==="PERS2A") ? 220 : 160;
      const H = isPorta ? 240 : 160;
      const BW = 6; // bordo telaio fisso
      const GX = BW+10, GY = BW+10; // inizio vetro/anta
      const GW = W-GX*2, GH = H-GY*2;
      const cx = W/2, cy = H/2;
      const F = "monospace";
      const OR = "#e09010"; // arancio OB

      // Anta singola (riusabile)
      const anta1 = (ax,ay,aw,ah,ob,hingeLeft) => {
        const elems = [];
        elems.push(<rect key="v" x={ax} y={ay} width={aw} height={ah} fill="#ddeefa"/>);
        elems.push(<rect key="p" x={ax} y={ay} width={aw} height={ah} fill="none" stroke="#333" strokeWidth={1.2}/>);
        // triangolo: apice al centro del lato di apertura (opposto al cardine)
        if(hingeLeft) {
          // cardine SX ‚Üí apice centro-DX
          elems.push(<line key="t1" x1={ax} y1={ay} x2={ax+aw} y2={ay+ah/2} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>);
          elems.push(<line key="t2" x1={ax} y1={ay+ah} x2={ax+aw} y2={ay+ah/2} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>);
          if(ob) {
            // OB aggiunge V vasistas in arancio (apice centro-basso)
            elems.push(<line key="ob1" x1={ax} y1={ay} x2={ax+aw/2} y2={ay+ah} stroke={OR} strokeWidth={1.2} strokeDasharray="8,4"/>);
            elems.push(<line key="ob2" x1={ax+aw} y1={ay} x2={ax+aw/2} y2={ay+ah} stroke={OR} strokeWidth={1.2} strokeDasharray="8,4"/>);
          }
          elems.push(<rect key="m" x={ax+aw-5} y={ay+ah/2-9} width={5} height={18} fill="white" stroke="#444" strokeWidth={0.8}/>);
        } else {
          // cardine DX ‚Üí apice centro-SX
          elems.push(<line key="t1" x1={ax+aw} y1={ay} x2={ax} y2={ay+ah/2} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>);
          elems.push(<line key="t2" x1={ax+aw} y1={ay+ah} x2={ax} y2={ay+ah/2} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>);
          if(ob) {
            elems.push(<line key="ob1" x1={ax} y1={ay} x2={ax+aw/2} y2={ay+ah} stroke={OR} strokeWidth={1.2} strokeDasharray="8,4"/>);
            elems.push(<line key="ob2" x1={ax+aw} y1={ay} x2={ax+aw/2} y2={ay+ah} stroke={OR} strokeWidth={1.2} strokeDasharray="8,4"/>);
          }
          elems.push(<rect key="m" x={ax} y={ay+ah/2-9} width={5} height={18} fill="white" stroke="#444" strokeWidth={0.8}/>);
        }
        return elems;
      };

      let body = null;

      if (t==="F1A"||t==="PF1A") {
        body = anta1(GX,GY,GW,GH,false,true);
      } else if (t==="F2A"||t==="PF2A") {
        const hw = Math.floor((GW-8)/2);
        body = [
          <rect key="mont" x={GX+hw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          ...anta1(GX, GY, hw, GH, false, true).map((e,i)=><g key={"l"+i}>{e}</g>),
          ...anta1(GX+hw+8, GY, GW-hw-8, GH, false, false).map((e,i)=><g key={"r"+i}>{e}</g>),
        ];
      } else if (t==="F3A"||t==="PF3A") {
        const tw = Math.floor((GW-16)/3);
        body = [
          <rect key="m1" x={GX+tw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="m2" x={GX+tw*2+8} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          ...anta1(GX, GY, tw, GH, true, true).map((e,i)=><g key={"a"+i}>{e}</g>),
          ...anta1(GX+tw+8, GY, tw, GH, false, true).map((e,i)=><g key={"b"+i}>{e}</g>),
          ...anta1(GX+tw*2+16, GY, tw, GH, true, false).map((e,i)=><g key={"c"+i}>{e}</g>),
        ];
      } else if (t==="F4A"||t==="PF4A") {
        const qw = Math.floor((GW-24)/4);
        body = [
          <rect key="m1" x={GX+qw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="m2" x={GX+qw*2+8} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="m3" x={GX+qw*3+16} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          ...anta1(GX, GY, qw, GH, false, true).map((e,i)=><g key={"a"+i}>{e}</g>),
          ...anta1(GX+qw+8, GY, qw, GH, false, false).map((e,i)=><g key={"b"+i}>{e}</g>),
          ...anta1(GX+qw*2+16, GY, qw, GH, false, true).map((e,i)=><g key={"c"+i}>{e}</g>),
          ...anta1(GX+qw*3+24, GY, qw, GH, false, false).map((e,i)=><g key={"d"+i}>{e}</g>),
        ];
      } else if (t==="F2AFISDX"||t==="PF2AFISDX") {
        const tw = Math.floor((GW-16)/3);
        body = [
          <rect key="m1" x={GX+tw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="m2" x={GX+tw*2+8} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          ...anta1(GX, GY, tw, GH, false, true).map((e,i)=><g key={"a"+i}>{e}</g>),
          ...anta1(GX+tw+8, GY, tw, GH, false, false).map((e,i)=><g key={"b"+i}>{e}</g>),
          <rect key="fix" x={GX+tw*2+16} y={GY} width={tw} height={GH} fill="#ddeefa"/>,
          <rect key="fixb" x={GX+tw*2+16} y={GY} width={tw} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <text key="fixt" x={GX+tw*2+16+tw/2} y={cy+4} textAnchor="middle" fontSize={8} fill="#888" fontFamily={F}>FISSO</text>,
        ];
      } else if (t==="F2AFISSX"||t==="PF2AFISSX") {
        const tw = Math.floor((GW-16)/3);
        body = [
          <rect key="m1" x={GX+tw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="m2" x={GX+tw*2+8} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="fix" x={GX} y={GY} width={tw} height={GH} fill="#ddeefa"/>,
          <rect key="fixb" x={GX} y={GY} width={tw} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <text key="fixt" x={GX+tw/2} y={cy+4} textAnchor="middle" fontSize={8} fill="#888" fontFamily={F}>FISSO</text>,
          ...anta1(GX+tw+8, GY, tw, GH, false, true).map((e,i)=><g key={"a"+i}>{e}</g>),
          ...anta1(GX+tw*2+16, GY, tw, GH, false, false).map((e,i)=><g key={"b"+i}>{e}</g>),
        ];
      } else if (t==="PERS1A") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#e8f5e9"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          ...Array.from({length:8}).map((_,i)=><line key={"sl"+i} x1={GX} y1={GY+GH*i/8} x2={GX+GW} y2={GY+GH*i/8} stroke="#66bb6a" strokeWidth={0.6}/>),
          <line key="t1" x1={GX} y1={GY} x2={GX+GW} y2={cy} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <line key="t2" x1={GX} y1={GY+GH} x2={GX+GW} y2={cy} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
        ];
      } else if (t==="PERS2A") {
        const hw = Math.floor((GW-8)/2);
        body = [
          <rect key="m" x={GX+hw} y={0} width={8} height={H} fill="white" stroke="#333" strokeWidth={2}/>,
          <rect key="vl" x={GX} y={GY} width={hw} height={GH} fill="#e8f5e9"/>,
          <rect key="vr" x={GX+hw+8} y={GY} width={GW-hw-8} height={GH} fill="#e8f5e9"/>,
          ...Array.from({length:8}).map((_,i)=><line key={"sl"+i} x1={GX} y1={GY+GH*i/8} x2={GX+hw} y2={GY+GH*i/8} stroke="#66bb6a" strokeWidth={0.6}/>),
          ...Array.from({length:8}).map((_,i)=><line key={"sr"+i} x1={GX+hw+8} y1={GY+GH*i/8} x2={GX+GW} y2={GY+GH*i/8} stroke="#66bb6a" strokeWidth={0.6}/>),
          <rect key="pl" x={GX} y={GY} width={hw} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <rect key="pr" x={GX+hw+8} y={GY} width={GW-hw-8} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
        ];
      } else if (t==="MONO") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#e3f2fd"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <rect key="cas" x={GX} y={GY-12} width={GW} height={12} fill="#fff8e1" stroke="#ca8a04" strokeWidth={0.6}/>,
          <text key="ct" x={cx} y={GY-4} textAnchor="middle" fontSize={6} fill="#92400e" fontFamily={F} fontWeight="700">CASSONETTO</text>,
          <rect key="tap" x={GX+GW-8} y={GY} width={8} height={GH} fill="#ffecb3" stroke="#ff8f00" strokeWidth={0.5}/>,
          <text key="tt" x={cx} y={cy+4} textAnchor="middle" fontSize={10} fill="#666" fontFamily={F}>MONO</text>,
        ];
      } else if (t==="TAPP") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#fff8e1"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          ...Array.from({length:12}).map((_,i)=><line key={"h"+i} x1={GX+2} y1={GY+GH*i/12} x2={GX+GW-2} y2={GY+GH*i/12} stroke="#ff8f00" strokeWidth={0.8}/>),
          <text key="tt" x={cx} y={cy+4} textAnchor="middle" fontSize={9} fill="#e65100" fontFamily={F} fontWeight="700">TAPPARELLA</text>,
        ];
      } else if (t==="ZANZ") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#f3e5f5"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          ...Array.from({length:6}).map((_,i)=><line key={"hh"+i} x1={GX+2} y1={GY+GH*i/6} x2={GX+GW-2} y2={GY+GH*i/6} stroke="#ce93d8" strokeWidth={0.4}/>),
          ...Array.from({length:6}).map((_,i)=><line key={"vv"+i} x1={GX+GW*i/6} y1={GY+2} x2={GX+GW*i/6} y2={GY+GH-2} stroke="#ce93d8" strokeWidth={0.4}/>),
          <text key="tt" x={cx} y={cy+4} textAnchor="middle" fontSize={9} fill="#7b1fa2" fontFamily={F} fontWeight="700">ZANZARIERA</text>,
        ];
      } else if (t==="SC2A"||t==="SC4A"||t==="SCRDX"||t==="SCRSX") {
        const hw = Math.floor(GW/2);
        body = [
          <line key="bt" x1={GX} y1={GY-3} x2={GX+GW} y2={GY-3} stroke="#666" strokeWidth={2}/>,
          <line key="bb" x1={GX} y1={GY+GH+3} x2={GX+GW} y2={GY+GH+3} stroke="#666" strokeWidth={2}/>,
          <rect key="la" x={GX} y={GY} width={hw} height={GH} fill="#ddeefa" stroke="#333" strokeWidth={1.5}/>,
          <rect key="lb" x={GX+hw} y={GY} width={GW-hw} height={GH} fill="#ddeefa" fillOpacity={0.4} stroke="#555" strokeWidth={0.8} strokeDasharray="5,3"/>,
          <rect key="mh" x={GX+hw-4} y={cy-9} width={4} height={18} fill="white" stroke="#444" strokeWidth={0.8}/>,
          <line key="ar" x1={GX+hw+14} y1={cy} x2={GX+hw+GW*0.35} y2={cy} stroke="#1a56db" strokeWidth={1.2}/>,
          <polygon key="ap" points={(GX+hw+GW*0.35)+","+(cy-4)+" "+(GX+hw+GW*0.35)+","+(cy+4)+" "+(GX+hw+GW*0.35+8)+","+cy} fill="#1a56db"/>,
        ];
      } else if (t==="ALZDX"||t==="ALZSX"||t==="ALZSC") {
        const hw = Math.floor(GW/2);
        body = [
          <line key="bt" x1={GX} y1={GY-3} x2={GX+GW} y2={GY-3} stroke="#666" strokeWidth={2}/>,
          <line key="bb" x1={GX} y1={GY+GH+3} x2={GX+GW} y2={GY+GH+3} stroke="#666" strokeWidth={2}/>,
          <rect key="la" x={GX} y={GY} width={hw} height={GH} fill="#ddeefa" stroke="#333" strokeWidth={1.5}/>,
          <rect key="lb" x={GX+hw} y={GY} width={GW-hw} height={GH} fill="#ddeefa" fillOpacity={0.4} stroke="#555" strokeWidth={0.8} strokeDasharray="5,3"/>,
          <line key="av" x1={GX+hw+GW*0.22} y1={cy+12} x2={GX+hw+GW*0.22} y2={cy-14} stroke="#1a56db" strokeWidth={1.2}/>,
          <polygon key="ap" points={(GX+hw+GW*0.22-4)+","+(cy-10)+" "+(GX+hw+GW*0.22+4)+","+(cy-10)+" "+(GX+hw+GW*0.22)+","+(cy-18)} fill="#1a56db"/>,
        ];
      } else if (t==="VAS") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#ddeefa"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <line key="v1" x1={GX} y1={GY} x2={cx} y2={GY+GH} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <line key="v2" x1={GX+GW} y1={GY} x2={cx} y2={GY+GH} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <rect key="m" x={cx-12} y={GY+GH-4} width={24} height={4} fill="white" stroke="#444" strokeWidth={0.8}/>,
        ];
      } else if (t==="RIBALTA") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#ddeefa"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
          <line key="v1" x1={GX} y1={GY+GH} x2={cx} y2={GY} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <line key="v2" x1={GX+GW} y1={GY+GH} x2={cx} y2={GY} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <rect key="m" x={cx-12} y={GY} width={24} height={4} fill="white" stroke="#444" strokeWidth={0.8}/>,
        ];
      } else if (t==="BLI") {
        body = [
          <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#ddeefa"/>,
          <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={2}/>,
          <line key="t1" x1={GX} y1={GY} x2={GX+GW} y2={cy} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <line key="t2" x1={GX} y1={GY+GH} x2={GX+GW} y2={cy} stroke="#333" strokeWidth={1} strokeDasharray="8,4"/>,
          <rect key="m" x={GX+GW-5} y={cy-11} width={5} height={22} fill="white" stroke="#444" strokeWidth={0.8}/>,
          <circle key="mk" cx={GX+GW-3} cy={cy} r={5} fill="white" stroke="#333" strokeWidth={1.2}/>,
        ];
      } else if (t==="FISDX"||t==="FISSX"||t==="SOPR") {
        body = [<rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#ddeefa"/>];
      } else {
        const tipObj = TIPOLOGIE_RAPIDE.find(tp => tp.code === t);
        const forma = tipObj?.forma || "rettangolare";
        if (forma === "fuorisquadro") {
          // Usa H sx e H dx reali per proporzionare il disegno
          const hL = m.hSx || m.hCentro || hc || GH;
          const hR = m.hDx || m.hCentro || hc || GH;
          const maxH = Math.max(hL, hR, 1);
          const scaledHL = (hL / maxH) * GH;
          const scaledHR = (hR / maxH) * GH;
          const topL = GY + GH - scaledHL;
          const topR = GY + GH - scaledHR;
          const btm = GY + GH;
          body = [
            <polygon key="v" points={`${GX},${topL} ${GX+GW},${topR} ${GX+GW},${btm} ${GX},${btm}`} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            // Diagonale in rosso
            <line key="diag" x1={GX} y1={topL} x2={GX+GW} y2={btm} stroke="#c62828" strokeWidth={1} strokeDasharray="6,3"/>,
            // Quote H1 e H2 sui lati
            <text key="h1" x={GX-2} y={(topL+btm)/2} textAnchor="end" fontSize={8} fill="#c62828" fontFamily={F} fontWeight="700">{"H1\n"+(m.hSx||"")}</text>,
            <text key="h2" x={GX+GW+2} y={(topR+btm)/2} textAnchor="start" fontSize={8} fill="#1565c0" fontFamily={F} fontWeight="700">{"H2\n"+(m.hDx||"")}</text>,
            // Label tipo
            <text key="tx" x={cx} y={btm-8} textAnchor="middle" fontSize={9} fill="#555" fontFamily={F} fontWeight="600">{t}</text>,
            // Differenza fuorisquadro
            ...(hL !== hR ? [<text key="diff" x={cx} y={Math.min(topL,topR)-4} textAnchor="middle" fontSize={7} fill="#c62828" fontFamily={F} fontWeight="700">{"Œî "+Math.abs(hL-hR)+"mm"}</text>] : []),
          ];
        } else if (forma === "arco") {
          body = [
            <path key="v" d={`M${GX},${GY+GH} L${GX},${GY+GH*0.35} Q${GX},${GY} ${cx},${GY} Q${GX+GW},${GY} ${GX+GW},${GY+GH*0.35} L${GX+GW},${GY+GH} Z`} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={cy+10} textAnchor="middle" fontSize={9} fill="#555" fontFamily={F} fontWeight="600">{t}</text>
          ];
        } else if (forma === "trapezio") {
          const inset = GW * 0.15;
          body = [
            <polygon key="v" points={`${GX+inset},${GY} ${GX+GW-inset},${GY} ${GX+GW},${GY+GH} ${GX},${GY+GH}`} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={cy+4} textAnchor="middle" fontSize={9} fill="#555" fontFamily={F} fontWeight="600">{t}</text>
          ];
        } else if (forma === "triangolo") {
          body = [
            <polygon key="v" points={`${cx},${GY} ${GX+GW},${GY+GH} ${GX},${GY+GH}`} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={GY+GH-10} textAnchor="middle" fontSize={9} fill="#555" fontFamily={F} fontWeight="600">{t}</text>
          ];
        } else if (forma === "oblo") {
          const r = Math.min(GW, GH) / 2;
          body = [
            <circle key="v" cx={cx} cy={cy} r={r} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={cy+4} textAnchor="middle" fontSize={9} fill="#555" fontFamily={F} fontWeight="600">{t}</text>
          ];
        } else if (forma === "sagomato") {
          body = [
            <path key="v" d={`M${GX},${GY+GH} L${GX},${GY+GH*0.25} Q${GX},${GY} ${GX+GW*0.3},${GY} L${GX+GW*0.7},${GY} Q${GX+GW},${GY+GH*0.15} ${GX+GW},${GY+GH*0.4} L${GX+GW},${GY+GH*0.7} Q${GX+GW*0.8},${GY+GH} ${GX+GW*0.5},${GY+GH} Z`} fill="#ddeefa" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={cy+4} textAnchor="middle" fontSize={8} fill="#555" fontFamily={F} fontWeight="600">{t}</text>,
            <text key="tx2" x={cx} y={cy+14} textAnchor="middle" fontSize={6} fill="#999" fontFamily={F}>SAGOMATO</text>
          ];
        } else {
          body = [
            <rect key="v" x={GX} y={GY} width={GW} height={GH} fill="#ddeefa"/>,
            <rect key="p" x={GX} y={GY} width={GW} height={GH} fill="none" stroke="#333" strokeWidth={1.2}/>,
            <text key="tx" x={cx} y={cy+4} textAnchor="middle" fontSize={10} fill="#888" fontFamily={F}>{t||"?"}</text>
          ];
        }
      }

      // soglia per porte
      const hasSoglia = isPorta || t==="SC2A"||t==="SC4A"||t==="ALZDX"||t==="ALZSX";

      return (
        <svg viewBox={"-18 -2 "+(W+22)+" "+(H+4)} width="100%" style={{display:"block",background:"white",border:"1px solid #ddd",borderRadius:3}}>
          {/* cassonetto */}
          {v.cassonetto&&<rect x={0} y={-14} width={W} height={14} fill="#fffde7" stroke="#ca8a04" strokeWidth={0.8}/>}
          {v.cassonetto&&<text x={cx} y={-4} textAnchor="middle" fontSize={6} fill="#92400e" fontFamily={F} fontWeight="700">{"CASS. "+(v.misure?.casL||"")+"√ó"+(v.misure?.casH||"")+"√ó"+(v.misure?.casP||"")}</text>}
          {/* telaio fisso */}
          <rect x={1} y={1} width={W-2} height={H-2} fill="white" stroke="#333" strokeWidth={BW}/>
          {/* soglia */}
          {hasSoglia&&<line x1={1} y1={H-BW/2} x2={W-1} y2={H-BW/2} stroke="#333" strokeWidth={3}/>}
          {/* corpo */}
          {body}
          {/* quadratura: solo badge, no linee */}
          {fuori&&<rect x={cx-26} y={cy-9} width={52} height={18} rx={3} fill="#dc2626"/>}
          {fuori&&<text x={cx} y={cy+4} textAnchor="middle" fontSize={9} fill="white" fontFamily={F} fontWeight="700">{"‚ö† +"+diff+"mm"}</text>}
          {!fuori&&diff!==null&&<rect x={cx-18} y={cy-7} width={36} height={14} rx={3} fill="#15803d"/>}
          {!fuori&&diff!==null&&<text x={cx} y={cy+4} textAnchor="middle" fontSize={8} fill="white" fontFamily={F} fontWeight="700">{"‚úì sq."}</text>}
          {/* quote */}
          {hasM&&<rect x={cx-30} y={-1} width={60} height={16} rx={2} fill="#1d4ed8"/>}
          {hasM&&<text x={cx} y={12} textAnchor="middle" fontSize={10} fill="white" fontFamily={F} fontWeight="700">{lc}</text>}
          {hasM&&<rect x={-16} y={cy-20} width={18} height={40} rx={3} fill="#15803d"/>}
          {hasM&&<text x={-7} y={cy+4} textAnchor="middle" fontSize={9} fill="white" fontFamily={F} fontWeight="700" transform={"rotate(-90,-7,"+cy+")"}>{hc}</text>}
          {/* badge telaio/accessori */}
          {v.telaio&&<text x={GX+2} y={GY+9} fontSize={6} fill="#6d28d9" fontFamily={F} fontWeight="700">{"Tel."+v.telaio+(v.telaio==="Z"&&v.telaioAlaZ?" "+v.telaioAlaZ:"")}</text>}
          {v.accessori?.tapparella?.attivo&&<text x={GX+GW-2} y={GY+9} textAnchor="end" fontSize={6} fill="#d97706" fontFamily={F} fontWeight="700">TAP</text>}
          {v.accessori?.zanzariera?.attivo&&<text x={GX+GW-2} y={GY+17} textAnchor="end" fontSize={6} fill="#6d28d9" fontFamily={F} fontWeight="700">ZAN</text>}
        </svg>
      );
    };

    return (
      <div style={{paddingBottom:110,background:"#f1f5f9",minHeight:"100vh"}}>
        {/* Header */}
        <div style={{background:"#0f172a",padding:"13px 16px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:10}}>
          <div onClick={()=>setShowRiepilogo(false)} style={{cursor:"pointer",padding:4}}>
            <Ico d={ICO.back} s={20} c="#64748b"/>
          </div>
          <div style={{flex:1}}>
            <div style={{fontSize:15,fontWeight:800,color:"white"}}>Riepilogo Sopralluogo</div>
            <div style={{fontSize:10,color:"#64748b"}}>{c.code} ¬∑ {c.cliente} {c.cognome||""} ¬∑ {today}</div>
          </div>
          <div style={{padding:"4px 8px",borderRadius:6,background:vaniFilled===vaniR.length?"#16a34a":"#d97706",fontSize:10,fontWeight:700,color:"white"}}>{vaniFilled}/{vaniR.length} ‚úì</div>
        </div>

        <div style={{padding:"10px 12px"}}>
          {/* Dati cantiere */}
          <div style={{background:"white",borderRadius:10,border:"1px solid #e2e8f0",padding:"12px 14px",marginBottom:10,boxShadow:"0 1px 3px rgba(0,0,0,0.04)"}}>
            <div style={{fontSize:9,fontWeight:800,color:BLU,textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:8}}>üìç Dati Cantiere</div>
            <div style={{display:"grid",gridTemplateColumns:"80px 1fr",gap:"3px 8px",fontSize:11.5}}>
              <span style={{color:GRY,fontWeight:600}}>Cliente</span><span style={{fontWeight:700}}>{c.cliente} {c.cognome||""}</span>
              <span style={{color:GRY,fontWeight:600}}>Indirizzo</span><span>{c.indirizzo}</span>
              {c.telefono&&<><span style={{color:GRY,fontWeight:600}}>Tel</span><span>{c.telefono}</span></>}
              {c.pianoEdificio&&<><span style={{color:GRY,fontWeight:600}}>Piano</span><span style={{fontWeight:600}}>{c.pianoEdificio}</span></>}
              {c.mezzoSalita&&<><span style={{color:GRY,fontWeight:600}}>Salita</span><span>{c.mezzoSalita}</span></>}
              {c.sistema&&<><span style={{color:GRY,fontWeight:600}}>Sistema</span><span style={{fontWeight:700,color:BLU}}>{c.sistema}</span></>}
            </div>
            {c.note&&<div style={{marginTop:8,padding:"5px 8px",background:"#fffbeb",borderRadius:6,fontSize:11,color:"#713f12",borderLeft:"3px solid "+AMB}}>üìù {c.note}</div>}
          </div>

          {/* Vani */}
          {vaniR.map((v,vi)=>{
            const m=v.misure||{};
            const lc=m.lCentro||0, hc=m.hCentro||0;
            const diff=m.d1>0&&m.d2>0?Math.abs(m.d1-m.d2):null;
            const fuori=diff!==null&&(diff as number)>5;
            const misN=Object.values(m).filter(x=>(x as number)>0).length;
            const tipLabel=TIPOLOGIE_RAPIDE.find(tp=>tp.code===v.tipo)?.label||v.tipo||"‚Äî";
            return (
              <div key={v.id} style={{background:"white",borderRadius:10,border:"1.5px solid "+(fuori?"#fca5a5":"#e2e8f0"),marginBottom:10,overflow:"hidden"}}>
                {/* Header */}
                <div style={{padding:"8px 12px",background:fuori?"#fef2f2":"#0f172a",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <span style={{fontSize:13,fontWeight:800,color:fuori?"#991b1b":"white"}}>{vi+1}. {v.nome}</span>
                    <span style={{fontSize:10,color:fuori?"#b91c1c":"#64748b",marginLeft:6}}>{tipLabel} ¬∑ {v.stanza} ¬∑ {v.piano}</span>
                  </div>
                  <div style={{display:"flex",gap:3}}>
                    {(v.pezzi||1)>1&&<span style={{padding:"2px 6px",borderRadius:3,background:"#7c3aed",color:"white",fontSize:8,fontWeight:800}}>√ó{v.pezzi} PZ</span>}
                    {fuori&&<span style={{padding:"2px 6px",borderRadius:3,background:ROS,color:"white",fontSize:8,fontWeight:800}}>‚ö† +{diff}mm</span>}
                    <span style={{padding:"2px 6px",borderRadius:3,background:misN>=6?"#16a34a":"#d97706",color:"white",fontSize:8,fontWeight:700}}>{misN}mis</span>
                  </div>
                </div>

                <div style={{display:"flex"}}>
                  {/* SVG disegno */}
                  <div style={{width:"50%",padding:"10px 6px 8px 10px",borderRight:"1px solid #f1f5f9"}}>
                    <div style={{fontSize:7,fontWeight:700,color:GRY,textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>Schema</div>
                    <DrawVano v={v}/>
                  </div>

                  {/* Misure */}
                  <div style={{flex:1,padding:"10px 10px 8px 10px"}}>
                    <div style={{fontSize:7,fontWeight:700,color:GRY,textTransform:"uppercase",marginBottom:5}}>Misure (mm)</div>
                    {[["LARGH",BLU,[["Alto",m.lAlto],["Centro‚óè",m.lCentro],["Basso",m.lBasso]]],
                      ["ALT",VRD,[["Sx",m.hSx],["Centro‚óè",m.hCentro],["Dx",m.hDx]]]
                    ].map(([lbl,col,rows])=>(
                      <div key={lbl} style={{marginBottom:5}}>
                        <div style={{fontSize:7,fontWeight:800,color:col,marginBottom:2,display:"flex",alignItems:"center",gap:2}}>
                          <span style={{width:6,height:6,borderRadius:1,background:col,display:"inline-block"}}/>
                          {lbl}
                        </div>
                        {rows.map(([l,val])=>(
                          <div key={l} style={{display:"flex",justifyContent:"space-between",fontSize:10.5,padding:"1.5px 0",borderBottom:"1px solid #f8fafc"}}>
                            <span style={{color:GRY,fontSize:9.5}}>{l}</span>
                            <span style={{fontWeight:700,color:val?"#0f172a":"#e2e8f0",fontFamily:"'DM Mono',monospace"}}>{val||"‚Äî"}</span>
                          </div>
                        ))}
                      </div>
                    ))}
                    {(m.d1>0||m.d2>0)&&<div style={{marginBottom:4}}>
                      <div style={{fontSize:7,fontWeight:800,color:fuori?ROS:VIO,marginBottom:2}}>DIAG. {fuori?"‚ö† +"+diff:"‚úì"}</div>
                      {[["D1‚Üó",m.d1],["D2‚Üò",m.d2]].map(([l,val])=>(
                        <div key={l} style={{display:"flex",justifyContent:"space-between",fontSize:10.5,padding:"1px 0"}}>
                          <span style={{color:GRY,fontSize:9.5}}>{l}</span>
                          <span style={{fontWeight:700,fontFamily:"'DM Mono',monospace"}}>{val||"‚Äî"}</span>
                        </div>
                      ))}
                    </div>}
                    {(m.spSx>0||m.spDx>0)&&<div>
                      <div style={{fontSize:7,fontWeight:800,color:AMB,marginBottom:2}}>SPALL.</div>
                      <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                        {[["Sx",m.spSx],["Dx",m.spDx],["Sop",m.spSopra]].filter(([,val])=>val>0).map(([l,val])=>(
                          <span key={l} style={{fontSize:10}}><span style={{color:GRY,fontSize:9}}>{l} </span><strong style={{fontFamily:"'DM Mono',monospace"}}>{val}</strong></span>
                        ))}
                      </div>
                    </div>}
                  </div>
                </div>

                {/* Prodotto */}
                {(v.sistema||v.vetro||v.telaio||v.accessori?.tapparella?.attivo||v.accessori?.zanzariera?.attivo||v.accessori?.persiana?.attivo||v.cassonetto||v.note||v.controtelaio?.tipo)&&(
                  <div style={{padding:"7px 12px",background:"#f8fafc",borderTop:"1px solid #f1f5f9"}}>
                    <div style={{display:"flex",flexWrap:"wrap",gap:3,marginBottom:3}}>
                      {v.controtelaio?.tipo&&<span style={{padding:"2px 7px",borderRadius:4,background:"#dbeafe",color:"#1e40af",fontSize:9.5,fontWeight:700}}>üî≤ CT {v.controtelaio.tipo==="singolo"?"Sing.":v.controtelaio.tipo==="doppio"?"Doppio":"Cass."} {v.controtelaio.l||""}√ó{v.controtelaio.h||""}{v.controtelaio.prof?" P"+v.controtelaio.prof:""}</span>}
                      {v.sistema&&<span style={{padding:"2px 7px",borderRadius:4,background:"#eff6ff",color:"#1d4ed8",fontSize:9.5,fontWeight:700}}>‚öô {v.sistema}</span>}
                      {v.vetro&&<span style={{padding:"2px 7px",borderRadius:4,background:"#f0fdf4",color:"#15803d",fontSize:9.5,fontWeight:700}}>üî≤ {v.vetro}</span>}
                      {v.coloreInt&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fafafa",border:"1px solid #e2e8f0",color:"#374151",fontSize:9.5}}>üé® {v.bicolore?"INT:"+v.coloreInt+"/EST:"+v.coloreEst:v.coloreInt}</span>}
                      {v.telaio&&<span style={{padding:"2px 7px",borderRadius:4,background:"#f5f3ff",color:"#6d28d9",fontSize:9.5,fontWeight:700}}>üìê Tel.{v.telaio}{v.telaio==="Z"&&v.telaioAlaZ?" ("+v.telaioAlaZ+"mm)":""}</span>}
                      {v.rifilato&&(v.rifilSx||v.rifilDx)&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fdf4ff",color:"#7e22ce",fontSize:9.5}}>Rif Sx:{v.rifilSx} Dx:{v.rifilDx} Sop:{v.rifilSopra}</span>}
                      {v.coprifilo&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fefce8",color:"#92400e",fontSize:9.5}}>üî© {v.coprifilo}</span>}
                      {v.lamiera&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fff7ed",color:"#9a3412",fontSize:9.5}}>üìè {v.lamiera}</span>}
                    </div>
                    <div style={{display:"flex",flexWrap:"wrap",gap:3}}>
                      {v.cassonetto&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fef3c7",color:"#b45309",fontSize:9.5,fontWeight:700}}>üì¶ {v.casTipo||"Cass."} {v.misure?.casL||""}√ó{v.misure?.casH||""}√ó{v.misure?.casP||""}</span>}
                      {v.accessori?.tapparella?.attivo&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fef3c7",color:"#b45309",fontSize:9.5,fontWeight:700}}>‚¨á Tap. {v.accessori.tapparella.colore} {v.accessori.tapparella.l}√ó{v.accessori.tapparella.h}</span>}
                      {v.accessori?.persiana?.attivo&&<span style={{padding:"2px 7px",borderRadius:4,background:"#eff6ff",color:"#1e40af",fontSize:9.5,fontWeight:700}}>ü™ü Pers. {v.accessori.persiana.colore}</span>}
                      {v.accessori?.zanzariera?.attivo&&<span style={{padding:"2px 7px",borderRadius:4,background:"#fdf4ff",color:"#6b21a8",fontSize:9.5,fontWeight:700}}>üï∏ Zan. {v.accessori.zanzariera.l}√ó{v.accessori.zanzariera.h}</span>}
                    </div>
                    {v.note&&<div style={{marginTop:5,fontSize:10.5,color:"#475569",fontStyle:"italic",padding:"3px 6px",background:"#fffbeb",borderRadius:4,borderLeft:"2px solid "+AMB}}>üìù {v.note}</div>}
                  </div>
                )}
              </div>
            );
          })}

          {/* Sommario */}
          <div style={{background:"#0f172a",borderRadius:10,padding:"12px 14px",marginBottom:12}}>
            <div style={{fontSize:9,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:8}}>Sommario</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
              {[["Vani",vaniR.length,"#60a5fa"],["Misure ‚úì",vaniFilled,"#4ade80"],["‚ö† Fuori sq.",fuoriSqN,fuoriSqN>0?"#fbbf24":"#4ade80"]].map(([l,val,col])=>(
                <div key={l} style={{textAlign:"center",padding:"8px 4px",background:"rgba(255,255,255,0.05)",borderRadius:8}}>
                  <div style={{fontSize:22,fontWeight:800,color:col,fontFamily:"'DM Mono',monospace"}}>{val}</div>
                  <div style={{fontSize:8,color:"#94a3b8",marginTop:2}}>{l}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

          {/* Anteprima messaggio WA */}
          <div style={{background:"#dcf8c6",border:"1.5px solid #16a34a",borderRadius:10,padding:"10px 12px",marginBottom:10}}>
            <div style={{fontSize:9,fontWeight:800,color:"#166534",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:6}}>üì± Anteprima messaggio</div>
            <pre style={{fontFamily:"'DM Mono',monospace",fontSize:9.5,color:"#14532d",whiteSpace:"pre-wrap",lineHeight:1.65,margin:0,maxHeight:400,overflow:"auto"}}>{waMsg}</pre>
          </div>

        {/* Barra invio */}
        <div style={{position:"fixed",bottom:0,left:0,right:0,background:"white",borderTop:"2px solid #e2e8f0",padding:"10px 12px 22px",boxShadow:"0 -6px 20px rgba(0,0,0,0.08)"}}>
          <div style={{fontSize:9,fontWeight:700,color:GRY,textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:7,textAlign:"center"}}>Invia riepilogo</div>
          <div style={{display:"flex",gap:8}}>
            <div onClick={()=>{navigator.clipboard?.writeText(waMsg.replace(/\*/g,""));}} 
              style={{padding:"13px 14px",borderRadius:11,background:"#f1f5f9",color:"#475569",cursor:"pointer",fontWeight:800,fontSize:13}}>üìã</div>
            <div onClick={()=>window.open("https://wa.me/?text="+encodeURIComponent(waMsg))}
              style={{flex:1,padding:"13px 8px",borderRadius:11,background:"#16a34a",color:"white",textAlign:"center",cursor:"pointer",fontWeight:800,fontSize:13}}>üí¨ WhatsApp</div>
            <div onClick={()=>window.open("mailto:?subject="+encodeURIComponent("Riepilogo Commessa "+c.code+" ‚Äî "+c.cliente)+"&body="+encodeURIComponent(waMsg.replace(/\*/g,"")))}
              style={{flex:1,padding:"13px 8px",borderRadius:11,background:BLU,color:"white",textAlign:"center",cursor:"pointer",fontWeight:800,fontSize:13}}>üìß Email</div>
            <div onClick={()=>window.print()}
              style={{padding:"13px 14px",borderRadius:11,background:"#f1f5f9",color:"#475569",cursor:"pointer",fontWeight:800,fontSize:15}}>üñ®</div>
          </div>
        </div>
      </div>
    );
  };

// =======================================================
// MASTRO ERP v2 ‚Äî PARTE 3/5
// Righe 2639-3594: Vano Detail Wizard completo
// =======================================================
  /* == VANO DETAIL ‚Äî WIZARD A STEP == */
  const STEPS = [
    { id: "misure", title: "MISURE", desc: "Larghezze, altezze e diagonali", color: "#507aff", icon: "üìè" },
    { id: "dettagli", title: "DETTAGLI", desc: "Spallette, davanzale, accessori, foto", color: "#af52de", icon: "‚öô" },
    { id: "riepilogo", title: "RIEPILOGO", desc: "Anteprima completa del vano", color: "#34c759", icon: "üìã" },
  ];
  const [detailOpen, setDetailOpen] = useState<Record<string,boolean>>({});

  const renderVanoDetail = () => {
    const v = selectedVano;
    const m = v.misure || {};
    const step = STEPS[vanoStep];
    const filled = Object.values(m).filter(x => (x as number) > 0).length;
    const TIPO_TIPS = { Scorrevole: { t: "Scorrevole (alzante/traslante)", dim: "2000 √ó 2200 mm", w: ["Binario inferiore: serve spazio incasso", "Verifica portata parete"] }, Portafinestra: { t: "Portafinestra standard", dim: "800-900 √ó 2200 mm", w: ["Soglia a taglio termico", "Verifica altezza architrave"] }, Finestra: { t: "Finestra", dim: "1200 √ó 1400 mm", w: ["Verifica spazio per anta"] } };
    const tip = TIPO_TIPS[v.tipo] || null;
    const hasWarnings = !m.lAlto && !m.lCentro && !m.lBasso;
    const hasHWarnings = !m.hSx && !m.hCentro && !m.hDx;
    const fSq = m.d1 > 0 && m.d2 > 0 ? Math.abs(m.d1 - m.d2) : null;

    // Mini SVG per step
    const MiniSVG = ({ type }) => {
      const w = 60, h = 70;
      return (
        <svg viewBox={`0 0 ${w} ${h}`} width={w} height={h} style={{ display: "block" }}>
          <rect x={5} y={5} width={w-10} height={h-10} fill={step.color + "12"} stroke={step.color + "40"} strokeWidth={1.5} rx={3} />
          {type === "larghezze" && <>
            <line x1={10} y1={18} x2={w-10} y2={18} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
            <line x1={10} y1={h/2} x2={w-10} y2={h/2} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
            <line x1={10} y1={h-18} x2={w-10} y2={h-18} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
          </>}
          {type === "altezze" && <>
            <line x1={14} y1={10} x2={14} y2={h-10} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
            <line x1={w/2} y1={10} x2={w/2} y2={h-10} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
            <line x1={w-14} y1={10} x2={w-14} y2={h-10} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
          </>}
          {type === "diagonali" && <>
            <line x1={10} y1={10} x2={w-10} y2={h-10} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
            <line x1={w-10} y1={10} x2={10} y2={h-10} stroke={step.color} strokeWidth={1.2} strokeDasharray="3,2" />
          </>}
          {type === "spallette" && <>
            <rect x={2} y={5} width={10} height={h-10} fill={step.color + "25"} stroke={step.color+"60"} rx={1} />
            <rect x={w-12} y={5} width={10} height={h-10} fill={step.color + "25"} stroke={step.color+"60"} rx={1} />
            <rect x={5} y={2} width={w-10} height={8} fill={step.color + "18"} stroke={step.color+"40"} rx={1} />
          </>}
          {type === "davanzale" && <>
            <rect x={5} y={h-16} width={w-10} height={10} fill={step.color + "25"} stroke={step.color+"60"} rx={1} />
          </>}
        </svg>
      );
    };

    // Inline input renderer (no sub-component = no focus loss)
    const bInput = (label, field) => (
      <div key={field} style={{ marginBottom: 12 }}>
        <div style={{ fontSize: 12, fontWeight: 600, color: T.text, marginBottom: 4 }}>{label}</div>
        <input
          key={`input-${field}`}
          style={{ width: "100%", padding: "14px 16px", fontSize: 17, fontWeight: 500, fontFamily: FM, textAlign: "center", border: `1px solid ${T.bdr}`, borderRadius: 12, background: m[field] > 0 ? step.color + "08" : T.card, color: T.text, outline: "none", boxSizing: "border-box" }}
          type="number" inputMode="numeric" placeholder="Tocca per inserire" value={m[field] || ""}
          onChange={e => updateMisura(v.id, field, e.target.value)}
        />
      </div>
    );

    return (
      <div style={{ paddingBottom: 80, background: T.bg }}>
        {/* Back + vano name */}
        <div style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 16px", background: T.card, borderBottom: `1px solid ${T.bdr}` }}>
          <div onClick={() => { setSelectedVano(null); setVanoStep(0); }} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 14, fontWeight: 700 }}>{v.nome}</div>
            <div style={{ fontSize: 10, color: T.sub }}>{TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo)?.label || v.tipo} ¬∑ {v.stanza} ¬∑ {v.piano}</div>
          </div>
          <div onClick={() => { setShowAIPhoto(true); setAiPhotoStep(0); }} style={{ padding: "5px 10px", borderRadius: 8, background: "linear-gradient(135deg, #af52de20, #007aff20)", border: "1px solid #af52de40", cursor: "pointer", display: "flex", alignItems: "center", gap: 4 }}>
            <span style={{ fontSize: 14 }}>ü§ñ</span>
            <span style={{ fontSize: 10, fontWeight: 700, color: "#af52de" }}>AI</span>
          </div>
        </div>

        {/* ‚ïê‚ïê‚ïê VOCE AI SOPRALLUOGO ‚ïê‚ïê‚ïê */}
        <div style={{ display: "flex", justifyContent: "center", margin: "8px 16px" }}>
          <div onClick={voiceActive ? stopVoice : startVoice}
            style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 16px", borderRadius: 20, background: voiceActive ? "#ff3b30" : T.accLt, border: `1px solid ${voiceActive ? "#ff3b30" : T.bdr}`, cursor: "pointer" }}>
            <span style={{ fontSize: 16 }}>{voiceActive ? "\u23F9" : "\uD83C\uDFA4"}</span>
            <span style={{ fontSize: 11, fontWeight: 700, color: voiceActive ? "#fff" : T.acc }}>
              {voiceActive ? "Dettatura attiva..." : "Dettatura vocale"}
            </span>
          </div>
        </div>
        {voiceTranscript && (
          <div style={{ margin: "0 16px 8px", padding: "8px 12px", borderRadius: 8, background: T.accLt, border: `1px solid ${T.bdr}`, fontSize: 11, color: T.text }}>
            <span style={{ fontSize: 9, fontWeight: 700, color: T.acc }}>Trascrizione: </span>{voiceTranscript}
          </div>
        )}

        {/* == INFO VANO ‚Äî fisarmoniche (solo step 0) == */}
        {vanoStep === 0 && (() => {
          const updateV = (field, val) => {
            const updRil = selectedRilievo ? { ...selectedRilievo, vani: selectedRilievo.vani.map(vn => vn.id === v.id ? { ...vn, [field]: val } : vn) } : null;
            setCantieri(cs => cs.map(c => c.id === selectedCM?.id
              ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? (updRil || r2) : r2) } : c));
            if (updRil) setSelectedRilievo(updRil);
            setSelectedCM(prev => prev ? ({ ...prev, rilievi: prev.rilievi.map(r => r.id === selectedRilievo?.id ? (updRil || r) : r) }) : prev);
            setSelectedVano(prev => ({ ...prev, [field]: val }));
          };
          const cats = [...new Set(tipologieFiltrate.map(t => t.cat))];
          const pianiList = ["S2","S1","PT","P1","P2","P3","P4","P5","P6","P7","P8","P9","P10","P11","P12","P13","P14","P15","P16","P17","P18","P19","P20","M"];
          const coloriRAL = ["RAL 9010","RAL 9016","RAL 9001","RAL 7016","RAL 7021","RAL 8014","RAL 8016","RAL 1013","Altro"];

          const sections = [
            { id:"accesso", icon:"üèó", label:"Accesso / Difficolt√†",
              badge: v.difficoltaSalita||null,
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div style={{display:"flex",gap:4}}>
                  {[{id:"facile",l:"Facile",c:T.grn,e:"‚úÖ"},{id:"media",l:"Media",c:T.orange,e:"‚ö†Ô∏è"},{id:"difficile",l:"Difficile",c:T.red,e:"üî¥"}].map(d=>(
                    <div key={d.id} onClick={()=>updateV("difficoltaSalita",d.id)}
                      style={{flex:1,padding:"7px 4px",borderRadius:8,border:`1.5px solid ${v.difficoltaSalita===d.id?d.c:T.bdr}`,background:v.difficoltaSalita===d.id?d.c+"15":T.card,textAlign:"center",cursor:"pointer"}}>
                      <div style={{fontSize:13}}>{d.e}</div>
                      <div style={{fontSize:10,fontWeight:700,color:v.difficoltaSalita===d.id?d.c:T.sub}}>{d.l}</div>
                    </div>
                  ))}
                </div>
                <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:2}}>MEZZO DI SALITA</div>
                <select style={S.select} value={v.mezzoSalita||""} onChange={e=>updateV("mezzoSalita",e.target.value)}>
                  <option value="">‚Äî Seleziona ‚Äî</option>
                  {mezziSalita.map(m=><option key={m} value={m}>{m}</option>)}
                </select>
              </div>
            },
            { id:"tipologia", icon:"ü™ü", label:"Tipologia",
              badge: v.tipo||null,
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div style={{display:"flex",gap:2,borderBottom:`1px solid ${T.bdr}`,paddingBottom:0,marginBottom:4}}>
                  {cats.map(cat=>(
                    <div key={cat} onClick={()=>setTipCat(cat)}
                      style={{padding:"5px 8px",fontSize:10,fontWeight:700,cursor:"pointer",color:tipCat===cat?T.acc:T.sub,borderBottom:`2px solid ${tipCat===cat?T.acc:"transparent"}`,marginBottom:-1,whiteSpace:"nowrap"}}>
                      {cat}
                    </div>
                  ))}
                </div>
                <div style={{display:"flex",gap:5,overflowX:"auto",paddingBottom:4,WebkitOverflowScrolling:"touch"}}>
                  {tipologieFiltrate.filter(t=>t.cat===tipCat).map(t=>(
                    <div key={t.code} onClick={()=>updateV("tipo",t.code)}
                      style={{padding:"7px 10px",borderRadius:10,border:`1.5px solid ${v.tipo===t.code?T.acc:T.bdr}`,background:v.tipo===t.code?T.accLt:T.card,fontSize:11,fontWeight:700,color:v.tipo===t.code?T.acc:T.text,cursor:"pointer",whiteSpace:"nowrap",flexShrink:0}}>
                      {t.icon} {t.code}
                    </div>
                  ))}
                </div>
              </div>
            },
            { id:"posizione", icon:"üè†", label:"Stanza / Piano",
              badge: v.stanza?`${v.stanza} ¬∑ ${v.piano}`:null,
              body: <div style={{display:"flex",gap:8}}>
                <div style={{flex:1}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>STANZA</div>
                  <select style={S.select} value={v.stanza||""} onChange={e=>updateV("stanza",e.target.value)}>
                    {["Soggiorno","Cucina","Camera","Bagno","Studio","Ingresso","Corridoio","Altro"].map(x=><option key={x}>{x}</option>)}
                  </select>
                </div>
                <div style={{flex:1}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>PIANO</div>
                  <select style={S.select} value={v.piano||""} onChange={e=>updateV("piano",e.target.value)}>
                    {pianiList.map(p=><option key={p} value={p}>{p==="S2"?"S2 ‚Äî 2¬∞ Seminterrato":p==="S1"?"S1 ‚Äî Seminterrato":p==="PT"?"PT ‚Äî Piano Terra":p==="M"?"M ‚Äî Mansarda":`${p} ‚Äî ${p.replace("P","")}¬∞ Piano`}</option>)}
                  </select>
                </div>
                <div style={{width:80}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>PEZZI</div>
                  <div style={{display:"flex",alignItems:"center",gap:4}}>
                    <div onClick={()=>updateV("pezzi",Math.max(1,(v.pezzi||1)-1))} style={{width:28,height:32,borderRadius:6,background:T.bg,border:`1px solid ${T.bdr}`,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:16,fontWeight:700,color:T.sub}}>‚àí</div>
                    <div style={{flex:1,textAlign:"center",fontSize:16,fontWeight:800,color:T.acc}}>{v.pezzi||1}</div>
                    <div onClick={()=>updateV("pezzi",(v.pezzi||1)+1)} style={{width:28,height:32,borderRadius:6,background:T.bg,border:`1px solid ${T.bdr}`,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:16,fontWeight:700,color:T.sub}}>+</div>
                  </div>
                </div>
              </div>
            },
            { id:"sistema", icon:"‚öôÔ∏è", label:"Sistema / Vetro",
              badge: v.sistema?v.sistema.split(" ").slice(0,2).join(" ¬∑ "):null,
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>SISTEMA</div>
                  <select style={S.select} value={v.sistema||""} onChange={e=>updateV("sistema",e.target.value)}>
                    <option value="">‚Äî Seleziona ‚Äî</option>
                    {sistemiDB.map(s=><option key={s.id} value={`${s.marca} ${s.sistema}`}>{s.marca} {s.sistema}</option>)}
                  </select>
                </div>
                <div>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>VETRO</div>
                  <select style={S.select} value={v.vetro||""} onChange={e=>updateV("vetro",e.target.value)}>
                    <option value="">‚Äî Seleziona ‚Äî</option>
                    {vetriDB.map(g=><option key={g.id} value={g.code}>{g.code} Ug={g.ug}</option>)}
                  </select>
                </div>
              </div>
            },
            { id:"colori", icon:"üé®", label:"Colori profili",
              badge: v.coloreInt||null,
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub}}>INT</div>
                  <div onClick={()=>updateV("bicolore",!v.bicolore)}
                    style={{fontSize:10,padding:"2px 8px",borderRadius:4,background:v.bicolore?T.accLt:"transparent",border:`1px solid ${v.bicolore?T.acc:T.bdr}`,color:v.bicolore?T.acc:T.sub,cursor:"pointer",fontWeight:600}}>
                    Bicolore {v.bicolore?"‚úì":""}
                  </div>
                </div>
                {!v.bicolore
                  ? <select style={S.select} value={v.coloreInt||""} onChange={e=>updateV("coloreInt",e.target.value)}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {coloriDB.map(c=><option key={c.id} value={c.code}>{c.code} ‚Äî {c.nome}</option>)}
                    </select>
                  : <div style={{display:"flex",gap:6}}>
                      <div style={{flex:1}}>
                        <div style={{fontSize:9,color:T.sub,marginBottom:2}}>INT</div>
                        <select style={S.select} value={v.coloreInt||""} onChange={e=>updateV("coloreInt",e.target.value)}>
                          <option value="">‚Äî</option>{coloriDB.map(c=><option key={c.id} value={c.code}>{c.code}</option>)}
                        </select>
                      </div>
                      <div style={{flex:1}}>
                        <div style={{fontSize:9,color:T.sub,marginBottom:2}}>EST</div>
                        <select style={S.select} value={v.coloreEst||""} onChange={e=>updateV("coloreEst",e.target.value)}>
                          <option value="">‚Äî</option>{coloriDB.map(c=><option key={c.id} value={c.code}>{c.code}</option>)}
                        </select>
                      </div>
                    </div>
                }
                <div>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>ACCESSORI</div>
                  <select style={S.select} value={v.coloreAcc||""} onChange={e=>updateV("coloreAcc",e.target.value)}>
                    <option value="">‚Äî Come profili ‚Äî</option>
                    {coloriDB.map(c=><option key={c.id} value={c.code}>{c.code} ‚Äî {c.nome}</option>)}
                  </select>
                </div>
              </div>
            },
            { id:"telaio", icon:"üìê", label:"Telaio / Rifilato",
              badge: v.telaio?(v.telaio==="Z"?"Telaio Z":"Telaio L"):(v.rifilato?"Rifilato":null),
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div style={{display:"flex",gap:6}}>
                  {[{id:"Z",l:"Telaio a Z"},{id:"L",l:"Telaio a L"}].map(t=>(
                    <div key={t.id} onClick={()=>updateV("telaio",v.telaio===t.id?"":t.id)}
                      style={{flex:1,padding:"9px",borderRadius:8,border:`1.5px solid ${v.telaio===t.id?T.acc:T.bdr}`,background:v.telaio===t.id?T.accLt:T.card,textAlign:"center",fontSize:12,fontWeight:700,color:v.telaio===t.id?T.acc:T.sub,cursor:"pointer"}}>
                      {t.l}
                    </div>
                  ))}
                </div>
                {v.telaio==="Z" && <div>
                  <div style={{fontSize:10,color:T.sub,fontWeight:600,marginBottom:2}}>Lunghezza ala (mm)</div>
                  <input style={S.input} type="number" inputMode="numeric" placeholder="es. 35" value={v.telaioAlaZ||""} onChange={e=>updateV("telaioAlaZ",e.target.value)}/>
                </div>}
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <div onClick={()=>updateV("rifilato",!v.rifilato)}
                    style={{width:40,height:22,borderRadius:11,background:v.rifilato?T.acc:T.bdr,cursor:"pointer",position:"relative",flexShrink:0}}>
                    <div style={{position:"absolute",top:2,left:v.rifilato?20:2,width:18,height:18,borderRadius:"50%",background:"#fff",transition:"left 0.15s"}}/>
                  </div>
                  <span style={{fontSize:12,fontWeight:600,color:T.text}}>Rifilato</span>
                </div>
                {v.rifilato && <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
                  {[["rifilSx","‚Üô Sx"],["rifilDx","‚Üò Dx"],["rifilSopra","‚Üë Sopra"],["rifilSotto","‚Üì Sotto"]].map(([f,l])=>(
                    <div key={f}><div style={{fontSize:9,color:T.sub,fontWeight:600,marginBottom:2}}>{l} (mm)</div>
                    <input style={S.input} type="number" inputMode="numeric" placeholder="0" value={v[f]||""} onChange={e=>updateV(f,e.target.value)}/></div>
                  ))}
                </div>}
              </div>
            },
            { id:"finiture", icon:"üî©", label:"Coprifilo / Lamiera",
              badge: (v.coprifilo||v.lamiera)?"‚úì":null,
              body: <div style={{display:"flex",gap:8}}>
                <div style={{flex:1}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>COPRIFILO</div>
                  <select style={S.select} value={v.coprifilo||""} onChange={e=>updateV("coprifilo",e.target.value)}>
                    <option value="">‚Äî No ‚Äî</option>
                    {coprifiliDB.map(c=><option key={c.id} value={c.cod}>{c.cod} ‚Äî {c.nome}</option>)}
                  </select>
                </div>
                <div style={{flex:1}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:3}}>LAMIERA</div>
                  <select style={S.select} value={v.lamiera||""} onChange={e=>updateV("lamiera",e.target.value)}>
                    <option value="">‚Äî No ‚Äî</option>
                    {lamiereDB.map(l=><option key={l.id} value={l.cod}>{l.cod} ‚Äî {l.nome}</option>)}
                  </select>
                </div>
              </div>
            },
            { id:"controtelaio", icon:"üî≤", label:"Controtelaio",
              badge: v.controtelaio?.tipo ? (v.controtelaio.tipo==="singolo"?"Singolo":v.controtelaio.tipo==="doppio"?"Doppio":"Con cassonetto") : null,
              body: <div style={{display:"flex",flexDirection:"column",gap:8}}>
                <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:2}}>TIPO CONTROTELAIO</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {[{id:"",l:"Nessuno",c:T.sub},{id:"singolo",l:"Singolo",c:"#2563eb"},{id:"doppio",l:"Doppio",c:"#7c3aed"},{id:"cassonetto",l:"Con Cassonetto",c:"#b45309"}].map(ct=>(
                    <div key={ct.id} onClick={()=>updateV("controtelaio",{...(v.controtelaio||{}),tipo:ct.id})}
                      style={{flex:1,padding:"8px 6px",borderRadius:8,border:`1.5px solid ${v.controtelaio?.tipo===ct.id?ct.c:T.bdr}`,background:v.controtelaio?.tipo===ct.id?ct.c+"15":T.card,textAlign:"center",cursor:"pointer",minWidth:70}}>
                      <div style={{fontSize:11,fontWeight:700,color:v.controtelaio?.tipo===ct.id?ct.c:T.sub}}>{ct.l}</div>
                    </div>
                  ))}
                </div>
                {v.controtelaio?.tipo==="singolo" && <>
                  <div style={{display:"flex",gap:6}}>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>LARGHEZZA</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.l||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,l:parseInt(e.target.value)||0})}/></div>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>ALTEZZA</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.h||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,h:parseInt(e.target.value)||0})}/></div>
                  </div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>PROFONDIT√Ä</div>
                    <select style={S.select} value={v.controtelaio?.prof||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,prof:e.target.value})}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {ctProfDB.map(p=><option key={p.id} value={p.code}>{p.code} mm</option>)}
                    </select></div>
                  {v.controtelaio?.l > 0 && v.controtelaio?.h > 0 && (
                    <div onClick={()=>{
                      const off = ctOffset;
                      const cl = v.controtelaio.l - off*2;
                      const ch = v.controtelaio.h - off*2;
                      updateMisureBatch(v.id, { lAlto: cl, lCentro: cl, lBasso: cl });
                      updateMisureBatch(v.id, { hSx: ch, hCentro: ch, hDx: ch });
                    }} style={{padding:"10px",borderRadius:10,background:"#2563eb15",border:"1.5px solid #2563eb40",textAlign:"center",cursor:"pointer"}}>
                      <div style={{fontSize:12,fontWeight:700,color:"#2563eb"}}>‚ö° Calcola infisso (offset ‚àí{ctOffset}mm/lato)</div>
                      <div style={{fontSize:10,color:"#2563eb80",marginTop:2}}>{v.controtelaio.l-ctOffset*2} √ó {v.controtelaio.h-ctOffset*2} mm</div>
                    </div>
                  )}
                </>}
                {v.controtelaio?.tipo==="doppio" && <>
                  <div style={{display:"flex",gap:6}}>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>LARGHEZZA</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.l||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,l:parseInt(e.target.value)||0})}/></div>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>ALTEZZA</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.h||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,h:parseInt(e.target.value)||0})}/></div>
                  </div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>SEZIONE INTERNA (infisso interno)</div>
                    <select style={S.select} value={v.controtelaio?.sezInt||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,sezInt:e.target.value})}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {ctSezioniDB.map(s=><option key={s.id} value={s.code}>{s.code}</option>)}
                    </select></div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>SEZIONE ESTERNA (infisso esterno)</div>
                    <select style={S.select} value={v.controtelaio?.sezEst||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,sezEst:e.target.value})}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {ctSezioniDB.map(s=><option key={s.id} value={s.code}>{s.code}</option>)}
                    </select></div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>DISTANZIALE</div>
                    <input style={S.input} type="text" placeholder="es. 30mm" value={v.controtelaio?.distanziale||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,distanziale:e.target.value})}/></div>
                  {v.controtelaio?.l > 0 && v.controtelaio?.h > 0 && (
                    <div onClick={()=>{
                      const off = ctOffset;
                      const cl = v.controtelaio.l - off*2;
                      const ch = v.controtelaio.h - off*2;
                      updateMisureBatch(v.id, { lAlto: cl, lCentro: cl, lBasso: cl });
                      updateMisureBatch(v.id, { hSx: ch, hCentro: ch, hDx: ch });
                    }} style={{padding:"10px",borderRadius:10,background:"#7c3aed15",border:"1.5px solid #7c3aed40",textAlign:"center",cursor:"pointer"}}>
                      <div style={{fontSize:12,fontWeight:700,color:"#7c3aed"}}>‚ö° Calcola infisso (offset ‚àí{ctOffset}mm/lato)</div>
                      <div style={{fontSize:10,color:"#7c3aed80",marginTop:2}}>{v.controtelaio.l-ctOffset*2} √ó {v.controtelaio.h-ctOffset*2} mm</div>
                    </div>
                  )}
                </>}
                {v.controtelaio?.tipo==="cassonetto" && <>
                  <div style={{display:"flex",gap:6}}>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>LARGH. VANO</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.l||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,l:parseInt(e.target.value)||0})}/></div>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>ALT. MAX VANO</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.h||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,h:parseInt(e.target.value)||0})}/></div>
                  </div>
                  <div style={{marginTop:4,padding:"6px 0",borderTop:`1px dashed ${T.bdr}`}}>
                    <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:4}}>CASSONETTO</div>
                  </div>
                  <div style={{display:"flex",gap:6}}>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>H CASSONETTO</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.hCass||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,hCass:parseInt(e.target.value)||0})}/></div>
                    <div style={{flex:1}}><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>P CASSONETTO</div>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="mm" value={v.controtelaio?.pCass||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,pCass:parseInt(e.target.value)||0})}/></div>
                  </div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>SEZIONE CONTROTELAIO</div>
                    <select style={S.select} value={v.controtelaio?.sezione||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,sezione:e.target.value})}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {ctSezioniDB.map(s=><option key={s.id} value={s.code}>{s.code}</option>)}
                    </select></div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>SPALLA CONTROTELAIO</div>
                    <input style={S.input} type="text" placeholder="es. 120mm" value={v.controtelaio?.spalla||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,spalla:e.target.value})}/></div>
                  <div><div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:2}}>MODELLO CIELINO</div>
                    <select style={S.select} value={v.controtelaio?.cielino||""} onChange={e=>updateV("controtelaio",{...v.controtelaio,cielino:e.target.value})}>
                      <option value="">‚Äî Seleziona ‚Äî</option>
                      {ctCieliniDB.map(c=><option key={c.id} value={c.code}>{c.code}</option>)}
                    </select></div>
                  {v.controtelaio?.l > 0 && v.controtelaio?.h > 0 && (
                    <div onClick={()=>{
                      const off = ctOffset;
                      const cl = v.controtelaio.l - off*2;
                      const hInf = v.controtelaio.h - (v.controtelaio.hCass||0) - off*2;
                      updateMisureBatch(v.id, { lAlto: cl, lCentro: cl, lBasso: cl });
                      updateMisura(v.id,"hSx",hInf); updateMisura(v.id,"hCentro",hInf); updateMisura(v.id,"hDx",hInf);
                    }} style={{padding:"10px",borderRadius:10,background:"#b4530915",border:"1.5px solid #b4530940",textAlign:"center",cursor:"pointer"}}>
                      <div style={{fontSize:12,fontWeight:700,color:"#b45309"}}>‚ö° Calcola infisso (offset ‚àí{ctOffset}mm/lato)</div>
                      <div style={{fontSize:10,color:"#b4530980",marginTop:2}}>L: {v.controtelaio.l-ctOffset*2} ¬∑ H: {v.controtelaio.h-(v.controtelaio.hCass||0)-ctOffset*2} mm</div>
                    </div>
                  )}
                </>}
              </div>
            },
          ];

          return (
            <div style={{padding:"6px 16px 2px"}}>
              {sections.map(sec=>{
                const isOpen = vanoInfoOpen===sec.id;
                return (
                  <div key={sec.id} style={{marginBottom:3,borderRadius:10,border:`1px solid ${isOpen?T.acc+"50":T.bdr}`,overflow:"hidden"}}>
                    <div onClick={()=>setVanoInfoOpen(isOpen?null:sec.id)}
                      style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 12px",background:isOpen?T.acc+"06":T.card,cursor:"pointer"}}>
                      <div style={{display:"flex",alignItems:"center",gap:7}}>
                        <span style={{fontSize:14}}>{sec.icon}</span>
                        <span style={{fontSize:12,fontWeight:600,color:T.text}}>{sec.label}</span>
                        {sec.badge && <span style={{...S.badge(T.accLt,T.acc),fontSize:9,padding:"1px 6px"}}>{sec.badge}</span>}
                      </div>
                      <span style={{fontSize:9,color:T.sub,display:"inline-block",transform:isOpen?"rotate(180deg)":"none",transition:"transform 0.15s"}}>‚ñº</span>
                    </div>
                    {isOpen && <div style={{padding:"12px",background:T.bg,borderTop:`1px solid ${T.bdr}`}}>{sec.body}</div>}
                  </div>
                );
              })}
            </div>
          );
        })()}

        {/* Dots progress */}
        <div style={{ display: "flex", justifyContent: "center", gap: 5, padding: "14px 16px 6px" }}>
          {STEPS.map((s, i) => (
            <div key={i} onClick={() => setVanoStep(i)} style={{ width: i === vanoStep ? 18 : 8, height: 8, borderRadius: 4, background: i === vanoStep ? s.color : i < vanoStep ? s.color + "60" : T.bdr, cursor: "pointer", transition: "all 0.2s" }} />
          ))}
        </div>

        <div style={{ padding: "8px 16px" }}>
          {/* Step header card */}
          <div style={{ display: "flex", alignItems: "center", gap: 14, padding: "14px 16px", background: step.color + "10", borderRadius: 14, border: `1px solid ${step.color}25`, marginBottom: 12 }}>
            <div style={{ width: 50, height: 50, borderRadius: 12, background: step.color + "20", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 24 }}>{step.icon}</div>
            <div>
              <div style={{ fontSize: 15, fontWeight: 800, color: step.color }}>{step.icon} {step.title}</div>
              <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{step.desc}</div>
              {vanoStep === 0 && <div style={{ fontSize: 11, fontWeight: 700, color: T.text, marginTop: 2 }}>{["lAlto","lCentro","lBasso","hSx","hCentro","hDx","d1","d2"].filter(f => m[f] > 0).length}/8 inserite</div>}
            </div>
          </div>

          {/* Warnings */}
          {vanoStep === 0 && (hasWarnings || hasHWarnings) && (
            <div style={{ padding: "8px 14px", borderRadius: 10, background: "#fff3e0", border: "1px solid #ffe0b2", marginBottom: 12, fontSize: 11, color: "#e65100" }}>
              {hasWarnings && <div>‚ö† Nessuna larghezza inserita</div>}
              {hasHWarnings && <div>‚ö† Nessuna altezza inserita</div>}
            </div>
          )}

          {/* === STEP 0: MISURE (larghezze + altezze + diagonali) === */}
          {vanoStep === 0 && (
            <>
              {/* ‚ïê‚ïê‚ïê MISURE OUTDOOR: Tende / Pergole ‚ïê‚ïê‚ïê */}
              {(() => {
                const outdoorCodes = ["TDBR","TDCAD","TDCAP","TDVER","TDRUL","TDPERG","TDZIP","TDVELA","VENEZIA","TDS","TDR","TVE","PBC","PGA","PGF","TCA","TCB","ZTE"];
                if (!outdoorCodes.includes(v.tipo)) return null;
                const isPergola = ["TDPERG","PBC","PGA","PGF"].includes(v.tipo);
                const isBracci = ["TDBR","TCB","TCA","TDCAP"].includes(v.tipo);
                const isVela = v.tipo === "TDVELA";
                return (
                  <div style={{ marginBottom:16 }}>
                    <div style={{ padding:"10px 14px", borderRadius:10, background:"#ff950010", border:"1px solid #ff950030", marginBottom:12 }}>
                      <div style={{ fontSize:11, fontWeight:700, color:"#ff9500" }}>‚òÄÔ∏è Misure {isPergola ? "Pergola" : isBracci ? "Tenda a bracci" : isVela ? "Vela ombreggiante" : "Tenda/Schermatura"}</div>
                      <div style={{ fontSize:10, color:T.sub, marginTop:2 }}>{isPergola ? "Larghezza √ó Profondit√† √ó Altezza colonne" : isBracci ? "Larghezza telo √ó Sporgenza (aggetto)" : "Larghezza √ó Altezza (caduta)"}</div>
                    </div>

                    {/* LARGHEZZA ‚Äî sempre presente */}
                    <div style={{ fontSize:11, fontWeight:800, color:"#507aff", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6 }}>üìè Larghezza</div>
                    {bInput("Larghezza mm", "lCentro")}

                    {/* ALTEZZA/DROP ‚Äî sempre presente */}
                    <div style={{ fontSize:11, fontWeight:800, color:"#34c759", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6, marginTop:12 }}>üìê {isPergola ? "Altezza colonne" : "Altezza / Drop"}</div>
                    {bInput(isPergola ? "Altezza colonne mm" : "Altezza (caduta) mm", "hCentro")}

                    {/* PROFONDITA/SPORGENZA ‚Äî pergole e bracci */}
                    {(isPergola || isBracci) && (<>
                      <div style={{ fontSize:11, fontWeight:800, color:"#ff9500", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6, marginTop:12 }}>‚ÜïÔ∏è {isPergola ? "Profondit√†" : "Sporgenza (Aggetto)"}</div>
                      {bInput(isPergola ? "Profondit√† mm" : "Sporgenza/Aggetto mm", "sporgenza")}
                    </>)}

                    {/* VELA: 3 lati */}
                    {isVela && (<>
                      <div style={{ fontSize:11, fontWeight:800, color:"#ff9500", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6, marginTop:12 }}>üìê Lati vela</div>
                      {bInput("Lato 2 mm", "lAlto")}
                      {bInput("Lato 3 mm", "lBasso")}
                    </>)}

                    {/* PERGOLA: extra fields */}
                    {isPergola && (<>
                      <div style={{ fontSize:11, fontWeight:800, color:"#5856d6", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6, marginTop:16, borderTop:"1px solid "+T.bdr, paddingTop:12 }}>üèó Configurazione Pergola</div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginBottom:8 }}>
                        <div>
                          <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>N¬∞ MODULI</div>
                          <input style={S.input} type="number" placeholder="1" value={v.nModuli||""} onChange={e => updateV("nModuli", parseInt(e.target.value)||1)}/>
                        </div>
                        <div>
                          <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>TIPO LAMA</div>
                          <select style={S.select} value={v.tipoLama||""} onChange={e => updateV("tipoLama", e.target.value)}>
                            <option value="">‚Äî Tipo ‚Äî</option>
                            <option value="orientabile">Orientabile</option>
                            <option value="retrattile">Retrattile</option>
                            <option value="impacchettabile">Impacchettabile</option>
                            <option value="fissa">Fissa</option>
                          </select>
                        </div>
                      </div>
                      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
                        <div>
                          <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>STRUTTURA</div>
                          <select style={S.select} value={v.struttura||""} onChange={e => updateV("struttura", e.target.value)}>
                            <option value="">‚Äî Struttura ‚Äî</option>
                            <option value="alluminio">Alluminio</option>
                            <option value="acciaio">Acciaio</option>
                            <option value="legno">Legno</option>
                          </select>
                        </div>
                        <div>
                          <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>TIPO</div>
                          <select style={S.select} value={v.tipoPergola||""} onChange={e => updateV("tipoPergola", e.target.value)}>
                            <option value="">‚Äî Tipo ‚Äî</option>
                            <option value="addossata">Addossata a muro</option>
                            <option value="freestanding">Autoportante</option>
                          </select>
                        </div>
                      </div>
                    </>)}

                    {/* COMUNE: montaggio + motorizzazione */}
                    <div style={{ fontSize:11, fontWeight:800, color:"#86868b", textTransform:"uppercase", letterSpacing:"0.08em", marginBottom:6, marginTop:16, borderTop:"1px solid "+T.bdr, paddingTop:12 }}>‚öôÔ∏è Installazione</div>
                    <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8, marginBottom:8 }}>
                      <div>
                        <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>MONTAGGIO</div>
                        <select style={S.select} value={v.montaggio||""} onChange={e => updateV("montaggio", e.target.value)}>
                          <option value="">‚Äî Montaggio ‚Äî</option>
                          <option value="parete">A parete</option>
                          <option value="soffitto">A soffitto</option>
                          <option value="nicchia">In nicchia</option>
                          <option value="pavimento">A pavimento</option>
                        </select>
                      </div>
                      <div>
                        <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>ORIENTAMENTO</div>
                        <select style={S.select} value={v.orientamento||""} onChange={e => updateV("orientamento", e.target.value)}>
                          <option value="">‚Äî Orientamento ‚Äî</option>
                          <option value="nord">Nord</option>
                          <option value="sud">Sud</option>
                          <option value="est">Est</option>
                          <option value="ovest">Ovest</option>
                        </select>
                      </div>
                    </div>
                    <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:8 }}>
                      <div>
                        <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>MOTORIZZAZIONE</div>
                        <select style={S.select} value={v.motorizzazione||""} onChange={e => updateV("motorizzazione", e.target.value)}>
                          <option value="">‚Äî Motorizzazione ‚Äî</option>
                          <option value="manuale">Manuale</option>
                          <option value="motore">Motore tubolare</option>
                          <option value="motore_radio">Motore + radiocomando</option>
                          <option value="domotica">Domotica/smart</option>
                          <option value="sensore_vento">Con sensore vento</option>
                          <option value="sensore_sole">Con sensore sole</option>
                        </select>
                      </div>
                      <div>
                        <div style={{ fontSize:9, fontWeight:700, color:T.sub, marginBottom:2 }}>TESSUTO/MATERIALE</div>
                        <input style={S.input} placeholder="es. Acrilico 300g" value={v.tessuto||""} onChange={e => updateV("tessuto", e.target.value)}/>
                      </div>
                    </div>

                    {/* Altezza montaggio da terra */}
                    <div style={{ marginTop:8 }}>
                      {bInput("Altezza montaggio da terra mm", "hMontaggio")}
                    </div>

                    {/* Riepilogo visivo */}
                    {m.lCentro > 0 && m.hCentro > 0 && (
                      <div style={{ marginTop:12, padding:12, borderRadius:10, background:T.card, border:"1px solid "+T.bdr, textAlign:"center" }}>
                        <div style={{ fontSize:10, color:T.sub, fontWeight:700, marginBottom:4 }}>üìê RIEPILOGO</div>
                        <div style={{ fontSize:16, fontWeight:900, color:T.text }}>
                          {m.lCentro} √ó {m.hCentro} {(m.sporgenza||isPergola) ? " √ó " + (m.sporgenza||"‚Äî") : ""} mm
                        </div>
                        <div style={{ fontSize:11, color:T.sub }}>
                          {((m.lCentro/1000) * (isPergola ? (m.sporgenza||m.hCentro)/1000 : m.hCentro/1000)).toFixed(2)} m¬≤
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}

              {/* ‚ïê‚ïê‚ïê MISURE STANDARD: Serramenti (8 punti) ‚ïê‚ïê‚ïê */}
              {!["TDBR","TDCAD","TDCAP","TDVER","TDRUL","TDPERG","TDZIP","TDVELA","VENEZIA","TDS","TDR","TVE","PBC","PGA","PGF","TCA","TCB","ZTE"].includes(v.tipo) && (<>
              <div style={{ fontSize: 11, fontWeight: 800, color: "#507aff", textTransform: "uppercase", letterSpacing: "0.08em", marginBottom: 6, display: "flex", alignItems: "center", gap: 6 }}>üìè Larghezze</div>
              {bInput("Larghezza ALTO", "lAlto")}
              {m.lAlto > 0 && !m.lCentro && !m.lBasso && (
                <div onClick={() => { updateMisura(v.id, "lCentro", m.lAlto); updateMisura(v.id, "lBasso", m.lAlto); }} style={{ margin: "-4px 0 12px", padding: "10px", borderRadius: 10, background: T.accLt, border: `1px solid ${T.acc}40`, textAlign: "center", cursor: "pointer", fontSize: 13, fontWeight: 700, color: T.acc }}>
                  = Tutte uguali ({m.lAlto} mm)
                </div>
              )}
              {bInput("Larghezza CENTRO (luce netta)", "lCentro")}
              {bInput("Larghezza BASSO", "lBasso")}

              {/* ALTEZZE */}
              <div style={{ fontSize: 11, fontWeight: 800, color: "#34c759", textTransform: "uppercase", letterSpacing: "0.08em", marginBottom: 6, marginTop: 16, display: "flex", alignItems: "center", gap: 6, borderTop: `1px solid ${T.bdr}`, paddingTop: 16 }}>üìê Altezze</div>
              {bInput("Altezza SINISTRA", "hSx")}
              {m.hSx > 0 && !m.hCentro && !m.hDx && (
                <div onClick={() => { updateMisura(v.id, "hCentro", m.hSx); updateMisura(v.id, "hDx", m.hSx); }} style={{ margin: "-4px 0 12px", padding: "10px", borderRadius: 10, background: T.accLt, border: `1px solid ${T.acc}40`, textAlign: "center", cursor: "pointer", fontSize: 13, fontWeight: 700, color: T.acc }}>
                  = Tutte uguali ({m.hSx} mm)
                </div>
              )}
              {bInput("Altezza CENTRO", "hCentro")}
              {bInput("Altezza DESTRA", "hDx")}

              {/* DIAGONALI */}
              <div style={{ fontSize: 11, fontWeight: 800, color: "#ff9500", textTransform: "uppercase", letterSpacing: "0.08em", marginBottom: 6, marginTop: 16, display: "flex", alignItems: "center", gap: 6, borderTop: `1px solid ${T.bdr}`, paddingTop: 16 }}>‚úï Diagonali</div>
              {bInput("Diagonale 1 ‚Üó", "d1")}
              {bInput("Diagonale 2 ‚Üò", "d2")}
              {fSq !== null && fSq > 3 && (
                <div style={{ padding: "10px 14px", borderRadius: 10, background: "#ffebee", border: "1px solid #ef9a9a", marginBottom: 12 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: "#c62828" }}>‚ö† Fuori squadra: {fSq}mm</div>
                  <div style={{ fontSize: 11, color: "#b71c1c" }}>Differenza superiore a 3mm ‚Äî segnalare in ufficio</div>
                </div>
              )}
              {fSq !== null && fSq <= 3 && (
                <div style={{ padding: "10px 14px", borderRadius: 10, background: "#e8f5e9", border: "1px solid #a5d6a7" }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: "#2e7d32" }}>‚úÖ In squadra ‚Äî differenza: {fSq}mm</div>
                </div>
              )}
            </>)}
          </>
          )}

          {/* === STEP 1: DETTAGLI (accordion) === */}
          {vanoStep === 1 && (
            <>
              {/* Spallette */}
              <div onClick={() => setDetailOpen(d => ({...d, spallette: !d.spallette}))} style={{ padding: "12px 16px", borderRadius: 12, border: `1px solid ${detailOpen.spallette ? "#32ade6" : T.bdr}`, background: detailOpen.spallette ? "#32ade608" : T.card, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>üß±</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: detailOpen.spallette ? "#32ade6" : T.text }}>Spallette</span>
                  {(m.spSx||m.spDx||m.spSopra||m.imbotte) && <span style={{ fontSize: 10, color: "#32ade6", fontWeight: 700, background: "#32ade615", padding: "2px 8px", borderRadius: 6 }}>{[m.spSx,m.spDx,m.spSopra,m.imbotte].filter(x=>x>0).length}/4</span>}
                </div>
                <span style={{ fontSize: 13, color: T.sub, transform: detailOpen.spallette ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s" }}>‚ñæ</span>
              </div>
              {detailOpen.spallette && (
                <div style={{ marginBottom: 12 }}>
              {bInput("Spalletta SINISTRA", "spSx")}
              {bInput("Spalletta DESTRA", "spDx")}
              {bInput("Spalletta SOPRA", "spSopra")}
              {bInput("Profondit√† IMBOTTE", "imbotte")}
              {/* DISEGNO LIBERO SPALLETTE */}
              <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, marginTop: 8, overflow: "hidden" }}>
                <div style={{ padding: "8px 14px", borderBottom: `1px solid ${T.bdr}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <span style={{ fontSize: 12, fontWeight: 700, color: "#32ade6" }}>‚úèÔ∏è Disegno spallette</span>
                  <div style={{ display: "flex", gap: 6 }}>
                    <button onClick={() => { const ctx = spCanvasRef.current?.getContext("2d"); ctx?.clearRect(0, 0, 380, 200); }} style={{ padding: "4px 10px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üóù‚Äò Pulisci</button>
                    <button style={{ padding: "4px 10px", borderRadius: 6, border: "none", background: T.grn, color: "#fff", fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üíæ Salva</button>
                  </div>
                </div>
                <canvas ref={spCanvasRef} width={380} height={200} style={{ width: "100%", height: 200, background: "#fff", touchAction: "none", cursor: "crosshair" }}
                  onPointerDown={e=>{spCanvasRef.current?.setPointerCapture(e.pointerId);setSpDrawing(true);const cv=spCanvasRef.current;const ctx=cv?.getContext("2d");if(ctx&&cv){const r=cv.getBoundingClientRect();const sx=cv.width/r.width,sy=cv.height/r.height;ctx.beginPath();ctx.moveTo((e.clientX-r.left)*sx,(e.clientY-r.top)*sy);ctx.strokeStyle=penColor;ctx.lineWidth=penSize;ctx.lineCap="round";ctx.lineJoin="round";}}}
                  onPointerMove={e=>{if(!spDrawing)return;const cv=spCanvasRef.current;const ctx=cv?.getContext("2d");if(ctx&&cv){const r=cv.getBoundingClientRect();const sx=cv.width/r.width,sy=cv.height/r.height;ctx.lineTo((e.clientX-r.left)*sx,(e.clientY-r.top)*sy);ctx.stroke();}}}
                  onPointerUp={() => setSpDrawing(false)}
                  onPointerLeave={() => setSpDrawing(false)}
                />
                <div style={{ padding: "6px 14px", display: "flex", gap: 4 }}>
                  {["#1d1d1f", "#ff3b30", "#007aff", "#34c759", "#ff9500"].map(c => (
                    <div key={c} onClick={() => setPenColor(c)} style={{ width: 20, height: 20, borderRadius: "50%", background: c, border: penColor === c ? `3px solid ${T.acc}` : "2px solid transparent", cursor: "pointer" }} />
                  ))}
                  <div style={{ marginLeft: "auto", display: "flex", gap: 3 }}>
                    {[1, 2, 4].map(s => (
                      <div key={s} onClick={() => setPenSize(s)} style={{ width: 22, height: 22, borderRadius: 6, background: penSize === s ? T.accLt : "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                        <div style={{ width: s * 2 + 2, height: s * 2 + 2, borderRadius: "50%", background: T.text }} />
                      </div>
                    ))}
                  </div>
                </div>
              </div>
                </div>
              )}
              {/* Davanzale + Cassonetto */}
              <div onClick={() => setDetailOpen(d => ({...d, davanzale: !d.davanzale}))} style={{ padding: "12px 16px", borderRadius: 12, border: `1px solid ${detailOpen.davanzale ? "#ff2d55" : T.bdr}`, background: detailOpen.davanzale ? "#ff2d5508" : T.card, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>‚¨á</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: detailOpen.davanzale ? "#ff2d55" : T.text }}>Davanzale + Cassonetto</span>
                  {(m.davProf||m.davSporg||m.soglia||v.cassonetto) && <span style={{ fontSize: 10, color: "#ff2d55", fontWeight: 700, background: "#ff2d5515", padding: "2px 8px", borderRadius: 6 }}>{v.cassonetto ? "üßä" : ""} {[m.davProf,m.davSporg,m.soglia].filter(x=>x>0).length}/3</span>}
                </div>
                <span style={{ fontSize: 13, color: T.sub, transform: detailOpen.davanzale ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s" }}>‚ñæ</span>
              </div>
              {detailOpen.davanzale && (
                <div style={{ marginBottom: 12 }}>
              {bInput("Davanzale PROFONDIT√Ä", "davProf")}
              {bInput("Davanzale SPORGENZA", "davSporg")}
              {bInput("Altezza SOGLIA", "soglia")}
              {/* Cassonetto toggle */}
              <div style={{ marginTop: 8, padding: "12px 16px", borderRadius: 12, border: `1px dashed ${T.bdr}`, display: "flex", alignItems: "center", gap: 10, cursor: "pointer" }} onClick={() => {
                const nv = { ...v, cassonetto: !v.cassonetto };
                setSelectedVano(nv);
                if(selectedRilievo){const updR3={...selectedRilievo,vani:selectedRilievo.vani.map(x=>x.id===v.id?nv:x)};setCantieri(cs=>cs.map(c=>c.id===selectedCM?.id?{...c,rilievi:c.rilievi.map(r2=>r2.id===selectedRilievo.id?updR3:r2)}:c));setSelectedRilievo(updR3);}
              }}>
                <span style={{ fontSize: 12, color: T.sub }}>+</span>
                <span style={{ fontSize: 14 }}>üßä</span>
                <span style={{ fontSize: 13, color: T.sub }}>{v.cassonetto ? "Cassonetto attivo" : "Ha un cassonetto? Tocca per aggiungere"}</span>
              </div>
              {v.cassonetto && (
                <div style={{ marginTop: 8 }}>
                  {bInput("Cassonetto LARGHEZZA", "casL")}
                  {bInput("Cassonetto ALTEZZA", "casH")}
                  {bInput("Cassonetto PROFONDIT√Ä", "casP")}
                  {bInput("Cielino LARGHEZZA", "casLCiel")}
                  {bInput("Cielino PROFONDIT√Ä", "casPCiel")}
                </div>
              )}
                </div>
              )}
              {/* Accessori */}
              <div onClick={() => setDetailOpen(d => ({...d, accessori: !d.accessori}))} style={{ padding: "12px 16px", borderRadius: 12, border: `1px solid ${detailOpen.accessori ? "#af52de" : T.bdr}`, background: detailOpen.accessori ? "#af52de08" : T.card, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>‚úö</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: detailOpen.accessori ? "#af52de" : T.text }}>Accessori</span>
                  {(v.accessori?.tapparella?.attivo||v.accessori?.persiana?.attivo||v.accessori?.zanzariera?.attivo) && <span style={{ fontSize: 10, color: "#af52de", fontWeight: 700, background: "#af52de15", padding: "2px 8px", borderRadius: 6 }}>{[v.accessori?.tapparella?.attivo,v.accessori?.persiana?.attivo,v.accessori?.zanzariera?.attivo].filter(Boolean).length} attivi</span>}
                </div>
                <span style={{ fontSize: 13, color: T.sub, transform: detailOpen.accessori ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s" }}>‚ñæ</span>
              </div>
              {detailOpen.accessori && (
                <div style={{ marginBottom: 12 }}>
              {["tapparella", "persiana", "zanzariera", "cassonetto"].map(acc => {
                if (acc === "cassonetto") {
                  const casColor = "#b45309";
                  const focusNext = (ids, cur) => { const i = ids.indexOf(cur); if (i < ids.length - 1) { const el = document.getElementById(ids[i + 1]); if (el) { el.focus(); el.scrollIntoView({ behavior: "smooth", block: "center" }); } } };
                  const casIds = [`cas-L-${v.id}`, `cas-H-${v.id}`, `cas-P-${v.id}`, `cas-LC-${v.id}`, `cas-PC-${v.id}`];
                  const casInput = (label, field, idx) => (
                    <div key={field} style={{ marginBottom: 8 }}>
                      <div style={{ fontSize: 11, color: T.text, marginBottom: 4 }}>{label}</div>
                      <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                        <input id={casIds[idx]} style={{ flex: 1, padding: "10px", fontSize: 14, fontFamily: FM, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card }} type="number" inputMode="numeric" enterKeyHint={idx < 4 ? "next" : "done"} placeholder="" value={m[field] || ""} onChange={e => updateMisura(v.id, field, e.target.value)} onKeyDown={e => { if (e.key === "Enter") { e.preventDefault(); focusNext(casIds, casIds[idx]); } }} />
                        <span style={{ fontSize: 11, color: T.sub, background: T.bg, padding: "6px 8px", borderRadius: 6 }}>mm</span>
                        {idx < 4 && <div onClick={() => focusNext(casIds, casIds[idx])} style={{ padding: "8px 12px", borderRadius: 8, background: casColor, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer", whiteSpace: "nowrap" }}>‚Üí</div>}
                      </div>
                    </div>
                  );
                  return (
                    <div key={acc} style={{ marginBottom: 8, borderRadius: 12, border: `1px ${v.cassonetto ? "solid" : "dashed"} ${v.cassonetto ? casColor + "40" : T.bdr}`, overflow: "hidden", background: T.card }}>
                      {!v.cassonetto ? (
                        <div onClick={() => { const nv = { ...v, cassonetto: true }; setSelectedVano(nv); if(selectedRilievo){const updR3={...selectedRilievo,vani:selectedRilievo.vani.map(x=>x.id===v.id?nv:x)};setCantieri(cs=>cs.map(c=>c.id===selectedCM?.id?{...c,rilievi:c.rilievi.map(r2=>r2.id===selectedRilievo.id?updR3:r2)}:c));setSelectedRilievo(updR3);} }} style={{ padding: "14px 16px", textAlign: "center", cursor: "pointer" }}>
                          <span style={{ fontSize: 12, color: T.sub }}>+ üßä Aggiungi Cassonetto</span>
                        </div>
                      ) : (
                        <>
                          <div style={{ padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: `1px solid ${T.bdr}` }}>
                            <span style={{ fontSize: 13, fontWeight: 700, color: casColor }}>üßä Cassonetto</span>
                            <div onClick={() => { const nv = { ...v, cassonetto: false }; setSelectedVano(nv); if(selectedRilievo){const updR3={...selectedRilievo,vani:selectedRilievo.vani.map(x=>x.id===v.id?nv:x)};setCantieri(cs=>cs.map(c=>c.id===selectedCM?.id?{...c,rilievi:c.rilievi.map(r2=>r2.id===selectedRilievo.id?updR3:r2)}:c));setSelectedRilievo(updR3);} }} style={{ fontSize: 11, color: T.sub, cursor: "pointer" }}>‚ñ≤ Chiudi</div>
                          </div>
                          <div style={{ padding: "12px 16px" }}>
                            <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Tipo Cassonetto</div>
                            <div style={{ display: "flex", gap: 4, marginBottom: 12, flexWrap: "wrap" }}>
                              {tipoCassonettoDB.map(tc => (
                                <div key={tc.id} onClick={() => updateVanoField(v.id, "casTipo", tc.code)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${v.casTipo === tc.code ? casColor : T.bdr}`, background: v.casTipo === tc.code ? casColor + "18" : T.card, fontSize: 12, cursor: "pointer", fontWeight: v.casTipo === tc.code ? 700 : 400, color: v.casTipo === tc.code ? casColor : T.text }}>{tc.code}</div>
                              ))}
                            </div>
                            {casInput("Larghezza", "casL", 0)}
                            {casInput("Altezza", "casH", 1)}
                            {casInput("Profondit√†", "casP", 2)}
                            <div style={{ marginTop: 4, marginBottom: 4, padding: "6px 0", borderTop: `1px dashed ${T.bdr}` }}>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 2 }}>Cielino</div>
                            </div>
                            {casInput("Larghezza Cielino", "casLCiel", 3)}
                            {casInput("Profondit√† Cielino", "casPCiel", 4)}
                            <div onClick={() => { const nv = { ...v, cassonetto: false }; setSelectedVano(nv); if(selectedRilievo){const updR3={...selectedRilievo,vani:selectedRilievo.vani.map(x=>x.id===v.id?nv:x)};setCantieri(cs=>cs.map(c=>c.id===selectedCM?.id?{...c,rilievi:c.rilievi.map(r2=>r2.id===selectedRilievo.id?updR3:r2)}:c));setSelectedRilievo(updR3);} }} style={{ marginTop: 10, padding: "8px", borderRadius: 8, border: `1px dashed #ef5350`, textAlign: "center", fontSize: 11, color: "#ef5350", cursor: "pointer" }}>
                              üóë Rimuovi cassonetto
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  );
                }
                const a = v.accessori?.[acc] || { attivo: false };
                const accColors = { tapparella: "#ff9500", persiana: "#007aff", zanzariera: "#ff2d55" };
                const accIcons = { tapparella: "ü™ü", persiana: "üè†", zanzariera: "ü¶ü" };
                const focusNextAcc = (ids, cur) => { const i = ids.indexOf(cur); if (i < ids.length - 1) { const el = document.getElementById(ids[i + 1]); if (el) { el.focus(); el.scrollIntoView({ behavior: "smooth", block: "center" }); } } };
                const accInputIds = [`${acc}-L-${v.id}`, `${acc}-H-${v.id}`];
                return (
                  <div key={acc} style={{ marginBottom: 8, borderRadius: 12, border: `1px ${a.attivo ? "solid" : "dashed"} ${a.attivo ? accColors[acc] + "40" : T.bdr}`, overflow: "hidden", background: T.card }}>
                    {!a.attivo ? (
                      <div onClick={() => toggleAccessorio(v.id, acc)} style={{ padding: "14px 16px", textAlign: "center", cursor: "pointer" }}>
                        <span style={{ fontSize: 12, color: T.sub }}>+ {accIcons[acc]} Aggiungi {acc.charAt(0).toUpperCase() + acc.slice(1)}</span>
                      </div>
                    ) : (
                      <>
                        <div style={{ padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", borderBottom: `1px solid ${T.bdr}` }}>
                          <span style={{ fontSize: 13, fontWeight: 700, color: accColors[acc] }}>{accIcons[acc]} {acc.charAt(0).toUpperCase() + acc.slice(1)}</span>
                          <div onClick={() => toggleAccessorio(v.id, acc)} style={{ fontSize: 11, color: T.sub, cursor: "pointer" }}>‚ñ≤ Chiudi</div>
                        </div>
                        <div style={{ padding: "12px 16px" }}>
                          <div style={{ marginBottom: 10 }}>
                            <div style={{ fontSize: 11, color: T.text, marginBottom: 4 }}>Larghezza</div>
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                              <input id={accInputIds[0]} style={{ flex: 1, padding: "10px", fontSize: 14, fontFamily: FM, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card }} type="number" inputMode="numeric" enterKeyHint="next" placeholder="" value={v.accessori?.[acc]?.l || ""} onChange={e => updateAccessorio(v.id, acc, "l", parseInt(e.target.value) || 0)} onKeyDown={e => { if (e.key === "Enter") { e.preventDefault(); focusNextAcc(accInputIds, accInputIds[0]); } }} />
                              <span style={{ fontSize: 11, color: T.sub, background: T.bg, padding: "6px 8px", borderRadius: 6 }}>mm</span>
                              <div onClick={() => focusNextAcc(accInputIds, accInputIds[0])} style={{ padding: "8px 12px", borderRadius: 8, background: accColors[acc], color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>‚Üí</div>
                            </div>
                          </div>
                          <div style={{ marginBottom: 10 }}>
                            <div style={{ fontSize: 11, color: T.text, marginBottom: 4 }}>Altezza</div>
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                              <input id={accInputIds[1]} style={{ flex: 1, padding: "10px", fontSize: 14, fontFamily: FM, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card }} type="number" inputMode="numeric" enterKeyHint="done" placeholder="" value={v.accessori?.[acc]?.h || ""} onChange={e => updateAccessorio(v.id, acc, "h", parseInt(e.target.value) || 0)} />
                              <span style={{ fontSize: 11, color: T.sub, background: T.bg, padding: "6px 8px", borderRadius: 6 }}>mm</span>
                            </div>
                          </div>
                          {acc === "tapparella" && (
                            <>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Materiale</div>
                              <div style={{ display: "flex", gap: 4, marginBottom: 10, flexWrap: "wrap" }}>
                                {["PVC", "Alluminio", "Acciaio", "Legno"].map(mat => (
                                  <div key={mat} onClick={() => updateAccessorio(v.id, acc, "materiale", mat)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${v.accessori?.[acc]?.materiale === mat ? "#ff9500" : T.bdr}`, background: v.accessori?.[acc]?.materiale === mat ? "#ff950018" : T.card, fontSize: 12, cursor: "pointer", fontWeight: v.accessori?.[acc]?.materiale === mat ? 700 : 400, color: v.accessori?.[acc]?.materiale === mat ? "#ff9500" : T.text }}>{mat}</div>
                                ))}
                              </div>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Motorizzata</div>
                              <div style={{ display: "flex", gap: 4, marginBottom: 10 }}>
                                {["S√¨", "No"].map(mot => (
                                  <div key={mot} onClick={() => updateAccessorio(v.id, acc, "motorizzata", mot)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${v.accessori?.[acc]?.motorizzata === mot ? "#34c759" : T.bdr}`, background: v.accessori?.[acc]?.motorizzata === mot ? "#34c75918" : T.card, fontSize: 12, cursor: "pointer", fontWeight: v.accessori?.[acc]?.motorizzata === mot ? 700 : 400, color: v.accessori?.[acc]?.motorizzata === mot ? "#34c759" : T.text }}>{mot}</div>
                                ))}
                              </div>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Tipo Misura</div>
                              <select style={{ width: "100%", padding: "10px", fontSize: 12, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card, fontFamily: FF, marginBottom: 10 }} value={v.accessori?.[acc]?.tipoMisura || ""} onChange={e => updateAccessorio(v.id, acc, "tipoMisura", e.target.value)}>
                                <option value="">‚Äî Seleziona tipo misura ‚Äî</option>
                                {tipoMisuraTappDB.map(tm => <option key={tm.id} value={tm.code}>{tm.code}</option>)}
                              </select>
                            </>
                          )}
                          {acc === "persiana" && (
                            <>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Tipologia Telaio</div>
                              <div style={{ display: "flex", gap: 4, marginBottom: 10, flexWrap: "wrap" }}>
                                {telaiPersianaDB.map(tp => (
                                  <div key={tp.id} onClick={() => updateAccessorio(v.id, acc, "telaio", tp.code)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${v.accessori?.[acc]?.telaio === tp.code ? "#007aff" : T.bdr}`, background: v.accessori?.[acc]?.telaio === tp.code ? "#007aff18" : T.card, fontSize: 12, cursor: "pointer", fontWeight: v.accessori?.[acc]?.telaio === tp.code ? 700 : 400, color: v.accessori?.[acc]?.telaio === tp.code ? "#007aff" : T.text }}>{tp.code}</div>
                                ))}
                              </div>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>4¬∞ Lato / Posizionamento</div>
                              <div style={{ display: "flex", gap: 4, marginBottom: 10, flexWrap: "wrap" }}>
                                {posPersianaDB.map(pp => (
                                  <div key={pp.id} onClick={() => updateAccessorio(v.id, acc, "posizionamento", pp.code)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${v.accessori?.[acc]?.posizionamento === pp.code ? "#007aff" : T.bdr}`, background: v.accessori?.[acc]?.posizionamento === pp.code ? "#007aff18" : T.card, fontSize: 12, cursor: "pointer", fontWeight: v.accessori?.[acc]?.posizionamento === pp.code ? 700 : 400, color: v.accessori?.[acc]?.posizionamento === pp.code ? "#007aff" : T.text }}>{pp.code}</div>
                                ))}
                              </div>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Tipo Misura</div>
                              <select style={{ width: "100%", padding: "10px", fontSize: 12, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card, fontFamily: FF, marginBottom: 10 }} value={v.accessori?.[acc]?.tipoMisura || ""} onChange={e => updateAccessorio(v.id, acc, "tipoMisura", e.target.value)}>
                                <option value="">‚Äî Seleziona tipo misura ‚Äî</option>
                                {tipoMisuraDB.map(tm => <option key={tm.id} value={tm.code}>{tm.code}</option>)}
                              </select>
                            </>
                          )}
                          {acc === "zanzariera" && (
                            <>
                              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Tipo Misura</div>
                              <select style={{ width: "100%", padding: "10px", fontSize: 12, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card, fontFamily: FF, marginBottom: 10 }} value={v.accessori?.[acc]?.tipoMisura || ""} onChange={e => updateAccessorio(v.id, acc, "tipoMisura", e.target.value)}>
                                <option value="">‚Äî Seleziona tipo misura ‚Äî</option>
                                {tipoMisuraZanzDB.map(tm => <option key={tm.id} value={tm.code}>{tm.code}</option>)}
                              </select>
                            </>
                          )}
                          <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6, textTransform: "uppercase" }}>Colore</div>
                          <select style={{ width: "100%", padding: "10px", fontSize: 12, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card, fontFamily: FF }} value={v.accessori?.[acc]?.colore || ""} onChange={e => updateAccessorio(v.id, acc, "colore", e.target.value)}>
                            <option value="">Colore</option>
                            {coloriDB.map(c => <option key={c.id} value={c.code}>{c.code} ‚Äî {c.nome}</option>)}
                          </select>
                          <div onClick={() => toggleAccessorio(v.id, acc)} style={{ marginTop: 10, padding: "8px", borderRadius: 8, border: `1px dashed #ef5350`, textAlign: "center", fontSize: 11, color: "#ef5350", cursor: "pointer" }}>
                            üóù‚Äò Rimuovi {acc}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                );
              })}
                </div>
              )}
              {/* Voci Libere */}
              <div onClick={() => setDetailOpen(d => ({...d, vociLibere: !d.vociLibere}))} style={{ padding: "12px 16px", borderRadius: 12, border: `1px solid ${detailOpen.vociLibere ? "#ff9500" : T.bdr}`, background: detailOpen.vociLibere ? "#ff950008" : T.card, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>üì¶</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: detailOpen.vociLibere ? "#ff9500" : T.text }}>Voci libere</span>
                  {v.vociLibere?.length > 0 && <span style={{ fontSize: 10, color: "#ff9500", fontWeight: 700, background: "#ff950015", padding: "2px 8px", borderRadius: 6 }}>{v.vociLibere.length} voc{v.vociLibere.length === 1 ? "e" : "i"}</span>}
                </div>
                <span style={{ fontSize: 13, color: T.sub, transform: detailOpen.vociLibere ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s" }}>‚ñæ</span>
              </div>
              {detailOpen.vociLibere && (
                <div style={{ marginBottom: 12, padding: "0 4px" }}>
                  {(v.vociLibere || []).map((voce, vi) => (
                    <div key={voce.id || vi} style={{ padding: 10, borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, marginBottom: 8 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                        <span style={{ fontSize: 11, fontWeight: 700, color: "#ff9500" }}>Voce {vi + 1}</span>
                        <div onClick={() => {
                          const newVoci = (v.vociLibere || []).filter((_, i) => i !== vi);
                          updateVanoField(v.id, "vociLibere", newVoci);
                        }} style={{ fontSize: 10, color: T.red, cursor: "pointer", fontWeight: 600 }}>‚úï Rimuovi</div>
                      </div>
                      {/* Foto */}
                      <div style={{ marginBottom: 6 }}>
                        {voce.foto ? (
                          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                            <img src={voce.foto} style={{ height: 50, maxWidth: 80, objectFit: "cover", borderRadius: 6, border: `1px solid ${T.bdr}` }} alt="" />
                            <div onClick={() => {
                              const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], foto: undefined };
                              updateVanoField(v.id, "vociLibere", newVoci);
                            }} style={{ fontSize: 9, color: T.red, cursor: "pointer" }}>‚úï</div>
                          </div>
                        ) : (
                          <label style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "4px 10px", borderRadius: 6, background: "#ff950012", color: "#ff9500", fontSize: 10, fontWeight: 600, cursor: "pointer" }}>
                            üì∑ Foto
                            <input type="file" accept="image/*" style={{ display: "none" }} onChange={e => {
                              const file = e.target.files?.[0]; if (!file) return;
                              const reader = new FileReader();
                              reader.onload = ev => {
                                const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], foto: ev.target?.result as string };
                                updateVanoField(v.id, "vociLibere", newVoci);
                              };
                              reader.readAsDataURL(file);
                            }} />
                          </label>
                        )}
                      </div>
                      {/* Descrizione */}
                      <input style={{ ...S.input, marginBottom: 6, fontSize: 12 }} placeholder="Descrizione (es. Controtelaio, Davanzale, Soglia...)" defaultValue={voce.descrizione || ""} onBlur={e => {
                        const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], descrizione: e.target.value };
                        updateVanoField(v.id, "vociLibere", newVoci);
                      }} />
                      {/* Prezzo + Unit√† + Quantit√† */}
                      <div style={{ display: "flex", gap: 6 }}>
                        <div style={{ flex: 1 }}>
                          <label style={{ fontSize: 9, color: T.sub, fontWeight: 700 }}>Prezzo ‚Ç¨</label>
                          <input style={{ ...S.input, fontSize: 12, fontFamily: FM }} type="number" step="0.01" placeholder="0.00" defaultValue={voce.prezzo || ""} onBlur={e => {
                            const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], prezzo: parseFloat(e.target.value) || 0 };
                            updateVanoField(v.id, "vociLibere", newVoci);
                          }} />
                        </div>
                        <div style={{ width: 80 }}>
                          <label style={{ fontSize: 9, color: T.sub, fontWeight: 700 }}>Unit√†</label>
                          <select style={{ ...S.select, fontSize: 11 }} value={voce.unita || "pz"} onChange={e => {
                            const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], unita: e.target.value };
                            updateVanoField(v.id, "vociLibere", newVoci);
                          }}>
                            <option value="pz">Pezzo</option>
                            <option value="mq">mq</option>
                            <option value="ml">ml</option>
                            <option value="kg">kg</option>
                            <option value="forfait">Forfait</option>
                          </select>
                        </div>
                        <div style={{ width: 60 }}>
                          <label style={{ fontSize: 9, color: T.sub, fontWeight: 700 }}>Qt√†</label>
                          <input style={{ ...S.input, fontSize: 12, fontFamily: FM, textAlign: "center" }} type="number" step="0.1" defaultValue={voce.qta || 1} onBlur={e => {
                            const newVoci = [...(v.vociLibere || [])]; newVoci[vi] = { ...newVoci[vi], qta: parseFloat(e.target.value) || 1 };
                            updateVanoField(v.id, "vociLibere", newVoci);
                          }} />
                        </div>
                      </div>
                      {voce.prezzo > 0 && <div style={{ textAlign: "right", fontSize: 11, fontWeight: 700, color: T.grn, fontFamily: FM, marginTop: 4 }}>= ‚Ç¨{((voce.prezzo || 0) * (voce.qta || 1)).toFixed(2)}</div>}
                    </div>
                  ))}
                  <div style={{ display: "flex", gap: 8 }}>
                    <div onClick={() => {
                      const newVoci = [...(v.vociLibere || []), { id: Date.now(), descrizione: "", prezzo: 0, unita: "pz", qta: 1 }];
                      updateVanoField(v.id, "vociLibere", newVoci);
                    }} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px dashed #ff9500`, textAlign: "center", cursor: "pointer", color: "#ff9500", fontSize: 12, fontWeight: 600 }}>+ Voce vuota</div>
                    <div onClick={() => {
                      setDetailOpen(d => ({ ...d, showLibreria: !d.showLibreria }));
                    }} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>üì¶ Da libreria</div>
                  </div>
                  {detailOpen.showLibreria && libreriaDB.length > 0 && (
                    <div style={{ marginTop: 8, padding: 8, borderRadius: 10, border: `1px solid ${T.acc}30`, background: T.acc + "06" }}>
                      <div style={{ fontSize: 10, fontWeight: 700, color: T.acc, marginBottom: 6, textTransform: "uppercase" }}>Scegli dalla libreria</div>
                      <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
                        {libreriaDB.map(item => (
                          <div key={item.id} onClick={() => {
                            const newVoce = { id: Date.now(), descrizione: item.nome, prezzo: item.prezzo || 0, unita: item.unita || "pz", qta: 1, foto: item.foto || undefined, libreriaId: item.id };
                            const newVoci = [...(v.vociLibere || []), newVoce];
                            updateVanoField(v.id, "vociLibere", newVoci);
                            setDetailOpen(d => ({ ...d, showLibreria: false }));
                          }} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px", borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, cursor: "pointer" }}>
                            {item.foto ? (
                              <img src={item.foto} style={{ width: 32, height: 32, objectFit: "cover", borderRadius: 4, flexShrink: 0 }} alt="" />
                            ) : (
                              <div style={{ width: 32, height: 32, borderRadius: 4, background: T.bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>üì¶</div>
                            )}
                            <div style={{ flex: 1, minWidth: 0 }}>
                              <div style={{ fontSize: 12, fontWeight: 600, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{item.nome}</div>
                              <div style={{ fontSize: 9, color: T.sub }}>{item.categoria}</div>
                            </div>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.grn, fontFamily: FM, flexShrink: 0 }}>‚Ç¨{item.prezzo}/{item.unita || "pz"}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
              {/* Foto + Note */}
              <div onClick={() => setDetailOpen(d => ({...d, disegno: !d.disegno}))} style={{ padding: "12px 16px", borderRadius: 12, border: `1px solid ${detailOpen.disegno ? "#ff6b6b" : T.bdr}`, background: detailOpen.disegno ? "#ff6b6b08" : T.card, marginBottom: 8, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>üì∑</span>
                  <span style={{ fontSize: 13, fontWeight: 700, color: detailOpen.disegno ? "#ff6b6b" : T.text }}>Foto + Note</span>
                  {(v.note) && <span style={{ fontSize: 10, color: "#ff6b6b", fontWeight: 700, background: "#ff6b6b15", padding: "2px 8px", borderRadius: 6 }}>üìù</span>}
                </div>
                <span style={{ fontSize: 13, color: T.sub, transform: detailOpen.disegno ? "rotate(0deg)" : "rotate(-90deg)", transition: "transform 0.2s" }}>‚ñæ</span>
              </div>
              {detailOpen.disegno && (
                <div style={{ marginBottom: 12 }}>
{/* Disegno mano libera ‚Äî Enhanced: eraser, multi-page, fullscreen */}
              {(() => {
                const W = drawFullscreen ? 760 : 380;
                const H = drawFullscreen ? 680 : 340;
                const savePageData = () => { const cv = canvasRef.current; if (cv) { setDrawPages(prev => { const n = [...prev]; n[drawPageIdx] = cv.toDataURL(); return n; }); } };
                const loadPageData = (idx: number) => { const cv = canvasRef.current; const ctx = cv?.getContext("2d"); if (ctx && cv) { ctx.clearRect(0, 0, cv.width, cv.height); if (drawPages[idx]) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = drawPages[idx]; } } };
                const addPage = () => { savePageData(); setDrawPages(prev => [...prev, ""]); setDrawPageIdx(drawPages.length); setTimeout(() => { const cv = canvasRef.current; const ctx = cv?.getContext("2d"); if (ctx && cv) ctx.clearRect(0, 0, cv.width, cv.height); }, 50); };
                const switchPage = (idx: number) => { if (idx === drawPageIdx) return; savePageData(); setDrawPageIdx(idx); setTimeout(() => loadPageData(idx), 50); };
                const canvasEl = (
                  <canvas ref={canvasRef} width={W} height={H} style={{ width: "100%", height: drawFullscreen ? "calc(100vh - 140px)" : 340, background: "#fff", touchAction: "none", cursor: drawTool === "eraser" ? "cell" : "crosshair" }}
                    onPointerDown={e => {
                      canvasRef.current?.setPointerCapture(e.pointerId); setIsDrawing(true);
                      const cv = canvasRef.current; const ctx = cv?.getContext("2d");
                      if (ctx && cv) {
                        const r = cv.getBoundingClientRect(); const sx = cv.width / r.width, sy = cv.height / r.height;
                        ctx.beginPath(); ctx.moveTo((e.clientX - r.left) * sx, (e.clientY - r.top) * sy);
                        if (drawTool === "eraser") { ctx.globalCompositeOperation = "destination-out"; ctx.lineWidth = penSize * 8; }
                        else { ctx.globalCompositeOperation = "source-over"; ctx.strokeStyle = penColor; ctx.lineWidth = penSize; }
                        ctx.lineCap = "round"; ctx.lineJoin = "round";
                      }
                    }}
                    onPointerMove={e => {
                      if (!isDrawing) return; const cv = canvasRef.current; const ctx = cv?.getContext("2d");
                      if (ctx && cv) { const r = cv.getBoundingClientRect(); const sx = cv.width / r.width, sy = cv.height / r.height; ctx.lineTo((e.clientX - r.left) * sx, (e.clientY - r.top) * sy); ctx.stroke(); }
                    }}
                    onPointerUp={() => { setIsDrawing(false); const cv = canvasRef.current; const ctx = cv?.getContext("2d"); if (ctx) ctx.globalCompositeOperation = "source-over"; }}
                    onPointerLeave={() => { setIsDrawing(false); const cv = canvasRef.current; const ctx = cv?.getContext("2d"); if (ctx) ctx.globalCompositeOperation = "source-over"; }}
                  />
                );
                const toolbar = (
                  <div style={{ padding: "8px 14px", display: "flex", alignItems: "center", gap: 4, flexWrap: "wrap" as const }}>
                    {["#1d1d1f", "#ff3b30", "#007aff", "#34c759", "#ff9500", "#af52de", "#ff2d55", "#ffffff"].map(c => (
                      <div key={c} onClick={() => { setPenColor(c); setDrawTool("pen"); }} style={{ width: 22, height: 22, borderRadius: "50%", background: c, border: penColor === c && drawTool === "pen" ? `3px solid ${T.acc}` : c === "#ffffff" ? `1px solid ${T.bdr}` : "2px solid transparent", cursor: "pointer" }} />
                    ))}
                    <div style={{ width: 1, height: 20, background: T.bdr, margin: "0 4px" }} />
                    {/* Gomma */}
                    <div onClick={() => setDrawTool(drawTool === "eraser" ? "pen" : "eraser")}
                      style={{ width: 32, height: 32, borderRadius: 8, background: drawTool === "eraser" ? "#ff3b30" + "18" : T.bg, border: drawTool === "eraser" ? "2px solid #ff3b30" : `1px solid ${T.bdr}`, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                      <span style={{ fontSize: 14 }}>{drawTool === "eraser" ? "‚úï" : "üßπ"}</span>
                    </div>
                    <div style={{ marginLeft: "auto", display: "flex", gap: 3 }}>
                      {[1, 2, 4, 6].map(s => (
                        <div key={s} onClick={() => setPenSize(s)} style={{ width: 24, height: 24, borderRadius: 6, background: penSize === s ? T.accLt : "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                          <div style={{ width: s * 2 + 1, height: s * 2 + 1, borderRadius: "50%", background: drawTool === "eraser" ? "#ff3b30" : T.text }} />
                        </div>
                      ))}
                    </div>
                  </div>
                );
                const pageStrip = (
                  <div style={{ padding: "6px 14px", borderTop: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 6 }}>
                    <span style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" as const }}>Fogli:</span>
                    {drawPages.map((_: string, i: number) => (
                      <div key={i} onClick={() => switchPage(i)}
                        style={{ minWidth: drawPageIdx === i ? 22 : 8, height: 8, borderRadius: 4, background: drawPageIdx === i ? T.acc : T.bdr, cursor: "pointer", transition: "all 0.15s", position: "relative" as const }}>
                        {drawPageIdx === i && <span style={{ position: "absolute" as const, top: -12, left: "50%", transform: "translateX(-50%)", fontSize: 8, fontWeight: 700, color: T.acc }}>{i + 1}</span>}
                      </div>
                    ))}
                    <div onClick={addPage} style={{ width: 22, height: 22, borderRadius: "50%", background: T.bg, border: `1.5px dashed ${T.bdr}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, color: T.sub, cursor: "pointer", fontWeight: 700 }}>+</div>
                    <span style={{ fontSize: 9, color: T.sub }}>{drawPageIdx + 1}/{drawPages.length}</span>
                    <div style={{ marginLeft: "auto" }} />
                    <div onClick={() => { savePageData(); setDrawFullscreen(!drawFullscreen); }}
                      style={{ padding: "3px 8px", borderRadius: 6, background: drawFullscreen ? T.acc + "12" : T.bg, border: `1px solid ${drawFullscreen ? T.acc : T.bdr}`, fontSize: 10, fontWeight: 700, color: drawFullscreen ? T.acc : T.sub, cursor: "pointer" }}>
                      {drawFullscreen ? "‚Üô Riduci" : "‚Üó Ingrandisci"}
                    </div>
                  </div>
                );

                if (drawFullscreen) return (
                  <div style={{ position: "fixed", inset: 0, zIndex: 9999, background: "#fff", display: "flex", flexDirection: "column" as const }}>
                    <div style={{ padding: "8px 14px", borderBottom: `1px solid ${T.bdr}`, display: "flex", justifyContent: "space-between", alignItems: "center", background: T.bg }}>
                      <span style={{ fontSize: 13, fontWeight: 700, color: "#ff6b6b" }}>‚úèÔ∏è Disegno ‚Äî Foglio {drawPageIdx + 1}/{drawPages.length}</span>
                      <div style={{ display: "flex", gap: 6 }}>
                        <button onClick={() => { const ctx = canvasRef.current?.getContext("2d"); ctx?.clearRect(0, 0, W, H); }} style={{ padding: "4px 10px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üóë Pulisci foglio</button>
                        <button style={{ padding: "4px 10px", borderRadius: 6, border: "none", background: "#ff3b30", color: "#fff", fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üíæ Salva</button>
                        <button onClick={() => { savePageData(); setDrawFullscreen(false); }} style={{ padding: "4px 10px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>‚úï Chiudi</button>
                      </div>
                    </div>
                    <div style={{ flex: 1, overflow: "hidden" }}>{canvasEl}</div>
                    {toolbar}
                    {pageStrip}
                  </div>
                );

                return (
                  <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, marginBottom: 12, overflow: "hidden" }}>
                    <div style={{ padding: "10px 14px", borderBottom: `1px solid ${T.bdr}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                      <span style={{ fontSize: 12, fontWeight: 700, color: "#ff6b6b" }}>‚úèÔ∏è Disegno a mano libera</span>
                      <div style={{ display: "flex", gap: 6 }}>
                        <button onClick={() => { const ctx = canvasRef.current?.getContext("2d"); ctx?.clearRect(0, 0, W, H); }} style={{ padding: "4px 10px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üóë Pulisci foglio</button>
                        <button style={{ padding: "4px 10px", borderRadius: 6, border: "none", background: "#ff3b30", color: "#fff", fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üíæ Salva</button>
                      </div>
                    </div>
                    {canvasEl}
                    {toolbar}
                    {pageStrip}
                  </div>
                );
              })()}
              {/* Foto */}
              <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 14, marginBottom: 12 }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: T.blue }}>üì∑ FOTO ({(v.foto && Object.keys(v.foto).length) || 0})</div>
                  <div style={{ display: "flex", gap: 4 }}>
                    <button onClick={() => openCamera("foto", null)}
                      style={{ padding: "4px 10px", borderRadius: 6, background: T.acc, color: "#fff", border: "none", fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üì∑ Foto</button>
                    <button onClick={() => openCamera("video", null)}
                      style={{ padding: "4px 10px", borderRadius: 6, background: T.blue, color: "#fff", border: "none", fontSize: 10, fontWeight: 600, cursor: "pointer", fontFamily: FF }}>üé¨ Video</button>
                  </div>
                </div>
                {/* Hidden file inputs as fallback */}
                <input ref={fotoVanoRef} type="file" accept="image/*" multiple style={{ display: "none" }}
                  onChange={e => {
                    const cat = pendingFotoCat;
                    Array.from(e.target.files || []).forEach(file => {
                      const r = new FileReader();
                      r.onload = async ev => {
                        const compressed = await compressImage(ev.target.result as string);
                        const key = "foto_" + Date.now() + "_" + file.name;
                        const fotoObj = { dataUrl: compressed, nome: file.name, tipo: "foto", categoria: cat || null };
                        setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? { ...r2, vani: r2.vani.map(vn => vn.id === v.id ? { ...vn, foto: { ...(vn.foto||{}), [key]: fotoObj } } : vn) } : r2) } : c));
                        setSelectedVano(prev => ({ ...prev, foto: { ...(prev.foto||{}), [key]: fotoObj } }));
                      };
                      r.readAsDataURL(file);
                    });
                    setPendingFotoCat(null);
                    e.target.value = "";
                  }}/>
                <input ref={videoVanoRef} type="file" accept="video/*" capture="environment" style={{ display: "none" }}
                  onChange={e => {
                    const file = e.target.files?.[0]; if (!file) return;
                    const key = "video_" + Date.now();
                    const reader = new FileReader();
                    reader.onload = ev => {
                      const vObj = { nome: file.name, tipo: "video", dataUrl: ev.target?.result };
                      setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? { ...r2, vani: r2.vani.map(vn => vn.id === v.id ? { ...vn, foto: { ...(vn.foto||{}), [key]: vObj } } : vn) } : r2) } : c));
                      setSelectedVano(prev => ({ ...prev, foto: { ...(prev.foto||{}), [key]: vObj } }));
                    };
                    reader.readAsDataURL(file);
                    e.target.value = "";
                  }}/>
                <div style={{ fontSize: 10, color: T.sub, marginBottom: 6 }}>{Object.keys(v.foto||{}).length} allegati</div>
                <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                  {[
                    { n: "Panoramica", r: true, c: "#ff3b30" }, { n: "Spalle muro", r: true, c: "#007aff" }, { n: "Soglia", r: true, c: "#007aff" },
                    { n: "Cassonetto", r: false, c: "#34c759" }, { n: "Dettagli critici", r: true, c: "#ff3b30" }, { n: "Imbotto", r: false, c: "#34c759" },
                    { n: "Contesto", r: false, c: "#34c759" }, { n: "Altro", r: false, c: "#34c759" },
                  ].map((cat, i) => {
                    const fotoCount = Object.values(v.foto||{}).filter(f=>f.categoria===cat.n).length;
                    return (
                    <div key={i} onClick={()=>{ openCamera("foto", cat.n); }}
                      style={{ padding: "4px 10px", borderRadius: 6, border: `1px solid ${fotoCount>0 ? "#34c759" : cat.r ? cat.c + "40" : T.bdr}`, background: fotoCount>0 ? "#34c75915" : cat.r ? cat.c + "08" : "transparent", fontSize: 10, fontWeight: 600, color: fotoCount>0 ? "#1a9e40" : cat.r ? cat.c : T.sub, cursor: "pointer", display: "flex", alignItems: "center", gap: 3, position:"relative" }}>
                      {fotoCount>0 ? <span style={{fontSize:8,background:"#34c759",color:"#fff",borderRadius:"50%",width:14,height:14,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:900}}>{fotoCount}</span> : cat.r ? <span style={{ fontSize: 8 }}>‚úï</span> : null}
                      <span style={{ fontSize: 10 }}>üì∑</span> {cat.n}
                    </div>
                    );
                  })}
                </div>
                {Object.keys(v.foto||{}).length === 0
                  ? <div style={{ textAlign: "center", padding: "16px 0", color: T.sub, fontSize: 11 }}>Nessun allegato ‚Äî tocca üì∑ Foto o üé¨ Video</div>
                  : <>
                    <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginTop: 8 }}>
                      {Object.entries(v.foto||{}).map(([k, f]) => (
                        <div key={k} onClick={() => { if (f.dataUrl) setViewingPhotoId(viewingPhotoId === k ? null : k as any); }}
                          style={{ position: "relative", width: 72, height: 72, borderRadius: 8, overflow: "hidden", background: T.bg, border: viewingPhotoId === k ? `2px solid ${T.acc}` : `1px solid ${T.bdr}`, cursor: f.dataUrl ? "pointer" : "default" }}>
                          {f.tipo === "foto" && f.dataUrl
                            ? <img src={f.dataUrl} style={{ width: "100%", height: "100%", objectFit: "cover" }} alt={f.nome}/>
                            : f.tipo === "video" && f.dataUrl
                              ? <div style={{ width: "100%", height: "100%", display: "flex", alignItems: "center", justifyContent: "center", background: "#111" }}>
                                  <span style={{ fontSize: 28, filter: "drop-shadow(0 1px 3px rgba(0,0,0,0.5))" }}>‚ñ∂</span>
                                </div>
                              : <div style={{ width: "100%", height: "100%", display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column", gap: 2 }}>
                                  <span style={{ fontSize: 24 }}>üé¨</span>
                                  <span style={{ fontSize: 8, color: T.sub, textAlign: "center", padding: "0 4px" }}>{f.nome?.slice(0,12)}</span>
                                </div>
                          }
                          {f.categoria && <div style={{position:"absolute",bottom:0,left:0,right:0,background:"rgba(0,0,0,0.6)",color:"#fff",fontSize:7,fontWeight:700,padding:"2px 3px",textAlign:"center",lineHeight:1.2}}>{f.categoria}</div>}
                          <div onClick={(ev) => {
                            ev.stopPropagation();
                            const newFoto = { ...(v.foto||{}) }; delete newFoto[k];
                            setCantieri(cs => cs.map(c => c.id === selectedCM?.id ? { ...c, rilievi: c.rilievi.map(r2 => r2.id === selectedRilievo?.id ? { ...r2, vani: r2.vani.map(vn => vn.id === v.id ? { ...vn, foto: newFoto } : vn) } : r2) } : c));
                            setSelectedVano(prev => ({ ...prev, foto: newFoto }));
                          }} style={{ position: "absolute", top: 2, right: 2, width: 18, height: 18, borderRadius: "50%", background: "rgba(0,0,0,0.55)", color: "#fff", fontSize: 10, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>‚úï</div>
                        </div>
                      ))}
                    </div>
                    {/* Inline viewer for tapped photo/video */}
                    {viewingPhotoId && (v.foto||{})[viewingPhotoId as any] && (
                      <div style={{ marginTop: 8, borderRadius: 12, overflow: "hidden", background: "#000", position: "relative" as const }}>
                        {(v.foto||{})[viewingPhotoId as any]?.tipo === "video"
                          ? <video src={(v.foto||{})[viewingPhotoId as any]?.dataUrl} controls playsInline autoPlay style={{ width: "100%", maxHeight: 300 }} />
                          : <img src={(v.foto||{})[viewingPhotoId as any]?.dataUrl} style={{ width: "100%", maxHeight: 300, objectFit: "contain" }} alt="" />
                        }
                        <div onClick={() => setViewingPhotoId(null)} style={{ position: "absolute", top: 8, right: 8, width: 28, height: 28, borderRadius: "50%", background: "rgba(0,0,0,0.6)", color: "#fff", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 14, fontWeight: 700 }}>‚úï</div>
                      </div>
                    )}
                  </>
                }
              </div>

              {/* Note */}
              <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 14 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#ff9500", marginBottom: 8 }}>üìù NOTE</div>
                <textarea style={{ width: "100%", padding: 10, fontSize: 13, border: `1px solid ${T.bdr}`, borderRadius: 8, background: T.card, minHeight: 60, resize: "vertical", fontFamily: FF, boxSizing: "border-box" }} placeholder="Note sul vano..." defaultValue={v.note || ""} />
              </div>
                </div>
              )}
            </>
          )}


          {/* === STEP 7: RIEPILOGO === */}
          {vanoStep === 2 && (
            <>
              <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: 16, marginBottom: 12 }}>
                <div style={{ textAlign: "center", marginBottom: 14 }}>
                  <div style={{ fontSize: 16, fontWeight: 700 }}>{v.nome}</div>
                  <div style={{ fontSize: 12, color: T.sub }}>{v.tipo} ‚Ä¢ {v.stanza} ‚Ä¢ {v.piano}</div>
                </div>
                {/* Larghezze */}
                <div style={{ borderRadius: 10, border: `1px solid #507aff25`, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ padding: "6px 12px", background: "#507aff10", fontSize: 11, fontWeight: 700, color: "#507aff" }}>üìè LARGHEZZE</div>
                  {[["Alto", m.lAlto], ["Centro", m.lCentro], ["Basso", m.lBasso]].map(([l, val]) => (
                    <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                      <span style={{ color: T.text }}>{l}</span>
                      <span style={{ fontFamily: FM, fontWeight: 600, color: val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                    </div>
                  ))}
                </div>
                {/* Altezze */}
                <div style={{ borderRadius: 10, border: `1px solid #34c75925`, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ padding: "6px 12px", background: "#34c75910", fontSize: 11, fontWeight: 700, color: "#34c759" }}>üìê ALTEZZE</div>
                  {[["Sinistra", m.hSx], ["Centro", m.hCentro], ["Destra", m.hDx]].map(([l, val]) => (
                    <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                      <span>{l}</span>
                      <span style={{ fontFamily: FM, fontWeight: 600, color: val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                    </div>
                  ))}
                </div>
                {/* Diagonali */}
                <div style={{ borderRadius: 10, border: `1px solid #ff950025`, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ padding: "6px 12px", background: "#ff950010", fontSize: 11, fontWeight: 700, color: "#ff9500" }}>‚úï DIAGONALI</div>
                  {[["D1", m.d1], ["D2", m.d2], ["Fuori squadra", fSq !== null ? `${fSq}mm` : ""]].map(([l, val]) => (
                    <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                      <span>{l}</span>
                      <span style={{ fontFamily: FM, fontWeight: 600, color: l === "Fuori squadra" && fSq > 3 ? "#ff3b30" : val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                    </div>
                  ))}
                </div>
                {/* Controtelaio */}
                {v.controtelaio?.tipo && (
                  <div style={{ borderRadius: 10, border: `1px solid #2563eb25`, overflow: "hidden", marginBottom: 8 }}>
                    <div style={{ padding: "6px 12px", background: "#2563eb10", fontSize: 11, fontWeight: 700, color: "#2563eb" }}>üî≤ CONTROTELAIO {v.controtelaio.tipo==="singolo"?"SINGOLO":v.controtelaio.tipo==="doppio"?"DOPPIO":"CON CASSONETTO"}</div>
                    {[["Larghezza", v.controtelaio.l], ["Altezza", v.controtelaio.h]].map(([l, val]) => (
                      <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                        <span>{l}</span>
                        <span style={{ fontFamily: FM, fontWeight: 600, color: val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                      </div>
                    ))}
                    {v.controtelaio.tipo==="singolo" && v.controtelaio.prof && (
                      <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                        <span>Profondit√†</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.prof}mm</span>
                      </div>
                    )}
                    {v.controtelaio.tipo==="doppio" && <>
                      {v.controtelaio.sezInt && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Sez. interna</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.sezInt}</span></div>}
                      {v.controtelaio.sezEst && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Sez. esterna</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.sezEst}</span></div>}
                      {v.controtelaio.distanziale && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Distanziale</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.distanziale}</span></div>}
                    </>}
                    {v.controtelaio.tipo==="cassonetto" && <>
                      {v.controtelaio.hCass && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>H Cassonetto</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.hCass}</span></div>}
                      {v.controtelaio.pCass && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>P Cassonetto</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.pCass}</span></div>}
                      {v.controtelaio.sezione && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Sezione</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.sezione}</span></div>}
                      {v.controtelaio.spalla && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Spalla</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.spalla}</span></div>}
                      {v.controtelaio.cielino && <div style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}><span>Cielino</span><span style={{ fontFamily: FM, fontWeight: 600 }}>{v.controtelaio.cielino}</span></div>}
                    </>}
                  </div>
                )}
                {/* Spallette */}
                <div style={{ borderRadius: 10, border: `1px solid #32ade625`, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ padding: "6px 12px", background: "#32ade610", fontSize: 11, fontWeight: 700, color: "#32ade6" }}>üß± SPALLETTE</div>
                  {[["Sinistra", m.spSx], ["Destra", m.spDx], ["Sopra", m.spSopra], ["Imbotte", m.imbotte]].map(([l, val]) => (
                    <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                      <span>{l}</span>
                      <span style={{ fontFamily: FM, fontWeight: 600, color: val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                    </div>
                  ))}
                </div>
                {/* Davanzale */}
                <div style={{ borderRadius: 10, border: `1px solid #ff2d5525`, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ padding: "6px 12px", background: "#ff2d5510", fontSize: 11, fontWeight: 700, color: "#ff2d55" }}>‚¨á DAVANZALE</div>
                  {[["Profondit√†", m.davProf], ["Sporgenza", m.davSporg], ["Soglia", m.soglia]].map(([l, val]) => (
                    <div key={l} style={{ display: "flex", justifyContent: "space-between", padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>
                      <span>{l}</span>
                      <span style={{ fontFamily: FM, fontWeight: 600, color: val ? T.text : T.sub2 }}>{val || "‚Äî"}</span>
                    </div>
                  ))}
                </div>
                {/* Accessori */}
                {(v.accessori?.tapparella?.attivo || v.accessori?.persiana?.attivo || v.accessori?.zanzariera?.attivo) && (
                  <div style={{ borderRadius: 10, border: `1px solid #af52de25`, overflow: "hidden", marginBottom: 8 }}>
                    <div style={{ padding: "6px 12px", background: "#af52de10", fontSize: 11, fontWeight: 700, color: "#af52de" }}>‚úö ACCESSORI</div>
                    {v.accessori?.tapparella?.attivo && <div style={{ padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>ü™ü Tapparella</div>}
                    {v.accessori?.persiana?.attivo && <div style={{ padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>üè† Persiana</div>}
                    {v.accessori?.zanzariera?.attivo && <div style={{ padding: "6px 12px", borderTop: `1px solid ${T.bdr}`, fontSize: 12 }}>ü¶ü Zanzariera</div>}
                  </div>
                )}
                {/* Foto gallery */}
                {Object.values(v.foto || {}).filter(f => f.tipo === "foto" && f.dataUrl).length > 0 && (
                  <div style={{ borderRadius: 10, border: `1px solid #007aff25`, overflow: "hidden", marginBottom: 8 }}>
                    <div style={{ padding: "6px 12px", background: "#007aff10", fontSize: 11, fontWeight: 700, color: "#007aff" }}>üì∑ FOTO ({Object.values(v.foto || {}).filter(f => f.tipo === "foto").length})</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap", padding: 8 }}>
                      {Object.entries(v.foto || {}).filter(([, f]) => f.tipo === "foto" && f.dataUrl).map(([k, f]) => (
                        <div key={k} style={{ position: "relative", width: 64, height: 48, borderRadius: 6, overflow: "hidden" }}>
                          <img src={f.dataUrl} style={{ width: "100%", height: "100%", objectFit: "cover" }} alt="" />
                          {f.categoria && <div style={{ position: "absolute", bottom: 0, left: 0, right: 0, background: "rgba(0,0,0,0.6)", color: "#fff", fontSize: 6, textAlign: "center", padding: "1px" }}>{f.categoria}</div>}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </>
          )}

          <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
            {vanoStep > 0 && (
              <button onClick={() => setVanoStep(s => s - 1)} style={{ flex: 1, padding: "14px", borderRadius: 12, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 14, fontWeight: 600, cursor: "pointer", fontFamily: FF, color: T.text }}>‚Üê Indietro</button>
            )}
            {vanoStep < 2 && (
              <button onClick={() => setVanoStep(s => s + 1)} style={{ flex: 1, padding: "14px", borderRadius: 12, border: "none", background: step.color, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>{vanoStep === 0 ? "Dettagli ‚Üí" : "Riepilogo ‚Üí"}</button>
            )}
            {vanoStep === 0 && (
              <button onClick={() => setVanoStep(2)} style={{ padding: "14px 16px", borderRadius: 12, border: `1px solid ${T.grn}`, background: T.grn + "15", fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: FF, color: T.grn }}>‚úì Fine</button>
            )}
            {vanoStep === 2 && (
              <button onClick={() => { setVanoStep(0); goBack(); }} style={{ flex: 1, padding: "14px", borderRadius: 12, border: "none", background: "#34c759", color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>üíæ SALVA TUTTO</button>
            )}
          </div>

          {/* === RIEPILOGO RAPIDO === */}
          <div style={{ marginTop: 12, padding: "8px 12px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>
            <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: "0.08em", marginBottom: 4 }}>Riepilogo rapido</div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {[
                ["L", m.lCentro || m.lAlto || m.lBasso],
                ["H", m.hCentro || m.hSx || m.hDx],
                ["D1", m.d1], ["D2", m.d2],
                ["F.sq", fSq !== null ? `${fSq}` : null],
              ].map(([l, val]) => (
                <div key={l} style={{ padding: "3px 8px", borderRadius: 4, background: T.bg, fontSize: 10, fontFamily: FM, color: val ? T.text : T.sub2 }}>
                  {l}: {val || "‚Äî"}
                </div>
              ))}
            </div>
          </div>

          {/* === FAB QUICK EDIT PANEL === */}
          {detailOpen.fabOpen && <div onClick={() => setDetailOpen(d => ({ ...d, fabOpen: false }))} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.35)", zIndex: 998 }} />}
          {detailOpen.fabOpen && (
            <div style={{ position: "fixed", bottom: 80, left: 12, right: 12, zIndex: 999, background: "#fff", borderRadius: 16, boxShadow: "0 8px 40px rgba(0,0,0,0.25)", padding: "14px 16px", maxHeight: "75vh", overflowY: "auto" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                <span style={{ fontSize: 13, fontWeight: 800, color: T.text }}>‚ö° Accesso rapido</span>
                <div onClick={() => setDetailOpen(d => ({ ...d, fabOpen: false }))} style={{ padding: "4px 10px", borderRadius: 6, background: T.bg, fontSize: 11, color: T.sub, cursor: "pointer", fontWeight: 600 }}>‚úï Chiudi</div>
              </div>

              {/* TIPOLOGIA ‚Äî chips scroll */}
              <div style={{ marginBottom: 10 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 4 }}>ü™ü Tipologia</div>
                <div style={{ display: "flex", gap: 4, overflowX: "auto", paddingBottom: 4, WebkitOverflowScrolling: "touch" }}>
                  {tipologieFiltrate.map(tp => (
                    <div key={tp.code} onClick={() => updateVanoField(v.id, "tipo", tp.code)} style={{
                      padding: "6px 10px", borderRadius: 8, flexShrink: 0, cursor: "pointer",
                      border: `1.5px solid ${v.tipo === tp.code ? "#ff9500" : T.bdr}`,
                      background: v.tipo === tp.code ? "#ff950015" : T.card,
                    }}>
                      <div style={{ fontSize: 14, textAlign: "center" }}>{tp.icon}</div>
                      <div style={{ fontSize: 8, fontWeight: 700, color: v.tipo === tp.code ? "#ff9500" : T.sub, textAlign: "center", whiteSpace: "nowrap" }}>{tp.code}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* SISTEMA + VETRO */}
              <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 3 }}>‚öôÔ∏è Sistema</div>
                  <select style={{ ...S.select, fontSize: 12, padding: "8px" }} value={v.sistema || ""} onChange={e => updateVanoField(v.id, "sistema", e.target.value)}>
                    <option value="">‚Äî Sistema ‚Äî</option>
                    {sistemiDB.map(s => <option key={s.id} value={`${s.marca} ${s.sistema}`}>{s.marca} {s.sistema}</option>)}
                  </select>
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 3 }}>ü™ü Vetro</div>
                  <select style={{ ...S.select, fontSize: 12, padding: "8px" }} value={v.vetro || ""} onChange={e => updateVanoField(v.id, "vetro", e.target.value)}>
                    <option value="">‚Äî Vetro ‚Äî</option>
                    {vetriDB.map(g => <option key={g.id} value={g.code}>{g.code}</option>)}
                  </select>
                </div>
              </div>

              {/* COLORI */}
              <div style={{ marginBottom: 10 }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 3 }}>
                  <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>üé® Colore</div>
                  <div onClick={() => updateVanoField(v.id, "bicolore", !v.bicolore)} style={{ fontSize: 9, padding: "2px 8px", borderRadius: 4, background: v.bicolore ? T.accLt : T.bg, border: `1px solid ${v.bicolore ? T.acc : T.bdr}`, color: v.bicolore ? T.acc : T.sub, cursor: "pointer", fontWeight: 600 }}>
                    Bicolore {v.bicolore ? "‚úì" : ""}
                  </div>
                </div>
                {!v.bicolore ? (
                  <select style={{ ...S.select, fontSize: 12, padding: "8px" }} value={v.coloreInt || ""} onChange={e => updateVanoField(v.id, "coloreInt", e.target.value)}>
                    <option value="">‚Äî Colore ‚Äî</option>
                    {coloriDB.map(c => <option key={c.id} value={c.code}>{c.code} ‚Äî {c.nome}</option>)}
                  </select>
                ) : (
                  <div style={{ display: "flex", gap: 6 }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>INT</div>
                      <select style={{ ...S.select, fontSize: 11, padding: "7px" }} value={v.coloreInt || ""} onChange={e => updateVanoField(v.id, "coloreInt", e.target.value)}>
                        <option value="">‚Äî</option>
                        {coloriDB.map(c => <option key={c.id} value={c.code}>{c.code}</option>)}
                      </select>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>EST</div>
                      <select style={{ ...S.select, fontSize: 11, padding: "7px" }} value={v.coloreEst || ""} onChange={e => updateVanoField(v.id, "coloreEst", e.target.value)}>
                        <option value="">‚Äî</option>
                        {coloriDB.map(c => <option key={c.id} value={c.code}>{c.code}</option>)}
                      </select>
                    </div>
                  </div>
                )}
              </div>

              {/* COLORE ACCESSORI */}
              <div style={{ marginBottom: 10 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 3 }}>üî© Colore accessori</div>
                <select style={{ ...S.select, fontSize: 12, padding: "8px" }} value={v.coloreAcc || ""} onChange={e => updateVanoField(v.id, "coloreAcc", e.target.value)}>
                  <option value="">‚Äî Come profili ‚Äî</option>
                  {coloriDB.map(c => <option key={c.id} value={c.code}>{c.code} ‚Äî {c.nome}</option>)}
                </select>
              </div>

              {/* MISURE RAPIDE ‚Äî L (tutte e 3) √ó H (tutte e 3) */}
              <div style={{ marginBottom: 6 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 4 }}>üìè Misure (mm) ‚Äî compila L e H, inserisce Alto/Centro/Basso e Sx/Centro/Dx</div>
                <div style={{ display: "flex", gap: 6 }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 8, color: "#507aff", marginBottom: 2, fontWeight: 700 }}>LARGHEZZA</div>
                    <input type="number" inputMode="numeric" style={{ ...S.input, fontSize: 16, fontFamily: FM, fontWeight: 700, textAlign: "center", padding: "10px", borderColor: "#507aff50" }} value={m.lCentro || ""} placeholder="L" onChange={e => { const val = parseInt(e.target.value) || 0; updateMisureBatch(v.id, { lAlto: val, lCentro: val, lBasso: val }); }} />
                    <div style={{ fontSize: 8, color: T.sub, marginTop: 2, textAlign: "center" }}>‚Üí Alto ¬∑ Centro ¬∑ Basso</div>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", paddingTop: 8, fontSize: 18, color: T.sub, fontWeight: 300 }}>√ó</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 8, color: "#507aff", marginBottom: 2, fontWeight: 700 }}>ALTEZZA</div>
                    <input type="number" inputMode="numeric" style={{ ...S.input, fontSize: 16, fontFamily: FM, fontWeight: 700, textAlign: "center", padding: "10px", borderColor: "#507aff50" }} value={m.hCentro || ""} placeholder="H" onChange={e => { const val = parseInt(e.target.value) || 0; updateMisureBatch(v.id, { hSx: val, hCentro: val, hDx: val }); }} />
                    <div style={{ fontSize: 8, color: T.sub, marginTop: 2, textAlign: "center" }}>‚Üí Sx ¬∑ Centro ¬∑ Dx</div>
                  </div>
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", paddingTop: 8 }}>
                    {m.lCentro > 0 && m.hCentro > 0 && (
                      <div style={{ fontSize: 13, color: T.grn, fontWeight: 800, fontFamily: FM }}>{((m.lCentro/1000)*(m.hCentro/1000)).toFixed(2)}</div>
                    )}
                    {m.lCentro > 0 && m.hCentro > 0 && (
                      <div style={{ fontSize: 8, color: T.grn, fontWeight: 600 }}>mq</div>
                    )}
                  </div>
                </div>
              </div>

              {/* Pezzi ‚Äî chips 1-5 + input libero */}
              <div style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 0" }}>
                <span style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>Pezzi:</span>
                <div style={{ display: "flex", gap: 3 }}>
                  {[1, 2, 3, 4, 5].map(n => (
                    <div key={n} onClick={() => updateVanoField(v.id, "pezzi", n)} style={{
                      width: 28, height: 28, borderRadius: 6, display: "flex", alignItems: "center", justifyContent: "center",
                      fontSize: 12, fontWeight: 700, fontFamily: FM, cursor: "pointer",
                      background: (v.pezzi || 1) === n ? T.acc : T.bg,
                      color: (v.pezzi || 1) === n ? "#fff" : T.sub,
                      border: `1px solid ${(v.pezzi || 1) === n ? T.acc : T.bdr}`
                    }}>{n}</div>
                  ))}
                </div>
                <input type="number" inputMode="numeric" min="1" style={{
                  width: 48, padding: "4px 6px", fontSize: 13, fontFamily: FM, fontWeight: 700, textAlign: "center",
                  border: `1.5px solid ${(v.pezzi || 1) > 5 ? T.acc : T.bdr}`, borderRadius: 6,
                  color: (v.pezzi || 1) > 5 ? T.acc : T.text,
                  background: (v.pezzi || 1) > 5 ? T.accLt : T.bg
                }} value={v.pezzi || 1} onChange={e => updateVanoField(v.id, "pezzi", parseInt(e.target.value) || 1)} />
              </div>
            </div>
          )}
          <div onClick={() => setDetailOpen(d => ({ ...d, fabOpen: !d.fabOpen }))} style={{
            position: "fixed", bottom: 260, right: 20, zIndex: 999,
            width: 52, height: 52, borderRadius: "50%",
            background: detailOpen.fabOpen ? T.red : "linear-gradient(135deg, #34c759, #28a745)",
            display: "flex", alignItems: "center", justifyContent: "center",
            boxShadow: "0 4px 18px rgba(52,199,89,0.45)", cursor: "pointer",
            transition: "transform 0.2s, background 0.2s",
            transform: detailOpen.fabOpen ? "rotate(45deg)" : "none"
          }}>
            <span style={{ fontSize: 20, color: "#fff" }}>‚ö°</span>
          </div>

        </div>
      </div>
    );
  };

  /* == AGENDA TAB ‚Äî Giorno / Settimana / Mese == */
  /* == CLIENTI TAB == */
  const [clientiSearch, setClientiSearch] = useState("");
  const [clientiFilter, setClientiFilter] = useState("tutti");
  const [showNewCliente, setShowNewCliente] = useState(false);
  const [newCliente, setNewCliente] = useState({ nome: "", cognome: "", tipo: "cliente", telefono: "", email: "", indirizzo: "", piva: "", note: "" });
  const [selectedCliente, setSelectedCliente] = useState<any>(null);
  const [clienteDetailTab, setClienteDetailTab] = useState("info");
  const [clienteNotes, setClienteNotes] = useState<Record<string,string>>({});



  const renderClienti = () => {
    const filters = [
      { id: "tutti", l: "Tutti", c: T.acc },
      { id: "cliente", l: "Clienti", c: "#007aff" },
      { id: "fornitore", l: "Fornitori", c: "#34c759" },
      { id: "professionista", l: "Professionisti", c: "#af52de" },
    ];
    const filtered = contatti
      .filter(c => clientiFilter === "tutti" || c.tipo === clientiFilter)
      .filter(c => {
        if (!clientiSearch) return true;
        const s = clientiSearch.toLowerCase();
        return (c.nome||"").toLowerCase().includes(s) || (c.cognome||"").toLowerCase().includes(s) || (c.telefono||"").includes(s) || (c.email||"").toLowerCase().includes(s) || (c.indirizzo||"").toLowerCase().includes(s);
      })
      .sort((a, b) => (a.nome||"").localeCompare(b.nome||""));

    // Count commesse per cliente
    const cmCountFor = (c) => cantieri.filter(cm => cm.cliente === c.nome || (c.cognome && cm.cognome === c.cognome)).length;

    // Dettaglio cliente selezionato ‚Äî ENRICHED v2
    if (selectedCliente) {
      const c = selectedCliente;
      const cmList = cantieri.filter(cm => cm.cliente === c.nome || (c.cognome && cm.cognome === c.cognome));
      const evList = events.filter(ev => ev.persona === c.nome || ev.persona === (c.nome + " " + (c.cognome||"")).trim());
      const fattureTot = fattureDB.filter(f => cmList.some(cm => cm.id === f.cmId)).reduce((s, f) => s + (f.importo || 0), 0);
      const cmAttive = cmList.filter(cm => cm.fase !== "chiusura").length;
      const tabs = [
        { id: "info", label: "Info", icon: "üìã" },
        { id: "storia", label: "Storia", icon: "üìÖ" },
        { id: "fatturato", label: "‚Ç¨ Fatturato", icon: "" },
        { id: "note", label: "üìù Note", icon: "" }
      ];
      return (
        <div style={{ padding: "0 0 100px" }}>
          {/* Header */}
          <div style={{ ...S.header, display: "flex", alignItems: "center", gap: 10 }}>
            <div onClick={() => { setSelectedCliente(null); setClienteDetailTab("info"); }} style={{ cursor: "pointer", padding: 4 }}>
              <Ico d={ICO.back} s={22} c={T.text} />
            </div>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 17, fontWeight: 800 }}>{c.nome} {c.cognome || ""}</div>
              <div style={{ fontSize: 11, color: T.sub }}>{c.tipo === "cliente" ? "üë§ Cliente" : c.tipo === "fornitore" ? "üè≠ Fornitore" : "üë∑ Professionista"}</div>
            </div>
            <div onClick={() => { const idx = contatti.findIndex(x => x.id === c.id); if (idx >= 0) { const updated = { ...c, preferito: !c.preferito }; setContatti(prev => prev.map(x => x.id === c.id ? updated : x)); setSelectedCliente(updated); } }} style={{ fontSize: 22, cursor: "pointer" }}>
              {c.preferito ? "‚≠ê" : "‚òÜ"}
            </div>
          </div>

          {/* KPI Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, margin: "0 16px 12px" }}>
            <div style={{ background: T.card, borderRadius: 12, padding: "12px 10px", textAlign: "center", border: "1px solid " + T.bdr }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: T.acc }}>{cmList.length}</div>
              <div style={{ fontSize: 10, color: T.sub, fontWeight: 600 }}>Commesse</div>
            </div>
            <div style={{ background: T.card, borderRadius: 12, padding: "12px 10px", textAlign: "center", border: "1px solid " + T.bdr }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: T.grn }}>{cmAttive}</div>
              <div style={{ fontSize: 10, color: T.sub, fontWeight: 600 }}>Attive</div>
            </div>
            <div style={{ background: T.card, borderRadius: 12, padding: "12px 10px", textAlign: "center", border: "1px solid " + T.bdr }}>
              <div style={{ fontSize: 20, fontWeight: 800, color: T.orange }}>{fattureTot > 0 ? (fattureTot / 1000).toFixed(1) + "k" : "0"}</div>
              <div style={{ fontSize: 10, color: T.sub, fontWeight: 600 }}>‚Ç¨ Totale</div>
            </div>
          </div>

          {/* Tab bar */}
          <div style={{ display: "flex", gap: 0, margin: "0 16px 12px", background: T.bg, borderRadius: 10, padding: 3 }}>
            {tabs.map(t => (
              <div key={t.id} onClick={() => setClienteDetailTab(t.id)}
                style={{ flex: 1, padding: "8px 4px", textAlign: "center", borderRadius: 8, fontSize: 11, fontWeight: 700,
                  cursor: "pointer", transition: "all .2s",
                  background: clienteDetailTab === t.id ? T.card : "transparent",
                  color: clienteDetailTab === t.id ? T.acc : T.sub,
                  boxShadow: clienteDetailTab === t.id ? T.cardSh : "none"
                }}>
                {t.icon} {t.label}
              </div>
            ))}
          </div>

          {/* TAB: Info */}
          {clienteDetailTab === "info" && <>
            <div style={{ margin: "0 16px 12px", background: T.card, borderRadius: 14, padding: 16, border: "1px solid " + T.bdr }}>
              {c.telefono && <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                <div style={{ fontSize: 14 }}>üìû</div>
                <div style={{ flex: 1, fontSize: 13, color: T.text }}>{c.telefono}</div>
                <div onClick={() => { window.location.href="tel:" + c.telefono; }} style={{ padding: "6px 12px", borderRadius: 8, background: T.grnLt, color: T.grn, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>Chiama</div>
                <div onClick={() => window.open("https://wa.me/" + c.telefono.replace(/\s/g, ""))} style={{ padding: "6px 12px", borderRadius: 8, background: "#dcf8c6", color: "#128c7e", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>WA</div>
              </div>}
              {c.email && <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                <div style={{ fontSize: 14 }}>üìß</div>
                <div style={{ flex: 1, fontSize: 13, color: T.text }}>{c.email}</div>
                <div onClick={() => window.open("mailto:" + c.email)} style={{ padding: "6px 12px", borderRadius: 8, background: T.blueLt, color: T.blue, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>Email</div>
              </div>}
              {c.indirizzo && <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                <div style={{ fontSize: 14 }}>üìç</div>
                <div style={{ flex: 1, fontSize: 13, color: T.text }}>{c.indirizzo}</div>
                <div onClick={() => window.open("https://maps.google.com/?q=" + encodeURIComponent(c.indirizzo))} style={{ padding: "6px 12px", borderRadius: 8, background: T.bg, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>Mappa</div>
              </div>}
              {c.piva && <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
                <div style={{ fontSize: 14 }}>üè¢</div>
                <div style={{ fontSize: 13, color: T.sub, fontFamily: "'JetBrains Mono',monospace" }}>{c.piva}</div>
              </div>}
              {c.cf && <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
                <div style={{ fontSize: 14 }}>üÜî</div>
                <div style={{ fontSize: 13, color: T.sub, fontFamily: "'JetBrains Mono',monospace" }}>{c.cf}</div>
              </div>}
            </div>
            <div style={{ margin: "0 16px 12px" }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 8, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <span>üìÇ Commesse ({cmList.length})</span>
                <div onClick={() => { setNewCM(prev => ({ ...prev, cliente: c.nome, telefono: c.telefono || "", indirizzo: c.indirizzo || "" } as any)); setTab("commesse"); }} style={{ fontSize: 11, fontWeight: 700, color: T.acc, cursor: "pointer" }}>+ Nuova commessa</div>
              </div>
              {cmList.length === 0 && <div style={{ padding: 16, background: T.card, borderRadius: 10, textAlign: "center", fontSize: 12, color: T.sub }}>Nessuna commessa</div>}
              {cmList.map(cm => (
                <div key={cm.id} onClick={() => { setSelectedCM(cm); setTab("commesse"); }} style={{ padding: "10px 12px", background: T.card, borderRadius: 10, border: "1px solid " + T.bdr, marginBottom: 6, cursor: "pointer", display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ width: 36, height: 36, borderRadius: 8, background: (PIPELINE.find(p => p.id === cm.fase)?.color || T.acc) + "18", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 }}>
                    {PIPELINE.find(p => p.id === cm.fase)?.icon || "üìÇ"}
                  </div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{cm.code}</div>
                    <div style={{ fontSize: 11, color: T.sub }}>{PIPELINE.find(p => p.id === cm.fase)?.nome || cm.fase} ¬∑ {cm.indirizzo || "‚Äî"}</div>
                  </div>
                </div>
              ))}
            </div>
          </>}

          {/* TAB: Storia */}
          {clienteDetailTab === "storia" && <>
            <div style={{ margin: "0 16px 12px" }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 12 }}>üìÖ Timeline</div>
              {[...evList].sort((a, b) => (b.date || "").localeCompare(a.date || "")).length === 0 &&
                <div style={{ padding: 24, background: T.card, borderRadius: 12, textAlign: "center", fontSize: 12, color: T.sub }}>Nessuna attivit√† registrata</div>
              }
              {[...evList].sort((a, b) => (b.date || "").localeCompare(a.date || "")).map((ev, i) => (
                <div key={ev.id || i} style={{ display: "flex", gap: 12, marginBottom: 2 }}>
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center", width: 24 }}>
                    <div style={{ width: 10, height: 10, borderRadius: "50%", background: tipoEvColor(ev.tipo), border: "2px solid " + T.card }} />
                    {i < evList.length - 1 && <div style={{ width: 2, flex: 1, background: T.bdr }} />}
                  </div>
                  <div style={{ flex: 1, paddingBottom: 16 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{ev.text}</div>
                    <div style={{ fontSize: 11, color: T.sub }}>{ev.date} {ev.time && "¬∑ " + ev.time} {ev.tipo && "¬∑ " + ev.tipo}</div>
                  </div>
                </div>
              ))}
            </div>
          </>}

          {/* TAB: Fatturato */}
          {clienteDetailTab === "fatturato" && <>
            <div style={{ margin: "0 16px 12px" }}>
              {(() => {
                const fattList = fattureDB.filter(f => cmList.some(cm => cm.id === f.cmId));
                const totaleFatt = fattList.reduce((s, f) => s + (f.importo || 0), 0);
                const totalePagato = fattList.filter(f => f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
                const totaleNonPagato = totaleFatt - totalePagato;
                return <>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 16 }}>
                    <div style={{ background: T.card, borderRadius: 12, padding: 14, border: "1px solid " + T.bdr }}>
                      <div style={{ fontSize: 10, color: T.sub, fontWeight: 600, marginBottom: 4 }}>Fatturato totale</div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: T.text }}>‚Ç¨ {totaleFatt.toLocaleString("it-IT")}</div>
                    </div>
                    <div style={{ background: T.card, borderRadius: 12, padding: 14, border: "1px solid " + T.bdr }}>
                      <div style={{ fontSize: 10, color: T.sub, fontWeight: 600, marginBottom: 4 }}>Da incassare</div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: totaleNonPagato > 0 ? T.red : T.grn }}>‚Ç¨ {totaleNonPagato.toLocaleString("it-IT")}</div>
                    </div>
                  </div>
                  <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 8 }}>Fatture ({fattList.length})</div>
                  {fattList.length === 0 && <div style={{ padding: 24, background: T.card, borderRadius: 12, textAlign: "center", fontSize: 12, color: T.sub }}>Nessuna fattura</div>}
                  {fattList.map(f => (
                    <div key={f.id} style={{ padding: "10px 12px", background: T.card, borderRadius: 10, border: "1px solid " + T.bdr, marginBottom: 6, display: "flex", alignItems: "center", gap: 10 }}>
                      <div style={{ width: 8, height: 8, borderRadius: "50%", background: f.pagata ? T.grn : T.red }} />
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>‚Ç¨ {(f.importo || 0).toLocaleString("it-IT")}</div>
                        <div style={{ fontSize: 11, color: T.sub }}>{f.numero || "N/D"} ¬∑ {f.data || ""}</div>
                      </div>
                      <div style={{ fontSize: 10, fontWeight: 700, padding: "3px 8px", borderRadius: 6, background: f.pagata ? T.grnLt : T.redLt, color: f.pagata ? T.grn : T.red }}>{f.pagata ? "Pagata" : "Da pagare"}</div>
                    </div>
                  ))}
                </>;
              })()}
            </div>
          </>}

          {/* TAB: Note */}
          {clienteDetailTab === "note" && <>
            <div style={{ margin: "0 16px 12px" }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìù Note private</div>
              <textarea
                value={clienteNotes[c.id] || c.note || ""}
                onChange={e => setClienteNotes(prev => ({ ...prev, [c.id]: e.target.value }))}
                onBlur={() => { const noteVal = clienteNotes[c.id]; if (noteVal !== undefined) { setContatti(prev => prev.map(x => x.id === c.id ? { ...x, note: noteVal } : x)); setSelectedCliente({ ...c, note: noteVal }); } }}
                placeholder="Scrivi note private su questo cliente..."
                style={{ width: "100%", minHeight: 120, padding: 12, borderRadius: 12, border: "1px solid " + T.bdr, background: T.card, color: T.text, fontSize: 13, fontFamily: "inherit", resize: "vertical", outline: "none" }}
              />
              {c.note && <div style={{ marginTop: 6, fontSize: 10, color: T.sub }}>Le note si salvano automaticamente</div>}
            </div>
          </>}

          {/* Azioni */}
          <div style={{ margin: "12px 16px 0", display: "flex", gap: 8 }}>
            <div onClick={() => { if(confirm("Eliminare " + c.nome + "?")) { setContatti(prev => prev.filter(x => x.id !== c.id)); setSelectedCliente(null); }}} style={{ flex: 1, padding: 12, borderRadius: 10, background: T.redLt, color: T.red, textAlign: "center", fontSize: 12, fontWeight: 700, cursor: "pointer" }}>üóë Elimina</div>
          </div>
        </div>
      );
    }

    // Nuovo cliente modal
    if (showNewCliente) {
      return (
        <div style={{ padding: "0 0 100px" }}>
          <div style={{ ...S.header, display: "flex", alignItems: "center", gap: 10 }}>
            <div onClick={() => setShowNewCliente(false)} style={{ cursor: "pointer", padding: 4 }}>
              <Ico d={ICO.back} s={22} c={T.text} />
            </div>
            <div style={{ flex: 1, fontSize: 17, fontWeight: 800 }}>Nuovo contatto</div>
          </div>

          <div style={{ padding: "0 16px" }}>
            {/* Tipo */}
            <div style={{ display: "flex", gap: 6, marginBottom: 16 }}>
              {[{id:"cliente",l:"üë§ Cliente"},{id:"fornitore",l:"üè≠ Fornitore"},{id:"professionista",l:"üë∑ Professionista"}].map(t => (
                <div key={t.id} onClick={() => setNewCliente(prev => ({...prev, tipo: t.id}))} style={{ flex: 1, padding: "10px 6px", borderRadius: 10, border: `1.5px solid ${newCliente.tipo === t.id ? T.acc : T.bdr}`, background: newCliente.tipo === t.id ? T.accLt : T.card, textAlign: "center", fontSize: 11, fontWeight: 700, cursor: "pointer", color: newCliente.tipo === t.id ? T.acc : T.sub }}>{t.l}</div>
              ))}
            </div>

            {[
              { l: "Nome *", k: "nome", ph: "Mario" },
              { l: "Cognome", k: "cognome", ph: "Rossi" },
              { l: "Telefono", k: "telefono", ph: "+39 333 1234567" },
              { l: "Email", k: "email", ph: "mario@email.it" },
              { l: "Indirizzo", k: "indirizzo", ph: "Via Roma 1, Cosenza" },
              { l: "P.IVA / C.F.", k: "piva", ph: "IT01234567890" },
            ].map(f => (
              <div key={f.k} style={{ marginBottom: 10 }}>
                <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3, textTransform: "uppercase", letterSpacing: "0.05em" }}>{f.l}</div>
                <input value={newCliente[f.k]} onChange={e => setNewCliente(prev => ({...prev, [f.k]: e.target.value}))}
                  placeholder={f.ph} style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 13, color: T.text, fontFamily: "inherit", boxSizing: "border-box" }} />
              </div>
            ))}

            <div style={{ marginBottom: 10 }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 3, textTransform: "uppercase", letterSpacing: "0.05em" }}>Note</div>
              <textarea value={newCliente.note} onChange={e => setNewCliente(prev => ({...prev, note: e.target.value}))}
                placeholder="Note aggiuntive..." rows={3} style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 13, color: T.text, fontFamily: "inherit", boxSizing: "border-box", resize: "vertical" }} />
            </div>

            <button onClick={() => {
              if (!newCliente.nome.trim()) return;
              setContatti(prev => [...prev, { id: "CT-" + Date.now(), ...newCliente, preferito: false }]);
              setNewCliente({ nome: "", cognome: "", tipo: "cliente", telefono: "", email: "", indirizzo: "", piva: "", note: "" });
              setShowNewCliente(false);
            }} style={{ width: "100%", padding: "14px", borderRadius: 12, border: "none", background: T.acc, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
              ‚úÖ Salva contatto
            </button>
          </div>
        </div>
      );
    }

    // Lista principale
    return (
      <div style={{ padding: "0 0 100px" }}>
        <div style={{ ...S.header, flexDirection: "column", alignItems: "stretch" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
            <div style={{ fontSize: 20, fontWeight: 900 }}>Clienti</div>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ fontSize: 11, color: T.sub, fontWeight: 600 }}>{contatti.length}</span>
              <div onClick={() => setShowNewCliente(true)} style={{ width: 32, height: 32, borderRadius: 8, background: T.acc, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                <Ico d={ICO.plus} s={16} c="#fff" />
              </div>
            </div>
          </div>

          {/* Search */}
          <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px", borderRadius: 10, border: `1px solid ${T.bdr}`, background: T.card, marginBottom: 8 }}>
            <Ico d={ICO.search} s={14} c={T.sub} />
            <input value={clientiSearch} onChange={e => setClientiSearch(e.target.value)}
              placeholder="Cerca..."
              style={{ flex: 1, border: "none", background: "transparent", fontSize: 13, color: T.text, outline: "none", fontFamily: "inherit" }} />
            {clientiSearch && <div onClick={() => setClientiSearch("")} style={{ cursor: "pointer", fontSize: 12, color: T.sub }}>‚úï</div>}
          </div>

          {/* Filters */}
          <div style={{ display: "flex", gap: 4, overflowX: "auto", WebkitOverflowScrolling: "touch", paddingBottom: 2 }}>
            {filters.map(f => (
              <div key={f.id} onClick={() => setClientiFilter(f.id)} style={{ padding: "5px 10px", borderRadius: 16, border: `1px solid ${clientiFilter === f.id ? f.c : T.bdr}`, background: clientiFilter === f.id ? f.c + "15" : T.card, fontSize: 10, fontWeight: 600, cursor: "pointer", whiteSpace: "nowrap", color: clientiFilter === f.id ? f.c : T.sub }}>
                {f.l}{f.id !== "tutti" ? ` ${contatti.filter(c => c.tipo === f.id).length}` : ""}
              </div>
            ))}
          </div>
        </div>

        {/* Lista */}
        <div style={{ padding: "0 16px" }}>
          {filtered.length === 0 && (
            <div style={{ padding: "40px 20px", textAlign: "center" }}>
              <div style={{ fontSize: 40, marginBottom: 10 }}>üë§</div>
              <div style={{ fontSize: 14, fontWeight: 700, color: T.text, marginBottom: 4 }}>Nessun contatto</div>
              <div style={{ fontSize: 12, color: T.sub }}>Aggiungi il tuo primo cliente</div>
            </div>
          )}
          {filtered.map(c => {
            const cmCount = cmCountFor(c);
            const tipoColor = c.tipo === "cliente" ? "#007aff" : c.tipo === "fornitore" ? "#34c759" : "#af52de";
            const initials = ((c.nome||"")[0] || "") + ((c.cognome||"")[0] || "");
            return (
              <div key={c.id} onClick={() => setSelectedCliente(c)} style={{ padding: "12px 14px", background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, marginBottom: 6, cursor: "pointer", display: "flex", alignItems: "center", gap: 12 }}>
                {/* Avatar */}
                <div style={{ width: 42, height: 42, borderRadius: "50%", background: tipoColor + "18", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15, fontWeight: 800, color: tipoColor, flexShrink: 0 }}>
                  {initials.toUpperCase() || "?"}
                </div>
                {/* Info */}
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: T.text, display: "flex", alignItems: "center", gap: 4 }}>
                    {c.nome} {c.cognome || ""}
                    {c.preferito && <span style={{ fontSize: 12 }}>‚≠ê</span>}
                  </div>
                  <div style={{ fontSize: 11, color: T.sub, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                    {c.telefono || c.email || c.indirizzo || "Nessun dettaglio"}
                  </div>
                  <div style={{ display: "flex", gap: 4, marginTop: 3 }}>
                    <span style={{ ...S.badge(tipoColor + "15", tipoColor), fontSize: 9 }}>{c.tipo === "cliente" ? "Cliente" : c.tipo === "fornitore" ? "Fornitore" : "Professionista"}</span>
                    {cmCount > 0 && <span style={{ ...S.badge(T.accLt, T.acc), fontSize: 9 }}>üìÅ {cmCount}</span>}
                  </div>
                </div>
                {/* Quick actions */}
                <div style={{ display: "flex", gap: 4 }}>
                  {c.telefono && <div onClick={(e) => { e.stopPropagation(); window.location.href="tel:" + c.telefono; }} style={{ width: 32, height: 32, borderRadius: "50%", background: T.grnLt, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, cursor: "pointer" }}>üìû</div>}
                  {c.telefono && <div onClick={(e) => { e.stopPropagation(); window.open("https://wa.me/" + (c.telefono||"").replace(/\s/g, "")); }} style={{ width: 32, height: 32, borderRadius: "50%", background: "#dcf8c6", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, cursor: "pointer" }}>üí¨</div>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const renderAgenda = () => {
    const dateStr = (d) => d.toISOString().split("T")[0];
    // Merge events + tasks + montaggi + consegne
    const tasksWithDate = tasks.filter(t => t.date).map(t => ({ ...t, _isTask: true, color: t.priority === "alta" ? "#FF3B30" : t.priority === "media" ? "#FF9500" : "#8E8E93" }));
    const montaggiItems = (montaggiDB || []).filter(m => m.data).map(m => {
      const sq = (squadreDB || []).find(s => s.id === m.squadraId);
      return { id: "mag_" + m.id, date: m.data, time: m.orario || "08:00", text: "üîß Montaggio " + (m.cliente || ""), persona: m.cliente || "", cm: m.cmCode || "", color: "#007aff", durata: (m.giorni || 1) * 480, _isMontaggio: true, _stato: m.stato, _squadra: sq?.nome || "", _vani: m.vani || 0 };
    });
    const consegneItems = (ordiniFornDB || []).filter(o => o.consegna?.prevista && o.stato !== "consegnato").map(o => ({
      id: "cons_" + o.id, date: o.consegna.prevista, time: "09:00", text: "üöö Consegna " + (o.fornitore?.nome || ""), persona: o.fornitore?.nome || "", cm: o.cmCode || "", color: "#af52de", durata: 60, _isConsegna: true
    }));
    const scadenzeItems = [
      ...(fattureDB || []).filter(f => !f.pagata && f.scadenza).map(f => ({
        id: "scad_e_" + f.id, date: f.scadenza, time: "", text: "üì§ Incasso " + f.cliente, persona: f.cliente, cm: f.cmCode || "", color: "#34c759", _isScadenza: true, _importo: f.importo, _tipo: "incasso"
      })),
      ...(fatturePassive || []).filter(f => !f.pagata && f.scadenza).map(f => ({
        id: "scad_p_" + f.id, date: f.scadenza, time: "", text: "üì• Pagamento " + (f.fornitore || ""), persona: f.fornitore || "", cm: "", color: "#ff9500", _isScadenza: true, _importo: f.importo || 0, _tipo: "pagamento"
      })),
    ];
    const allItemsRaw = [...events, ...tasksWithDate, ...montaggiItems, ...consegneItems, ...scadenzeItems];
    const allItems = allItemsRaw.filter(it => {
      if (it._isTask && !agendaFilters.tasks) return false;
      if (it._isMontaggio && !agendaFilters.montaggi) return false;
      if (it._isConsegna && !agendaFilters.consegne) return false;
      if (it._isScadenza && !agendaFilters.scadenze) return false;
      if (!it._isTask && !it._isMontaggio && !it._isConsegna && !it._isScadenza && !agendaFilters.eventi) return false;
      return true;
    });
    const dayEvents = allItems.filter(e => e.date === dateStr(selDate)).sort((a, b) => (a.time || "99").localeCompare(b.time || "99"));
    const weekStart = new Date(selDate); weekStart.setDate(selDate.getDate() - selDate.getDay() + 1);
    const weekDays = Array.from({ length: 7 }, (_, i) => { const d = new Date(weekStart); d.setDate(d.getDate() + i); return d; });
    const monthStart = new Date(selDate.getFullYear(), selDate.getMonth(), 1);
    const monthDays = Array.from({ length: 35 }, (_, i) => { const d = new Date(monthStart); d.setDate(d.getDate() + i - monthStart.getDay() + 1); return d; });
    const isSameDay = (a, b) => dateStr(a) === dateStr(b);
    const isToday2 = (d) => isSameDay(d, new Date());
    const eventsOn = (d) => allItems.filter(e => e.date === dateStr(d));


    const navDate = (dir) => {
      const d = new Date(selDate);
      if (agendaView === "giorno") d.setDate(d.getDate() + dir);
      else if (agendaView === "settimana") d.setDate(d.getDate() + dir * 7);
      else d.setMonth(d.getMonth() + dir);
      setSelDate(d);
    };

    // Swipe handlers
    let touchStartX = 0;
    const onTouchStart = (e) => { touchStartX = e.touches[0].clientX; };
    const onTouchEnd = (e) => {
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (Math.abs(dx) > 50) navDate(dx < 0 ? 1 : -1);
    };

    // Prossimi eventi (dal giorno di oggi in avanti, max 3)
    const todayStr = dateStr(new Date());
    const prossimiEventi = allItems
      .filter(e => e.date >= todayStr)
      .sort((a, b) => a.date.localeCompare(b.date) || (a.time||"99").localeCompare(b.time||"99"))
      .slice(0, 3);

    // Ore rimanenti agli eventi di oggi
    const now = new Date();
    const oraOra = now.getHours() * 60 + now.getMinutes();
    const eventiOggi = events.filter(e => e.date === todayStr && e.time).map(e => {
      const [hh, mm] = e.time.split(":").map(Number);
      const minuti = hh * 60 + mm - oraOra;
      return { ...e, minutiAlEvento: minuti };
    }).filter(e => e.minutiAlEvento > 0).sort((a,b) => a.minutiAlEvento - b.minutiAlEvento);

    const renderEventCard = (ev) => (
      <div key={ev.id} style={{ ...S.card, margin: "0 0 8px", opacity: ev._isTask && ev.done ? 0.5 : 1, borderLeft: (ev._isMontaggio || ev._isConsegna || ev._isScadenza) ? "4px solid " + ev.color : "none" }} onClick={() => !ev._isTask && !ev._isMontaggio && !ev._isConsegna && !ev._isScadenza && setSelectedEvent(selectedEvent?.id === ev.id ? null : ev)}>
        <div style={{ ...S.cardInner, display: "flex", gap: 10 }}>
          {ev._isTask ? (
            <div onClick={(e) => { e.stopPropagation(); toggleTask(ev.id); }} style={{ width: 22, height: 22, borderRadius: 6, border: `2px solid ${ev.done ? T.grn : T.bdr}`, background: ev.done ? T.grn : "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", flexShrink: 0, marginTop: 2 }}>
              {ev.done && <span style={{ color: "#fff", fontSize: 13, fontWeight: 700 }}>‚úì</span>}
            </div>
          ) : ev._isMontaggio ? (
            <div style={{ width: 32, height: 32, borderRadius: 8, background: "#007aff15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>üîß</div>
          ) : ev._isConsegna ? (
            <div style={{ width: 32, height: 32, borderRadius: 8, background: "#af52de15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>üöö</div>
          ) : ev._isScadenza ? (
            <div style={{ width: 32, height: 32, borderRadius: 8, background: (ev._tipo === "incasso" ? "#34c759" : "#ff9500") + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>{ev._tipo === "incasso" ? "üì§" : "üì•"}</div>
          ) : (
            <div style={{ width: 3, borderRadius: 2, background: ev.color, flexShrink: 0 }} />
          )}
          {ev.time && <div style={{ fontSize: 12, fontWeight: 700, color: T.sub, minWidth: 38, fontFamily: FM }}>{ev.time}</div>}
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 13, fontWeight: 600, textDecoration: ev._isTask && ev.done ? "line-through" : "none" }}>{ev.text}</div>
            {ev._isTask && ev.meta && <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>üìù {ev.meta}</div>}
            {!ev._isTask && !ev._isMontaggio && !ev._isConsegna && !ev._isScadenza && ev.addr && <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>üìç {ev.addr}</div>}
            {ev._isMontaggio && <div style={{ fontSize: 10, color: T.sub, marginTop: 2 }}>{ev._squadra} ¬∑ {ev._vani} vani ¬∑ {ev._stato === "completato" ? "‚úÖ Completato" : ev._stato === "in_corso" ? "üîÑ In corso" : "üìã Programmato"}</div>}
            {ev._isConsegna && <div style={{ fontSize: 10, color: T.sub, marginTop: 2 }}>Materiale per {ev.cm}</div>}
            {ev._isScadenza && <div style={{ fontSize: 10, color: T.sub, marginTop: 2 }}>{ev._tipo === "incasso" ? "Da incassare" : "Da pagare"}: <b style={{ color: ev.color }}>‚Ç¨{(ev._importo || 0).toLocaleString("it-IT")}</b></div>}
            <div style={{ display: "flex", gap: 4, marginTop: 3, flexWrap: "wrap" }}>
              {ev.cm && <span onClick={(e) => { e.stopPropagation(); const cm = cantieri.find(c => c.code === ev.cm); if (cm) { setSelectedCM(cm); setTab("commesse"); } }} style={{ ...S.badge(T.accLt, T.acc), cursor: "pointer" }}>{ev.cm}</span>}
              {ev.persona && !ev._isMontaggio && !ev._isConsegna && <span style={S.badge(T.purpleLt, T.purple)}>{ev.persona}</span>}
              {ev._isTask && <span style={S.badge(ev.priority === "alta" ? "#FF3B3018" : ev.priority === "media" ? "#FF950018" : "#8E8E9318", ev.priority === "alta" ? "#FF3B30" : ev.priority === "media" ? "#FF9500" : "#8E8E93")}>task ¬∑ {ev.priority}</span>}
              {!ev._isTask && ev.reminder && <span style={S.badge(ev.reminderSent ? T.grnLt : "#FF950015", ev.reminderSent ? T.grn : "#FF9500")}>{ev.reminderSent ? "‚úì Reminder inviato" : `‚è∞ ${ev.reminder}`}</span>}
              {!ev._isTask && <span style={S.badge(tipoEvColor(ev.tipo) + "18", tipoEvColor(ev.tipo))}>{(TIPI_EVENTO.find(t=>t.id===ev.tipo)||{l:ev.tipo}).l}</span>}
            </div>
          </div>
          <div style={{ alignSelf: "center", transition: "transform 0.2s", transform: selectedEvent?.id === ev.id ? "rotate(90deg)" : "rotate(0deg)" }}>
            <Ico d={ICO.back} s={14} c={T.sub} />
          </div>
        </div>
        {/* Expanded detail */}
        {selectedEvent?.id === ev.id && (
          <div style={{ padding: "0 14px 12px", borderTop: `1px solid ${T.bdr}`, marginTop: 4 }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, padding: "10px 0" }}>
              <div>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.5 }}>Data</div>
                <div style={{ fontSize: 13, fontWeight: 600, marginTop: 2 }}>{new Date(ev.date).toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "short" })}</div>
              </div>
              <div>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.5 }}>Orario</div>
                <div style={{ fontSize: 13, fontWeight: 600, marginTop: 2 }}>{ev.time || "Tutto il giorno"}</div>
              </div>
              {ev.persona && <div>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.5 }}>Assegnato a</div>
                <div style={{ fontSize: 13, fontWeight: 600, marginTop: 2 }}>üë§ {ev.persona}</div>
              </div>}
              {ev.addr && <div>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.5 }}>Luogo</div>
                <div style={{ fontSize: 13, fontWeight: 600, marginTop: 2 }}>üìç {ev.addr}</div>
              </div>}
            </div>
            {ev.cm && (
              <div style={{ padding: "8px 10px", background: T.accLt, borderRadius: 8, marginBottom: 8 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.acc, textTransform: "uppercase", letterSpacing: 0.5 }}>Commessa collegata</div>
                <div onClick={(e) => { e.stopPropagation(); const cm = cantieri.find(c => c.code === ev.cm); if (cm) { setSelectedCM(cm); setTab("commesse"); } }} style={{ fontSize: 13, fontWeight: 700, color: T.acc, marginTop: 2, cursor: "pointer" }}>{ev.cm} ‚Üí Apri commessa</div>
              </div>
            )}
            <div style={{ display: "flex", gap: 6 }}>
              <div onClick={(e) => { e.stopPropagation(); if (ev.addr) window.open("https://maps.google.com/?q=" + encodeURIComponent(ev.addr)); }} style={{ flex: 1, padding: "8px", borderRadius: 8, background: T.card, border: `1px solid ${T.bdr}`, textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 600, color: T.blue }}>üóù¬∫ Mappa</div>
              <div onClick={(e) => { e.stopPropagation(); const tel = contatti.find(ct => ct.nome === ev.persona)?.telefono; if (tel) window.location.href="tel:" + tel; }} style={{ flex: 1, padding: "8px", borderRadius: 8, background: T.card, border: `1px solid ${T.bdr}`, textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 600, color: T.grn }}>üìû Chiama</div>
              <div onClick={(e) => {
                e.stopPropagation();
                const cmObj = cantieri.find(c => c.code === ev.cm) || null;
                const cliente = cmObj ? `${cmObj.cliente} ${cmObj.cognome||""}`.trim() : (ev.persona || "Cliente");
                const dataFmt = new Date(ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" });
                const tpl = `Gentile ${cliente},

Le confermo l'appuntamento:

üìÖ ${dataFmt}${ev.time ? " alle " + ev.time : ""}
üìç ${ev.addr || "da concordare"}

${ev.text}

Per qualsiasi necessit√† non esiti a contattarmi.

Cordiali saluti,
Fabio Cozza
Walter Cozza Serramenti`;
                setMailBody(tpl);
                setShowMailModal({ ev, cm: cmObj });
              }} style={{ flex: 1, padding: "8px", borderRadius: 8, background: T.accLt, border: `1px solid ${T.acc}30`, textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 600, color: T.acc }}>‚úâÔ∏è Mail</div>
              <div onClick={(e) => { e.stopPropagation(); deleteEvent(ev.id); setSelectedEvent(null); }} style={{ flex: 1, padding: "8px", borderRadius: 8, background: T.redLt, border: `1px solid ${T.red}30`, textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 600, color: T.red }}>üóù‚Äò</div>
            </div>
            <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
              <div onClick={(e) => { e.stopPropagation(); const cmObj = ev.cm ? cantieri.find(c => c.code === ev.cm) : null; if (cmObj) { setSelectedCM(cmObj); } else { const code = "CM-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "Nuovo", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "sopralluogo", vani: [], note: ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); } setSelectedEvent(null); setTab("commesse"); }} style={{ flex: 1, padding: "10px 4px", borderRadius: 10, background: "linear-gradient(135deg, #007aff15, #007aff08)", border: "1px solid #007aff25", textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 800, color: "#007aff" }}>{"üìÅ"} Commessa</div>
              <div onClick={(e) => { e.stopPropagation(); const cmObj = ev.cm ? cantieri.find(c => c.code === ev.cm) : null; if (cmObj) { setSelectedCM(cmObj); } else { const code = "CM-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "Nuovo", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "misure", vani: [], note: "Misure: " + ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); } setSelectedEvent(null); setTab("commesse"); }} style={{ flex: 1, padding: "10px 4px", borderRadius: 10, background: "linear-gradient(135deg, #ff950015, #ff950008)", border: "1px solid #ff950025", textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 800, color: "#ff9500" }}>{"üìè"} Misure</div>
              <div onClick={(e) => { e.stopPropagation(); const code = "INT-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "sopralluogo", vani: [], note: "Intervento: " + ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); setSelectedEvent(null); setTab("commesse"); }} style={{ flex: 1, padding: "10px 4px", borderRadius: 10, background: "linear-gradient(135deg, #34c75915, #34c75908)", border: "1px solid #34c75925", textAlign: "center", cursor: "pointer", fontSize: 11, fontWeight: 800, color: "#34c759" }}>{"üîß"} Intervento</div>
            </div>
          </div>
        )}
      </div>
    );

    return (
      <div style={{ paddingBottom: 80 }}>
        <div style={S.header}>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>Agenda</div>
            <div style={S.headerSub}>
              {agendaView === "giorno" ? selDate.toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" }) :
               agendaView === "settimana" ? `${weekDays[0].getDate()}‚Äì${weekDays[6].getDate()} ${selDate.toLocaleDateString("it-IT", { month: "long", year: "numeric" })}` :
               selDate.toLocaleDateString("it-IT", { month: "long", year: "numeric" })}
            </div>
          </div>
          <div onClick={() => setShowNewEvent(true)} style={{ width: 36, height: 36, borderRadius: 10, background: T.acc, color: "#fff", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 20, fontWeight: 300 }}>+</div>
        </div>

        {/* View switcher */}
        <div style={{ display: "flex", gap: 0, margin: "8px 16px", borderRadius: 8, overflow: "hidden", border: `1px solid ${T.bdr}` }}>
          {["giorno", "settimana", "mese"].map(v => (
            <div key={v} onClick={() => setAgendaView(v)} style={{ flex: 1, padding: "8px 4px", textAlign: "center", fontSize: 12, fontWeight: 600, background: agendaView === v ? T.acc : T.card, color: agendaView === v ? "#fff" : T.sub, cursor: "pointer", textTransform: "capitalize" }}>
              {v}
            </div>
          ))}
        </div>

        {/* ‚ïê‚ïê‚ïê FILTRI AGENDA ‚ïê‚ïê‚ïê */}
        <div style={{ display: "flex", gap: 4, padding: "6px 16px", overflowX: "auto", WebkitOverflowScrolling: "touch" }}>
          {[
            { id: "eventi", ico: "üìç", l: "Sopralluoghi", col: "#007aff" },
            { id: "montaggi", ico: "üîß", l: "Montaggi", col: "#5856d6" },
            { id: "consegne", ico: "üöö", l: "Consegne", col: "#af52de" },
            { id: "scadenze", ico: "üí∞", l: "Pagamenti", col: "#ff9500" },
            { id: "tasks", ico: "‚úÖ", l: "Task", col: "#8e8e93" },
          ].map(f => {
            const active = agendaFilters[f.id];
            return <div key={f.id} onClick={() => setAgendaFilters(p => ({...p, [f.id]: !p[f.id]}))}
              style={{ display: "flex", alignItems: "center", gap: 4, padding: "5px 10px", borderRadius: 20, fontSize: 10, fontWeight: 700, cursor: "pointer", whiteSpace: "nowrap",
                background: active ? f.col + "18" : T.bg, color: active ? f.col : T.sub + "80",
                border: "1.5px solid " + (active ? f.col + "60" : T.bdr), opacity: active ? 1 : 0.5,
                transition: "all 0.15s ease" }}>
              <span>{f.ico}</span> {f.l}
            </div>;
          })}
        </div>

        {/* Nav arrows */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 16px" }}>
          <div onClick={() => navDate(-1)} style={{ cursor: "pointer", padding: "4px 8px" }}><Ico d={ICO.back} s={18} c={T.sub} /></div>
          <div onClick={() => setSelDate(new Date())} style={{ fontSize: 12, fontWeight: 600, color: T.acc, cursor: "pointer" }}>Oggi</div>
          <div onClick={() => navDate(1)} style={{ cursor: "pointer", padding: "4px 8px", transform: "rotate(180deg)" }}><Ico d={ICO.back} s={18} c={T.sub} /></div>
        </div>

        {/* === BANNER REMINDER PENDENTI === */}
        {(() => {
          const today = dateStr(new Date());
          const tomorrow = dateStr(new Date(Date.now() + 86400000));
          const reminderPendenti = events.filter(ev => {
            if (!ev.reminder || ev.reminderSent) return false;
            if (ev.reminder === "giorno" && ev.date === today) return true;
            if (ev.reminder === "24h" && ev.date === tomorrow) return true;
            if (ev.reminder === "1h") {
              if (ev.date !== today) return false;
              if (!ev.time) return true;
              const [hh, mm] = ev.time.split(":").map(Number);
              const evMin = hh * 60 + mm;
              const nowMin = new Date().getHours() * 60 + new Date().getMinutes();
              return evMin - nowMin <= 60 && evMin - nowMin > 0;
            }
            return false;
          });
          if (reminderPendenti.length === 0) return null;
          return (
            <div style={{ margin: "0 16px 10px", padding: "10px 12px", borderRadius: 10, background: "#FF950010", border: "1px solid #FF950040", borderLeft: "3px solid #FF9500" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                <span style={{ fontSize: 18 }}>‚è∞</span>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 800, color: "#FF9500" }}>
                    {reminderPendenti.length} reminder da inviare
                  </div>
                  <div style={{ fontSize: 10, color: T.sub }}>Avvisa i clienti con 1 click</div>
                </div>
              </div>
              {reminderPendenti.map(ev => {
                const cmObj = cantieri.find(c => c.code === ev.cm);
                const cliente = cmObj ? `${cmObj.cliente} ${cmObj.cognome||""}`.trim() : ev.persona || "Cliente";
                const dataFmt = new Date(ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" });
                const tpl = `Gentile ${cliente},

Le ricordiamo l'appuntamento:

üìÖ ${dataFmt}${ev.time ? " alle " + ev.time : ""}
üìç ${ev.addr || "da concordare"}

${ev.text}

Per qualsiasi necessit√† non esiti a contattarci.

Cordiali saluti,
Fabio Cozza
Walter Cozza Serramenti`;
                return (
                  <div key={ev.id} style={{ display:"flex", alignItems:"center", gap:8, padding:"7px 8px", background:"#fff", borderRadius:8, marginBottom:4, border:"1px solid #FF950030" }}>
                    <div style={{ flex:1 }}>
                      <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{ev.text}</div>
                      <div style={{ fontSize:10, color:T.sub }}>{cliente} ¬∑ {ev.time || "tutto il giorno"}</div>
                    </div>
                    <div onClick={() => {
                      setMailBody(tpl);
                      setShowMailModal({ ev: { ...ev, addr: ev.addr || "" }, cm: cmObj || null });
                      setEvents(es => es.map(x => x.id === ev.id ? { ...x, reminderSent: true } : x));
                    }} style={{ padding:"5px 10px", borderRadius:7, background:"#FF9500", color:"#fff", fontSize:11, fontWeight:800, cursor:"pointer", whiteSpace:"nowrap" }}>
                      ‚úâÔ∏è Invia
                    </div>
                  </div>
                );
              })}
            </div>
          );
        })()}

        <div style={{ padding: "0 16px" }}>

          {/* === VISTA MESE === */}
          {agendaView === "mese" && (
            <>
              {/* Banner prossimo evento di oggi */}
              {eventiOggi.length > 0 && (
                <div style={{ ...S.card, marginBottom: 10, padding: "10px 14px", borderLeft: `3px solid ${eventiOggi[0].color || tipoEvColor(eventiOggi[0].tipo)}`, display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 11, color: T.sub, fontWeight: 600 }}>
                      Prossimo evento tra {eventiOggi[0].minutiAlEvento < 60
                        ? `${eventiOggi[0].minutiAlEvento} min`
                        : `${Math.floor(eventiOggi[0].minutiAlEvento/60)}h ${eventiOggi[0].minutiAlEvento%60>0?eventiOggi[0].minutiAlEvento%60+"min":""}`}
                    </div>
                    <div style={{ fontSize: 13, fontWeight: 700 }}>{eventiOggi[0].text}</div>
                    {eventiOggi[0].addr && <div style={{ fontSize: 11, color: T.sub }}>üìç {eventiOggi[0].addr}</div>}
                  </div>
                  {eventiOggi[0].addr && (
                    <div onClick={() => window.open("https://maps.google.com/?q=" + encodeURIComponent(eventiOggi[0].addr))}
                      style={{ padding: "6px 10px", borderRadius: 8, background: T.blueLt, color: T.blue, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                      üóù¬∫ Naviga
                    </div>
                  )}
                </div>
              )}
              {/* GRIGLIA MENSILE A RIQUADRI */}
              <div onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}
                style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, overflow: "hidden", marginBottom: 12 }}>
                {/* Intestazione giorni */}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", borderBottom: `1px solid ${T.bdr}` }}>
                  {["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].map((d, i) => (
                    <div key={i} style={{ fontSize: 10, fontWeight: 700, color: T.sub, padding: "7px 4px", textAlign: "center", borderRight: i < 6 ? `1px solid ${T.bdr}` : "none" }}>{d}</div>
                  ))}
                </div>
                {/* Celle mese */}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)" }}>
                  {monthDays.map((d, i) => {
                    const inMonth = d.getMonth() === selDate.getMonth();
                    const sel = isSameDay(d, selDate);
                    const tod = isToday2(d);
                    const evs = eventsOn(d);
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    const isExp = expandedDay === dateStr(d);
                    const col = Math.floor(i % 7);
                    return (
                      <div key={i}
                        onClick={() => { setSelDate(new Date(d)); setExpandedDay(isExp ? null : dateStr(d)); }}
                        onDoubleClick={() => { setSelDate(new Date(d)); setNewEvent(prev => ({...prev, date: dateStr(d)})); setShowNewEvent(true); }}
                        style={{
                        minHeight: 72, padding: "5px 6px",
                        borderRight: col < 6 ? `1px solid ${T.bdr}` : "none",
                        borderBottom: `1px solid ${T.bdr}`,
                        background: sel ? T.acc + "18" : isExp ? T.accLt : isWeekend && inMonth ? T.bg : T.card,
                        cursor: "pointer", position: "relative",
                        outline: sel ? `2px solid ${T.acc}` : isExp ? `1.5px solid ${T.acc}50` : "none",
                        outlineOffset: -1,
                      }}>
                        {/* Numero giorno */}
                        <div style={{
                          display: "inline-flex", alignItems: "center", justifyContent: "center",
                          width: 22, height: 22, borderRadius: "50%", fontSize: 12, fontWeight: sel || tod ? 800 : 400,
                          background: tod ? T.acc : "transparent",
                          color: tod ? "#fff" : !inMonth ? T.sub2 : sel ? T.acc : T.text,
                          marginBottom: 3,
                        }}>{d.getDate()}</div>
                        {/* Eventi (max 3 visibili) */}
                        {evs.slice(0, 3).map((ev, ei) => (
                          <div key={ev.id} onClick={(e) => { e.stopPropagation(); setSelectedEvent(ev); setSelDate(new Date(d)); }} style={{
                            display: "flex", alignItems: "center", gap: 3, marginBottom: 1,
                            padding: "1px 4px", borderRadius: 3, fontSize: 10, fontWeight: 600,
                            background: (ev.color || tipoEvColor(ev.tipo)) + "20",
                            borderLeft: `2px solid ${ev.color || tipoEvColor(ev.tipo)}`,
                            overflow: "hidden", whiteSpace: "nowrap",
                          }}>
                            <span style={{ color: ev.color || tipoEvColor(ev.tipo), overflow: "hidden", textOverflow: "ellipsis", maxWidth: "100%" }}>
                              {ev.time ? ev.time.slice(0,5) + " " : ""}{ev.text}
                            </span>
                          </div>
                        ))}
                        {evs.length > 3 && (
                          <div style={{ fontSize: 9, color: T.sub, fontWeight: 600 }}>+{evs.length - 3} altri</div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
              {/* Sezione prossimi eventi */}
              {prossimiEventi.length > 0 && (
                <div style={{ ...S.card, marginBottom: 10, padding: "12px 14px" }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, textTransform: "uppercase", letterSpacing: 0.8, marginBottom: 10 }}>Prossimi eventi</div>
                  {prossimiEventi.map((ev, i) => {
                    const evDate = new Date(ev.date + "T12:00:00");
                    const isEvToday = ev.date === todayStr;
                    const isEvTomorrow = ev.date === dateStr(new Date(Date.now() + 86400000));
                    const labelData = isEvToday ? "Oggi" : isEvTomorrow ? "Domani" : evDate.toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "short" });
                    return (
                      <div key={ev.id} onClick={() => { setSelDate(evDate); setSelectedEvent(ev); }}
                        style={{ display: "flex", gap: 10, padding: "8px 0", borderBottom: i < prossimiEventi.length-1 ? `1px solid ${T.bdr}` : "none", cursor: "pointer", alignItems: "center" }}>
                        <div style={{ width: 3, alignSelf: "stretch", borderRadius: 2, background: ev.color || tipoEvColor(ev.tipo), flexShrink: 0 }} />
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 13, fontWeight: 600 }}>{ev.text}</div>
                          <div style={{ display: "flex", gap: 6, marginTop: 2, flexWrap: "wrap" }}>
                            {ev.cm && <span style={S.badge(T.accLt, T.acc)}>{ev.cm}</span>}
                            {ev.persona && <span style={S.badge(T.purpleLt, T.purple)}>üë§ {ev.persona}</span>}
                          </div>
                        </div>
                        <div style={{ textAlign: "right" }}>
                          <div style={{ fontSize: 11, fontWeight: 700, color: isEvToday ? T.acc : T.sub }}>{labelData}</div>
                          {ev.time && <div style={{ fontSize: 11, color: T.sub }}>{ev.time}</div>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* Pannello evento selezionato (click su evento nella griglia) */}
              {selectedEvent && isSameDay(new Date(selectedEvent.date), selDate) && (
                <div style={{ ...S.card, padding: "12px 14px", marginBottom: 8, borderLeft: `3px solid ${selectedEvent.color || T.acc}` }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 4 }}>{selectedEvent.text}</div>
                      <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                        {selectedEvent.time && <span style={S.badge(T.bg, T.sub)}>üïê {selectedEvent.time}</span>}
                        {selectedEvent.cm && <span style={S.badge(T.accLt, T.acc)}>{selectedEvent.cm}</span>}
                        {selectedEvent.persona && <span style={S.badge(T.purpleLt, T.purple)}>üë§ {selectedEvent.persona}</span>}
                        {selectedEvent.addr && <span style={S.badge(T.grnLt, T.grn)}>üìç {selectedEvent.addr}</span>}
                      </div>
                    </div>
                    <div onClick={() => setSelectedEvent(null)} style={{ padding: 4, cursor: "pointer", color: T.sub, fontSize: 16 }}>√ó</div>
                  </div>
                  <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
                    {selectedEvent.addr && <div onClick={() => window.open("https://maps.google.com/?q=" + encodeURIComponent(selectedEvent.addr))} style={{ flex:1, padding:"6px", borderRadius:6, background:T.blueLt, textAlign:"center", cursor:"pointer", fontSize:11, fontWeight:600, color:T.blue }}>üóù¬∫ Mappa</div>}
                    <div onClick={() => {
                      const ev = selectedEvent;
                      const cmObj = cantieri.find(c => c.code === ev.cm) || null;
                      const cliente = cmObj ? `${cmObj.cliente} ${cmObj.cognome||""}`.trim() : (ev.persona || "Cliente");
                      const dataFmt = new Date(ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" });
                      const tpl = `Gentile ${cliente},

Le confermo l'appuntamento:

üìÖ ${dataFmt}${ev.time ? " alle " + ev.time : ""}
üìç ${ev.addr || "da concordare"}

${ev.text}

Per qualsiasi necessit√† non esiti a contattarmi.

Cordiali saluti,
Fabio Cozza
Walter Cozza Serramenti`;
                      setMailBody(tpl);
                      setShowMailModal({ ev, cm: cmObj });
                    }} style={{ flex:1, padding:"6px", borderRadius:6, background:T.accLt, textAlign:"center", cursor:"pointer", fontSize:11, fontWeight:600, color:T.acc }}>‚úâÔ∏è Mail</div>
                    <div onClick={() => deleteEvent(selectedEvent.id)} style={{ flex:1, padding:"6px", borderRadius:6, background:T.redLt, textAlign:"center", cursor:"pointer", fontSize:11, fontWeight:600, color:T.red }}>üóù‚Äò Elimina</div>
                  </div>
                </div>
              )}
              <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 8 }}>
                {selDate.toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })}
              </div>
              {dayEvents.length === 0 ? (
                <div style={{ padding: "16px", textAlign: "center", color: T.sub, fontSize: 12, background: T.card, borderRadius: T.r, border: `1px dashed ${T.bdr}` }}>Nessun evento. Tocca + per aggiungere.</div>
              ) : dayEvents.map(renderEventCard)}
            </>
          )}

          {/* === VISTA SETTIMANA === */}
          {agendaView === "settimana" && (
            <>
              <div style={{ display: "flex", gap: 2, marginBottom: 12 }}>
                {weekDays.map((d, i) => {
                  const sel = isSameDay(d, selDate);
                  const tod = isToday2(d);
                  const n = eventsOn(d).length;
                  return (
                    <div key={i} onClick={() => setSelDate(new Date(d))} style={{ flex: 1, textAlign: "center", padding: "8px 2px", borderRadius: 10, background: sel ? T.acc : tod ? T.accLt : T.card, border: `1px solid ${sel ? T.acc : T.bdr}`, cursor: "pointer" }}>
                      <div style={{ fontSize: 9, fontWeight: 600, color: sel ? "#fff" : T.sub, textTransform: "uppercase" }}>
                        {["Lu", "Ma", "Me", "Gi", "Ve", "Sa", "Do"][i]}
                      </div>
                      <div style={{ fontSize: 14, fontWeight: 700, color: sel ? "#fff" : T.text, marginTop: 2 }}>{d.getDate()}</div>
                      {n > 0 && <div style={{ width: 5, height: 5, borderRadius: "50%", background: sel ? "#fff" : T.red, margin: "2px auto 0" }} />}
                    </div>
                  );
                })}
              </div>
              <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 8 }}>
                {selDate.toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })}
              </div>
              {dayEvents.length === 0 ? (
                <div style={{ padding: "16px", textAlign: "center", color: T.sub, fontSize: 12, background: T.card, borderRadius: T.r, border: `1px dashed ${T.bdr}` }}>Nessun evento</div>
              ) : dayEvents.map(renderEventCard)}
            </>
          )}

          {/* === VISTA GIORNO === */}
          {agendaView === "giorno" && (
            <>
              {/* Timeline ore ‚Äî scrollabile con dito */}
              <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, overflowY: "auto", overflowX: "hidden", marginBottom: 12, maxHeight: "60vh" } as any}>
                {Array.from({ length: 15 }, (_, i) => i + 6).map(h => {
                  const hour = `${String(h).padStart(2, "0")}:00`;
                  const hourEvents = dayEvents.filter(e => e.time && e.time.startsWith(String(h).padStart(2, "0")));
                  return (
                    <div key={h} style={{ display: "flex", borderBottom: `1px solid ${T.bdr}`, minHeight: 48 }}>
                      <div style={{ width: 48, padding: "4px 6px", fontSize: 10, color: T.sub, fontFamily: FM, fontWeight: 600, borderRight: `1px solid ${T.bdr}`, flexShrink: 0 }}>{hour}</div>
                      <div style={{ flex: 1, padding: "4px 8px" }}>
                        {hourEvents.map(ev => (
                          <div key={ev.id} onClick={() => setSelectedEvent(selectedEvent?.id === ev.id ? null : ev)} style={{ padding: "6px 10px", marginBottom: 2, borderRadius: 6, background: selectedEvent?.id === ev.id ? (ev.color || T.acc) + "30" : (ev.color || T.acc) + "18", borderLeft: `3px solid ${ev.color || T.acc}`, cursor: "pointer", transition: "all 0.15s" }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{ev.text} {ev.persona && <span style={{ fontWeight: 400, color: T.sub }}>¬∑ {ev.persona}</span>}</div>
                            {ev.addr && <div style={{ fontSize: 10, color: T.sub, marginTop: 1 }}>{ev.addr}</div>}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
              {/* Unscheduled */}
              {dayEvents.filter(e => !e.time).length > 0 && (
                <>
                  <div style={{ fontSize: 12, fontWeight: 700, marginBottom: 6, color: T.sub }}>Senza orario</div>
                  {dayEvents.filter(e => !e.time).map(ev => (<div key={ev.id} onClick={() => setSelectedEvent(selectedEvent?.id === ev.id ? null : ev)} style={{ padding: "8px 12px", marginBottom: 4, borderRadius: 8, background: selectedEvent?.id === ev.id ? (ev.color || T.acc) + "30" : (ev.color || T.acc) + "18", borderLeft: `3px solid ${ev.color || T.acc}`, cursor: "pointer" }}><div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{ev.text}</div>{ev.persona && <div style={{ fontSize: 11, color: T.sub }}>{ev.persona} {ev.addr ? "¬∑ " + ev.addr : ""}</div>}</div>))}
                </>
              )}
            </>
          )}
        </div>
      </div>
    );
  };

// =======================================================
// MASTRO ERP v2 ‚Äî PARTE 4/5
// Righe 3595-4130: Agenda (Giorno/Settimana/Mese), Chat AI, Settings
// =======================================================
  /* == CHAT / AI TAB == */
  const renderMessaggi = () => {
    const chIco = { email: "üìß", whatsapp: "üí¨", sms: "üì±", telegram: "‚úàÔ∏è" };
    const chCol = { email: T.blue, whatsapp: "#25d366", sms: T.orange, telegram: "#0088cc" };
    const chBg = { email: T.blueLt, whatsapp: "#25d36618", sms: T.orangeLt, telegram: "#0088cc18" };
    const filteredMsgs = msgs.filter(m => {
      const matchFilter = msgFilter === "tutti" || m.canale === msgFilter;
      const matchSearch = !msgSearch.trim() || m.from.toLowerCase().includes(msgSearch.toLowerCase()) || m.preview.toLowerCase().includes(msgSearch.toLowerCase());
      return matchFilter && matchSearch;
    });
    const unread = msgs.filter(m => !m.read).length;

    const filteredContatti = [...contatti, ...team.map(t => ({ id: "t" + t.id, nome: t.nome, tipo: "team", ruolo: t.ruolo, tel: "", email: "", preferito: true, canali: ["whatsapp", "email"], cm: "", colore: t.colore }))].filter(c => {
      const matchF = rubricaFilter === "tutti" || (rubricaFilter === "preferiti" && c.preferito) || (rubricaFilter === "team" && c.tipo === "team") || (rubricaFilter === "clienti" && c.tipo === "cliente") || (rubricaFilter === "fornitori" && (c.tipo === "fornitore" || c.tipo === "professionista"));
      const matchS = !rubricaSearch.trim() || c.nome.toLowerCase().includes(rubricaSearch.toLowerCase());
      return matchF && matchS;
    }).sort((a, b) => (b.preferito ? 1 : 0) - (a.preferito ? 1 : 0) || a.nome.localeCompare(b.nome));

    return (
      <div style={{ paddingBottom: 80 }}>
        <div style={S.header}>
          <div style={{ flex: 1 }}>
            <div style={S.headerTitle}>Messaggi</div>
            <div style={S.headerSub}>{unread > 0 ? `${unread} non letti` : "Tutti letti"} ¬∑ {msgs.length} conversazioni</div>
          </div>
          <div onClick={() => setShowCompose(true)} style={{ width: 36, height: 36, borderRadius: 10, background: T.acc, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
            <Ico d={ICO.pen} s={16} c="#fff" />
          </div>
        </div>

        {/* Sub-tabs: Chat / Rubrica / AI */}
        <div style={{ display: "flex", margin: "8px 16px", borderRadius: 10, border: `1px solid ${T.bdr}`, overflow: "hidden" }}>
          {[
            { id: "chat", l: "üí¨ Chat", count: unread },
            { id: "email", l: "‚úâÔ∏è Email", count: gmailMessages.filter(m => m.unread).length },
            { id: "ai", l: "ü§ñ AI", count: aiInbox.filter(m => !m.read).length },
            { id: "rubrica", l: "üìí Rubrica", count: 0 }
          ].map(st => (
            <div key={st.id} onClick={() => setMsgSubTab(st.id)} style={{ flex: 1, padding: "10px 4px", textAlign: "center", fontSize: 12, fontWeight: 700, cursor: "pointer", background: msgSubTab === st.id ? T.acc : T.card, color: msgSubTab === st.id ? "#fff" : T.sub, transition: "all 0.2s", position: "relative" }}>
              {st.l}
              {st.count > 0 && <span style={{ marginLeft: 4, fontSize: 9, fontWeight: 800, padding: "1px 5px", borderRadius: 8, background: msgSubTab === st.id ? "rgba(255,255,255,0.3)" : T.red, color: "#fff" }}>{st.count}</span>}
            </div>
          ))}
        </div>

        {/* == CHAT TAB == */}
        {msgSubTab === "chat" && (<>
          <div style={{ padding: "4px 16px 8px" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>
              <Ico d={ICO.search} s={14} c={T.sub} />
              <input style={{ flex: 1, border: "none", background: "transparent", fontSize: 13, color: T.text, outline: "none", fontFamily: FF }} placeholder="Cerca contatto o messaggio..." value={msgSearch} onChange={e => setMsgSearch(e.target.value)} />
              {msgSearch && <div onClick={() => setMsgSearch("")} style={{ cursor: "pointer", fontSize: 14, color: T.sub }}>‚úï</div>}
            </div>
          </div>
          <div style={{ display: "flex", gap: 4, padding: "0 16px 10px", overflowX: "auto" }}>
            {[
              { id: "tutti", l: "Tutti", c: T.acc },
              { id: "whatsapp", l: "üí¨ WhatsApp", c: "#25d366" },
              { id: "email", l: "üìß Email", c: T.blue },
              { id: "sms", l: "üì± SMS", c: T.orange },
              { id: "telegram", l: "‚úàÔ∏è Telegram", c: "#0088cc" },
            ].map(f => {
              const unr = f.id === "tutti" ? unread : msgs.filter(m => m.canale === f.id && !m.read).length;
              return (
                <div key={f.id} onClick={() => setMsgFilter(f.id)} style={{ padding: "6px 12px", borderRadius: 20, border: `1px solid ${msgFilter === f.id ? f.c : T.bdr}`, background: msgFilter === f.id ? f.c + "15" : T.card, fontSize: 11, fontWeight: 600, cursor: "pointer", whiteSpace: "nowrap", color: msgFilter === f.id ? f.c : T.sub, display: "flex", alignItems: "center", gap: 4 }}>
                  {f.l}
                  {unr > 0 && <span style={{ width: 16, height: 16, borderRadius: "50%", background: f.c, color: "#fff", fontSize: 9, fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center" }}>{unr}</span>}
                </div>
              );
            })}
          </div>
          <div style={{ padding: "0 16px" }}>
            {filteredMsgs.length === 0 ? (
              <div style={{ padding: 30, textAlign: "center", color: T.sub, fontSize: 13 }}>Nessun messaggio</div>
            ) : (
              <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, overflow: "hidden" }}>
                {filteredMsgs.map(m => (
                  <div key={m.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "12px 14px", borderBottom: `1px solid ${T.bg}`, cursor: "pointer", background: m.read ? "transparent" : T.acc + "06" }} onClick={() => { setMsgs(ms => ms.map(x => x.id === m.id ? { ...x, read: true } : x)); setSelectedMsg(m); }}>
                    <div style={{ width: 42, height: 42, borderRadius: "50%", background: chBg[m.canale] || T.bg, border: `2px solid ${chCol[m.canale] || T.bdr}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, flexShrink: 0, position: "relative" }}>
                      {m.from.charAt(0).toUpperCase()}
                      <div style={{ position: "absolute", bottom: -2, right: -2, fontSize: 10, background: T.card, borderRadius: "50%", padding: 1 }}>{chIco[m.canale]}</div>
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                        <div style={{ fontSize: 13, fontWeight: m.read ? 500 : 700, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{m.from}</div>
                        <div style={{ fontSize: 10, color: m.read ? T.sub : T.acc, fontWeight: m.read ? 400 : 700, flexShrink: 0, marginLeft: 8 }}>{m.time}</div>
                      </div>
                      <div style={{ fontSize: 12, color: m.read ? T.sub : T.text, marginTop: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", fontWeight: m.read ? 400 : 500 }}>{m.preview}</div>
                      {m.cm && <div style={{ marginTop: 3 }}><span style={S.badge(T.accLt, T.acc)}>{m.cm}</span></div>}
                    </div>
                    {!m.read && <div style={{ width: 10, height: 10, borderRadius: "50%", background: T.acc, flexShrink: 0 }} />}
                  </div>
                ))}
              </div>
            )}
          </div>
        </>)}

        {/* == EMAIL TAB == */}
        {msgSubTab === "email" && (<>
          {!gmailStatus.connected ? (
            <div style={{ margin: "20px 16px", textAlign: "center" }}>
              <div style={{ fontSize: 48, marginBottom: 12 }}>‚úâÔ∏è</div>
              <div style={{ fontSize: 16, fontWeight: 800, color: T.text, marginBottom: 8 }}>Collega la tua email</div>
              <div style={{ fontSize: 12, color: T.sub, marginBottom: 20, lineHeight: 1.6 }}>
                Collegando Gmail, riceverai le email dei clienti e fornitori direttamente nell'Inbox di MASTRO.
                Le email vengono automaticamente associate alle commesse.
              </div>
              <div onClick={() => window.location.href = "/api/gmail/auth"} style={{ display: "inline-block", padding: "14px 32px", borderRadius: 12, background: "#ea4335", color: "#fff", fontSize: 14, fontWeight: 800, cursor: "pointer" }}>
                <span style={{ marginRight: 8 }}>üìß</span> Collega Gmail
              </div>
              <div style={{ fontSize: 10, color: T.sub, marginTop: 12 }}>Supporta Gmail e Google Workspace. I dati restano sul tuo dispositivo.</div>
            </div>
          ) : gmailSelected ? (
            /* === EMAIL DETAIL VIEW === */
            <div style={{ padding: "0 16px" }}>
              <div onClick={() => { setGmailSelected(null); setGmailReply(""); }} style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 0", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 700 }}>
                ‚Üê Torna alla inbox
              </div>
              {/* Email header */}
              <div style={{ background: T.card, borderRadius: 12, padding: 14, marginBottom: 10, border: `1px solid ${T.bdr}` }}>
                <div style={{ fontSize: 15, fontWeight: 800, color: T.text, marginBottom: 6 }}>{gmailSelected.subject || "(senza oggetto)"}</div>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                  <div>
                    <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{gmailSelected.from?.replace(/<.*>/, "").trim()}</div>
                    <div style={{ fontSize: 10, color: T.sub }}>{gmailSelected.from?.match(/<(.+)>/)?.[1] || gmailSelected.from}</div>
                  </div>
                  <div style={{ fontSize: 10, color: T.sub }}>{new Date(gmailSelected.timestamp).toLocaleDateString("it-IT", { day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" })}</div>
                </div>
                {/* Commessa match */}
                {(() => { const match = gmailMatchCommessa(gmailSelected); return match ? (
                  <div onClick={() => { setSelectedCM(match); setTab("commesse"); }} style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 10px", borderRadius: 8, background: T.acc + "10", border: `1px solid ${T.acc}30`, cursor: "pointer", marginTop: 4 }}>
                    <span style={{ fontSize: 12 }}>üìÅ</span>
                    <span style={{ fontSize: 11, fontWeight: 700, color: T.acc }}>{match.code} ‚Äî {match.cliente} {match.cognome || ""}</span>
                  </div>
                ) : null; })()}
                {/* Attachments */}
                {gmailSelected.attachments?.length > 0 && (
                  <div style={{ marginTop: 8 }}>
                    <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, marginBottom: 4 }}>üìé ALLEGATI ({gmailSelected.attachments.length})</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {gmailSelected.attachments.map((a, i) => (
                        <div key={i} style={{ padding: "4px 8px", borderRadius: 6, background: T.bg, border: `1px solid ${T.bdr}`, fontSize: 10, color: T.text }}>
                          {a.filename.endsWith(".pdf") ? "üìÑ" : a.filename.match(/\.(jpg|png|jpeg)$/i) ? "üñº" : "üìé"} {a.filename}
                          <span style={{ fontSize: 8, color: T.sub, marginLeft: 4 }}>{Math.round(a.size/1024)}KB</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
              {/* Email body */}
              <div style={{ background: T.card, borderRadius: 12, padding: 14, marginBottom: 10, border: `1px solid ${T.bdr}`, fontSize: 12, color: T.text, lineHeight: 1.7, whiteSpace: "pre-wrap", maxHeight: 300, overflowY: "auto" }}>
                {gmailSelected.body || gmailSelected.snippet || "(nessun contenuto)"}
              </div>
              {/* Quick actions */}
              <div style={{ background: T.card, borderRadius: 12, padding: 12, marginBottom: 10, border: `1px solid ${T.bdr}` }}>
                <div style={{ fontSize: 9, fontWeight: 800, color: T.sub, textTransform: "uppercase", marginBottom: 8 }}>‚ö° Azioni rapide</div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                  {/* Link a commessa esistente */}
                  {(() => { const match = gmailMatchCommessa(gmailSelected); return match ? (
                    <div onClick={() => { setSelectedCM(match); setTab("commesse"); }} style={{ padding: "8px 14px", borderRadius: 8, background: T.acc + "15", color: T.acc, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>üìÅ Apri {match.code}</div>
                  ) : null; })()}
                  {/* Crea nuova commessa */}
                  <div onClick={() => {
                    const fromName = (gmailSelected.from || "").replace(/<.*>/, "").trim();
                    const fromEmail = gmailSelected.from?.match(/<(.+)>/)?.[1] || gmailSelected.from || "";
                    setNewCM(p => ({ ...p, cliente: fromName, email: fromEmail, note: "Da email: " + (gmailSelected.subject || "") }));
                    setShowModal("commessa");
                    setGmailSelected(null);
                    setTab("commesse");
                  }} style={{ padding: "8px 14px", borderRadius: 8, background: "#34c75915", color: "#34c759", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                    üìã Nuova commessa
                  </div>
                  {/* Crea evento/appuntamento */}
                  <div onClick={() => {
                    const fromName = (gmailSelected.from || "").replace(/<.*>/, "").trim();
                    setNewEvent({ text: gmailSelected.subject || "Appuntamento", persona: fromName, date: new Date().toISOString().split("T")[0], time: "09:00", tipo: "sopralluogo", addr: "", reminder: "", cm: "" });
                    setShowNewEvent(true);
                    setGmailSelected(null);
                    setTab("agenda");
                  }} style={{ padding: "8px 14px", borderRadius: 8, background: "#5856d615", color: "#5856d6", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                    üìÖ Crea evento
                  </div>
                  {/* Crea task */}
                  <div onClick={() => {
                    const fromName = (gmailSelected.from || "").replace(/<.*>/, "").trim();
                    setNewTask({ text: "Rispondere a " + fromName + ": " + (gmailSelected.subject || ""), date: new Date().toISOString().split("T")[0], priority: "media", cm: "", meta: "", time: "", persona: fromName });
                    setShowModal("task");
                    setTab("agenda");
                    setGmailSelected(null);
                  }} style={{ padding: "8px 14px", borderRadius: 8, background: "#ff950015", color: "#ff9500", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                    ‚úÖ Crea task
                  </div>
                  {/* Aggiungi a rubrica */}
                  <div onClick={() => {
                    const fromName = (gmailSelected.from || "").replace(/<.*>/, "").trim();
                    const fromEmail = gmailSelected.from?.match(/<(.+)>/)?.[1] || gmailSelected.from || "";
                    const exists = contatti.find(c => c.email?.toLowerCase() === fromEmail.toLowerCase());
                    if (exists) { alert("Gi√† in rubrica: " + exists.nome); return; }
                    const parts = fromName.split(" ");
                    setContatti(prev => [...prev, { id: Date.now(), nome: parts[0] || fromName, cognome: parts.slice(1).join(" ") || "", email: fromEmail, telefono: "", tipo: "cliente", preferito: false }]);
                    alert("‚úÖ " + fromName + " aggiunto alla rubrica!");
                  }} style={{ padding: "8px 14px", borderRadius: 8, background: "#af52de15", color: "#af52de", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                    üìí Rubrica
                  </div>
                  {/* Copia email */}
                  <div onClick={() => { const fromEmail = gmailSelected.from?.match(/<(.+)>/)?.[1] || gmailSelected.from; navigator.clipboard?.writeText(fromEmail); alert("Email copiata!"); }} style={{ padding: "8px 14px", borderRadius: 8, background: T.bg, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer", border: `1px solid ${T.bdr}` }}>üìã Copia email</div>
                  {/* Seleziona tutto il testo */}
                  <div onClick={() => { navigator.clipboard?.writeText(gmailSelected.body || gmailSelected.snippet || ""); alert("Testo email copiato!"); }} style={{ padding: "8px 14px", borderRadius: 8, background: T.bg, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer", border: `1px solid ${T.bdr}` }}>üìÑ Copia testo</div>
                </div>
              </div>
              {/* Reply */}
              <div style={{ background: T.card, borderRadius: 12, padding: 12, border: `1px solid ${T.bdr}` }}>
                <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>‚Ü©Ô∏è RISPONDI</div>
                <textarea value={gmailReply} onChange={e => setGmailReply(e.target.value)} rows={4} placeholder="Scrivi la risposta..."
                  style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.bg, fontSize: 12, color: T.text, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box" as any, lineHeight: 1.5 }} />
                <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
                  <button disabled={!gmailReply.trim() || gmailSending} onClick={() => {
                    const to = gmailSelected.from?.match(/<(.+)>/)?.[1] || gmailSelected.from;
                    gmailSendReply(to, gmailSelected.subject, gmailReply, gmailSelected.threadId);
                  }} style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: gmailReply.trim() ? "#007aff" : T.bdr, color: "#fff", fontSize: 13, fontWeight: 700, cursor: gmailReply.trim() ? "pointer" : "default", fontFamily: "inherit", opacity: gmailSending ? 0.6 : 1 }}>
                    {gmailSending ? "Invio..." : "‚úâÔ∏è Invia risposta"}
                  </button>
                </div>
              </div>
            </div>
          ) : (
            /* === EMAIL LIST VIEW === */
            <div style={{ padding: "0 16px" }}>
              {/* Connected status + search */}
              <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                <div style={{ flex: 1, display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>
                  <span style={{ fontSize: 14 }}>üîç</span>
                  <input value={gmailSearch} onChange={e => setGmailSearch(e.target.value)} onKeyDown={e => { if (e.key === "Enter") gmailFetchMessages(gmailSearch); }}
                    placeholder="Cerca email..." style={{ flex: 1, border: "none", background: "transparent", fontSize: 12, color: T.text, outline: "none", fontFamily: FF }} />
                  {gmailSearch && <div onClick={() => { setGmailSearch(""); gmailFetchMessages(); }} style={{ cursor: "pointer", fontSize: 14, color: T.sub }}>‚úï</div>}
                </div>
                <div onClick={() => gmailFetchMessages(gmailSearch)} style={{ padding: "8px 12px", borderRadius: 10, background: T.acc, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>
                  üîÑ
                </div>
              </div>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
                <div style={{ fontSize: 10, color: T.sub }}>üìß {gmailStatus.email} ¬∑ {gmailMessages.length} email</div>
                <div onClick={async () => { if(confirm("Disconnettere Gmail?")) { await fetch("/api/gmail/disconnect", { method: "POST" }); setGmailStatus({ connected: false }); setGmailMessages([]); }}} style={{ fontSize: 10, color: T.red, cursor: "pointer" }}>Disconnetti</div>
              </div>

              {gmailLoading && gmailMessages.length === 0 ? (
                <div style={{ textAlign: "center", padding: 40, color: T.sub }}>‚è≥ Caricamento email...</div>
              ) : gmailMessages.length === 0 ? (
                <div style={{ textAlign: "center", padding: 40, color: T.sub }}>Nessuna email trovata</div>
              ) : (
                <>
                  {gmailMessages.map(m => {
                    const match = gmailMatchCommessa(m);
                    const fromName = m.from?.replace(/<.*>/, "").trim() || "‚Äî";
                    const fromShort = fromName.length > 25 ? fromName.substring(0, 25) + "‚Ä¶" : fromName;
                    return (
                      <div key={m.id} onClick={() => setGmailSelected(m)} style={{ padding: "10px 12px", background: T.card, borderRadius: 10, border: `1px solid ${m.unread ? T.acc + "40" : T.bdr}`, marginBottom: 6, cursor: "pointer", borderLeft: m.unread ? `3px solid ${T.acc}` : "none" }}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 3 }}>
                          <div style={{ fontSize: 12, fontWeight: m.unread ? 800 : 600, color: T.text, flex: 1 }}>{fromShort}</div>
                          <div style={{ fontSize: 9, color: T.sub, flexShrink: 0, marginLeft: 8 }}>{new Date(m.timestamp).toLocaleDateString("it-IT", { day: "2-digit", month: "short" })}</div>
                        </div>
                        <div style={{ fontSize: 11, fontWeight: m.unread ? 700 : 400, color: T.text, marginBottom: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" as any }}>{m.subject || "(senza oggetto)"}</div>
                        <div style={{ fontSize: 10, color: T.sub, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" as any }}>{m.snippet}</div>
                        <div style={{ display: "flex", gap: 4, marginTop: 4 }}>
                          {match && <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.acc + "15", color: T.acc, fontWeight: 700 }}>üìÅ {match.code}</span>}
                          {m.attachments?.length > 0 && <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.bg, color: T.sub, fontWeight: 700 }}>üìé {m.attachments.length}</span>}
                          {m.unread && <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.acc + "15", color: T.acc, fontWeight: 700 }}>NUOVA</span>}
                        </div>
                      </div>
                    );
                  })}
                  {gmailNextPage && (
                    <div onClick={() => gmailFetchMessages(gmailSearch, gmailNextPage)} style={{ textAlign: "center", padding: 12, color: T.acc, fontSize: 12, fontWeight: 700, cursor: "pointer" }}>
                      {gmailLoading ? "‚è≥ Caricamento..." : "üì• Carica altre email"}
                    </div>
                  )}
                </>
              )}
            </div>
          )}
        </>)}

        {/* == AI INBOX TAB == */}
        {msgSubTab === "ai" && (<>
          {/* Header spiegazione */}
          <div style={{ margin: "0 16px 10px", padding: "10px 12px", borderRadius: 10, background: "linear-gradient(135deg, #1A1A1C, #2A2008)", border: `1px solid ${T.acc}30`, display: "flex", alignItems: "center", gap: 10 }}>
            <span style={{ fontSize: 22 }}>ü§ñ</span>
            <div>
              <div style={{ fontSize: 12, fontWeight: 700, color: "#fff" }}>AI classifica le tue email</div>
              <div style={{ fontSize: 10, color: "#888", marginTop: 1 }}>Collegata al tuo indirizzo mail ‚Äî suggerisce dove archiviare ogni messaggio</div>
            </div>
          </div>

          {/* Lista email classificate */}
          <div style={{ padding: "0 16px" }}>
            {aiInbox.map(m => {
              const isSelected = selectedAiMsg?.id === m.id;
              return (
                <div key={m.id} style={{ ...S.card, marginBottom: 8, padding: 0, overflow: "hidden", opacity: m.archiviata ? 0.5 : 1 }}>
                  {/* Header messaggio */}
                  <div onClick={() => setSelectedAiMsg(isSelected ? null : m)}
                    style={{ padding: "11px 13px", display: "flex", gap: 10, alignItems: "flex-start", cursor: "pointer", background: m.read ? T.card : T.acc + "06" }}>
                    {/* Avatar */}
                    <div style={{ width: 38, height: 38, borderRadius: "50%", background: m.ai.color + "20", border: `2px solid ${m.ai.color}40`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15, fontWeight: 700, color: m.ai.color, flexShrink: 0 }}>
                      {m.from.charAt(0)}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 4 }}>
                        <div style={{ fontSize: 12, fontWeight: m.read ? 500 : 700, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", flex: 1 }}>{m.from}</div>
                        <div style={{ fontSize: 10, color: T.sub, flexShrink: 0 }}>{m.time}</div>
                      </div>
                      <div style={{ fontSize: 11, fontWeight: m.read ? 400 : 600, color: T.text, marginTop: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{m.subject}</div>
                      {/* Badge AI */}
                      <div style={{ display: "flex", gap: 4, marginTop: 4, alignItems: "center", flexWrap: "wrap" }}>
                        <span style={{ fontSize: 9, fontWeight: 800, padding: "2px 7px", borderRadius: 8, background: m.ai.color + "18", color: m.ai.color, border: `1px solid ${m.ai.color}30` }}>
                          {m.ai.emoji} {m.ai.label}
                        </span>
                        <span style={{ fontSize: 9, fontWeight: 700, color: T.sub }}>
                          ü§ñ {m.ai.confidenza}% sicuro
                        </span>
                        {m.ai.cmSuggerita && <span style={{ ...S.badge(T.accLt, T.acc) }}>{m.ai.cmSuggerita}</span>}
                        {m.archiviata && <span style={{ fontSize: 9, fontWeight: 700, color: T.grn }}>‚úì Archiviata</span>}
                      </div>
                    </div>
                    <span style={{ fontSize: 13, color: T.sub, transform: isSelected ? "rotate(90deg)" : "rotate(0)", transition: "transform 0.2s", flexShrink: 0, marginTop: 2 }}>‚Ä∫</span>
                  </div>

                  {/* Dettaglio espanso */}
                  {isSelected && (
                    <div style={{ borderTop: `1px solid ${T.bdr}`, padding: "12px 13px" }}>
                      {/* Testo email */}
                      <div style={{ fontSize: 11, color: T.sub, lineHeight: 1.6, marginBottom: 10, padding: "8px 10px", background: T.bg, borderRadius: 8 }}>
                        {m.body}
                      </div>

                      {/* Analisi AI */}
                      <div style={{ background: m.ai.color + "10", border: `1px solid ${m.ai.color}30`, borderRadius: 10, padding: "10px 12px", marginBottom: 10 }}>
                        <div style={{ fontSize: 10, fontWeight: 800, color: m.ai.color, letterSpacing: 1, textTransform: "uppercase", marginBottom: 6 }}>ü§ñ Analisi AI</div>
                        <div style={{ fontSize: 12, color: T.text, marginBottom: 4 }}><strong>Tipo:</strong> {m.ai.emoji} {m.ai.label} ({m.ai.confidenza}% confidenza)</div>
                        <div style={{ fontSize: 12, color: T.text, marginBottom: 4 }}><strong>Azione suggerita:</strong> {m.ai.azione}</div>
                        {m.ai.note && <div style={{ fontSize: 11, color: T.sub, fontStyle: "italic" }}>"{m.ai.note}"</div>}
                      </div>

                      {/* Dati estratti (se nuova commessa) */}
                      {m.ai.estratto && (
                        <div style={{ background: T.grnLt, border: `1px solid ${T.grn}30`, borderRadius: 10, padding: "10px 12px", marginBottom: 10 }}>
                          <div style={{ fontSize: 10, fontWeight: 800, color: T.grn, letterSpacing: 1, textTransform: "uppercase", marginBottom: 6 }}>üìã Dati estratti automaticamente</div>
                          {m.ai.estratto.cliente && <div style={{ fontSize: 12, color: T.text, marginBottom: 3 }}>üë§ <strong>Cliente:</strong> {m.ai.estratto.cliente}</div>}
                          {m.ai.estratto.indirizzo && <div style={{ fontSize: 12, color: T.text, marginBottom: 3 }}>üìç <strong>Indirizzo:</strong> {m.ai.estratto.indirizzo}</div>}
                          {m.ai.estratto.email && <div style={{ fontSize: 12, color: T.text, marginBottom: 3 }}>‚úâÔ∏è <strong>Email:</strong> {m.ai.estratto.email}</div>}
                          {m.ai.estratto.note && <div style={{ fontSize: 12, color: T.text }}>üìù <strong>Note:</strong> {m.ai.estratto.note}</div>}
                        </div>
                      )}

                      {/* Azioni */}
                      {!m.archiviata && (
                        <div style={{ display: "flex", gap: 6 }}>
                          <div onClick={() => {
                            setAiInbox(ai => ai.map(x => x.id === m.id ? { ...x, archiviata: true, read: true } : x));
                            setSelectedAiMsg(null);
                            if (m.ai.cmSuggerita) {
                              const cm = cantieri.find(c => c.code === m.ai.cmSuggerita);
                              if (cm) { setSelectedCM(cm); setTab("commesse"); }
                            }
                          }} style={{ flex: 2, padding: "10px", borderRadius: 9, background: m.ai.color, color: "#fff", textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>
                            {m.ai.cmNuova ? "‚ûï Crea Commessa" : `üîó ${m.ai.azione.split(" ").slice(0,3).join(" ¬∑ ")}`}
                          </div>
                          <div onClick={() => {
                            setAiInbox(ai => ai.map(x => x.id === m.id ? { ...x, archiviata: true, read: true } : x));
                            setSelectedAiMsg(null);
                          }} style={{ flex: 1, padding: "10px", borderRadius: 9, background: T.bg, border: `1px solid ${T.bdr}`, color: T.sub, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>
                            Ignora
                          </div>
                          <div onClick={() => {
                            const dest = m.email || "";
                            const tpl = `Gentile ${m.from.split(" ")[0]},

Grazie per il suo messaggio.

`;
                            setMailBody(tpl);
                            setShowMailModal({ ev: { text: m.subject, date: new Date().toISOString().slice(0,10), time: "", addr: "" }, cm: null, emailOverride: dest });
                          }} style={{ flex: 1, padding: "10px", borderRadius: 9, background: T.accLt, border: `1px solid ${T.acc}30`, color: T.acc, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>
                            ‚úâÔ∏è
                          </div>
                        </div>
                      )}
                      {m.archiviata && (
                        <div style={{ padding: "8px 12px", background: T.grnLt, borderRadius: 8, textAlign: "center", fontSize: 12, fontWeight: 700, color: T.grn }}>
                          ‚úì Archiviata con successo
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </>)}

        {/* == RUBRICA TAB == */}
        {msgSubTab === "rubrica" && (<>
          <div style={{ padding: "4px 16px 8px" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>
              <Ico d={ICO.search} s={14} c={T.sub} />
              <input style={{ flex: 1, border: "none", background: "transparent", fontSize: 13, color: T.text, outline: "none", fontFamily: FF }} placeholder="Cerca nella rubrica..." value={rubricaSearch} onChange={e => setRubricaSearch(e.target.value)} />
              {rubricaSearch && <div onClick={() => setRubricaSearch("")} style={{ cursor: "pointer", fontSize: 14, color: T.sub }}>‚úï</div>}
            </div>
          </div>
          <div style={{ display: "flex", gap: 4, padding: "0 16px 10px", overflowX: "auto" }}>
            {[
              { id: "tutti", l: "Tutti", c: T.acc },
              { id: "preferiti", l: "‚≠ê Preferiti", c: "#ff9500" },
              { id: "team", l: "üë• Team", c: "#34c759" },
              { id: "clienti", l: "üè† Clienti", c: T.blue },
              { id: "fornitori", l: "üè≠ Fornitori", c: "#af52de" },
            ].map(f => (
              <div key={f.id} onClick={() => setRubricaFilter(f.id)} style={{ padding: "6px 12px", borderRadius: 20, border: `1px solid ${rubricaFilter === f.id ? f.c : T.bdr}`, background: rubricaFilter === f.id ? f.c + "15" : T.card, fontSize: 11, fontWeight: 600, cursor: "pointer", whiteSpace: "nowrap", color: rubricaFilter === f.id ? f.c : T.sub }}>
                {f.l}
              </div>
            ))}
          </div>
          <div style={{ padding: "0 16px" }}>
            <div style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, overflow: "hidden" }}>
              {filteredContatti.length === 0 ? (
                <div style={{ padding: 30, textAlign: "center", color: T.sub, fontSize: 13 }}>Nessun contatto trovato</div>
              ) : filteredContatti.map(c => {
                const tipoColor = c.tipo === "team" ? "#34c759" : c.tipo === "cliente" ? T.blue : c.tipo === "fornitore" ? "#af52de" : "#ff9500";
                const tipoLabel = c.tipo === "team" ? "Team" : c.tipo === "cliente" ? "Cliente" : c.tipo === "fornitore" ? "Fornitore" : "Professionista";
                return (
                  <div key={c.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "12px 14px", borderBottom: `1px solid ${T.bg}` }}>
                    <div style={{ width: 42, height: 42, borderRadius: "50%", background: (c.colore || tipoColor) + "18", border: `2px solid ${c.colore || tipoColor}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, fontWeight: 700, color: c.colore || tipoColor, flexShrink: 0, position: "relative" }}>
                      {c.nome.split(" ").map(w => w[0]).join("").substring(0, 2)}
                      {c.preferito && <div style={{ position: "absolute", top: -4, right: -4, fontSize: 10 }}>‚≠ê</div>}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontSize: 13, fontWeight: 600, color: T.text }}>{c.nome}</div>
                      <div style={{ display: "flex", gap: 4, marginTop: 2, alignItems: "center", flexWrap: "wrap" }}>
                        <span style={S.badge(tipoColor + "18", tipoColor)}>{tipoLabel}</span>
                        {c.ruolo && <span style={{ fontSize: 10, color: T.sub }}>{c.ruolo}</span>}
                        {c.cm && <span style={S.badge(T.accLt, T.acc)}>{c.cm}</span>}
                      </div>
                    </div>
                    <div style={{ display: "flex", gap: 4 }}>
                      {(c.canali || []).includes("whatsapp") && (
                        <div onClick={() => { setComposeMsg(m => ({ ...m, canale: "whatsapp", to: c.nome })); setShowCompose(true); }} style={{ width: 32, height: 32, borderRadius: "50%", background: "#25d36618", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, cursor: "pointer" }}>üí¨</div>
                      )}
                      {(c.canali || []).includes("email") && (
                        <div onClick={() => { setComposeMsg(m => ({ ...m, canale: "email", to: c.nome })); setShowCompose(true); }} style={{ width: 32, height: 32, borderRadius: "50%", background: T.blueLt, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, cursor: "pointer" }}>üìß</div>
                      )}
                      <div onClick={() => { setContatti(cs => cs.map(x => x.id === c.id ? { ...x, preferito: !x.preferito } : x)); }} style={{ width: 32, height: 32, borderRadius: "50%", background: c.preferito ? "#ff950018" : T.bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, cursor: "pointer" }}>
                        {c.preferito ? "‚≠ê" : "‚òÜ"}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </>)}

      </div>
    );
  };

  /* == SETTINGS TAB == */

  // ‚ïê‚ïê‚ïê CONTABILIT√Ä PRO ‚ïê‚ïê‚ïê
  const renderContabilita = () => {
    const today = new Date();
    const [cY, cM] = contabMese.split("-").map(Number);
    const daysInMonth = new Date(cY, cM, 0).getDate();
    const firstDow = (new Date(cY, cM - 1, 1).getDay() + 6) % 7; // Mon=0
    const meseLbl = new Date(cY, cM - 1).toLocaleDateString("it-IT", { month: "long", year: "numeric" });
    
    // All invoices
    const allEmesse = fattureDB || [];
    const allRicevute = fatturePassive || [];
    
    // Monthly filter
    const meseEmesse = allEmesse.filter(f => (f.dataISO || "").startsWith(contabMese));
    const meseRicevute = allRicevute.filter(f => (f.dataISO || f.data || "").startsWith(contabMese));
    
    // Totals
    const totEmesso = allEmesse.reduce((s, f) => s + (f.importo || 0), 0);
    const totIncassato = allEmesse.filter(f => f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
    const totDaIncassare = allEmesse.filter(f => !f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
    const totCosti = allRicevute.reduce((s, f) => s + (f.importo || 0), 0);
    const totPagati = allRicevute.filter(f => f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
    const totDaPagare = allRicevute.filter(f => !f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
    const margine = totIncassato - totPagati;
    
    // Mese totals
    const meseEmTot = meseEmesse.reduce((s, f) => s + (f.importo || 0), 0);
    const meseRicTot = meseRicevute.reduce((s, f) => s + (f.importo || 0), 0);
    
    // Scadenze per giorno del mese (calendar dots)
    const scadenzeMap: Record<number, Array<{tipo:string;importo:number;nome:string}>> = {};
    allEmesse.filter(f => !f.pagata && f.scadenza && f.scadenza.startsWith(contabMese)).forEach(f => {
      const d = parseInt(f.scadenza.split("-")[2]);
      if (!scadenzeMap[d]) scadenzeMap[d] = [];
      scadenzeMap[d].push({ tipo: "incasso", importo: f.importo, nome: f.cliente });
    });
    allRicevute.filter(f => !f.pagata && f.scadenza && f.scadenza.startsWith(contabMese)).forEach(f => {
      const d = parseInt(f.scadenza.split("-")[2]);
      if (!scadenzeMap[d]) scadenzeMap[d] = [];
      scadenzeMap[d].push({ tipo: "pagamento", importo: f.importo || 0, nome: f.fornitore || "" });
    });
    
    // Monthly bar data (last 6 months)
    const barData: Array<{lbl:string;emesso:number;costi:number}> = [];
    for (let i = 5; i >= 0; i--) {
      const bd = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const key = `${bd.getFullYear()}-${String(bd.getMonth()+1).padStart(2,"0")}`;
      const lbl = bd.toLocaleDateString("it-IT", { month: "short" });
      const em = allEmesse.filter(f => (f.dataISO || "").startsWith(key)).reduce((s, f) => s + (f.importo || 0), 0);
      const co = allRicevute.filter(f => (f.dataISO || f.data || "").startsWith(key)).reduce((s, f) => s + (f.importo || 0), 0);
      barData.push({ lbl, emesso: em, costi: co });
    }
    const barMax = Math.max(...barData.map(b => Math.max(b.emesso, b.costi)), 1);
    
    const prevMese = () => { const d = new Date(cY, cM - 2, 1); setContabMese(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`); };
    const nextMese = () => { const d = new Date(cY, cM, 1); setContabMese(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`); };
    
    const fmt = (n: number) => "‚Ç¨" + n.toLocaleString("it-IT", { minimumFractionDigits: 0 });
    
    return (
    <div style={{ position: "fixed", inset: 0, zIndex: 10002, background: T.bg, overflow: "auto" }}>
      {/* HEADER */}
      <div style={{ display: "flex", alignItems: "center", padding: "12px 16px", background: T.card, borderBottom: "1px solid " + T.bdr, position: "sticky", top: 0, zIndex: 10 }}>
        <div onClick={() => setShowContabilita(false)} style={{ cursor: "pointer", color: T.acc, fontWeight: 700, fontSize: 14 }}>‚Üê Indietro</div>
        <div style={{ flex: 1, textAlign: "center", fontSize: 16, fontWeight: 800, color: T.text }}>üí∞ Contabilit√†</div>
        <div style={{ width: 60 }} />
      </div>
      
      {/* TABS */}
      <div style={{ display: "flex", margin: "8px 16px", borderRadius: 8, border: "1px solid " + T.bdr, overflow: "hidden" }}>
        {[{ id: "panoramica", l: "üìä Panoramica" }, { id: "emesse", l: "üì§ Emesse" }, { id: "ricevute", l: "üì• Ricevute" }, { id: "calendario", l: "üìÖ Calendario" }, { id: "sdi", l: "üèõ SDI" }].map(t => (
          <div key={t.id} onClick={() => setContabTab(t.id)} style={{ flex: 1, padding: "8px 2px", textAlign: "center", fontSize: 9, fontWeight: 700, background: contabTab === t.id ? T.acc : T.card, color: contabTab === t.id ? "#fff" : T.sub, cursor: "pointer" }}>{t.l}</div>
        ))}
      </div>
      
      <div style={{ padding: "0 16px 100px" }}>
      
      {/* ‚ïê‚ïê‚ïê PANORAMICA ‚ïê‚ïê‚ïê */}
      {contabTab === "panoramica" && <>
        {/* KPI Cards */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6, marginBottom: 12 }}>
          <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>FATTURATO</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: T.text }}>{fmt(totEmesso)}</div>
          </div>
          <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>INCASSATO</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: T.grn }}>{fmt(totIncassato)}</div>
          </div>
          <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>DA INCASSARE</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: T.red }}>{fmt(totDaIncassare)}</div>
          </div>
        </div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6, marginBottom: 16 }}>
          <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>COSTI</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: T.orange }}>{fmt(totCosti)}</div>
          </div>
          <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>DA PAGARE</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: "#ff6b00" }}>{fmt(totDaPagare)}</div>
          </div>
          <div style={{ background: T.card, borderRadius: T.r, border: "2px solid " + (margine >= 0 ? T.grn : T.red), padding: "10px 8px", textAlign: "center" }}>
            <div style={{ fontSize: 7, color: T.sub, textTransform: "uppercase" as const, fontWeight: 700, letterSpacing: 0.5 }}>MARGINE</div>
            <div style={{ fontSize: 17, fontWeight: 900, color: margine >= 0 ? T.grn : T.red }}>{fmt(margine)}</div>
          </div>
        </div>
        
        {/* BAR CHART - Last 6 months */}
        <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 12 }}>üìä Andamento 6 mesi</div>
          <div style={{ display: "flex", alignItems: "flex-end", gap: 4, height: 100 }}>
            {barData.map((b, i) => (
              <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column" as const, alignItems: "center", gap: 2 }}>
                <div style={{ width: "100%", display: "flex", gap: 2, alignItems: "flex-end", justifyContent: "center", height: 80 }}>
                  <div style={{ width: "40%", height: Math.max(2, (b.emesso / barMax) * 80), background: T.acc, borderRadius: "3px 3px 0 0", transition: "height 0.3s" }} />
                  <div style={{ width: "40%", height: Math.max(2, (b.costi / barMax) * 80), background: T.orange, borderRadius: "3px 3px 0 0", transition: "height 0.3s" }} />
                </div>
                <div style={{ fontSize: 8, color: T.sub, fontWeight: 600, textTransform: "uppercase" as const }}>{b.lbl}</div>
              </div>
            ))}
          </div>
          <div style={{ display: "flex", gap: 16, justifyContent: "center", marginTop: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 10, height: 10, borderRadius: 2, background: T.acc }} /><span style={{ fontSize: 9, color: T.sub }}>Fatturato</span></div>
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 10, height: 10, borderRadius: 2, background: T.orange }} /><span style={{ fontSize: 9, color: T.sub }}>Costi</span></div>
          </div>
        </div>
        
        {/* SCADENZE PROSSIME */}
        <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
          <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>‚è∞ Prossime scadenze</div>
          {[...allEmesse.filter(f => !f.pagata && f.scadenza).map(f => ({ ...f, dir: "incasso" as const })), 
            ...allRicevute.filter(f => !f.pagata && f.scadenza).map(f => ({ ...f, dir: "pagamento" as const }))]
            .sort((a, b) => (a.scadenza || "z").localeCompare(b.scadenza || "z")).slice(0, 6).map((f, i) => {
              const isLate = (f.scadenza || "") < today.toISOString().split("T")[0];
              const days = Math.ceil((new Date(f.scadenza || "").getTime() - today.getTime()) / 86400000);
              return <div key={i} style={{ display: "flex", alignItems: "center", padding: "8px 0", borderBottom: i < 5 ? "1px solid " + T.bg : "none" }}>
                <div style={{ width: 32, height: 32, borderRadius: 8, background: isLate ? T.redLt : f.dir === "incasso" ? T.grnLt : T.orangeLt, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, flexShrink: 0 }}>
                  {isLate ? "üî¥" : f.dir === "incasso" ? "üì§" : "üì•"}
                </div>
                <div style={{ flex: 1, marginLeft: 10 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{(f as any).fornitore || f.cliente}</div>
                  <div style={{ fontSize: 9, color: isLate ? T.red : T.sub }}>
                    {isLate ? `Scaduta da ${Math.abs(days)} gg` : days === 0 ? "Scade oggi!" : `Tra ${days} gg`} ¬∑ {new Date(f.scadenza || "").toLocaleDateString("it-IT")}
                  </div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontSize: 14, fontWeight: 900, color: isLate ? T.red : T.text }}>{fmt(f.importo || 0)}</div>
                  <div style={{ fontSize: 8, color: f.dir === "incasso" ? T.grn : T.orange, fontWeight: 700 }}>{f.dir === "incasso" ? "INCASSO" : "PAGAMENTO"}</div>
                </div>
              </div>;
            })}
          {allEmesse.filter(f => !f.pagata && f.scadenza).length + allRicevute.filter(f => !f.pagata && f.scadenza).length === 0 && (
            <div style={{ textAlign: "center", padding: 16, color: T.sub, fontSize: 12 }}>‚úÖ Nessuna scadenza in sospeso</div>
          )}
        </div>
        
        {/* RIEPILOGO MESE */}
        <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 16 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
            <div onClick={prevMese} style={{ cursor: "pointer", fontSize: 16, color: T.acc }}>‚óÄ</div>
            <div style={{ fontSize: 13, fontWeight: 800, color: T.text, textTransform: "capitalize" as const }}>{meseLbl}</div>
            <div onClick={nextMese} style={{ cursor: "pointer", fontSize: 16, color: T.acc }}>‚ñ∂</div>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            <div style={{ padding: 10, borderRadius: 8, background: T.accLt, textAlign: "center" }}>
              <div style={{ fontSize: 8, color: T.sub, fontWeight: 700 }}>EMESSO</div>
              <div style={{ fontSize: 16, fontWeight: 900, color: T.acc }}>{fmt(meseEmTot)}</div>
              <div style={{ fontSize: 9, color: T.sub }}>{meseEmesse.length} fatture</div>
            </div>
            <div style={{ padding: 10, borderRadius: 8, background: T.orangeLt, textAlign: "center" }}>
              <div style={{ fontSize: 8, color: T.sub, fontWeight: 700 }}>COSTI</div>
              <div style={{ fontSize: 16, fontWeight: 900, color: T.orange }}>{fmt(meseRicTot)}</div>
              <div style={{ fontSize: 9, color: T.sub }}>{meseRicevute.length} fatture</div>
            </div>
          </div>
        </div>
      </>}
      
      {/* ‚ïê‚ïê‚ïê EMESSE ‚ïê‚ïê‚ïê */}
      {contabTab === "emesse" && <>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>Fatture emesse ({allEmesse.length})</div>
          <div style={{ display: "flex", gap: 4 }}>
            <span style={{ fontSize: 9, padding: "3px 8px", borderRadius: 4, background: T.grnLt, color: T.grn, fontWeight: 700 }}>‚úÖ {allEmesse.filter(f=>f.pagata).length}</span>
            <span style={{ fontSize: 9, padding: "3px 8px", borderRadius: 4, background: T.redLt, color: T.red, fontWeight: 700 }}>‚è≥ {allEmesse.filter(f=>!f.pagata).length}</span>
          </div>
        </div>
        {allEmesse.sort((a, b) => b.numero - a.numero).map(f => (
          <div key={f.id} style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 12, marginBottom: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 800, color: T.text }}>N. {f.numero}/{f.anno}</div>
                <div style={{ fontSize: 10, color: T.sub }}>{f.cliente} ¬∑ {f.cmCode}</div>
                <div style={{ display: "flex", gap: 4, marginTop: 3 }}>
                  <span style={{ fontSize: 8, padding: "1px 6px", borderRadius: 3, background: f.tipo === "saldo" ? T.grnLt : f.tipo === "acconto" ? T.orangeLt : T.accLt, color: f.tipo === "saldo" ? T.grn : f.tipo === "acconto" ? T.orange : T.acc, fontWeight: 700 }}>{f.tipo?.toUpperCase()}</span>
                  <span style={{ fontSize: 8, color: T.sub }}>{f.dataISO}</span>
                  {f.scadenza && <span style={{ fontSize: 8, color: f.scadenza < today.toISOString().split("T")[0] && !f.pagata ? T.red : T.sub }}>Scade: {new Date(f.scadenza).toLocaleDateString("it-IT")}</span>}
                </div>
              </div>
              <div style={{ textAlign: "right" }}>
                <div style={{ fontSize: 18, fontWeight: 900, color: f.pagata ? T.grn : T.red }}>{fmt(f.importo)}</div>
                <span onClick={() => setFattureDB(prev => prev.map(ff => ff.id === f.id ? { ...ff, pagata: !ff.pagata, dataPagamento: !ff.pagata ? today.toISOString().split("T")[0] : null } : ff))} 
                  style={{ fontSize: 9, padding: "3px 8px", borderRadius: 6, background: f.pagata ? T.grnLt : T.redLt, color: f.pagata ? T.grn : T.red, fontWeight: 700, cursor: "pointer" }}>
                  {f.pagata ? "‚úÖ Incassata" : "‚è≥ Da incassare"}
                </span>
              </div>
            </div>
            <div style={{ display: "flex", gap: 6 }}>
              <div onClick={() => generaFatturaPDF(f)} style={{ flex: 1, padding: 7, borderRadius: 6, background: T.accLt, color: T.acc, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>üìÑ PDF</div>
              <div onClick={() => generaXmlSDI(f)} style={{ flex: 1, padding: 7, borderRadius: 6, background: T.purpleLt, color: T.purple, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>üèõ XML SDI</div>
              <div onClick={() => { const cm = cantieri.find(c => c.code === f.cmCode); if(cm) { setSelectedCM(cm); setShowContabilita(false); setTab("commesse"); }}} style={{ flex: 1, padding: 7, borderRadius: 6, background: T.bg, color: T.sub, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer", border: "1px solid " + T.bdr }}>üìÅ Commessa</div>
            </div>
          </div>
        ))}
      </>}
      
      {/* ‚ïê‚ïê‚ïê RICEVUTE ‚ïê‚ïê‚ïê */}
      {contabTab === "ricevute" && <>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>Fatture fornitori ({allRicevute.length})</div>
          <div onClick={() => setShowFatturaPassiva(true)} style={{ padding: "6px 14px", borderRadius: 8, background: T.acc, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>+ Nuova</div>
        </div>
        {allRicevute.length === 0 && <div style={{ textAlign: "center", padding: 32, color: T.sub }}>
          <div style={{ fontSize: 32, marginBottom: 8 }}>üì•</div>
          <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 4 }}>Nessuna fattura ricevuta</div>
          <div style={{ fontSize: 11 }}>Clicca "+ Nuova" per registrare una fattura fornitore</div>
        </div>}
        {allRicevute.map(f => (
          <div key={f.id} style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 12, marginBottom: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between" }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 800, color: T.text }}>{f.fornitore}</div>
                <div style={{ fontSize: 10, color: T.sub }}>N. {f.numero} ¬∑ {f.data || f.dataISO}</div>
                {f.descrizione && <div style={{ fontSize: 9, color: T.sub, marginTop: 2 }}>{f.descrizione}</div>}
                {f.scadenza && <div style={{ fontSize: 9, color: f.scadenza < today.toISOString().split("T")[0] && !f.pagata ? T.red : T.sub, marginTop: 2 }}>
                  {f.scadenza < today.toISOString().split("T")[0] && !f.pagata ? "üî¥ " : ""}Scadenza: {new Date(f.scadenza).toLocaleDateString("it-IT")}
                </div>}
              </div>
              <div style={{ textAlign: "right" }}>
                <div style={{ fontSize: 18, fontWeight: 900, color: T.orange }}>{fmt(f.importo || 0)}</div>
                <span onClick={() => setFatturePassive(prev => prev.map(ff => ff.id === f.id ? { ...ff, pagata: !ff.pagata } : ff))} 
                  style={{ fontSize: 9, padding: "3px 8px", borderRadius: 6, background: f.pagata ? T.grnLt : T.orangeLt, color: f.pagata ? T.grn : T.orange, fontWeight: 700, cursor: "pointer" }}>
                  {f.pagata ? "‚úÖ Pagata" : "‚è≥ Da pagare"}
                </span>
              </div>
            </div>
            <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
              {f.cmId && <div onClick={() => { const cm = cantieri.find(c => c.id === f.cmId); if(cm) { setSelectedCM(cm); setShowContabilita(false); setTab("commesse"); }}} style={{ flex: 1, padding: 6, borderRadius: 6, background: T.accLt, color: T.acc, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>üìÅ Commessa</div>}
              <div onClick={() => setFatturePassive(prev => prev.filter(ff => ff.id !== f.id))} style={{ padding: "6px 12px", borderRadius: 6, background: T.redLt, color: T.red, fontSize: 10, fontWeight: 700, cursor: "pointer" }}>üóë</div>
            </div>
          </div>
        ))}
        {showFatturaPassiva && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 10003, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={e => { if(e.target === e.currentTarget) setShowFatturaPassiva(false); }}>
            <div style={{ background: T.card, borderRadius: 16, padding: 20, width: "90%", maxWidth: 420 }}>
              <div style={{ fontSize: 16, fontWeight: 800, color: T.text, marginBottom: 14 }}>üì• Registra fattura fornitore</div>
              {[{k:"fornitore",l:"Fornitore",t:"text"},{k:"numero",l:"N. Fattura",t:"text"},{k:"data",l:"Data",t:"date"},{k:"importo",l:"Importo ‚Ç¨",t:"number"},{k:"descrizione",l:"Descrizione",t:"text"},{k:"scadenza",l:"Scadenza",t:"date"}].map(f => (
                <div key={f.k} style={{ marginBottom: 8 }}>
                  <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 2 }}>{f.l}</div>
                  <input type={f.t} value={(newFattPassiva as any)[f.k]} onChange={e => setNewFattPassiva(p => ({ ...p, [f.k]: e.target.value }))}
                    style={{ width: "100%", padding: "10px 12px", borderRadius: 10, border: "1px solid " + T.bdr, background: T.bg, color: T.text, fontSize: 13, fontFamily: "inherit", boxSizing: "border-box" as const }} />
                </div>
              ))}
              <div style={{ marginBottom: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 2 }}>Commessa (opzionale)</div>
                <select value={newFattPassiva.cmId} onChange={e => setNewFattPassiva(p => ({ ...p, cmId: e.target.value }))} style={{ width: "100%", padding: "10px 12px", borderRadius: 10, border: "1px solid " + T.bdr, background: T.bg, color: T.text, fontSize: 13, fontFamily: "inherit" }}>
                  <option value="">‚Äî Nessuna ‚Äî</option>
                  {cantieri.map(c => <option key={c.id} value={c.id}>{c.code} ¬∑ {c.cliente}</option>)}
                </select>
              </div>
              <div style={{ display: "flex", gap: 8, marginTop: 14 }}>
                <button onClick={() => setShowFatturaPassiva(false)} style={{ flex: 1, padding: 12, borderRadius: 10, border: "1px solid " + T.bdr, background: T.bg, color: T.sub, fontSize: 13, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
                <button onClick={creaFatturaPassiva} style={{ flex: 2, padding: 12, borderRadius: 10, border: "none", background: T.acc, color: "#fff", fontSize: 13, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>üíæ Registra</button>
              </div>
            </div>
          </div>
        )}
      </>}
      
      {/* ‚ïê‚ïê‚ïê CALENDARIO COMPLETO ‚ïê‚ïê‚ïê */}
      {contabTab === "calendario" && (() => {
        // Gather ALL events for calendar: scadenze + montaggi + events + consegne
        const calMap: Record<number, Array<{tipo:string;ico:string;col:string;label:string;importo?:number;detail?:string}>> = {};
        const addCal = (day: number, item: any) => { if (!calMap[day]) calMap[day] = []; calMap[day].push(item); };
        
        // Scadenze fatture
        allEmesse.filter(f => !f.pagata && f.scadenza && f.scadenza.startsWith(contabMese)).forEach(f => {
          const d = parseInt(f.scadenza.split("-")[2]);
          addCal(d, { tipo: "incasso", ico: "üì§", col: T.grn, label: f.cliente, importo: f.importo, detail: "Da incassare" });
        });
        allRicevute.filter(f => !f.pagata && f.scadenza && f.scadenza.startsWith(contabMese)).forEach(f => {
          const d = parseInt(f.scadenza.split("-")[2]);
          addCal(d, { tipo: "pagamento", ico: "üì•", col: T.orange, label: f.fornitore || "", importo: f.importo || 0, detail: "Da pagare" });
        });
        // Montaggi
        (montaggiDB || []).filter(m => m.data && m.data.startsWith(contabMese)).forEach(m => {
          const d = parseInt(m.data.split("-")[2]);
          const cm = cantieri.find(c => c.id === m.cmId);
          const sq = (squadreDB || []).find(s => s.id === m.squadraId);
          addCal(d, { tipo: "montaggio", ico: "üîß", col: "#007aff", label: cm?.cliente || "Montaggio", detail: sq?.nome || "" });
        });
        // Consegne previste ordini
        (ordiniFornDB || []).filter(o => o.consegna?.prevista && o.consegna.prevista.startsWith(contabMese) && o.stato !== "consegnato").forEach(o => {
          const d = parseInt(o.consegna.prevista.split("-")[2]);
          addCal(d, { tipo: "consegna", ico: "üöö", col: "#af52de", label: o.fornitore?.nome || "Consegna", detail: o.cmCode || "" });
        });
        // Events/appuntamenti
        (events || []).filter(ev => ev.date && ev.date.startsWith(contabMese)).forEach(ev => {
          const d = parseInt(ev.date.split("-")[2]);
          const tipoIco: Record<string,string> = { sopralluogo: "üìç", posa: "üîß", controllo: "üîç", consegna: "üöö", misure: "üìè", altro: "üìå" };
          const tipoCol: Record<string,string> = { sopralluogo: "#007aff", posa: "#34c759", controllo: "#ff9500", consegna: "#af52de", misure: "#5856d6", altro: "#86868b" };
          addCal(d, { tipo: ev.tipo || "altro", ico: tipoIco[ev.tipo] || "üìå", col: tipoCol[ev.tipo] || "#86868b", label: ev.persona || ev.text?.slice(0, 20) || "Evento", detail: ev.time || "" });
        });
        
        return <>
        {/* Month nav */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12, background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: "10px 16px" }}>
          <div onClick={prevMese} style={{ cursor: "pointer", fontSize: 18, color: T.acc, fontWeight: 700 }}>‚óÄ</div>
          <div style={{ fontSize: 15, fontWeight: 800, color: T.text, textTransform: "capitalize" as const }}>{meseLbl}</div>
          <div onClick={nextMese} style={{ cursor: "pointer", fontSize: 18, color: T.acc, fontWeight: 700 }}>‚ñ∂</div>
        </div>
        
        {/* Calendar grid */}
        <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 6, marginBottom: 12 }}>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 2, marginBottom: 4 }}>
            {["LUN","MAR","MER","GIO","VEN","SAB","DOM"].map(d => (
              <div key={d} style={{ textAlign: "center", fontSize: 8, fontWeight: 700, color: T.sub, padding: 4 }}>{d}</div>
            ))}
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 2 }}>
            {Array.from({ length: firstDow }, (_, i) => <div key={"e"+i} />)}
            {Array.from({ length: daysInMonth }, (_, i) => {
              const day = i + 1;
              const dateStr = contabMese + "-" + String(day).padStart(2, "0");
              const isToday = dateStr === today.toISOString().split("T")[0];
              const items = calMap[day] || [];
              const hasMoney = items.some(it => it.tipo === "incasso" || it.tipo === "pagamento");
              const hasMontaggio = items.some(it => it.tipo === "montaggio");
              const hasConsegna = items.some(it => it.tipo === "consegna");
              const hasEvento = items.some(it => !["incasso","pagamento","montaggio","consegna"].includes(it.tipo));
              const bgColor = isToday ? T.accLt : items.length > 0 ? (hasMontaggio ? "#007aff08" : hasMoney ? T.grnLt : hasConsegna ? "#af52de08" : "#f5f5f5") : "transparent";
              return <div key={day} style={{ 
                padding: "3px 1px", borderRadius: 6, minHeight: 44, textAlign: "center",
                background: bgColor,
                border: isToday ? "2px solid " + T.acc : items.length > 0 ? "1px solid " + T.bdr : "1px solid transparent",
              }}>
                <div style={{ fontSize: 11, fontWeight: isToday ? 900 : 600, color: isToday ? T.acc : T.text }}>{day}</div>
                {items.length > 0 && <div style={{ display: "flex", justifyContent: "center", gap: 1, marginTop: 2, flexWrap: "wrap" as any }}>
                  {items.slice(0, 4).map((it, ii) => <div key={ii} style={{ width: 6, height: 6, borderRadius: "50%", background: it.col }} title={it.label} />)}
                  {items.length > 4 && <div style={{ fontSize: 6, color: T.sub, fontWeight: 700 }}>+{items.length - 4}</div>}
                </div>}
                {hasMoney && <div style={{ fontSize: 6, fontWeight: 700, color: T.grn, marginTop: 1 }}>{fmt(items.filter(it => it.tipo === "incasso").reduce((s, x) => s + (x.importo || 0), 0))}</div>}
              </div>;
            })}
          </div>
        </div>
        
        {/* Legend */}
        <div style={{ display: "flex", gap: 8, justifyContent: "center", marginBottom: 12, flexWrap: "wrap" as any }}>
          {[{c:T.grn,l:"Incasso"},{c:T.orange,l:"Pagamento"},{c:"#007aff",l:"Montaggio"},{c:"#af52de",l:"Consegna"},{c:"#5856d6",l:"Evento"}].map(x => (
            <div key={x.l} style={{ display: "flex", alignItems: "center", gap: 3 }}><div style={{ width: 7, height: 7, borderRadius: "50%", background: x.c }} /><span style={{ fontSize: 8, color: T.sub }}>{x.l}</span></div>
          ))}
        </div>
        
        {/* LISTA GIORNO PER GIORNO */}
        <div style={{ fontSize: 13, fontWeight: 800, color: T.text, marginBottom: 8 }}>üìÖ Dettaglio {meseLbl}</div>
        {Object.keys(calMap).sort((a, b) => Number(a) - Number(b)).map(dayStr => {
          const day = Number(dayStr);
          const items = calMap[day];
          const dateStr = contabMese + "-" + String(day).padStart(2, "0");
          const isLate = dateStr < today.toISOString().split("T")[0];
          const dayLbl = new Date(cY, cM - 1, day).toLocaleDateString("it-IT", { weekday: "short", day: "numeric", month: "short" });
          return <div key={dayStr} style={{ marginBottom: 8 }}>
            <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 4, textTransform: "capitalize" as const }}>{dayLbl}</div>
            {items.map((it, si) => (
              <div key={si} style={{ display: "flex", alignItems: "center", padding: "8px 10px", background: T.card, borderRadius: 8, border: "1px solid " + (isLate && (it.tipo === "incasso" || it.tipo === "pagamento") ? T.red + "60" : T.bdr), marginBottom: 3 }}>
                <div style={{ width: 28, height: 28, borderRadius: 8, background: it.col + "18", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, flexShrink: 0 }}>{it.ico}</div>
                <div style={{ flex: 1, marginLeft: 8 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>{it.label}</div>
                  <div style={{ fontSize: 9, color: T.sub }}>{it.detail}</div>
                </div>
                {it.importo && it.importo > 0 && <div style={{ fontSize: 13, fontWeight: 900, color: isLate && it.tipo === "incasso" ? T.red : it.col }}>{fmt(it.importo)}</div>}
              </div>
            ))}
          </div>;
        })}
        {Object.keys(calMap).length === 0 && <div style={{ textAlign: "center", padding: 32, color: T.sub }}>
          <div style={{ fontSize: 32, marginBottom: 8 }}>üìÖ</div>
          <div style={{ fontSize: 13, fontWeight: 700 }}>Nessun evento questo mese</div>
        </div>}
        </>;
      })()}
      
      {/* ‚ïê‚ïê‚ïê SDI ‚ïê‚ïê‚ïê */}
      {contabTab === "sdi" && <>
        <div style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
          <div style={{ fontSize: 14, fontWeight: 800, color: T.text, marginBottom: 4 }}>üèõ Fatturazione Elettronica</div>
          <div style={{ fontSize: 11, color: T.sub, marginBottom: 4 }}>Genera XML FatturaPA 1.2 per il Sistema di Interscambio (SDI).</div>
          <div style={{ fontSize: 9, color: T.sub }}>Formato: FPR12 ¬∑ Regime: RF01 ¬∑ I file possono essere caricati su AdE, Aruba, Fatture in Cloud.</div>
        </div>
        {allEmesse.map(f => (
          <div key={f.id} style={{ display: "flex", alignItems: "center", padding: "10px 12px", background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, marginBottom: 6 }}>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>N. {f.numero}/{f.anno} ‚Äî {f.cliente}</div>
              <div style={{ fontSize: 9, color: T.sub }}>{f.tipo} ¬∑ {f.dataISO} ¬∑ {fmt(f.importo)}</div>
            </div>
            <div onClick={() => generaXmlSDI(f)} style={{ padding: "8px 14px", borderRadius: 8, background: T.purpleLt, color: T.purple, fontSize: 11, fontWeight: 700, cursor: "pointer" }}>üì• XML</div>
          </div>
        ))}
      </>}
      
      </div>
    </div>
    );
  };


  const renderSettings = () => (
    <div style={{ paddingBottom: 80 }}>
      <div style={S.header}>
        <div style={{ flex: 1 }}>
          <div style={S.headerTitle}>Impostazioni</div>
        </div>
        {/* FIX: rimosso supabase.auth.signOut() ‚Äî usa localStorage clear */}
        <div onClick={async () => { try { localStorage.clear(); const { createClient } = await import("@/lib/supabase"); await createClient().auth.signOut(); } catch(e) {} window.location.href = "/login"; }}
          style={{padding:"6px 12px",borderRadius:8,border:"1px solid #e5e5ea",background:"#fff",fontSize:12,fontWeight:700,cursor:"pointer",color:"#86868b"}}>
          Esci
        </div>
      </div>

      {/* Settings sub-tabs ‚Äî scrollable */}
      <div style={{ overflowX: "auto", WebkitOverflowScrolling: "touch", margin: "8px 16px 12px", borderRadius: 8, border: `1px solid ${T.bdr}` }}>
        <div style={{ display: "flex", minWidth: "max-content" }}>
          {[{ id: "settore", l: "üéØ Settore" }, { id: "azienda", l: "üè¢ Azienda" }, { id: "generali", l: "‚öôÔ∏è Generali" }, { id: "piano", l: "üíé Piano" }, { id: "team", l: "üë• Team" }, { id: "squadre", l: "üîß Squadre" }, { id: "fatture", l: "üí∞ Fatture" }, { id: "sistemi", l: "üèó Sistemi" }, { id: "colori", l: "üé® Colori" }, { id: "vetri", l: "ü™ü Vetri" }, { id: "tipologie", l: "üìê Tipologie" }, { id: "coprifili", l: "üìè Coprifili" }, { id: "lamiere", l: "üî© Lamiere" }, { id: "controtelaio", l: "üî≤ Controtelaio" }, { id: "tapparella", l: "‚¨á Tapparella" }, { id: "persiana", l: "üè† Persiana" }, { id: "zanzariera", l: "ü¶ü Zanzariera" }, { id: "cassonetto", l: "üßä Cassonetto" }, { id: "salita", l: "ü™ú Salita" }, { id: "pipeline", l: "üìä Pipeline" }, { id: "libreria", l: "üì¶ Libreria" }, { id: "importa", l: "üì• Importa" }, { id: "guida", l: "üìñ Guida" }, { id: "kit", l: "üîß Kit" }, { id: "marketplace", l: "üè™ Fornitori" }, { id: "temi", l: "üé® Temi" }].map(t => (
            <div key={t.id} onClick={() => setSettingsTab(t.id)} style={{ padding: "8px 12px", textAlign: "center", fontSize: 10, fontWeight: 600, background: settingsTab === t.id ? T.acc : T.card, color: settingsTab === t.id ? "#fff" : T.sub, cursor: "pointer", whiteSpace: "nowrap" }}>
              {t.l}
            </div>
          ))}
        </div>
      </div>

      <div style={{ padding: "0 16px" }}>

        {/* === AZIENDA === */}
        {/* === SETTORE === */}
        {settingsTab === "settore" && (
          <>
            <div style={{ fontSize: 12, color: T.sub, padding: "0 4px 10px", lineHeight: 1.5 }}>Seleziona i settori in cui operi. MASTRO mostrer√† solo le tipologie e funzioni rilevanti per il tuo lavoro.</div>
            {SETTORI.map(s => {
              const isOn = settoriAttivi.includes(s.id);
              const count = TIPOLOGIE_RAPIDE.filter(t => t.settore === s.id).length;
              return (
                <div key={s.id} onClick={() => {
                  setSettoriAttivi(prev => isOn ? prev.filter(x => x !== s.id) : [...prev, s.id]);
                }} style={{
                  padding: "14px 16px", borderRadius: 14, cursor: "pointer", marginBottom: 8,
                  border: `2px solid ${isOn ? "#007aff" : T.bdr}`,
                  background: isOn ? "#007aff08" : T.card,
                  display: "flex", alignItems: "center", gap: 12,
                }}>
                  <div style={{ fontSize: 28, width: 36, textAlign: "center" }}>{s.icon}</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 14, fontWeight: 700, color: isOn ? "#007aff" : T.text }}>{s.label}</div>
                    <div style={{ fontSize: 10, color: T.sub }}>{s.desc}</div>
                    <div style={{ fontSize: 9, color: T.sub, marginTop: 2 }}>{count} tipologie disponibili</div>
                  </div>
                  <div style={{
                    width: 48, height: 28, borderRadius: 14, padding: 2,
                    background: isOn ? "#007aff" : T.bdr,
                    display: "flex", alignItems: "center", transition: "all .2s",
                  }}>
                    <div style={{
                      width: 24, height: 24, borderRadius: 12, background: "#fff",
                      transform: isOn ? "translateX(20px)" : "translateX(0px)",
                      transition: "all .2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)",
                    }} />
                  </div>
                </div>
              );
            })}
            <div style={{ marginTop: 12, padding: 12, background: T.bg, borderRadius: 10, border: `1px solid ${T.bdr}`, fontSize: 11, color: T.sub, lineHeight: 1.5 }}>
              <b>Settori attivi:</b> {settoriAttivi.length} ¬∑ <b>Tipologie disponibili:</b> {tipologieFiltrate.length}<br />
              Le commesse esistenti con tipologie di settori disattivati resteranno visibili.
            </div>
          </>
        )}

        {settingsTab === "azienda" && (
          <div style={{background:"#fff",borderRadius:12,overflow:"hidden",border:`1px solid ${T.bdr}`}}>
            <div style={{padding:"12px 14px",background:T.acc,color:"#fff"}}>
              <div style={{fontSize:13,fontWeight:800}}>Dati Azienda</div>
              <div style={{fontSize:10,opacity:0.8,marginTop:2}}>Questi dati appaiono sul PDF del preventivo</div>
            </div>
            {/* LOGO */}
            <div style={{padding:"14px",borderBottom:`1px solid ${T.bdr}`}}>
              <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:8,textTransform:"uppercase",letterSpacing:"0.04em"}}>Logo Azienda</div>
              <input ref={logoInputRef} type="file" accept="image/png,image/jpeg,image/svg+xml,image/webp" style={{display:"none"}} onChange={e=>{
                const f=e.target.files?.[0]; if(!f) return;
                const r=new FileReader(); r.onload=ev=>setAziendaInfo(a=>({...a,logo:ev.target.result}));
                r.readAsDataURL(f); e.target.value="";
              }}/>
              {aziendaInfo.logo ? (
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <div style={{width:80,height:60,border:`1px solid ${T.bdr}`,borderRadius:8,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",background:"#f9f9f9"}}>
                    <img src={aziendaInfo.logo} style={{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}} alt="logo"/>
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:12,fontWeight:600,color:T.text,marginBottom:4}}>Logo caricato ‚úì</div>
                    <div style={{display:"flex",gap:6}}>
                      <div onClick={()=>logoInputRef.current?.click()} style={{fontSize:11,color:T.acc,fontWeight:700,cursor:"pointer"}}>Cambia</div>
                      <span style={{color:T.bdr}}>¬∑</span>
                      <div onClick={()=>setAziendaInfo(a=>({...a,logo:null}))} style={{fontSize:11,color:"#ff3b30",fontWeight:700,cursor:"pointer"}}>Rimuovi</div>
                    </div>
                  </div>
                </div>
              ) : (
                <div onClick={()=>logoInputRef.current?.click()} style={{border:`2px dashed ${T.bdr}`,borderRadius:10,padding:"16px",textAlign:"center",cursor:"pointer",background:"#fafafa"}}>
                  <div style={{fontSize:24,marginBottom:4}}>üñº</div>
                  <div style={{fontSize:12,fontWeight:700,color:T.text}}>Carica logo</div>
                  <div style={{fontSize:10,color:T.sub,marginTop:2}}>PNG, JPG, SVG ¬∑ max 2MB</div>
                </div>
              )}
            </div>
            {[
              {label:"Ragione Sociale",field:"ragione",placeholder:"Es. Walter Cozza Serramenti SRL"},
              {label:"Partita IVA",field:"piva",placeholder:"Es. 01234567890"},
              {label:"Indirizzo",field:"indirizzo",placeholder:"Es. Via Roma 1, 87100 Cosenza (CS)"},
              {label:"Telefono",field:"telefono",placeholder:"Es. +39 0984 000000"},
              {label:"Email",field:"email",placeholder:"Es. info@azienda.it"},
              {label:"Sito web",field:"website",placeholder:"Es. www.azienda.it"},
              {label:"IBAN",field:"iban",placeholder:"Es. IT60 X054 2811 1010 0000 0123 456"},
              {label:"CCIAA / REA",field:"cciaa",placeholder:"Es. CS-123456"},
              {label:"PEC",field:"pec",placeholder:"Es. azienda@pec.it"},
            ].map(({label,field,placeholder})=>(
              <div key={field} style={{padding:"10px 14px",borderBottom:`1px solid ${T.bdr}`}}>
                <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:4,textTransform:"uppercase",letterSpacing:"0.04em"}}>{label}</div>
                <input
                  value={aziendaInfo[field]||""}
                  onChange={e=>setAziendaInfo(a=>({...a,[field]:e.target.value}))}
                  placeholder={placeholder}
                  style={{width:"100%",border:"none",fontSize:13,fontWeight:600,color:T.text,background:"transparent",fontFamily:FF,outline:"none",padding:0,boxSizing:"border-box"}}
                />
              </div>
            ))}

            {/* CONDIZIONI PREVENTIVO */}
            <div style={{padding:"14px",borderTop:`2px solid ${T.acc}`,marginTop:8}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
                <span style={{fontSize:16}}>üìã</span>
                <div>
                  <div style={{fontSize:13,fontWeight:800,color:T.text}}>Condizioni Preventivo</div>
                  <div style={{fontSize:10,color:T.sub}}>Testi personalizzati stampati nel PDF. Lascia vuoto per usare i testi predefiniti.</div>
                </div>
              </div>
              {[
                {label:"Condizioni di fornitura",field:"condFornitura",placeholder:"Es. L'azienda, nell'esecuzione della produzione √® garante dell'osservanza scrupolosa della regola d'arte e delle norme vigenti.",rows:3},
                {label:"Condizioni di pagamento",field:"condPagamento",placeholder:"Es. 50% acconto alla firma del contratto...\n50% a saldo, a comunicazione merce pronta...",rows:4},
                {label:"Tempi di consegna",field:"condConsegna",placeholder:"Es. PVC Battente Standard 30 gg.\nPVC Porte 35 gg.\nAlluminio 45/50 gg lavorativi.",rows:5},
                {label:"Condizioni di contratto",field:"condContratto",placeholder:"Es. Clausole contrattuali personalizzate, garanzia, trattamento dati...",rows:5},
                {label:"Dettagli tecnici / Chiusura",field:"condDettagli",placeholder:"Es. Documenti alla consegna: Dichiarazione di Prestazione, Dichiarazione energetica, Etichetta CE, Manuale d'uso e manutenzione.",rows:3},
              ].map(({label,field,placeholder,rows})=>(
                <div key={field} style={{marginBottom:10}}>
                  <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:4,textTransform:"uppercase",letterSpacing:"0.04em"}}>{label}</div>
                  <textarea
                    value={aziendaInfo[field]||""}
                    onChange={e=>setAziendaInfo(a=>({...a,[field]:e.target.value}))}
                    placeholder={placeholder}
                    rows={rows}
                    style={{width:"100%",border:`1px solid ${T.bdr}`,borderRadius:8,fontSize:11,color:T.text,background:T.card,fontFamily:FF,padding:"8px 10px",boxSizing:"border-box",resize:"vertical",lineHeight:1.5}}
                  />
                </div>
              ))}
            </div>
            <div style={{padding:"12px 14px",background:"#f0fdf4",display:"flex",alignItems:"center",gap:6}}>
              <span style={{fontSize:14}}>‚úÖ</span>
              <span style={{fontSize:11,color:"#1a9e40",fontWeight:600}}>Salvato automaticamente in ogni preventivo PDF</span>
            </div>
          </div>
        )}

        {/* === GENERALI === */}
        {settingsTab === "generali" && (
          <>
            <div style={{...S.card,marginBottom:8}}><div style={S.cardInner}>
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12}}>
                <div>
                  <div style={{fontSize:13,fontWeight:700}}>üîî Soglia commesse ferme</div>
                  <div style={{fontSize:11,color:T.sub}}>Alert se una commessa non avanza da N giorni</div>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <input type="number" min="1" max="30" value={sogliaDays} onChange={e=>setSogliaDays(parseInt(e.target.value)||5)}
                    style={{width:50,padding:"5px 8px",borderRadius:8,border:`1px solid ${T.bdr}`,fontSize:14,fontWeight:700,textAlign:"center",fontFamily:FF}}/>
                  <span style={{fontSize:11,color:T.sub}}>giorni</span>
                </div>
              </div>
            </div></div>
            <div style={S.card}><div style={S.cardInner}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                {aziendaInfo.logo
                  ? <img src={aziendaInfo.logo} style={{width:48,height:48,borderRadius:"50%",objectFit:"cover",border:`1px solid ${T.bdr}`}} alt="logo"/>
                  : <div style={{ width: 48, height: 48, borderRadius: "50%", background: T.acc, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 18, fontWeight: 700 }}>FC</div>
                }
                <div>
                  <div style={{ fontSize: 15, fontWeight: 700 }}>Fabio Cozza</div>
                  <div style={{ fontSize: 12, color: T.sub }}>{aziendaInfo.ragione}</div>
                </div>
              </div>
            </div></div>
            <div style={{ ...S.card, marginTop: 8 }}><div style={S.cardInner}>
              <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>TEMA</div>
              <div style={{ display: "flex", gap: 6 }}>
                {[["chiaro", "‚òÄÔ∏è"], ["scuro", "üåô"], ["oceano", "üåä"]].map(([id, ico]) => (
                  <div key={id} onClick={() => setTheme(id)} style={{ flex: 1, padding: "10px 4px", borderRadius: 8, border: `1.5px solid ${theme === id ? T.acc : T.bdr}`, textAlign: "center", cursor: "pointer" }}>
                    <div style={{ fontSize: 18 }}>{ico}</div>
                    <div style={{ fontSize: 10, fontWeight: 600, textTransform: "capitalize", marginTop: 2 }}>{id}</div>
                  </div>
                ))}
              </div>
            </div></div>
            <div style={{ ...S.card, marginTop: 8 }}><div style={S.cardInner}>
              <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>STATISTICHE</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, fontSize: 12 }}>
                <div><div style={{ fontSize: 20, fontWeight: 700, color: T.acc }}>{cantieri.length}</div>Commesse</div>
                <div><div style={{ fontSize: 20, fontWeight: 700, color: T.blue }}>{countVani()}</div>Vani</div>
                <div><div style={{ fontSize: 20, fontWeight: 700, color: T.grn }}>{tasks.filter(t => t.done).length}/{tasks.length}</div>Task</div>
              </div>
            </div></div>
          </>
        )}

        {/* === PIANO === */}
        {settingsTab === "piano" && (
          <>
            {/* Current plan banner */}
            <div style={{ ...S.card, marginBottom: 12 }}>
              <div style={{ padding: 16, background: `linear-gradient(135deg, ${T.acc}15, ${T.acc}05)`, borderRadius: T.r }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
                  <div>
                    <div style={{ fontSize: 10, fontWeight: 700, color: T.acc, textTransform: "uppercase" as const, letterSpacing: 1 }}>Piano attuale</div>
                    <div style={{ fontSize: 24, fontWeight: 800, color: T.text, marginTop: 2 }}>
                      {plan.nome} {activePlan === "trial" && <span style={{ fontSize: 12, fontWeight: 600, color: trialDaysLeft <= 3 ? T.red : T.acc }}>({trialDaysLeft}gg rimasti)</span>}
                    </div>
                  </div>
                  {plan.prezzo > 0 && <div style={{ textAlign: "right" as const }}>
                    <div style={{ fontSize: 28, fontWeight: 800, color: T.acc, fontFamily: FM }}>‚Ç¨{plan.prezzo}</div>
                    <div style={{ fontSize: 10, color: T.sub }}>/mese</div>
                  </div>}
                </div>
                <div style={{ display: "flex", gap: 12, flexWrap: "wrap" as const }}>
                  <span style={{ fontSize: 10, color: T.sub }}>üìÅ {cantieri.length}/{plan.maxCommesse === 9999 ? "‚àû" : plan.maxCommesse} commesse</span>
                  <span style={{ fontSize: 10, color: T.sub }}>üë• {plan.maxUtenti} utent{plan.maxUtenti > 1 ? "i" : "e"}</span>
                  <span style={{ fontSize: 10, color: T.sub }}>{plan.sync ? "‚úÖ" : "‚ùå"} Sync</span>
                  <span style={{ fontSize: 10, color: T.sub }}>{plan.pdf ? "‚úÖ" : "‚ùå"} PDF</span>
                </div>
              </div>
            </div>

            {/* Plan comparison */}
            <div style={{ fontSize: 14, fontWeight: 700, color: T.text, padding: "0 16px", marginBottom: 8 }}>Confronta piani</div>
            {(Object.entries(PLANS) as [string, any][]).filter(([k]) => k !== "trial" && k !== "free").map(([key, pl]) => (
              <div key={key} onClick={() => { if (key !== activePlan) setSubPlan(key); }}
                style={{ ...S.card, marginBottom: 8, border: key === activePlan ? `2px solid ${T.acc}` : `1px solid ${T.bdr}`, cursor: "pointer", position: "relative" as const, overflow: "hidden" }}>
                {key === "pro" && <div style={{ position: "absolute" as const, top: 0, right: 0, background: T.acc, color: "#fff", fontSize: 8, fontWeight: 800, padding: "3px 10px", borderBottomLeftRadius: 8, textTransform: "uppercase" as const, letterSpacing: 1 }}>Consigliato</div>}
                <div style={{ padding: 14 }}>
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 10 }}>
                    <div>
                      <div style={{ fontSize: 18, fontWeight: 800, color: key === "pro" ? T.acc : T.text }}>{pl.nome}</div>
                    </div>
                    <div style={{ textAlign: "right" as const }}>
                      <span style={{ fontSize: 26, fontWeight: 800, color: key === "pro" ? T.acc : T.text, fontFamily: FM }}>‚Ç¨{pl.prezzo}</span>
                      <span style={{ fontSize: 11, color: T.sub }}>/mese</span>
                    </div>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "6px 16px" }}>
                    <div style={{ fontSize: 11, color: T.text }}>üìÅ {pl.maxCommesse === 9999 ? "Illimitate" : pl.maxCommesse} commesse</div>
                    <div style={{ fontSize: 11, color: T.text }}>üë• {pl.maxUtenti} utent{pl.maxUtenti > 1 ? "i" : "e"}</div>
                    <div style={{ fontSize: 11, color: pl.sync ? T.grn : T.sub }}>{pl.sync ? "‚úÖ" : "‚ùå"} Sync real-time</div>
                    <div style={{ fontSize: 11, color: pl.pdf ? T.grn : T.sub }}>{pl.pdf ? "‚úÖ" : "‚ùå"} PDF rilievo</div>
                    <div style={{ fontSize: 11, color: pl.admin ? T.grn : T.sub }}>{pl.admin ? "‚úÖ" : "‚ùå"} Pannello admin</div>
                    <div style={{ fontSize: 11, color: pl.api ? T.grn : T.sub }}>{pl.api ? "‚úÖ" : "‚ùå"} API</div>
                    <div style={{ fontSize: 11, color: T.text }}>üìÇ {pl.maxCataloghi === 99 ? "Illimitati" : pl.maxCataloghi} catalog{pl.maxCataloghi > 1 ? "hi" : "o"}</div>
                  </div>
                  {key === activePlan ? (
                    <div style={{ marginTop: 10, padding: "8px 0", textAlign: "center" as const, borderRadius: 8, background: T.acc + "15", fontSize: 12, fontWeight: 700, color: T.acc }}>‚úì Piano attivo</div>
                  ) : (
                    <div style={{ marginTop: 10, padding: "8px 0", textAlign: "center" as const, borderRadius: 8, background: T.acc, fontSize: 12, fontWeight: 700, color: "#fff" }}>
                      {pl.prezzo > (plan.prezzo || 0) ? `Passa a ${pl.nome} ‚Äî ‚Ç¨${pl.prezzo}/mese` : `Passa a ${pl.nome}`}
                    </div>
                  )}
                </div>
              </div>
            ))}

            {/* Free plan note */}
            <div style={{ padding: "8px 16px", marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: T.sub, textAlign: "center" as const }}>
                Il piano Free include 5 commesse e funzionalit√† base. I pagamenti saranno attivati al lancio ufficiale.
              </div>
            </div>
          </>
        )}

        {/* === TEAM === */}
        {settingsTab === "team" && (
          <>
            {team.map(m => (
              <div key={m.id} style={{ ...S.card, marginBottom: 8 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", gap: 10 }}>
                <div style={{ width: 36, height: 36, borderRadius: "50%", background: m.colore, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 12, fontWeight: 700, flexShrink: 0 }}>{m.nome.split(" ").map(n => n[0]).join("")}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, fontWeight: 700 }}>{m.nome}</div>
                  <div style={{ fontSize: 11, color: T.sub }}>{m.ruolo} ‚Äî {m.compiti}</div>
                </div>
                <Ico d={ICO.pen} s={14} c={T.sub} />
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("membro"); setSettingsForm({ nome: "", ruolo: "Posatore", compiti: "" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.bdr}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>+ Aggiungi membro</div>
          </>
        )}

        {/* === SISTEMI E SOTTOSISTEMI === */}
        {settingsTab === "sistemi" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Configura marche, sistemi e sottosistemi con colori collegati</div>
            {sistemiDB.map(s => (
              <div key={s.id} style={{ ...S.card, marginBottom: 8 }}><div style={S.cardInner}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: T.acc }}>{s.marca}</div>
                    <div style={{ fontSize: 12, fontWeight: 600 }}>{s.sistema}</div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 4, justifyContent: "flex-end", marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: T.sub }}>‚Ç¨/mq</span>
                      <input type="number" defaultValue={s.euroMq || ""} onBlur={e => setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, euroMq: parseFloat(e.target.value)||0, prezzoMq: parseFloat(e.target.value)||0 } : x))} style={{ width: 60, padding: "3px 6px", borderRadius: 4, border: `1px solid ${T.bdr}`, fontSize: 13, fontWeight: 700, color: T.grn, textAlign: "right", fontFamily: FM }} />
                    </div>
                    <div style={{ fontSize: 9, color: T.sub }}>+{s.sovRAL}% RAL ¬∑ +{s.sovLegno}% Legno</div>
                    {s.griglia?.length > 0 && <div style={{ fontSize: 9, color: T.acc, fontWeight: 600, marginTop: 2 }}>üìä Griglia {s.griglia.length} prezzi</div>}
                  </div>
                </div>
                {/* Profile image upload */}
                <div style={{ marginBottom: 8, padding: 8, borderRadius: 8, background: T.bg, border: `1px dashed ${T.bdr}` }}>
                  <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 4 }}>Sezione profilo (per preventivo PDF)</div>
                  {s.immagineProfilo ? (
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <img src={s.immagineProfilo} style={{ height: 48, maxWidth: 120, objectFit: "contain", borderRadius: 4, background: "#fff", border: `1px solid ${T.bdr}` }} alt="profilo" />
                      <div onClick={() => setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, immagineProfilo: undefined } : x))} style={{ fontSize: 10, color: T.red, cursor: "pointer", fontWeight: 600 }}>‚úï Rimuovi</div>
                    </div>
                  ) : (
                    <label style={{ display: "inline-flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 6, background: T.acc + "15", color: T.acc, fontSize: 11, fontWeight: 600, cursor: "pointer" }}>
                      üì∑ Carica PNG
                      <input type="file" accept="image/*" style={{ display: "none" }} onChange={e => {
                        const file = e.target.files?.[0]; if (!file) return;
                        const reader = new FileReader();
                        reader.onload = ev => { setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, immagineProfilo: ev.target?.result as string } : x)); };
                        reader.readAsDataURL(file);
                      }} />
                    </label>
                  )}
                </div>
                {/* Griglia prezzi */}
                <div style={{ marginBottom: 8, padding: 8, borderRadius: 8, background: T.bg, border: `1px dashed ${T.bdr}` }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                    <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>Griglia prezzi L√óH {s.griglia?.length > 0 ? `(${s.griglia.length} prezzi)` : ""}</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      <label style={{ padding: "3px 8px", borderRadius: 4, background: T.acc + "15", color: T.acc, fontSize: 9, fontWeight: 600, cursor: "pointer" }}>
                        üìÑ CSV / TXT
                        <input type="file" accept=".csv,.txt" style={{ display: "none" }} onChange={e => {
                          const file = e.target.files?.[0]; if (!file) return;
                          const reader = new FileReader();
                          reader.onload = ev => {
                            const text = ev.target?.result as string;
                            const lines = text.split(/\r?\n/).filter(l => l.trim());
                            const newGrid: any[] = [];
                            // Skip header line if it contains letters
                            const start = /[a-zA-Z]/.test(lines[0] || "") ? 1 : 0;
                            for (let i = start; i < lines.length; i++) {
                              const line = lines[i];
                              // Split by ; , or tab
                              const parts = line.split(/[;\t,]/).map(p => p.trim());
                              if (parts.length >= 3) {
                                // Handle Italian format: "1.200" or "1200" for mm, "350,50" or "350.50" for price
                                const parseMM = (v: string) => parseInt(v.replace(/\./g, "").replace(",", "."));
                                const parsePrice = (v: string) => {
                                  // If has both . and , : "1.350,50" ‚Üí remove dots, comma‚Üídot
                                  if (v.includes(".") && v.includes(",")) return parseFloat(v.replace(/\./g, "").replace(",", "."));
                                  // If only comma: "350,50" ‚Üí comma‚Üídot
                                  if (v.includes(",")) return parseFloat(v.replace(",", "."));
                                  return parseFloat(v);
                                };
                                const l = parseMM(parts[0]); const h = parseMM(parts[1]); const p = parsePrice(parts[2]);
                                if (l > 0 && h > 0 && p > 0) newGrid.push({ l, h, prezzo: Math.round(p * 100) / 100 });
                              }
                            }
                            if (newGrid.length > 0) {
                              newGrid.sort((a,b) => a.l - b.l || a.h - b.h);
                              setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, griglia: newGrid } : x));
                              alert(`‚úÖ ${newGrid.length} prezzi importati!`);
                            } else {
                              alert("‚ö†Ô∏è Nessun prezzo trovato.\n\nFormato accettato:\nLarghezza;Altezza;Prezzo\n1000;1200;350\n1200;1400;420,50");
                            }
                          };
                          reader.readAsText(file);
                        }} />
                      </label>
                      <div onClick={() => {
                        const txt = prompt("Incolla da Excel (L;H;Prezzo, una riga per combinazione):\n\nEsempio:\n1000;1200;350\n1200;1400;420");
                        if (!txt) return;
                        const lines = txt.split(/\r?\n/).filter(l => l.trim());
                        const newGrid: any[] = [...(s.griglia || [])];
                        let added = 0;
                        lines.forEach(line => {
                          const parts = line.split(/[;\t,]/).map(p => p.trim());
                          if (parts.length >= 3) {
                            const l = parseInt(parts[0].replace(/\./g,"")); 
                            const h = parseInt(parts[1].replace(/\./g,""));
                            let pv = parts[2]; if (pv.includes(".") && pv.includes(",")) pv = pv.replace(/\./g,""); pv = pv.replace(",",".");
                            const p = parseFloat(pv);
                            if (l > 0 && h > 0 && p > 0) { newGrid.push({ l, h, prezzo: Math.round(p*100)/100 }); added++; }
                          }
                        });
                        if (added > 0) {
                          newGrid.sort((a,b) => a.l - b.l || a.h - b.h);
                          setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, griglia: newGrid } : x));
                          alert(`‚úÖ ${added} prezzi aggiunti!`);
                        }
                      }} style={{ padding: "3px 8px", borderRadius: 4, background: "#5856d615", color: "#5856d6", fontSize: 9, fontWeight: 600, cursor: "pointer" }}>üìã Incolla</div>
                      <div onClick={() => {
                        const l = prompt("Larghezza (mm):", "1000");
                        const h = prompt("Altezza (mm):", "1200");
                        const p = prompt("Prezzo ‚Ç¨:", "300");
                        if (l && h && p && parseInt(l) > 0 && parseInt(h) > 0 && parseFloat(p.replace(",",".")) > 0) {
                          setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, griglia: [...(x.griglia||[]), { l: parseInt(l), h: parseInt(h), prezzo: parseFloat(p.replace(",",".")) }].sort((a,b) => a.l - b.l || a.h - b.h) } : x));
                        }
                      }} style={{ padding: "3px 8px", borderRadius: 4, background: T.grn + "15", color: T.grn, fontSize: 9, fontWeight: 600, cursor: "pointer" }}>+ Aggiungi</div>
                      {s.griglia?.length > 0 && <div onClick={() => {
                        const csv = "Larghezza;Altezza;Prezzo\n" + s.griglia.map(g => `${g.l};${g.h};${g.prezzo}`).join("\n");
                        const blob = new Blob([csv], { type: "text/csv" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a"); a.href = url; a.download = `listino_${s.nome.replace(/\s/g,"_")}.csv`; a.click();
                      }} style={{ padding: "3px 8px", borderRadius: 4, background: "#ff950015", color: "#ff9500", fontSize: 9, fontWeight: 600, cursor: "pointer" }}>üì• Esporta</div>}
                    </div>
                  </div>
                  {s.griglia?.length > 0 ? (() => {
                    // Build matrix view: unique L values as columns, H as rows
                    const uniqueL = [...new Set(s.griglia.map(g => g.l))].sort((a,b) => a - b);
                    const uniqueH = [...new Set(s.griglia.map(g => g.h))].sort((a,b) => a - b);
                    const showMatrix = uniqueL.length > 1 && uniqueH.length > 1 && uniqueL.length <= 12;
                    return (
                    <div>
                      <div style={{ fontSize: 9, color: T.sub, marginBottom: 3, fontStyle: "italic" }}>
                        Il prezzo viene preso dalla combinazione L√óH pi√π vicina (per eccesso). {s.griglia.length} combinazioni ¬∑ {uniqueL.length}L √ó {uniqueH.length}H
                      </div>
                      {showMatrix ? (
                        <div style={{ overflowX: "auto", borderRadius: 4, border: `1px solid ${T.bdr}` }}>
                          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 9 }}>
                            <thead><tr style={{ background: T.bg }}>
                              <th style={{ padding: "3px 4px", fontWeight: 700, color: T.sub, position: "sticky", left: 0, background: T.bg, borderRight: `1px solid ${T.bdr}`, fontSize: 8 }}>L‚Üí<br/>H‚Üì</th>
                              {uniqueL.map(l => <th key={l} style={{ padding: "3px 4px", fontWeight: 700, color: T.acc, textAlign: "center", fontSize: 8, minWidth: 40 }}>{l}</th>)}
                            </tr></thead>
                            <tbody>{uniqueH.map(h => (
                              <tr key={h} style={{ borderTop: `1px solid ${T.bdr}15` }}>
                                <td style={{ padding: "2px 4px", fontWeight: 700, color: T.acc, position: "sticky", left: 0, background: T.card, borderRight: `1px solid ${T.bdr}`, fontSize: 8 }}>{h}</td>
                                {uniqueL.map(l => {
                                  const g = s.griglia.find(x => x.l === l && x.h === h);
                                  return <td key={l} style={{ padding: "2px 4px", textAlign: "center", fontWeight: g ? 700 : 400, color: g ? T.grn : T.bdr, fontSize: 8 }}>
                                    {g ? `‚Ç¨${g.prezzo}` : "‚Äî"}
                                  </td>;
                                })}
                              </tr>
                            ))}</tbody>
                          </table>
                        </div>
                      ) : (
                        <div style={{ maxHeight: 150, overflowY: "auto", borderRadius: 4, border: `1px solid ${T.bdr}` }}>
                          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 9 }}>
                            <thead><tr style={{ background: T.bg, position: "sticky", top: 0 }}>
                              <th style={{ padding: "3px 6px", textAlign: "left", fontWeight: 700, color: T.sub }}>L (mm)</th>
                              <th style={{ padding: "3px 6px", textAlign: "left", fontWeight: 700, color: T.sub }}>H (mm)</th>
                              <th style={{ padding: "3px 6px", textAlign: "right", fontWeight: 700, color: T.sub }}>Prezzo ‚Ç¨</th>
                              <th style={{ width: 20 }}></th>
                            </tr></thead>
                            <tbody>{s.griglia.map((g, gi) => (
                              <tr key={gi} style={{ borderTop: `1px solid ${T.bdr}20` }}>
                                <td style={{ padding: "2px 6px" }}>{g.l}</td>
                                <td style={{ padding: "2px 6px" }}>{g.h}</td>
                                <td style={{ padding: "2px 6px", textAlign: "right", fontWeight: 700, color: T.grn }}>‚Ç¨{g.prezzo}</td>
                                <td style={{ padding: "2px 4px", cursor: "pointer", color: T.red, textAlign: "center" }} onClick={() => {
                                  setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, griglia: x.griglia.filter((_, i) => i !== gi) } : x));
                                }}>‚úï</td>
                              </tr>
                            ))}</tbody>
                          </table>
                        </div>
                      )}
                      <div style={{ display: "flex", justifyContent: "space-between", marginTop: 4 }}>
                        <div style={{ fontSize: 8, color: T.sub }}>Min: ‚Ç¨{Math.min(...s.griglia.map(g=>g.prezzo))} ¬∑ Max: ‚Ç¨{Math.max(...s.griglia.map(g=>g.prezzo))}</div>
                        <div onClick={() => { if(confirm("Cancellare tutta la griglia?")) setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, griglia: [] } : x)); }} style={{ fontSize: 9, color: T.red, cursor: "pointer" }}>üóë Svuota</div>
                      </div>
                    </div>);
                  })() : (
                    <div style={{ fontSize: 10, color: T.sub, fontStyle: "italic" }}>Nessuna griglia inserita ‚Äî il prezzo viene calcolato a ‚Ç¨/mq.<br/>Puoi caricare il listino del fornitore (CSV: Larghezza;Altezza;Prezzo per riga) oppure aggiungere i prezzi a mano.</div>
                  )}
                </div>
                {/* Minimi mq per tipologia */}
                <div style={{ marginBottom: 8, padding: 8, borderRadius: 8, background: T.bg, border: `1px dashed ${T.bdr}` }}>
                  <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 6 }}>Minimo mq fatturazione per tipologia</div>
                  <div style={{ fontSize: 9, color: T.sub, marginBottom: 6, fontStyle: "italic" }}>Attiva solo le categorie che vuoi ‚Äî se la finestra √® pi√π piccola, il prezzo viene calcolato sulla metratura minima</div>
                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                    {[
                      { key: "1anta", label: "1 Anta" },
                      { key: "2ante", label: "2 Ante" },
                      { key: "3ante", label: "3+ Ante" },
                      { key: "scorrevole", label: "Scorrevole" },
                      { key: "fisso", label: "Fisso" },
                    ].map(cat => {
                      const isActive = (s.minimiMq?.[cat.key] || 0) > 0;
                      return (
                        <div key={cat.key} style={{ display: "flex", alignItems: "center", gap: 4, padding: "4px 8px", borderRadius: 6, background: isActive ? T.acc + "10" : T.card, border: `1px solid ${isActive ? T.acc + "40" : T.bdr}`, opacity: isActive ? 1 : 0.6 }}>
                          <div onClick={() => {
                            if (isActive) {
                              setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, minimiMq: { ...(x.minimiMq || {}), [cat.key]: 0 } } : x));
                            } else {
                              const def = { "1anta": 1.5, "2ante": 2.0, "3ante": 2.8, "scorrevole": 3.5, "fisso": 1.0 }[cat.key] || 1.5;
                              setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, minimiMq: { ...(x.minimiMq || {}), [cat.key]: def } } : x));
                            }
                          }} style={{ width: 18, height: 18, borderRadius: 4, border: `2px solid ${isActive ? T.acc : T.bdr}`, background: isActive ? T.acc : "transparent", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 10, color: "#fff", fontWeight: 900, flexShrink: 0 }}>
                            {isActive && "‚úì"}
                          </div>
                          <span style={{ fontSize: 10, fontWeight: 600, color: T.text, minWidth: 52 }}>{cat.label}</span>
                          {isActive && (
                            <>
                              <input type="number" step="0.1" defaultValue={s.minimiMq?.[cat.key] || ""} onBlur={e => {
                                const val = parseFloat(e.target.value) || 0;
                                setSistemiDB(prev => prev.map(x => x.id === s.id ? { ...x, minimiMq: { ...(x.minimiMq || {}), [cat.key]: val } } : x));
                              }} style={{ width: 45, padding: "2px 4px", borderRadius: 4, border: `1px solid ${T.acc}40`, fontSize: 11, fontWeight: 700, color: T.acc, textAlign: "center", fontFamily: FM }} />
                              <span style={{ fontSize: 9, color: T.sub }}>mq</span>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
                {s.sottosistemi && (
                  <div style={{ marginBottom: 6 }}>
                    <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 3 }}>Sottosistemi</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {s.sottosistemi.map(ss => <span key={ss} style={S.badge(T.blueLt, T.blue)}>{ss}</span>)}
                    </div>
                  </div>
                )}
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 3 }}>Colori disponibili</div>
                <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                  {s.colori.map(c => {
                    const col = coloriDB.find(x => x.code === c);
                    return <span key={c} style={{ padding: "2px 8px", borderRadius: 4, fontSize: 10, fontWeight: 600, background: col?.hex + "20", color: T.text, border: `1px solid ${col?.hex || T.bdr}40` }}>{col?.hex && <span style={{ display: "inline-block", width: 8, height: 8, borderRadius: "50%", background: col.hex, marginRight: 4, verticalAlign: "middle" }} />}{c}</span>;
                  })}
                </div>
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("sistema"); setSettingsForm({ marca: "", sistema: "", euroMq: "", sovRAL: "", sovLegno: "", sottosistemi: "" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>+ Aggiungi sistema</div>
          </>
        )}

        {/* === COLORI === */}
        {settingsTab === "colori" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Colori disponibili ‚Äî collegati ai sistemi</div>
            {coloriDB.map(c => (
              <div key={c.id} style={{ ...S.card, marginBottom: 6 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", gap: 10 }}>
                <div style={{ width: 28, height: 28, borderRadius: 6, background: c.hex, border: `1px solid ${T.bdr}`, flexShrink: 0 }} />
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, fontWeight: 600 }}>{c.nome}</div>
                  <div style={{ fontSize: 10, color: T.sub }}>{c.code} ¬∑ {c.tipo}</div>
                </div>
                <div style={{ fontSize: 10, color: T.sub }}>{sistemiDB.filter(s => s.colori.includes(c.code)).map(s => s.marca).join(", ") || "‚Äî"}</div>
                <div onClick={() => deleteSettingsItem("colore", c.id)} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("colore"); setSettingsForm({ nome: "", code: "", hex: "#888888", tipo: "RAL" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>+ Aggiungi colore</div>
          </>
        )}

        {/* === VETRI === */}
        {settingsTab === "vetri" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Tipologie vetro disponibili per i vani</div>
            {vetriDB.map(g => (
              <div key={g.id} style={{ ...S.card, marginBottom: 6 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <div>
                  <div style={{ fontSize: 13, fontWeight: 700 }}>{g.nome}</div>
                  <div style={{ fontSize: 11, color: T.sub, fontFamily: FM }}>{g.code}</div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ padding: "3px 8px", borderRadius: 6, background: g.ug <= 0.7 ? T.grnLt : g.ug <= 1.0 ? T.orangeLt : T.redLt, fontSize: 12, fontWeight: 700, fontFamily: FM, color: g.ug <= 0.7 ? T.grn : g.ug <= 1.0 ? T.orange : T.red }}>Ug={g.ug}</span>
                  <div onClick={() => deleteSettingsItem("vetro", g.id)} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
                </div>
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("vetro"); setSettingsForm({ nome: "", code: "", ug: "" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>+ Aggiungi vetro</div>
          </>
        )}

        {/* === TIPOLOGIE === */}
        {settingsTab === "tipologie" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Tipologie serramento ‚Äî trascina ‚≠ê per i preferiti</div>
            {TIPOLOGIE_RAPIDE.map(t => {
              const isFav = favTipologie.includes(t.code);
              return (
                <div key={t.code} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", gap: 8, padding: "8px 14px" }}>
                  <div onClick={() => setFavTipologie(fav => isFav ? fav.filter(f => f !== t.code) : [...fav, t.code])} style={{ cursor: "pointer" }}>
                    <span style={{ fontSize: 16, color: isFav ? "#ff9500" : T.bdr }}>{isFav ? "‚≠ê" : "‚òÜ"}</span>
                  </div>
                  <span style={{ fontSize: 16 }}>{t.icon}</span>
                  <div style={{ flex: 1 }}>
                    <span style={{ fontSize: 12, fontWeight: 700, fontFamily: FM }}>{t.code}</span>
                    <span style={{ fontSize: 11, color: T.sub, marginLeft: 6 }}>{t.label}</span>
                    {t.forma && t.forma !== "rettangolare" && <span style={{ fontSize: 9, color: T.acc, marginLeft: 6, background: T.accLt, padding: "1px 5px", borderRadius: 4 }}>{t.forma}</span>}
                  </div>
                  <Ico d={ICO.pen} s={14} c={T.sub} />
                </div></div>
              );
            })}
            <div onClick={() => { setSettingsModal("tipologia"); setSettingsForm({ code: "", label: "", icon: "ü™ü", cat: "Altro", forma: "rettangolare" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi tipologia</div>
          </>
        )}

        {/* === COPRIFILI === */}
        {settingsTab === "coprifili" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Lista coprifili disponibili nella creazione vano</div>
            {coprifiliDB.map(c => (
              <div key={c.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <div>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: FM, color: T.acc }}>{c.cod}</span>
                  <span style={{ fontSize: 12, marginLeft: 8 }}>{c.nome}</span>
                </div>
                <div onClick={() => deleteSettingsItem("coprifilo", c.id)} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("coprifilo"); setSettingsForm({ nome: "", cod: "" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi coprifilo</div>
          </>
        )}

        {/* === LAMIERE === */}
        {settingsTab === "lamiere" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Lista lamiere e scossaline</div>
            {lamiereDB.map(l => (
              <div key={l.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <div>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: FM, color: T.orange }}>{l.cod}</span>
                  <span style={{ fontSize: 12, marginLeft: 8 }}>{l.nome}</span>
                </div>
                <div onClick={() => deleteSettingsItem("lamiera", l.id)} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { setSettingsModal("lamiera"); setSettingsForm({ nome: "", cod: "" }); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi lamiera</div>
          </>
        )}

        {/* === SALITA === */}
        {settingsTab === "tapparella" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 12 }}>Configura le opzioni per le tapparelle</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìè Tipo Misura Tapparella</div>
            {tipoMisuraTappDB.map(tm => (
              <div key={tm.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{tm.code}</span>
                <div onClick={() => setTipoMisuraTappDB(prev => prev.filter(x => x.id !== tm.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo tipo misura tapparella:");}catch(e){} if (n?.trim()) setTipoMisuraTappDB(prev => [...prev, { id: "tmt" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi tipo misura</div>
          </>
        )}

        {settingsTab === "zanzariera" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 12 }}>Configura le opzioni per le zanzariere</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìè Tipo Misura Zanzariera</div>
            {tipoMisuraZanzDB.map(tm => (
              <div key={tm.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{tm.code}</span>
                <div onClick={() => setTipoMisuraZanzDB(prev => prev.filter(x => x.id !== tm.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo tipo misura zanzariera:");}catch(e){} if (n?.trim()) setTipoMisuraZanzDB(prev => [...prev, { id: "tmz" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi tipo misura</div>
          </>
        )}

        {settingsTab === "persiana" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 12 }}>Configura le opzioni per le persiane</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üîß Tipologia Telaio</div>
            {telaiPersianaDB.map(tp => (
              <div key={tp.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{tp.code}</span>
                <div onClick={() => setTelaiPersianaDB(prev => prev.filter(x => x.id !== tp.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuova tipologia telaio (es. Z 35):");}catch(e){} if (n?.trim()) setTelaiPersianaDB(prev => [...prev, { id: "tp" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4, marginBottom: 16 }}>+ Aggiungi telaio</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìê 4¬∞ Lato / Posizionamento</div>
            {posPersianaDB.map(pp => (
              <div key={pp.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{pp.code}</span>
                <div onClick={() => setPosPersianaDB(prev => prev.filter(x => x.id !== pp.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo posizionamento (es. A muro):");}catch(e){} if (n?.trim()) setPosPersianaDB(prev => [...prev, { id: "pp" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi posizionamento</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginTop: 16, marginBottom: 8 }}>üìè Tipo Misura</div>
            {tipoMisuraDB.map(tm => (
              <div key={tm.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{tm.code}</span>
                <div onClick={() => setTipoMisuraDB(prev => prev.filter(x => x.id !== tm.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo tipo misura (es. Luce netta):");}catch(e){} if (n?.trim()) setTipoMisuraDB(prev => [...prev, { id: "tm" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi tipo misura</div>
          </>
        )}

        {/* === SALITA === */}
        {settingsTab === "controtelaio" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 12 }}>Configura profondit√†, sezioni e modelli cielino per i controtelai</div>
            
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìè Profondit√† disponibili (mm)</div>
            <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:8}}>
              {ctProfDB.map(p => (
                <div key={p.id} style={{display:"flex",alignItems:"center",gap:4,padding:"6px 10px",borderRadius:8,border:`1px solid ${T.bdr}`,background:T.card}}>
                  <span style={{fontSize:12,fontWeight:600}}>{p.code}</span>
                  <div onClick={() => setCtProfDB(prev => prev.filter(x => x.id !== p.id))} style={{ cursor: "pointer", fontSize: 10, color: T.sub }}>‚úï</div>
                </div>
              ))}
            </div>
            <div onClick={() => { let n; try{n=window.prompt("Nuova profondit√† (mm):");}catch(e){} if (n?.trim()) setCtProfDB(prev => [...prev, { id: "cp" + Date.now(), code: n.trim() }]); }} style={{ padding: "10px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 11, fontWeight: 600, marginBottom: 16 }}>+ Aggiungi profondit√†</div>

            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üìê Sezioni controtelaio</div>
            {ctSezioniDB.map(s => (
              <div key={s.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{s.code}</span>
                <div onClick={() => setCtSezioniDB(prev => prev.filter(x => x.id !== s.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuova sezione (es. 56√ó40):");}catch(e){} if (n?.trim()) setCtSezioniDB(prev => [...prev, { id: "cs" + Date.now(), code: n.trim() }]); }} style={{ padding: "10px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 11, fontWeight: 600, marginBottom: 16 }}>+ Aggiungi sezione</div>

            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üî≤ Modelli cielino</div>
            {ctCieliniDB.map(c => (
              <div key={c.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{c.code}</span>
                <div onClick={() => setCtCieliniDB(prev => prev.filter(x => x.id !== c.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo modello cielino:");}catch(e){} if (n?.trim()) setCtCieliniDB(prev => [...prev, { id: "cc" + Date.now(), code: n.trim() }]); }} style={{ padding: "10px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 11, fontWeight: 600, marginBottom: 16 }}>+ Aggiungi cielino</div>

            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>‚ö° Offset calcolo infisso</div>
            <div style={{ fontSize: 10, color: T.sub, marginBottom: 6 }}>Millimetri da sottrarre per lato (L e H) quando si calcola l'infisso dal controtelaio</div>
            <div style={{display:"flex",alignItems:"center",gap:8}}>
              <input style={{...S.input,width:80,textAlign:"center",fontSize:16,fontWeight:700}} type="number" inputMode="numeric" value={ctOffset} onChange={e=>setCtOffset(parseInt(e.target.value)||0)} />
              <span style={{fontSize:12,color:T.sub}}>mm/lato ‚Üí totale ‚àí{ctOffset*2}mm</span>
            </div>
          </>
        )}

        {settingsTab === "cassonetto" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 12 }}>Configura i tipi di cassonetto disponibili</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: T.text, marginBottom: 8 }}>üßä Tipo Cassonetto</div>
            {tipoCassonettoDB.map(tc => (
              <div key={tc.id} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <span style={{ fontSize: 13, fontWeight: 600 }}>{tc.code}</span>
                <div onClick={() => setTipoCassonettoDB(prev => prev.filter(x => x.id !== tc.id))} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nuovo tipo cassonetto:");}catch(e){} if (n?.trim()) setTipoCassonettoDB(prev => [...prev, { id: "tc" + Date.now(), code: n.trim() }]); }} style={{ padding: "12px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi tipo cassonetto</div>
          </>
        )}

        {settingsTab === "salita" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Configura i mezzi di salita disponibili</div>
            {mezziSalita.map((m, i) => (
              <div key={i} style={{ ...S.card, marginBottom: 4 }}><div style={{ ...S.cardInner, display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 14px" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16 }}>ü™ú</span>
                  <span style={{ fontSize: 13, fontWeight: 600 }}>{m}</span>
                </div>
                <div onClick={() => { if ((()=>{try{return window.confirm(`Eliminare "${m}"?`);}catch(e){return false;}})()) setMezziSalita(ms => ms.filter((_, j) => j !== i)); }} style={{ cursor: "pointer" }}><Ico d={ICO.trash} s={14} c={T.sub} /></div>
              </div></div>
            ))}
            <div onClick={() => { let n; try{n=window.prompt("Nome mezzo di salita:");}catch(e){} if (n?.trim()) setMezziSalita(ms => [...ms, n.trim()]); }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600, marginTop: 4 }}>+ Aggiungi mezzo salita</div>
          </>
        )}

        {/* === PIPELINE === */}
        {/* === LIBRERIA PRODOTTI === */}
        {settingsTab === "libreria" && (
          <>
            <div style={{ fontSize: 11, color: T.sub, marginBottom: 8 }}>Crea una libreria di prodotti/servizi da usare nelle Voci libere dei vani. Clicca sui campi per modificarli.</div>
            {libreriaDB.map(item => (
              <div key={item.id} style={{ ...S.card, marginBottom: 8 }}><div style={{ ...S.cardInner }}>
                <div style={{ display: "flex", gap: 10, alignItems: "flex-start" }}>
                  {/* Foto */}
                  <div style={{ flexShrink: 0 }}>
                    {item.foto ? (
                      <div style={{ position: "relative" }}>
                        <img src={item.foto} style={{ width: 56, height: 56, objectFit: "cover", borderRadius: 8, border: `1px solid ${T.bdr}` }} alt="" />
                        <div onClick={() => setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, foto: undefined } : x))} style={{ position: "absolute", top: -4, right: -4, width: 16, height: 16, borderRadius: "50%", background: T.red, color: "#fff", fontSize: 9, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontWeight: 900 }}>‚úï</div>
                      </div>
                    ) : (
                      <label style={{ width: 56, height: 56, borderRadius: 8, background: T.bg, border: `1px dashed ${T.bdr}`, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", cursor: "pointer", gap: 2 }}>
                        <span style={{ fontSize: 18 }}>üì∑</span>
                        <span style={{ fontSize: 7, color: T.sub }}>Foto</span>
                        <input type="file" accept="image/*" style={{ display: "none" }} onChange={e => {
                          const file = e.target.files?.[0]; if (!file) return;
                          const reader = new FileReader();
                          reader.onload = ev => setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, foto: ev.target?.result as string } : x));
                          reader.readAsDataURL(file);
                        }} />
                      </label>
                    )}
                  </div>
                  {/* Campi editabili */}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <input style={{ width: "100%", padding: "4px 6px", fontSize: 13, fontWeight: 700, border: `1px solid transparent`, borderRadius: 4, background: "transparent", marginBottom: 3 }} defaultValue={item.nome || ""} placeholder="Nome prodotto..." onFocus={e => e.target.style.borderColor = T.acc} onBlur={e => { e.target.style.borderColor = "transparent"; setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, nome: e.target.value } : x)); }} />
                    <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 3 }}>
                        <span style={{ fontSize: 9, color: T.sub }}>Cat:</span>
                        <input style={{ width: 80, padding: "2px 4px", fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, background: T.bg }} defaultValue={item.categoria || ""} placeholder="Categoria" onBlur={e => setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, categoria: e.target.value } : x))} />
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 3 }}>
                        <span style={{ fontSize: 9, color: T.sub }}>‚Ç¨</span>
                        <input type="number" step="0.01" style={{ width: 60, padding: "2px 4px", fontSize: 12, fontWeight: 700, fontFamily: FM, color: T.grn, border: `1px solid ${T.bdr}`, borderRadius: 4, textAlign: "right" }} defaultValue={item.prezzo || 0} onBlur={e => setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, prezzo: parseFloat(e.target.value) || 0 } : x))} />
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 3 }}>
                        <span style={{ fontSize: 9, color: T.sub }}>/</span>
                        <select style={{ padding: "2px 4px", fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, background: T.bg }} value={item.unita || "pz"} onChange={e => setLibreriaDB(prev => prev.map(x => x.id === item.id ? { ...x, unita: e.target.value } : x))}>
                          <option value="pz">Pezzo</option>
                          <option value="mq">mq</option>
                          <option value="ml">ml</option>
                          <option value="kg">kg</option>
                          <option value="forfait">Forfait</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  {/* Delete */}
                  <div onClick={() => setLibreriaDB(prev => prev.filter(x => x.id !== item.id))} style={{ padding: "6px", cursor: "pointer", color: T.sub, fontSize: 12, flexShrink: 0 }}>üóë</div>
                </div>
              </div></div>
            ))}
            <div onClick={() => {
              setLibreriaDB(prev => [...prev, { id: Date.now(), nome: "", categoria: "", prezzo: 0, unita: "pz" }]);
            }} style={{ padding: "14px", borderRadius: T.r, border: `1px dashed ${T.acc}`, textAlign: "center", cursor: "pointer", color: T.acc, fontSize: 12, fontWeight: 600 }}>+ Aggiungi prodotto alla libreria</div>
          </>
        )}

        {/* === SQUADRE MONTAGGIO === */}
        {settingsTab === "squadre" && (
          <>
            <div style={{ fontSize: 12, color: T.sub, padding: "0 4px 10px", lineHeight: 1.5 }}>Configura le squadre di montaggio. Ogni squadra ha un nome, membri e colore.</div>
            {squadreDB.map((sq, i) => (
              <div key={sq.id} style={{ background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: 12, marginBottom: 8 }}>
                <div style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 8 }}>
                  <input type="color" value={sq.colore} onChange={e => setSquadreDB(prev => prev.map((s, j) => j === i ? { ...s, colore: e.target.value } : s))} style={{ width: 32, height: 32, border: "none", borderRadius: 6, cursor: "pointer" }} />
                  <input style={{ ...S.input, flex: 1, fontSize: 14, fontWeight: 700 }} value={sq.nome} onChange={e => setSquadreDB(prev => prev.map((s, j) => j === i ? { ...s, nome: e.target.value } : s))} />
                  <div onClick={() => setSquadreDB(prev => prev.filter((_, j) => j !== i))} style={{ fontSize: 16, cursor: "pointer", color: T.red }}>üóë</div>
                </div>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, marginBottom: 3 }}>MEMBRI (uno per riga)</div>
                <textarea style={{ ...S.input, width: "100%", minHeight: 50, fontSize: 11, boxSizing: "border-box" }} value={sq.membri.join("\n")} onChange={e => setSquadreDB(prev => prev.map((s, j) => j === i ? { ...s, membri: e.target.value.split("\n").filter(x => x.trim()) } : s))} />
                <div style={{ fontSize: 9, color: T.sub, marginTop: 4 }}>Montaggi assegnati: {montaggiDB.filter(m => m.squadraId === sq.id).length}</div>
              </div>
            ))}
            <button onClick={() => setSquadreDB(prev => [...prev, { id: "sq" + Date.now(), nome: "Nuova Squadra", membri: [], colore: "#ff9500" }])} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1.5px dashed ${T.bdr}`, background: "transparent", color: T.acc, fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Aggiungi squadra</button>
          </>
        )}

        {/* === FATTURE EMESSE === */}
        {settingsTab === "fatture" && (
          <>
            <div style={{ fontSize: 12, color: T.sub, padding: "0 4px 10px", lineHeight: 1.5 }}>Elenco fatture emesse. Puoi segnare le fatture come pagate o ristampare il PDF.</div>
            {fattureDB.length === 0 ? (
              <div style={{ textAlign: "center", padding: 24, color: T.sub }}>Nessuna fattura emessa. Crea fatture dalla scheda preventivo di una commessa.</div>
            ) : (
              <>
                {/* Riepilogo */}
                <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
                  <div style={{ flex: 1, background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: 10, textAlign: "center" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase" }}>Totale emesso</div>
                    <div style={{ fontSize: 16, fontWeight: 900, color: T.text }}>‚Ç¨{fattureDB.reduce((s, f) => s + f.importo, 0).toLocaleString("it-IT")}</div>
                  </div>
                  <div style={{ flex: 1, background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: 10, textAlign: "center" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase" }}>Incassato</div>
                    <div style={{ fontSize: 16, fontWeight: 900, color: "#34c759" }}>‚Ç¨{fattureDB.filter(f => f.pagata).reduce((s, f) => s + f.importo, 0).toLocaleString("it-IT")}</div>
                  </div>
                  <div style={{ flex: 1, background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, padding: 10, textAlign: "center" }}>
                    <div style={{ fontSize: 8, color: T.sub, textTransform: "uppercase" }}>Da incassare</div>
                    <div style={{ fontSize: 16, fontWeight: 900, color: "#ff3b30" }}>‚Ç¨{fattureDB.filter(f => !f.pagata).reduce((s, f) => s + f.importo, 0).toLocaleString("it-IT")}</div>
                  </div>
                </div>
                {fattureDB.sort((a, b) => b.numero - a.numero).map(f => (
                  <div key={f.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 12px", background: T.card, borderRadius: T.r, border: `1px solid ${T.bdr}`, marginBottom: 6 }}>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700 }}>N. {f.numero}/{f.anno} ‚Äî {f.tipo.toUpperCase()}</div>
                      <div style={{ fontSize: 10, color: T.sub }}>{f.cliente} ¬∑ {f.cmCode} ¬∑ {f.data}</div>
                      <div style={{ fontSize: 9, color: f.pagata ? "#34c759" : (f.scadenza < new Date().toISOString().split("T")[0] ? "#ff3b30" : T.sub) }}>
                        {f.pagata ? `‚úÖ Pagata il ${f.dataPagamento}` : `‚è≥ Scadenza: ${f.scadenza}`}
                      </div>
                    </div>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <div style={{ fontSize: 14, fontWeight: 900, color: T.text }}>‚Ç¨{f.importo.toLocaleString("it-IT")}</div>
                      <div onClick={() => setFattureDB(prev => prev.map(x => x.id === f.id ? { ...x, pagata: !x.pagata, dataPagamento: !x.pagata ? new Date().toLocaleDateString("it-IT") : null } : x))} style={{ padding: "4px 8px", borderRadius: 6, background: f.pagata ? "#34c75920" : "#ff3b3020", color: f.pagata ? "#34c759" : "#ff3b30", fontSize: 9, fontWeight: 700, cursor: "pointer" }}>
                        {f.pagata ? "‚úÖ" : "üí∞"}
                      </div>
                      <div onClick={() => generaFatturaPDF(f)} style={{ fontSize: 16, cursor: "pointer" }}>üìÑ</div>
                      <div onClick={() => setFattureDB(prev => prev.filter(x => x.id !== f.id))} style={{ fontSize: 14, cursor: "pointer", color: T.red }}>üóë</div>
                    </div>
                  </div>
                ))}
              </>
            )}
          </>
        )}

        {settingsTab === "pipeline" && (
          <>
            <div style={{fontSize:12,color:T.sub,padding:"0 4px 10px",lineHeight:1.5}}>Personalizza il flusso di lavoro. Ogni fase controlla <b style={{color:T.acc}}>ERP + Messaggi + Montaggi</b> automaticamente.</div>
            
            {/* LEGENDA ECOSISTEMA */}
            <div style={{display:"flex",gap:6,marginBottom:12,flexWrap:"wrap"}}>
              {[{e:"üìã",l:"ERP",c:"#007aff"},{e:"üìß",l:"Messaggi",c:"#34c759"},{e:"üîß",l:"Montaggi",c:"#ff9500"},{e:"‚ö°",l:"Automazioni",c:"#af52de"}].map(b=>(
                <div key={b.l} style={{display:"flex",alignItems:"center",gap:4,padding:"4px 10px",borderRadius:20,background:b.c+"15",border:`1px solid ${b.c}30`}}>
                  <span style={{fontSize:10}}>{b.e}</span><span style={{fontSize:10,fontWeight:700,color:b.c}}>{b.l}</span>
                </div>
              ))}
            </div>
        
            {pipelineDB.map((p, i) => {
              const isExp = expandedPipelinePhase === p.id;
              const pTab = pipelinePhaseTab || "email";
              return (
              <div key={p.id} style={{marginBottom:8, opacity: p.attiva===false ? 0.45 : 1}}>
                <div style={{...S.card, marginBottom:0, borderRadius: isExp ? "10px 10px 0 0" : undefined}}>
                  <div onClick={()=>{setExpandedPipelinePhase(isExp?null:p.id);setPipelinePhaseTab("email");}} style={{display:"flex", alignItems:"center", gap:8, padding:"10px 12px", cursor:"pointer"}}>
                    <div style={{display:"flex",flexDirection:"column",gap:1}}>
                      <div onClick={(e)=>{e.stopPropagation(); if(i===0) return; const a=[...pipelineDB]; [a[i-1],a[i]]=[a[i],a[i-1]]; setPipelineDB(a); }} style={{fontSize:10,cursor:i===0?"default":"pointer",color:i===0?T.bdr:T.sub,lineHeight:1}}>‚ñ≤</div>
                      <div onClick={(e)=>{e.stopPropagation(); if(i===pipelineDB.length-1) return; const a=[...pipelineDB]; [a[i],a[i+1]]=[a[i+1],a[i]]; setPipelineDB(a); }} style={{fontSize:10,cursor:i===pipelineDB.length-1?"default":"pointer",color:i===pipelineDB.length-1?T.bdr:T.sub,lineHeight:1}}>‚ñº</div>
                    </div>
                    <span style={{fontSize:20,flexShrink:0}}>{p.ico}</span>
                    <input value={p.nome} onChange={e=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,nome:e.target.value}:x))}
                      onClick={(e)=>e.stopPropagation()} style={{flex:1,border:"none",background:"transparent",fontSize:13,fontWeight:700,color:T.text,fontFamily:FF,outline:"none",padding:0}}/>
                    <div onClick={(e)=>{e.stopPropagation();setExpandedPipelinePhase(isExp?null:p.id);setPipelinePhaseTab("email");}} style={{width:30,height:30,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",background:isExp?T.acc+"18":"#f0f0f0",cursor:"pointer",flexShrink:0,marginLeft:4}}><span style={{fontSize:12,color:isExp?T.acc:"#999",transform:isExp?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s"}}>‚ñæ</span></div><div style={{width:12,height:12,borderRadius:"50%",background:p.color,flexShrink:0}}/>
                    <div onClick={(e)=>{e.stopPropagation(); if(p.id==="chiusura") return; setPipelineDB(db=>db.map((x,j)=>j===i?{...x,attiva:x.attiva===false?true:false}:x)); }}
                      style={{width:36,height:20,borderRadius:10,background:p.attiva===false?T.bdr:T.grn,cursor:p.id==="chiusura"?"default":"pointer",transition:"background 0.2s",position:"relative",flexShrink:0}}>
                      <div style={{position:"absolute",top:2,left:p.attiva===false?2:18,width:16,height:16,borderRadius:"50%",background:"#fff",transition:"left 0.2s"}}/>
                    </div>
                    {p.custom && <div onClick={(e)=>{e.stopPropagation();setPipelineDB(db=>db.filter((_,j)=>j!==i));}} style={{fontSize:12,cursor:"pointer",color:T.red}}>‚úï</div>}
                    
                  </div>
                  {!isExp && (p.emailTemplate || (p.checklistMontaggio||[]).length>0 || (p.automazioni||[]).length>0) && (
                    <div style={{display:"flex",gap:4,padding:"0 12px 8px",flexWrap:"wrap"}}>
                      {p.emailTemplate && <span style={{fontSize:8,padding:"2px 6px",borderRadius:10,background:"#34c75915",color:"#34c759",fontWeight:700}}>üìß Email</span>}
                      {(p.checklistMontaggio||[]).length>0 && <span style={{fontSize:8,padding:"2px 6px",borderRadius:10,background:"#ff950015",color:"#ff9500",fontWeight:700}}>‚úÖ {p.checklistMontaggio.length} check</span>}
                      {(p.automazioni||[]).length>0 && <span style={{fontSize:8,padding:"2px 6px",borderRadius:10,background:"#af52de15",color:"#af52de",fontWeight:700}}>‚ö° {p.automazioni.length} auto</span>}
                    </div>
                  )}
                </div>
        
                {isExp && (
                  <div style={{background:T.card,border:`1px solid ${T.bdr}`,borderTop:"none",borderRadius:"0 0 10px 10px",overflow:"hidden"}}>
                    <div style={{display:"flex",borderBottom:`1px solid ${T.bdr}`}}>
                      {[{id:"email",l:"üìß Email",c:"#34c759"},{id:"checklist",l:"‚úÖ Checklist",c:"#ff9500"},{id:"auto",l:"‚ö° Auto",c:"#af52de"},{id:"gate",l:"üö™ Gate",c:"#007aff"}].map(tab=>(
                        <div key={tab.id} onClick={()=>setPipelinePhaseTab(tab.id)}
                          style={{flex:1,padding:"8px 4px",textAlign:"center",fontSize:10,fontWeight:700,cursor:"pointer",
                            color:pTab===tab.id?tab.c:T.sub,borderBottom:pTab===tab.id?`2px solid ${tab.c}`:"2px solid transparent",
                            background:pTab===tab.id?tab.c+"08":"transparent"}}>{tab.l}</div>
                      ))}
                    </div>
                    <div style={{padding:12}}>
        
                      {/* EMAIL TAB */}
                      {pTab==="email" && (<div>
                        <div style={{fontSize:11,color:T.sub,marginBottom:8}}>Template email automatica quando la commessa entra in questa fase.</div>
                        <div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:4}}>OGGETTO</div>
                        <input value={p.emailTemplate?.oggetto||""} placeholder={`es: Conferma ${p.nome} - ${"{{"}cliente${"}}"}  `}
                          onChange={e=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,emailTemplate:{...(x.emailTemplate||{}),oggetto:e.target.value}}:x))}
                          style={{...S.input,width:"100%",fontSize:12,marginBottom:8,boxSizing:"border-box"}} />
                        <div style={{fontSize:9,fontWeight:700,color:T.sub,marginBottom:4}}>CORPO</div>
                        <textarea value={p.emailTemplate?.corpo||""} placeholder="Gentile cliente,..."
                          onChange={e=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,emailTemplate:{...(x.emailTemplate||{}),corpo:e.target.value}}:x))}
                          style={{...S.input,width:"100%",minHeight:80,fontSize:11,lineHeight:1.5,boxSizing:"border-box",resize:"vertical"}} />
                        <div style={{display:"flex",gap:8,marginTop:8,alignItems:"center",flexWrap:"wrap"}}>
                          <div style={{display:"flex",alignItems:"center",gap:4}}>
                            <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,emailTemplate:{...(x.emailTemplate||{}),attiva:!(x.emailTemplate?.attiva)}}:x))}
                              style={{width:32,height:18,borderRadius:9,background:p.emailTemplate?.attiva?T.grn:T.bdr,cursor:"pointer",position:"relative"}}>
                              <div style={{position:"absolute",top:2,left:p.emailTemplate?.attiva?16:2,width:14,height:14,borderRadius:"50%",background:"#fff",transition:"left 0.2s"}}/>
                            </div>
                            <span style={{fontSize:10,color:p.emailTemplate?.attiva?"#34c759":T.sub,fontWeight:600}}>Invio auto</span>
                          </div>
                          <select value={p.emailTemplate?.destinatario||"cliente"}
                            onChange={e=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,emailTemplate:{...(x.emailTemplate||{}),destinatario:e.target.value}}:x))}
                            style={{...S.input,fontSize:10,padding:"3px 6px"}}>
                            <option value="cliente">Al cliente</option>
                            <option value="team">Al team</option>
                            <option value="entrambi">Entrambi</option>
                          </select>
                        </div>
                      </div>)}
        
                      {/* CHECKLIST TAB */}
                      {pTab==="checklist" && (<div>
                        <div style={{fontSize:11,color:T.sub,marginBottom:8}}>Checklist per montatori. Visibile in MASTRO MONTAGGI.</div>
                        {(p.checklistMontaggio||[]).map((item,ci)=>(
                          <div key={ci} style={{display:"flex",gap:6,alignItems:"center",marginBottom:6}}>
                            <span style={{fontSize:11,color:T.sub,width:18,textAlign:"center"}}>{ci+1}.</span>
                            <input value={item} onChange={e=>{const nl=[...(p.checklistMontaggio||[])];nl[ci]=e.target.value;setPipelineDB(db=>db.map((x,j)=>j===i?{...x,checklistMontaggio:nl}:x));}}
                              style={{...S.input,flex:1,fontSize:11,boxSizing:"border-box"}} placeholder="es: Verificare dimensioni vano..." />
                            <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,checklistMontaggio:(x.checklistMontaggio||[]).filter((_,k)=>k!==ci)}:x))} style={{fontSize:12,cursor:"pointer",color:T.red}}>‚úï</div>
                          </div>
                        ))}
                        <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,checklistMontaggio:[...(x.checklistMontaggio||[]),""]}:x))}
                          style={{padding:"8px",borderRadius:8,border:`1px dashed ${T.acc}`,textAlign:"center",cursor:"pointer",color:T.acc,fontSize:11,fontWeight:600}}>+ Aggiungi voce</div>
                        {(p.checklistMontaggio||[]).length>0 && (
                          <div style={{display:"flex",alignItems:"center",gap:4,marginTop:8}}>
                            <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,checklistObbligatoria:!x.checklistObbligatoria}:x))}
                              style={{width:32,height:18,borderRadius:9,background:p.checklistObbligatoria?T.grn:T.bdr,cursor:"pointer",position:"relative"}}>
                              <div style={{position:"absolute",top:2,left:p.checklistObbligatoria?16:2,width:14,height:14,borderRadius:"50%",background:"#fff",transition:"left 0.2s"}}/>
                            </div>
                            <span style={{fontSize:10,color:p.checklistObbligatoria?"#34c759":T.sub,fontWeight:600}}>Obbligatoria (blocca avanzamento)</span>
                          </div>
                        )}
                      </div>)}
        
                      {/* AUTOMAZIONI TAB */}
                      {pTab==="auto" && (<div>
                        <div style={{fontSize:11,color:T.sub,marginBottom:8}}>Azioni automatiche all'ingresso in questa fase.</div>
                        {(p.automazioni||[]).map((auto,ai)=>(
                          <div key={ai} style={{display:"flex",gap:6,alignItems:"center",marginBottom:6,background:T.bg,borderRadius:8,padding:"6px 8px"}}>
                            <select value={auto.tipo} onChange={e=>{const na=[...(p.automazioni||[])];na[ai]={...na[ai],tipo:e.target.value};setPipelineDB(db=>db.map((x,j)=>j===i?{...x,automazioni:na}:x));}}
                              style={{...S.input,fontSize:10,padding:"3px 6px",flex:1}}>
                              <option value="notifica_team">Notifica team</option>
                              <option value="notifica_cliente">Notifica cliente</option>
                              <option value="assegna_squadra">Assegna squadra</option>
                              <option value="crea_task">Crea task</option>
                              <option value="genera_pdf">Genera PDF</option>
                              <option value="verifica_magazzino">Verifica magazzino</option>
                              <option value="prenota_consegna">Prenota consegna</option>
                              <option value="richiedi_acconto">Richiedi acconto</option>
                              <option value="invia_enea">Pratica ENEA</option>
                              <option value="follow_up">Follow-up</option>
                            </select>
                            <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,automazioni:(x.automazioni||[]).filter((_,k)=>k!==ai)}:x))} style={{fontSize:12,cursor:"pointer",color:T.red}}>‚úï</div>
                          </div>
                        ))}
                        <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,automazioni:[...(x.automazioni||[]),{tipo:"notifica_team",attiva:true}]}:x))}
                          style={{padding:"8px",borderRadius:8,border:`1px dashed ${T.acc}`,textAlign:"center",cursor:"pointer",color:T.acc,fontSize:11,fontWeight:600}}>+ Aggiungi automazione</div>
                      </div>)}
        
                      {/* GATE TAB */}
                      {pTab==="gate" && (<div>
                        <div style={{fontSize:11,color:T.sub,marginBottom:8}}>Requisiti per avanzare a questa fase.</div>
                        {(p.gateRequisiti||[]).map((req,ri)=>(
                          <div key={ri} style={{display:"flex",gap:6,alignItems:"center",marginBottom:6}}>
                            <select value={req.tipo} onChange={e=>{const nr=[...(p.gateRequisiti||[])];nr[ri]={...nr[ri],tipo:e.target.value};setPipelineDB(db=>db.map((x,j)=>j===i?{...x,gateRequisiti:nr}:x));}}
                              style={{...S.input,fontSize:10,padding:"3px 6px",flex:1}}>
                              <option value="preventivo_approvato">Preventivo approvato</option>
                              <option value="acconto_ricevuto">Acconto ricevuto</option>
                              <option value="misure_confermate">Misure confermate</option>
                              <option value="materiali_ordinati">Materiali ordinati</option>
                              <option value="materiali_arrivati">Materiali arrivati</option>
                              <option value="squadra_assegnata">Squadra assegnata</option>
                              <option value="data_montaggio">Data montaggio fissata</option>
                              <option value="documenti_ok">Documenti completi</option>
                              <option value="checklist_completa">Checklist completata</option>
                              <option value="firma_cliente">Firma cliente</option>
                            </select>
                            <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,gateRequisiti:(x.gateRequisiti||[]).filter((_,k)=>k!==ri)}:x))} style={{fontSize:12,cursor:"pointer",color:T.red}}>‚úï</div>
                          </div>
                        ))}
                        <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,gateRequisiti:[...(x.gateRequisiti||[]),{tipo:"preventivo_approvato"}]}:x))}
                          style={{padding:"8px",borderRadius:8,border:`1px dashed ${T.acc}`,textAlign:"center",cursor:"pointer",color:T.acc,fontSize:11,fontWeight:600}}>+ Aggiungi requisito</div>
                        <div style={{display:"flex",alignItems:"center",gap:4,marginTop:8}}>
                          <div onClick={()=>setPipelineDB(db=>db.map((x,j)=>j===i?{...x,gateBloccante:!x.gateBloccante}:x))}
                            style={{width:32,height:18,borderRadius:9,background:p.gateBloccante?"#ff3b30":T.bdr,cursor:"pointer",position:"relative"}}>
                            <div style={{position:"absolute",top:2,left:p.gateBloccante?16:2,width:14,height:14,borderRadius:"50%",background:"#fff",transition:"left 0.2s"}}/>
                          </div>
                          <span style={{fontSize:10,color:p.gateBloccante?"#ff3b30":T.sub,fontWeight:600}}>Gate bloccante</span>
                        </div>
                      </div>)}
        
                    </div>
                  </div>
                )}
              </div>
              );
            })}
        
            <div onClick={()=>{ let nome; try{nome=window.prompt("Nome nuova fase:");}catch(e){} if(nome?.trim()) setPipelineDB(db=>[...db.slice(0,-1),{id:"custom_"+Date.now(),nome:nome.trim(),ico:"‚≠ê",color:"#8e8e93",attiva:true,custom:true},...db.slice(-1)]); }}
              style={{...S.card,marginTop:4,textAlign:"center",padding:"10px",cursor:"pointer",color:T.acc,fontSize:13,fontWeight:700}}>+ Aggiungi fase personalizzata</div>
            <div onClick={()=>{ if(!confirm("ATTENZIONE: Sei sicuro di voler ripristinare tutti i dati?")) return; if(!confirm("ULTIMA CONFERMA: Tutti i dati torneranno ai dati demo. Confermi?")) return; localStorage.removeItem("mastro_erp_data"); if((()=>{try{return window.confirm("Ripristinare le fasi predefinite?");}catch(e){return false;}})())setPipelineDB(PIPELINE_DEFAULT);}}
              style={{textAlign:"center",padding:"10px 0 4px",fontSize:11,color:T.sub,cursor:"pointer"}}>Ripristina predefinita</div>
          </>
        )}

        {/* === GUIDA === */}
        {/* === IMPORTA CATALOGO === */}
        {settingsTab === "importa" && (
          <>
            <div style={{background:T.card,borderRadius:12,overflow:"hidden",border:`1px solid ${T.bdr}`,marginBottom:12}}>
              <div style={{padding:"16px",borderBottom:`1px solid ${T.bdr}`,background:T.accLt}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:8}}>
                  <span style={{fontSize:24}}>üì•</span>
                  <div>
                    <div style={{fontSize:14,fontWeight:800,color:T.text}}>Importa Catalogo da Excel</div>
                    <div style={{fontSize:11,color:T.sub}}>Carica il template MASTRO compilato con i tuoi dati</div>
                  </div>
                </div>
              </div>
              <div style={{padding:"16px"}}>
                <div style={{fontSize:11,color:T.sub,lineHeight:1.5,marginBottom:14}}>
                  Scarica il template Excel, compilalo con i tuoi sistemi, colori, vetri, prezzi e tutto il catalogo. Poi caricalo qui per importare tutto automaticamente.
                </div>
                <div style={{display:"flex",gap:8,marginBottom:16}}>
                  <a href="/MASTRO_Catalogo_Template.xlsx" download style={{flex:1,padding:"12px",borderRadius:10,border:`1.5px solid ${T.acc}`,background:T.accLt,color:T.acc,fontSize:12,fontWeight:700,textAlign:"center",textDecoration:"none",cursor:"pointer"}}>
                    üìÑ Scarica Template Excel
                  </a>
                </div>
                <div style={{position:"relative",marginBottom:12}}>
                  <input type="file" accept=".xlsx,.xls" onChange={e=>{const f=e.target.files?.[0]; if(f) importExcelCatalog(f);}} style={{position:"absolute",inset:0,opacity:0,cursor:"pointer",zIndex:2}} />
                  <div style={{padding:"20px",borderRadius:12,border:`2px dashed ${T.acc}`,background:T.accLt,textAlign:"center",cursor:"pointer"}}>
                    <div style={{fontSize:28,marginBottom:6}}>üìÇ</div>
                    <div style={{fontSize:13,fontWeight:700,color:T.acc}}>Carica file Excel compilato</div>
                    <div style={{fontSize:10,color:T.sub,marginTop:4}}>Trascina qui o tocca per selezionare (.xlsx)</div>
                  </div>
                </div>
                {importStatus && (
                  <div style={{background:importStatus.ok?"#f0fdf4":"#fefce8",borderRadius:10,padding:"12px 14px",border:`1.5px solid ${importStatus.ok?"#34c759":"#ff9500"}`,marginBottom:10}}>
                    <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                      <span style={{fontSize:16}}>{importStatus.ok?"‚úÖ":importStatus.step==="error"?"‚ùå":"‚è≥"}</span>
                      <span style={{fontSize:12,fontWeight:700,color:importStatus.ok?"#1a9e40":importStatus.step==="error"?"#dc2626":"#7a4500"}}>{importStatus.msg}</span>
                    </div>
                    {importStatus.detail && <div style={{fontSize:10,color:"#666"}}>{importStatus.detail}</div>}
                  </div>
                )}
                {importLog.length > 0 && (
                  <div style={{background:T.card2,borderRadius:10,padding:"12px",border:`1px solid ${T.bdr}`,maxHeight:300,overflow:"auto"}}>
                    <div style={{fontSize:10,fontWeight:700,color:T.sub,marginBottom:6,textTransform:"uppercase"}}>Log importazione</div>
                    {importLog.map((l,i) => (
                      <div key={i} style={{fontSize:11,color:l.startsWith("‚úÖ")?"#1a9e40":l.startsWith("‚ùå")?"#dc2626":l.startsWith("‚ö†Ô∏è")?"#d97706":l.startsWith("üéâ")?"#7c3aed":T.text,fontFamily:FM,lineHeight:1.6,fontWeight:l.startsWith("üéâ")?800:400}}>
                        {l}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div style={{background:T.card,borderRadius:12,overflow:"hidden",border:`1px solid ${T.bdr}`,padding:16}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
                <span style={{fontSize:16}}>ü§ù</span>
                <div style={{fontSize:13,fontWeight:700,color:T.text}}>Servizio compilazione catalogo</div>
              </div>
              <div style={{fontSize:11,color:T.sub,lineHeight:1.6,marginBottom:10}}>
                Non hai tempo di compilare il template? Mandaci il tuo listino attuale (PDF, Excel, qualsiasi formato) e lo compiliamo noi per te.
              </div>
              <div style={{padding:"10px 14px",borderRadius:8,background:"#fff8ec",border:"1px solid #ffb800",fontSize:11,color:"#7a4500"}}>
                üí∞ Servizio a pagamento ‚Äî Contattaci: <strong>info@mastro.app</strong>
              </div>
            </div>
          </>
        )}

        
        {settingsTab === "kit" && <div>
          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 12 }}><div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>Kit Accessori</div>
            <div onClick={() => setKitAccessori(p => [...p, { id: Date.now(), nome: "Nuovo Kit", items: [], prezzo: 0 }])} style={{ padding: "6px 12px", borderRadius: 8, background: T.acc, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer" }}>+ Kit</div></div>
          {kitAccessori.map((kit, ki) => <div key={kit.id} style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 12, marginBottom: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
              <input value={kit.nome} onChange={e => setKitAccessori(p => p.map((k,i) => i===ki ? {...k, nome: e.target.value} : k))} style={{ fontSize: 13, fontWeight: 700, color: T.text, background: "transparent", border: "none", outline: "none", flex: 1 }} />
              <span style={{ fontSize: 13, fontWeight: 800, color: T.grn }}>‚Ç¨{kit.prezzo}</span>
            </div>
            {kit.items.map((item, ii) => <div key={ii} style={{ display: "flex", gap: 6, alignItems: "center", marginBottom: 3 }}>
              <input value={item} onChange={e => { const ni=[...kit.items]; ni[ii]=e.target.value; setKitAccessori(p => p.map((k,i) => i===ki ? {...k, items: ni} : k)); }} style={{ flex: 1, fontSize: 11, color: T.text, background: T.bg, border: "1px solid " + T.bdr, borderRadius: 6, padding: "3px 6px" }} />
              <span onClick={() => setKitAccessori(p => p.map((k,i) => i===ki ? {...k, items: kit.items.filter((_,j)=>j!==ii)} : k))} style={{ color: T.red, cursor: "pointer", fontSize: 10 }}>‚úï</span>
            </div>)}
            <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
              <span onClick={() => setKitAccessori(p => p.map((k,i) => i===ki ? {...k, items: [...kit.items, "Nuovo"]} : k))} style={{ fontSize: 10, color: T.acc, cursor: "pointer" }}>+ comp.</span>
              <input type="number" value={kit.prezzo} onChange={e => setKitAccessori(p => p.map((k,i) => i===ki ? {...k, prezzo: parseFloat(e.target.value)||0} : k))} style={{ width: 60, fontSize: 10, color: T.text, background: T.bg, border: "1px solid " + T.bdr, borderRadius: 6, padding: "2px 6px" }} />
            </div>
          </div>)}
        </div>}

        {settingsTab === "marketplace" && <div>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 14, fontWeight: 800, color: T.text }}>üè™ Anagrafica Fornitori</div>
            <div onClick={() => { setFornitoreEdit({ id: "f_" + Date.now(), nome: "", ragioneSociale: "", piva: "", cf: "", tipo: "", categoria: "profili", indirizzo: "", cap: "", citta: "", provincia: "", telefono: "", cellulare: "", email: "", pec: "", sito: "", referente: "", telReferente: "", emailReferente: "", banca: "", iban: "", pagamento: "30gg_fm", scontoBase: 0, tempoConsegna: 14, sistemiTrattati: "", note: "", rating: 0, preferito: false, attivo: true }); setShowFornitoreForm(true); }}
              style={{ padding: "8px 16px", borderRadius: 8, background: T.acc, color: "#fff", fontSize: 12, fontWeight: 700, cursor: "pointer" }}>+ Nuovo</div>
          </div>
          {/* Filtri categoria */}
          <div style={{ display: "flex", gap: 4, marginBottom: 10, overflowX: "auto", paddingBottom: 4 }}>
            {[{id:"tutti",l:"Tutti"},{id:"profili",l:"üèó Profili"},{id:"vetri",l:"ü™ü Vetri"},{id:"ferramenta",l:"üî© Ferramenta"},{id:"accessori",l:"‚öôÔ∏è Accessori"},{id:"altro",l:"üì¶ Altro"}].map(c => (
              <span key={c.id} onClick={() => setSettingsForm(f => ({...f, _filtroForn: c.id}))} style={{ padding: "4px 10px", borderRadius: 6, fontSize: 9, fontWeight: 700, whiteSpace: "nowrap", cursor: "pointer", background: (settingsForm._filtroForn || "tutti") === c.id ? T.accLt : T.bg, color: (settingsForm._filtroForn || "tutti") === c.id ? T.acc : T.sub, border: "1px solid " + ((settingsForm._filtroForn || "tutti") === c.id ? T.acc + "40" : T.bdr) }}>{c.l}</span>
            ))}
          </div>
          {fornitori.filter(f => !settingsForm._filtroForn || settingsForm._filtroForn === "tutti" || f.categoria === settingsForm._filtroForn).map(f => (
            <div key={f.id} onClick={() => setShowFornitoreDetail(f)} style={{ background: T.card, borderRadius: T.r, border: "1px solid " + T.bdr, padding: 12, marginBottom: 8, cursor: "pointer" }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 800, color: T.text }}>{f.preferito ? "‚≠ê " : ""}{f.nome}</div>
                  <div style={{ fontSize: 10, color: T.sub }}>{f.ragioneSociale || f.tipo}</div>
                  <div style={{ display: "flex", gap: 4, marginTop: 4, flexWrap: "wrap" as any }}>
                    <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.accLt, color: T.acc, fontWeight: 700 }}>{f.categoria || f.tipo}</span>
                    <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.orangeLt, color: T.orange, fontWeight: 700 }}>‚è± {f.tempoConsegna || "?"} gg</span>
                    <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.purpleLt, color: T.purple, fontWeight: 700 }}>üí≥ {f.pagamento?.replace("_"," ") || "?"}</span>
                    {f.scontoBase > 0 && <span style={{ fontSize: 8, padding: "2px 6px", borderRadius: 4, background: T.grnLt, color: T.grn, fontWeight: 700 }}>-{f.scontoBase}%</span>}
                  </div>
                </div>
                {f.citta && <div style={{ fontSize: 10, color: T.sub, textAlign: "right" }}>{f.citta} ({f.provincia})</div>}
              </div>
              <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                <div onClick={(e) => { e.stopPropagation(); window.open("tel:" + (f.telefono || f.cellulare)); }} style={{ flex: 1, padding: 6, borderRadius: 6, background: T.grnLt, color: T.grn, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>üìû Chiama</div>
                <div onClick={(e) => { e.stopPropagation(); window.open("mailto:" + f.email); }} style={{ flex: 1, padding: 6, borderRadius: 6, background: T.accLt, color: T.acc, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>‚úâÔ∏è Email</div>
                {f.pec && <div onClick={(e) => { e.stopPropagation(); window.open("mailto:" + f.pec); }} style={{ flex: 1, padding: 6, borderRadius: 6, background: T.purpleLt, color: T.purple, fontSize: 10, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>üìß PEC</div>}
              </div>
            </div>
          ))}
          
          {/* FORNITORE DETAIL OVERLAY */}
          {showFornitoreDetail && (() => {
            const f = showFornitoreDetail;
            const ordiniF = (ordiniFornDB || []).filter(o => (o.fornitore?.nome || "").toLowerCase().includes(f.nome.toLowerCase()));
            const PAGAMENTI: Record<string,string> = { "anticipato": "Anticipato", "30gg_fm": "30 gg FM", "60gg_fm": "60 gg FM", "90gg_fm": "90 gg FM", "riba_30": "RiBa 30 gg", "riba_60": "RiBa 60 gg", "ricevuta_merce": "Alla consegna" };
            return <div style={{ position: "fixed", inset: 0, zIndex: 10003, background: T.bg, overflow: "auto" }}>
              <div style={{ display: "flex", alignItems: "center", padding: "12px 16px", background: T.card, borderBottom: "1px solid " + T.bdr, position: "sticky", top: 0, zIndex: 5 }}>
                <div onClick={() => setShowFornitoreDetail(null)} style={{ cursor: "pointer", color: T.acc, fontWeight: 700, fontSize: 14 }}>‚Üê Indietro</div>
                <div style={{ flex: 1, textAlign: "center", fontSize: 14, fontWeight: 800, color: T.text }}>{f.nome}</div>
                <div onClick={() => { setFornitoreEdit({...f}); setShowFornitoreForm(true); setShowFornitoreDetail(null); }} style={{ cursor: "pointer", color: T.acc, fontWeight: 700, fontSize: 12 }}>‚úèÔ∏è Modifica</div>
              </div>
              <div style={{ padding: 16 }}>
                {/* DATI AZIENDA */}
                <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üè¢ DATI AZIENDA</div>
                  {f.ragioneSociale && <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 4 }}>{f.ragioneSociale}</div>}
                  {f.piva && <div style={{ fontSize: 11, color: T.sub }}>P.IVA: <b>{f.piva}</b></div>}
                  {f.cf && <div style={{ fontSize: 11, color: T.sub }}>CF: {f.cf}</div>}
                  {f.indirizzo && <div style={{ fontSize: 11, color: T.sub, marginTop: 4 }}>üìç {f.indirizzo}, {f.cap} {f.citta} ({f.provincia})</div>}
                  {f.sito && <div onClick={() => window.open("https://" + f.sito.replace("https://","").replace("http://",""))} style={{ fontSize: 11, color: T.acc, cursor: "pointer", marginTop: 2 }}>üåê {f.sito}</div>}
                </div>
                {/* CONTATTI */}
                <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üìû CONTATTI</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
                    {f.telefono && <div onClick={() => window.open("tel:" + f.telefono)} style={{ padding: 10, borderRadius: 8, background: T.grnLt, textAlign: "center", cursor: "pointer" }}><div style={{ fontSize: 16 }}>üìû</div><div style={{ fontSize: 10, fontWeight: 700, color: T.grn }}>{f.telefono}</div><div style={{ fontSize: 8, color: T.sub }}>Ufficio</div></div>}
                    {f.cellulare && <div onClick={() => window.open("tel:" + f.cellulare)} style={{ padding: 10, borderRadius: 8, background: T.grnLt, textAlign: "center", cursor: "pointer" }}><div style={{ fontSize: 16 }}>üì±</div><div style={{ fontSize: 10, fontWeight: 700, color: T.grn }}>{f.cellulare}</div><div style={{ fontSize: 8, color: T.sub }}>Cellulare</div></div>}
                    {f.email && <div onClick={() => window.open("mailto:" + f.email)} style={{ padding: 10, borderRadius: 8, background: T.accLt, textAlign: "center", cursor: "pointer" }}><div style={{ fontSize: 16 }}>‚úâÔ∏è</div><div style={{ fontSize: 10, fontWeight: 700, color: T.acc, wordBreak: "break-all" }}>{f.email}</div></div>}
                    {f.pec && <div onClick={() => window.open("mailto:" + f.pec)} style={{ padding: 10, borderRadius: 8, background: T.purpleLt, textAlign: "center", cursor: "pointer" }}><div style={{ fontSize: 16 }}>üìß</div><div style={{ fontSize: 10, fontWeight: 700, color: T.purple, wordBreak: "break-all" }}>{f.pec}</div><div style={{ fontSize: 8, color: T.sub }}>PEC</div></div>}
                  </div>
                  {f.referente && <div style={{ marginTop: 8, padding: 10, borderRadius: 8, background: T.bg }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: T.text }}>üë§ Referente: {f.referente}</div>
                    {f.telReferente && <div style={{ fontSize: 10, color: T.sub }}>{f.telReferente}</div>}
                    {f.emailReferente && <div style={{ fontSize: 10, color: T.acc }}>{f.emailReferente}</div>}
                  </div>}
                </div>
                {/* CONDIZIONI COMMERCIALI */}
                <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üí∞ CONDIZIONI COMMERCIALI</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <div style={{ padding: 10, borderRadius: 8, background: T.orangeLt, textAlign: "center" }}><div style={{ fontSize: 8, fontWeight: 700, color: T.sub }}>PAGAMENTO</div><div style={{ fontSize: 12, fontWeight: 900, color: T.orange }}>{PAGAMENTI[f.pagamento] || f.pagamento}</div></div>
                    <div style={{ padding: 10, borderRadius: 8, background: T.grnLt, textAlign: "center" }}><div style={{ fontSize: 8, fontWeight: 700, color: T.sub }}>SCONTO BASE</div><div style={{ fontSize: 12, fontWeight: 900, color: T.grn }}>{f.scontoBase}%</div></div>
                    <div style={{ padding: 10, borderRadius: 8, background: T.accLt, textAlign: "center" }}><div style={{ fontSize: 8, fontWeight: 700, color: T.sub }}>TEMPI CONSEGNA</div><div style={{ fontSize: 12, fontWeight: 900, color: T.acc }}>{f.tempoConsegna} gg</div></div>
                    {f.rating > 0 && <div style={{ padding: 10, borderRadius: 8, background: T.bg, textAlign: "center" }}><div style={{ fontSize: 8, fontWeight: 700, color: T.sub }}>RATING</div><div style={{ fontSize: 12, fontWeight: 900, color: T.text }}>‚≠ê {f.rating}</div></div>}
                  </div>
                  {f.banca && <div style={{ marginTop: 8, padding: 8, borderRadius: 8, background: T.bg }}><div style={{ fontSize: 10, color: T.sub }}>üè¶ {f.banca}</div>{f.iban && <div style={{ fontSize: 10, color: T.text, fontFamily: "'JetBrains Mono', monospace", letterSpacing: 0.5 }}>{f.iban}</div>}</div>}
                </div>
                {/* PRODOTTI */}
                {f.sistemiTrattati && <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 6 }}>üì¶ SISTEMI/PRODOTTI</div>
                  <div style={{ fontSize: 12, color: T.text, lineHeight: 1.6 }}>{f.sistemiTrattati}</div>
                </div>}
                {/* STORICO ORDINI */}
                <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>üìã STORICO ORDINI ({ordiniF.length})</div>
                  {ordiniF.length === 0 ? <div style={{ fontSize: 11, color: T.sub, textAlign: "center", padding: 12 }}>Nessun ordine</div> :
                    ordiniF.slice(0, 5).map(o => <div key={o.id} style={{ display: "flex", justifyContent: "space-between", padding: "6px 0", borderBottom: "1px solid " + T.bdr + "30" }}>
                      <div style={{ fontSize: 11, color: T.text }}>{o.cmCode || "‚Äî"}</div>
                      <div style={{ fontSize: 11, fontWeight: 700, color: T.text }}>‚Ç¨{(o.totale || 0).toLocaleString("it-IT")}</div>
                    </div>)
                  }
                </div>
                {f.note && <div style={{ background: T.card, borderRadius: 12, border: "1px solid " + T.bdr, padding: 16, marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 4 }}>üìù NOTE</div>
                  <div style={{ fontSize: 12, color: T.text }}>{f.note}</div>
                </div>}
                <div style={{ display: "flex", gap: 8 }}>
                  <div onClick={() => setFornitori(p => p.map(ff => ff.id === f.id ? {...ff, preferito: !ff.preferito} : ff))} style={{ flex: 1, padding: 12, borderRadius: 10, background: f.preferito ? T.orangeLt : T.bg, border: "1px solid " + (f.preferito ? T.orange : T.bdr), color: f.preferito ? T.orange : T.sub, fontSize: 12, fontWeight: 700, textAlign: "center", cursor: "pointer" }}>{f.preferito ? "‚òÖ Preferito" : "‚òÜ Preferito"}</div>
                  <div onClick={() => { if(confirm("Eliminare " + f.nome + "?")) { setFornitori(p => p.filter(ff => ff.id !== f.id)); setShowFornitoreDetail(null); }}} style={{ padding: "12px 16px", borderRadius: 10, background: T.redLt, color: T.red, fontSize: 12, fontWeight: 700, cursor: "pointer" }}>üóë</div>
                </div>
              </div>
            </div>;
          })()}
          
          {/* FORNITORE FORM OVERLAY */}
          {showFornitoreForm && fornitoreEdit && (() => {
            const PAGAMENTI_OPT = [
              { id: "anticipato", l: "Anticipato" }, { id: "30gg_fm", l: "30 gg FM" }, { id: "60gg_fm", l: "60 gg FM" },
              { id: "90gg_fm", l: "90 gg FM" }, { id: "riba_30", l: "RiBa 30 gg" }, { id: "riba_60", l: "RiBa 60 gg" }, { id: "ricevuta_merce", l: "Alla consegna" }
            ];
            const CATEGORIE = [
              { id: "profili", l: "üèó Profili" }, { id: "vetri", l: "ü™ü Vetri" }, { id: "ferramenta", l: "üî© Ferramenta" },
              { id: "accessori", l: "‚öôÔ∏è Accessori" }, { id: "guarnizioni", l: "üîß Guarnizioni" }, { id: "altro", l: "üì¶ Altro" }
            ];
            const upd = (k: string, v: any) => setFornitoreEdit((p: any) => ({...p, [k]: v}));
            const fldStyle = { width: "100%", padding: "10px 12px", borderRadius: 10, border: "1px solid " + T.bdr, background: T.bg, color: T.text, fontSize: 12, fontFamily: "inherit", boxSizing: "border-box" as const };
            const lblStyle = { fontSize: 9, fontWeight: 700, color: T.sub, marginBottom: 2, textTransform: "uppercase" as const };
            return <div style={{ position: "fixed", inset: 0, zIndex: 10004, background: T.bg, overflow: "auto" }}>
              <div style={{ display: "flex", alignItems: "center", padding: "12px 16px", background: T.card, borderBottom: "1px solid " + T.bdr, position: "sticky", top: 0, zIndex: 5 }}>
                <div onClick={() => { setShowFornitoreForm(false); setFornitoreEdit(null); }} style={{ cursor: "pointer", color: T.red, fontWeight: 700, fontSize: 13 }}>‚úï Annulla</div>
                <div style={{ flex: 1, textAlign: "center", fontSize: 14, fontWeight: 800, color: T.text }}>{fornitori.find(f => f.id === fornitoreEdit.id) ? "Modifica" : "Nuovo"} Fornitore</div>
                <div onClick={() => {
                  const existing = fornitori.find(f => f.id === fornitoreEdit.id);
                  if (existing) setFornitori(p => p.map(f => f.id === fornitoreEdit.id ? fornitoreEdit : f));
                  else setFornitori(p => [...p, fornitoreEdit]);
                  setShowFornitoreForm(false); setFornitoreEdit(null);
                }} style={{ cursor: "pointer", color: T.acc, fontWeight: 800, fontSize: 13 }}>üíæ Salva</div>
              </div>
              <div style={{ padding: 16 }}>
                {/* SEZIONE AZIENDA */}
                <div style={{ fontSize: 11, fontWeight: 800, color: T.acc, marginBottom: 8, marginTop: 4 }}>üè¢ DATI AZIENDA</div>
                <div style={{ display: "grid", gap: 8, marginBottom: 16 }}>
                  <div><div style={lblStyle}>Nome (breve)</div><input style={fldStyle} value={fornitoreEdit.nome} onChange={e => upd("nome", e.target.value)} placeholder="es. Aluplast" /></div>
                  <div><div style={lblStyle}>Ragione Sociale</div><input style={fldStyle} value={fornitoreEdit.ragioneSociale} onChange={e => upd("ragioneSociale", e.target.value)} placeholder="es. Aluplast Italia SRL" /></div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <div><div style={lblStyle}>P.IVA</div><input style={fldStyle} value={fornitoreEdit.piva} onChange={e => upd("piva", e.target.value)} placeholder="01234567890" /></div>
                    <div><div style={lblStyle}>Codice Fiscale</div><input style={fldStyle} value={fornitoreEdit.cf} onChange={e => upd("cf", e.target.value)} /></div>
                  </div>
                  <div><div style={lblStyle}>Indirizzo</div><input style={fldStyle} value={fornitoreEdit.indirizzo} onChange={e => upd("indirizzo", e.target.value)} /></div>
                  <div style={{ display: "grid", gridTemplateColumns: "80px 1fr 60px", gap: 8 }}>
                    <div><div style={lblStyle}>CAP</div><input style={fldStyle} value={fornitoreEdit.cap} onChange={e => upd("cap", e.target.value)} /></div>
                    <div><div style={lblStyle}>Citt√†</div><input style={fldStyle} value={fornitoreEdit.citta} onChange={e => upd("citta", e.target.value)} /></div>
                    <div><div style={lblStyle}>Prov.</div><input style={fldStyle} value={fornitoreEdit.provincia} onChange={e => upd("provincia", e.target.value)} maxLength={2} /></div>
                  </div>
                  <div><div style={lblStyle}>Sito Web</div><input style={fldStyle} value={fornitoreEdit.sito} onChange={e => upd("sito", e.target.value)} placeholder="www.fornitore.it" /></div>
                  <div><div style={lblStyle}>Categoria</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" as any }}>
                      {CATEGORIE.map(c => <span key={c.id} onClick={() => upd("categoria", c.id)} style={{ padding: "6px 10px", borderRadius: 6, fontSize: 10, fontWeight: 700, cursor: "pointer", background: fornitoreEdit.categoria === c.id ? T.accLt : T.bg, color: fornitoreEdit.categoria === c.id ? T.acc : T.sub, border: "1px solid " + (fornitoreEdit.categoria === c.id ? T.acc + "40" : T.bdr) }}>{c.l}</span>)}
                    </div>
                  </div>
                </div>
                {/* SEZIONE CONTATTI */}
                <div style={{ fontSize: 11, fontWeight: 800, color: T.acc, marginBottom: 8 }}>üìû CONTATTI</div>
                <div style={{ display: "grid", gap: 8, marginBottom: 16 }}>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <div><div style={lblStyle}>Telefono</div><input style={fldStyle} value={fornitoreEdit.telefono} onChange={e => upd("telefono", e.target.value)} type="tel" /></div>
                    <div><div style={lblStyle}>Cellulare</div><input style={fldStyle} value={fornitoreEdit.cellulare} onChange={e => upd("cellulare", e.target.value)} type="tel" /></div>
                  </div>
                  <div><div style={lblStyle}>Email</div><input style={fldStyle} value={fornitoreEdit.email} onChange={e => upd("email", e.target.value)} type="email" /></div>
                  <div><div style={lblStyle}>PEC</div><input style={fldStyle} value={fornitoreEdit.pec} onChange={e => upd("pec", e.target.value)} type="email" placeholder="fornitore@pec.it" /></div>
                  <div style={{ fontSize: 10, fontWeight: 800, color: T.sub, marginTop: 4 }}>üë§ REFERENTE COMMERCIALE</div>
                  <div><div style={lblStyle}>Nome Referente</div><input style={fldStyle} value={fornitoreEdit.referente} onChange={e => upd("referente", e.target.value)} /></div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <div><div style={lblStyle}>Tel. Referente</div><input style={fldStyle} value={fornitoreEdit.telReferente} onChange={e => upd("telReferente", e.target.value)} type="tel" /></div>
                    <div><div style={lblStyle}>Email Referente</div><input style={fldStyle} value={fornitoreEdit.emailReferente} onChange={e => upd("emailReferente", e.target.value)} type="email" /></div>
                  </div>
                </div>
                {/* SEZIONE COMMERCIALE */}
                <div style={{ fontSize: 11, fontWeight: 800, color: T.acc, marginBottom: 8 }}>üí∞ CONDIZIONI COMMERCIALI</div>
                <div style={{ display: "grid", gap: 8, marginBottom: 16 }}>
                  <div><div style={lblStyle}>Modalit√† Pagamento</div>
                    <select value={fornitoreEdit.pagamento} onChange={e => upd("pagamento", e.target.value)} style={{...fldStyle}}>
                      {PAGAMENTI_OPT.map(p => <option key={p.id} value={p.id}>{p.l}</option>)}
                    </select>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <div><div style={lblStyle}>Sconto Base %</div><input style={fldStyle} type="number" value={fornitoreEdit.scontoBase} onChange={e => upd("scontoBase", parseFloat(e.target.value) || 0)} /></div>
                    <div><div style={lblStyle}>Tempi Consegna (gg)</div><input style={fldStyle} type="number" value={fornitoreEdit.tempoConsegna} onChange={e => upd("tempoConsegna", parseInt(e.target.value) || 0)} /></div>
                  </div>
                  <div><div style={lblStyle}>Banca</div><input style={fldStyle} value={fornitoreEdit.banca} onChange={e => upd("banca", e.target.value)} /></div>
                  <div><div style={lblStyle}>IBAN</div><input style={fldStyle} value={fornitoreEdit.iban} onChange={e => upd("iban", e.target.value)} placeholder="IT..." /></div>
                </div>
                {/* SEZIONE PRODOTTI */}
                <div style={{ fontSize: 11, fontWeight: 800, color: T.acc, marginBottom: 8 }}>üì¶ PRODOTTI E NOTE</div>
                <div style={{ display: "grid", gap: 8, marginBottom: 16 }}>
                  <div><div style={lblStyle}>Sistemi/Prodotti Trattati</div><textarea style={{...fldStyle, minHeight: 60, resize: "vertical" as any}} value={fornitoreEdit.sistemiTrattati} onChange={e => upd("sistemiTrattati", e.target.value)} placeholder="es. Ideal 4000, Ideal 7000..." /></div>
                  <div><div style={lblStyle}>Note</div><textarea style={{...fldStyle, minHeight: 60, resize: "vertical" as any}} value={fornitoreEdit.note} onChange={e => upd("note", e.target.value)} /></div>
                </div>
              </div>
            </div>;
          })()}
        </div>}

        {settingsTab === "temi" && <div>
          <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 12 }}>Temi</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8 }}>
            {Object.entries(THEMES).map(([k, v]: [string, any]) => (
              <div key={k} onClick={() => setTheme(k)} style={{ background: v.card, borderRadius: T.r, border: "2px solid " + (theme === k ? v.acc : v.bdr), padding: 12, cursor: "pointer", textAlign: "center" }}>
                <div style={{ fontSize: 20, marginBottom: 4 }}>{v.emoji}</div>
                <div style={{ fontSize: 11, fontWeight: 700, color: v.text }}>{v.name}</div>
                {theme === k && <div style={{ fontSize: 9, color: v.acc, fontWeight: 700, marginTop: 2 }}>ATTIVO</div>}
              </div>
            ))}
          </div>
        </div>}


        {settingsTab === "guida" && (
          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            {/* Header */}
            <div style={{background:T.acc,borderRadius:12,padding:"16px 18px",color:"#fff"}}>
              <div style={{fontSize:15,fontWeight:800}}>üìñ Guida rapida MASTRO</div>
              <div style={{fontSize:11,opacity:0.8,marginTop:4}}>Tutto quello che ti serve sapere, in pillole da 30 secondi.</div>
            </div>

            {/* CARD 1: CREARE COMMESSA */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#007aff15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìÅ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come creare una commessa</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Commesse</b> dal menu in basso</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca il pulsante <b>+ Nuova Commessa</b> in alto</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Compila <b>nome cliente, indirizzo</b> e tipo di lavoro</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#34c759",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>‚úì</div>
                  <div style={{fontSize:12,color:"#34c759",fontWeight:700,lineHeight:1.5}}>La commessa parte in fase "Sopralluogo"</div>
                </div>
              </div>
            </div>

            {/* CARD 2: AGGIUNGERE VANI */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff950015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>ü™ü</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come aggiungere i vani</div><div style={{fontSize:10,color:T.sub}}>‚è± 30 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri una commessa e vai nella sezione <b>Rilievi</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>+ Aggiungi vano</b> ‚Äî scegli tipo (F1A, PF2A, SC2A...)</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Dai un nome al vano (es. "Cucina", "Salone") e scegli la stanza</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:4,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Tipologie rapide:</b> F1A = 1 anta, F2A = 2 ante, PF = portafinestra, SC = scorrevole, VAS = vasistas, TDBR = tenda bracci, TDPERG = pergola</div>
              </div>
            </div>

            {/* CARD 3: INSERIRE MISURE */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#5856d615",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìè</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come inserire le misure</div><div style={{fontSize:10,color:T.sub}}>‚è± 30 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca un vano per aprirlo ‚Äî vai nel tab <b>Misure</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Inserisci <b>3 larghezze</b> (alto, centro, basso) e <b>3 altezze</b> (sx, centro, dx)</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Completa <b>spallette</b>, <b>davanzale</b>, telaio e accessori</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:4,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Regola d'oro:</b> misura sempre dal CENTRO del vano ‚Äî √® il punto pi√π affidabile per il taglio</div>
              </div>
            </div>

            {/* CARD 4: GENERARE PREVENTIVO */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#34c75915",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìÑ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come generare un preventivo PDF</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri una commessa con almeno un vano misurato</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca il pulsante <b>‚Ç¨ Preventivo</b> nella barra azioni</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Controlla il riepilogo ‚Äî fai <b>firmare il cliente</b> sul telefono</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>4</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>Genera & Scarica PDF</b> ‚Äî pronto per inviare via WhatsApp!</div>
                </div>
              </div>
            </div>

            {/* CARD 5: FASI COMMESSA */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#af52de15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üîÑ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Le 8 fasi di una commessa</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                {[
                  {f:"Sopralluogo",i:"üìê",d:"Vai dal cliente, valuta il lavoro",c:"#007aff"},
                  {f:"Preventivo",i:"üìù",d:"Prepara e invia l'offerta",c:"#ff9500"},
                  {f:"Conferma",i:"‚úçÔ∏è",d:"Il cliente accetta e firma",c:"#af52de"},
                  {f:"Misure",i:"üìè",d:"Rilievo preciso di ogni vano",c:"#5856d6"},
                  {f:"Ordini",i:"üõí",d:"Ordina profili, vetri e accessori",c:"#ff2d55"},
                  {f:"Produzione",i:"üè≠",d:"Attendi che il materiale sia pronto",c:"#ff9500"},
                  {f:"Posa",i:"üîß",d:"Installa tutto dal cliente",c:"#34c759"},
                  {f:"Chiusura",i:"‚úÖ",d:"Saldo finale e garanzia",c:"#30b0c7"},
                ].map((p,i) => (
                  <div key={i} style={{display:"flex",alignItems:"center",gap:8,marginBottom:i<7?6:0}}>
                    <div style={{fontSize:14,width:22,textAlign:"center"}}>{p.i}</div>
                    <div style={{fontSize:12,fontWeight:700,color:p.c,width:85}}>{p.f}</div>
                    <div style={{fontSize:11,color:T.sub}}>{p.d}</div>
                    {i<7 && <div style={{marginLeft:"auto",fontSize:10,color:T.sub}}>‚Üí</div>}
                  </div>
                ))}
              </div>
            </div>

            {/* CARD 6: SCORCIATOIE */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff2d5515",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>‚ö°</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Trucchi da Pro</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                {[
                  {t:"Barra di ricerca",d:"Cerca qualsiasi cosa: clienti, commesse, indirizzi ‚Äî tutto da Home"},
                  {t:"Allerte rosse",d:"Le commesse ferme da troppo tempo appaiono in Home ‚Äî toccale per aprirle"},
                  {t:"Drag & drop fasi",d:"In Commesse, tieni premuto su una card per spostarla tra le fasi"},
                  {t:"Foto e firma",d:"Puoi fotografare il vano e far firmare il cliente direttamente sul telefono"},
                  {t:"SVG in tempo reale",d:"Mentre inserisci le misure, il disegno del vano si aggiorna live"},
                ].map((tip,i) => (
                  <div key={i} style={{display:"flex",gap:8,marginBottom:i<4?8:0,alignItems:"flex-start"}}>
                    <div style={{fontSize:10,color:T.acc,fontWeight:900,marginTop:2}}>‚ñ∏</div>
                    <div><span style={{fontSize:12,fontWeight:700,color:T.text}}>{tip.t}: </span><span style={{fontSize:11,color:T.sub}}>{tip.d}</span></div>
                  </div>
                ))}
              </div>
            </div>

            {/* CARD 7: CONTROTELAIO PSU */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#2563eb15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üî≤</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come configurare il controtelaio</div><div style={{fontSize:10,color:T.sub}}>‚è± 30 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri un vano ‚Äî scorri fino alla sezione <b>üî≤ Controtelaio</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scegli il tipo: <b>Singolo</b>, <b>Doppio</b> o <b>Con Cassonetto</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Inserisci <b>larghezza e altezza vano</b> ‚Äî il calcolo infisso parte in automatico</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#34c759",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>‚úì</div>
                  <div style={{fontSize:12,color:"#34c759",fontWeight:700,lineHeight:1.5}}>L'infisso viene calcolato togliendo l'offset (default 10mm/lato)</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Cassonetto:</b> compila anche H e P cassonetto + modello cielino (A tampone, A tappo, Frontale)</div>
              </div>
            </div>

            {/* CARD 8: FOTO VIDEO AUDIO */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff2d5515",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üì∏</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Foto, video e note vocali</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Dentro un rilievo, tocca il pulsante <b>üìé Allegati</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scegli: <b>üì∑ Foto</b> (scatta dalla fotocamera), <b>üé• Video</b> o <b>üé§ Nota vocale</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Gli allegati vengono salvati e associati al vano ‚Äî rivedili quando vuoi</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>AI Photo:</b> tocca il bottone ü§ñ AI nel vano per analizzare la foto con intelligenza artificiale</div>
              </div>
            </div>

            {/* CARD 9: FUORISQUADRO */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff950015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìê</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Fuorisquadro e diagonali</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Nelle misure del vano, inserisci <b>H1</b> (sinistra) e <b>H2</b> (destra) se diverse</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Inserisci le <b>diagonali D1 e D2</b> ‚Äî il sistema calcola la differenza</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#ff3b30",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>!</div>
                  <div style={{fontSize:12,color:"#ff3b30",fontWeight:700,lineHeight:1.5}}>Se fuorisquadro: warning rosso + disegno SVG con forma reale</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Nel riepilogo WhatsApp</b> il fuorisquadro viene segnalato con ‚ö†Ô∏è per avvisare la produzione</div>
              </div>
            </div>

            {/* CARD 10: IMPORT EXCEL */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#34c75915",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üì•</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Importare il catalogo da Excel</div><div style={{fontSize:10,color:T.sub}}>‚è± 1 minuto</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Impostazioni ‚Üí Importa</b> e scarica il <b>Template Excel</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri il file Excel ‚Äî ogni <b>foglio</b> corrisponde a una categoria del catalogo</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Compila le colonne come indicato sotto ‚Äî <b>una riga per ogni prodotto</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:10}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>4</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Torna in <b>Importa</b>, carica il file ‚Äî il catalogo viene sostituito automaticamente</div>
                </div>

                {/* Tabella fogli */}
                <div style={{fontSize:11,fontWeight:800,color:T.acc,marginBottom:6,marginTop:4}}>üìä COLONNE PER OGNI FOGLIO:</div>
                {[
                  {foglio:"SISTEMI", colonne:"Marca | Nome Sistema | Uf (W/m¬≤K)", es:"Aluplast | Ideal 4000 | 1.1"},
                  {foglio:"COLORI", colonne:"Nome | RAL/Codice | Tipo", es:"Grigio Antracite | 7016 | RAL"},
                  {foglio:"VETRI", colonne:"Descrizione | Composizione | Ug (W/m¬≤K) | Prezzo ‚Ç¨/mq", es:"Basso emissivo | 4/20/4 | 1.0 | 35"},
                  {foglio:"COPRIFILI", colonne:"Descrizione | Codice | Prezzo ‚Ç¨/ml", es:"Coprifilo 70mm | CF70 | 4.50"},
                  {foglio:"LAMIERE", colonne:"Descrizione | Codice | Prezzo ‚Ç¨/ml", es:"Lamiera 25/10 | LM25 | 8.20"},
                ].map((f,i) => (
                  <div key={i} style={{marginBottom:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8,border:"1px solid "+(T.bdr||"#E5E3DE")}}>
                    <div style={{fontSize:11,fontWeight:800,color:T.blue||"#2563eb",marginBottom:3}}>{"üìã "+f.foglio}</div>
                    <div style={{fontSize:10,color:T.text,fontFamily:FM,marginBottom:2}}>{f.colonne}</div>
                    <div style={{fontSize:9,color:T.sub,fontStyle:"italic"}}>{"Es: "+f.es}</div>
                  </div>
                ))}
                <div style={{fontSize:10,color:T.sub,marginTop:4,padding:"8px 10px",background:"#fff8ec",borderRadius:8,border:"1px solid #ffcc0040"}}>
                  ‚ö†Ô∏è <b>Attenzione:</b> l'importazione <b>sostituisce</b> il catalogo esistente ‚Äî fai un backup prima se hai gia inserito dati a mano.
                </div>
                <div style={{fontSize:10,color:T.sub,marginTop:6,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>
                  üí° <b>Fogli extra supportati:</b> ACCESSORI, TIPOLOGIE, CONTROTELAI, TAPPARELLE, ZANZARIERE, PERSIANE, SERVIZI, SAGOME_TELAIO, PROFILI ‚Äî saranno attivati nei prossimi aggiornamenti.
                </div>
                <div style={{fontSize:10,color:T.sub,marginTop:6,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>
                  ü§ù <b>Non hai tempo?</b> Mandaci il tuo listino in qualsiasi formato (PDF, foto, Excel vecchio) a <b>info@mastro.app</b> e lo compiliamo noi per te.
                </div>
              </div>
            </div>

            {/* CARD 11: CONDIZIONI PREVENTIVO */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#af52de15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìã</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Personalizzare le condizioni del preventivo</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Impostazioni ‚Üí Azienda</b> e scorri in basso</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Trovi 5 sezioni: <b>Fornitura, Pagamento, Consegna, Contratto, Dettagli tecnici</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scrivi il tuo testo ‚Äî appare nel PDF. Se lasci vuoto, usa il testo standard</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>PEC:</b> compila anche il campo PEC ‚Äî apparira nell'intestazione del preventivo</div>
              </div>
            </div>

            {/* CARD 12: AGENDA */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#007aff15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìÖ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come usare l'agenda</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Agenda</b> dal menu ‚Äî scegli vista <b>Mese, Settimana o Giorno</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>+ Nuovo evento</b> ‚Äî scegli tipo (Sopralluogo, Misure, Posa, Consegna...)</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Collega l'evento a una <b>commessa</b> ‚Äî appare anche nella Home del giorno</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>10 tipi evento</b> con icone e colori diversi ‚Äî i pallini colorati nel mese ti danno il colpo d'occhio</div>
              </div>
            </div>

            {/* CARD 13: AI INBOX */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#5856d615",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>ü§ñ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>AI Inbox ‚Äî email intelligenti</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Messaggi ‚Üí AI Inbox</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>L'AI classifica ogni email: <b>priorita, sentimento, commessa suggerita</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Azioni rapide: <b>Archivia</b>, <b>Collega a commessa</b> o <b>Rispondi</b> con un tap</div>
                </div>
              </div>
            </div>

            {/* CARD 14: RIEPILOGO WHATSAPP */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#25d36618",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üí¨</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Riepilogo per WhatsApp</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri una commessa con vani ‚Äî tocca <b>üìã Riepilogo</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vedi il riepilogo formattato con tutti i vani, misure, colori, accessori</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>Copia</b> ‚Äî incolla direttamente in WhatsApp per la produzione</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Fuorisquadro incluso:</b> se un vano e fuorisquadro, il riepilogo lo segnala con ‚ö†Ô∏è e le misure reali</div>
              </div>
            </div>

            {/* CARD 15: PIPELINE PERSONALIZZABILE */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff950015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>‚öôÔ∏è</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Personalizzare la pipeline</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Impostazioni ‚Üí Pipeline</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Attiva/disattiva le fasi che ti servono con gli <b>switch</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#34c759",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>‚úì</div>
                  <div style={{fontSize:12,color:"#34c759",fontWeight:700,lineHeight:1.5}}>La fase Chiusura e sempre attiva ‚Äî non si puo disabilitare</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Esempio:</b> non fai produzione interna? Disattiva "Produzione" e le commesse saltano direttamente a "Posa"</div>
              </div>
            </div>

            {/* CARD 16: FIRMA CLIENTE */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#5856d615",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>‚úçÔ∏è</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Far firmare il cliente sul telefono</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri il <b>Preventivo</b> di una commessa</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>‚úçÔ∏è Firma cliente</b> ‚Äî appare un'area bianca per firmare col dito</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Il cliente firma col dito sullo schermo ‚Äî tocca <b>Conferma</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#34c759",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>‚úì</div>
                  <div style={{fontSize:12,color:"#34c759",fontWeight:700,lineHeight:1.5}}>La firma viene salvata e inserita nel PDF del preventivo</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Puoi cancellare</b> e far rifirmare ‚Äî tocca "Cancella" per resettare l'area firma</div>
              </div>
            </div>

            {/* CARD 17: SISTEMA RILIEVI */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff950015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìÇ</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Come funzionano i rilievi</div><div style={{fontSize:10,color:T.sub}}>‚è± 30 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri una commessa ‚Äî tocca <b>+ Nuovo rilievo</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Compila <b>data, rilevatore</b> (dal team), note e condizioni</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Dentro ogni rilievo aggiungi i <b>vani</b> con misure e foto</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:4,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Piu rilievi per commessa:</b> puoi fare un primo sopralluogo esplorativo e poi un secondo con le misure definitive. Il tab <b>Report</b> confronta le differenze tra rilievi</div>
              </div>
            </div>

            {/* CARD 18: CHAT AI */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#af52de15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üí¨</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Chiedi a MASTRO AI</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Messaggi</b> ‚Äî trovi la chat AI in basso</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scrivi domande naturali: <b>"cosa ho in programma oggi?"</b>, <b>"quante commesse ho?"</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>MASTRO AI risponde con dati reali dalle tue commesse, task e misure</div>
                </div>
              </div>
            </div>

            {/* CARD 19: INVIO EMAIL */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#007aff15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìß</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Inviare email dalla commessa</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Dentro una commessa, tocca <b>üìß Invia email</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scegli il <b>destinatario</b> (cliente o fornitore), scrivi <b>oggetto e messaggio</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>L'email viene inviata e collegata alla commessa nel <b>log attivita</b></div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Template pronti:</b> conferma appuntamento, promemoria, preventivo pronto ‚Äî personalizzabili</div>
              </div>
            </div>

            {/* CARD 20: RUBRICA */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#34c75915",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üìá</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Rubrica contatti</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Messaggi ‚Üí Rubrica</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Filtra per tipo: <b>Tutti, Preferiti, Team, Clienti, Fornitori</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Ogni contatto mostra: nome, ruolo, canali disponibili (WhatsApp, email, SMS)</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>I membri del team</b> appaiono automaticamente nella rubrica con il loro ruolo e colore</div>
              </div>
            </div>

            {/* CARD 21: TEAM */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff2d5515",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üë•</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Gestione Team</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Impostazioni ‚Üí Team</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>+ Aggiungi membro</b> ‚Äî inserisci nome, ruolo e colore</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>I membri appaiono nei rilievi, negli eventi e nella rubrica automaticamente</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Assegnazione automatica:</b> quando una commessa avanza di fase, il responsabile viene assegnato in base al ruolo configurato</div>
              </div>
            </div>

            {/* CARD 22: WIDGET DRAG & DROP */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#007aff15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üß©</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Personalizzare la Home</div><div style={{fontSize:10,color:T.sub}}>‚è± 15 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Nella Home, tocca <b>‚úèÔ∏è Layout</b> in alto a destra</div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}><b>Trascina</b> i widget per riordinarli ‚Äî metti in alto quelli che usi di piu</div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Tocca <b>‚úì Fine</b> per salvare ‚Äî l'ordine viene ricordato</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>7 widget disponibili:</b> Contatori, IO (briefing), Attenzione, Programma oggi, Settimana, Commesse, Azioni rapide</div>
              </div>
            </div>

            {/* CARD 23: DATI AZIENDALI */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#ff950015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üè¢</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Compilare i dati aziendali</div><div style={{fontSize:10,color:T.sub}}>‚è± 30 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Vai in <b>Impostazioni ‚Üí Azienda</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Compila: <b>Ragione sociale, P.IVA, CF, Indirizzo, Telefono, Email, PEC, CCIAA</b></div>
                </div>
                <div style={{display:"flex",gap:12}}>
                  <div style={{width:22,height:22,borderRadius:6,background:"#34c759",color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>‚úì</div>
                  <div style={{fontSize:12,color:"#34c759",fontWeight:700,lineHeight:1.5}}>Questi dati appaiono nell'intestazione di ogni preventivo PDF</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:8,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>Compila tutto subito:</b> cosi ogni preventivo che generi ha gia tutti i dati corretti senza doverli inserire ogni volta</div>
              </div>
            </div>

            {/* CARD 24: MODULO PROBLEMI */}
            <div style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),overflow:"hidden"}}>
              <div style={{padding:"12px 16px",borderBottom:"1px solid "+(T.bdr||"#E5E3DE"),display:"flex",alignItems:"center",gap:8}}>
                <div style={{width:28,height:28,borderRadius:8,background:"#FF3B3015",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14}}>üö®</div>
                <div><div style={{fontSize:13,fontWeight:800,color:T.text}}>Segnalare un problema</div><div style={{fontSize:10,color:T.sub}}>‚è± 20 secondi</div></div>
              </div>
              <div style={{padding:"12px 16px"}}>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>1</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Apri una commessa ‚Äî tocca <b>üö® Segnala problema</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>2</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Scegli <b>tipo</b> (Materiale, Misure, Installazione...) e <b>priorit√†</b></div>
                </div>
                <div style={{display:"flex",gap:12,marginBottom:8}}>
                  <div style={{width:22,height:22,borderRadius:6,background:T.acc,color:"#fff",fontSize:11,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>3</div>
                  <div style={{fontSize:12,color:T.text,lineHeight:1.5}}>Descrivi il problema e <b>assegna</b> a un membro del team</div>
                </div>
                <div style={{fontSize:11,color:T.sub,marginTop:4,padding:"8px 10px",background:T.bg||"#f8f8f5",borderRadius:8}}>üí° <b>3 stati:</b> Aperto ‚Üí In corso ‚Üí Risolto. I problemi aperti appaiono nel widget <b>Attenzione</b> in Home</div>
              </div>
            </div>

            {/* RIVEDI TUTORIAL */}
            <div onClick={() => { try{localStorage.removeItem("mastro:onboarded")}catch(e){} setTutoStep(1); }} style={{background:"#fff",borderRadius:12,border:"1px solid "+(T.bdr||"#E5E3DE"),padding:"14px 16px",display:"flex",alignItems:"center",gap:10,cursor:"pointer"}}>
              <div style={{fontSize:18}}>üîÑ</div>
              <div>
                <div style={{fontSize:13,fontWeight:700,color:T.text}}>Rivedi il tutorial iniziale</div>
                <div style={{fontSize:11,color:T.sub}}>Riavvia la guida di benvenuto</div>
              </div>
              <div style={{marginLeft:"auto",fontSize:14,color:T.sub}}>‚Üí</div>
            </div>

            <div style={{height:20}}/>
          </div>
        )}

        {/* === üîÑ RESET DEMO === */}
        <div style={{ margin: "20px 0", padding: 16, background: "#ff3b3008", borderRadius: 12, border: "1px solid #ff3b3025" }}>
          <div style={{ fontSize: 11, fontWeight: 800, color: "#ff3b30", textTransform: "uppercase", marginBottom: 6 }}>üîÑ Zona Reset</div>
          <div style={{ fontSize: 11, color: T.sub, marginBottom: 10 }}>Ricarica i 4 clienti demo con tutti i dati precompilati per testare il flusso completo.</div>
          <button onClick={() => {
            if (!confirm("Vuoi ricaricare i dati demo? I dati attuali verranno sostituiti.")) return;
            ["cantieri","tasks","events","fatture","ordiniForn","montaggi","contatti","pipeline","azienda","team","settori","piano","colori","sistemi","vetri","coprifili","lamiere","libreria","squadre"].forEach(k => {
              try { localStorage.removeItem("mastro:" + k); } catch(e) {}
            });
            localStorage.removeItem("mastro:demoVer");
            localStorage.removeItem("mastro:cleanSlate");
            window.location.reload();
          }} style={{
            width: "100%", padding: 12, borderRadius: 10, border: "2px solid #ff3b30",
            background: "#fff", color: "#ff3b30", fontSize: 13, fontWeight: 800,
            cursor: "pointer", fontFamily: "inherit",
          }}>üîÑ RICARICA DATI DEMO (4 clienti)</button>

          <button onClick={() => {
            if (!confirm("‚ö†Ô∏è ATTENZIONE: Cancellare TUTTI i dati demo e partire da zero?\n\nCommesse, contatti, fatture, eventi, task ‚Äî tutto verr√† cancellato.\n\nI dati reali che hai inserito saranno persi.")) return;
            // Clear all data
            setCantieri([]);
            setFattureDB([]);
            setOrdiniFornDB([]);
            setMontaggiDB([]);
            setMsgs([]);
            setContatti([]);
            setEvents([]);
            setTasks([]);
            setAiInbox([]);
            setPipeline([]);
            setProblemi([]);
            // Save empty to localStorage + set cleanSlate flag
            ["cantieri","tasks","events","fatture","ordiniForn","montaggi","contatti","pipeline","msgs","problemi","fatturePassive","fornitori"].forEach(k => {
              try { localStorage.setItem("mastro:" + k, "[]"); } catch(e) {}
            });
            localStorage.setItem("mastro:cleanSlate", "true");
            localStorage.setItem("mastro:demoVer", "v50-gmail-email");
            alert("‚úÖ Dati puliti! MASTRO √® pronto per i tuoi dati reali.");
            window.location.reload();
          }} style={{
            width: "100%", padding: 12, borderRadius: 10, border: "2px solid #34c759",
            background: "#fff", color: "#34c759", fontSize: 13, fontWeight: 800,
            cursor: "pointer", fontFamily: "inherit", marginTop: 8,
          }}>üßπ PULISCI TUTTO ‚Äî Parti da zero</button>
        </div>

      </div>
    </div>
  );

// =======================================================
// MASTRO ERP v2 ‚Äî PARTE 5/5
// Righe 4131-5248: Modals (Task, Commessa, Vano, Allegati, Firma, AI Photo),
//                 Main Render finale
// =======================================================
  /* ======= MODALS ======= */
  const renderModal = () => {
    if (!showModal) return null;
    return (
      <div style={S.modal} onClick={e => e.target === e.currentTarget && setShowModal(null)}>
        <div style={S.modalInner}>
          {/* TASK MODAL */}
          {/* === MODAL MANDA MAIL === */}
          {showMailModal && (
            <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.55)", zIndex:500, display:"flex", alignItems:"flex-end", justifyContent:"center" }}
              onClick={e => e.target === e.currentTarget && setShowMailModal(null)}>
              <div style={{ background:T.bg, borderRadius:"20px 20px 0 0", width:"100%", maxWidth:480, maxHeight:"85vh", overflow:"auto", paddingBottom:24 }}>
                {/* Header */}
                <div style={{ padding:"16px 16px 10px", display:"flex", alignItems:"center", gap:10, position:"sticky", top:0, background:T.bg, zIndex:1, borderBottom:`1px solid ${T.bdr}` }}>
                  <span style={{ fontSize:22 }}>‚úâÔ∏è</span>
                  <div style={{ flex:1 }}>
                    <div style={{ fontSize:15, fontWeight:800, color:T.text }}>Manda Mail</div>
                    <div style={{ fontSize:11, color:T.sub }}>
                      {showMailModal.cm ? `${showMailModal.cm.cliente} ${showMailModal.cm.cognome||""}`.trim() : showMailModal.ev.persona || "Cliente"}
                      {showMailModal.cm?.email ? ` ¬∑ ${showMailModal.cm.email}` : ""}
                    </div>
                  </div>
                  <div onClick={() => setShowMailModal(null)} style={{ width:30, height:30, borderRadius:"50%", background:T.bdr, display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", fontSize:16, color:T.sub }}>√ó</div>
                </div>

                <div style={{ padding:"14px 16px" }}>
                  {/* Info evento */}
                  <div style={{ background:T.accLt, borderRadius:10, padding:"10px 12px", marginBottom:12, borderLeft:`3px solid ${T.acc}` }}>
                    <div style={{ fontSize:12, fontWeight:700, color:T.acc, marginBottom:2 }}>{showMailModal.ev.text}</div>
                    <div style={{ fontSize:11, color:T.sub }}>
                      {new Date(showMailModal.ev.date).toLocaleDateString("it-IT", { weekday:"short", day:"numeric", month:"short" })}
                      {showMailModal.ev.time ? " ¬∑ " + showMailModal.ev.time : ""}
                      {showMailModal.ev.addr ? " ¬∑ üìç " + showMailModal.ev.addr : ""}
                    </div>
                  </div>

                  {/* Campo email destinatario */}
                  {!showMailModal.cm?.email && (
                    <div style={{ marginBottom:10 }}>
                      <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>Email destinatario</div>
                      <input
                        type="email" placeholder="cliente@email.com"
                        style={{ width:"100%", padding:"9px 12px", borderRadius:8, border:`1px solid ${T.bdr}`, background:T.card, fontSize:13, color:T.text, fontFamily:"inherit", boxSizing:"border-box" as any }}
                        onChange={e => {
                          const v = e.target.value;
                          setShowMailModal(prev => prev ? { ...prev, emailOverride: v } : prev);
                        }}
                      />
                    </div>
                  )}

                  {/* Testo mail modificabile */}
                  <div style={{ marginBottom:12 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>Testo della mail</div>
                    <textarea
                      value={mailBody}
                      onChange={e => setMailBody(e.target.value)}
                      rows={10}
                      style={{ width:"100%", padding:"10px 12px", borderRadius:8, border:`1px solid ${T.bdr}`, background:T.card, fontSize:12, color:T.text, fontFamily:"inherit", resize:"vertical" as any, boxSizing:"border-box" as any, lineHeight:1.6 }}
                    />
                  </div>

                  {/* Template rapidi */}
                  <div style={{ marginBottom:14 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Template rapidi</div>
                    <div style={{ display:"flex", gap:6, flexWrap:"wrap" }}>
                      {[
                        { lbl:"üìÖ Conferma", tpl: `Gentile Cliente,

Le confermo l'appuntamento del ${new Date(showMailModal.ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" })}${showMailModal.ev.time ? " alle " + showMailModal.ev.time : ""}.

üìç ${showMailModal.ev.addr || "Luogo da concordare"}

Cordiali saluti,
Fabio Cozza - Walter Cozza Serramenti` },
                        { lbl:"‚è∞ Reminder", tpl: `Gentile Cliente,

Le ricordiamo che domani, ${new Date(showMailModal.ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" })}${showMailModal.ev.time ? " alle " + showMailModal.ev.time : ""}, √® previsto il nostro appuntamento.

üìç ${showMailModal.ev.addr || "Luogo da concordare"}

In caso di impedimento la preghiamo di avvertirci il prima possibile.

Cordiali saluti,
Fabio Cozza - Walter Cozza Serramenti` },
                        { lbl:"‚úÖ Preventivo pronto", tpl: `Gentile Cliente,

Siamo lieti di comunicarle che il preventivo relativo alla fornitura e posa √® pronto.

Pu√≤ contattarci per concordare un incontro o richiedere il documento via mail.

Cordiali saluti,
Fabio Cozza - Walter Cozza Serramenti` },
                        { lbl:"üîß Posa confermata", tpl: `Gentile Cliente,

Confermiamo la data di posa in opera per il ${new Date(showMailModal.ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" })}${showMailModal.ev.time ? " a partire dalle " + showMailModal.ev.time : ""}.

La preghiamo di assicurarsi che i locali siano accessibili.

Cordiali saluti,
Fabio Cozza - Walter Cozza Serramenti` },
                      ].map(({ lbl, tpl }) => (
                        <div key={lbl} onClick={() => setMailBody(tpl)}
                          style={{ padding:"5px 10px", borderRadius:20, border:`1px solid ${T.bdr}`, background:T.card, fontSize:11, fontWeight:600, color:T.text, cursor:"pointer" }}>
                          {lbl}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Bottoni azione */}
                  <div style={{ display:"flex", gap:8 }}>
                    <div
                      onClick={() => {
                        const dest = (showMailModal as any).emailOverride || showMailModal.cm?.email || "";
                        const sogg = encodeURIComponent(`Appuntamento - ${showMailModal.ev.text}`);
                        const corpo = encodeURIComponent(mailBody);
                        window.open(`mailto:${dest}?subject=${sogg}&body=${corpo}`);
                      }}
                      style={{ flex:1, padding:"12px", borderRadius:10, background:T.acc, color:"#fff", textAlign:"center", cursor:"pointer", fontSize:13, fontWeight:700 }}>
                      ‚úâÔ∏è Apri in Mail
                    </div>
                    <div
                      onClick={() => {
                        navigator.clipboard?.writeText(mailBody);
                        alert("Testo copiato negli appunti!");
                      }}
                      style={{ padding:"12px 14px", borderRadius:10, background:T.bg, border:`1px solid ${T.bdr}`, color:T.sub, cursor:"pointer", fontSize:13, fontWeight:600 }}>
                      üìã Copia
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* === EMAIL COMPOSER MODAL === */}
          {showEmailComposer && (
            <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.55)", zIndex:500, display:"flex", alignItems:"flex-end", justifyContent:"center" }}
              onClick={e => e.target === e.currentTarget && setShowEmailComposer(null)}>
              <div style={{ background:T.card, borderRadius:"20px 20px 0 0", width:"100%", maxWidth:500, maxHeight:"90vh", overflow:"auto", paddingBottom:24 }}>
                {/* Header */}
                <div style={{ padding:"16px 16px 10px", display:"flex", alignItems:"center", gap:10, position:"sticky", top:0, background:T.card, zIndex:1, borderBottom:`1px solid ${T.bdr}` }}>
                  <span style={{ fontSize:22 }}>‚úâÔ∏è</span>
                  <div style={{ flex:1 }}>
                    <div style={{ fontSize:15, fontWeight:800, color:T.text }}>Componi Email</div>
                    <div style={{ fontSize:11, color:T.sub }}>{showEmailComposer.cm?.code} ‚Äî {showEmailComposer.cm?.cliente} {showEmailComposer.cm?.cognome||""}</div>
                  </div>
                  <div onClick={() => setShowEmailComposer(null)} style={{ width:30, height:30, borderRadius:"50%", background:T.bdr, display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", fontSize:16, color:T.sub }}>√ó</div>
                </div>
                <div style={{ padding:"14px 16px" }}>
                  {/* Template selector */}
                  <div style={{ display:"flex", gap:4, marginBottom:12, flexWrap:"wrap" }}>
                    {[
                      { id: "preventivo", l: "üìÑ Preventivo", c: "#007aff" },
                      { id: "conferma", l: "‚úÖ Conferma", c: "#34c759" },
                      { id: "montaggio", l: "üîß Montaggio", c: "#5856d6" },
                      { id: "saldo", l: "üí∂ Saldo", c: "#ff9500" },
                      { id: "generico", l: "‚úèÔ∏è Libero", c: "#86868b" },
                    ].map(t => (
                      <div key={t.id} onClick={() => inviaEmail(showEmailComposer.cm, t.id)}
                        style={{ padding:"6px 12px", borderRadius:20, border:`1.5px solid ${showEmailComposer.tipo === t.id ? t.c : t.c+"40"}`, background: showEmailComposer.tipo === t.id ? t.c+"15" : "transparent", fontSize:11, fontWeight:700, color:t.c, cursor:"pointer" }}>
                        {t.l}
                      </div>
                    ))}
                  </div>

                  {/* Destinatario */}
                  <div style={{ marginBottom:10 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", marginBottom:4 }}>A:</div>
                    <input value={emailDest} onChange={e => setEmailDest(e.target.value)} placeholder="email@cliente.it"
                      style={{ width:"100%", padding:"9px 12px", borderRadius:8, border:`1px solid ${T.bdr}`, background:T.bg, fontSize:13, color:T.text, fontFamily:"inherit", boxSizing:"border-box" as any }} />
                  </div>
                  {/* Oggetto */}
                  <div style={{ marginBottom:10 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", marginBottom:4 }}>Oggetto:</div>
                    <input value={emailOggetto} onChange={e => setEmailOggetto(e.target.value)}
                      style={{ width:"100%", padding:"9px 12px", borderRadius:8, border:`1px solid ${T.bdr}`, background:T.bg, fontSize:13, color:T.text, fontFamily:"inherit", boxSizing:"border-box" as any }} />
                  </div>
                  {/* Corpo */}
                  <div style={{ marginBottom:14 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", marginBottom:4 }}>Messaggio:</div>
                    <textarea value={emailCorpo} onChange={e => setEmailCorpo(e.target.value)} rows={14}
                      style={{ width:"100%", padding:"10px 12px", borderRadius:8, border:`1px solid ${T.bdr}`, background:T.bg, fontSize:12, color:T.text, fontFamily:"inherit", resize:"vertical" as any, boxSizing:"border-box" as any, lineHeight:1.6 }} />
                  </div>

                  {/* Bottoni invio */}
                  <div style={{ display:"flex", gap:8 }}>
                    <div onClick={() => {
                      window.open(`mailto:${emailDest}?subject=${encodeURIComponent(emailOggetto)}&body=${encodeURIComponent(emailCorpo)}`);
                    }} style={{ flex:1, padding:12, borderRadius:10, background:"#007aff", color:"#fff", textAlign:"center", cursor:"pointer", fontSize:13, fontWeight:700 }}>
                      ‚úâÔ∏è Apri in Mail
                    </div>
                    <div onClick={() => {
                      window.open(`https://mail.google.com/mail/?view=cm&to=${emailDest}&su=${encodeURIComponent(emailOggetto)}&body=${encodeURIComponent(emailCorpo)}`, "_blank");
                    }} style={{ flex:1, padding:12, borderRadius:10, background:"#ea4335", color:"#fff", textAlign:"center", cursor:"pointer", fontSize:13, fontWeight:700 }}>
                      Gmail
                    </div>
                    <div onClick={() => {
                      const tel = (showEmailComposer.cm?.telefono||"").replace(/\D/g,"");
                      const t = tel.startsWith("39") ? tel : "39" + tel;
                      window.open(`https://wa.me/${t}?text=${encodeURIComponent(emailCorpo)}`, "_blank");
                    }} style={{ padding:12, borderRadius:10, background:"#25d366", color:"#fff", textAlign:"center", cursor:"pointer", fontSize:13, fontWeight:700 }}>
                      üí¨
                    </div>
                  </div>
                  <div onClick={() => { navigator.clipboard?.writeText(emailCorpo); alert("Copiato!"); }}
                    style={{ marginTop:8, padding:10, borderRadius:8, background:T.bg, border:`1px solid ${T.bdr}`, textAlign:"center", cursor:"pointer", fontSize:12, fontWeight:600, color:T.sub }}>
                    üìã Copia testo
                  </div>
                </div>
              </div>
            </div>
          )}

          {showModal === "task" && (
            <>
              <div style={S.modalTitle}>Nuovo task</div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Cosa devi fare?</label>
                <input style={S.input} placeholder="es. Sopralluogo, chiamare fornitore..." value={newTask.text} onChange={e => setNewTask(t => ({ ...t, text: e.target.value }))} />
              </div>
              <div style={{ display: "flex", gap: 10, marginBottom: 14 }}>
                <div style={{ flex: 1 }}>
                  <label style={S.fieldLabel}>Data</label>
                  <input style={S.input} type="date" value={newTask.date} onChange={e => setNewTask(t => ({ ...t, date: e.target.value }))} />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={S.fieldLabel}>Ora (opz.)</label>
                  <input style={S.input} type="time" value={newTask.time} onChange={e => setNewTask(t => ({ ...t, time: e.target.value }))} />
                </div>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Priorit√†</label>
                <div style={{ display: "flex", gap: 6 }}>
                  {[{ id: "alta", l: "Urgente", c: T.red }, { id: "media", l: "Normale", c: T.orange }, { id: "bassa", l: "Bassa", c: T.sub }].map(p => (
                    <div key={p.id} onClick={() => setNewTask(t => ({ ...t, priority: p.id }))} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${newTask.priority === p.id ? p.c : T.bdr}`, background: newTask.priority === p.id ? p.c + "18" : "transparent", color: p.c, fontSize: 12, fontWeight: 600, cursor: "pointer" }}>
                      {p.l}
                    </div>
                  ))}
                </div>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Collega a commessa (opzionale)</label>
                <select style={S.select} value={newTask.cm} onChange={e => setNewTask(t => ({ ...t, cm: e.target.value }))}>
                  <option value="">‚Äî Nessuna ‚Äî</option>
                  {cantieri.map(c => <option key={c.id} value={c.code}>{c.code} ¬∑ {c.cliente}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Assegna a persona (opzionale)</label>
                <select style={S.select} value={newTask.persona} onChange={e => setNewTask(t => ({ ...t, persona: e.target.value }))}>
                  <option value="">‚Äî Nessuno ‚Äî</option>
                  {[...contatti.filter(ct => ct.tipo === "cliente"), ...team].map(m => <option key={m.id} value={m.nome}>{m.nome}{(m as any).ruolo ? " ‚Äî " + (m as any).ruolo : ""}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Note (opzionale)</label>
                <input style={S.input} placeholder="Dettagli, materiale da portare..." value={newTask.meta} onChange={e => setNewTask(t => ({ ...t, meta: e.target.value }))} />
              </div>
              {/* Task Allegati */}
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Allegati</label>
                <div style={{ display: "flex", gap: 6 }}>
                  {[
                    { ico: "üìé", l: "File", act: () => setTaskAllegati(a => [...a, { id: Date.now(), tipo: "file", nome: "Allegato_" + (a.length + 1) }]) },
                    { ico: "üìù", l: "Nota", act: () => { let txt; try{txt=window.prompt("Nota:");}catch(e){} if (txt) setTaskAllegati(a => [...a, { id: Date.now(), tipo: "nota", nome: txt }]); }},
                    { ico: "üé§", l: "Audio", act: () => setTaskAllegati(a => [...a, { id: Date.now(), tipo: "vocale", nome: "Audio " + (a.length + 1) }]) },
                    { ico: "üì∑", l: "Foto", act: () => setTaskAllegati(a => [...a, { id: Date.now(), tipo: "foto", nome: "Foto " + (a.length + 1) }]) },
                  ].map((b, i) => (
                    <div key={i} onClick={b.act} style={{ flex: 1, padding: "8px 4px", background: T.bg, borderRadius: 8, border: `1px solid ${T.bdr}`, textAlign: "center", cursor: "pointer" }}>
                      <div style={{ fontSize: 16 }}>{b.ico}</div>
                      <div style={{ fontSize: 9, fontWeight: 600, color: T.sub, marginTop: 1 }}>{b.l}</div>
                    </div>
                  ))}
                </div>
                {taskAllegati.length > 0 && (
                  <div style={{ marginTop: 6, display: "flex", flexWrap: "wrap", gap: 4 }}>
                    {taskAllegati.map(a => (
                      <div key={a.id} style={{ display: "flex", alignItems: "center", gap: 4, padding: "3px 8px", borderRadius: 6, background: T.bg, border: `1px solid ${T.bdr}`, fontSize: 10 }}>
                        <span>{a.tipo === "nota" ? "üìù" : a.tipo === "vocale" ? "üé§" : a.tipo === "foto" ? "üì∑" : "üìé"}</span>
                        <span style={{ color: T.text, maxWidth: 80, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{a.nome}</span>
                        <span onClick={() => setTaskAllegati(al => al.filter(x => x.id !== a.id))} style={{ cursor: "pointer", color: T.red }}>‚úï</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <button style={S.btn} onClick={addTask}>Crea task</button>
              <button style={S.btnCancel} onClick={() => setShowModal(null)}>Annulla</button>
            </>
          )}

          {/* COMMESSA MODAL */}
          {showModal === "contatto" && (
            <div style={{ padding: "20px 0" }}>
              <div style={S.modalTitle}>Nuovo cliente</div>
              <div style={{ marginBottom: 12 }}><label style={S.fieldLabel}>Nome *</label>
                <input style={S.input} placeholder="Nome" value={(newCM as any)._ctNome || ""} onChange={e => setNewCM(p => ({ ...p, _ctNome: e.target.value } as any))} /></div>
              <div style={{ marginBottom: 12 }}><label style={S.fieldLabel}>Cognome</label>
                <input style={S.input} placeholder="Cognome" value={(newCM as any)._ctCognome || ""} onChange={e => setNewCM(p => ({ ...p, _ctCognome: e.target.value } as any))} /></div>
              <div style={{ marginBottom: 12 }}><label style={S.fieldLabel}>Telefono</label>
                <input style={S.input} type="tel" placeholder="333 1234567" value={(newCM as any)._ctTel || ""} onChange={e => setNewCM(p => ({ ...p, _ctTel: e.target.value } as any))} /></div>
              <div style={{ marginBottom: 12 }}><label style={S.fieldLabel}>Email</label>
                <input style={S.input} type="email" placeholder="nome@email.it" value={(newCM as any)._ctEmail || ""} onChange={e => setNewCM(p => ({ ...p, _ctEmail: e.target.value } as any))} /></div>
              <div style={{ marginBottom: 12 }}><label style={S.fieldLabel}>Indirizzo</label>
                <input style={S.input} placeholder="Via Roma 12, Cosenza" value={(newCM as any)._ctAddr || ""} onChange={e => setNewCM(p => ({ ...p, _ctAddr: e.target.value } as any))} /></div>
              <div onClick={() => {
                const nome = ((newCM as any)._ctNome || "").trim();
                if (!nome) return;
                setContatti(prev => [...prev, { id: "CT-" + Date.now(), nome, cognome: (newCM as any)._ctCognome || "", tipo: "cliente", telefono: (newCM as any)._ctTel || "", email: (newCM as any)._ctEmail || "", indirizzo: (newCM as any)._ctAddr || "", preferito: false }]);
                setNewCM({ cliente: "", indirizzo: "", telefono: "", sistema: "", tipo: "nuova" });
                setShowModal(null);
              }} style={{ padding: "14px", borderRadius: 12, background: `linear-gradient(135deg, ${T.acc}, #b86e06)`, color: "#fff", textAlign: "center", fontWeight: 800, fontSize: 15, cursor: "pointer" }}>
                Salva cliente ‚úì
              </div>
            </div>
          )}

          {showModal === "commessa" && (
            <>
              <div style={S.modalTitle}>Nuova commessa</div>
              <div style={{ display: "flex", gap: 6, marginBottom: 18 }}>
                {[{ id: "nuova", l: "üÜï Nuova installazione", c: T.acc }, { id: "riparazione", l: "üîß Riparazione", c: T.orange }].map(t => (
                  <div key={t.id} onClick={() => { setNewCM(c => ({ ...c, tipo: t.id })); setRipSearch(""); setRipCMSel(null); setRipProblema(""); setRipFotos([]); setRipUrgenza("media"); }}
                    style={{ flex: 1, padding: "12px 6px", borderRadius: 12, border: `2px solid ${newCM.tipo === t.id ? (t.id==="nuova"?T.acc:T.orange) : T.bdr}`, background: newCM.tipo === t.id ? (t.id==="nuova"?T.acc:T.orange)+"12" : T.card, textAlign: "center", cursor: "pointer", transition:"all 0.15s" }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: newCM.tipo === t.id ? (t.id==="nuova"?T.acc:T.orange) : T.sub }}>{t.l}</div>
                  </div>
                ))}
              </div>

              {/* == FLUSSO RIPARAZIONE == */}
              {newCM.tipo === "riparazione" && (() => {
                const addRipFoto = (e) => {
                  const file = e.target.files?.[0]; if(!file) return;
                  const r = new FileReader();
                  r.onload = ev => setRipFotos(fs => [...fs, { id: Date.now(), dataUrl: ev.target.result, nome: file.name }]);
                  r.readAsDataURL(file); e.target.value = "";
                };
                const cmResults = ripSearch.length > 1
                  ? cantieri.filter(c => c.cliente.toLowerCase().includes(ripSearch.toLowerCase()) || c.code.toLowerCase().includes(ripSearch.toLowerCase()) || c.indirizzo.toLowerCase().includes(ripSearch.toLowerCase()))
                  : [];
                const addRiparazione = () => {
                  if (!ripProblema.trim()) return;
                  const code = "CM-" + String(cantieri.length + 1).padStart(4, "0");
                  const nuova = {
                    id: Date.now(), code,
                    cliente: ripCMSel ? ripCMSel.cliente : (newCM.cliente || ripSearch),
                    indirizzo: newCM.indirizzo || ripCMSel?.indirizzo || "",
                    telefono: newCM.telefono || ripCMSel?.telefono || "",
                    sistema: ripCMSel?.sistema || "",
                    tipo: "riparazione", fase: "sopralluogo",
                    cmCollegata: ripCMSel?.code || null,
                    problema: ripProblema,
                    tipoProblema: newCM.tipoProblema || "",
                    tipoInfisso: newCM.tipoInfisso || "",
                    vanoProblema: newCM.vanoProblema || "",
                    dataRichiesta: newCM.dataRichiesta || "",
                    chiSegnala: newCM.chiSegnala || "",
                    preventivoStimato: newCM.preventivoStimato || "",
                    urgenza: ripUrgenza,
                    fotoProblema: ripFotos,
                    vani: ripCMSel?.vani || [], note: ripProblema,
                    alert: ripUrgenza === "urgente" ? "‚ö†Ô∏è Riparazione urgente" : null,
                    creato: new Date().toLocaleDateString("it-IT", {day:"numeric",month:"short"}),
                    aggiornato: new Date().toLocaleDateString("it-IT", {day:"numeric",month:"short"}),
                    allegati: [],
                  };
                  setCantieri(cs => [nuova, ...cs]);
                  setRipSearch(""); setRipCMSel(null); setRipProblema(""); setRipFotos([]); setRipUrgenza("media");
                  setNewCM(c => ({...c, tipo:"nuova", cliente:"", indirizzo:"", telefono:"", tipoProblema:"", tipoInfisso:"", vanoProblema:"", dataRichiesta:"", chiSegnala:"", preventivoStimato:""}));
                  setShowModal(null);
                  setSelectedCM(nuova); setTab("commesse");
                };
                return (
                  <div style={{ display:"flex", flexDirection:"column", gap:14 }}>

                    <div>
                      <label style={S.fieldLabel}>Cliente o commessa esistente</label>
                      <input style={S.input} placeholder="Cerca nome, codice CM, indirizzo‚Ä¶"
                        value={ripSearch} onChange={e => { setRipSearch(e.target.value); if(ripCMSel) setRipCMSel(null); }}/>
                      {/* Rubrica button when empty */}
                      {!ripSearch && !ripCMSel && (
                        <div onClick={() => setRipSearch(" ")} style={{ margin:"6px 0", padding:"8px 12px", borderRadius:8, border:"1.5px dashed "+T.acc+"60", background:T.acc+"06", cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:6 }}>
                          <span style={{ fontSize:14 }}>üìí</span>
                          <span style={{ fontSize:11, fontWeight:700, color:T.acc }}>Scegli dalla rubrica</span>
                        </div>
                      )}
                      {/* Contatti rubrica results */}
                      {ripSearch.length >= 1 && !ripCMSel && (() => {
                        const qr = ripSearch.trim().toLowerCase();
                        const ctMatches = qr.length > 0
                          ? contatti.filter(ct => ct.tipo === "cliente" && (ct.nome?.toLowerCase().includes(qr) || (ct.cognome||"").toLowerCase().includes(qr))).slice(0, 5)
                          : contatti.filter(ct => ct.tipo === "cliente").slice(0, 8);
                        if (ctMatches.length === 0 && cmResults.length === 0) return null;
                        return ctMatches.length > 0 && cmResults.length === 0 ? (
                          <div style={{ marginTop:4, background:T.card, border:"1.5px solid "+T.acc+"40", borderRadius:10, overflow:"hidden", maxHeight:200, overflowY:"auto" }}>
                            <div style={{ padding:"5px 10px", fontSize:9, fontWeight:700, color:T.acc, background:T.acc+"08", borderBottom:"1px solid "+T.acc+"20" }}>üìí Rubrica ({ctMatches.length})</div>
                            {ctMatches.map(ct => (
                              <div key={ct.id} onClick={() => { setRipSearch(ct.nome + " " + (ct.cognome||"")); setNewCM(x=>({...x, cliente: ct.nome, cognome: ct.cognome||"", indirizzo: ct.indirizzo||"", telefono: ct.telefono||"", email: ct.email||"" })); }}
                                style={{ padding:"8px 12px", borderBottom:"1px solid "+T.bdr+"40", cursor:"pointer", display:"flex", alignItems:"center", gap:8 }}>
                                <span style={{ fontSize:14 }}>üìí</span>
                                <div style={{ flex:1 }}>
                                  <div style={{ fontSize:12, fontWeight:700 }}>{ct.nome} {ct.cognome||""}</div>
                                  <div style={{ fontSize:9, color:T.sub }}>{ct.telefono} {ct.indirizzo ? "¬∑ "+ct.indirizzo : ""}</div>
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : null;
                      })()}
                      {cmResults.length > 0 && !ripCMSel && (
                        <div style={{ marginTop:4, background:T.card, border:`1px solid ${T.bdr}`, borderRadius:10, overflow:"hidden" }}>
                          {cmResults.slice(0,4).map(c => (
                            <div key={c.id} onClick={() => { setRipCMSel(c); setRipSearch(c.cliente); setNewCM(x=>({...x,indirizzo:c.indirizzo,telefono:c.telefono})); }}
                              style={{ padding:"10px 14px", borderBottom:`1px solid ${T.bg}`, cursor:"pointer", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                              <div>
                                <div style={{ fontSize:13, fontWeight:700, color:T.text }}>{c.cliente}</div>
                                <div style={{ fontSize:11, color:T.sub, marginTop:1 }}>{c.code} ¬∑ {c.indirizzo}</div>
                                {getVaniAttivi(c).length>0 && <div style={{ fontSize:10, color:T.sub }}>{getVaniAttivi(c).length} vani</div>}
                              </div>
                              <div style={{ fontSize:10, fontWeight:600, color:T.acc }}>Collega ‚Üí</div>
                            </div>
                          ))}
                        </div>
                      )}
                      {ripCMSel && (
                        <div style={{ marginTop:6, padding:"8px 12px", background:T.accLt, border:`1px solid ${T.acc}30`, borderRadius:8, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                          <div>
                            <div style={{ fontSize:12, fontWeight:700, color:T.acc }}>‚úì Collegata a {ripCMSel.code}</div>
                            <div style={{ fontSize:11, color:T.sub, marginTop:1 }}>{ripCMSel.cliente} ¬∑ {ripCMSel.indirizzo}</div>
                          </div>
                          <div onClick={() => { setRipCMSel(null); setRipSearch(""); setNewCM(x=>({...x,indirizzo:"",telefono:""})); }} style={{ fontSize:14, color:T.sub, cursor:"pointer", padding:4 }}>‚úï</div>
                        </div>
                      )}
                      {!ripCMSel && (
                        <div style={{ fontSize:10, color:T.sub, marginTop:3 }}>Lascia vuoto per cliente nuovo</div>
                      )}
                    </div>

                    {!ripCMSel && (
                      <div style={{ padding:"12px", background:T.bg, borderRadius:10, border:`1px solid ${T.bdr}`, display:"flex", flexDirection:"column", gap:8 }}>
                        <div style={{ fontSize:10, fontWeight:700, color:T.sub, textTransform:"uppercase", letterSpacing:"0.06em" }}>Dati cliente nuovo</div>
                        <input style={S.input} placeholder="Nome e cognome" value={newCM.cliente} onChange={e=>setNewCM(c=>({...c,cliente:e.target.value}))}/>
                        <div style={{ display:"flex", gap:8 }}>
                          <input style={{...S.input,flex:2}} placeholder="Indirizzo" value={newCM.indirizzo} onChange={e=>setNewCM(c=>({...c,indirizzo:e.target.value}))}/>
                          <input style={{...S.input,flex:1}} placeholder="Telefono" value={newCM.telefono} onChange={e=>setNewCM(c=>({...c,telefono:e.target.value}))}/>
                        </div>
                      </div>
                    )}

                    <div>
                      <label style={S.fieldLabel}>Urgenza</label>
                      <div style={{ display:"flex", gap:6 }}>
                        {[{id:"normale",l:"Normale",c:T.grn,e:"üü¢"},{id:"media",l:"Media",c:T.orange,e:"üü°"},{id:"urgente",l:"Urgente",c:T.red,e:"üî¥"}].map(u => (
                          <div key={u.id} onClick={() => setRipUrgenza(u.id)}
                            style={{ flex:1, padding:"8px 4px", borderRadius:8, border:`1.5px solid ${ripUrgenza===u.id?u.c:T.bdr}`, background:ripUrgenza===u.id?u.c+"15":T.card, textAlign:"center", cursor:"pointer", transition:"all 0.12s" }}>
                            <div style={{ fontSize:14 }}>{u.e}</div>
                            <div style={{ fontSize:10, fontWeight:700, color:ripUrgenza===u.id?u.c:T.sub, marginTop:2 }}>{u.l}</div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Tipo problema</label>
                      <div style={{ display:"flex", flexWrap:"wrap", gap:5 }}>
                        {["Vetro rotto","Cardine","Guarnizione","Serratura","Maniglia","Tapparella","Infiltrazioni","Deformazione","Altro"].map(t => (
                          <div key={t} onClick={() => setNewCM(c=>({...c,tipoProblema:c.tipoProblema===t?"":t}))}
                            style={{ padding:"5px 10px", borderRadius:20, border:`1.5px solid ${newCM.tipoProblema===t?T.orange:T.bdr}`, background:newCM.tipoProblema===t?T.orangeLt:T.card, fontSize:11, fontWeight:600, color:newCM.tipoProblema===t?T.orange:T.sub, cursor:"pointer", transition:"all 0.12s" }}>
                            {t}
                          </div>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Tipo infisso</label>
                      <div style={{ display:"flex", flexWrap:"wrap", gap:5 }}>
                        {["Finestra","Porta","Portafinestra","Scorrevole","Tapparella","Persiana","Zanzariera","Altro"].map(t => (
                          <div key={t} onClick={() => setNewCM(c=>({...c,tipoInfisso:c.tipoInfisso===t?"":t}))}
                            style={{ padding:"5px 10px", borderRadius:20, border:`1.5px solid ${newCM.tipoInfisso===t?T.acc:T.bdr}`, background:newCM.tipoInfisso===t?T.accLt:T.card, fontSize:11, fontWeight:600, color:newCM.tipoInfisso===t?T.acc:T.sub, cursor:"pointer", transition:"all 0.12s" }}>
                            {t}
                          </div>
                        ))}
                      </div>
                    </div>

                    {ripCMSel && getVaniAttivi(ripCMSel).length > 0 && (
                      <div>
                        <label style={S.fieldLabel}>Vano con il problema</label>
                        <div style={{ display:"flex", flexWrap:"wrap", gap:5 }}>
                          {getVaniAttivi(ripCMSel).map(v => (
                            <div key={v.id} onClick={() => setNewCM(c=>({...c,vanoProblema:c.vanoProblema===v.nome?"":v.nome}))}
                              style={{ padding:"5px 10px", borderRadius:20, border:`1.5px solid ${newCM.vanoProblema===v.nome?T.acc:T.bdr}`, background:newCM.vanoProblema===v.nome?T.accLt:T.card, fontSize:11, fontWeight:600, color:newCM.vanoProblema===v.nome?T.acc:T.sub, cursor:"pointer" }}>
                              {v.nome}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    <div>
                      <label style={S.fieldLabel}>Descrizione problema *</label>
                      <textarea style={{ ...S.input, minHeight:70, resize:"vertical" }}
                        placeholder="Descrivi il problema in dettaglio‚Ä¶"
                        value={ripProblema} onChange={e => setRipProblema(e.target.value)}/>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Chi segnala</label>
                      <div style={{ display:"flex", flexWrap:"wrap", gap:5 }}>
                        {["Cliente","Posatore","Tecnico","Subappaltatore","Altro"].map(t => (
                          <div key={t} onClick={() => setNewCM(c=>({...c,chiSegnala:c.chiSegnala===t?"":t}))}
                            style={{ padding:"5px 10px", borderRadius:20, border:`1.5px solid ${newCM.chiSegnala===t?T.acc:T.bdr}`, background:newCM.chiSegnala===t?T.accLt:T.card, fontSize:11, fontWeight:600, color:newCM.chiSegnala===t?T.acc:T.sub, cursor:"pointer" }}>
                            {t}
                          </div>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Data richiesta intervento</label>
                      <input type="date" style={S.input} value={newCM.dataRichiesta} onChange={e=>setNewCM(c=>({...c,dataRichiesta:e.target.value}))}/>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Preventivo stimato (‚Ç¨)</label>
                      <input style={S.input} type="number" inputMode="numeric" placeholder="es. 250" value={newCM.preventivoStimato} onChange={e=>setNewCM(c=>({...c,preventivoStimato:e.target.value}))}/>
                    </div>

                    <div>
                      <label style={S.fieldLabel}>Foto del problema ({ripFotos.length})</label>
                      {ripFotos.length === 0
                        ? <div onClick={() => ripFotoRef.current?.click()}
                            style={{ border:`1.5px dashed ${T.bdr}`, borderRadius:10, padding:"20px", textAlign:"center", cursor:"pointer" }}>
                            <div style={{ fontSize:28, marginBottom:4 }}>üì∑</div>
                            <div style={{ fontSize:12, color:T.sub }}>Scatta o allega una foto</div>
                            <div style={{ fontSize:10, color:T.sub2||T.sub, marginTop:2 }}>Puoi aggiungerne quante vuoi</div>
                          </div>
                        : <div>
                            <div style={{ display:"flex", gap:6, flexWrap:"wrap", marginBottom:8 }}>
                              {ripFotos.map((f,i) => (
                                <div key={f.id} style={{ position:"relative", width:76, height:76, borderRadius:10, overflow:"hidden", background:T.bg }}>
                                  <img src={f.dataUrl} style={{ width:"100%", height:"100%", objectFit:"cover" }} alt={`Foto ${i+1}`}/>
                                  <div onClick={() => setRipFotos(fs => fs.filter(x => x.id !== f.id))}
                                    style={{ position:"absolute", top:3, right:3, width:20, height:20, borderRadius:"50%", background:"rgba(0,0,0,0.55)", color:"#fff", fontSize:11, display:"flex", alignItems:"center", justifyContent:"center", cursor:"pointer", fontWeight:700 }}>‚úï</div>
                                  <div style={{ position:"absolute", bottom:2, left:4, fontSize:9, color:"#fff", fontWeight:700, textShadow:"0 1px 2px rgba(0,0,0,0.7)" }}>#{i+1}</div>
                                </div>
                              ))}
                              {/* FIX: usa ref invece di getElementById */}
                              <div onClick={() => ripFotoRef.current?.click()}
                                style={{ width:76, height:76, borderRadius:10, border:`1.5px dashed ${T.bdr}`, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", cursor:"pointer", color:T.sub }}>
                                <div style={{ fontSize:22 }}>+</div>
                                <div style={{ fontSize:9, fontWeight:600 }}>Aggiungi</div>
                              </div>
                            </div>
                          </div>
                      }
                      <input ref={ripFotoRef} type="file" accept="image/*" capture="environment" style={{ display:"none" }} onChange={addRipFoto}/>
                    </div>

                    <div style={{ paddingTop:4 }}>
                      {!ripProblema.trim() && (
                        <div style={{ fontSize:11, color:T.orange, fontWeight:600, marginBottom:8, textAlign:"center" }}>‚ö†Ô∏è Descrivi il problema per procedere</div>
                      )}
                      <button style={{ ...S.btn, background:ripProblema.trim()?T.orange:"#ccc", cursor:ripProblema.trim()?"pointer":"not-allowed" }}
                        onClick={addRiparazione} disabled={!ripProblema.trim()}>
                        üîß Crea riparazione
                      </button>
                      <button style={S.btnCancel} onClick={() => setShowModal(null)}>Annulla</button>
                    </div>

                  </div>
                );
              })()}

              {/* == FLUSSO NUOVA INSTALLAZIONE == */}
              {newCM.tipo === "nuova" && (() => {
                const AccordionSection = ({ id, icon, label, badge, children }) => {
                  const open = newCM._open === id;
                  return (
                    <div style={{ marginBottom:8, borderRadius:10, border:`1px solid ${T.bdr}`, overflow:"hidden" }}>
                      <div onClick={() => setNewCM(c=>({...c,_open:open?null:id}))}
                        style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"11px 14px", background:T.card, cursor:"pointer" }}>
                        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                          <span style={{ fontSize:16 }}>{icon}</span>
                          <span style={{ fontSize:13, fontWeight:600, color:T.text }}>{label}</span>
                          {badge && <span style={{ ...S.badge(T.accLt,T.acc), fontSize:10 }}>{badge}</span>}
                        </div>
                        <span style={{ fontSize:12, color:T.sub, transition:"transform 0.2s", display:"inline-block", transform:open?"rotate(180deg)":"rotate(0deg)" }}>‚ñº</span>
                      </div>
                      {open && <div style={{ padding:"12px 14px", background:T.bg, borderTop:`1px solid ${T.bdr}` }}>{children}</div>}
                    </div>
                  );
                };

                const previewCode = "S-" + String(cantieri.length + 1).padStart(4,"0");

                return (
                  <>
                    <div style={{ marginBottom:14, padding:"8px 12px", background:T.bg, borderRadius:8, display:"flex", alignItems:"center", gap:8 }}>
                      <span style={{ fontSize:11, color:T.sub }}>Numero commessa:</span>
                      <span style={{ fontSize:13, fontWeight:800, color:T.acc, fontFamily:FM }}>{previewCode}</span>
                      <span style={{ fontSize:10, color:T.sub }}>(assegnato automaticamente)</span>
                    </div>

                    <div style={{ marginBottom:14, padding:"14px", background:T.card, borderRadius:12, border:`1.5px solid ${T.bdr}` }}>
                      <div style={{ fontSize:10, fontWeight:800, color:T.sub, textTransform:"uppercase", letterSpacing:"0.07em", marginBottom:10 }}>üë§ Dati cliente *</div>
                      <div style={{ display:"flex", gap:8, marginBottom:0 }}>
                        <input style={{...S.input,flex:1}} placeholder="Nome" value={newCM.cliente} onChange={e=>setNewCM(c=>({...c,cliente:e.target.value}))}/>
                        <input style={{...S.input,flex:1}} placeholder="Cognome" value={newCM.cognome||""} onChange={e=>setNewCM(c=>({...c,cognome:e.target.value}))}/>
                      </div>
                      {/* Bottone rubrica SEMPRE visibile */}
                      {!newCM.cliente && (
                        <div onClick={() => setNewCM(c => ({...c, cliente: " "}))} style={{ margin:"6px 0 8px", padding:"10px 14px", borderRadius:10, border:"1.5px dashed "+T.acc+"60", background:T.acc+"06", cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:8 }}>
                          <span style={{ fontSize:16 }}>üìí</span>
                          <span style={{ fontSize:12, fontWeight:700, color:T.acc }}>Scegli dalla rubrica ({contatti.filter(c=>c.tipo==="cliente").length} clienti)</span>
                        </div>
                      )}
                      {/* Autocomplete rubrica - INLINE */}
                      {newCM.cliente.length >= 1 && (() => {
                        const q = newCM.cliente.trim().toLowerCase();
                        const matches = q.length > 0 
                          ? contatti.filter(ct => ct.nome?.toLowerCase().includes(q) || (ct.cognome || "").toLowerCase().includes(q) || (ct.azienda || "").toLowerCase().includes(q)).slice(0, 8)
                          : contatti.filter(ct => ct.tipo === "cliente").slice(0, 10);
                        const cmMatches = q.length > 0
                          ? cantieri.filter(cm => cm.cliente?.toLowerCase().includes(q) || (cm.cognome || "").toLowerCase().includes(q)).slice(0, 3)
                          : [];
                        const allSugg = [
                          ...matches.map(ct => ({ tipo: "rubrica", nome: ct.nome, cognome: ct.cognome || "", tel: ct.telefono || "", email: ct.email || "", indirizzo: ct.indirizzo || "", ico: "üìí" })),
                          ...cmMatches.map(cm => ({ tipo: "commessa", nome: cm.cliente, cognome: cm.cognome || "", tel: cm.telefono || "", email: cm.email || "", indirizzo: cm.indirizzo || "", ico: "üìÅ" }))
                        ];
                        const seen = new Set();
                        const unique = allSugg.filter(s => { const k = (s.nome+s.cognome).toLowerCase(); if (seen.has(k)) return false; seen.add(k); return true; });
                        if (unique.length === 0) return null;
                        return <div style={{ background:"#fff", border:"1.5px solid " + T.acc + "40", borderRadius:10, marginTop:6, marginBottom:8, overflow:"hidden", maxHeight:220, overflowY:"auto" }}>
                          <div style={{ padding:"6px 10px", fontSize:9, fontWeight:700, color:T.acc, background:T.acc+"08", borderBottom:"1px solid " + T.acc + "20", display:"flex", justifyContent:"space-between", position:"sticky", top:0 }}>
                            <span>üìí Seleziona dalla rubrica ({unique.length})</span>
                            <span onClick={(e) => { e.stopPropagation(); setNewCM(c => ({...c, cliente: ""})); }} style={{ cursor:"pointer", color:T.sub }}>‚úï</span>
                          </div>
                          {unique.map((s, i) => (
                            <div key={i} onClick={() => setNewCM(c => ({...c, cliente: s.nome, cognome: s.cognome, telefono: s.tel, email: s.email, indirizzo: s.indirizzo || c.indirizzo }))}
                              style={{ display:"flex", alignItems:"center", gap:8, padding:"10px 12px", cursor:"pointer", borderBottom: i < unique.length -1 ? "1px solid " + T.bdr + "40" : "none" }}>
                              <div style={{ fontSize:16 }}>{s.ico}</div>
                              <div style={{ flex:1 }}>
                                <div style={{ fontSize:12, fontWeight:700, color:T.text }}>{s.nome} {s.cognome}</div>
                                <div style={{ fontSize:9, color:T.sub }}>{s.tel && ("üìû " + s.tel)} {s.email && (" ‚úâÔ∏è " + s.email)}</div>
                                {s.indirizzo && <div style={{ fontSize:9, color:T.sub }}>üìç {s.indirizzo}</div>}
                              </div>
                              <span style={{ fontSize:8, padding:"2px 6px", borderRadius:4, background: s.tipo === "rubrica" ? "#af52de15" : T.accLt, color: s.tipo === "rubrica" ? "#af52de" : T.acc, fontWeight:700 }}>{s.tipo === "rubrica" ? "RUBRICA" : "COMMESSA"}</span>
                            </div>
                          ))}
                        </div>;
                      })()}
                      <input style={{...S.input,marginBottom:8}} placeholder="Indirizzo lavori (Via, CAP, Citt√†)" value={newCM.indirizzo} onChange={e=>setNewCM(c=>({...c,indirizzo:e.target.value}))}/>
                      <div style={{ display:"flex", gap:8 }}>
                        <input style={{...S.input,flex:1}} placeholder="Telefono" inputMode="tel" value={newCM.telefono} onChange={e=>setNewCM(c=>({...c,telefono:e.target.value}))}/>
                        <input style={{...S.input,flex:1}} placeholder="Email" inputMode="email" value={newCM.email||""} onChange={e=>setNewCM(c=>({...c,email:e.target.value}))}/>
                      </div>
                    </div>

                    <AccordionSection id="accesso" icon="üèó" label="Accesso / Difficolt√† salita"
                      badge={newCM.difficoltaSalita||null}>
                      <div style={{ display:"flex", gap:4, marginBottom:8 }}>
                        {[{id:"facile",l:"Facile",c:T.grn,e:"‚úÖ"},{id:"media",l:"Media",c:T.orange,e:"‚ö†Ô∏è"},{id:"difficile",l:"Difficile",c:T.red,e:"üî¥"}].map(d => (
                          <div key={d.id} onClick={()=>setNewCM(c=>({...c,difficoltaSalita:d.id}))}
                            style={{ flex:1, padding:"8px 4px", borderRadius:8, border:`1.5px solid ${newCM.difficoltaSalita===d.id?d.c:T.bdr}`, background:newCM.difficoltaSalita===d.id?d.c+"15":T.card, textAlign:"center", cursor:"pointer" }}>
                            <div style={{ fontSize:14 }}>{d.e}</div>
                            <div style={{ fontSize:10, fontWeight:600, color:newCM.difficoltaSalita===d.id?d.c:T.sub }}>{d.l}</div>
                          </div>
                        ))}
                      </div>
                      <div style={{ display:"flex", gap:8, marginBottom:8 }}>
                        <div style={{ flex:1 }}>
                          <div style={{ fontSize:10, color:T.sub, fontWeight:600, marginBottom:2 }}>Piano edificio</div>
                          <select style={S.select} value={newCM.pianoEdificio} onChange={e=>setNewCM(c=>({...c,pianoEdificio:e.target.value}))}>
                            <option value="">‚Äî Seleziona ‚Äî</option>
                            {["S2 ‚Äî 2¬∞ Seminterrato","S1 ‚Äî Seminterrato","PT ‚Äî Piano Terra","P1 ‚Äî 1¬∞ Piano","P2 ‚Äî 2¬∞ Piano","P3 ‚Äî 3¬∞ Piano","P4 ‚Äî 4¬∞ Piano","P5 ‚Äî 5¬∞ Piano","P6 ‚Äî 6¬∞ Piano","P7 ‚Äî 7¬∞ Piano","P8 ‚Äî 8¬∞ Piano","P9 ‚Äî 9¬∞ Piano","P10 ‚Äî 10¬∞ Piano","P11 ‚Äî 11¬∞ Piano","P12 ‚Äî 12¬∞ Piano","P13 ‚Äî 13¬∞ Piano","P14 ‚Äî 14¬∞ Piano","P15 ‚Äî 15¬∞ Piano","P16 ‚Äî 16¬∞ Piano","P17 ‚Äî 17¬∞ Piano","P18 ‚Äî 18¬∞ Piano","P19 ‚Äî 19¬∞ Piano","P20 ‚Äî 20¬∞ Piano","M ‚Äî Mansarda"].map(p=><option key={p} value={p}>{p}</option>)}
                          </select>
                        </div>
                        <div style={{ flex:1 }}>
                          <div style={{ fontSize:10, color:T.sub, fontWeight:600, marginBottom:2 }}>Foro scale (cm)</div>
                          <input style={S.input} placeholder="es. 80√ó200" value={newCM.foroScale} onChange={e=>setNewCM(c=>({...c,foroScale:e.target.value}))}/>
                        </div>
                      </div>
                      <div style={{ fontSize:10, color:T.sub, fontWeight:600, marginBottom:2 }}>Mezzo di salita</div>
                      <select style={S.select} value={newCM.mezzoSalita} onChange={e=>setNewCM(c=>({...c,mezzoSalita:e.target.value}))}>
                        <option value="">‚Äî Seleziona ‚Äî</option>
                        {mezziSalita.map(m => <option key={m} value={m}>{m}</option>)}
                      </select>
                    </AccordionSection>

                    <AccordionSection id="note" icon="üìù" label="Note aggiuntive"
                      badge={newCM.note ? "‚úì" : null}>
                      <textarea style={{...S.input,minHeight:70,resize:"vertical"}}
                        placeholder="Note aggiuntive sulla commessa‚Ä¶"
                        defaultValue={newCM.note} onBlur={e=>setNewCM(c=>({...c,note:e.target.value}))}/>
                    </AccordionSection>

                    <div style={{ marginTop:6 }}>
                      {!newCM.cliente.trim() && (
                        <div style={{ fontSize:11, color:T.sub, textAlign:"center", marginBottom:8 }}>Inserisci almeno il nome per procedere</div>
                      )}
                      <button style={{ ...S.btn, background:newCM.cliente.trim()?T.acc:"#ccc", cursor:newCM.cliente.trim()?"pointer":"not-allowed" }}
                        onClick={addCommessa} disabled={!newCM.cliente.trim()}>
                        ‚úì Crea commessa {previewCode}
                      </button>
                      <button style={S.btnCancel} onClick={() => setShowModal(null)}>Annulla</button>
                    </div>
                  </>
                );
              })()}
            </>
          )}
        </div>
      </div>
    );
  };


  const generaPreventivoPDF = (c) => {
    // Grid price lookup: find smallest grid cell where L>=vanoL and H>=vanoH (ceiling approach like real suppliers)
    const grigliaLookup = (griglia: any[], lmm: number, hmm: number): number | null => {
      if (!griglia || griglia.length === 0) return null;
      // Sort by L then H
      const sorted = [...griglia].sort((a, b) => a.l - b.l || a.h - b.h);
      // Find exact match first
      const exact = sorted.find(g => g.l === lmm && g.h === hmm);
      if (exact) return exact.prezzo;
      // Find ceiling: smallest grid cell that covers the window
      const ceiling = sorted.find(g => g.l >= lmm && g.h >= hmm);
      if (ceiling) return ceiling.prezzo;
      // If window is larger than any grid entry, find the largest grid entry
      const largest = sorted[sorted.length - 1];
      if (largest) return largest.prezzo;
      return null;
    };

    const calcolaVanoPDF = (v) => {
      const m = v.misure||{};
      const lc=(m.lCentro||0)/1000, hc=(m.hCentro||0)/1000;
      const lmm=m.lCentro||0, hmm=m.hCentro||0;
      const mq=lc*hc, perim=2*(lc+hc);
      const sysRec = sistemiDB.find(s=>(s.marca+" "+s.sistema)===v.sistema||s.sistema===v.sistema);
      // Get minimo mq for this tipologia
      const minCat = tipoToMinCat(v.tipo || "F1A");
      const minimoMq = sysRec?.minimiMq?.[minCat] || 0;
      const mqCalc = (minimoMq > 0 && mq > 0 && mq < minimoMq) ? minimoMq : mq;
      // Price: try grid first, fallback to ‚Ç¨/mq with minimo applied
      let basePrezzoSer = 0;
      const gridPrice = sysRec?.griglia ? grigliaLookup(sysRec.griglia, lmm, hmm) : null;
      if (gridPrice !== null) {
        basePrezzoSer = gridPrice;
      } else {
        basePrezzoSer = mqCalc * parseFloat(sysRec?.prezzoMq||sysRec?.euroMq||c.prezzoMq||350);
      }
      let tot = basePrezzoSer;
      const vetroRec = vetriDB.find(g=>g.code===v.vetro||g.nome===v.vetro);
      if(vetroRec?.prezzoMq) tot += mq * parseFloat(vetroRec.prezzoMq);
      const copRec = coprifiliDB.find(cp=>cp.cod===v.coprifilo);
      if(copRec?.prezzoMl) tot += perim * parseFloat(copRec.prezzoMl);
      const lamRec = lamiereDB.find(l=>l.cod===v.lamiera);
      if(lamRec?.prezzoMl) tot += lc * parseFloat(lamRec.prezzoMl);
      const tapp=v.accessori?.tapparella; if(tapp?.attivo&&c.prezzoTapparella){const tmq=((tapp.l||m.lCentro||0)/1000)*((tapp.h||m.hCentro||0)/1000);tot+=tmq*parseFloat(c.prezzoTapparella);}
      const pers=v.accessori?.persiana; if(pers?.attivo&&c.prezzoPersiana){const pmq=((pers.l||m.lCentro||0)/1000)*((pers.h||m.hCentro||0)/1000);tot+=pmq*parseFloat(c.prezzoPersiana);}
      const zanz=v.accessori?.zanzariera; if(zanz?.attivo&&c.prezzoZanzariera){const zmq=((zanz.l||m.lCentro||0)/1000)*((zanz.h||m.hCentro||0)/1000);tot+=zmq*parseFloat(c.prezzoZanzariera);}
      // Voci libere
      if (v.vociLibere?.length > 0) v.vociLibere.forEach(vl => { tot += (vl.prezzo || 0) * (vl.qta || 1); });
      return { tot, mq, perim, sysRec, vetroRec, copRec, lamRec };
    };
    const vaniPDF = getVaniAttivi(c);
    const totale = vaniPDF.reduce((s,v)=>s+calcolaVanoPDF(v).tot, 0);
    const sconto = parseFloat(c.sconto||0);
    const scontoVal = totale * sconto / 100;
    const imponibile = totale - scontoVal;
    const ivaPerc = parseFloat(c.ivaPerc||10);
    const iva = imponibile * ivaPerc / 100;
    const totIva = imponibile + iva;
    const oggi = new Date().toLocaleDateString("it-IT");
    const totalMq = vaniPDF.reduce((s,v)=>s+calcolaVanoPDF(v).mq, 0);
    const az = aziendaInfo;
    const fmt = (n: number) => n.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const TIPI_LABEL: Record<string,string> = { F1A:"Finestra 1 anta", F2A:"Finestra 2 ante", PF1A:"Portafinestra 1 anta", PF2A:"Portafinestra 2 ante", SC2A:"Scorrevole 2 ante", SC4A:"Scorrevole 4 ante", VAS:"Vasistas", FIS:"Fisso", PB:"Porta blindata", PI:"Porta interna", PORTONE:"Portone", TDBR:"Tenda a bracci", TDCAD:"Tenda a caduta", TDCAP:"Cappottina", TDVER:"Tenda verticale", TDRUL:"Tenda a rullo", TDPERG:"Pergola bioclimatica", TDZIP:"Tenda ZIP/Screen", TDVELA:"Vela ombreggiante", VENEZIA:"Veneziana", TDS:"Tenda da sole", TDR:"Tenda a rullo", TVE:"Tenda veranda", PBC:"Pergola bioclimatica", PGA:"Pergola addossata", PGF:"Pergola freestanding", TCA:"Tenda a cappottina", TCB:"Tenda a bracci", ZTE:"Zanzariera tenda" };
    const TIPI_OUTDOOR = ["TDBR","TDCAD","TDCAP","TDVER","TDRUL","TDPERG","TDZIP","TDVELA","VENEZIA","TDS","TDR","TVE","PBC","PGA","PGF","TCA","TCB","ZTE"];
    const isOutdoor = (tipo: string) => TIPI_OUTDOOR.includes(tipo);

    // SVG technical drawing per tipo - IMPROVED
    const drawSVG = (tipo: string, w: number, h: number) => {
      // Use standard dimensions if 0
      const DEFAULTS: Record<string,number[]> = { F1A:[700,1200], F2A:[1200,1400], F3A:[1800,1400], PF1A:[800,2200], PF2A:[1400,2200], PF3A:[2100,2200], VAS:[700,500], SOPR:[800,400], FIS:[600,1000], FISTONDO:[600,600], SC2A:[1600,2200], SC4A:[2800,2200], ALZSC:[3000,2200], BLI:[900,2100], PI:[900,2100] };
      const [defW, defH] = DEFAULTS[tipo] || [1000, 1300];
      const ww = w > 0 ? w : defW;
      const hh = h > 0 ? h : defH;
      const vw=140, vh=Math.max(Math.min(Math.round(vw*(hh/Math.max(ww,1))),180), 60);
      const pad=5, iw=vw-pad*2, ih=vh-pad*2;
      // Frame
      let d = `<rect x="${pad}" y="${pad}" width="${iw}" height="${ih}" rx="1.5" fill="#f0f6ff" stroke="#333" stroke-width="2.5"/>`;
      // Internal frame
      d += `<rect x="${pad+3}" y="${pad+3}" width="${iw-6}" height="${ih-6}" rx="0.5" fill="none" stroke="#555" stroke-width="0.8"/>`;
      
      if (tipo.includes("SC") || tipo === "ALZSC") {
        // Scorrevole
        const mid=vw/2;
        d += `<rect x="${pad+5}" y="${pad+5}" width="${mid-pad-7}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.7"/>`;
        d += `<rect x="${mid+2}" y="${pad+5}" width="${mid-pad-7}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.7"/>`;
        // Rails
        d += `<line x1="${pad+5}" y1="${vh/2}" x2="${vw-pad-5}" y2="${vh/2}" stroke="#bbb" stroke-width="0.3" stroke-dasharray="2,2"/>`;
        // Handles
        d += `<rect x="${mid-10}" y="${vh/2-6}" width="3" height="12" rx="1" fill="#666"/>`;
        d += `<rect x="${mid+7}" y="${vh/2-6}" width="3" height="12" rx="1" fill="#666"/>`;
        // Arrows
        d += `<path d="M${mid-16},${vh/2} L${mid-22},${vh/2-3} L${mid-22},${vh/2+3}Z" fill="#999"/>`;
        d += `<path d="M${mid+16},${vh/2} L${mid+22},${vh/2-3} L${mid+22},${vh/2+3}Z" fill="#999"/>`;
      } else if (tipo.includes("2A") || tipo === "PF2A") {
        // 2 ante
        const mid=vw/2;
        d += `<line x1="${mid}" y1="${pad+3}" x2="${mid}" y2="${vh-pad-3}" stroke="#333" stroke-width="1.5"/>`;
        // Left pane
        d += `<rect x="${pad+5}" y="${pad+5}" width="${mid-pad-7}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.5"/>`;
        d += `<line x1="${pad+5}" y1="${pad+5}" x2="${mid-2}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        d += `<line x1="${mid-2}" y1="${pad+5}" x2="${pad+5}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        // Right pane
        d += `<rect x="${mid+2}" y="${pad+5}" width="${mid-pad-7}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.5"/>`;
        d += `<line x1="${mid+2}" y1="${pad+5}" x2="${vw-pad-5}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        d += `<line x1="${vw-pad-5}" y1="${pad+5}" x2="${mid+2}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        // Handles
        d += `<circle cx="${mid-8}" cy="${vh/2}" r="3" fill="none" stroke="#333" stroke-width="1"/>`;
        d += `<circle cx="${mid+8}" cy="${vh/2}" r="3" fill="none" stroke="#333" stroke-width="1"/>`;
        // Hinge indicators
        d += `<rect x="${pad+2}" y="${vh/3}" width="2" height="8" rx="1" fill="#888"/>`;
        d += `<rect x="${pad+2}" y="${vh*2/3}" width="2" height="8" rx="1" fill="#888"/>`;
        d += `<rect x="${vw-pad-4}" y="${vh/3}" width="2" height="8" rx="1" fill="#888"/>`;
        d += `<rect x="${vw-pad-4}" y="${vh*2/3}" width="2" height="8" rx="1" fill="#888"/>`;
      } else if (tipo === "VAS" || tipo === "SOPR") {
        // Vasistas / Sopraluce
        d += `<rect x="${pad+5}" y="${pad+5}" width="${iw-10}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.5"/>`;
        d += `<line x1="${pad+5}" y1="${vh-pad-5}" x2="${vw/2}" y2="${pad+5}" stroke="#ccc" stroke-width="0.4"/>`;
        d += `<line x1="${vw-pad-5}" y1="${vh-pad-5}" x2="${vw/2}" y2="${pad+5}" stroke="#ccc" stroke-width="0.4"/>`;
        // Handle bottom center
        d += `<rect x="${vw/2-5}" y="${vh-pad-9}" width="10" height="3" rx="1" fill="#666"/>`;
        // Hinge top
        d += `<rect x="${vw/3}" y="${pad+2}" width="8" height="2" rx="1" fill="#888"/>`;
        d += `<rect x="${vw*2/3-8}" y="${pad+2}" width="8" height="2" rx="1" fill="#888"/>`;
      } else if (tipo === "FIS" || tipo === "FISTONDO") {
        // Fisso
        d += `<rect x="${pad+5}" y="${pad+5}" width="${iw-10}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.5"/>`;
        // Glass dividers
        d += `<line x1="${vw/2}" y1="${pad+5}" x2="${vw/2}" y2="${vh-pad-5}" stroke="#ddd" stroke-width="0.3"/>`;
        d += `<line x1="${pad+5}" y1="${vh/2}" x2="${vw-pad-5}" y2="${vh/2}" stroke="#ddd" stroke-width="0.3"/>`;
        // "FISSO" label
        d += `<text x="${vw/2}" y="${vh/2+3}" text-anchor="middle" font-size="8" fill="#999" font-style="italic">fisso</text>`;
      } else if (tipo === "BLI") {
        // Porta blindata
        d += `<rect x="${pad+5}" y="${pad+5}" width="${iw-10}" height="${ih-10}" fill="#f5ece0" stroke="#555" stroke-width="0.7"/>`;
        // Panel details
        d += `<rect x="${pad+12}" y="${pad+15}" width="${iw-24}" height="${ih/4}" rx="2" fill="none" stroke="#987" stroke-width="0.5"/>`;
        d += `<rect x="${pad+12}" y="${vh/2-ih/8}" width="${iw-24}" height="${ih/4}" rx="2" fill="none" stroke="#987" stroke-width="0.5"/>`;
        // Handle
        d += `<rect x="${vw-pad-14}" y="${vh/2-8}" width="3" height="16" rx="1.5" fill="#666"/>`;
        // Lock
        d += `<circle cx="${vw-pad-12}" cy="${vh/2+14}" r="2.5" fill="none" stroke="#666" stroke-width="0.8"/>`;
      } else {
        // 1 anta standard (F1A, PF1A)
        d += `<rect x="${pad+5}" y="${pad+5}" width="${iw-10}" height="${ih-10}" fill="#e8f0fe" stroke="#555" stroke-width="0.5"/>`;
        // Opening diagonals
        d += `<line x1="${pad+5}" y1="${pad+5}" x2="${vw-pad-5}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        d += `<line x1="${vw-pad-5}" y1="${pad+5}" x2="${pad+5}" y2="${vh-pad-5}" stroke="#ccc" stroke-width="0.4"/>`;
        // Handle
        d += `<circle cx="${vw-pad-12}" cy="${vh/2}" r="3" fill="none" stroke="#333" stroke-width="1"/>`;
        d += `<line x1="${vw-pad-12}" y1="${vh/2-3}" x2="${vw-pad-12}" y2="${vh/2-10}" stroke="#333" stroke-width="1"/>`;
        // Hinges left
        d += `<rect x="${pad+2}" y="${vh/3}" width="2" height="8" rx="1" fill="#888"/>`;
        d += `<rect x="${pad+2}" y="${vh*2/3}" width="2" height="8" rx="1" fill="#888"/>`;
      }
      // Dimension labels
      d += `<text x="${vw/2}" y="${vh+10}" text-anchor="middle" font-size="8" fill="#333" font-weight="700">${w} mm</text>`;
      d += `<text x="${vw+6}" y="${vh/2+3}" text-anchor="start" font-size="8" fill="#333" font-weight="700" transform="rotate(90,${vw+6},${vh/2})">${h} mm</text>`;
      return `<svg viewBox="0 0 ${vw+14} ${vh+14}" width="160" style="display:block;margin:6px auto;">${d}</svg>`;
    };

    // Build grouped sections by sistema
    const vaniWithCalc = vaniPDF.map((v, i) => {
      const { tot: sub, mq, perim, sysRec, vetroRec, copRec, lamRec } = calcolaVanoPDF(v);
      const m = v.misure||{};
      const lmm = m.lCentro||0, hmm = m.hCentro||0;
      const colInt = v.coloreInt || v.coloreInterno || v.colore || "Bianco";
      const colEst = v.coloreEst || v.coloreEsterno || v.colore || "Bianco";
      const vetroDesc = vetroRec ? vetroRec.code + (vetroRec.nome ? " " + vetroRec.nome : "") : (v.vetro || "");
      const sysKey = sysRec ? sysRec.id : (v.sistema || "nessuno");
      const sysName = sysRec ? (sysRec.marca ? sysRec.marca.toUpperCase() + " - " + sysRec.sistema.toUpperCase() : sysRec.sistema.toUpperCase()) : (v.sistema ? v.sistema.toUpperCase() : "");
      const tipoCode = v.tipo || "F1A";
      const tipoLabel = TIPI_LABEL[tipoCode] || tipoCode;
      const acc = v.accessori || {};
      let specs = '';
      const addS = (l: string, val: string) => { if (val) specs += `<tr><td class="sl">${l}</td><td class="sv"><b>${val}</b></td></tr>`; };
      addS("Colore interno:", colInt);
      addS("Colore esterno:", colEst);
      if (v.bicolore) addS("Finitura:", "Bicolore");
      if (vetroDesc) addS("Vetro:", vetroDesc);
      if (v.maniglia) addS("Martellina:", v.maniglia);
      addS("Superficie:", mq.toFixed(2).replace(".",",") + " m\u00b2");
      if (v.rifilDx) addS("Sagoma telaio dx:", v.rifilDx);
      if (v.rifilSotto || v.sagomaInf) addS("Sagoma telaio inf:", v.rifilSotto || v.sagomaInf || "");
      if (v.rifilSopra || v.sagomaSup) addS("Sagoma telaio sup:", v.rifilSopra || v.sagomaSup || "");
      if (v.rifilSx) addS("Sagoma telaio sx:", v.rifilSx);
      if (v.telaio) addS("Telaio fisso:", v.telaio);
      if (v.telaioAlaZ) addS("Telaio mobile:", v.telaioAlaZ);
      if (copRec) addS("Coprifilo:", copRec.nome || copRec.cod);
      if (lamRec) addS("Lamiera:", lamRec.nome || lamRec.cod);
      addS("Trasmitt. termica:", (v.trasmittanzaUw || sysRec?.uw || "1,2") + " W/m\u00b2K");
      if (acc.tapparella?.attivo) addS("Tapparella:", (acc.tapparella.tipo || "PVC") + (acc.tapparella.colore ? " " + acc.tapparella.colore : ""));
      if (acc.persiana?.attivo) addS("Persiana:", (acc.persiana.tipo || "Alluminio"));
      if (acc.zanzariera?.attivo) addS("Zanzariera:", (acc.zanzariera.tipo || "Rullo"));
      if (v.note && !v.note.startsWith("\ud83d\udd34")) addS("Note:", v.note);
      // Voci libere
      if (v.vociLibere?.length > 0) {
        v.vociLibere.forEach(vl => {
          const vlTot = (vl.prezzo || 0) * (vl.qta || 1);
          const unitaLabel = { pz: "pz", mq: "mq", ml: "ml", kg: "kg", forfait: "forfait" }[vl.unita] || vl.unita || "pz";
          addS("üì¶ " + (vl.descrizione || "Voce extra") + ":", `‚Ç¨${(vl.prezzo||0).toFixed(2)}/${unitaLabel} √ó ${vl.qta||1} = <b style="color:#1a7f37">‚Ç¨${vlTot.toFixed(2)}</b>`);
        });
      }
      return { ...v, idx: i, sub, mq, sysKey, sysName, sysRec, tipoCode, tipoLabel, lmm, hmm, specs };
    });

    // Group by system
    const groups: Record<string, typeof vaniWithCalc> = {};
    vaniWithCalc.forEach(v => {
      const k = String(v.sysKey);
      if (!groups[k]) groups[k] = [];
      groups[k].push(v);
    });

    // Build HTML sections
    let globalIdx = 0;
    const sectionsHtml = Object.entries(groups).map(([key, vani]) => {
      const sys = vani[0].sysRec;
      const sysName = vani[0].sysName || "Senza sistema assegnato";
      const subTot = vani.reduce((s, v) => s + v.sub, 0);
      const subMq = vani.reduce((s, v) => s + v.mq, 0);

      // System header with profile image
      const sysHeader = `<div style="margin-top:16px;margin-bottom:8px;padding:10px 14px;background:#f5f8fc;border:1.5px solid #0066cc30;border-radius:6px;display:flex;align-items:center;gap:14px;page-break-inside:avoid">
        ${sys?.immagineProfilo ? `<img src="${sys.immagineProfilo}" style="height:65px;max-width:140px;object-fit:contain;border-radius:4px;background:#fff;padding:4px;border:1px solid #ddd" alt=""/>` : `<div style="width:60px;height:60px;background:#e8f0fe;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:28px">ü™ü</div>`}
        <div style="flex:1">
          <div style="font-size:14px;font-weight:900;color:#0066cc;letter-spacing:-0.3px">${sysName}</div>
          ${sys ? `<div style="font-size:9px;color:#666;margin-top:2px">${sys.euroMq ? "‚Ç¨" + sys.euroMq + "/m¬≤ base" : ""} ${sys.uw ? " ¬∑ Uw " + sys.uw + " W/m¬≤K" : ""}</div>` : ""}
          <div style="font-size:9px;color:#888;margin-top:1px">${vani.length} element${vani.length > 1 ? "i" : "o"} ¬∑ ${subMq.toFixed(2).replace(".",",")} m¬≤</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:13px;font-weight:900;color:#1a1a1c">&euro; ${fmt(subTot)}</div>
          <div style="font-size:8px;color:#888">subtotale</div>
        </div>
      </div>`;

      // Vani rows
      const rows = vani.map(v => {
        globalIdx++;
        return `<div style="display:flex;gap:10px;padding:10px 8px;border-bottom:1px solid #eee;page-break-inside:avoid">
          <div style="width:180px;text-align:center;flex-shrink:0">
            <div style="font-size:22px;font-weight:900;color:#0066cc;margin-bottom:2px">${String(globalIdx).padStart(2,"0")}</div>
            ${drawSVG(v.tipoCode, v.lmm, v.hmm)}
            <div style="font-size:7.5px;color:#999;font-style:italic;margin-top:1px">Vista interna</div>
            <div style="font-size:9px;font-weight:700;color:#333;margin-top:2px">${v.tipoLabel}</div>
            ${v.stanza ? `<div style="font-size:8px;color:#888">${v.stanza}${v.piano ? ", " + v.piano : ""}</div>` : ""}
          </div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px">
              <div style="font-size:11px;font-weight:700">${v.lmm} √ó ${v.hmm} mm</div>
              <div style="font-size:12px;font-weight:900;color:#1a1a1c">&euro; ${fmt(v.sub)}</div>
            </div>
            <table class="st"><tbody>${v.specs}</tbody></table>
            ${Object.values(v.foto || {}).filter(f => f.tipo === "foto" && f.dataUrl).length > 0 ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px">${Object.values(v.foto || {}).filter(f => f.tipo === "foto" && f.dataUrl).slice(0, 4).map(f => `<img src="${f.dataUrl}" style="width:60px;height:45px;object-fit:cover;border-radius:3px;border:1px solid #ddd" alt=""/>`).join("")}${Object.values(v.foto || {}).filter(f => f.tipo === "foto" && f.dataUrl).length > 4 ? `<div style="width:60px;height:45px;background:#f0f0f0;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;color:#666">+${Object.values(v.foto || {}).filter(f => f.tipo === "foto" && f.dataUrl).length - 4}</div>` : ""}</div>` : ""}
          </div>
        </div>`;
      }).join("");

      return sysHeader + `<div style="border:1px solid #ddd;border-radius:4px;overflow:hidden;margin-bottom:6px">${rows}</div>`;
    }).join("");

    // Extra rows (trasporto etc)
    let extraHtml = '';
    if (c.trasporto && parseFloat(c.trasporto) > 0) {
      extraHtml = `<div style="margin-top:8px;padding:10px 14px;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-size:11px;font-weight:700">üöõ Trasporto</div><div style="font-size:9px;color:#666">${c.trasportoNote || "Trasporto e scarico"}</div></div>
        <div style="font-size:12px;font-weight:900">&euro; ${fmt(parseFloat(c.trasporto))}</div>
      </div>`;
    }

    const scontoRow = sconto > 0 ? `<tr><td class="tl" style="color:#D08008">Sconto ${sconto}%</td><td class="tv" style="color:#D08008">&minus; ${fmt(scontoVal)}</td></tr>` : '';
    const noteHtml = c.notePreventivo ? `<div style="border:1px solid #ddd;padding:10px 12px;margin:10px 0;font-size:9.5px;color:#444;line-height:1.5"><b>Note:</b> ${c.notePreventivo}</div>` : '';
    const firmaHtml = c.firmaCliente ? `<img src="${c.firmaCliente}" style="max-height:55px;max-width:100%;display:block;margin:0 auto 4px"/>` : '<div style="border-bottom:1px solid #666;height:45px;margin-bottom:4px"></div>';

    const html = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"/><title>Preventivo ${c.code}</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
@page{size:A4;margin:12mm 10mm 15mm 10mm}
body{font-family:'Segoe UI',Arial,Helvetica,sans-serif;color:#1a1a1c;font-size:10px;line-height:1.35;background:#fff}
.pg{max-width:210mm;margin:0 auto;padding:12px 16px}
/* HEADER */
.hd{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:14px;margin-bottom:14px;border-bottom:3px solid #0066cc}
.an{font-size:20px;font-weight:900;color:#0066cc;letter-spacing:-0.3px}
.ai{font-size:9px;color:#555;line-height:1.6}
/* CLIENT */
.cl-s{margin-bottom:12px;display:flex;justify-content:space-between}
.cl-l{font-size:9px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.cl-n{font-size:13px;font-weight:800}
.cl-a{font-size:10px;color:#555}
.pi{font-size:10px;line-height:1.6}.pi b{color:#0066cc}
.intro{font-size:10px;color:#444;margin:10px 0 8px;font-style:italic}
/* TABLE */
.pt{width:100%;border-collapse:collapse;margin-bottom:8px;border:1px solid #ccc}
.pt thead th{background:#f0f0f0;border:1px solid #ccc;padding:5px 7px;font-size:8.5px;font-weight:700;text-transform:uppercase;color:#444;text-align:center}
.ir{border-bottom:1px solid #ddd}.ir2{border-bottom:1.5px solid #aaa}
.cn{width:150px;padding:8px;vertical-align:top;border-right:1px solid #ddd;text-align:center}
.n0{font-size:26px;font-weight:900;color:#0066cc;margin-bottom:4px}
.cv{font-size:7.5px;color:#999;font-style:italic;margin-top:2px}
.ct{font-size:9px;font-weight:700;color:#333;margin-top:3px;text-transform:uppercase}
.cs{font-size:8px;color:#888}
.csys{font-size:8px;font-weight:700;color:#0066cc;margin-top:2px;line-height:1.2}
.cd{padding:5px 7px;vertical-align:top;border-bottom:1px solid #eee}
.dv{font-size:11px;font-weight:700}
.cp,.cq,.ce{width:70px;padding:5px 7px;text-align:right;vertical-align:top;border-left:1px solid #ddd;font-size:10px}
.ce{font-weight:800}
.csp{padding:0 7px 7px;border-bottom:none}
.st{border-collapse:collapse;width:100%}
.st td{padding:1.5px 5px;font-size:9.5px;vertical-align:top}
.st .sl{color:#666;width:130px;white-space:nowrap}
.st .sv b{font-weight:700;color:#1a1a1c}
/* TOTALS */
.ts{margin-top:4px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.qi{font-size:10px;color:#555;padding-top:6px}.qi b{color:#1a1a1c}
.tt{border-collapse:collapse;min-width:250px}
.tt td{padding:4px 10px;font-size:10px}
.tl{text-align:right;color:#555;border:1px solid #ddd;background:#fafafa}
.tv{text-align:right;font-weight:700;border:1px solid #ddd;min-width:85px}
.tf .tl,.tf .tv{font-size:14px;font-weight:900;background:#f0f0f0;border:2px solid #333}
.tf .tv{color:#0066cc}
/* CONDIZIONI */
.ct2{font-size:10px;font-weight:800;text-transform:uppercase;text-align:center;margin:14px 0 8px;letter-spacing:.5px}
.cst{font-size:9px;font-weight:700;text-align:center;margin-bottom:6px;color:#555}
.ctx{font-size:9px;color:#444;line-height:1.6;margin-bottom:8px}.ctx b{color:#1a1a1c}
/* FIRMA */
.fs{display:flex;gap:36px;margin-top:20px;padding-top:14px;border-top:1.5px solid #ccc}
.fb{flex:1;text-align:center}.fl{font-size:8.5px;color:#555}
/* FOOTER */
.ft{margin-top:14px;padding:10px 0;border-top:2px solid #0066cc;display:flex;justify-content:space-between;font-size:8px;color:#888}
.ft b{color:#555}
/* PRINT */
.pb{display:block;margin:0 auto 12px;padding:10px 28px;background:#0066cc;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit}
@media print{.pb{display:none!important}.pg{padding:0;margin:0}}
</style></head><body>
<div class="pg">
<button class="pb" onclick="window.print()">üñ®Ô∏è Stampa / Salva PDF</button>
<div class="no-print" style="position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #0066cc;padding:10px 16px;display:flex;gap:8px;z-index:999;box-shadow:0 -4px 20px rgba(0,0,0,0.15)">
  <button onclick="window.print()" style="flex:1;padding:10px;background:#0066cc;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üñ®Ô∏è Stampa PDF</button>
  <button onclick="if(navigator.share){navigator.share({title:'Preventivo ${c.code}',text:'Preventivo per ${c.cliente}',url:window.location.href}).catch(()=>{})}else{navigator.clipboard.writeText(document.title);alert('Link copiato!')}" style="flex:1;padding:10px;background:#34c759;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üì§ Condividi</button>
  <button onclick="window.close()" style="padding:10px 16px;background:#ff3b30;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">‚úï</button>
</div>

<div class="hd">
  <div>
    ${az.logo?`<img src="${az.logo}" style="height:48px;max-width:120px;object-fit:contain;margin-bottom:6px;display:block" alt=""/>`:''}
    <div class="an">${az.ragione||"La Tua Azienda"}</div>
    <div class="ai">${az.indirizzo||""}<br/>Tel. ${az.telefono||""}${az.email?" &middot; "+az.email:""}${az.piva?"<br/>P.IVA "+az.piva:""}${az.cciaa?" &middot; REA "+az.cciaa:""}${(az as any).pec?"<br/>PEC: "+(az as any).pec:""}</div>
  </div>
  <div style="text-align:right">

  </div>
</div>

<div class="cl-s">
  <div>
    <div class="cl-l">Spett.le</div>
    <div class="cl-n">${c.cliente} ${c.cognome||""}</div>
    <div class="cl-a">${c.indirizzo||""}</div>
    ${c.telefono?`<div class="cl-a">Tel. ${c.telefono}</div>`:""}
    ${c.email?`<div class="cl-a">${c.email}</div>`:""}
  </div>
  <div style="text-align:right">
    <div class="pi">Preventivo n. <b>${c.code.replace("CM-","")}</b></div>
    <div class="pi">Riferimento ordine <b>${c.cliente} ${c.cognome||""}</b></div>
    <div class="pi">Data: <b>${oggi}</b></div>
  </div>
</div>

<div class="intro">A seguito della Vostra gentile richiesta Vi rimettiamo il presente preventivo:</div>

${sectionsHtml}
${extraHtml}

<div class="ts">
  <div class="qi">Quadratura: <b>${totalMq.toFixed(2).replace(".",",")} m&sup2;</b></div>
  <table class="tt">
    <tr><td class="tl">Imponibile:</td><td class="tv">${fmt(imponibile)}</td></tr>
    ${scontoRow}
    <tr><td class="tl">I.V.A. ${ivaPerc}%:</td><td class="tv">${fmt(iva)}</td></tr>
    <tr class="tf"><td class="tl">Totale iva inclusa:</td><td class="tv">&euro; ${fmt(totIva)}</td></tr>
  </table>
</div>

${noteHtml}

${(() => {
  const nl2br = (s: string) => s.replace(/\n/g, "<br/>");
  const defFornitura = (az.ragione?az.ragione.toUpperCase():"L'AZIENDA") + ", NELL'ESECUZIONE DELLA PRODUZIONE E' GARANTE DELL'OSSERVANZA SCRUPOLOSA DELLA REGOLA D'ARTE E DELLE NORME VIGENTI.";
  const defPagamento = "<b>1. Pagamento</b><br/>&middot; 50% acconto alla firma del contratto previa ricezione di ns fattura di acconto<br/>&middot; 50% a SALDO, se non diversamente autorizzato a mezzo mail, a comunicazione merce pronta previa ricezione ns fattura a saldo fornitura.";
  const defConsegna = "<b>2. Tempi di consegna per tipologia di prodotto:</b><br/>&middot; PVC: BATTENTE STANDARD 30 GG.<br/>&middot; PVC: PORTE 35 GG.<br/>&middot; PVC: ALZANTI SCORREVOLI 40 GG.<br/>&middot; PVC: SCORREVOLE PARALLELO/RIBALTA E SCORRE 35 GG.<br/>&middot; PVC: FUORI SQUADRO 50 GG.<br/>&middot; ALLUMINIO: 45/50 GG LAVORATIVI.<br/><br/>Il contratto aggiornato datato e sottoscritto dal cliente con accettazione dei disegni tecnici allegati ed avviato dopo aver avviato l'ordine al fornitore dei materiali, non potranno pi&ugrave; essere accettate variazioni di alcun tipo.";
  const defContratto = "(I prezzi si intendono IVA esclusa)<br/><br/><b>1. Qualificazione giuridica del contratto</b><br/>Il contratto &egrave; ad ogni utile effetto di legge una compravendita in quanto la fornitura del materiale &egrave; prevalente.<br/><br/><b>2. Conclusione del contratto</b><br/>Il presente contratto si conclude con la sua sottoscrizione da parte dell'Acquirente e del Venditore.<br/><br/><b>3. Misure</b><br/>L'Acquirente &egrave; responsabile nel caso in cui abbia dato misure inesatte o non abbia comunicato tempestivamente variazioni.<br/><br/><b>4. Consegna</b><br/>La data di consegna ha natura meramente indicativa e non tassativa.<br/><br/><b>5. Garanzia</b><br/>I manufatti sono coperti da garanzia a norma di legge.<br/><br/><b>6. Trattamento dati</b><br/>Il trattamento dei dati personali viene svolto nel rispetto del D. Lgs. n. 196/2003.";
  const defDettagli = (vaniPDF.length > 0 && vaniPDF[0].sistema ? "Telai e strutture di manovra, sistema " + vaniPDF[0].sistema + ", colorazione \"" + (vaniPDF[0].coloreInt || vaniPDF[0].coloreEst || vaniPDF[0].colore || "Bianco") + "\"." : "Come da specifiche indicate per ogni singola voce del preventivo.") + "<br/><br/><b>Documenti da allegare alla consegna:</b><br/>- Dichiarazione di Prestazione;<br/>- Dichiarazione energetica;<br/>- Etichetta CE;<br/>- Manuale d'uso e manutenzione.";
  
  const txFornitura = az.condFornitura ? nl2br(az.condFornitura) : defFornitura;
  const txPagamento = az.condPagamento ? nl2br(az.condPagamento) : defPagamento;
  const txConsegna = az.condConsegna ? nl2br(az.condConsegna) : defConsegna;
  const txContratto = az.condContratto ? nl2br(az.condContratto) : defContratto;
  const txDettagli = az.condDettagli ? nl2br(az.condDettagli) : defDettagli;

  return `
<div class="ct2">CONDIZIONI GENERALI DI FORNITURA:</div>
<div class="ctx">${txFornitura}</div>

<div class="cst">CONDIZIONI PAGAMENTO E CONSEGNA (parte del preventivo)</div>
<div class="ctx">${txPagamento}<br/><br/>${txConsegna}</div>

<div class="ct2">CONDIZIONI GENERALI DI CONTRATTO</div>
<div class="ctx">${txContratto}</div>

<div class="ctx" style="margin-top:10px">
<b>Dettagli tecnici:</b><br/>
${txDettagli}<br/><br/>
${az.indirizzo ? (az.indirizzo.split(",").pop()?.trim() || "") + ", " : ""}${oggi}<br/><br/>
<div style="text-align:right;font-style:italic">Distinti saluti.</div>
</div>`;
})()}

<div class="fs">
  <div class="fb"><div style="border-bottom:1px solid #666;height:45px;margin-bottom:4px"></div><div class="fl">Firma tecnico / Timbro azienda</div></div>
  <div class="fb">${firmaHtml}<div class="fl">Firma cliente per accettazione${c.dataFirma?" &mdash; "+c.dataFirma:""}</div></div>
</div>

<div class="ft">
  <div><b>Indirizzo:</b><br/>${az.indirizzo||""}</div>
  <div><b>Contatti:</b><br/>Tel. ${az.telefono||""}${az.email?"<br/>"+az.email:""}</div>
  <div><b>Dati Aziendali:</b><br/>${az.ragione||""}${az.piva?"<br/>P.IVA "+az.piva:""}${az.iban?"<br/>IBAN: "+az.iban:""}</div>
</div>
<div style="text-align:center;font-size:7px;color:#bbb;margin-top:6px">Documento generato con MASTRO ERP &mdash; mastro.app</div>
</div>
</body></html>`;

    const blob = new Blob([html], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  };

  // === PDF MISURE PER PRODUZIONE ===
  const generaPDFMisure = (c) => {
    const az = aziendaDB;
    const vani = getVaniAttivi(c);
    const fmt = (n) => n.toLocaleString("it-IT", { minimumFractionDigits: 2 });

    const vaniHtml = vani.map((v, i) => {
      const m = v.misure || {};
      const fotoEntries = Object.entries(v.foto || {}).filter(([, f]) => f.tipo === "foto" && f.dataUrl);
      const tip = TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo);
      const lmm = m.lCentro || m.lAlto || m.lBasso || 0;
      const hmm = m.hCentro || m.hSx || m.hDx || 0;
      const mq = lmm > 0 && hmm > 0 ? ((lmm / 1000) * (hmm / 1000)) : 0;

      return `<div style="border:1.5px solid #333;border-radius:6px;padding:12px;margin-bottom:10px;page-break-inside:avoid">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #333;padding-bottom:6px;margin-bottom:8px">
          <div>
            <span style="font-size:18px;font-weight:900;color:#0066cc">${String(i + 1).padStart(2, "0")}</span>
            <span style="font-size:14px;font-weight:800;margin-left:8px">${v.nome}</span>
            <span style="font-size:11px;color:#666;margin-left:8px">${tip?.label || v.tipo} ¬∑ ${v.stanza || ""} ¬∑ ${v.piano || ""}</span>
          </div>
          <div style="text-align:right">
            <div style="font-size:13px;font-weight:900">${lmm} √ó ${hmm} mm</div>
            <div style="font-size:10px;color:#666">${mq.toFixed(2)} m¬≤ ${(v.pezzi || 1) > 1 ? "√ó " + v.pezzi + " pz" : ""}</div>
          </div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:10px">
          <tr>
            <td style="border:1px solid #ccc;padding:4px;background:#f0f8ff;font-weight:700;width:50%" colspan="2">üìè LARGHEZZE (mm)</td>
            <td style="border:1px solid #ccc;padding:4px;background:#fff8f0;font-weight:700;width:50%" colspan="2">üìê ALTEZZE (mm)</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Alto</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.lAlto || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Sinistra</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.hSx || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Centro</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.lCentro || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Centro</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.hCentro || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Basso</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.lBasso || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Destra</td><td style="border:1px solid #ccc;padding:4px;font-weight:700;font-family:monospace">${m.hDx || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px;background:#fef3f3" colspan="2">‚Üó Diag 1: <b>${m.d1 || "‚Äî"}</b></td>
            <td style="border:1px solid #ccc;padding:4px;background:#fef3f3" colspan="2">‚Üò Diag 2: <b>${m.d2 || "‚Äî"}</b> ${m.d1 > 0 && m.d2 > 0 ? `(Œî ${Math.abs(m.d1 - m.d2)} mm${Math.abs(m.d1 - m.d2) > 3 ? " ‚ö†Ô∏è" : " ‚úÖ"})` : ""}</td>
          </tr>
        </table>
        <table style="width:100%;border-collapse:collapse;font-size:10px;margin-top:4px">
          <tr>
            <td style="border:1px solid #ccc;padding:4px;background:#f0fff0;font-weight:700" colspan="4">‚öôÔ∏è CONFIGURAZIONE</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Sistema</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.sistema || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Vetro</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.vetro || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Colore INT</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.coloreInt || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Colore EST</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.bicolore ? (v.coloreEst || "‚Äî") : "= INT"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Telaio</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.telaio === "Z" ? "Z" : v.telaio === "L" ? "L" : "‚Äî"}${v.telaioAlaZ ? " Ala " + v.telaioAlaZ : ""}</td>
            <td style="border:1px solid #ccc;padding:4px">Coprifilo</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.coprifilo || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:4px">Lamiera</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.lamiera || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:4px">Col. Acc.</td><td style="border:1px solid #ccc;padding:4px;font-weight:700">${v.coloreAcc || "= profili"}</td>
          </tr>
          ${v.rifilato ? `<tr><td style="border:1px solid #ccc;padding:4px;background:#fff8e6" colspan="4">‚úÇÔ∏è RIFILATO ‚Äî Sx: ${v.rifilSx || "‚Äî"} ¬∑ Dx: ${v.rifilDx || "‚Äî"} ¬∑ Sopra: ${v.rifilSopra || "‚Äî"} ¬∑ Sotto: ${v.rifilSotto || "‚Äî"}</td></tr>` : ""}
        </table>
        <table style="width:100%;border-collapse:collapse;font-size:10px;margin-top:4px">
          <tr>
            <td style="border:1px solid #ccc;padding:4px;background:#f5f0ff;font-weight:700" colspan="4">üß± MURATURA</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:3px">Sp. Sx</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.spSx || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:3px">Sp. Dx</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.spDx || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:3px">Sp. Sopra</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.spSopra || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:3px">Imbotte</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.imbotte || "‚Äî"}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ccc;padding:3px">Dav. Prof.</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.davProf || "‚Äî"}</td>
            <td style="border:1px solid #ccc;padding:3px">Dav. Sporg.</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${m.davSporg || "‚Äî"}</td>
          </tr>
          <tr><td style="border:1px solid #ccc;padding:3px">Soglia</td><td style="border:1px solid #ccc;padding:3px;font-weight:700" colspan="3">${m.soglia || "‚Äî"}</td></tr>
        </table>
        ${v.controtelaio?.tipo ? `<table style="width:100%;border-collapse:collapse;font-size:10px;margin-top:4px">
          <tr><td style="border:1px solid #ccc;padding:4px;background:#e8f4fd;font-weight:700" colspan="4">üî≤ CONTROTELAIO ${(v.controtelaio.tipo || "").toUpperCase()}</td></tr>
          <tr><td style="border:1px solid #ccc;padding:3px">L</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${v.controtelaio.l || "‚Äî"}</td><td style="border:1px solid #ccc;padding:3px">H</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${v.controtelaio.h || "‚Äî"}</td></tr>
          ${v.controtelaio.hCass ? `<tr><td style="border:1px solid #ccc;padding:3px">H Cass.</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${v.controtelaio.hCass}</td><td style="border:1px solid #ccc;padding:3px">Sezione</td><td style="border:1px solid #ccc;padding:3px;font-weight:700">${v.controtelaio.sezione || "‚Äî"}</td></tr>` : ""}
        </table>` : ""}
        ${v.accessori?.tapparella?.attivo || v.accessori?.persiana?.attivo || v.accessori?.zanzariera?.attivo ? `<div style="font-size:10px;margin-top:4px;padding:4px;background:#f5f5ff;border:1px solid #ddd;border-radius:3px">
          <b>Accessori:</b> ${v.accessori?.tapparella?.attivo ? "ü™ü Tapparella" : ""} ${v.accessori?.persiana?.attivo ? "üè† Persiana" : ""} ${v.accessori?.zanzariera?.attivo ? "ü¶ü Zanzariera" : ""}
        </div>` : ""}
        ${fotoEntries.length > 0 ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px">${fotoEntries.slice(0, 6).map(([, f]) => `<img src="${f.dataUrl}" style="width:70px;height:52px;object-fit:cover;border-radius:3px;border:1px solid #ccc" alt=""/>`).join("")}</div>` : ""}
        ${v.note ? `<div style="font-size:10px;margin-top:4px;padding:4px;background:#fff8e6;border:1px solid #f0e0b0;border-radius:3px">üìù <b>Note:</b> ${v.note}</div>` : ""}
        ${v.difficoltaSalita ? `<div style="font-size:10px;margin-top:3px;color:#b45309">üèó Accesso: ${v.difficoltaSalita}${v.mezzoSalita ? " ‚Äî " + v.mezzoSalita : ""}</div>` : ""}
      </div>`;
    }).join("");

    const totalMq = vani.reduce((s, v) => {
      const m = v.misure || {};
      const l = m.lCentro || m.lAlto || m.lBasso || 0;
      const h = m.hCentro || m.hSx || m.hDx || 0;
      return s + (l > 0 && h > 0 ? (l / 1000) * (h / 1000) * (v.pezzi || 1) : 0);
    }, 0);

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Misure ‚Äî ${c.code}</title>
    <style>
      body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:15px;font-size:11px}
      @media print{body{padding:5px} .no-print{display:none!important}}
      .header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #333;padding-bottom:10px;margin-bottom:12px}
    </style></head><body>
    <div class="header">
      <div>
        ${az.logo ? `<img src="${az.logo}" style="max-height:50px;max-width:180px;margin-bottom:4px" alt=""/>` : ""}
        <div style="font-size:16px;font-weight:900;color:#333">${az.nome || "MASTRO"}</div>
        <div style="font-size:9px;color:#666">${az.indirizzo || ""} ${az.citta || ""} ¬∑ ${az.tel || ""}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:20px;font-weight:900;color:#5856d6">SCHEDA MISURE</div>
        <div style="font-size:11px;color:#333;margin-top:2px"><b>${c.code}</b></div>
        <div style="font-size:10px;color:#666">${new Date().toLocaleDateString("it-IT")}</div>
      </div>
    </div>
    <div style="display:flex;gap:16px;margin-bottom:12px;padding:10px;background:#f5f5f7;border-radius:6px">
      <div style="flex:1"><div style="font-size:8px;color:#999;text-transform:uppercase">Cliente</div><div style="font-size:13px;font-weight:800">${c.cliente}</div></div>
      <div style="flex:1"><div style="font-size:8px;color:#999;text-transform:uppercase">Indirizzo</div><div style="font-size:11px">${c.indirizzo || "‚Äî"}</div></div>
      <div><div style="font-size:8px;color:#999;text-transform:uppercase">Vani</div><div style="font-size:13px;font-weight:800">${vani.length}</div></div>
      <div><div style="font-size:8px;color:#999;text-transform:uppercase">Tot. m¬≤</div><div style="font-size:13px;font-weight:800">${totalMq.toFixed(2)}</div></div>
    </div>
    ${vaniHtml}
    <div style="margin-top:12px;padding:10px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;font-size:10px;color:#666;text-align:center">
      Documento generato da MASTRO ERP ‚Äî ${new Date().toLocaleDateString("it-IT")} ${new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" })}
      <br><b style="color:#333">‚ö† DOCUMENTO PER USO INTERNO / PRODUZIONE ‚Äî NON VALIDO COME PREVENTIVO</b>
    </div>
    <div class="no-print" style="position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #5856d6;padding:10px 16px;display:flex;gap:8px;z-index:999;box-shadow:0 -4px 20px rgba(0,0,0,0.15)">
      <button onclick="window.print()" style="flex:1;padding:10px;background:#5856d6;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üñ®Ô∏è Stampa PDF</button>
      <button onclick="if(navigator.share){navigator.share({title:document.title,text:'Report misure',url:window.location.href}).catch(()=>{})}else{alert('Usa Stampa ‚Üí Salva come PDF')}" style="flex:1;padding:10px;background:#34c759;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üì§ Condividi</button>
      <button onclick="window.close()" style="padding:10px 16px;background:#ff3b30;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">‚úï</button>
    </div>
    <button class="no-print" onclick="window.print()" style="position:fixed;bottom:70px;right:20px;padding:12px 24px;background:#5856d6;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(88,86,214,0.3)">üñ®Ô∏è Stampa / Salva PDF</button>
    </body></html>`;
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  };

  // === FATTURAZIONE ===
  const nextNumFattura = () => {
    const anno = new Date().getFullYear();
    const annoPrev = fattureDB.filter(f => f.anno === anno);
    return annoPrev.length + 1;
  };

  const creaFattura = (c, tipo: "acconto" | "saldo" | "unica") => {
    const num = nextNumFattura();
    const anno = new Date().getFullYear();
    // Calcola totale REALE dai vani + voci libere
    const importoBase = calcolaTotaleCommessa(c);
    const giaPagato = fattureDB.filter(f => f.cmId === c.id && f.pagata).reduce((s, f) => s + (f.importo || 0), 0);
    const importo = tipo === "acconto" ? Math.round(importoBase * 0.5) : tipo === "saldo" ? Math.round(importoBase - giaPagato) : importoBase;
    const iva = 10; // serramenti = 10% se ristrutturazione, 22% se nuova costruzione
    const imponibile = Math.round(importo / (1 + iva / 100) * 100) / 100;
    const ivaAmt = importo - imponibile;
    const fattura = {
      id: "fat_" + Date.now(),
      numero: num,
      anno,
      data: new Date().toLocaleDateString("it-IT"),
      dataISO: new Date().toISOString().split("T")[0],
      tipo,
      cmId: c.id,
      cmCode: c.code,
      cliente: c.cliente,
      cognome: c.cognome || "",
      indirizzo: c.indirizzo || "",
      cf: c.cf || "",
      piva: c.piva || "",
      sdi: c.sdi || "",
      pec: c.pec || "",
      importo,
      imponibile,
      iva,
      ivaAmt,
      pagata: false,
      dataPagamento: null,
      metodoPagamento: "",
      scadenza: (() => { const d = new Date(); d.setDate(d.getDate() + 30); return d.toISOString().split("T")[0]; })(),
      note: tipo === "acconto" ? "Acconto 50% su ordine" : tipo === "saldo" ? "Saldo a completamento lavori" : "",
    };
    setFattureDB(prev => [...prev, fattura]);
    // AUTO-ADVANCE pipeline
    if (tipo === "acconto" || tipo === "unica") setFaseTo(c.id, "ordini");
    if (tipo === "saldo") setFaseTo(c.id, "chiusura");
    return fattura;
  };

  const generaFatturaPDF = (fat) => {
    const az = aziendaDB;
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Fattura ${fat.numero}/${fat.anno}</title>
    <style>
      body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;font-size:12px;color:#333}
      @media print{.no-print{display:none!important}body{padding:10px}}
      table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:8px;text-align:left}
      th{background:#f5f8fc;font-size:10px;text-transform:uppercase;color:#666}
      .totale{font-size:16px;font-weight:900}
    </style></head><body>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
      <div>
        ${az.logo ? `<img src="${az.logo}" style="max-height:60px;max-width:200px;margin-bottom:6px" alt=""/>` : ""}
        <div style="font-size:18px;font-weight:900">${az.nome || "MASTRO"}</div>
        <div style="font-size:10px;color:#666">${az.indirizzo || ""} ¬∑ ${az.citta || ""}</div>
        <div style="font-size:10px;color:#666">P.IVA: ${az.piva || "‚Äî"} ¬∑ Tel: ${az.tel || "‚Äî"}</div>
        ${az.pec ? `<div style="font-size:10px;color:#666">PEC: ${az.pec}</div>` : ""}
      </div>
      <div style="text-align:right">
        <div style="font-size:24px;font-weight:900;color:#007aff">FATTURA</div>
        <div style="font-size:14px;font-weight:700">N. ${fat.numero}/${fat.anno}</div>
        <div style="font-size:11px;color:#666">Data: ${fat.data}</div>
        <div style="font-size:10px;color:#999;margin-top:4px">${fat.tipo === "acconto" ? "ACCONTO" : fat.tipo === "saldo" ? "SALDO" : "FATTURA"}</div>
      </div>
    </div>
    <div style="background:#f5f5f7;padding:14px;border-radius:8px;margin-bottom:16px">
      <div style="font-size:9px;color:#999;text-transform:uppercase;margin-bottom:4px">Destinatario</div>
      <div style="font-size:14px;font-weight:800">${fat.cliente} ${fat.cognome}</div>
      <div style="font-size:11px">${fat.indirizzo || ""}</div>
      ${fat.cf ? `<div style="font-size:10px;color:#666">C.F.: ${fat.cf}</div>` : ""}
      ${fat.piva ? `<div style="font-size:10px;color:#666">P.IVA: ${fat.piva}</div>` : ""}
      ${fat.sdi ? `<div style="font-size:10px;color:#666">SDI: ${fat.sdi}</div>` : ""}
      ${fat.pec ? `<div style="font-size:10px;color:#666">PEC: ${fat.pec}</div>` : ""}
      <div style="font-size:10px;color:#666;margin-top:4px">Rif. commessa: ${fat.cmCode}</div>
    </div>
    <table>
      <thead><tr><th>Descrizione</th><th style="width:80px;text-align:right">Imponibile</th><th style="width:60px;text-align:right">IVA %</th><th style="width:80px;text-align:right">IVA</th><th style="width:90px;text-align:right">Totale</th></tr></thead>
      <tbody>
        <tr>
          <td>Fornitura e posa serramenti${fat.tipo === "acconto" ? " ‚Äî Acconto 50%" : fat.tipo === "saldo" ? " ‚Äî Saldo" : ""}<br><span style="font-size:10px;color:#666">${fat.note || ""}</span></td>
          <td style="text-align:right;font-weight:700">&euro; ${fmt(fat.imponibile)}</td>
          <td style="text-align:right">${fat.iva}%</td>
          <td style="text-align:right">&euro; ${fmt(fat.ivaAmt)}</td>
          <td style="text-align:right;font-weight:900;font-size:14px">&euro; ${fmt(fat.importo)}</td>
        </tr>
      </tbody>
    </table>
    <div style="text-align:right;margin-top:12px;padding:12px;background:#f0f8ff;border-radius:8px">
      <div style="font-size:10px;color:#666">Imponibile: &euro; ${fmt(fat.imponibile)}</div>
      <div style="font-size:10px;color:#666">IVA ${fat.iva}%: &euro; ${fmt(fat.ivaAmt)}</div>
      <div class="totale" style="margin-top:6px;color:#007aff">TOTALE: &euro; ${fmt(fat.importo)}</div>
    </div>
    <div style="margin-top:16px;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:10px;color:#666">
      <b>Modalit√† pagamento:</b> Bonifico bancario<br>
      <b>IBAN:</b> ${az.iban || "________________"}<br>
      <b>Scadenza:</b> ${fat.scadenza || "30 giorni data fattura"}<br>
      ${fat.note ? `<b>Note:</b> ${fat.note}` : ""}
    </div>
    <div style="margin-top:20px;text-align:center;font-size:9px;color:#999">Documento generato da MASTRO ERP</div>
    <div class="no-print" style="position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #007aff;padding:10px 16px;display:flex;gap:8px;z-index:999;box-shadow:0 -4px 20px rgba(0,0,0,0.15)">
      <button onclick="window.print()" style="flex:1;padding:10px;background:#007aff;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üñ®Ô∏è Stampa PDF</button>
      <button onclick="if(navigator.share){navigator.share({title:document.title,text:'Ordine fornitore',url:window.location.href}).catch(()=>{})}else{alert('Usa Stampa ‚Üí Salva come PDF')}" style="flex:1;padding:10px;background:#34c759;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">üì§ Condividi</button>
      <button onclick="window.close()" style="padding:10px 16px;background:#ff3b30;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">‚úï</button>
    </div>
    <button class="no-print" onclick="window.print()" style="position:fixed;bottom:70px;right:20px;padding:12px 24px;background:#007aff;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer">üñ®Ô∏è Stampa / Salva PDF</button>
    </body></html>`;
    const blob = new Blob([html], { type: "text/html" });
    window.open(URL.createObjectURL(blob), "_blank");
  };

  // === WHATSAPP / EMAIL HELPERS ===
  const inviaWhatsApp = (c, tipo: "preventivo" | "conferma" | "stato") => {
    const tel = (c.telefono || "").replace(/\D/g, "");
    const msgs = {
      preventivo: `Gentile ${c.cliente}, le invio in allegato il preventivo per la fornitura serramenti. Rif: ${c.code}. Resto a disposizione per qualsiasi chiarimento.`,
      conferma: `Gentile ${c.cliente}, confermiamo la ricezione del suo ordine ${c.code}. Provvederemo a ordinare il materiale. La terremo aggiornata sullo stato di avanzamento.`,
      stato: `Gentile ${c.cliente}, aggiornamento sul suo ordine ${c.code}: ${c.trackingStato === "ordinato" ? "il materiale √® stato ordinato" : c.trackingStato === "produzione" ? "il materiale √® in produzione" : c.trackingStato === "pronto" ? "il materiale √® pronto per la consegna" : c.trackingStato === "consegnato" ? "il materiale √® stato consegnato" : c.trackingStato === "montato" ? "il montaggio √® completato" : "in lavorazione"}.${c.dataPrevConsegna ? " Consegna prevista: " + c.dataPrevConsegna : ""}`,
    };
    const msg = encodeURIComponent(msgs[tipo] || "");
    window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${msg}`, "_blank");
  };

  const inviaEmail = (c, tipo: "preventivo" | "conferma" | "montaggio" | "saldo" | "generico") => {
    const az = aziendaDB;
    const azNome = az.ragione || az.nome || "Walter Cozza Serramenti";
    const azTel = az.telefono || "";
    const azEmail = az.email || "";
    const firma = `\nCordiali saluti,\n${azNome}${azTel ? "\nTel. " + azTel : ""}${azEmail ? "\n" + azEmail : ""}`;
    const vani = getVaniAttivi(c);
    const totale = vani.reduce((s, v) => s + calcolaVanoPrezzo(v, c), 0) + (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo||0)*(vl.qta||1)), 0);
    const ivaP = parseFloat(c.ivaPerc || 10);
    const totIva = totale * (1 + ivaP / 100);
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";
    
    const templates = {
      preventivo: {
        oggetto: `Preventivo ${c.code} ‚Äî ${azNome}`,
        corpo: `Gentile ${c.cliente} ${c.cognome || ""},\n\nle trasmetto il preventivo per la fornitura e posa in opera dei serramenti per l'immobile in ${c.indirizzo || "‚Äî"}.\n\nüìã Rif. commessa: ${c.code}\nüì¶ Vani: ${vani.length}\n${c.sistema ? "üè≠ Sistema: " + c.sistema + "\n" : ""}üí∞ Importo: ‚Ç¨${fmt(totale)} + IVA ${ivaP}% = ‚Ç¨${fmt(totIva)}\n${c.praticaFiscale ? "üìë Agevolazione: " + c.praticaFiscale + "\n" : ""}\nIl preventivo include fornitura, posa in opera, smaltimento vecchi infissi e rilascio documentazione (DoP, CE, manuale).\n\nResto a disposizione per qualsiasi chiarimento.${firma}`
      },
      conferma: {
        oggetto: `Conferma ordine ${c.code} ‚Äî ${azNome}`,
        corpo: `Gentile ${c.cliente} ${c.cognome || ""},\n\ncon la presente le confermiamo la ricezione dell'ordine per la commessa ${c.code}.\n\n‚úÖ Materiale ordinato al fornitore\n‚è± Tempi di consegna stimati: 4-6 settimane\nüìç Cantiere: ${c.indirizzo || "‚Äî"}\n\nLa terremo aggiornata sullo stato di avanzamento della produzione.\n\nPer qualsiasi necessit√† non esiti a contattarci.${firma}`
      },
      montaggio: {
        oggetto: `Programmazione montaggio ${c.code} ‚Äî ${azNome}`,
        corpo: `Gentile ${c.cliente} ${c.cognome || ""},\n\nsiamo lieti di comunicarle che il materiale per la commessa ${c.code} √® arrivato.\n\nüîß Montaggio previsto: [INSERIRE DATA]\nüìç Indirizzo: ${c.indirizzo || "‚Äî"}\n‚è± Durata stimata: ${vani.length <= 3 ? "1 giorno" : vani.length <= 6 ? "2 giorni" : "3+ giorni"}\nüë∑ Squadra: [NOME SQUADRA]\n\nüìå Note per il giorno del montaggio:\n- Assicurarsi che i locali siano accessibili\n- Spostare eventuali mobili vicino alle finestre\n- √à possibile che si verifichi polvere durante lo smontaggio\n\nLa preghiamo di confermare la data rispondendo a questa mail.${firma}`
      },
      saldo: {
        oggetto: `Completamento lavori e saldo ${c.code} ‚Äî ${azNome}`,
        corpo: `Gentile ${c.cliente} ${c.cognome || ""},\n\ncon la presente le comunichiamo che i lavori relativi alla commessa ${c.code} sono stati completati con successo.\n\n‚úÖ Fornitura e posa completata\nüì¶ Vani installati: ${vani.length}\nüìç Cantiere: ${c.indirizzo || "‚Äî"}\n\nüí∂ Importo totale: ‚Ç¨${fmt(totIva)} (IVA ${ivaP}% inclusa)\n${(() => { const inc = fattureDB.filter(f => f.cmId === c.id && f.pagata).reduce((s,f)=>s+(f.importo||0),0); return inc > 0 ? `üí≥ Gi√† versato: ‚Ç¨${fmt(inc)}\nüìÑ Saldo dovuto: ‚Ç¨${fmt(totIva - inc)}\n` : ""; })()}\nüìé In allegato:\n- Fattura di saldo\n- Dichiarazione di prestazione (DoP)\n- Certificazione CE\n- Manuale d'uso e manutenzione\n\nModalit√† di pagamento: Bonifico bancario\nIBAN: ${az.iban || "[IBAN]"}\n\nLa ringraziamo per la fiducia.${firma}`
      },
      generico: {
        oggetto: `Commessa ${c.code} ‚Äî ${azNome}`,
        corpo: `Gentile ${c.cliente} ${c.cognome || ""},\n\n[Scrivi qui il messaggio]\n\nRif. commessa: ${c.code}\nCantiere: ${c.indirizzo || "‚Äî"}${firma}`
      }
    };
    const t = templates[tipo] || templates.generico;
    setEmailDest(c.email || "");
    setEmailOggetto(t.oggetto);
    setEmailCorpo(t.corpo);
    setShowEmailComposer({ cm: c, tipo });
  };

  // =============================================
  // === ORDINI FORNITORE ‚Äî MODULO COMPLETO ===
  // =============================================

  const [ordineDetail, setOrdineDetail] = useState<string | null>(null); // id ordine aperto
  const [extractingPDF, setExtractingPDF] = useState(false); // loading AI extraction
  const [showInboxDoc, setShowInboxDoc] = useState(false); // global document inbox
  const [inboxResult, setInboxResult] = useState<any>(null); // extracted data from inbox



  // Crea nuovo ordine fornitore da commessa
  const creaOrdineFornitore = (c, fornitoreNome = "") => {
    const vani = getVaniAttivi(c);
    // Auto-genera righe da vani commessa con prezzi
    const righe = vani.map(v => {
      const tipLabel = TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo)?.label || v.tipo || "‚Äî";
      const m = v.misure || {};
      const lmm = m.lCentro || 0, hmm = m.hCentro || 0;
      const prezzo = calcolaVanoPrezzo(v, c);
      return {
        id: "r_" + Math.random().toString(36).slice(2, 8),
        desc: `${tipLabel} ‚Äî ${v.stanza || ""} ${v.piano || ""}`.trim(),
        misure: lmm > 0 && hmm > 0 ? `${lmm}√ó${hmm}` : "da definire",
        qta: v.pezzi || 1,
        prezzoUnit: Math.round(prezzo * 100) / 100,
        totale: Math.round(prezzo * (v.pezzi || 1) * 100) / 100,
        note: v.coloreEst ? `Colore: ${v.coloreEst}` : "",
      };
    });

    const ord = {
      id: "ord_" + Date.now(),
      cmId: c.id,
      cmCode: c.code,
      cliente: c.cliente,
      numero: ordiniFornDB.filter(o => new Date(o.dataOrdine).getFullYear() === new Date().getFullYear()).length + 1,
      anno: new Date().getFullYear(),
      dataOrdine: new Date().toISOString().split("T")[0],
      fornitore: {
        nome: fornitoreNome,
        email: "",
        tel: "",
        piva: "",
        referente: "",
      },
      righe,
      totale: righe.reduce((s, r) => s + r.totale, 0),
      iva: 22, // IVA fornitore standard
      totaleIva: Math.round(righe.reduce((s, r) => s + r.totale, 0) * 1.22 * 100) / 100,
      sconto: 0,

      // STATO ORDINE
      stato: "bozza" as string, // bozza ‚Üí inviato ‚Üí confermato ‚Üí in_produzione ‚Üí spedito ‚Üí consegnato

      // CONFERMA FORNITORE
      conferma: {
        ricevuta: false,
        dataRicezione: "",
        verificata: false, // MASTRO ha controllato
        differenze: "",    // note su differenze
        firmata: false,
        dataFirma: "",
        reinviata: false,
        dataReinvio: "",
      },

      // CONSEGNA
      consegna: {
        prevista: "",       // data prevista dal fornitore
        settimane: 0,       // settimane di produzione
        effettiva: "",      // data effettiva consegna
        luogo: c.indirizzo || "",
        note: "",
      },

      // PAGAMENTO
      pagamento: {
        termini: "30gg_fm" as string, // anticipato, 30gg_fm, 60gg_fm, 90gg_fm, ricevuta_merce
        scadenza: "",
        importo: 0,
        pagato: false,
        dataPagamento: "",
        metodo: "", // bonifico, assegno, riba
      },

      note: "",
    };

    setOrdiniFornDB(prev => [...prev, ord]);
    setFaseTo(c.id, "ordini"); // AUTO-ADVANCE: ordine creato ‚Üí fase ordini
    return ord;
  };

  // Ricalcola totali ordine
  const ricalcolaOrdine = (ordId: string) => {
    setOrdiniFornDB(prev => prev.map(o => {
      if (o.id !== ordId) return o;
      const subtot = o.righe.reduce((s, r) => s + (r.qta * r.prezzoUnit), 0);
      const scontoVal = subtot * (o.sconto || 0) / 100;
      const imponibile = subtot - scontoVal;
      const ivaVal = imponibile * o.iva / 100;
      return { ...o, totale: imponibile, totaleIva: imponibile + ivaVal, pagamento: { ...o.pagamento, importo: imponibile + ivaVal } };
    }));
  };

  // Aggiorna campo ordine
  const updateOrdine = (ordId: string, path: string, value: any) => {
    setOrdiniFornDB(prev => prev.map(o => {
      if (o.id !== ordId) return o;
      const parts = path.split(".");
      const updated = { ...o };
      let current: any = updated;
      for (let i = 0; i < parts.length - 1; i++) {
        current[parts[i]] = { ...current[parts[i]] };
        current = current[parts[i]];
      }
      current[parts[parts.length - 1]] = value;
      return updated;
    }));
  };

  // Calcola scadenza pagamento
  const calcolaScadenzaPagamento = (dataOrdine: string, termini: string) => {
    const d = new Date(dataOrdine);
    if (termini === "anticipato") return dataOrdine;
    if (termini === "ricevuta_merce") return ""; // da compilare alla consegna
    const days = termini === "30gg_fm" ? 30 : termini === "60gg_fm" ? 60 : termini === "90gg_fm" ? 90 : 30;
    // Fine mese + giorni
    const fm = new Date(d.getFullYear(), d.getMonth() + 1, 0); // fine mese ordine
    fm.setDate(fm.getDate() + days);
    return fm.toISOString().split("T")[0];
  };

  // Genera PDF ordine fornitore
  const generaOrdinePDF = (ord) => {
    const az = aziendaDB;
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0,00";
    const imponibile = ord.totale;
    const ivaVal = imponibile * ord.iva / 100;
    const scontoPerc = ord.sconto || 0;

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:'Helvetica Neue',Arial,sans-serif;font-size:11px;color:#1a1a1c;padding:20px;max-width:800px;margin:0 auto}
      .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #1a1a1c}
      .title{font-size:20px;font-weight:800;letter-spacing:-0.3px}
      table{width:100%;border-collapse:collapse;margin:16px 0}
      th{background:#f5f5f7;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #ddd}
      td{padding:8px 10px;border-bottom:1px solid #eee}
      .total-row td{font-weight:700;border-top:2px solid #1a1a1c;border-bottom:none}
      .box{background:#f9f9fb;border-radius:8px;padding:14px;margin-bottom:12px}
      .sign-area{margin-top:40px;display:flex;justify-content:space-between}
      .sign-box{width:45%;border-top:1px solid #aaa;padding-top:8px;text-align:center;font-size:10px;color:#888}
      @media print{body{padding:10px}}
    </style></head><body>

    <div class="header">
      <div>
        ${az.logo ? `<img src="${az.logo}" style="max-height:45px;margin-bottom:6px" /><br>` : ""}
        <div class="title">${az.nome || "MASTRO"}</div>
        <div style="font-size:10px;color:#666;margin-top:2px">${az.indirizzo || ""}<br>${az.tel || ""} ¬∑ ${az.email || ""}<br>${az.piva ? "P.IVA " + az.piva : ""}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:16px;font-weight:800;color:#007aff">ORDINE FORNITORE</div>
        <div style="font-size:12px;font-weight:700">N. ${ord.numero}/${ord.anno}</div>
        <div style="font-size:10px;color:#666">Data: ${new Date(ord.dataOrdine).toLocaleDateString("it-IT")}</div>
        <div style="font-size:10px;color:#666">Rif. Commessa: ${ord.cmCode}</div>
      </div>
    </div>

    <div style="display:flex;gap:16px;margin-bottom:16px">
      <div class="box" style="flex:1">
        <div style="font-size:9px;text-transform:uppercase;color:#888;letter-spacing:1px;margin-bottom:6px">Fornitore</div>
        <div style="font-size:14px;font-weight:700">${ord.fornitore.nome || "‚Äî"}</div>
        ${ord.fornitore.referente ? `<div>Att.ne: ${ord.fornitore.referente}</div>` : ""}
        ${ord.fornitore.email ? `<div>${ord.fornitore.email}</div>` : ""}
        ${ord.fornitore.tel ? `<div>${ord.fornitore.tel}</div>` : ""}
        ${ord.fornitore.piva ? `<div>P.IVA: ${ord.fornitore.piva}</div>` : ""}
      </div>
      <div class="box" style="flex:1">
        <div style="font-size:9px;text-transform:uppercase;color:#888;letter-spacing:1px;margin-bottom:6px">Consegna</div>
        <div style="font-size:12px;font-weight:600">${ord.consegna.luogo || "Da definire"}</div>
        ${ord.consegna.prevista ? `<div>üìÖ Prevista: ${new Date(ord.consegna.prevista).toLocaleDateString("it-IT")}</div>` : ""}
        ${ord.consegna.settimane ? `<div>‚è± Produzione: ${ord.consegna.settimane} settimane</div>` : ""}
        <div style="margin-top:4px;font-size:10px;color:#888">Pagamento: ${ord.pagamento.termini === "anticipato" ? "Anticipato" : ord.pagamento.termini === "30gg_fm" ? "30gg FM" : ord.pagamento.termini === "60gg_fm" ? "60gg FM" : ord.pagamento.termini === "90gg_fm" ? "90gg FM" : "A ricevimento merce"}</div>
      </div>
    </div>

    <div style="font-size:12px;font-weight:700;margin-bottom:4px">Cliente finale: ${ord.cliente}</div>

    <table>
      <tr><th style="width:5%">#</th><th style="width:40%">Descrizione</th><th style="width:12%">Misure</th><th style="width:8%">Qt√†</th><th style="width:15%">Prezzo Unit.</th><th style="width:15%">Totale</th><th>Note</th></tr>
      ${ord.righe.map((r, i) => `<tr>
        <td>${i + 1}</td>
        <td style="font-weight:600">${r.desc}</td>
        <td>${r.misure}</td>
        <td style="text-align:center">${r.qta}</td>
        <td style="text-align:right">&euro;${fmt(r.prezzoUnit)}</td>
        <td style="text-align:right">&euro;${fmt(r.qta * r.prezzoUnit)}</td>
        <td style="font-size:9px;color:#666">${r.note || ""}</td>
      </tr>`).join("")}
      ${scontoPerc > 0 ? `<tr><td colspan="5" style="text-align:right;font-weight:600">Sconto ${scontoPerc}%</td><td style="text-align:right;color:#ff3b30">-&euro;${fmt(ord.righe.reduce((s, r) => s + r.qta * r.prezzoUnit, 0) * scontoPerc / 100)}</td><td></td></tr>` : ""}
      <tr><td colspan="5" style="text-align:right">Imponibile</td><td style="text-align:right">&euro;${fmt(imponibile)}</td><td></td></tr>
      <tr><td colspan="5" style="text-align:right">IVA ${ord.iva}%</td><td style="text-align:right">&euro;${fmt(ivaVal)}</td><td></td></tr>
      <tr class="total-row"><td colspan="5" style="text-align:right;font-size:13px">TOTALE</td><td style="text-align:right;font-size:13px">&euro;${fmt(ord.totaleIva)}</td><td></td></tr>
    </table>

    ${ord.note ? `<div class="box"><div style="font-size:9px;text-transform:uppercase;color:#888;margin-bottom:4px">Note</div>${ord.note}</div>` : ""}

    <div class="sign-area">
      <div class="sign-box">Timbro e firma ordinante<br><br><br></div>
      <div class="sign-box">Per accettazione fornitore<br><br><br></div>
    </div>

    <div style="text-align:center;font-size:8px;color:#ccc;margin-top:30px">Generato con MASTRO ¬∑ ${new Date().toLocaleDateString("it-IT")}</div>
    </body></html>`;

    const w = window.open("", "_blank");
    if (w) { w.document.write(html); w.document.close(); w.print(); }
  };

  // Genera PDF conferma firmata (per reinvio al fornitore)
  const generaConfermaFirmataPDF = (ord) => {
    const az = aziendaDB;
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:'Helvetica Neue',Arial,sans-serif;font-size:11px;color:#1a1a1c;padding:30px;max-width:800px;margin:0 auto}
      .stamp{border:3px solid #34c759;border-radius:12px;padding:16px;margin:20px 0;text-align:center}
    </style></head><body>
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:18px;font-weight:800;color:#34c759">‚úÖ CONFERMA ORDINE APPROVATA</div>
      <div style="font-size:12px;color:#666;margin-top:4px">Ordine N. ${ord.numero}/${ord.anno} ‚Äî ${ord.fornitore.nome}</div>
    </div>

    <div style="background:#f9f9fb;border-radius:8px;padding:14px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between">
        <div><b>Committente:</b> ${az.nome || "MASTRO"}<br>${az.indirizzo || ""}<br>${az.piva ? "P.IVA " + az.piva : ""}</div>
        <div style="text-align:right"><b>Fornitore:</b> ${ord.fornitore.nome}<br>${ord.fornitore.email || ""}<br>${ord.fornitore.piva ? "P.IVA " + ord.fornitore.piva : ""}</div>
      </div>
    </div>

    <div style="margin:14px 0"><b>Rif. Commessa:</b> ${ord.cmCode} ‚Äî ${ord.cliente}</div>

    <table style="width:100%;border-collapse:collapse">
      <tr><th style="background:#34c75920;padding:8px;text-align:left;border-bottom:2px solid #34c759">#</th><th style="background:#34c75920;padding:8px;text-align:left;border-bottom:2px solid #34c759">Descrizione</th><th style="background:#34c75920;padding:8px;border-bottom:2px solid #34c759">Misure</th><th style="background:#34c75920;padding:8px;border-bottom:2px solid #34c759">Qt√†</th><th style="background:#34c75920;padding:8px;text-align:right;border-bottom:2px solid #34c759">Prezzo</th></tr>
      ${ord.righe.map((r, i) => `<tr><td style="padding:6px;border-bottom:1px solid #eee">${i + 1}</td><td style="padding:6px;border-bottom:1px solid #eee">${r.desc}</td><td style="padding:6px;border-bottom:1px solid #eee">${r.misure}</td><td style="padding:6px;border-bottom:1px solid #eee;text-align:center">${r.qta}</td><td style="padding:6px;border-bottom:1px solid #eee;text-align:right">&euro;${fmt(r.qta * r.prezzoUnit)}</td></tr>`).join("")}
    </table>
    <div style="text-align:right;font-size:14px;font-weight:800;margin-top:8px">TOTALE: &euro;${fmt(ord.totaleIva)}</div>

    <div class="stamp">
      <div style="font-size:14px;font-weight:800;color:#34c759">CONFERMATO E APPROVATO</div>
      <div style="font-size:11px;color:#666;margin-top:4px">Data conferma: ${ord.conferma.dataFirma ? new Date(ord.conferma.dataFirma).toLocaleDateString("it-IT") : new Date().toLocaleDateString("it-IT")}</div>
      <div style="font-size:11px;color:#666">Consegna prevista: ${ord.consegna.prevista ? new Date(ord.consegna.prevista).toLocaleDateString("it-IT") : "Da concordare"}</div>
      <div style="font-size:11px;color:#666">Pagamento: ${ord.pagamento.termini === "anticipato" ? "Anticipato" : ord.pagamento.termini.replace("_", " ").toUpperCase()}</div>
      ${ord.conferma.differenze ? `<div style="margin-top:8px;font-size:10px;color:#ff9500;font-weight:600">‚ö†Ô∏è Note: ${ord.conferma.differenze}</div>` : ""}
    </div>

    <div style="display:flex;justify-content:space-between;margin-top:40px">
      <div style="width:45%;border-top:1px solid #aaa;padding-top:8px;text-align:center;font-size:10px;color:#888">Firma ${az.nome || "committente"}<br>${ord.conferma.dataFirma || ""}</div>
      <div style="width:45%;border-top:1px solid #aaa;padding-top:8px;text-align:center;font-size:10px;color:#888">Per accettazione fornitore</div>
    </div>
    </body></html>`;

    const w = window.open("", "_blank");
    if (w) { w.document.write(html); w.document.close(); w.print(); }
  };

  // Invio ordine/conferma via email/whatsapp
  const inviaOrdineFornitore = (ord, mezzo: "email" | "whatsapp") => {
    const az = aziendaDB;
    if (mezzo === "email") {
      const subject = ord.conferma.firmata
        ? `Conferma ordine N.${ord.numero}/${ord.anno} ‚Äî ${az.nome}`
        : `Ordine N.${ord.numero}/${ord.anno} ‚Äî ${az.nome}`;
      const body = ord.conferma.firmata
        ? `Gentile ${ord.fornitore.referente || ord.fornitore.nome},\n\nconfermiamo l'ordine N.${ord.numero}/${ord.anno} per la commessa ${ord.cmCode} (${ord.cliente}).\n\nTotale: ‚Ç¨${ord.totaleIva?.toLocaleString("it-IT", { minimumFractionDigits: 2 })}\nConsegna prevista: ${ord.consegna.prevista ? new Date(ord.consegna.prevista).toLocaleDateString("it-IT") : "da concordare"}\nPagamento: ${ord.pagamento.termini}\n\nIn allegato la conferma firmata.\n\nCordiali saluti,\n${az.nome}`
        : `Gentile ${ord.fornitore.referente || ord.fornitore.nome},\n\ncon la presente vi trasmettiamo l'ordine N.${ord.numero}/${ord.anno} per la commessa ${ord.cmCode} (${ord.cliente}).\n\nRichiediamo conferma d'ordine con tempi di consegna e condizioni di pagamento.\n\nCordiali saluti,\n${az.nome}`;
      window.open(`mailto:${ord.fornitore.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, "_blank");
    } else {
      const tel = (ord.fornitore.tel || "").replace(/\D/g, "");
      const msg = ord.conferma.firmata
        ? `Buongiorno, vi confermiamo ordine N.${ord.numero}/${ord.anno} ‚Äî Commessa ${ord.cmCode} (${ord.cliente}). Totale ‚Ç¨${ord.totaleIva?.toLocaleString("it-IT", { minimumFractionDigits: 2 })}. Consegna prevista: ${ord.consegna.prevista ? new Date(ord.consegna.prevista).toLocaleDateString("it-IT") : "da concordare"}. Vi inviamo conferma firmata via email. ${az.nome}`
        : `Buongiorno, vi invio ordine N.${ord.numero}/${ord.anno} ‚Äî Commessa ${ord.cmCode} (${ord.cliente}). Attendo conferma d'ordine con tempi e condizioni. Grazie. ${az.nome}`;
      window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(msg)}`, "_blank");
    }
  };

  // Stati ordine con colori
  const ORDINE_STATI = [
    { id: "bozza", label: "Bozza", icon: "üìù", color: "#8e8e93" },
    { id: "inviato", label: "Inviato", icon: "üì§", color: "#007aff" },
    { id: "confermato", label: "Confermato", icon: "‚úÖ", color: "#34c759" },
    { id: "in_produzione", label: "In Produzione", icon: "üè≠", color: "#ff9500" },
    { id: "spedito", label: "Spedito", icon: "üöõ", color: "#5856d6" },
    { id: "consegnato", label: "Consegnato", icon: "üì¶", color: "#30b0c7" },
  ];

  // === PIANIFICAZIONE MONTAGGIO ===
  const creaMontaggio = (c) => {
    const m = {
      id: "mont_" + Date.now(),
      cmId: c.id,
      cmCode: c.code,
      cliente: c.cliente,
      indirizzo: c.indirizzo || "",
      squadraId: squadreDB[0]?.id || "",
      data: "",
      oraInizio: "08:00",
      durata: "giornata", // "mezza", "giornata", "2giorni", "3giorni"
      stato: "pianificato", // pianificato, in_corso, completato
      note: "",
      vaniCount: getVaniAttivi(c).length,
    };
    setMontaggiDB(prev => [...prev, m]);
    return m;
  };

  // Genera giorni della settimana
  const getWeekDays = (offset: number) => {
    const now = new Date();
    const monday = new Date(now);
    monday.setDate(now.getDate() - now.getDay() + 1 + offset * 7);
    return Array.from({ length: 7 }, (_, i) => {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      return d;
    });
  };

  // Render calendario montaggi (vista settimanale con squadre)
  const renderCalendarioMontaggi = (targetMontaggioId?: string) => {
    const days = getWeekDays(calMontaggiWeek);
    const durataGiorni = (d: string) => d === "mezza" ? 0.5 : d === "2giorni" ? 2 : d === "3giorni" ? 3 : 1;
    const isOccupied = (sq: any, day: Date) => {
      const dayStr = day.toISOString().split("T")[0];
      return montaggiDB.some(m => {
        if (m.squadraId !== sq.id || !m.data || m.stato === "completato") return false;
        const startDate = new Date(m.data);
        const numDays = durataGiorni(m.durata);
        for (let i = 0; i < Math.ceil(numDays); i++) {
          const d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          if (d.toISOString().split("T")[0] === dayStr) return m;
        }
        return false;
      });
    };
    const today = new Date().toISOString().split("T")[0];
    const isSunday = (d: Date) => d.getDay() === 0;

    return (
      <div style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, overflow: "hidden" }}>
        {/* Header navigazione settimana */}
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 12px", background: T.bg, borderBottom: `1px solid ${T.bdr}` }}>
          <div onClick={() => setCalMontaggiWeek(w => w - 1)} style={{ padding: "4px 10px", cursor: "pointer", fontSize: 16, fontWeight: 700, color: T.acc }}>‚óÄ</div>
          <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>
            {days[0].toLocaleDateString("it-IT", { day: "numeric", month: "short" })} ‚Äî {days[6].toLocaleDateString("it-IT", { day: "numeric", month: "short", year: "numeric" })}
          </div>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <div onClick={() => setCalMontaggiWeek(0)} style={{ padding: "3px 8px", borderRadius: 6, background: calMontaggiWeek === 0 ? T.acc : "transparent", color: calMontaggiWeek === 0 ? "#fff" : T.sub, fontSize: 9, fontWeight: 700, cursor: "pointer" }}>Oggi</div>
            <div onClick={() => setCalMontaggiWeek(w => w + 1)} style={{ padding: "4px 10px", cursor: "pointer", fontSize: 16, fontWeight: 700, color: T.acc }}>‚ñ∂</div>
          </div>
        </div>

        {/* Griglia: header giorni */}
        <div style={{ display: "grid", gridTemplateColumns: `80px repeat(7, 1fr)`, fontSize: 9 }}>
          <div style={{ padding: "6px 4px", fontWeight: 700, color: T.sub, textAlign: "center", borderBottom: `1px solid ${T.bdr}`, borderRight: `1px solid ${T.bdr}` }}>Squadra</div>
          {days.map((d, i) => {
            const isToday = d.toISOString().split("T")[0] === today;
            const isSun = isSunday(d);
            return (
              <div key={i} style={{
                padding: "6px 2px", textAlign: "center", fontWeight: 700,
                color: isToday ? "#fff" : isSun ? T.red : T.text,
                background: isToday ? T.acc : isSun ? "#ff3b3010" : "transparent",
                borderBottom: `1px solid ${T.bdr}`,
                borderRight: i < 6 ? `1px solid ${T.bdr}` : "none",
              }}>
                <div>{["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"][i]}</div>
                <div style={{ fontSize: 12 }}>{d.getDate()}</div>
              </div>
            );
          })}

          {/* Righe squadre */}
          {squadreDB.map(sq => (
            <React.Fragment key={sq.id}>
              <div style={{ padding: "8px 6px", fontWeight: 700, fontSize: 10, color: sq.colore, borderRight: `1px solid ${T.bdr}`, borderBottom: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 3 }}>
                <div style={{ width: 8, height: 8, borderRadius: 4, background: sq.colore, flexShrink: 0 }} />
                {sq.nome}
              </div>
              {days.map((d, i) => {
                const occ = isOccupied(sq, d);
                const dayStr = d.toISOString().split("T")[0];
                const isPast = dayStr < today;
                const isSun = isSunday(d);
                const canClick = !occ && !isPast && !isSun && targetMontaggioId;
                return (
                  <div key={i} onClick={() => {
                    if (canClick) {
                      setMontaggiDB(prev => prev.map(m => m.id === targetMontaggioId ? { ...m, data: dayStr, squadraId: sq.id } : m));
                    }
                  }} style={{
                    padding: "4px 3px", borderBottom: `1px solid ${T.bdr}`,
                    borderRight: i < 6 ? `1px solid ${T.bdr}` : "none",
                    background: occ ? sq.colore + "20" : isPast ? T.bg + "80" : isSun ? "#ff3b3005" : canClick ? "#34c75908" : "transparent",
                    cursor: canClick ? "pointer" : "default",
                    minHeight: 36, position: "relative" as any,
                  }}>
                    {occ && (
                      <div style={{ fontSize: 7, fontWeight: 700, color: sq.colore, lineHeight: 1.2 }}>
                        <div>{(occ as any).cliente?.slice(0, 8)}</div>
                        <div style={{ color: T.sub }}>{(occ as any).vaniCount}v ¬∑ {(occ as any).durata === "mezza" ? "¬Ω" : (occ as any).durata === "2giorni" ? "2g" : (occ as any).durata === "3giorni" ? "3g" : "1g"}</div>
                      </div>
                    )}
                    {canClick && !occ && (
                      <div style={{ position: "absolute" as any, inset: 0, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, color: "#34c75950" }}>+</div>
                    )}
                  </div>
                );
              })}
            </React.Fragment>
          ))}
        </div>

        {/* Legenda */}
        <div style={{ padding: "6px 12px", display: "flex", gap: 12, flexWrap: "wrap" as any, fontSize: 9, color: T.sub, borderTop: `1px solid ${T.bdr}` }}>
          {squadreDB.map(sq => (
            <span key={sq.id} style={{ display: "flex", alignItems: "center", gap: 3 }}>
              <div style={{ width: 8, height: 8, borderRadius: 2, background: sq.colore }} />
              {sq.nome}: {montaggiDB.filter(m => m.squadraId === sq.id && m.stato !== "completato").length} in programma
            </span>
          ))}
          <span style={{ display: "flex", alignItems: "center", gap: 3 }}>
            <div style={{ width: 8, height: 8, borderRadius: 2, background: "#ff9500" }} />
            Consegne: {ordiniFornDB.filter(o => o.dataConsegnaPrev && o.stato !== "consegnato").length} attese
          </span>
        </div>

        {/* Consegne fornitore nella settimana */}
        {(() => {
          const weekDeliveries = ordiniFornDB.filter(o => {
            if (!o.dataConsegnaPrev || o.stato === "consegnato") return false;
            const d = new Date(o.dataConsegnaPrev);
            return d >= days[0] && d <= days[6];
          });
          if (weekDeliveries.length === 0) return null;
          return (
            <div style={{ padding: "8px 12px", borderTop: `1px solid ${T.bdr}`, background: "#ff950008" }}>
              <div style={{ fontSize: 9, fontWeight: 700, color: "#ff9500", marginBottom: 4 }}>üöõ Consegne questa settimana:</div>
              {weekDeliveries.map(o => {
                const cm = cantieri.find(cc => cc.id === o.cmId);
                const isLate = new Date(o.dataConsegnaPrev) < new Date();
                return (
                  <div key={o.id} style={{ fontSize: 10, color: isLate ? T.red : T.text, padding: "2px 0", display: "flex", gap: 8 }}>
                    <span style={{ fontWeight: 700, width: 30, color: "#ff9500" }}>{new Date(o.dataConsegnaPrev).toLocaleDateString("it-IT", { weekday: "short" })}</span>
                    <span style={{ fontWeight: 600 }}>{o.fornitore}</span>
                    <span style={{ color: T.sub }}>‚Üí {cm?.cliente || o.cmId}</span>
                    {o.costo > 0 && <span style={{ color: T.sub }}>‚Ç¨{o.costo.toLocaleString("it-IT")}</span>}
                    {isLate && <span style={{ color: T.red, fontWeight: 700 }}>‚ö†Ô∏è RITARDO</span>}
                  </div>
                );
              })}
            </div>
          );
        })()}
      </div>
    );
  };

  // === PAGINA PREVENTIVO CONDIVISIBILE (link per cliente) ===
  const generaPreventivoCondivisibile = async (c) => {
    const az = aziendaDB;
    const vani = getVaniAttivi(c);
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0,00";
    // Calcola prezzi reali dai sistemi/griglie
    const vaniConPrezzi = vani.map(v => ({ ...v, _prezzo: calcolaVanoPrezzo(v, c) }));
    const subtot = vaniConPrezzi.reduce((s, v) => s + v._prezzo, 0) + (c.vociLibere || []).reduce((s, vl) => s + ((vl.importo || 0) * (vl.qta || 1)), 0);
    const iva = subtot * 0.1;
    const tot = subtot + iva;

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#1d1d1f;max-width:600px;margin:0 auto;padding:16px;background:#f5f5f7}
      .card{background:#fff;border-radius:14px;padding:18px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
      .header{text-align:center;margin-bottom:16px}
      .logo{max-height:50px;margin-bottom:8px}
      .title{font-size:22px;font-weight:800;color:#1d1d1f}
      .sub{font-size:12px;color:#86868b}
      .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f0f0f0;font-size:13px}
      .row:last-child{border:none}
      .total{font-size:18px;font-weight:800;color:#007aff;text-align:right;padding:12px 0}
      .btn{width:100%;padding:16px;border-radius:12px;border:none;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;font-family:inherit}
      .btn-green{background:#34c759;color:#fff}
      .btn-outline{background:#fff;color:#007aff;border:2px solid #007aff}
      canvas{border:1px solid #e5e5ea;border-radius:10px;background:#fff;touch-action:none}
      .firma-done{background:#f0fdf4;border:2px solid #34c759;border-radius:12px;padding:16px;text-align:center}
    </style></head><body>
    <div class="header">
      ${az.logo ? `<img src="${az.logo}" class="logo"/><br>` : ""}
      <div class="title">${az.nome || "MASTRO"}</div>
      <div class="sub">${az.indirizzo || ""}<br>${az.tel || ""} ¬∑ ${az.email || ""}</div>
    </div>

    <div class="card">
      <div style="font-size:11px;text-transform:uppercase;color:#86868b;letter-spacing:1px;margin-bottom:8px">Preventivo</div>
      <div style="font-size:16px;font-weight:700">${c.code}</div>
      <div style="font-size:13px;color:#86868b;margin-top:2px">Per: ${c.cliente} ${c.cognome || ""}</div>
      <div style="font-size:12px;color:#86868b">${c.indirizzo || ""}</div>
      <div style="font-size:11px;color:#86868b;margin-top:4px">Data: ${new Date().toLocaleDateString("it-IT")}</div>
    </div>

    <div class="card">
      <div style="font-size:11px;text-transform:uppercase;color:#86868b;letter-spacing:1px;margin-bottom:10px">Riepilogo fornitura</div>
      ${vaniConPrezzi.map((v, i) => {
        const tipLabel = TIPOLOGIE_RAPIDE.find(t => t.code === v.tipo)?.label || v.tipo || "Vano";
        return `<div class="row">
          <div><strong>${i + 1}. ${tipLabel}</strong><br><span style="font-size:11px;color:#86868b">${v.stanza || ""} ${v.piano || ""} ‚Äî ${v.misure?.lCentro || 0}√ó${v.misure?.hCentro || 0} mm</span></div>
          <div style="font-weight:700;white-space:nowrap">&euro;${fmt(v._prezzo)}</div>
        </div>`;
      }).join("")}
      ${(c.vociLibere || []).map(vl => `<div class="row"><div>${vl.desc}</div><div style="font-weight:700">&euro;${fmt(vl.importo)}</div></div>`).join("")}
      <div style="border-top:2px solid #e5e5ea;margin-top:8px;padding-top:8px">
        <div class="row"><span>Imponibile</span><span style="font-weight:600">&euro;${fmt(subtot)}</span></div>
        <div class="row"><span>IVA 10%</span><span>&euro;${fmt(iva)}</span></div>
      </div>
      <div class="total">TOTALE: &euro;${fmt(tot)}</div>
    </div>

    ${c.condPagamento ? `<div class="card"><div style="font-size:11px;text-transform:uppercase;color:#86868b;letter-spacing:1px;margin-bottom:6px">Condizioni di pagamento</div><div style="font-size:12px;line-height:1.5">${c.condPagamento.replace(/\n/g, "<br>")}</div></div>` : ""}

    <div class="card" id="firma-section">
      <div style="font-size:11px;text-transform:uppercase;color:#86868b;letter-spacing:1px;margin-bottom:10px">Firma di accettazione</div>
      <div id="firma-pad" style="text-align:center">
        <canvas id="sigCanvas" width="340" height="150" style="width:100%;max-width:340px"></canvas>
        <div style="font-size:10px;color:#86868b;margin-top:4px">Firma con il dito o con il mouse</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-outline" onclick="clearSig()" style="flex:1;padding:10px;font-size:13px">Cancella</button>
          <button class="btn btn-green" onclick="confirmSig()" style="flex:1;padding:10px;font-size:13px">‚úÖ Conferma e Firma</button>
        </div>
      </div>
      <div id="firma-done" class="firma-done" style="display:none">
        <div style="font-size:24px;margin-bottom:6px">‚úÖ</div>
        <div style="font-size:16px;font-weight:700;color:#34c759">Preventivo Firmato!</div>
        <div style="font-size:12px;color:#86868b;margin-top:4px">Grazie per la conferma. Ricever√† aggiornamenti sull'avanzamento del suo ordine.</div>
        <img id="firma-img" style="max-height:60px;margin-top:10px" alt=""/>
      </div>
    </div>

    <div style="text-align:center;font-size:10px;color:#ccc;margin-top:16px">Generato con MASTRO ¬∑ ${new Date().toLocaleDateString("it-IT")}</div>

    <script>
    const canvas=document.getElementById('sigCanvas'),ctx=canvas.getContext('2d');
    let drawing=false,lastX=0,lastY=0,hasDrawn=false;
    ctx.strokeStyle='#1d1d1f';ctx.lineWidth=2;ctx.lineCap='round';
    function getPos(e){const r=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
    canvas.addEventListener('mousedown',e=>{drawing=true;const p=getPos(e);lastX=p.x;lastY=p.y;});
    canvas.addEventListener('mousemove',e=>{if(!drawing)return;hasDrawn=true;const p=getPos(e);ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(p.x,p.y);ctx.stroke();lastX=p.x;lastY=p.y;});
    canvas.addEventListener('mouseup',()=>drawing=false);
    canvas.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;const p=getPos(e);lastX=p.x;lastY=p.y;},{passive:false});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(!drawing)return;hasDrawn=true;const p=getPos(e);ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(p.x,p.y);ctx.stroke();lastX=p.x;lastY=p.y;},{passive:false});
    canvas.addEventListener('touchend',()=>drawing=false);
    function clearSig(){ctx.clearRect(0,0,canvas.width,canvas.height);hasDrawn=false;}
    function confirmSig(){
      if(!hasDrawn){alert('Firma prima di confermare');return;}
      const img=canvas.toDataURL();
      document.getElementById('firma-pad').style.display='none';
      document.getElementById('firma-done').style.display='block';
      document.getElementById('firma-img').src=img;
    }
    <\/script>
    </body></html>`;

    // Upload to Supabase Storage per URL pubblico condivisibile
    const fileName = `preventivo_${c.code}_${Date.now()}.html`;
    try {
      const blob = new Blob([html], { type: "text/html" });
      const { data: uploadData, error } = await supabase.storage
        .from("preventivi")
        .upload(`public/${fileName}`, blob, { contentType: "text/html", upsert: true });
      
      if (!error && uploadData) {
        const { data: urlData } = supabase.storage.from("preventivi").getPublicUrl(`public/${fileName}`);
        const publicUrl = urlData?.publicUrl;
        if (publicUrl) {
          // Salva URL nella commessa
          setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, linkPreventivo: publicUrl } : x));
          setSelectedCM(p => p?.id === c.id ? { ...p, linkPreventivo: publicUrl } : p);
          
          // Apri link + offri invio WhatsApp
          window.open(publicUrl, "_blank");
          
          // Auto-WhatsApp
          const tel = (c.telefono || "").replace(/\D/g, "");
          if (tel) {
            const msg = `Gentile ${c.cliente}, ecco il preventivo per ${c.code}:\n${publicUrl}\n\nPu√≤ visionarlo e firmarlo direttamente dal suo telefono.\n\nCordiali saluti,\n${aziendaDB.nome || "MASTRO"}`;
            setTimeout(() => {
              if (confirm("Inviare il link via WhatsApp al cliente?")) {
                window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(msg)}`, "_blank");
              }
            }, 500);
          }
          return publicUrl;
        }
      }
    } catch (e) { console.warn("Upload Supabase non riuscito, uso blob locale:", e); }
    
    // Fallback: blob locale se Supabase non disponibile
    const blobFallback = new Blob([html], { type: "text/html" });
    const urlFallback = URL.createObjectURL(blobFallback);
    window.open(urlFallback, "_blank");
    return urlFallback;
  };

  // === UPLOAD CONFERMA FORNITORE (Supabase Storage + AI Extraction) ===
  const uploadConfermaFornitore = (ordId: string) => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/pdf,image/*";
    input.onchange = async (e: any) => {
      const file = e.target.files?.[0];
      if (!file) return;

      // 1. Upload a Supabase Storage
      const fileName = `conferma_${ordId}_${Date.now()}_${file.name}`;
      let fileUrl = "";
      try {
        const { data: uploadData, error } = await supabase.storage
          .from("conferme-fornitore")
          .upload(`docs/${fileName}`, file, { contentType: file.type, upsert: true });
        if (!error && uploadData) {
          const { data: urlData } = supabase.storage.from("conferme-fornitore").getPublicUrl(`docs/${fileName}`);
          fileUrl = urlData?.publicUrl || "";
        }
      } catch (err) { console.warn("Upload Supabase fallito:", err); }

      // 2. AI Extraction ‚Äî funziona con PDF, immagini, scansioni
      let extractedData: any = {};
      setExtractingPDF(true);
      try {
        extractedData = await estraiDatiPDF(file);
      } catch (err) { console.warn("Estrazione:", err); }
      setExtractingPDF(false);

      // 3. Aggiorna ordine con allegato + dati estratti
      setOrdiniFornDB(prev => prev.map(o => {
        if (o.id !== ordId) return o;
        const updated = {
          ...o,
          conferma: {
            ...o.conferma,
            ricevuta: true,
            dataRicezione: new Date().toISOString().split("T")[0],
            nomeFile: file.name,
            fileUrl: fileUrl,
            datiEstratti: extractedData, // salva tutto per riferimento
          },
          stato: o.stato === "bozza" || o.stato === "inviato" ? "confermato" : o.stato,
        };
        // Auto-fill dati estratti
        if (extractedData.totale) updated.totaleIva = extractedData.totale;
        if (extractedData.imponibile) updated.totale = extractedData.imponibile;
        if (extractedData.settimane) updated.consegna = { ...updated.consegna, settimane: extractedData.settimane };
        if (extractedData.dataConsegna) updated.consegna = { ...updated.consegna, prevista: extractedData.dataConsegna };
        if (extractedData.pagamento) updated.pagamento = { ...updated.pagamento, termini: extractedData.pagamento };
        if (extractedData.fornitoreNome && !o.fornitore?.nome) updated.fornitore = { ...updated.fornitore, nome: extractedData.fornitoreNome };
        if (extractedData.numeroOrdine) updated.numero = extractedData.numeroOrdine;
        // Auto-fill righe se estratte dall'AI
        if (extractedData.righe?.length > 0 && (!o.righe || o.righe.length === 0)) {
          updated.righe = extractedData.righe.map((r: any, i: number) => ({
            id: Date.now() + i,
            desc: r.descrizione || "",
            misure: r.misure || "",
            qta: r.quantita || 1,
            prezzoUnit: r.prezzo_unitario || 0,
            totale: r.prezzo_totale || (r.prezzo_unitario || 0) * (r.quantita || 1),
            note: "",
          }));
        }
        return updated;
      }));
    };
    input.click();
  };

  // === AI PDF EXTRACTION ‚Äî Claude legge QUALSIASI PDF ===
  const estraiDatiPDF = async (file: File): Promise<any> => {
    const extracted: any = { nomeFile: file.name };
    
    // Estrazione locale robusta ‚Äî funziona anche offline
    try {
      const text = await new Promise<string>((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result as string || "");
        reader.onerror = () => resolve("");
        reader.readAsText(file);
        setTimeout(() => resolve(""), 3000); // 3s max
      });
      
      if (text && text.length > 20) {
        // Totale
        const totMatch = text.match(/(?:TOTALE|Totale\s*(?:Documento|Ordine|Generale)?|Tot\.?\s*\u20ac?)\s*[\u20ac:]?\s*([\d.,]+)/i);
        if (totMatch) { const val = parseFloat(totMatch[1].replace(/\./g, "").replace(",", ".")); if (val > 0 && val < 1000000) extracted.totale = val; }
        // Imponibile
        const impMatch = text.match(/(?:Imponibile|Subtotale|Sub\s*tot)\s*[\u20ac:]?\s*([\d.,]+)/i);
        if (impMatch) { const val = parseFloat(impMatch[1].replace(/\./g, "").replace(",", ".")); if (val > 0) extracted.imponibile = val; }
        // Settimane
        const settMatch = text.match(/(\d{1,2})\s*(?:settiman[ea]|sett\.?|weeks?)/i);
        if (settMatch) extracted.settimane = parseInt(settMatch[1]);
        const giorniMatch = text.match(/(\d{1,3})\s*(?:giorni?\s*(?:lavorativ|lavor))/i);
        if (giorniMatch) extracted.settimane = Math.ceil(parseInt(giorniMatch[1]) / 5);
        // Data consegna
        const consMatch = text.match(/(?:consegna|delivery|spedizione)\s*(?:prevista)?:?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i);
        if (consMatch) { const parts = consMatch[1].split(/[\/\-]/); if (parts.length === 3) { const y = parts[2].length === 2 ? "20" + parts[2] : parts[2]; extracted.dataConsegna = y + "-" + parts[1].padStart(2, "0") + "-" + parts[0].padStart(2, "0"); } }
        // Fornitore
        const fornMatch = text.match(/(?:Da|From|Fornitore|Ragione\s*Sociale)[:\s]+([^\n]{3,50})/i);
        if (fornMatch) extracted.fornitoreNome = fornMatch[1].trim();
        // Pagamento
        const pagMatch = text.match(/(\d{2,3})\s*(?:gg|giorni)\s*(?:FM|D\.?F\.?|f\.?m\.?)?/i);
        if (pagMatch) { const days = parseInt(pagMatch[1]); extracted.pagamento = days <= 30 ? "30gg_fm" : days <= 60 ? "60gg_fm" : "90gg_fm"; }
        if (text.match(/anticip/i)) extracted.pagamento = "anticipato";
        
        extracted.text = text.slice(0, 2000); // keep snippet for classification
      }
    } catch (e) { console.warn("Estrazione fallback:", e); }
    
    // Per immagini, estrai info dal nome file
    if (file.type.startsWith("image/")) {
      const fname = file.name.toLowerCase();
      if (fname.match(/conferma|order/i)) extracted.fornitoreNome = "Da conferma";
      if (fname.match(/fattura|invoice/i)) extracted.totale = extracted.totale || 0;
      // Crea URL locale per preview
      try { extracted.previewUrl = URL.createObjectURL(file); } catch(e) {}
    }
    
    return extracted;
  };

  // === üì• INBOX UNIVERSALE ‚Äî Classifica qualsiasi documento ===
  const apriInboxDocumento = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/pdf,image/*,.jpg,.jpeg,.png";
    input.onchange = async (ev: any) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      setShowInboxDoc(true);
      setInboxResult({ stato: "caricamento", file: file.name, tipo: file.type });

      let fileUrl = "";
      let extractedData: any = {};

      try {
        // Crea URL locale per il file (funziona sempre, anche offline)
        try { fileUrl = URL.createObjectURL(file); } catch(e) {}
        
        // Prova upload Supabase (se disponibile)
        try {
          if (typeof supabase !== "undefined" && supabase?.storage) {
            const fileName = "inbox_" + Date.now() + "_" + file.name.replace(/[^a-zA-Z0-9.-]/g, "_");
            const result: any = await Promise.race([
              supabase.storage.from("conferme-fornitore").upload("docs/" + fileName, file, { contentType: file.type, upsert: true }),
              new Promise((_, rej) => setTimeout(() => rej("timeout"), 3000)),
            ]).catch(() => null);
            if (result && !result.error) {
              const { data: urlData } = supabase.storage.from("conferme-fornitore").getPublicUrl("docs/" + fileName);
              if (urlData?.publicUrl) fileUrl = urlData.publicUrl;
            }
          }
        } catch (err) { /* skip ‚Äî local URL works fine */ }

        setInboxResult((prev: any) => ({ ...prev, stato: "analisi" }));
        
        // Estrai dati dal file (max 4 secondi)
        try {
          extractedData = await Promise.race([
            estraiDatiPDF(file),
            new Promise((_, rej) => setTimeout(() => rej("timeout"), 4000)),
          ]).catch(() => ({ nomeFile: file.name }));
        } catch (err) { extractedData = { nomeFile: file.name }; }
      } catch (err) { console.warn("Inbox error:", err); extractedData = { nomeFile: file.name }; }

      // === CLASSIFICAZIONE UNIVERSALE ===
      const fname = file.name.toLowerCase();
      const dati = extractedData;
      let docTipo: string = "sconosciuto"; // firma | conferma | fattura | ricevuta | foto
      let matchedCommessa: any = null;
      let matchedOrdine: any = null;
      let confidence = 0;

      // 1. Detect tipo from filename + content
      if (fname.includes("firmato") || fname.includes("firma") || fname.includes("signed") || dati.text?.match(/firmato|firma.*cliente|approvato/i)) {
        docTipo = "firma"; confidence = 90;
      } else if (fname.includes("conferma") || fname.includes("order_confirm") || dati.fornitoreNome || dati.settimane) {
        docTipo = "conferma"; confidence = 85;
      } else if (fname.includes("fattura") || fname.includes("invoice") || dati.text?.match(/fattura\s*(n\.?|numero)/i)) {
        docTipo = "fattura"; confidence = 85;
      } else if (fname.includes("bonifico") || fname.includes("ricevuta") || fname.includes("pagamento") || dati.text?.match(/bonifico|accredito|pagamento/i)) {
        docTipo = "ricevuta"; confidence = 80;
      } else if (file.type.startsWith("image/") && !dati.fornitoreNome && !dati.totale) {
        docTipo = "foto"; confidence = 60;
      } else if (dati.fornitoreNome || dati.settimane) {
        docTipo = "conferma"; confidence = 70;
      } else if (dati.totale > 0) {
        docTipo = "fattura"; confidence = 50;
      }

      // 2. Match to commessa/ordine
      const ordiniAttivi = ordiniFornDB.filter(o => !o.conferma?.ricevuta);
      
      if (docTipo === "conferma") {
        // Match conferma to ordine fornitore
        if (dati.fornitoreNome) {
          matchedOrdine = ordiniAttivi.find(o =>
            (o.fornitore?.nome || "").toLowerCase().includes(dati.fornitoreNome.toLowerCase()) ||
            dati.fornitoreNome.toLowerCase().includes((o.fornitore?.nome || "").toLowerCase())
          );
        }
        if (!matchedOrdine && dati.totale) {
          matchedOrdine = ordiniAttivi.find(o => Math.abs((o.totaleIva || o.totale || 0) - dati.totale) < 100);
        }
        if (!matchedOrdine && ordiniAttivi.length === 1) matchedOrdine = ordiniAttivi[0];
        if (matchedOrdine) matchedCommessa = cantieri.find(cm => cm.id === matchedOrdine.cmId);
      } else if (docTipo === "firma") {
        // Match firma to commessa in attesa firma
        const cmInAttesaFirma = cantieri.filter(cm => !cm.firmaCliente && cm.rilievi?.length > 0);
        // Try match by client name in filename
        for (const cm of cmInAttesaFirma) {
          const cliName = `${cm.cliente} ${cm.cognome || ""}`.toLowerCase();
          if (fname.includes(cm.cliente.toLowerCase()) || fname.includes((cm.cognome || "").toLowerCase()) || fname.includes(cm.code.toLowerCase())) {
            matchedCommessa = cm; confidence = 95; break;
          }
        }
        if (!matchedCommessa && cmInAttesaFirma.length === 1) { matchedCommessa = cmInAttesaFirma[0]; confidence = 75; }
        if (!matchedCommessa && cmInAttesaFirma.length > 0) { matchedCommessa = null; } // ambiguous ‚Äî will show options
      } else if (docTipo === "ricevuta") {
        // Match ricevuta to fattura non pagata
        const fatNonPagate = fattureDB.filter(f => !f.pagata);
        if (dati.totale) {
          const match = fatNonPagate.find(f => Math.abs(f.importo - dati.totale) < 10);
          if (match) matchedCommessa = cantieri.find(cm => cm.id === match.cmId);
        }
        if (!matchedCommessa && fatNonPagate.length === 1) {
          matchedCommessa = cantieri.find(cm => cm.id === fatNonPagate[0].cmId);
        }
      } else if (docTipo === "foto") {
        // Match foto to montaggio in corso
        const montInCorso = montaggiDB.filter(m => m.stato === "in_corso" || m.stato === "programmato");
        if (montInCorso.length === 1) matchedCommessa = cantieri.find(cm => cm.id === montInCorso[0].cmId);
      }

      // All commesse for manual selection
      const commesseAttive = cantieri.filter(cm => cm.fase !== "chiusura");

      setInboxResult({
        stato: "completato", file: file.name, tipo: file.type, fileUrl,
        dati: extractedData, docTipo, confidence,
        matchedOrdine, matchedCommessa, tuttiOrdini: ordiniAttivi, commesseAttive,
      });
    };
    input.click();
  };

  // Conferma inbox ‚Üí assegna a ordine
  const confermaInboxDoc = (ordId: string) => {
    const res = inboxResult;
    if (!res || !ordId) return;
    setOrdiniFornDB(prev => prev.map(o => {
      if (o.id !== ordId) return o;
      const updated = {
        ...o,
        conferma: {
          ...o.conferma,
          ricevuta: true,
          dataRicezione: new Date().toISOString().split("T")[0],
          nomeFile: res.file,
          fileUrl: res.fileUrl || "",
          datiEstratti: res.dati,
        },
        stato: o.stato === "bozza" || o.stato === "inviato" ? "confermato" : o.stato,
      };
      if (res.dati?.totale) updated.totaleIva = res.dati.totale;
      if (res.dati?.imponibile) updated.totale = res.dati.imponibile;
      if (res.dati?.settimane) updated.consegna = { ...updated.consegna, settimane: res.dati.settimane };
      if (res.dati?.dataConsegna) updated.consegna = { ...updated.consegna, prevista: res.dati.dataConsegna };
      if (res.dati?.pagamento) updated.pagamento = { ...updated.pagamento, termini: res.dati.pagamento };
      if (res.dati?.righe?.length > 0 && (!o.righe || o.righe.length === 0)) {
        updated.righe = res.dati.righe.map((r: any, i: number) => ({
          id: Date.now() + i, desc: r.descrizione || "", misure: r.misure || "",
          qta: r.quantita || 1, prezzoUnit: r.prezzo_unitario || 0,
          totale: r.prezzo_totale || 0, note: "",
        }));
      }
      return updated;
    }));
    // Auto-advance commessa
    const ord = ordiniFornDB.find(o => o.id === ordId);
    if (ord?.cmId) setFaseTo(ord.cmId, "produzione");
    setShowInboxDoc(false);
    setInboxResult(null);
  };

  // Assegna documento universale a commessa/step
  const assegnaDocUniversale = (cmId: number, tipo: string) => {
    const res = inboxResult;
    if (!res) return;
    const allegato = { id: Date.now(), tipo, nome: res.file, data: new Date().toLocaleDateString("it-IT"), dataUrl: res.fileUrl || "" };
    
    if (tipo === "firma") {
      setCantieri(cs => cs.map(cm => cm.id === cmId ? {
        ...cm, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0],
        firmaDocumento: allegato, allegati: [...(cm.allegati || []), allegato],
        log: [{ chi: "Fabio", cosa: `üì• documento firmato caricato da inbox`, quando: "Adesso", color: "#34c759" }, ...(cm.log || [])]
      } : cm));
      if (selectedCM?.id === cmId) setSelectedCM(prev => ({ ...prev, firmaCliente: true, dataFirma: new Date().toISOString().split("T")[0] }));
    } else if (tipo === "ricevuta") {
      // Segna fattura come pagata
      const fatNonPagata = fattureDB.find(f => f.cmId === cmId && !f.pagata);
      if (fatNonPagata) {
        setFattureDB(prev => prev.map(f => f.id === fatNonPagata.id ? { ...f, pagata: true, dataPagamento: new Date().toISOString().split("T")[0], metodoPagamento: "Bonifico" } : f));
      }
      setCantieri(cs => cs.map(cm => cm.id === cmId ? {
        ...cm, allegati: [...(cm.allegati || []), allegato],
        log: [{ chi: "Fabio", cosa: `üì• ricevuta pagamento caricata da inbox`, quando: "Adesso", color: "#007aff" }, ...(cm.log || [])]
      } : cm));
    } else if (tipo === "foto") {
      setCantieri(cs => cs.map(cm => cm.id === cmId ? {
        ...cm, allegati: [...(cm.allegati || []), allegato],
        log: [{ chi: "Fabio", cosa: `üì• foto cantiere caricata da inbox`, quando: "Adesso", color: "#5856d6" }, ...(cm.log || [])]
      } : cm));
    } else {
      // Generic: just add as allegato
      setCantieri(cs => cs.map(cm => cm.id === cmId ? {
        ...cm, allegati: [...(cm.allegati || []), allegato],
        log: [{ chi: "Fabio", cosa: `üì• documento "${res.file}" caricato da inbox`, quando: "Adesso", color: "#86868b" }, ...(cm.log || [])]
      } : cm));
    }
    
    setShowInboxDoc(false); setInboxResult(null);
  };

  // === TRACKING CLIENTE (pagina pubblica) ===
  const generaTrackingCliente = (c) => {
    const az = aziendaDB;
    const trackSteps = [
      { id: "ordinato", label: "Ordinato", icon: "üì¶", desc: "Il materiale √® stato ordinato al fornitore" },
      { id: "produzione", label: "In Produzione", icon: "üè≠", desc: "I serramenti sono in fase di produzione" },
      { id: "pronto", label: "Pronto", icon: "‚úÖ", desc: "Il materiale √® pronto per la consegna" },
      { id: "consegnato", label: "Consegnato", icon: "üöõ", desc: "Il materiale √® stato consegnato" },
      { id: "montato", label: "Montato", icon: "üîß", desc: "L'installazione √® completata" },
    ];
    const curIdx = trackSteps.findIndex(s => s.id === c.trackingStato);
    const fatture = fattureDB.filter(f => f.cmId === c.id);
    const totFat = fatture.reduce((s, f) => s + f.importo, 0);
    const totPag = fatture.filter(f => f.pagata).reduce((s, f) => s + f.importo, 0);
    const montaggio = montaggiDB.find(m => m.cmId === c.id && m.stato !== "completato");
    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tracking Ordine ${c.code} ‚Äî ${az.nome || "MASTRO"}</title>
    <style>
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f7;color:#1a1a1c;padding:16px;max-width:480px;margin:0 auto}
      .card{background:#fff;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
      .step{display:flex;align-items:flex-start;gap:12px;padding:14px 0;border-bottom:1px solid #f0f0f2}
      .step:last-child{border-bottom:none}
      .dot{width:36px;height:36px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
      .active .dot{background:#007aff20} .done .dot{background:#34c75920} .pending .dot{background:#f0f0f2}
      .line{width:2px;height:20px;margin:0 17px;background:#e0e0e2}
      .done .line{background:#34c759} .active .line{background:#007aff}
      .badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700}
      h2{font-size:20px;font-weight:800;letter-spacing:-0.3px}
    </style></head><body>
    <div class="card" style="text-align:center">
      ${az.logo ? `<img src="${az.logo}" style="max-height:50px;max-width:180px;margin-bottom:8px" alt="">` : ""}
      <h2>${az.nome || "MASTRO"}</h2>
      <div style="font-size:12px;color:#8e8e93;margin-top:4px">${az.tel || ""} ¬∑ ${az.email || ""}</div>
    </div>

    <div class="card">
      <div style="font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Ordine</div>
      <h2>${c.code}</h2>
      <div style="font-size:13px;color:#8e8e93;margin-top:2px">${c.cliente} ${c.cognome || ""}</div>
      <div style="font-size:12px;color:#8e8e93">${c.indirizzo || ""}</div>
      ${c.dataPrevConsegna ? `<div style="margin-top:10px;padding:8px 12px;background:#007aff10;border-radius:8px;font-size:12px;color:#007aff;font-weight:600">üìÖ Consegna prevista: ${new Date(c.dataPrevConsegna).toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long", year: "numeric" })}</div>` : ""}
      ${montaggio?.data ? `<div style="margin-top:6px;padding:8px 12px;background:#30b0c710;border-radius:8px;font-size:12px;color:#30b0c7;font-weight:600">üîß Montaggio programmato: ${new Date(montaggio.data).toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })} ore ${montaggio.oraInizio || "08:00"}</div>` : ""}
    </div>

    <div class="card">
      <div style="font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Stato avanzamento</div>
      ${trackSteps.map((st, i) => {
        const isDone = i < curIdx;
        const isActive = i === curIdx;
        const cls = isDone ? "done" : isActive ? "active" : "pending";
        return `<div class="step ${cls}">
          <div>
            <div class="dot">${st.icon}</div>
            ${i < trackSteps.length - 1 ? `<div class="line"></div>` : ""}
          </div>
          <div style="padding-top:6px">
            <div style="font-size:14px;font-weight:700;color:${isDone ? "#34c759" : isActive ? "#007aff" : "#c7c7cc"}">${st.label}</div>
            <div style="font-size:11px;color:#8e8e93;margin-top:2px">${st.desc}</div>
            ${isDone && c["tracking_" + st.id + "_data"] ? `<div style="font-size:10px;color:#34c759;margin-top:2px">‚úÖ ${c["tracking_" + st.id + "_data"]}</div>` : ""}
            ${isActive ? `<span class="badge" style="background:#007aff20;color:#007aff;margin-top:4px">In corso</span>` : ""}
          </div>
        </div>`;
      }).join("")}
    </div>

    ${fatture.length > 0 ? `<div class="card">
      <div style="font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Situazione pagamenti</div>
      ${fatture.map(f => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f2">
        <div>
          <div style="font-size:12px;font-weight:600">${f.tipo === "acconto" ? "Acconto" : f.tipo === "saldo" ? "Saldo" : "Fattura"} N.${f.numero}/${f.anno}</div>
          <div style="font-size:10px;color:#8e8e93">${f.data}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:800">&euro;${fmt(f.importo)}</div>
          <div style="font-size:10px;color:${f.pagata ? "#34c759" : "#ff3b30"};font-weight:600">${f.pagata ? "‚úÖ Pagata" : "‚è≥ Da pagare"}</div>
        </div>
      </div>`).join("")}
      <div style="display:flex;justify-content:space-between;padding:10px 0 0;margin-top:4px">
        <span style="font-size:12px;color:#8e8e93">Totale: &euro;${fmt(totFat)}</span>
        <span style="font-size:12px;font-weight:700;color:${totPag >= totFat ? "#34c759" : "#ff9500"}">${totPag >= totFat ? "‚úÖ Saldato" : `Da pagare: ‚Ç¨${fmt(totFat - totPag)}`}</span>
      </div>
    </div>` : ""}

    <div style="text-align:center;font-size:10px;color:#c7c7cc;margin-top:16px;padding:12px">
      Pagina generata da MASTRO ¬∑ ${new Date().toLocaleDateString("it-IT")}
    </div>
    </body></html>`;
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
    return url;
  };

  // ‚ïê‚ïê‚ïê FATTURAZIONE ELETTRONICA XML SDI ‚ïê‚ïê‚ïê
  const generaXmlSDI = (fat) => {
    const az = aziendaDB;
    const progressivo = String(fat.numero).padStart(5, "0") + "_" + fat.anno;
    const xml = `<?xml version="1.0" encoding="UTF-8"?>
<p:FatturaElettronica xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2" versione="FPR12">
  <FatturaElettronicaHeader>
    <DatiTrasmissione>
      <IdTrasmittente><IdPaese>IT</IdPaese><IdCodice>` + (az.piva || "00000000000") + `</IdCodice></IdTrasmittente>
      <ProgressivoInvio>` + progressivo + `</ProgressivoInvio>
      <FormatoTrasmissione>FPR12</FormatoTrasmissione>
      <CodiceDestinatario>` + (fat.sdi || "0000000") + `</CodiceDestinatario>
    </DatiTrasmissione>
    <CedentePrestatore>
      <DatiAnagrafici>
        <IdFiscaleIVA><IdPaese>IT</IdPaese><IdCodice>` + (az.piva || "") + `</IdCodice></IdFiscaleIVA>
        <Anagrafica><Denominazione>` + (az.ragioneSociale || "MASTRO SRL") + `</Denominazione></Anagrafica>
        <RegimeFiscale>RF01</RegimeFiscale>
      </DatiAnagrafici>
    </CedentePrestatore>
    <CessionarioCommittente>
      <DatiAnagrafici>
        <Anagrafica><Denominazione>` + fat.cliente + ` ` + (fat.cognome || "") + `</Denominazione></Anagrafica>
      </DatiAnagrafici>
    </CessionarioCommittente>
  </FatturaElettronicaHeader>
  <FatturaElettronicaBody>
    <DatiGenerali>
      <DatiGeneraliDocumento>
        <TipoDocumento>TD01</TipoDocumento>
        <Divisa>EUR</Divisa>
        <Data>` + (fat.dataISO || new Date().toISOString().split("T")[0]) + `</Data>
        <Numero>` + fat.numero + `/` + fat.anno + `</Numero>
        <ImportoTotaleDocumento>` + fat.importo.toFixed(2) + `</ImportoTotaleDocumento>
      </DatiGeneraliDocumento>
    </DatiGenerali>
    <DatiBeniServizi>
      <DettaglioLinee>
        <NumeroLinea>1</NumeroLinea>
        <Descrizione>Fornitura e posa serramenti (Rif. ` + fat.cmCode + `)</Descrizione>
        <Quantita>1.00</Quantita>
        <PrezzoUnitario>` + fat.imponibile.toFixed(2) + `</PrezzoUnitario>
        <PrezzoTotale>` + fat.imponibile.toFixed(2) + `</PrezzoTotale>
        <AliquotaIVA>` + fat.iva.toFixed(2) + `</AliquotaIVA>
      </DettaglioLinee>
    </DatiBeniServizi>
  </FatturaElettronicaBody>
</p:FatturaElettronica>`;
    const blob = new Blob([xml], { type: "application/xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url;
    a.download = "IT" + (az.piva || "00000000000") + "_" + progressivo + ".xml";
    a.click(); URL.revokeObjectURL(url);
  };


  // === ONBOARDING MODAL "COSA VENDI?" ===
  const renderOnboarding = () => {
    if (!showOnboarding) return null;
    return (
      <div style={{ position: "fixed", inset: 0, zIndex: 9999, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }}>
        <div style={{ background: T.card, borderRadius: 20, padding: 24, maxWidth: 420, width: "100%", maxHeight: "90vh", overflow: "auto" }}>
          <div style={{ textAlign: "center", marginBottom: 16 }}>
            <div style={{ width: 56, height: 56, borderRadius: 14, background: T.text, display: "inline-flex", alignItems: "center", justifyContent: "center", marginBottom: 10 }}>
              <span style={{ fontSize: 28, fontWeight: 900, color: T.card, fontFamily: FF }}>M</span>
            </div>
            <div style={{ fontSize: 22, fontWeight: 900, color: T.text, letterSpacing: -0.5 }}>Benvenuto in MASTRO</div>
            <div style={{ fontSize: 13, color: T.sub, marginTop: 4 }}>Seleziona i prodotti che vendi o installi. Puoi modificare in qualsiasi momento dalle Impostazioni.</div>
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            {SETTORI.map(s => {
              const isOn = settoriAttivi.includes(s.id);
              return (
                <div key={s.id} onClick={() => {
                  setSettoriAttivi(prev => isOn ? prev.filter(x => x !== s.id) : [...prev, s.id]);
                }} style={{
                  padding: "14px 16px", borderRadius: 14, cursor: "pointer",
                  border: `2px solid ${isOn ? "#007aff" : T.bdr}`,
                  background: isOn ? "#007aff10" : T.bg,
                  display: "flex", alignItems: "center", gap: 12, transition: "all .15s",
                }}>
                  <div style={{ fontSize: 28, width: 36, textAlign: "center" }}>{s.icon}</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 14, fontWeight: 700, color: isOn ? "#007aff" : T.text }}>{s.label}</div>
                    <div style={{ fontSize: 10, color: T.sub }}>{s.desc}</div>
                  </div>
                  <div style={{
                    width: 28, height: 28, borderRadius: 14,
                    background: isOn ? "#007aff" : T.bg,
                    border: `2px solid ${isOn ? "#007aff" : T.bdr}`,
                    display: "flex", alignItems: "center", justifyContent: "center",
                    fontSize: 14, color: "#fff", fontWeight: 900,
                  }}>{isOn ? "‚úì" : ""}</div>
                </div>
              );
            })}
          </div>
          <button onClick={() => {
            if (settoriAttivi.length === 0) { setSettoriAttivi(SETTORI_DEFAULT); }
            setShowOnboarding(false);
          }} style={{
            width: "100%", padding: 16, borderRadius: 14, border: "none",
            background: settoriAttivi.length > 0 ? "#007aff" : T.bdr,
            color: "#fff", fontSize: 16, fontWeight: 800, cursor: "pointer", fontFamily: FF,
            marginTop: 16,
          }}>
            {settoriAttivi.length > 0 ? `Inizia con ${settoriAttivi.length} ${settoriAttivi.length === 1 ? "settore" : "settori"} ‚Üí` : "Seleziona almeno un settore"}
          </button>
          <div style={{ textAlign: "center", fontSize: 10, color: T.sub, marginTop: 10 }}>
            MASTRO si adatta al tuo lavoro: serramenti, zanzariere, tende, box doccia e altro.
          </div>
        </div>
      </div>
    );
  };

  const renderFirmaModal = () => {
    if (!showFirmaModal) return null;
    const c = selectedCM;
    const clearFirma = () => { const cv=firmaRef.current; if(cv){const ctx=cv.getContext("2d");ctx.clearRect(0,0,cv.width,cv.height);} };
    const salvaFirma = () => {
      const cv=firmaRef.current; if(!cv)return;
      const dataUrl=cv.toDataURL("image/png");
      setCantieri(cs=>cs.map(x=>x.id===c.id?{...x,firmaCliente:dataUrl,dataFirma:new Date().toLocaleDateString("it-IT")}:x));
      setSelectedCM(p=>({...p,firmaCliente:dataUrl,dataFirma:new Date().toLocaleDateString("it-IT")}));
      setFaseTo(c.id, "conferma"); // AUTO-ADVANCE: firma ‚Üí conferma
      setShowFirmaModal(false);
    };
    return (
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",zIndex:500,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
        <div style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:420,overflow:"hidden"}}>
          <div style={{padding:"14px 16px",borderBottom:"1px solid #eee",display:"flex",alignItems:"center",gap:10}}>
            <span style={{fontSize:20}}>‚úçÔ∏è</span>
            <div><div style={{fontSize:14,fontWeight:800}}>Firma del Cliente</div><div style={{fontSize:11,color:"#666"}}>{c?.code}</div></div>
            <div onClick={()=>setShowFirmaModal(false)} style={{marginLeft:"auto",width:28,height:28,borderRadius:"50%",background:"#f5f5f7",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}}>‚úï</div>
          </div>
          <div style={{padding:"12px 16px 0"}}>
            <div style={{fontSize:11,color:"#666",marginBottom:8,textAlign:"center"}}>Firma nella casella qui sotto</div>
            <div style={{border:"2px solid #007aff",borderRadius:10,overflow:"hidden",background:"#fafafa",touchAction:"none"}}>
              <canvas ref={firmaRef} width={388} height={160} style={{width:"100%",height:160,display:"block",cursor:"crosshair"}}
                onPointerDown={e=>{firmaRef.current?.setPointerCapture(e.pointerId);setFirmaDrawing(true);const cv=firmaRef.current;const r=cv.getBoundingClientRect();const sx=cv.width/r.width,sy=cv.height/r.height;const ctx=cv.getContext("2d");ctx.beginPath();ctx.moveTo((e.clientX-r.left)*sx,(e.clientY-r.top)*sy);ctx.strokeStyle="#1a1a1c";ctx.lineWidth=2.5;ctx.lineCap="round";ctx.lineJoin="round";}}
                onPointerMove={e=>{if(!firmaDrawing)return;const cv=firmaRef.current;const r=cv.getBoundingClientRect();const sx=cv.width/r.width,sy=cv.height/r.height;const ctx=cv.getContext("2d");ctx.lineTo((e.clientX-r.left)*sx,(e.clientY-r.top)*sy);ctx.stroke();}}
                onPointerUp={()=>setFirmaDrawing(false)} onPointerLeave={()=>setFirmaDrawing(false)}/>
            </div>
            <div style={{display:"flex",justifyContent:"space-between",padding:"6px 0 10px"}}>
              <div style={{fontSize:10,color:"#999"}}>üìÖ {new Date().toLocaleDateString("it-IT")}</div>
              <div onClick={clearFirma} style={{fontSize:11,color:"#ff3b30",cursor:"pointer",fontWeight:600}}>üóù‚Äò Cancella</div>
            </div>
          </div>
          <div style={{padding:"0 16px 16px",display:"flex",gap:8}}>
            <button onClick={()=>setShowFirmaModal(false)} style={{flex:1,padding:12,borderRadius:10,border:"1px solid #eee",background:"#f5f5f7",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",color:"#666"}}>Annulla</button>
            <button onClick={salvaFirma} style={{flex:2,padding:12,borderRadius:10,border:"none",background:"linear-gradient(135deg,#34c759,#1a9e40)",color:"#fff",fontSize:14,fontWeight:800,cursor:"pointer",fontFamily:"inherit"}}>‚úÖ Conferma firma</button>
          </div>
        </div>
      </div>
    );
  };


  const renderPreventivoModal = () => {
    if (!showPreventivoModal || !selectedCM) return null;
    const c = selectedCM;
    const updateCMp = (field, val) => { setCantieri(cs=>cs.map(x=>x.id===c.id?{...x,[field]:val}:x)); setSelectedCM(p=>({...p,[field]:val})); };
    const calcolaVano = (v) => {
      const m=v.misure||{}; const lc=(m.lCentro||0)/1000,hc=(m.hCentro||0)/1000; const lmm=m.lCentro||0,hmm=m.hCentro||0; const mq=lc*hc,perim=2*(lc+hc);
      const sysRec=sistemiDB.find(s=>(s.marca+" "+s.sistema)===v.sistema||s.sistema===v.sistema);
      // Minimo mq per tipologia
      const minCat = tipoToMinCat(v.tipo || "F1A");
      const minimoMq = sysRec?.minimiMq?.[minCat] || 0;
      const mqCalc = (minimoMq > 0 && mq > 0 && mq < minimoMq) ? minimoMq : mq;
      // Grid lookup: ceiling approach
      let basePrezzoSer = 0;
      const grid = sysRec?.griglia;
      let gridPrice = null;
      if (grid && grid.length > 0) {
        const sorted = [...grid].sort((a,b) => a.l - b.l || a.h - b.h);
        gridPrice = sorted.find(g => g.l === lmm && g.h === hmm)?.prezzo ?? sorted.find(g => g.l >= lmm && g.h >= hmm)?.prezzo ?? sorted[sorted.length-1]?.prezzo ?? null;
      }
      if (gridPrice !== null) { basePrezzoSer = gridPrice; } else { basePrezzoSer = mqCalc*parseFloat(sysRec?.prezzoMq||sysRec?.euroMq||c.prezzoMq||350); }
      let tot=basePrezzoSer;
      const vetroRec=vetriDB.find(g=>g.code===v.vetro||g.nome===v.vetro); if(vetroRec?.prezzoMq) tot+=mq*parseFloat(vetroRec.prezzoMq);
      const copRec=coprifiliDB.find(cp=>cp.cod===v.coprifilo); if(copRec?.prezzoMl) tot+=perim*parseFloat(copRec.prezzoMl);
      const lamRec=lamiereDB.find(l=>l.cod===v.lamiera); if(lamRec?.prezzoMl) tot+=lc*parseFloat(lamRec.prezzoMl);
      const tapp=v.accessori?.tapparella; if(tapp?.attivo&&c.prezzoTapparella){const tmq=((tapp.l||m.lCentro||0)/1000)*((tapp.h||m.hCentro||0)/1000);tot+=tmq*parseFloat(c.prezzoTapparella);}
      const pers=v.accessori?.persiana; if(pers?.attivo&&c.prezzoPersiana){const pmq=((pers.l||m.lCentro||0)/1000)*((pers.h||m.hCentro||0)/1000);tot+=pmq*parseFloat(c.prezzoPersiana);}
      const zanz=v.accessori?.zanzariera; if(zanz?.attivo&&c.prezzoZanzariera){const zmq=((zanz.l||m.lCentro||0)/1000)*((zanz.h||m.hCentro||0)/1000);tot+=zmq*parseFloat(c.prezzoZanzariera);}
      if (v.vociLibere?.length > 0) v.vociLibere.forEach(vl => { tot += (vl.prezzo || 0) * (vl.qta || 1); });
      return {tot,mq,sysRec,vetroRec,copRec,lamRec};
    };
    const vaniCalc=getVaniAttivi(c).map(v=>({...v,calc:calcolaVano(v)}));
    const totale=vaniCalc.reduce((s,v)=>s+v.calc.tot,0);
    const vaniSenzaSistema = vaniCalc.filter(v=>!v.calc.sysRec && !v.sistema);
    const vaniSenzaMisure = vaniCalc.filter(v=>!(v.misure?.lCentro) || !(v.misure?.hCentro));
    const hasWarnings = vaniSenzaSistema.length>0 || vaniSenzaMisure.length>0;
    const scontoVal=totale*parseFloat(c.sconto||0)/100;
    const imponibile=totale-scontoVal; const iva=imponibile*0.10; const totIva=imponibile+iva;
    return (
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:400,display:"flex",alignItems:"flex-end",justifyContent:"center"}} onClick={e=>e.target===e.currentTarget&&setShowPreventivoModal(false)}>
        <div style={{background:"#f5f5f7",borderRadius:"20px 20px 0 0",width:"100%",maxWidth:480,maxHeight:"90vh",overflow:"auto",paddingBottom:24}}>
          <div style={{padding:"16px 16px 10px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,background:"#f5f5f7",zIndex:1}}>
            <span style={{fontSize:20}}>üìÑ</span>
            <div><div style={{fontSize:15,fontWeight:800}}>Preventivo</div><div style={{fontSize:11,color:"#666"}}>{c.code} ‚Äî {c.cliente} {c.cognome||""}</div></div>
            <div onClick={()=>setShowPreventivoModal(false)} style={{marginLeft:"auto",width:28,height:28,borderRadius:"50%",background:"#e5e5ea",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}}>‚úï</div>
          </div>
          <div style={{padding:"0 16px"}}>
            <div style={{background:"#fff",borderRadius:12,padding:"14px",marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#999",textTransform:"uppercase",marginBottom:10}}>Parametri</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
                <div><div style={{fontSize:10,fontWeight:700,color:"#999",marginBottom:4}}>SCONTO %</div><input type="number" value={c.sconto||0} onChange={e=>updateCMp("sconto",e.target.value)} style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e5e5ea",fontSize:15,fontWeight:700,textAlign:"right",boxSizing:"border-box"}}/></div>
                <div><div style={{fontSize:10,fontWeight:700,color:"#999",marginBottom:4}}>ACCONTO ‚Ç¨</div><input type="number" value={c.accontoRicevuto||0} onChange={e=>updateCMp("accontoRicevuto",e.target.value)} style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e5e5ea",fontSize:15,fontWeight:700,textAlign:"right",boxSizing:"border-box"}}/></div>
              </div>
              <div><div style={{fontSize:10,fontWeight:700,color:"#999",marginBottom:4}}>NOTE</div><textarea value={c.notePreventivo||""} onChange={e=>updateCMp("notePreventivo",e.target.value)} placeholder="Condizioni, garanzie..." style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e5e5ea",fontSize:12,minHeight:50,resize:"none",boxSizing:"border-box",fontFamily:"inherit"}}/></div>
            </div>
            {hasWarnings && (
              <div style={{background:"#fff8ec",borderRadius:12,padding:"12px 14px",marginBottom:10,border:"1.5px solid #ff9500"}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                  <span style={{fontSize:16}}>‚ö†Ô∏è</span>
                  <span style={{fontSize:12,fontWeight:800,color:"#7a4500"}}>Preventivo incompleto</span>
                </div>
                {vaniSenzaSistema.length>0 && (
                  <div style={{fontSize:11,color:"#7a4500",marginBottom:4}}>
                    ‚Ä¢ {vaniSenzaSistema.length} vano/i senza sistema assegnato ‚Üí prezzo ‚Ç¨0
                    <div onClick={()=>{setShowPreventivoModal(false);setSelectedVano(vaniSenzaSistema[0]);setVanoStep(0);}} style={{display:"inline",marginLeft:8,color:"#007aff",fontWeight:700,cursor:"pointer"}}>Vai ‚Üí</div>
                  </div>
                )}
                {vaniSenzaMisure.length>0 && (
                  <div style={{fontSize:11,color:"#7a4500"}}>
                    ‚Ä¢ {vaniSenzaMisure.length} vano/i senza misure ‚Üí calcolo non accurato
                    <div onClick={()=>{setShowPreventivoModal(false);setSelectedVano(vaniSenzaMisure[0]);setVanoStep(0);}} style={{display:"inline",marginLeft:8,color:"#007aff",fontWeight:700,cursor:"pointer"}}>Vai ‚Üí</div>
                  </div>
                )}
              </div>
            )}
            <div style={{background:"#fff",borderRadius:12,padding:"14px",marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#999",textTransform:"uppercase",marginBottom:8}}>Voci</div>
              {vaniCalc.length===0?<div style={{fontSize:12,color:"#999",textAlign:"center",padding:12}}>Nessun vano</div>:vaniCalc.map((v,i)=>(
                <div key={v.id} style={{padding:"8px 0",borderBottom:"1px solid #f5f5f7",background:v.calc.tot===0?"#fff5f5":"transparent",borderRadius:v.calc.tot===0?8:0}}>
                  <div style={{display:"flex",gap:8,alignItems:"flex-start"}}><div style={{flex:1}}><div style={{fontSize:12,fontWeight:700,display:"flex",alignItems:"center",gap:4}}>{v.nome||"Vano "+(i+1)}{v.calc.tot===0&&<span style={{fontSize:9,background:"#ff3b30",color:"#fff",padding:"1px 5px",borderRadius:3,fontWeight:800}}>MANCA SISTEMA</span>}</div><div style={{fontSize:10,color:"#666"}}>{v.tipo} ¬∑ {(v.misure?.lCentro||0)}√ó{(v.misure?.hCentro||0)}mm ¬∑ {v.calc.mq.toFixed(2)} mq</div></div><div style={{fontSize:13,fontWeight:800,color:v.calc.tot===0?"#ff3b30":"#1a1a1c"}}>‚Ç¨ {v.calc.tot.toFixed(2)}</div></div>
                  <div style={{display:"flex",flexWrap:"wrap",gap:3,marginTop:3}}>
                    {v.calc.sysRec&&<span style={{fontSize:9,background:"#007aff15",color:"#007aff",padding:"1px 5px",borderRadius:4}}>{v.calc.sysRec.sistema}</span>}
                    {v.calc.vetroRec&&<span style={{fontSize:9,background:"#34c75915",color:"#1a9e40",padding:"1px 5px",borderRadius:4}}>{v.calc.vetroRec.code}</span>}
                    {v.calc.copRec&&<span style={{fontSize:9,background:"#ff950015",color:"#7a4500",padding:"1px 5px",borderRadius:4}}>{v.calc.copRec.cod}</span>}
                    {v.calc.lamRec&&<span style={{fontSize:9,background:"#af52de15",color:"#7c2d9e",padding:"1px 5px",borderRadius:4}}>{v.calc.lamRec.cod}</span>}
                  </div>
                </div>
              ))}
            </div>
            <div style={{background:"#fff",borderRadius:12,padding:"14px",marginBottom:10}}>
              {parseFloat(c.sconto||0)>0&&<div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#ff9500",marginBottom:6}}><span>Sconto {c.sconto}%</span><span>‚àí ‚Ç¨ {scontoVal.toFixed(2)}</span></div>}
              <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#666",marginBottom:6}}><span>Imponibile</span><span>‚Ç¨ {imponibile.toFixed(2)}</span></div>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#666",marginBottom:10}}><span>IVA 10%</span><span>‚Ç¨ {iva.toFixed(2)}</span></div>
              <div style={{display:"flex",justifyContent:"space-between",fontSize:18,fontWeight:900,paddingTop:10,borderTop:"2px solid #1a1a1c"}}><span>TOTALE</span><span style={{color:"#007aff"}}>‚Ç¨ {totIva.toFixed(2)}</span></div>
              {parseFloat(c.accontoRicevuto||0)>0&&<div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:"#34c759",marginTop:8,fontWeight:700}}><span>Saldo da incassare</span><span>‚Ç¨ {(totIva-parseFloat(c.accontoRicevuto)).toFixed(2)}</span></div>}
            </div>
            {c.firmaCliente?(<div style={{background:"#f0fdf4",borderRadius:12,padding:14,border:"1.5px solid #34c759",marginBottom:10}}><div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}><span>‚úÖ</span><span style={{fontSize:12,fontWeight:700,color:"#1a9e40"}}>Firmato {c.dataFirma}</span><div onClick={()=>{setCantieri(cs=>cs.map(x=>x.id===c.id?{...x,firmaCliente:null,dataFirma:null}:x));setSelectedCM(p=>({...p,firmaCliente:null,dataFirma:null}));}} style={{marginLeft:"auto",fontSize:11,color:"#ff3b30",cursor:"pointer"}}>‚úï Rimuovi</div></div><img src={c.firmaCliente} style={{width:"100%",maxHeight:70,objectFit:"contain",background:"#fff",borderRadius:8}} alt=""/></div>):(<button onClick={()=>{setShowPreventivoModal(false);setShowFirmaModal(true);}} style={{width:"100%",padding:13,borderRadius:12,border:"1.5px solid #34c759",background:"#f0fdf4",color:"#1a9e40",fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:"inherit",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>‚úçÔ∏è Firma cliente sul telefono</button>)}
            {hasWarnings && (
              <div style={{fontSize:11,color:"#999",textAlign:"center",marginBottom:6}}>‚ö†Ô∏è Correggi i problemi per un preventivo accurato</div>
            )}
            <button onClick={()=>generaPreventivoPDF(c)} style={{width:"100%",padding:14,borderRadius:12,border:"none",background:hasWarnings?"linear-gradient(135deg,#8e8e93,#636366)":"linear-gradient(135deg,#007aff,#0055cc)",color:"#fff",fontSize:15,fontWeight:800,cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",justifyContent:"center",gap:8,boxShadow:hasWarnings?"none":"0 4px 12px rgba(0,122,255,0.3)"}}>
              {hasWarnings?"‚ö†Ô∏è Genera PDF (incompleto)":"üìÑ Genera & Scarica PDF"}
            </button>
            <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
              <button onClick={() => generaPDFMisure(c)} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1.5px solid #5856d6`, background: "#5856d615", color: "#5856d6", fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                üìê PDF Misure (Produzione)
              </button>
              <button onClick={() => {
                const upd = { ...c, confermato: true, dataConferma: new Date().toLocaleDateString("it-IT"), stato: "conferma" };
                setCantieri(cs => cs.map(x => x.id === c.id ? upd : x));
                setSelectedCM(upd);
              }} style={{ flex: 1, padding: 12, borderRadius: 10, border: `1.5px solid ${c.confermato ? "#34c759" : "#af52de"}`, background: c.confermato ? "#34c75915" : "#af52de15", color: c.confermato ? "#34c759" : "#af52de", fontSize: 12, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                {c.confermato ? `‚úÖ Confermato ${c.dataConferma || ""}` : "‚úçÔ∏è Conferma ordine"}
              </button>
            </div>
            {/* Tracking produzione */}
            <div style={{ marginTop: 10, background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
              <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 6 }}>üì¶ Tracking produzione</div>
              <div style={{ display: "flex", gap: 2 }}>
                {[
                  { id: "ordinato", l: "Ordinato", ico: "üì¶", c: "#ff9500" },
                  { id: "produzione", l: "In Prod.", ico: "üè≠", c: "#5856d6" },
                  { id: "pronto", l: "Pronto", ico: "‚úÖ", c: "#34c759" },
                  { id: "consegnato", l: "Consegnato", ico: "üöõ", c: "#007aff" },
                  { id: "montato", l: "Montato", ico: "üîß", c: "#30b0c7" },
                ].map((st, i) => {
                  const trackSteps = ["ordinato", "produzione", "pronto", "consegnato", "montato"];
                  const curIdx = trackSteps.indexOf(c.trackingStato || "");
                  const stIdx = trackSteps.indexOf(st.id);
                  const isActive = stIdx <= curIdx;
                  const isCurrent = st.id === c.trackingStato;
                  return (
                    <div key={st.id} onClick={() => {
                      const upd = { ...c, trackingStato: st.id, [`tracking_${st.id}_data`]: new Date().toLocaleDateString("it-IT") };
                      setCantieri(cs => cs.map(x => x.id === c.id ? upd : x));
                      setSelectedCM(upd);
                    }} style={{
                      flex: 1, padding: "6px 2px", borderRadius: 6, textAlign: "center", cursor: "pointer",
                      background: isActive ? st.c + "20" : "transparent",
                      border: `1.5px solid ${isCurrent ? st.c : isActive ? st.c + "40" : T.bdr}`,
                    }}>
                      <div style={{ fontSize: 14 }}>{st.ico}</div>
                      <div style={{ fontSize: 7, fontWeight: 700, color: isActive ? st.c : T.sub }}>{st.l}</div>
                      {isActive && c[`tracking_${st.id}_data`] && <div style={{ fontSize: 6, color: st.c + "99" }}>{c[`tracking_${st.id}_data`]}</div>}
                    </div>
                  );
                })}
              </div>
              {c.trackingStato && <div style={{ fontSize: 9, color: T.sub, marginTop: 4, textAlign: "center" }}>Data prevista consegna: <input type="date" value={c.dataPrevConsegna || ""} onChange={e => { const upd = { ...c, dataPrevConsegna: e.target.value }; setCantieri(cs => cs.map(x => x.id === c.id ? upd : x)); setSelectedCM(upd); }} style={{ fontSize: 9, border: `1px solid ${T.bdr}`, borderRadius: 4, padding: "2px 6px" }} /></div>}
            </div>

            {/* === INVIO WhatsApp / Email === */}
            <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
              <button onClick={() => inviaWhatsApp(c, c.confermato ? "conferma" : "preventivo")} style={{ flex: 1, padding: 10, borderRadius: 10, border: "1.5px solid #25d366", background: "#25d36615", color: "#25d366", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit", display: "flex", alignItems: "center", justifyContent: "center", gap: 4 }}>
                üí¨ WhatsApp
              </button>
              <button onClick={() => inviaEmail(c, c.confermato ? "conferma" : "preventivo")} style={{ flex: 1, padding: 10, borderRadius: 10, border: `1.5px solid #007aff`, background: "#007aff15", color: "#007aff", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit", display: "flex", alignItems: "center", justifyContent: "center", gap: 4 }}>
                üìß Email
              </button>
              {c.trackingStato && (
                <button onClick={() => inviaWhatsApp(c, "stato")} style={{ flex: 1, padding: 10, borderRadius: 10, border: "1.5px solid #ff9500", background: "#ff950015", color: "#ff9500", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit", display: "flex", alignItems: "center", justifyContent: "center", gap: 4 }}>
                  üì≤ Stato
                </button>
              )}
            </div>
            {/* Email template rapidi */}
            <div style={{ display: "flex", gap: 4, marginTop: 6, flexWrap: "wrap" }}>
              {[
                { id: "preventivo", l: "üìÑ Preventivo", c: "#007aff" },
                { id: "conferma", l: "‚úÖ Conferma", c: "#34c759" },
                { id: "montaggio", l: "üîß Montaggio", c: "#5856d6" },
                { id: "saldo", l: "üí∂ Saldo", c: "#ff9500" },
                { id: "generico", l: "‚úèÔ∏è Libero", c: "#86868b" },
              ].map(t => (
                <div key={t.id} onClick={() => inviaEmail(c, t.id)} style={{ padding: "5px 10px", borderRadius: 20, border: `1px solid ${t.c}30`, background: t.c + "08", fontSize: 10, fontWeight: 600, color: t.c, cursor: "pointer" }}>
                  {t.l}
                </div>
              ))}
            </div>

            {/* === FATTURAZIONE === */}
            <div style={{ marginTop: 10, background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>üí∞ Fatturazione</div>
                <div style={{ display: "flex", gap: 4 }}>
                  <button onClick={() => { const f = creaFattura(c, "acconto"); generaFatturaPDF(f); }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid #ff9500`, background: "#ff950015", color: "#ff9500", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Acconto</button>
                  <button onClick={() => { const f = creaFattura(c, "saldo"); generaFatturaPDF(f); }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid #34c759`, background: "#34c75915", color: "#34c759", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Saldo</button>
                  <button onClick={() => { const f = creaFattura(c, "unica"); generaFatturaPDF(f); }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid #007aff`, background: "#007aff15", color: "#007aff", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Unica</button>
                </div>
              </div>
              {fattureDB.filter(f => f.cmId === c.id).length > 0 ? (
                <div>
                  {fattureDB.filter(f => f.cmId === c.id).map(f => (
                    <div key={f.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: `1px solid ${T.bdr}` }}>
                      <div>
                        <div style={{ fontSize: 11, fontWeight: 700 }}>N. {f.numero}/{f.anno} ¬∑ {f.tipo.toUpperCase()}</div>
                        <div style={{ fontSize: 9, color: T.sub }}>{f.data} ¬∑ Scad: {f.scadenza}</div>
                      </div>
                      <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                        <span style={{ fontSize: 12, fontWeight: 800, color: f.pagata ? "#34c759" : T.text }}>‚Ç¨{f.importo.toLocaleString("it-IT")}</span>
                        <div onClick={() => { setFattureDB(prev => prev.map(x => x.id === f.id ? { ...x, pagata: !x.pagata, dataPagamento: !x.pagata ? new Date().toLocaleDateString("it-IT") : null } : x)); }} style={{ padding: "3px 8px", borderRadius: 4, background: f.pagata ? "#34c75920" : "#ff3b3020", color: f.pagata ? "#34c759" : "#ff3b30", fontSize: 9, fontWeight: 700, cursor: "pointer" }}>
                          {f.pagata ? "‚úÖ Pagata" : "‚è≥ Da pagare"}
                        </div>
                        <div onClick={() => generaFatturaPDF(f)} style={{ fontSize: 14, cursor: "pointer" }}>üìÑ</div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div style={{ fontSize: 10, color: T.sub, textAlign: "center", padding: 6 }}>Nessuna fattura emessa</div>
              )}
            </div>

            {/* === ORDINI FORNITORE ‚Äî COMPLETO === */}
            <div style={{ marginTop: 10, background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>üì¶ Ordini Fornitore</div>
                <button onClick={() => {
                  const ord = creaOrdineFornitore(c);
                  setOrdineDetail(ord.id);
                }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid #ff2d55`, background: "#ff2d5515", color: "#ff2d55", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Nuovo Ordine</button>
              </div>

              {/* Lista ordini della commessa */}
              {ordiniFornDB.filter(o => o.cmId === c.id).length > 0 ? (
                <div>
                  {ordiniFornDB.filter(o => o.cmId === c.id).map(o => {
                    const st = ORDINE_STATI.find(s => s.id === o.stato) || ORDINE_STATI[0];
                    const isOpen = ordineDetail === o.id;
                    const fmt = (n) => typeof n === "number" ? n.toLocaleString("it-IT", { minimumFractionDigits: 2 }) : "0,00";
                    const isLate = o.consegna?.prevista && new Date(o.consegna.prevista) < new Date() && o.stato !== "consegnato";

                    return (
                      <div key={o.id} style={{ marginBottom: 8 }}>
                        {/* Header ordine (clickabile per expand) */}
                        <div onClick={() => setOrdineDetail(isOpen ? null : o.id)} style={{
                          padding: "10px 12px", borderRadius: 10, cursor: "pointer",
                          background: T.card, border: `1.5px solid ${isLate ? "#ff3b30" : st.color}30`,
                        }}>
                          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                              <span style={{ fontSize: 16 }}>{st.icon}</span>
                              <div>
                                <div style={{ fontSize: 12, fontWeight: 700, color: T.text }}>
                                  {o.fornitore?.nome || "Fornitore da inserire"} <span style={{ fontSize: 10, color: T.sub, fontWeight: 400 }}>N.{o.numero}/{o.anno}</span>
                                </div>
                                <div style={{ fontSize: 9, color: T.sub }}>
                                  {new Date(o.dataOrdine).toLocaleDateString("it-IT")} ¬∑ {o.righe?.length || 0} articoli ¬∑ ‚Ç¨{fmt(o.totaleIva || 0)}
                                </div>
                              </div>
                            </div>
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                              <span style={{ padding: "3px 8px", borderRadius: 6, fontSize: 8, fontWeight: 700, background: st.color + "20", color: st.color }}>{st.label}</span>
                              <span style={{ fontSize: 12, color: T.sub, transform: isOpen ? "rotate(180deg)" : "none", transition: "all .2s" }}>‚ñº</span>
                            </div>
                          </div>
                          {isLate && <div style={{ fontSize: 9, color: "#ff3b30", fontWeight: 700, marginTop: 4 }}>‚ö†Ô∏è Consegna in ritardo! Prevista: {new Date(o.consegna.prevista).toLocaleDateString("it-IT")}</div>}
                          {o.conferma?.firmata && !o.conferma?.reinviata && <div style={{ fontSize: 9, color: "#ff9500", fontWeight: 700, marginTop: 4 }}>üì§ Conferma firmata ‚Äî da reinviare al fornitore</div>}
                        </div>

                        {/* Dettaglio ordine espanso */}
                        {isOpen && (
                          <div style={{ marginTop: 6, padding: 12, background: T.card, borderRadius: 10, border: `1px solid ${T.bdr}` }}>

                            {/* === 1. DATI FORNITORE === */}
                            <div style={{ fontSize: 9, fontWeight: 700, color: "#ff2d55", textTransform: "uppercase", marginBottom: 6 }}>1. Fornitore</div>
                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 10 }}>
                              <input value={o.fornitore?.nome || ""} onChange={e => updateOrdine(o.id, "fornitore.nome", e.target.value)} placeholder="Nome fornitore" style={{ padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit", gridColumn: "1/3" }} />
                              <input value={o.fornitore?.referente || ""} onChange={e => updateOrdine(o.id, "fornitore.referente", e.target.value)} placeholder="Referente" style={{ padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit" }} />
                              <input value={o.fornitore?.tel || ""} onChange={e => updateOrdine(o.id, "fornitore.tel", e.target.value)} placeholder="Telefono" style={{ padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit" }} />
                              <input value={o.fornitore?.email || ""} onChange={e => updateOrdine(o.id, "fornitore.email", e.target.value)} placeholder="Email" style={{ padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit" }} />
                              <input value={o.fornitore?.piva || ""} onChange={e => updateOrdine(o.id, "fornitore.piva", e.target.value)} placeholder="P.IVA" style={{ padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit" }} />
                            </div>

                            {/* === 2. RIGHE ORDINE === */}
                            <div style={{ fontSize: 9, fontWeight: 700, color: "#ff2d55", textTransform: "uppercase", marginBottom: 6, display: "flex", justifyContent: "space-between" }}>
                              <span>2. Articoli ordinati</span>
                              <span onClick={() => {
                                const newRiga = { id: "r_" + Math.random().toString(36).slice(2, 8), desc: "", misure: "", qta: 1, prezzoUnit: 0, totale: 0, note: "" };
                                updateOrdine(o.id, "righe", [...(o.righe || []), newRiga]);
                              }} style={{ color: "#007aff", cursor: "pointer", fontWeight: 700 }}>+ Aggiungi riga</span>
                            </div>
                            {(o.righe || []).map((r, ri) => (
                              <div key={r.id} style={{ display: "flex", gap: 4, marginBottom: 4, alignItems: "center" }}>
                                <span style={{ fontSize: 9, color: T.sub, width: 16 }}>{ri + 1}</span>
                                <input value={r.desc} onChange={e => {
                                  const righe = [...o.righe]; righe[ri] = { ...righe[ri], desc: e.target.value };
                                  updateOrdine(o.id, "righe", righe);
                                }} placeholder="Descrizione" style={{ flex: 2, padding: 5, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, fontFamily: "inherit" }} />
                                <input value={r.misure} onChange={e => {
                                  const righe = [...o.righe]; righe[ri] = { ...righe[ri], misure: e.target.value };
                                  updateOrdine(o.id, "righe", righe);
                                }} placeholder="LxH" style={{ width: 55, padding: 5, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4 }} />
                                <input type="number" value={r.qta || ""} onChange={e => {
                                  const righe = [...o.righe]; righe[ri] = { ...righe[ri], qta: parseInt(e.target.value) || 0 };
                                  updateOrdine(o.id, "righe", righe);
                                }} placeholder="Q" style={{ width: 32, padding: 5, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, textAlign: "center" }} />
                                <input type="number" value={r.prezzoUnit || ""} onChange={e => {
                                  const righe = [...o.righe]; righe[ri] = { ...righe[ri], prezzoUnit: parseFloat(e.target.value) || 0 };
                                  updateOrdine(o.id, "righe", righe); setTimeout(() => ricalcolaOrdine(o.id), 50);
                                }} placeholder="‚Ç¨" style={{ width: 55, padding: 5, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, textAlign: "right" }} />
                                <span style={{ fontSize: 9, fontWeight: 700, color: T.text, width: 55, textAlign: "right" }}>‚Ç¨{fmt(r.qta * r.prezzoUnit)}</span>
                                <span onClick={() => {
                                  const righe = o.righe.filter((_, i) => i !== ri);
                                  updateOrdine(o.id, "righe", righe); setTimeout(() => ricalcolaOrdine(o.id), 50);
                                }} style={{ fontSize: 12, cursor: "pointer", color: T.red }}>‚úï</span>
                              </div>
                            ))}
                            {/* Totali */}
                            <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: 2, marginTop: 6, paddingTop: 6, borderTop: `1px solid ${T.bdr}` }}>
                              <div style={{ display: "flex", gap: 8, fontSize: 10 }}>
                                <span style={{ color: T.sub }}>Sconto %</span>
                                <input type="number" value={o.sconto || ""} onChange={e => { updateOrdine(o.id, "sconto", parseFloat(e.target.value) || 0); setTimeout(() => ricalcolaOrdine(o.id), 50); }} style={{ width: 40, padding: 3, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 4, textAlign: "center" }} />
                              </div>
                              <div style={{ fontSize: 10, color: T.sub }}>Imponibile: <b>‚Ç¨{fmt(o.totale || 0)}</b></div>
                              <div style={{ fontSize: 10, color: T.sub }}>IVA {o.iva || 22}%: <b>‚Ç¨{fmt((o.totale || 0) * (o.iva || 22) / 100)}</b></div>
                              <div style={{ fontSize: 13, fontWeight: 800, color: T.text }}>TOTALE: ‚Ç¨{fmt(o.totaleIva || 0)}</div>
                            </div>

                            {/* === 3. STATO + CONFERMA === */}
                            <div style={{ fontSize: 9, fontWeight: 700, color: "#ff2d55", textTransform: "uppercase", marginTop: 12, marginBottom: 6 }}>3. Stato & Conferma</div>
                            {/* Barra stati */}
                            <div style={{ display: "flex", gap: 3, marginBottom: 8 }}>
                              {ORDINE_STATI.map(s => (
                                <div key={s.id} onClick={() => updateOrdine(o.id, "stato", s.id)} style={{
                                  flex: 1, padding: "6px 2px", borderRadius: 6, cursor: "pointer", textAlign: "center",
                                  background: o.stato === s.id ? s.color + "20" : "transparent",
                                  border: `1.5px solid ${o.stato === s.id ? s.color : T.bdr}`,
                                }}>
                                  <div style={{ fontSize: 14 }}>{s.icon}</div>
                                  <div style={{ fontSize: 7, fontWeight: 700, color: o.stato === s.id ? s.color : T.sub }}>{s.label}</div>
                                </div>
                              ))}
                            </div>
                            {/* Conferma fornitore */}
                            <div style={{ padding: 8, background: o.conferma?.firmata ? "#34c75910" : "#ff950010", borderRadius: 8, border: `1px solid ${o.conferma?.firmata ? "#34c759" : "#ff9500"}30`, marginBottom: 8 }}>
                              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" as any, alignItems: "center" }}>
                                <div onClick={() => updateOrdine(o.id, "conferma.ricevuta", !o.conferma?.ricevuta)} style={{ padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 9, fontWeight: 700, background: o.conferma?.ricevuta ? "#007aff20" : T.bg, color: o.conferma?.ricevuta ? "#007aff" : T.sub, border: `1px solid ${o.conferma?.ricevuta ? "#007aff" : T.bdr}` }}>
                                  {o.conferma?.ricevuta ? "‚úÖ Conferma ricevuta" : "üì© Ricevi conferma"}
                                </div>
                                {o.conferma?.ricevuta && (
                                  <div onClick={() => updateOrdine(o.id, "conferma.verificata", !o.conferma?.verificata)} style={{ padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 9, fontWeight: 700, background: o.conferma?.verificata ? "#34c75920" : T.bg, color: o.conferma?.verificata ? "#34c759" : T.sub, border: `1px solid ${o.conferma?.verificata ? "#34c759" : T.bdr}` }}>
                                    {o.conferma?.verificata ? "‚úÖ Verificata OK" : "üîç Verifica"}
                                  </div>
                                )}
                                {o.conferma?.verificata && (
                                  <div onClick={() => {
                                    updateOrdine(o.id, "conferma.firmata", true);
                                    updateOrdine(o.id, "conferma.dataFirma", new Date().toISOString().split("T")[0]);
                                    updateOrdine(o.id, "stato", "confermato");
                                    if (o.cmId) setFaseTo(o.cmId, "produzione"); // AUTO-ADVANCE
                                  }} style={{ padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 9, fontWeight: 700, background: o.conferma?.firmata ? "#34c75920" : "#ff950020", color: o.conferma?.firmata ? "#34c759" : "#ff9500", border: `1px solid ${o.conferma?.firmata ? "#34c759" : "#ff9500"}` }}>
                                    {o.conferma?.firmata ? `‚úÖ Firmata ${o.conferma?.dataFirma || ""}` : "‚úçÔ∏è Firma conferma"}
                                  </div>
                                )}
                                {o.conferma?.firmata && (
                                  <div onClick={() => updateOrdine(o.id, "conferma.reinviata", true)} style={{ padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 9, fontWeight: 700, background: o.conferma?.reinviata ? "#34c75920" : "#5856d620", color: o.conferma?.reinviata ? "#34c759" : "#5856d6", border: `1px solid ${o.conferma?.reinviata ? "#34c759" : "#5856d6"}` }}>
                                    {o.conferma?.reinviata ? "‚úÖ Reinviata" : "üì§ Reinvia al fornitore"}
                                  </div>
                                )}
                              </div>
                              {o.conferma?.ricevuta && (
                                <textarea value={o.conferma?.differenze || ""} onChange={e => updateOrdine(o.id, "conferma.differenze", e.target.value)} placeholder="Note/differenze rispetto all'ordine originale..." rows={2} style={{ width: "100%", marginTop: 6, padding: 6, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit", resize: "vertical" as any }} />
                              )}
                            </div>

                            {/* === 4. CONSEGNA + PAGAMENTO === */}
                            <div style={{ fontSize: 9, fontWeight: 700, color: "#ff2d55", textTransform: "uppercase", marginBottom: 6 }}>4. Consegna & Pagamento</div>
                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 8 }}>
                              <div>
                                <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>‚è± Settimane produzione</div>
                                <input type="number" value={o.consegna?.settimane || ""} onChange={e => {
                                  const sett = parseInt(e.target.value) || 0;
                                  updateOrdine(o.id, "consegna.settimane", sett);
                                  if (sett > 0) {
                                    const prevista = new Date(o.dataOrdine);
                                    prevista.setDate(prevista.getDate() + sett * 7);
                                    updateOrdine(o.id, "consegna.prevista", prevista.toISOString().split("T")[0]);
                                  }
                                }} placeholder="0" style={{ width: "100%", padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6 }} />
                              </div>
                              <div>
                                <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>üìÖ Consegna prevista</div>
                                <input type="date" value={o.consegna?.prevista || ""} onChange={e => updateOrdine(o.id, "consegna.prevista", e.target.value)} style={{ width: "100%", padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6 }} />
                              </div>
                              <div>
                                <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>üöõ Consegna effettiva</div>
                                <input type="date" value={o.consegna?.effettiva || ""} onChange={e => {
                                  updateOrdine(o.id, "consegna.effettiva", e.target.value);
                                  if (e.target.value) updateOrdine(o.id, "stato", "consegnato");
                                }} style={{ width: "100%", padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6 }} />
                              </div>
                              <div>
                                <div style={{ fontSize: 8, color: T.sub, marginBottom: 2 }}>üí≥ Termini pagamento</div>
                                <select value={o.pagamento?.termini || "30gg_fm"} onChange={e => {
                                  updateOrdine(o.id, "pagamento.termini", e.target.value);
                                  updateOrdine(o.id, "pagamento.scadenza", calcolaScadenzaPagamento(o.dataOrdine, e.target.value));
                                }} style={{ width: "100%", padding: 6, fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6, background: T.card }}>
                                  <option value="anticipato">Anticipato</option>
                                  <option value="30gg_fm">30gg FM</option>
                                  <option value="60gg_fm">60gg FM</option>
                                  <option value="90gg_fm">90gg FM</option>
                                  <option value="ricevuta_merce">A ricevimento merce</option>
                                </select>
                              </div>
                            </div>
                            {/* Scadenza pagamento + stato */}
                            <div style={{ display: "flex", gap: 6, alignItems: "center", marginBottom: 8, padding: 8, background: o.pagamento?.pagato ? "#34c75910" : T.bg, borderRadius: 6, border: `1px solid ${T.bdr}` }}>
                              <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 9, color: T.sub }}>Scadenza: <b>{o.pagamento?.scadenza ? new Date(o.pagamento.scadenza).toLocaleDateString("it-IT") : "‚Äî"}</b></div>
                                <div style={{ fontSize: 12, fontWeight: 800, color: T.text }}>‚Ç¨{fmt(o.pagamento?.importo || o.totaleIva || 0)}</div>
                              </div>
                              <div onClick={() => {
                                updateOrdine(o.id, "pagamento.pagato", !o.pagamento?.pagato);
                                if (!o.pagamento?.pagato) updateOrdine(o.id, "pagamento.dataPagamento", new Date().toISOString().split("T")[0]);
                              }} style={{
                                padding: "8px 14px", borderRadius: 8, cursor: "pointer", fontWeight: 700, fontSize: 10,
                                background: o.pagamento?.pagato ? "#34c75920" : "#ff3b3020",
                                color: o.pagamento?.pagato ? "#34c759" : "#ff3b30",
                                border: `1.5px solid ${o.pagamento?.pagato ? "#34c759" : "#ff3b30"}`,
                              }}>
                                {o.pagamento?.pagato ? "‚úÖ Pagato" : "‚è≥ Da pagare"}
                              </div>
                            </div>

                            {/* === 5. AZIONI === */}
                            <div style={{ display: "flex", gap: 4, flexWrap: "wrap" as any }}>
                              <button onClick={() => generaOrdinePDF(o)} style={{ flex: 1, padding: 8, borderRadius: 8, border: `1.5px solid #007aff`, background: "#007aff15", color: "#007aff", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üìÑ PDF Ordine</button>
                              {o.conferma?.firmata && <button onClick={() => generaConfermaFirmataPDF(o)} style={{ flex: 1, padding: 8, borderRadius: 8, border: `1.5px solid #34c759`, background: "#34c75915", color: "#34c759", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üìÑ PDF Conferma</button>}
                              <button onClick={() => inviaOrdineFornitore(o, "email")} style={{ padding: 8, borderRadius: 8, border: `1.5px solid #5856d6`, background: "#5856d615", color: "#5856d6", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üìß</button>
                              <button onClick={() => inviaOrdineFornitore(o, "whatsapp")} style={{ padding: 8, borderRadius: 8, border: `1.5px solid #25d366`, background: "#25d36615", color: "#25d366", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üí¨</button>
                              <button onClick={() => { if (confirm("Eliminare ordine?")) setOrdiniFornDB(prev => prev.filter(x => x.id !== o.id)); }} style={{ padding: 8, borderRadius: 8, border: `1.5px solid #ff3b30`, background: "#ff3b3015", color: "#ff3b30", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üóë</button>
                            </div>

                            {/* Riepilogo margine */}
                            {(() => {
                              const totPreventivo = calcolaTotaleCommessa(c);
                              const margine = totPreventivo - (o.totale || 0);
                              const marginePct = totPreventivo > 0 ? Math.round(margine / totPreventivo * 100) : 0;
                              return o.totale > 0 ? (
                                <div style={{ marginTop: 8, padding: 8, background: margine > 0 ? "#34c75910" : "#ff3b3010", borderRadius: 8, border: `1px solid ${margine > 0 ? "#34c759" : "#ff3b30"}30`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                                  <span style={{ fontSize: 10, color: T.sub }}>Preventivo ‚Ç¨{fmt(totPreventivo)} ‚àí Costo ‚Ç¨{fmt(o.totale)}</span>
                                  <span style={{ fontSize: 12, fontWeight: 800, color: margine > 0 ? "#34c759" : "#ff3b30" }}>Margine: ‚Ç¨{fmt(margine)} ({marginePct}%)</span>
                                </div>
                              ) : null;
                            })()}

                            <textarea value={o.note || ""} onChange={e => updateOrdine(o.id, "note", e.target.value)} placeholder="Note ordine..." rows={2} style={{ width: "100%", marginTop: 8, padding: 6, fontSize: 10, border: `1px solid ${T.bdr}`, borderRadius: 6, fontFamily: "inherit", resize: "vertical" as any }} />
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div style={{ fontSize: 10, color: T.sub, textAlign: "center", padding: 10 }}>
                  Nessun ordine fornitore.<br />Premi "+ Nuovo Ordine" per creare un ordine con le righe della commessa.
                </div>
              )}
            </div>

            {/* === PIANIFICAZIONE MONTAGGIO === */}
            <div style={{ marginTop: 10, background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase" }}>üîß Montaggio</div>
                <div style={{ display: "flex", gap: 4 }}>
                  <button onClick={() => {
                    const m = creaMontaggio(c);
                    setCalMontaggiTarget(m.id);
                    setShowCalMontaggi(true);
                  }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid #30b0c7`, background: "#30b0c715", color: "#30b0c7", fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>+ Pianifica</button>
                  <button onClick={() => { setCalMontaggiTarget(null); setShowCalMontaggi(!showCalMontaggi); }} style={{ padding: "4px 8px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: showCalMontaggi ? T.acc + "15" : "transparent", color: showCalMontaggi ? T.acc : T.sub, fontSize: 9, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>üìÖ Calendario</button>
                </div>
              </div>

              {/* Calendario visuale montaggi */}
              {showCalMontaggi && (
                <div style={{ marginBottom: 10 }}>
                  {calMontaggiTarget && (
                    <div style={{ fontSize: 10, color: T.acc, fontWeight: 600, marginBottom: 6, textAlign: "center" }}>
                      üëÜ Clicca su uno slot libero per assegnare data e squadra
                    </div>
                  )}
                  {renderCalendarioMontaggi(calMontaggiTarget || undefined)}
                </div>
              )}

              {montaggiDB.filter(m => m.cmId === c.id).length > 0 ? (
                <div>
                  {montaggiDB.filter(m => m.cmId === c.id).map(m => {
                    const sq = squadreDB.find(s => s.id === m.squadraId);
                    return (
                      <div key={m.id} style={{ padding: "8px 0", borderBottom: `1px solid ${T.bdr}` }}>
                        <div style={{ display: "flex", gap: 6, marginBottom: 6 }}>
                          <select value={m.squadraId} onChange={e => setMontaggiDB(prev => prev.map(x => x.id === m.id ? { ...x, squadraId: e.target.value } : x))} style={{ ...S.select, fontSize: 11, flex: 1, padding: "6px" }}>
                            {squadreDB.map(s => <option key={s.id} value={s.id}>{s.nome} ({s.membri.join(", ")})</option>)}
                          </select>
                          <select value={m.durata} onChange={e => setMontaggiDB(prev => prev.map(x => x.id === m.id ? { ...x, durata: e.target.value } : x))} style={{ ...S.select, fontSize: 11, width: 100, padding: "6px" }}>
                            <option value="mezza">¬Ω giornata</option>
                            <option value="giornata">1 giornata</option>
                            <option value="2giorni">2 giorni</option>
                            <option value="3giorni">3 giorni</option>
                          </select>
                        </div>
                        <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                          <input type="date" value={m.data} onChange={e => setMontaggiDB(prev => prev.map(x => x.id === m.id ? { ...x, data: e.target.value } : x))} style={{ flex: 1, padding: "6px", fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6 }} />
                          <input type="time" value={m.oraInizio} onChange={e => setMontaggiDB(prev => prev.map(x => x.id === m.id ? { ...x, oraInizio: e.target.value } : x))} style={{ width: 80, padding: "6px", fontSize: 11, border: `1px solid ${T.bdr}`, borderRadius: 6 }} />
                          <div onClick={() => {
                            const upd = { ...m, stato: m.stato === "pianificato" ? "in_corso" : m.stato === "in_corso" ? "completato" : "pianificato" };
                            setMontaggiDB(prev => prev.map(x => x.id === m.id ? upd : x));
                          }} style={{ padding: "4px 8px", borderRadius: 6, fontSize: 9, fontWeight: 700, cursor: "pointer",
                            background: m.stato === "completato" ? "#34c75920" : m.stato === "in_corso" ? "#ff950020" : T.bg,
                            color: m.stato === "completato" ? "#34c759" : m.stato === "in_corso" ? "#ff9500" : T.sub,
                            border: `1px solid ${m.stato === "completato" ? "#34c759" : m.stato === "in_corso" ? "#ff9500" : T.bdr}`
                          }}>
                            {m.stato === "completato" ? "‚úÖ Fatto" : m.stato === "in_corso" ? "üîß In corso" : "üìÖ Pianif."}
                          </div>
                          <div onClick={() => { setCalMontaggiTarget(m.id); setShowCalMontaggi(true); }} style={{ fontSize: 12, cursor: "pointer", color: T.acc }}>üìÖ</div>
                          <div onClick={() => setMontaggiDB(prev => prev.filter(x => x.id !== m.id))} style={{ fontSize: 14, cursor: "pointer", color: T.red }}>üóë</div>
                        </div>
                        {sq && <div style={{ fontSize: 9, color: sq.colore, fontWeight: 600, marginTop: 4 }}>üë∑ {sq.nome}: {sq.membri.join(", ")}</div>}
                        {m.data && <div style={{ fontSize: 9, color: T.sub, marginTop: 2 }}>üìÖ {new Date(m.data).toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })} ore {m.oraInizio} ¬∑ {m.durata === "mezza" ? "¬Ω giornata" : m.durata === "2giorni" ? "2 giorni" : m.durata === "3giorni" ? "3 giorni" : "1 giornata"}</div>}
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div style={{ fontSize: 10, color: T.sub, textAlign: "center", padding: 6 }}>Nessun montaggio pianificato</div>
              )}
            </div>

            {/* === TRACKING CLIENTE === */}
            {c.trackingStato && (
              <div style={{ marginTop: 10, display: "flex", gap: 6 }}>
                <button onClick={() => generaTrackingCliente(c)} style={{ flex: 1, padding: 10, borderRadius: 10, border: `1.5px solid #5856d6`, background: "#5856d615", color: "#5856d6", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                  üì± Pagina Tracking Cliente
                </button>
                <button onClick={() => {
                  const msg = `Gentile ${c.cliente}, pu√≤ seguire lo stato del suo ordine ${c.code} a questo link: [link pagina tracking]`;
                  const tel = (c.telefono || "").replace(/\D/g, "");
                  window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(msg)}`, "_blank");
                }} style={{ padding: "10px 14px", borderRadius: 10, border: `1.5px solid #25d366`, background: "#25d36615", color: "#25d366", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                  üí¨
                </button>
              </div>
            )}

            {/* Dati fiscali cliente */}
            <div style={{ marginTop: 10, background: T.bg, borderRadius: 10, padding: 10, border: `1px solid ${T.bdr}` }}>
              <div style={{ fontSize: 9, fontWeight: 700, color: T.sub, textTransform: "uppercase", marginBottom: 6 }}>üèõ Dati fiscali cliente</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
                {[
                  ["cf", "Codice Fiscale", c.cf],
                  ["piva", "P.IVA", c.piva],
                  ["sdi", "Codice SDI", c.sdi],
                  ["pec", "PEC", c.pec],
                  ["email", "Email", c.email],
                ].map(([field, label, val]) => (
                  <div key={field}>
                    <div style={{ fontSize: 8, color: T.sub, marginBottom: 1 }}>{label}</div>
                    <input style={{ ...S.input, fontSize: 11, padding: "5px 8px", width: "100%", boxSizing: "border-box" }} placeholder={label} value={val || ""} onChange={e => { const upd = { ...c, [field]: e.target.value }; setCantieri(cs => cs.map(x => x.id === c.id ? upd : x)); setSelectedCM(upd); }} />
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* == AI PHOTO MODAL VARS == */
  const _aiVt = selectedVano?.tipo || "F1A";
  const _aiSizes: Record<string, [number, number]> = {
    "F1A": [700, 1200], "F2A": [1200, 1400], "F3A": [1800, 1400],
    "PF1A": [800, 2200], "PF2A": [1400, 2200], "PF3A": [2100, 2200],
    "VAS": [700, 500], "SOPR": [800, 400], "FIS": [600, 1000], "FISTONDO": [600, 600],
    "SC2A": [1600, 2200], "SC4A": [2800, 2200], "ALZSC": [3000, 2200],
    "BLI": [900, 2100], "TRIANG": [800, 800], "OBLICA": [700, 1200]
  };
  const [_aiStdW, _aiStdH] = _aiSizes[_aiVt] || [1100, 1300];
  const _aiEx = (selectedVano?.misure || {}) as any;
  const _aiBaseW = (_aiEx.lCentro ?? 0) > 0 ? (_aiEx.lCentro + Math.floor(Math.random() * 7 - 3)) : (_aiStdW + Math.floor(Math.random() * 11 - 5));
  const _aiBaseH = (_aiEx.hCentro ?? 0) > 0 ? (_aiEx.hCentro + Math.floor(Math.random() * 7 - 3)) : (_aiStdH + Math.floor(Math.random() * 11 - 5));
  const _aiTip = TIPOLOGIE_RAPIDE.find(t => t.code === _aiVt)?.label || _aiVt;


  /* ======= MAIN RENDER ======= */
  return (
    <>
      <link href={FONT} rel="stylesheet" />
      <style>{`
        * { box-sizing: border-box; }
        body { margin: 0; background: ${T.bg}; }
        input, select, textarea, button { font-size: inherit; }
      `}</style>
      <div style={S.app}>
        {/* Content */}
        {tab === "home" && !selectedCM && !selectedMsg && renderHome()}
        {tab === "commesse" && renderCommesse()}
        {tab === "clienti" && renderClienti()}
        {tab === "messaggi" && !selectedMsg && renderMessaggi()}
        {tab === "agenda" && renderAgenda()}
        {tab === "settings" && renderSettings()}

        {/* FAB ‚Äî Quick Actions */}
        {/* FAB ‚Äî Compose menu */}
        <style>{`
          @keyframes fabPulse { 0%,100% { box-shadow: 0 4px 20px rgba(0,122,255,0.4); } 50% { box-shadow: 0 4px 30px rgba(0,122,255,0.6); } }
          @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `}</style>
        {/* EVENT POPUP OVERLAY ‚Äî Google Calendar style */}
        {selectedEvent && !selectedEvent._isTask && (tab === "agenda" || tab === "home") && (() => {
          const ev = selectedEvent;
          const cmObj = ev.cm ? cantieri.find(c => c.code === ev.cm) : null;
          return (
            <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, zIndex: 9998, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={() => setSelectedEvent(null)}>
              <div style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.3)" }} />
              <div onClick={(e) => e.stopPropagation()} style={{ position: "relative", zIndex: 9999, background: T.bg, borderRadius: 16, padding: 20, width: "90%", maxWidth: 420, boxShadow: "0 8px 40px rgba(0,0,0,0.2)" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                  <div>
                    <input defaultValue={ev.text} onBlur={(e) => { const val = e.target.value.trim(); if (val && val !== ev.text) { setEvents(prev => prev.map(x => x.id === ev.id ? { ...x, text: val } : x)); setSelectedEvent({ ...ev, text: val }); } }} style={{ fontSize: 18, fontWeight: 800, color: T.text, border: "none", background: "transparent", width: "100%", outline: "none", padding: 0, fontFamily: "inherit" }} />
                    <div style={{ display: "flex", gap: 8, marginTop: 6 }}>
                      <input type="date" defaultValue={ev.date} onChange={(e) => { if (e.target.value) { setEvents(prev => prev.map(x => x.id === ev.id ? { ...x, date: e.target.value } : x)); setSelectedEvent({ ...ev, date: e.target.value }); } }} style={{ fontSize: 13, color: T.sub, border: `1px solid ${T.bdr}`, borderRadius: 8, padding: "4px 8px", background: T.card, fontFamily: "inherit" }} />
                      <input type="time" defaultValue={ev.time || ""} onChange={(e) => { setEvents(prev => prev.map(x => x.id === ev.id ? { ...x, time: e.target.value } : x)); setSelectedEvent({ ...ev, time: e.target.value }); }} style={{ fontSize: 13, color: T.sub, border: `1px solid ${T.bdr}`, borderRadius: 8, padding: "4px 8px", background: T.card, fontFamily: "inherit" }} />
                    </div>
                  </div>
                  <div onClick={() => setSelectedEvent(null)} style={{ cursor: "pointer", fontSize: 22, color: T.sub, padding: "0 4px" }}>{"‚úï"}</div>
                </div>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 14 }}>
                  {ev.persona && <span style={S.badge(T.purpleLt, T.purple)}>{"üë§"} {ev.persona}</span>}
                  {ev.addr && <span style={{ fontSize: 11, color: T.sub, background: T.blueLt, padding: "3px 8px", borderRadius: 6 }}>{"üìç"} {ev.addr}</span>}
                  {ev.cm && <span style={S.badge(T.blueLt, T.blue)}>{"üìÅ"} {ev.cm}</span>}
                  <select defaultValue={ev.tipo || "sopralluogo"} onChange={(e) => { setEvents(prev => prev.map(x => x.id === ev.id ? { ...x, tipo: e.target.value } : x)); setSelectedEvent({ ...ev, tipo: e.target.value }); }} style={{ fontSize: 11, padding: "3px 8px", borderRadius: 6, border: `1px solid ${T.bdr}`, background: tipoEvColor(ev.tipo || "sopralluogo") + "18", color: tipoEvColor(ev.tipo || "sopralluogo"), fontWeight: 600, cursor: "pointer", fontFamily: "inherit" }}>
                    {TIPI_EVENTO.map(t => <option key={t.id} value={t.id}>{t.l}</option>)}
                  </select>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 8, marginBottom: 8 }}>
                  {ev.addr && <div onClick={() => window.open("https://maps.google.com/?q=" + encodeURIComponent(ev.addr))} style={{ padding: "12px 4px", borderRadius: 10, background: T.blueLt, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700, color: T.blue }}>{"üìç"} Mappa</div>}
                  <div onClick={() => { const tel = cmObj?.telefono || contatti.find(c => c.nome === ev.persona)?.telefono; if (tel) window.location.href="tel:" + tel; }} style={{ padding: "12px 4px", borderRadius: 10, background: T.grnLt, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700, color: T.grn }}>{"üìû"} Chiama</div>
                  <div onClick={() => { const cliente = cmObj ? `${cmObj.cliente} ${cmObj.cognome||""}`.trim() : (ev.persona || "Cliente"); const dataFmt = new Date(ev.date).toLocaleDateString("it-IT", { weekday:"long", day:"numeric", month:"long" }); setMailBody(`Gentile ${cliente},\n\nLe confermo l'appuntamento:\n\n${dataFmt}${ev.time ? " alle " + ev.time : ""}\n${ev.addr || ""}\n\n${ev.text}\n\nCordiali saluti,\nFabio Cozza`); setShowMailModal({ ev, cm: cmObj }); setSelectedEvent(null); }} style={{ padding: "12px 4px", borderRadius: 10, background: T.accLt, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700, color: T.acc }}>{"‚úâÔ∏è"} Mail</div>
                  <div onClick={() => { deleteEvent(ev.id); setSelectedEvent(null); }} style={{ padding: "12px 4px", borderRadius: 10, background: T.redLt, textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 700, color: T.red }}>{"üóëÔ∏è"} Elimina</div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 8 }}>
                  <div onClick={() => { if (cmObj) { setSelectedCM(cmObj); } else { const code = "CM-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "Nuovo", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "sopralluogo", vani: [], note: ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); } setSelectedEvent(null); setTab("commesse"); }} style={{ padding: "12px 4px", borderRadius: 12, background: "linear-gradient(135deg, #007aff15, #007aff08)", border: "1px solid #007aff25", textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 800, color: "#007aff" }}>{"üìÅ"} Commessa</div>
                  <div onClick={() => { if (cmObj) { setSelectedCM(cmObj); } else { const code = "CM-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "Nuovo", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "misure", vani: [], note: "Misure: " + ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); } setSelectedEvent(null); setTab("commesse"); }} style={{ padding: "12px 4px", borderRadius: 12, background: "linear-gradient(135deg, #ff950015, #ff950008)", border: "1px solid #ff950025", textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 800, color: "#ff9500" }}>{"üìè"} Misure</div>
                  <div onClick={() => { const code = "INT-" + Date.now().toString().slice(-4); const nc = { id: "c" + Date.now(), code, cliente: ev.persona || "", cognome: "", indirizzo: ev.addr || "", telefono: "", tipo: "nuova", fase: "sopralluogo", vani: [], note: "Intervento: " + ev.text }; setCantieri(prev => [...prev, nc]); setSelectedCM(nc); setSelectedEvent(null); setTab("commesse"); }} style={{ padding: "12px 4px", borderRadius: 12, background: "linear-gradient(135deg, #34c75915, #34c75908)", border: "1px solid #34c75925", textAlign: "center", cursor: "pointer", fontSize: 12, fontWeight: 800, color: "#34c759" }}>{"üîß"} Intervento</div>
                </div>
              </div>
            </div>
          );
        })()}
        {/* TASK DETAIL MODAL */}
        {selectedTask && (() => {
          const t = tasks.find(x => x.id === selectedTask.id) || selectedTask;
          const prioColor = t.priority === "alta" ? "#FF3B30" : t.priority === "media" ? "#FF9500" : "#8E8E93";
          const prioLabel = t.priority === "alta" ? "üî¥ Urgente" : t.priority === "media" ? "üü† Normale" : "‚ö™ Bassa";
          return (
            <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, zIndex: 9998, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={() => setSelectedTask(null)}>
              <div style={{ position: "absolute", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.3)" }} />
              <div onClick={(e) => e.stopPropagation()} style={{ position: "relative", zIndex: 9999, background: T.bg, borderRadius: 16, padding: 20, width: "90%", maxWidth: 420, boxShadow: "0 8px 40px rgba(0,0,0,0.2)" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 9, fontWeight: 800, color: prioColor, textTransform: "uppercase", letterSpacing: "0.1em", marginBottom: 4, fontFamily: FM }}>‚úÖ TASK ¬∑ {prioLabel}</div>
                    <div style={{ fontSize: 18, fontWeight: 800, color: T.text, textDecoration: t.done ? "line-through" : "none", opacity: t.done ? 0.6 : 1 }}>{t.text}</div>
                    {t.date && <div style={{ fontSize: 12, color: T.sub, marginTop: 4 }}>üìÖ {new Date(t.date + "T12:00:00").toLocaleDateString("it-IT", { weekday: "long", day: "numeric", month: "long" })}{t.time ? " alle " + t.time : ""}</div>}
                  </div>
                  <div onClick={() => setSelectedTask(null)} style={{ cursor: "pointer", fontSize: 22, color: T.sub, padding: "0 4px" }}>‚úï</div>
                </div>
                {t.meta && <div style={{ fontSize: 13, color: T.sub, marginBottom: 12, padding: "8px 12px", background: T.bgSec, borderRadius: 8, border: `1px solid ${T.bdr}` }}>üìù {t.meta}</div>}
                <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 16 }}>
                  <span style={S.badge(prioColor + "18", prioColor)}>{prioLabel}</span>
                  {t.cm && <span onClick={() => { const cm = cantieri.find(c => c.code === t.cm); if (cm) { setSelectedCM(cm); setTab("commesse"); setSelectedTask(null); } }} style={{ ...S.badge(T.accLt, T.acc), cursor: "pointer" }}>üìÅ {t.cm}</span>}
                  {t.persona && <span style={S.badge(T.purpleLt, T.purple)}>üë§ {t.persona}</span>}
                  {t.done && <span style={S.badge(T.grnLt, T.grn)}>‚úÖ Completato</span>}
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                  <div onClick={() => { toggleTask(t.id); setSelectedTask({ ...t, done: !t.done }); }} style={{ padding: "14px", borderRadius: 12, background: t.done ? T.bg : T.grn, color: t.done ? T.sub : "#fff", textAlign: "center", cursor: "pointer", fontSize: 14, fontWeight: 800, border: `1px solid ${t.done ? T.bdr : T.grn}` }}>{t.done ? "‚Ü© Riapri" : "‚úì Completa"}</div>
                  <div onClick={() => { setTasks(ts => ts.filter(x => x.id !== t.id)); setSelectedTask(null); }} style={{ padding: "14px", borderRadius: 12, background: "#FF3B3010", color: "#FF3B30", textAlign: "center", cursor: "pointer", fontSize: 14, fontWeight: 800, border: "1px solid #FF3B3020" }}>üóë Elimina</div>
                </div>
              </div>
            </div>
          );
        })()}
        {fabOpen && <div onClick={() => setFabOpen(false)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.3)", backdropFilter: "blur(4px)", zIndex: 89 }} />}
        {(() => {
          const lastCM = lastOpenedCMId ? cantieri.find(c => c.id === lastOpenedCMId) : (cantieri.find(c => c.fase === "misure") || cantieri.find(c => c.fase !== "chiusura") || cantieri[0]);
          const fabItems: Array<{id:string;ico:string;l:string;c:string;action:()=>void}> = [
            { id: "evento", ico: "üìÖ", l: "Appuntamento", c: "#007aff", action: () => { setFabOpen(false); setShowNewEvent(true); } },
            { id: "cliente", ico: "üë§", l: "Nuovo cliente", c: "#34c759", action: () => { setFabOpen(false); setShowModal("contatto"); } },
            { id: "commessa", ico: "üìÅ", l: "Nuova commessa", c: "#ff9500", action: () => { setFabOpen(false); setShowModal("commessa"); } },
            { id: "messaggio", ico: "üí¨", l: "Messaggio", c: "#5856d6", action: () => { setFabOpen(false); setShowCompose(true); } },
          ];
          if (lastCM) {
            const p = PIPELINE.find(x => x.id === lastCM.fase);
            fabItems.push({ id: "ultima", ico: p?.ico || "üìÅ", l: `${lastCM.code} ¬∑ ${lastCM.cliente}`, c: p?.color || T.acc, action: () => { setFabOpen(false); setSelectedCM(lastCM); setTab("commesse"); } });
          }
          return fabItems.map((item, i) => (
            <div key={item.id} onClick={item.action} style={{
              position: "fixed", bottom: 90 + (i + 1) * 58, right: 20, zIndex: 90,
              display: "flex", alignItems: "center", gap: 10, flexDirection: "row-reverse",
              opacity: fabOpen ? 1 : 0, transform: fabOpen ? "translateY(0) scale(1)" : "translateY(30px) scale(0.5)",
              transition: `all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) ${fabOpen ? i * 0.06 : 0}s`,
              pointerEvents: fabOpen ? "auto" : "none",
            }}>
              <div style={{ width: item.id === "ultima" ? 52 : 48, height: item.id === "ultima" ? 52 : 48, borderRadius: "50%", background: item.id === "ultima" ? `linear-gradient(135deg, ${item.c}, ${item.c}cc)` : item.c, display: "flex", alignItems: "center", justifyContent: "center", fontSize: item.id === "ultima" ? 22 : 20, boxShadow: `0 4px 16px ${item.c}50`, cursor: "pointer", border: item.id === "ultima" ? "2px solid #fff" : "none" }}>
                {item.ico}
              </div>
              <div style={{ padding: "6px 12px", borderRadius: 8, background: T.card, border: `1px solid ${item.id === "ultima" ? item.c + "40" : T.bdr}`, boxShadow: "0 2px 12px rgba(0,0,0,0.1)", fontSize: item.id === "ultima" ? 11 : 12, fontWeight: 700, color: item.c, whiteSpace: "nowrap", maxWidth: 200, overflow: "hidden", textOverflow: "ellipsis" }}>
                {item.id === "ultima" ? `‚Ü© ${item.l}` : item.l}
              </div>
            </div>
          ));
        })()}
        <div onClick={() => setFabOpen(!fabOpen)} style={{
          position: "fixed", bottom: 90, right: 20, zIndex: 91,
          width: 56, height: 56, borderRadius: "50%",
          background: fabOpen ? T.sub : "linear-gradient(135deg, #007aff, #5856d6)",
          display: "flex", alignItems: "center", justifyContent: "center",
          boxShadow: fabOpen ? "0 4px 16px rgba(0,0,0,0.2)" : "0 4px 20px rgba(0,122,255,0.4)",
          cursor: "pointer", transition: "all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",
          animation: fabOpen ? "none" : "fabPulse 2s infinite",
        }}>
          <div style={{ fontSize: 24, color: "#fff", transition: "transform 0.3s ease", transform: fabOpen ? "rotate(45deg)" : "rotate(0deg)" }}>‚úèÔ∏è</div>
        </div>

        {/* MESSAGE DETAIL OVERLAY */}
        {selectedMsg && (() => {
          const chIco = { email: "üìß", whatsapp: "üí¨", sms: "üì±", telegram: "‚úàÔ∏è" };
          const chCol = { email: T.blue, whatsapp: "#25d366", sms: T.orange, telegram: "#0088cc" };
          const [replyChannel, setReplyChannelX] = [selectedMsg._replyChannel || selectedMsg.canale, (ch) => setSelectedMsg(p => ({...p, _replyChannel: ch}))];
          return (
          <div style={{ position: "fixed", inset: 0, background: T.bg, zIndex: 150, display: "flex", flexDirection: "column" }}>
            <div style={{ padding: "12px 16px", background: T.card, borderBottom: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 10 }}>
              <div onClick={() => { setSelectedMsg(null); setReplyText(""); }} style={{ cursor: "pointer", padding: 4 }}><Ico d={ICO.back} s={20} c={T.sub} /></div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 15, fontWeight: 700, display: "flex", alignItems: "center", gap: 4 }}>
                  <span>{chIco[selectedMsg.canale]}</span> {selectedMsg.from}
                </div>
                <div style={{ fontSize: 11, color: T.sub }}>{selectedMsg.cm ? `${selectedMsg.cm} ¬∑ ` : ""}{selectedMsg.thread?.length || 0} messaggi</div>
              </div>
              {selectedMsg.cm && (
                <div onClick={() => { const cm = cantieri.find(c => c.code === selectedMsg.cm); if (cm) { setSelectedMsg(null); setSelectedCM(cm); setTab("commesse"); } }} style={{ padding: "4px 10px", borderRadius: 6, background: T.accLt, fontSize: 10, fontWeight: 700, color: T.acc, cursor: "pointer" }}>
                  üìÇ {selectedMsg.cm}
                </div>
              )}
            </div>
            <div style={{ flex: 1, overflowY: "auto", padding: "12px 16px" }}>
              {(selectedMsg.thread || []).map((msg, i) => {
                const isMe = msg.who === "Tu";
                const mChIco = chIco[msg.canale] || chIco[selectedMsg.canale] || "üí¨";
                return (
                  <div key={i} style={{ marginBottom: 12, display: "flex", flexDirection: "column", alignItems: isMe ? "flex-end" : "flex-start" }}>
                    <div style={{ fontSize: 9, color: T.sub, marginBottom: 3, fontWeight: 600 }}>{mChIco} {msg.who} ¬∑ {msg.date} {msg.time}</div>
                    <div style={{ maxWidth: "80%", padding: "10px 14px", borderRadius: isMe ? "14px 14px 4px 14px" : "14px 14px 14px 4px", background: isMe ? (chCol[msg.canale || selectedMsg.canale] || T.acc) : T.card, color: isMe ? "#fff" : T.text, border: isMe ? "none" : `1px solid ${T.bdr}`, fontSize: 13, lineHeight: 1.4 }}>
                      {msg.text}
                    </div>
                  </div>
                );
              })}
            </div>
            <div style={{ borderTop: `1px solid ${T.bdr}`, background: T.card }}>
              <div style={{ display: "flex", gap: 2, padding: "6px 16px 0" }}>
                {["email", "whatsapp", "sms", "telegram"].map(ch => (
                  <div key={ch} onClick={() => setReplyChannelX(ch)} style={{ padding: "4px 8px", borderRadius: "8px 8px 0 0", fontSize: 14, cursor: "pointer", background: replyChannel === ch ? chCol[ch] + "18" : "transparent", borderBottom: replyChannel === ch ? `2px solid ${chCol[ch]}` : "2px solid transparent" }}>
                    {chIco[ch]}
                  </div>
                ))}
              </div>
              <div style={{ padding: "8px 16px 20px", display: "flex", gap: 8, alignItems: "center" }}>
                <div style={{ display: "flex", gap: 4 }}>
                  <div style={{ width: 32, height: 32, borderRadius: "50%", background: T.bg, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 14 }}>üìé</div>
                  <div style={{ width: 32, height: 32, borderRadius: "50%", background: T.bg, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 14 }}>üé§</div>
                  <div style={{ width: 32, height: 32, borderRadius: "50%", background: T.bg, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 14 }}>üì∑</div>
                </div>
                <input
                  style={{ flex: 1, padding: "10px 14px", fontSize: 13, border: `1px solid ${T.bdr}`, borderRadius: 20, background: T.bg, outline: "none", fontFamily: FF }}
                  placeholder={`Rispondi via ${replyChannel}...`}
                  value={replyText}
                  onChange={e => setReplyText(e.target.value)}
                  onKeyDown={e => {
                    if (e.key === "Enter" && replyText.trim()) {
                      const newThread = [...(selectedMsg.thread || []), { who: "Tu", text: replyText, time: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), date: new Date().toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit" }), canale: replyChannel }];
                      setMsgs(ms => ms.map(m => m.id === selectedMsg.id ? { ...m, thread: newThread, preview: replyText } : m));
                      setSelectedMsg(prev => ({ ...prev, thread: newThread }));
                      setReplyText("");
                    }
                  }}
                />
                <div onClick={() => {
                  if (replyText.trim()) {
                    const newThread = [...(selectedMsg.thread || []), { who: "Tu", text: replyText, time: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), date: new Date().toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit" }), canale: replyChannel }];
                    setMsgs(ms => ms.map(m => m.id === selectedMsg.id ? { ...m, thread: newThread, preview: replyText } : m));
                    setSelectedMsg(prev => ({ ...prev, thread: newThread }));
                    setReplyText("");
                  }
                }} style={{ width: 38, height: 38, borderRadius: "50%", background: replyText.trim() ? (chCol[replyChannel] || T.acc) : T.bdr, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", flexShrink: 0 }}>
                  <Ico d={ICO.send} s={16} c={replyText.trim() ? "#fff" : T.sub} />
                </div>
              </div>
            </div>
          </div>
          );
        })()}

        {/* SETTINGS ADD MODAL */}
        {settingsModal && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }} onClick={e => e.target === e.currentTarget && setSettingsModal(null)}>
            <div style={{ background: T.card, borderRadius: 16, width: "100%", maxWidth: 380, padding: 20 }}>
              <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 14 }}>
                {settingsModal === "sistema" && "Nuovo Sistema"}
                {settingsModal === "colore" && "Nuovo Colore"}
                {settingsModal === "vetro" && "Nuovo Vetro"}
                {settingsModal === "coprifilo" && "Nuovo Coprifilo"}
                {settingsModal === "lamiera" && "Nuova Lamiera"}
                {settingsModal === "tipologia" && "Nuova Tipologia"}
                {settingsModal === "membro" && "Nuovo Membro Team"}
              </div>

              {settingsModal === "membro" && (<>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Nome e cognome</label><input style={S.input} placeholder="es. Marco Ferraro" value={settingsForm.nome || ""} onChange={e => setSettingsForm(f => ({ ...f, nome: e.target.value }))} /></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Ruolo</label><select style={S.select} value={settingsForm.ruolo || "Posatore"} onChange={e => setSettingsForm(f => ({ ...f, ruolo: e.target.value }))}><option>Titolare</option><option>Posatore</option><option>Ufficio</option><option>Magazzino</option></select></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Compiti</label><input style={S.input} placeholder="es. Misure, installazione" value={settingsForm.compiti || ""} onChange={e => setSettingsForm(f => ({ ...f, compiti: e.target.value }))} /></div>
              </>)}

              {settingsModal === "sistema" && (<>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Marca</label><input style={S.input} placeholder="es. Aluplast" value={settingsForm.marca || ""} onChange={e => setSettingsForm(f => ({ ...f, marca: e.target.value }))} /></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Sistema</label><input style={S.input} placeholder="es. Ideal 4000" value={settingsForm.sistema || ""} onChange={e => setSettingsForm(f => ({ ...f, sistema: e.target.value }))} /></div>
                <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>‚Ç¨/mq (fallback)</label><input style={S.input} type="number" placeholder="180" value={settingsForm.euroMq || ""} onChange={e => setSettingsForm(f => ({ ...f, euroMq: e.target.value }))} /></div>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Sovr. RAL %</label><input style={S.input} type="number" placeholder="12" value={settingsForm.sovRAL || ""} onChange={e => setSettingsForm(f => ({ ...f, sovRAL: e.target.value }))} /></div>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Sovr. Legno %</label><input style={S.input} type="number" placeholder="22" value={settingsForm.sovLegno || ""} onChange={e => setSettingsForm(f => ({ ...f, sovLegno: e.target.value }))} /></div>
                </div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Sottosistemi (separati da virgola)</label><input style={S.input} placeholder="es. Classicline, Roundline" value={settingsForm.sottosistemi || ""} onChange={e => setSettingsForm(f => ({ ...f, sottosistemi: e.target.value }))} /></div>
              </>)}

              {settingsModal === "colore" && (<>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Nome</label><input style={S.input} placeholder="es. Grigio antracite" value={settingsForm.nome || ""} onChange={e => setSettingsForm(f => ({ ...f, nome: e.target.value }))} /></div>
                <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Codice</label><input style={S.input} placeholder="es. RAL 7016" value={settingsForm.code || ""} onChange={e => setSettingsForm(f => ({ ...f, code: e.target.value }))} /></div>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Tipo</label><select style={S.select} value={settingsForm.tipo || "RAL"} onChange={e => setSettingsForm(f => ({ ...f, tipo: e.target.value }))}><option>RAL</option><option>Legno</option><option>Satinato</option><option>Altro</option></select></div>
                </div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Colore HEX</label><div style={{ display: "flex", gap: 8, alignItems: "center" }}><input type="color" value={settingsForm.hex || "#888888"} onChange={e => setSettingsForm(f => ({ ...f, hex: e.target.value }))} style={{ width: 40, height: 34, border: "none", cursor: "pointer" }} /><input style={{ ...S.input, flex: 1 }} value={settingsForm.hex || "#888888"} onChange={e => setSettingsForm(f => ({ ...f, hex: e.target.value }))} /></div></div>
              </>)}

              {settingsModal === "vetro" && (<>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Nome</label><input style={S.input} placeholder="es. Triplo basso emissivo" value={settingsForm.nome || ""} onChange={e => setSettingsForm(f => ({ ...f, nome: e.target.value }))} /></div>
                <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                  <div style={{ flex: 2 }}><label style={S.fieldLabel}>Codice composizione</label><input style={S.input} placeholder="es. 4/16/4 BE" value={settingsForm.code || ""} onChange={e => setSettingsForm(f => ({ ...f, code: e.target.value }))} /></div>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Ug</label><input style={S.input} type="number" step="0.1" placeholder="1.1" value={settingsForm.ug || ""} onChange={e => setSettingsForm(f => ({ ...f, ug: e.target.value }))} /></div>
                </div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Prezzo ‚Ç¨/mq</label><input style={S.input} type="number" step="0.5" placeholder="es. 45" value={settingsForm.prezzoMq || ""} onChange={e => setSettingsForm(f => ({ ...f, prezzoMq: parseFloat(e.target.value)||0 }))} /></div>
              </>)}

              {(settingsModal === "coprifilo" || settingsModal === "lamiera") && (<>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Codice</label><input style={S.input} placeholder={settingsModal === "coprifilo" ? "es. CP50" : "es. LD250"} value={settingsForm.cod || ""} onChange={e => setSettingsForm(f => ({ ...f, cod: e.target.value }))} /></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Descrizione</label><input style={S.input} placeholder={settingsModal === "coprifilo" ? "es. Coprifilo piatto 50mm" : "es. Lamiera davanzale 250mm"} value={settingsForm.nome || ""} onChange={e => setSettingsForm(f => ({ ...f, nome: e.target.value }))} /></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Prezzo ‚Ç¨/ml</label><input style={S.input} type="number" step="0.5" placeholder="es. 5.50" value={settingsForm.prezzoMl || ""} onChange={e => setSettingsForm(f => ({ ...f, prezzoMl: parseFloat(e.target.value)||0 }))} /></div>
              </>)}

              {settingsModal === "tipologia" && (<>
                <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                  <div style={{ flex: 1 }}><label style={S.fieldLabel}>Codice</label><input style={S.input} placeholder="es. F4A" value={settingsForm.code || ""} onChange={e => setSettingsForm(f => ({ ...f, code: e.target.value }))} /></div>
                  <div style={{ width: 60 }}><label style={S.fieldLabel}>Icona</label><input style={S.input} placeholder="ü™ü" value={settingsForm.icon || ""} onChange={e => setSettingsForm(f => ({ ...f, icon: e.target.value }))} /></div>
                </div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Descrizione</label><input style={S.input} placeholder="es. Finestra 4 ante" value={settingsForm.label || ""} onChange={e => setSettingsForm(f => ({ ...f, label: e.target.value }))} /></div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Categoria</label>
                  <select style={S.select} value={settingsForm.cat || "Altro"} onChange={e => setSettingsForm(f => ({ ...f, cat: e.target.value }))}>
                    {["Finestre","Balconi","Scorrevoli","Persiane","Altro"].map(c => <option key={c}>{c}</option>)}
                  </select>
                </div>
                <div style={{ marginBottom: 10 }}><label style={S.fieldLabel}>Forma base</label>
                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                    {[
                      { id: "rettangolare", label: "Rettangolare", svg: <svg viewBox="0 0 40 32" width={40} height={32}><rect x={2} y={2} width={36} height={28} fill="#ddeefa" stroke="#333" strokeWidth={1.5} rx={1}/></svg> },
                      { id: "fuorisquadro", label: "Fuorisquadro", svg: <svg viewBox="0 0 40 36" width={40} height={36}><polygon points="2,34 2,6 38,2 38,34" fill="#ddeefa" stroke="#333" strokeWidth={1.5}/><line x1="2" y1="6" x2="38" y2="34" stroke="#c62828" strokeWidth={1} strokeDasharray="3,2"/><text x="4" y="20" fontSize="7" fill="#c62828" fontWeight="700">H1</text><text x="32" y="20" fontSize="7" fill="#1565c0" fontWeight="700">H2</text></svg> },
                      { id: "arco", label: "Ad arco", svg: <svg viewBox="0 0 40 36" width={40} height={36}><path d="M2,36 L2,14 Q2,2 20,2 Q38,2 38,14 L38,36 Z" fill="#ddeefa" stroke="#333" strokeWidth={1.5}/></svg> },
                      { id: "trapezio", label: "Trapezoidale", svg: <svg viewBox="0 0 40 32" width={40} height={32}><polygon points="8,2 32,2 38,30 2,30" fill="#ddeefa" stroke="#333" strokeWidth={1.5}/></svg> },
                      { id: "triangolo", label: "Triangolare", svg: <svg viewBox="0 0 40 32" width={40} height={32}><polygon points="20,2 38,30 2,30" fill="#ddeefa" stroke="#333" strokeWidth={1.5}/></svg> },
                      { id: "oblo", label: "Obl√≤", svg: <svg viewBox="0 0 40 40" width={40} height={40}><circle cx={20} cy={20} r={17} fill="#ddeefa" stroke="#333" strokeWidth={1.5}/></svg> },
                      { id: "sagomato", label: "Sagomato", svg: <svg viewBox="0 0 40 32" width={40} height={32}><path d="M4,30 L4,10 Q4,2 12,2 L28,2 Q36,6 36,14 L36,24 Q30,30 20,30 Z" fill="#ddeefa" stroke="#333" strokeWidth={1.5}/></svg> },
                    ].map(f => (
                      <div key={f.id} onClick={() => setSettingsForm(fm => ({ ...fm, forma: f.id }))} style={{ padding: "6px 8px", borderRadius: 10, border: `2px solid ${settingsForm.forma === f.id ? T.acc : T.bdr}`, background: settingsForm.forma === f.id ? T.accLt : T.card, cursor: "pointer", textAlign: "center", minWidth: 56 }}>
                        <div>{f.svg}</div>
                        <div style={{ fontSize: 9, fontWeight: 600, color: settingsForm.forma === f.id ? T.acc : T.sub, marginTop: 2 }}>{f.label}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </>)}

              <button style={S.btn} onClick={addSettingsItem}>Salva</button>
              <button style={S.btnCancel} onClick={() => setSettingsModal(null)}>Annulla</button>
            </div>
          </div>
        )}


        {/* === MODULO PROBLEMI ‚Äî MODAL CREAZIONE === */}
        {showProblemaModal && selectedCM && (() => {
          const c = selectedCM;
          const TIPI_PROB = [
            { id: "materiale", l: "üì¶ Materiale", c: "#FF9500" },
            { id: "misure", l: "üìè Misure errate", c: "#5856d6" },
            { id: "installazione", l: "üîß Installazione", c: "#34c759" },
            { id: "cliente", l: "üë§ Cliente", c: "#007aff" },
            { id: "fornitore", l: "üè≠ Fornitore", c: "#FF6B00" },
            { id: "qualita", l: "‚ö†Ô∏è Qualit√†", c: "#FF3B30" },
            { id: "altro", l: "üìã Altro", c: "#8E8E93" },
          ];
          const PRIO = [
            { id: "alta", l: "üî¥ Alta", c: "#FF3B30" },
            { id: "media", l: "üü† Media", c: "#FF9500" },
            { id: "bassa", l: "‚ö™ Bassa", c: "#8E8E93" },
          ];
          return (
            <div style={S.modal} onClick={e => e.target === e.currentTarget && setShowProblemaModal(false)}>
              <div style={{ ...S.modalInner, maxHeight: "85vh", overflow: "auto" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                  <div style={{ fontSize: 16, fontWeight: 800, color: "#FF3B30" }}>üö® Segnala problema</div>
                  <div onClick={() => setShowProblemaModal(false)} style={{ cursor: "pointer", fontSize: 20, color: T.sub }}>‚úï</div>
                </div>
                <div style={{ fontSize: 11, color: T.sub, marginBottom: 14, padding: "8px 12px", background: T.accLt, borderRadius: 8 }}>üìÅ {c.code} ¬∑ {c.cliente} ¬∑ Fase: <b>{c.fase}</b></div>

                <label style={S.fieldLabel}>Titolo *</label>
                <input style={S.input} placeholder="Es: Profilo arrivato danneggiato" value={problemaForm.titolo} onChange={e => setProblemaForm(f => ({ ...f, titolo: e.target.value }))} />

                <label style={{ ...S.fieldLabel, marginTop: 12 }}>Tipo problema</label>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 12 }}>
                  {TIPI_PROB.map(t => (
                    <div key={t.id} onClick={() => setProblemaForm(f => ({ ...f, tipo: t.id }))} style={{ padding: "6px 10px", borderRadius: 8, border: `1px solid ${problemaForm.tipo === t.id ? t.c : T.bdr}`, background: problemaForm.tipo === t.id ? t.c + "18" : "transparent", fontSize: 11, fontWeight: 600, color: problemaForm.tipo === t.id ? t.c : T.sub, cursor: "pointer" }}>
                      {t.l}
                    </div>
                  ))}
                </div>

                <label style={S.fieldLabel}>Priorit√†</label>
                <div style={{ display: "flex", gap: 6, marginBottom: 12 }}>
                  {PRIO.map(p => (
                    <div key={p.id} onClick={() => setProblemaForm(f => ({ ...f, priorita: p.id }))} style={{ flex: 1, padding: "8px", borderRadius: 8, border: `1px solid ${problemaForm.priorita === p.id ? p.c : T.bdr}`, background: problemaForm.priorita === p.id ? p.c + "18" : "transparent", textAlign: "center", fontSize: 11, fontWeight: 700, color: problemaForm.priorita === p.id ? p.c : T.sub, cursor: "pointer" }}>
                      {p.l}
                    </div>
                  ))}
                </div>

                <label style={S.fieldLabel}>Descrizione</label>
                <textarea style={{ ...S.input, minHeight: 80, resize: "vertical" }} placeholder="Descrivi il problema nel dettaglio..." value={problemaForm.descrizione} onChange={e => setProblemaForm(f => ({ ...f, descrizione: e.target.value }))} />

                <label style={{ ...S.fieldLabel, marginTop: 12 }}>Assegna a</label>
                <select style={S.select || S.input} value={problemaForm.assegnato} onChange={e => setProblemaForm(f => ({ ...f, assegnato: e.target.value }))}>
                  <option value="">‚Äî Nessuno ‚Äî</option>
                  {team.map(m => <option key={m.id} value={m.nome}>{m.nome} ‚Äî {(m as any).ruolo}</option>)}
                </select>

                <button onClick={() => {
                  if (!problemaForm.titolo.trim()) return;
                  const np = {
                    id: "P" + Date.now(),
                    commessaId: c.id,
                    commessaCode: c.code,
                    cliente: c.cliente,
                    fase: c.fase,
                    tipo: problemaForm.tipo,
                    priorita: problemaForm.priorita,
                    stato: "aperto",
                    titolo: problemaForm.titolo.trim(),
                    descrizione: problemaForm.descrizione.trim(),
                    segnalatoDa: team[0]?.nome || "Fabio",
                    assegnatoA: problemaForm.assegnato,
                    dataApertura: new Date().toISOString(),
                    dataRisoluzione: null,
                    noteRisoluzione: "",
                  };
                  setProblemi(prev => [np, ...prev]);
                  setCantieri(cs => cs.map(x => x.id === c.id ? { ...x, log: [...(x.log || []), { chi: np.segnalatoDa, cosa: `üö® Problema segnalato: ${np.titolo}`, quando: "Adesso", color: "#FF3B30" }] } : x));
                  setSelectedCM(prev => ({ ...prev, log: [...(prev.log || []), { chi: np.segnalatoDa, cosa: `üö® Problema segnalato: ${np.titolo}`, quando: "Adesso", color: "#FF3B30" }] }));
                  setShowProblemaModal(false);
                }} style={{ width: "100%", padding: "14px", borderRadius: 12, border: "none", background: "#FF3B30", color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: FF, marginTop: 16 }}>
                  üö® Crea segnalazione
                </button>
              </div>
            </div>
          );
        })()}

        {/* === MODULO PROBLEMI ‚Äî VISTA LISTA === */}
        {showProblemiView && (() => {
          const cmFilter = selectedCM?.id;
          const list = cmFilter ? problemi.filter(p => p.commessaId === cmFilter) : problemi;
          const TIPI_PROB_MAP = { materiale: { l: "üì¶ Materiale", c: "#FF9500" }, misure: { l: "üìè Misure", c: "#5856d6" }, installazione: { l: "üîß Install.", c: "#34c759" }, cliente: { l: "üë§ Cliente", c: "#007aff" }, fornitore: { l: "üè≠ Fornitore", c: "#FF6B00" }, qualita: { l: "‚ö†Ô∏è Qualit√†", c: "#FF3B30" }, altro: { l: "üìã Altro", c: "#8E8E93" } };
          const STATO_MAP = { aperto: { l: "üî¥ Aperto", c: "#FF3B30" }, in_corso: { l: "üü† In corso", c: "#FF9500" }, risolto: { l: "‚úÖ Risolto", c: "#34c759" } };
          const aperti = list.filter(p => p.stato === "aperto").length;
          const inCorso = list.filter(p => p.stato === "in_corso").length;
          const risolti = list.filter(p => p.stato === "risolto").length;
          return (
            <div style={S.modal} onClick={e => e.target === e.currentTarget && setShowProblemiView(false)}>
              <div style={{ ...S.modalInner, maxWidth: 500, maxHeight: "90vh", overflow: "auto" }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                  <div style={{ fontSize: 16, fontWeight: 800, color: T.text }}>üö® Problemi {cmFilter ? `¬∑ ${selectedCM.code}` : "‚Äî Tutti"}</div>
                  <div onClick={() => setShowProblemiView(false)} style={{ cursor: "pointer", fontSize: 20, color: T.sub }}>‚úï</div>
                </div>

                {/* Contatori */}
                <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
                  <div style={{ flex: 1, padding: "10px", borderRadius: 10, background: "#FF3B3010", textAlign: "center" }}>
                    <div style={{ fontSize: 20, fontWeight: 900, color: "#FF3B30" }}>{aperti}</div>
                    <div style={{ fontSize: 10, color: "#FF3B30", fontWeight: 600 }}>Aperti</div>
                  </div>
                  <div style={{ flex: 1, padding: "10px", borderRadius: 10, background: "#FF950010", textAlign: "center" }}>
                    <div style={{ fontSize: 20, fontWeight: 900, color: "#FF9500" }}>{inCorso}</div>
                    <div style={{ fontSize: 10, color: "#FF9500", fontWeight: 600 }}>In corso</div>
                  </div>
                  <div style={{ flex: 1, padding: "10px", borderRadius: 10, background: "#34c75910", textAlign: "center" }}>
                    <div style={{ fontSize: 20, fontWeight: 900, color: "#34c759" }}>{risolti}</div>
                    <div style={{ fontSize: 10, color: "#34c759", fontWeight: 600 }}>Risolti</div>
                  </div>
                </div>

                {list.length === 0 ? (
                  <div style={{ textAlign: "center", padding: "28px 16px" }}>
                    <div style={{ fontSize: 36, marginBottom: 8 }}>‚úÖ</div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: T.text }}>Nessun problema segnalato</div>
                    <div style={{ fontSize: 12, color: T.sub, marginTop: 4 }}>Ottimo lavoro!</div>
                  </div>
                ) : list.map(p => {
                  const tp = TIPI_PROB_MAP[p.tipo] || TIPI_PROB_MAP.altro;
                  const st = STATO_MAP[p.stato] || STATO_MAP.aperto;
                  const prio = p.priorita === "alta" ? { l: "üî¥", c: "#FF3B30" } : p.priorita === "media" ? { l: "üü†", c: "#FF9500" } : { l: "‚ö™", c: "#8E8E93" };
                  return (
                    <div key={p.id} style={{ background: T.card, borderRadius: 12, border: `1px solid ${T.bdr}`, padding: "12px 14px", marginBottom: 8, borderLeft: `3px solid ${st.c}` }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 6 }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{prio.l} {p.titolo}</div>
                          <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{p.commessaCode} ¬∑ {p.cliente} ¬∑ {p.fase}</div>
                        </div>
                        <span style={{ fontSize: 10, fontWeight: 700, padding: "3px 8px", borderRadius: 6, background: st.c + "18", color: st.c }}>{st.l}</span>
                      </div>
                      {p.descrizione && <div style={{ fontSize: 11, color: T.sub, marginBottom: 8, lineHeight: 1.5 }}>{p.descrizione}</div>}
                      <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 8 }}>
                        <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: tp.c + "18", color: tp.c, fontWeight: 600 }}>{tp.l}</span>
                        {p.assegnatoA && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: T.purpleLt, color: T.purple, fontWeight: 600 }}>üë§ {p.assegnatoA}</span>}
                        <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: T.bg, color: T.sub }}>{new Date(p.dataApertura).toLocaleDateString("it-IT", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })}</span>
                      </div>
                      {/* Azioni */}
                      <div style={{ display: "flex", gap: 6 }}>
                        {p.stato === "aperto" && (
                          <button onClick={() => setProblemi(prev => prev.map(x => x.id === p.id ? { ...x, stato: "in_corso" } : x))} style={{ flex: 1, padding: "8px", borderRadius: 8, border: `1px solid #FF9500`, background: "#FF950010", color: "#FF9500", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>
                            üü† Prendi in carico
                          </button>
                        )}
                        {p.stato === "in_corso" && (
                          <button onClick={() => setProblemi(prev => prev.map(x => x.id === p.id ? { ...x, stato: "risolto", dataRisoluzione: new Date().toISOString() } : x))} style={{ flex: 1, padding: "8px", borderRadius: 8, border: `1px solid #34c759`, background: "#34c75910", color: "#34c759", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>
                            ‚úÖ Risolvi
                          </button>
                        )}
                        {p.stato === "risolto" && (
                          <button onClick={() => setProblemi(prev => prev.map(x => x.id === p.id ? { ...x, stato: "aperto", dataRisoluzione: null } : x))} style={{ flex: 1, padding: "8px", borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.bg, color: T.sub, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>
                            ‚Ü© Riapri
                          </button>
                        )}
                        <button onClick={() => { if (confirm("Eliminare questo problema?")) setProblemi(prev => prev.filter(x => x.id !== p.id)); }} style={{ padding: "8px 12px", borderRadius: 8, border: `1px solid #FF3B3030`, background: "#FF3B3008", color: "#FF3B30", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: FF }}>
                          üóë
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })()}

        {/* Tab Bar */}
        
      {/* === TUTORIAL INTERATTIVO === */}
      {tutoStep >= 1 && tutoStep <= 7 && (
        <div style={{ position:"fixed", inset:0, zIndex:99999, background: tutoStep === 1 ? "rgba(0,0,0,0.7)" : "rgba(0,0,0,0.5)", display:"flex", alignItems: tutoStep === 1 ? "center" : "flex-end", justifyContent:"center", padding:16, fontFamily:T.font }} onClick={nextTuto}>
          <div onClick={e => e.stopPropagation()} style={{ background:"#fff", borderRadius: tutoStep === 1 ? 24 : 20, width:"100%", maxWidth: tutoStep === 1 ? 380 : 340, padding: tutoStep === 1 ? "32px 28px" : "20px 22px", boxShadow:"0 20px 60px rgba(0,0,0,0.3)", marginBottom: tutoStep === 1 ? 0 : 80, ...(tutoStep >= 2 && tutoStep <= 6 ? { position:"fixed", bottom: 70, left:"50%", transform:"translateX(-50%)" } : {}) }}>

            {/* STEP 1: WELCOME */}
            {tutoStep === 1 && (<div style={{ textAlign:"center" }}>
              <div style={{ width:64, height:64, borderRadius:16, background:T.acc, display:"flex", alignItems:"center", justifyContent:"center", fontSize:28, fontWeight:900, color:"#fff", margin:"0 auto 16px" }}>M</div>
              <div style={{ fontSize:22, fontWeight:900, color:"#1A1A1C", marginBottom:6 }}>Benvenuto in MASTRO</div>
              <div style={{ fontSize:13, color:"#6B6B6B", lineHeight:1.6, marginBottom:24 }}>Il gestionale pensato per chi fa serramenti sul campo. Ti faccio vedere come funziona in 30 secondi.</div>
              <div style={{ display:"flex", flexDirection:"column", gap:10, textAlign:"left", marginBottom:24 }}>
                {[
                  {e:"üè†",t:"Home",d:"Riepilogo della giornata: appuntamenti, allerte, calendario"},
                  {e:"üìÖ",t:"Agenda",d:"Tutti i tuoi impegni in vista giorno, settimana o mese"},
                  {e:"üìÅ",t:"Commesse",d:"Il cuore: ogni lavoro dalla richiesta alla posa"},
                  {e:"üì®",t:"Messaggi",d:"Tutte le comunicazioni in un posto"},
                  {e:"‚öôÔ∏è",t:"Impostazioni",d:"Listini, colori, team e dati azienda"},
                ].map((s,i) => (
                  <div key={i} style={{ display:"flex", gap:10, alignItems:"flex-start" }}>
                    <div style={{ fontSize:18, width:28, textAlign:"center", flexShrink:0 }}>{s.e}</div>
                    <div><div style={{ fontSize:13, fontWeight:700, color:"#1A1A1C" }}>{s.t}</div><div style={{ fontSize:11, color:"#8E8E93" }}>{s.d}</div></div>
                  </div>
                ))}
              </div>
              <div onClick={nextTuto} style={{ padding:"14px 32px", fontSize:15, fontWeight:800, color:"#fff", background:T.acc, borderRadius:14, cursor:"pointer", display:"inline-block" }}>Inizia il tour ‚Üí</div>
              <div onClick={closeTuto} style={{ fontSize:11, color:"#8E8E93", marginTop:12, cursor:"pointer" }}>Salta, conosco gi√†</div>
            </div>)}

            {/* STEP 2: HOME TAB */}
            {tutoStep === 2 && (<div>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:8 }}>
                <div style={{ fontSize:22 }}>üè†</div>
                <div style={{ fontSize:16, fontWeight:800, color:"#1A1A1C" }}>Home</div>
                <div style={{ marginLeft:"auto", fontSize:10, color:"#8E8E93", background:"#f5f5f5", padding:"3px 8px", borderRadius:8 }}>1/6</div>
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:12 }}>Appena apri MASTRO vedi la <b>dashboard</b>: gli appuntamenti di oggi in alto, le <b>allerte</b> sulle commesse ferme, e il <b>calendario</b> del mese. Tocca qualsiasi elemento per aprirlo.</div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                <div onClick={closeTuto} style={{ fontSize:11, color:"#8E8E93", cursor:"pointer" }}>Chiudi tour</div>
                <div onClick={nextTuto} style={{ padding:"8px 20px", fontSize:13, fontWeight:700, color:"#fff", background:T.acc, borderRadius:10, cursor:"pointer" }}>Avanti ‚Üí</div>
              </div>
              <div style={{ position:"absolute", bottom:-8, left:24, width:0, height:0, borderLeft:"8px solid transparent", borderRight:"8px solid transparent", borderTop:"8px solid #fff" }}/>
            </div>)}

            {/* STEP 3: AGENDA */}
            {tutoStep === 3 && (<div>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:8 }}>
                <div style={{ fontSize:22 }}>üìÖ</div>
                <div style={{ fontSize:16, fontWeight:800, color:"#1A1A1C" }}>Agenda</div>
                <div style={{ marginLeft:"auto", fontSize:10, color:"#8E8E93", background:"#f5f5f5", padding:"3px 8px", borderRadius:8 }}>2/6</div>
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:12 }}>Qui vedi <b>tutti gli impegni</b>: sopralluoghi, pose, consegne. Puoi vedere il <b>giorno singolo</b>, la <b>settimana</b> o il <b>mese</b>. Tocca il + per aggiungere un appuntamento. Ogni evento pu√≤ essere collegato a una commessa.</div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                <div onClick={() => setTutoStep(tutoStep-1)} style={{ fontSize:12, color:"#8E8E93", cursor:"pointer" }}>‚Äπ Indietro</div>
                <div onClick={nextTuto} style={{ padding:"8px 20px", fontSize:13, fontWeight:700, color:"#fff", background:T.acc, borderRadius:10, cursor:"pointer" }}>Avanti ‚Üí</div>
              </div>
              <div style={{ position:"absolute", bottom:-8, left:"38%", width:0, height:0, borderLeft:"8px solid transparent", borderRight:"8px solid transparent", borderTop:"8px solid #fff" }}/>
            </div>)}

            {/* STEP 4: COMMESSE */}
            {tutoStep === 4 && (<div>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:8 }}>
                <div style={{ fontSize:22 }}>üìÅ</div>
                <div style={{ fontSize:16, fontWeight:800, color:"#1A1A1C" }}>Commesse</div>
                <div style={{ marginLeft:"auto", fontSize:10, color:"#8E8E93", background:"#f5f5f5", padding:"3px 8px", borderRadius:8 }}>3/6</div>
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:8 }}>Ogni commessa √® un <b>lavoro completo</b> con il suo ciclo di vita:</div>
              <div style={{ display:"flex", flexWrap:"wrap", gap:4, marginBottom:10 }}>
                {["Sopralluogo","Preventivo","Conferma","Misure","Ordini","Produzione","Posa","Chiusura"].map((f,i) => (
                  <div key={i} style={{ fontSize:9, fontWeight:700, padding:"3px 7px", borderRadius:6, background:i===0?"#007aff15":i<4?"#ff950015":"#34c75915", color:i===0?"#007aff":i<4?"#ff9500":"#34c759" }}>{f}</div>
                ))}
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:12 }}>Dentro ogni commessa gestisci <b>vani</b> (finestre, porte), <b>misure</b>, <b>rilievi</b> e generi il <b>preventivo PDF</b>. Tocca + per creare la tua prima commessa!</div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                <div onClick={() => setTutoStep(tutoStep-1)} style={{ fontSize:12, color:"#8E8E93", cursor:"pointer" }}>‚Äπ Indietro</div>
                <div onClick={nextTuto} style={{ padding:"8px 20px", fontSize:13, fontWeight:700, color:"#fff", background:T.acc, borderRadius:10, cursor:"pointer" }}>Avanti ‚Üí</div>
              </div>
              <div style={{ position:"absolute", bottom:-8, left:"50%", transform:"translateX(-50%)", width:0, height:0, borderLeft:"8px solid transparent", borderRight:"8px solid transparent", borderTop:"8px solid #fff" }}/>
            </div>)}

            {/* STEP 5: MESSAGGI */}
            {tutoStep === 5 && (<div>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:8 }}>
                <div style={{ fontSize:22 }}>üì®</div>
                <div style={{ fontSize:16, fontWeight:800, color:"#1A1A1C" }}>Messaggi</div>
                <div style={{ marginLeft:"auto", fontSize:10, color:"#8E8E93", background:"#f5f5f5", padding:"3px 8px", borderRadius:8 }}>4/6</div>
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:12 }}>Tutte le comunicazioni: <b>WhatsApp, email, SMS, Telegram</b>. L‚ÄôAI Inbox analizza le email in arrivo e suggerisce azioni automatiche: creare commesse, collegare messaggi, avanzare fasi.</div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                <div onClick={() => setTutoStep(tutoStep-1)} style={{ fontSize:12, color:"#8E8E93", cursor:"pointer" }}>‚Äπ Indietro</div>
                <div onClick={nextTuto} style={{ padding:"8px 20px", fontSize:13, fontWeight:700, color:"#fff", background:T.acc, borderRadius:10, cursor:"pointer" }}>Avanti ‚Üí</div>
              </div>
              <div style={{ position:"absolute", bottom:-8, right:"35%", width:0, height:0, borderLeft:"8px solid transparent", borderRight:"8px solid transparent", borderTop:"8px solid #fff" }}/>
            </div>)}

            {/* STEP 6: IMPOSTAZIONI */}
            {tutoStep === 6 && (<div>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:8 }}>
                <div style={{ fontSize:22 }}>‚öôÔ∏è</div>
                <div style={{ fontSize:16, fontWeight:800, color:"#1A1A1C" }}>Impostazioni</div>
                <div style={{ marginLeft:"auto", fontSize:10, color:"#8E8E93", background:"#f5f5f5", padding:"3px 8px", borderRadius:8 }}>5/6</div>
              </div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.6, marginBottom:12 }}>Configura la tua azienda: <b>ragione sociale, logo, listini prezzi, sistemi</b> (Sch√ºco, Rehau, Finstral...), <b>colori RAL</b>, vetri, coprifili, lamiere. Tutto quello che ti serve per fare preventivi precisi.</div>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                <div onClick={() => setTutoStep(tutoStep-1)} style={{ fontSize:12, color:"#8E8E93", cursor:"pointer" }}>‚Äπ Indietro</div>
                <div onClick={nextTuto} style={{ padding:"8px 20px", fontSize:13, fontWeight:700, color:"#fff", background:T.acc, borderRadius:10, cursor:"pointer" }}>Avanti ‚Üí</div>
              </div>
              <div style={{ position:"absolute", bottom:-8, right:24, width:0, height:0, borderLeft:"8px solid transparent", borderRight:"8px solid transparent", borderTop:"8px solid #fff" }}/>
            </div>)}

            {/* STEP 7: FINAL */}
            {tutoStep === 7 && (<div style={{ textAlign:"center" }}>
              <div style={{ fontSize:40, marginBottom:12 }}>üöÄ</div>
              <div style={{ fontSize:18, fontWeight:900, color:"#1A1A1C", marginBottom:6 }}>Tutto pronto!</div>
              <div style={{ fontSize:12, color:"#6B6B6B", lineHeight:1.7, marginBottom:8 }}>Ecco come iniziare:</div>
              <div style={{ textAlign:"left", marginBottom:20 }}>
                {[
                  {n:"1",t:"Vai in Impostazioni",d:"Inserisci ragione sociale, P.IVA, telefono"},
                  {n:"2",t:"Crea la prima commessa",d:"Tocca Commesse ‚Üí + e inserisci cliente e indirizzo"},
                  {n:"3",t:"Aggiungi i vani",d:"Dentro la commessa, aggiungi finestre e portefinestre"},
                  {n:"4",t:"Fai il sopralluogo",d:"Inserisci le misure vano per vano dal cantiere"},
                ].map((s,i) => (
                  <div key={i} style={{ display:"flex", gap:10, alignItems:"flex-start", marginBottom:10 }}>
                    <div style={{ width:22, height:22, borderRadius:6, background:T.acc, color:"#fff", fontSize:11, fontWeight:800, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0 }}>{s.n}</div>
                    <div><div style={{ fontSize:12, fontWeight:700, color:"#1A1A1C" }}>{s.t}</div><div style={{ fontSize:11, color:"#8E8E93" }}>{s.d}</div></div>
                  </div>
                ))}
              </div>
              <div onClick={closeTuto} style={{ padding:"14px 32px", fontSize:15, fontWeight:800, color:"#fff", background:T.acc, borderRadius:14, cursor:"pointer", display:"inline-block" }}>Inizia a lavorare! üí™</div>
            </div>)}
          </div>
        </div>
      )}
      {!selectedVano && (
          
      <div style={S.tabBar}>
            {[
              { id: "home", ico: ICO.home, label: "Home" },
              { id: "agenda", ico: ICO.calendar, label: "Agenda" },
              { id: "commesse", ico: ICO.filter, label: "Commesse" },
              { id: "clienti", ico: ICO.users, label: "Clienti" },
              { id: "messaggi", ico: ICO.chat, label: "Messaggi" },
              { id: "settings", ico: ICO.settings, label: "Impost." },
            ].map(t => (
              <div key={t.id} style={S.tabItem(tab === t.id)} onClick={() => { setTab(t.id); setSelectedCM(null); setSelectedVano(null); setSelectedMsg(null); }}>
                <div style={{ position: "relative", display: "inline-block" }}>
                  <Ico d={t.ico} s={22} c={tab === t.id ? T.acc : T.sub} />
                  {t.id === "messaggi" && msgs.filter(m => !m.read).length > 0 && (
                    <div style={{ position: "absolute", top: -4, right: -8, width: 16, height: 16, borderRadius: "50%", background: T.red, color: "#fff", fontSize: 9, fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center" }}>
                      {msgs.filter(m => !m.read).length}
                    </div>
                  )}
                </div>
                <div style={S.tabLabel(tab === t.id)}>{t.label}</div>
              </div>
            ))}
          </div>
        )}

        {/* Modals */}
        {renderModal()}
        {renderPreventivoModal()}
        {renderFirmaModal()}
        {renderOnboarding()}

        {/* SEND COMMESSA MODAL */}
        {showSendModal && selectedCM && (
          <div style={S.modal} onClick={e => e.target === e.currentTarget && setShowSendModal(false)}>
            <div style={S.modalInner}>
              {sendConfirm === "sent" ? (
                <div style={{ textAlign: "center", padding: "30px 0" }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>‚úÖ</div>
                  <div style={{ fontSize: 17, fontWeight: 700, color: T.grn }}>Commessa inviata!</div>
                  <div style={{ fontSize: 12, color: T.sub, marginTop: 4 }}>Email inviata con tutti i dati selezionati</div>
                </div>
              ) : (
                <>
                  <div style={S.modalTitle}>üìß Invia Commessa ‚Äî {selectedCM.code}</div>
                  <div style={{ fontSize: 12, color: T.sub, marginBottom: 14 }}>Scegli cosa includere nell'invio:</div>
                  {[
                    { key: "misure", label: "Misure tutti i vani", ico: "üìê" },
                    { key: "foto", label: "Foto scattate", ico: "üì∑" },
                    { key: "disegno", label: "Disegni mano libera", ico: "‚úèÔ∏è" },
                    { key: "accessori", label: "Accessori (tapparelle, zanzariere...)", ico: "ü™ü" },
                    { key: "note", label: "Note e annotazioni", ico: "üìù" },
                  ].map(opt => (
                    <div key={opt.key} onClick={() => setSendOpts(o => ({ ...o, [opt.key]: !o[opt.key] }))} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 12px", background: sendOpts[opt.key] ? T.accLt : T.card, border: `1px solid ${sendOpts[opt.key] ? T.acc : T.bdr}`, borderRadius: 10, marginBottom: 6, cursor: "pointer" }}>
                      <div style={{ width: 22, height: 22, borderRadius: 6, border: `2px solid ${sendOpts[opt.key] ? T.acc : T.bdr}`, background: sendOpts[opt.key] ? T.acc : "transparent", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 12, fontWeight: 700 }}>
                        {sendOpts[opt.key] && "‚úì"}
                      </div>
                      <span style={{ fontSize: 16 }}>{opt.ico}</span>
                      <span style={{ fontSize: 13, fontWeight: 600, color: T.text }}>{opt.label}</span>
                    </div>
                  ))}
                  <div style={{ marginTop: 10, marginBottom: 8 }}>
                    <label style={S.fieldLabel}>Invia a (email)</label>
                    <input style={S.input} placeholder="email@destinatario.com" />
                  </div>
                  <button onClick={sendCommessa} style={{ ...S.btn, background: "linear-gradient(135deg, #007aff, #0055cc)", marginTop: 4 }}>
                    üìß Invia commessa completa
                  </button>
                  <button style={S.btnCancel} onClick={() => setShowSendModal(false)}>Annulla</button>
                </>
              )}
            </div>
          </div>
        )}

        {/* NEW EVENT MODAL */}
        {showNewEvent && (
          <div style={S.modal} onClick={e => e.target === e.currentTarget && setShowNewEvent(false)}>
            <div style={S.modalInner}>
              <div style={S.modalTitle}>{newEvent.tipo === "task" ? "Nuovo task" : "Nuovo evento"}</div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Titolo</label>
                <input style={S.input} placeholder="es. Sopralluogo, consegna materiale..." value={newEvent.text} onChange={e => setNewEvent(ev => ({ ...ev, text: e.target.value }))} />
              </div>
              <div style={{ display: "flex", gap: 10, marginBottom: 14 }}>
                <div style={{ flex: 1 }}>
                  <label style={S.fieldLabel}>Data</label>
                  <input style={S.input} type="date" value={newEvent.date || selDate.toISOString().split("T")[0]} onChange={e => setNewEvent(ev => ({ ...ev, date: e.target.value }))} />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={S.fieldLabel}>Ora (opz.)</label>
                  <input style={S.input} type="time" value={newEvent.time} onChange={e => setNewEvent(ev => ({ ...ev, time: e.target.value }))} />
                </div>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Tipo</label>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                  {[{ id: "task", l: "‚úÖ Task", c: T.orange }, ...TIPI_EVENTO].map(t => (
                    <div key={t.id} onClick={() => setNewEvent(ev => ({ ...ev, tipo: t.id }))} style={{ padding: "8px 10px", borderRadius: 8, border: `1px solid ${newEvent.tipo === t.id ? t.c : T.bdr}`, background: newEvent.tipo === t.id ? t.c + "18" : "transparent", textAlign: "center", fontSize: 11, fontWeight: 600, color: newEvent.tipo === t.id ? t.c : T.sub, cursor: "pointer" }}>
                      {t.l}
                    </div>
                  ))}
                </div>
              </div>
              {/* --- TASK-SPECIFIC FIELDS --- */}
              {newEvent.tipo === "task" && (<>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Priorit√†</label>
                <div style={{ display: "flex", gap: 6 }}>
                  {[{ id: "alta", l: "üî¥ Alta", c: "#FF3B30" }, { id: "media", l: "üü† Media", c: "#FF9500" }, { id: "bassa", l: "‚ö™ Bassa", c: "#8E8E93" }].map(p => (
                    <div key={p.id} onClick={() => setNewEvent(ev => ({ ...ev, _taskPriority: p.id } as any))} style={{ flex: 1, padding: "8px 4px", borderRadius: 8, border: `1px solid ${((newEvent as any)._taskPriority || "media") === p.id ? p.c : T.bdr}`, background: ((newEvent as any)._taskPriority || "media") === p.id ? p.c + "18" : "transparent", textAlign: "center", fontSize: 12, fontWeight: 600, color: ((newEvent as any)._taskPriority || "media") === p.id ? p.c : T.sub, cursor: "pointer" }}>
                      {p.l}
                    </div>
                  ))}
                </div>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Collega a commessa</label>
                <select style={S.select} value={newEvent.cm} onChange={e => setNewEvent(ev => ({ ...ev, cm: e.target.value }))}>
                  <option value="">‚Äî Nessuna ‚Äî</option>
                  {cantieri.map(c => <option key={c.id} value={c.code}>{c.code} ¬∑ {c.cliente}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Assegna a persona</label>
                <select style={S.select} value={newEvent.persona} onChange={e => setNewEvent(ev => ({ ...ev, persona: e.target.value }))}>
                  <option value="">‚Äî Nessuno ‚Äî</option>
                  {[...contatti.filter(ct => ct.tipo === "cliente"), ...team].map(m => <option key={m.id} value={m.nome}>{m.nome}{(m as any).ruolo ? " ‚Äî " + (m as any).ruolo : ""}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Note (opz.)</label>
                <input style={S.input} placeholder="Dettagli, materiale da portare..." value={(newEvent as any)._taskMeta || ""} onChange={e => setNewEvent(ev => ({ ...ev, _taskMeta: e.target.value } as any))} />
              </div>
              </>)}
              {/* --- EVENT-SPECIFIC FIELDS --- */}
              {newEvent.tipo !== "task" && (<>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Cliente</label>
                <select style={S.select} value={newEvent.persona || ""} onChange={e => {
                  const val = e.target.value;
                  if (val === "__new__") { setNewEvent(ev => ({ ...ev, persona: "", _newCliente: true } as any)); }
                  else { const ct = contatti.find(c => c.nome === val); setNewEvent(ev => ({ ...ev, persona: val, addr: ct?.indirizzo || ev.addr, text: ev.text || ("Appuntamento " + val), _newCliente: false } as any)); }
                }}>
                  <option value="">‚Äî Seleziona cliente ‚Äî</option>
                  {contatti.filter(ct => ct.tipo === "cliente").map(ct => <option key={ct.id || ct.nome} value={ct.nome}>{ct.nome}{ct.cognome ? " " + ct.cognome : ""}</option>)}
                  <option value="__new__">‚ûï Nuovo cliente...</option>
                </select>
                {(newEvent as any)._newCliente && (
                  <div style={{ background: T.bgSec, borderRadius: 10, padding: 12, marginTop: 8, border: `1px solid ${T.bdr}` }}>
                    <div style={{ fontSize: 12, fontWeight: 700, color: T.acc, marginBottom: 8 }}>üë§ Nuovo cliente</div>
                    <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
                      <input style={{ ...S.input, flex: 1 }} placeholder="Nome" value={(newEvent as any)._nomeCliente || ""} onChange={e => setNewEvent(ev => ({ ...ev, _nomeCliente: e.target.value } as any))} />
                      <input style={{ ...S.input, flex: 1 }} placeholder="Cognome" value={(newEvent as any)._cognomeCliente || ""} onChange={e => setNewEvent(ev => ({ ...ev, _cognomeCliente: e.target.value } as any))} />
                    </div>
                    <input style={{ ...S.input, marginBottom: 8 }} placeholder="Telefono" value={(newEvent as any)._telCliente || ""} onChange={e => setNewEvent(ev => ({ ...ev, _telCliente: e.target.value } as any))} />
                    <input style={S.input} placeholder="Indirizzo" value={(newEvent as any)._addrCliente || ""} onChange={e => setNewEvent(ev => ({ ...ev, _addrCliente: e.target.value, addr: e.target.value } as any))} />
                  </div>
                )}
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Collega a commessa</label>
                <select style={S.select} value={newEvent.cm} onChange={e => setNewEvent(ev => ({ ...ev, cm: e.target.value }))}>
                  <option value="">‚Äî Nessuna ‚Äî</option>
                  {cantieri.map(c => <option key={c.id} value={c.code}>{c.code} ¬∑ {c.cliente}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Assegna a persona</label>
                <select style={S.select} value={newEvent.persona} onChange={e => setNewEvent(ev => ({ ...ev, persona: e.target.value }))}>
                  <option value="">‚Äî Nessuno ‚Äî</option>
                  {team.map(m => <option key={m.id} value={m.nome}>{m.nome} ‚Äî {m.ruolo}</option>)}
                </select>
              </div>
              {/* Indirizzo */}
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Indirizzo (opz.)</label>
                <input style={S.input} placeholder="Via Roma 12, Cosenza..." value={newEvent.addr||""} onChange={e => setNewEvent(ev => ({ ...ev, addr: e.target.value }))} />
              </div>
              {/* Reminder */}
              <div style={{ marginBottom: 16 }}>
                <label style={S.fieldLabel}>‚è∞ Reminder al cliente</label>
                <div style={{ display: "flex", gap: 6 }}>
                  {[
                    { id: "", l: "Nessuno" },
                    { id: "24h", l: "24h prima" },
                    { id: "1h", l: "1h prima" },
                    { id: "giorno", l: "Il giorno" },
                  ].map(r => (
                    <div key={r.id} onClick={() => setNewEvent(ev => ({ ...ev, reminder: r.id }))}
                      style={{ flex: 1, padding: "8px 4px", borderRadius: 8, textAlign: "center", fontSize: 11, fontWeight: 700, cursor: "pointer",
                        border: `1px solid ${newEvent.reminder === r.id ? T.acc : T.bdr}`,
                        background: newEvent.reminder === r.id ? T.accLt : "transparent",
                        color: newEvent.reminder === r.id ? T.acc : T.sub }}>
                      {r.l}
                    </div>
                  ))}
                </div>
                {newEvent.reminder && (
                  <div style={{ marginTop: 6, fontSize: 10, color: T.sub, padding: "5px 8px", background: T.accLt, borderRadius: 6 }}>
                    üìß MASTRO ti avviser√† di inviare il reminder ‚Äî lo farai con 1 click dal banner in agenda
                  </div>
                )}
              </div>
              </>)}
              <button style={S.btn} onClick={addEvent}>{newEvent.tipo === "task" ? "Crea task" : "Crea evento"}</button>
              <button style={S.btnCancel} onClick={() => setShowNewEvent(false)}>Annulla</button>
            </div>
          </div>
        )}

        {/* FASE ADVANCE NOTIFICATION */}
        {faseNotif && (
          <div style={{ position: "fixed", top: 60, left: "50%", transform: "translateX(-50%)", maxWidth: 380, width: "90%", padding: "12px 16px", borderRadius: 12, background: T.card, border: `1px solid ${faseNotif.color}40`, boxShadow: `0 4px 20px ${faseNotif.color}30`, zIndex: 300, display: "flex", alignItems: "center", gap: 10, animation: "fadeIn 0.3s ease" }}>
            <div style={{ width: 36, height: 36, borderRadius: 10, background: faseNotif.color + "20", display: "flex", alignItems: "center", justifyContent: "center" }}>
              <span style={{ fontSize: 18 }}>üìß</span>
            </div>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>Avanzato a {faseNotif.fase}</div>
              <div style={{ fontSize: 11, color: T.sub }}>Email inviata a <strong>{faseNotif.addetto}</strong></div>
            </div>
            <div style={{ fontSize: 18 }}>‚úÖ</div>
          </div>
        )}

        {/* COMPOSE MESSAGE MODAL */}
        {showCompose && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }} onClick={e => e.target === e.currentTarget && setShowCompose(false)}>
            <div style={{ background: T.card, borderRadius: 16, width: "100%", maxWidth: 420, padding: 20, maxHeight: "80vh", overflowY: "auto" }}>
              <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 14 }}>‚úèÔ∏è Nuovo messaggio</div>
              <div style={{ marginBottom: 12 }}>
                <label style={S.fieldLabel}>Invia via</label>
                <div style={{ display: "flex", gap: 4 }}>
                  {[
                    { id: "whatsapp", l: "üí¨ WhatsApp", c: "#25d366" },
                    { id: "email", l: "üìß Email", c: T.blue },
                    { id: "sms", l: "üì± SMS", c: T.orange },
                    { id: "telegram", l: "‚úàÔ∏è Telegram", c: "#0088cc" },
                  ].map(ch => (
                    <div key={ch.id} onClick={() => setComposeMsg(c => ({ ...c, canale: ch.id }))} style={{ flex: 1, padding: "8px 4px", borderRadius: 8, border: `1.5px solid ${composeMsg.canale === ch.id ? ch.c : T.bdr}`, background: composeMsg.canale === ch.id ? ch.c + "15" : T.card, textAlign: "center", cursor: "pointer", fontSize: 10, fontWeight: 600, color: composeMsg.canale === ch.id ? ch.c : T.sub }}>
                      {ch.l}
                    </div>
                  ))}
                </div>
              </div>
              <div style={{ marginBottom: 12 }}>
                <label style={S.fieldLabel}>Destinatario</label>
                <input style={S.input} placeholder="Nome o numero..." value={composeMsg.to} onChange={e => setComposeMsg(c => ({ ...c, to: e.target.value }))} />
              </div>
              <div style={{ marginBottom: 12 }}>
                <label style={S.fieldLabel}>Collega a commessa (opzionale)</label>
                <select style={S.select} value={composeMsg.cm} onChange={e => setComposeMsg(c => ({ ...c, cm: e.target.value }))}>
                  <option value="">‚Äî Nessuna ‚Äî</option>
                  {cantieri.map(c => <option key={c.id} value={c.code}>{c.code} ¬∑ {c.cliente}</option>)}
                </select>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={S.fieldLabel}>Messaggio</label>
                <textarea style={{ width: "100%", padding: 12, fontSize: 13, border: `1px solid ${T.bdr}`, borderRadius: 10, background: T.bg, minHeight: 80, resize: "vertical", fontFamily: FF, boxSizing: "border-box" }} placeholder="Scrivi il messaggio..." value={composeMsg.text} onChange={e => setComposeMsg(c => ({ ...c, text: e.target.value }))} />
              </div>
              <div style={{ display: "flex", gap: 6, marginBottom: 14 }}>
                {[{ ico: "üìé", l: "File" }, { ico: "üì∑", l: "Foto" }, { ico: "üé§", l: "Audio" }, { ico: "üìç", l: "Posizione" }].map((b, i) => (
                  <div key={i} style={{ flex: 1, padding: "8px 4px", background: T.bg, borderRadius: 8, border: `1px solid ${T.bdr}`, textAlign: "center", cursor: "pointer" }}>
                    <div style={{ fontSize: 16 }}>{b.ico}</div>
                    <div style={{ fontSize: 9, fontWeight: 600, color: T.sub, marginTop: 1 }}>{b.l}</div>
                  </div>
                ))}
              </div>
              <button onClick={() => {
                if (composeMsg.to.trim() && composeMsg.text.trim()) {
                  const newMsg = {
                    id: Date.now(), from: composeMsg.to, preview: composeMsg.text, time: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }),
                    cm: composeMsg.cm, read: true, canale: composeMsg.canale,
                    thread: [{ who: "Tu", text: composeMsg.text, time: new Date().toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }), date: new Date().toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit" }), canale: composeMsg.canale }]
                  };
                  setMsgs(ms => [newMsg, ...ms]);
                  setShowCompose(false);
                  setComposeMsg({ to: "", text: "", canale: "whatsapp", cm: "" });
                }
              }} style={{ ...S.btn, opacity: composeMsg.to.trim() && composeMsg.text.trim() ? 1 : 0.5 }}>
                Invia messaggio
              </button>
              <button onClick={() => setShowCompose(false)} style={S.btnCancel}>Annulla</button>
            </div>
          </div>
        )}

        {/* ALLEGATI MODAL */}
        {showAllegatiModal && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }} onClick={e => e.target === e.currentTarget && setShowAllegatiModal(null)}>
            <div style={{ background: T.card, borderRadius: 16, width: "100%", maxWidth: 380, padding: 20 }}>
              {showAllegatiModal === "nota" && (
                <>
                  <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 12 }}>üìù Nuova nota</div>
                  <textarea style={{ width: "100%", padding: 12, fontSize: 13, border: `1px solid ${T.bdr}`, borderRadius: 10, background: T.bg, minHeight: 100, resize: "vertical", fontFamily: FF, boxSizing: "border-box" }} placeholder="Scrivi la nota..." value={allegatiText} onChange={e => setAllegatiText(e.target.value)} autoFocus />
                  <button onClick={() => { if (allegatiText.trim()) { addAllegato("nota", allegatiText.trim()); setShowAllegatiModal(null); setAllegatiText(""); } }} style={{ ...S.btn, marginTop: 10, opacity: allegatiText.trim() ? 1 : 0.5 }}>Salva nota</button>
                </>
              )}
              {showAllegatiModal === "vocale" && (
                <>
                  <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 8, display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ width: 32, height: 32, borderRadius: 8, background: "linear-gradient(135deg, #ff3b30, #ff6b6b)", display: "inline-flex", alignItems: "center", justifyContent: "center" }}>
                      <span style={{ fontSize: 16, color: "#fff" }}>üé§</span>
                    </span>
                    <span>Nota Vocale</span>
                  </div>
                  <div style={{ textAlign: "center", padding: "16px 0" }}>
                    {/* Waveform visualizer */}
                    <div style={{ display: "flex", justifyContent: "center", alignItems: "center", gap: 2, height: 60, marginBottom: 16 }}>
                      {Array.from({ length: 32 }).map((_, i) => (
                        <div key={i} style={{
                          width: 3, borderRadius: 2,
                          background: isRecording ? "#ff3b30" : T.bdr,
                          height: isRecording ? (Math.sin(Date.now() / 200 + i * 0.5) * 0.5 + 0.5) * 40 + 8 : 8,
                          transition: "height 0.15s",
                          animation: isRecording ? `audioWave 0.6s ease-in-out infinite` : "none",
                          animationDelay: `${i * 30}ms`,
                          opacity: isRecording ? 1 : 0.3
                        }} />
                      ))}
                    </div>
                    <style>{`@keyframes audioWave { 0%,100% { height: 8px; } 50% { height: ${Math.random() * 30 + 20}px; } }`}</style>
                    {/* Timer */}
                    <div style={{ fontSize: 32, fontWeight: 700, fontFamily: FM, color: isRecording ? T.red : T.sub, marginBottom: 16, letterSpacing: 2 }}>
                      {Math.floor(recSeconds / 60)}:{String(recSeconds % 60).padStart(2, "0")}
                    </div>
                    {/* Record button */}
                    <div onClick={() => {
                      if (!isRecording) { startMediaRecording("vocale"); }
                      else { stopMediaRecording("vocale"); }
                    }} style={{ width: 70, height: 70, borderRadius: "50%", background: isRecording ? "linear-gradient(135deg, #ff3b30, #cc0000)" : "linear-gradient(135deg, #ff3b30, #ff6b6b)", display: "flex", alignItems: "center", justifyContent: "center", margin: "0 auto", cursor: "pointer", boxShadow: isRecording ? "0 0 24px rgba(255,59,48,0.5)" : "0 4px 16px rgba(255,59,48,0.3)" }}>
                      <span style={{ fontSize: 28, color: "#fff" }}>{isRecording ? "‚èπ" : "üé§"}</span>
                    </div>
                    <div style={{ fontSize: 12, color: isRecording ? T.red : T.sub, marginTop: 10, fontWeight: isRecording ? 700 : 400 }}>
                      {isRecording ? "Registrazione... tocca per fermare" : "Tocca per registrare"}
                    </div>
                  </div>
                </>
              )}
              {showAllegatiModal === "video" && (
                <>
                  <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 8, display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ width: 32, height: 32, borderRadius: 8, background: "linear-gradient(135deg, #007aff, #5856d6)", display: "inline-flex", alignItems: "center", justifyContent: "center" }}>
                      <span style={{ fontSize: 16, color: "#fff" }}>üé¨</span>
                    </span>
                    <span>Registra Video</span>
                  </div>
                  <div style={{ padding: "4px 0" }}>
                    {/* Camera preview ‚Äî always visible */}
                    <div style={{ width: "100%", height: 220, background: "#000", borderRadius: 14, marginBottom: 10, overflow: "hidden", position: "relative" as const }}>
                      <video ref={videoPreviewRef} playsInline muted autoPlay style={{ width: "100%", height: "100%", objectFit: "cover" }} />
                      {/* REC badge */}
                      {isRecording && (
                        <div style={{ position: "absolute" as const, top: 10, left: 10, display: "flex", alignItems: "center", gap: 6, background: "rgba(0,0,0,0.6)", borderRadius: 6, padding: "4px 10px" }}>
                          <div style={{ width: 10, height: 10, borderRadius: "50%", background: "#ff3b30", animation: "pulse 1s infinite" }} />
                          <span style={{ fontSize: 13, fontWeight: 700, fontFamily: FM, color: "#fff" }}>
                            {Math.floor(recSeconds / 60)}:{String(recSeconds % 60).padStart(2, "0")}
                          </span>
                        </div>
                      )}
                      {/* Camera switch hint */}
                      {!isRecording && (
                        <div style={{ position: "absolute" as const, bottom: 10, left: "50%", transform: "translateX(-50%)", background: "rgba(0,0,0,0.5)", borderRadius: 6, padding: "4px 12px" }}>
                          <span style={{ fontSize: 10, color: "#fff", fontWeight: 600 }}>üìπ Camera posteriore</span>
                        </div>
                      )}
                    </div>
                    {/* Controls */}
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 20, padding: "6px 0" }}>
                      <div onClick={() => {
                        if (!isRecording) { startMediaRecording("video"); }
                        else { stopMediaRecording("video"); }
                      }} style={{ width: 64, height: 64, borderRadius: "50%", border: "4px solid " + (isRecording ? "#ff3b30" : "#007aff"), background: isRecording ? "#ff3b30" : "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", transition: "all 0.2s" }}>
                        {isRecording
                          ? <div style={{ width: 22, height: 22, borderRadius: 4, background: "#fff" }} />
                          : <div style={{ width: 48, height: 48, borderRadius: "50%", background: "#ff3b30" }} />
                        }
                      </div>
                    </div>
                    <div style={{ textAlign: "center", fontSize: 11, color: isRecording ? T.red : T.sub, fontWeight: isRecording ? 700 : 400, marginTop: 2 }}>
                      {isRecording ? "Tocca per fermare" : "Tocca il cerchio per registrare"}
                    </div>
                  </div>
                  <style>{`@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }`}</style>
                </>
              )}
              <button onClick={() => { stopAllMedia(); clearInterval(recInterval.current); setIsRecording(false); setRecSeconds(0); setShowAllegatiModal(null); }} style={S.btnCancel}>Annulla</button>
            </div>
          </div>
        )}

        {/* CAMERA MODAL ‚Äî foto & video cattura */}
        {showCameraModal && (
          <div style={{ position: "fixed", inset: 0, zIndex: 9999, background: "#000", display: "flex", flexDirection: "column" as const }}>
            {/* Header */}
            <div style={{ padding: "10px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", background: "rgba(0,0,0,0.8)" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ fontSize: 14, color: "#fff", fontWeight: 700 }}>
                  {cameraMode === "foto" ? "üì∑ Scatta Foto" : "üé¨ Registra Video"}
                </span>
                {pendingFotoCat && <span style={{ fontSize: 10, color: "#ff9500", fontWeight: 700, background: "rgba(255,149,0,0.2)", padding: "2px 8px", borderRadius: 4 }}>{pendingFotoCat}</span>}
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                {/* Switch mode */}
                <div onClick={() => setCameraMode(cameraMode === "foto" ? "video" : "foto")}
                  style={{ padding: "4px 10px", borderRadius: 6, background: "rgba(255,255,255,0.15)", fontSize: 10, color: "#fff", fontWeight: 600, cursor: "pointer" }}>
                  {cameraMode === "foto" ? "üé¨ Video" : "üì∑ Foto"}
                </div>
                {/* Import from gallery */}
                <div onClick={() => { fotoVanoRef.current?.click(); }}
                  style={{ padding: "4px 10px", borderRadius: 6, background: "rgba(255,255,255,0.15)", fontSize: 10, color: "#fff", fontWeight: 600, cursor: "pointer" }}>
                  üñº Galleria
                </div>
                <div onClick={closeCamera}
                  style={{ padding: "4px 10px", borderRadius: 6, background: "rgba(255,59,48,0.3)", fontSize: 10, color: "#ff6b6b", fontWeight: 700, cursor: "pointer" }}>
                  ‚úï Chiudi
                </div>
              </div>
            </div>
            {/* Camera preview */}
            <div style={{ flex: 1, display: "flex", alignItems: "center", justifyContent: "center", overflow: "hidden", position: "relative" as const }}>
              <video ref={cameraPreviewRef} playsInline muted autoPlay style={{ width: "100%", height: "100%", objectFit: "cover" }} />
              {/* REC indicator for video */}
              {cameraMode === "video" && isRecording && (
                <div style={{ position: "absolute", top: 16, left: 16, display: "flex", alignItems: "center", gap: 8, background: "rgba(0,0,0,0.6)", borderRadius: 8, padding: "6px 12px" }}>
                  <div style={{ width: 12, height: 12, borderRadius: "50%", background: "#ff3b30", animation: "pulse 1s infinite" }} />
                  <span style={{ fontSize: 16, fontWeight: 700, fontFamily: FM, color: "#fff" }}>
                    {Math.floor(recSeconds / 60)}:{String(recSeconds % 60).padStart(2, "0")}
                  </span>
                </div>
              )}
              {/* Photo count badge */}
              {cameraMode === "foto" && (
                <div style={{ position: "absolute", top: 16, right: 16, background: "rgba(0,0,0,0.6)", borderRadius: 8, padding: "6px 12px" }}>
                  <span style={{ fontSize: 12, fontWeight: 700, color: "#fff" }}>
                    üì∑ {Object.values(selectedVano?.foto || {}).filter(f => f.tipo === "foto" && (!pendingFotoCat || f.categoria === pendingFotoCat)).length} scattate
                  </span>
                </div>
              )}
            </div>
            {/* Controls */}
            <div style={{ padding: "16px 0 24px", background: "rgba(0,0,0,0.8)", display: "flex", alignItems: "center", justifyContent: "center", gap: 32 }}>
              {cameraMode === "foto" ? (
                <div onClick={capturePhoto}
                  style={{ width: 72, height: 72, borderRadius: "50%", border: "4px solid #fff", background: "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                  <div style={{ width: 58, height: 58, borderRadius: "50%", background: "#fff" }} />
                </div>
              ) : (
                <div onClick={() => { if (!isRecording) startCameraVideoRec(); else stopCameraVideoRec(); }}
                  style={{ width: 72, height: 72, borderRadius: "50%", border: "4px solid #fff", background: "transparent", display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer" }}>
                  {isRecording
                    ? <div style={{ width: 26, height: 26, borderRadius: 4, background: "#ff3b30" }} />
                    : <div style={{ width: 58, height: 58, borderRadius: "50%", background: "#ff3b30" }} />
                  }
                </div>
              )}
            </div>
            <style>{`@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }`}</style>
          </div>
        )}

        {/* AI PHOTO MODAL */}
        {/* AI PHOTO MODAL */}
        {showAIPhoto && (
          <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 200, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }} onClick={e => e.target === e.currentTarget && setShowAIPhoto(false)}>
            <div style={{ background: T.card, borderRadius: 16, width: "100%", maxWidth: 380, padding: 20, maxHeight: "80vh", overflowY: "auto" }}>
              {aiPhotoStep === 0 && (
                <>
                  <div style={{ textAlign: "center", marginBottom: 16 }}>
                    <div style={{ width: 60, height: 60, borderRadius: 16, background: "linear-gradient(135deg, #af52de, #007aff)", display: "flex", alignItems: "center", justifyContent: "center", margin: "0 auto 12px", fontSize: 28 }}>ü§ñ</div>
                    <div style={{ fontSize: 17, fontWeight: 800, color: "#af52de" }}>AI Misure da Foto</div>
                    <div style={{ fontSize: 12, color: T.sub, marginTop: 4 }}>Inquadra il vano "{selectedVano?.nome}" e l'AI analizzer√† l'immagine</div>
                  </div>
                  <div style={{ position: "relative", height: 200, borderRadius: 12, overflow: "hidden", marginBottom: 12, background: "#000", display: "flex", alignItems: "center", justifyContent: "center" }}>
                    <div style={{ position: "absolute", inset: 20, border: "2px solid #af52de80", borderRadius: 8 }} />
                    <div style={{ position: "absolute", left: "50%", top: 0, bottom: 0, width: 1, background: "#af52de30" }} />
                    <div style={{ position: "absolute", top: "50%", left: 0, right: 0, height: 1, background: "#af52de30" }} />
                    <div style={{ color: "#af52de", fontSize: 12, fontWeight: 600, textAlign: "center", zIndex: 1 }}>üì∑ Simulazione fotocamera<br /><span style={{ fontSize: 10, color: "#af52de80" }}>Inquadra il serramento</span></div>
                  </div>
                  <button onClick={() => { setAiPhotoStep(1); setTimeout(() => setAiPhotoStep(2), 2000 + Math.random() * 1500); }} style={{ width: "100%", padding: 12, borderRadius: 10, border: "none", background: "linear-gradient(135deg, #af52de, #007aff)", color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: FF, marginBottom: 8 }}>
                    üì∏ Scatta e analizza
                  </button>
                  <button onClick={() => setShowAIPhoto(false)} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: FF, color: T.sub }}>Annulla</button>
                </>
              )}
              {aiPhotoStep === 1 && (
                <div style={{ textAlign: "center", padding: "40px 0" }}>
                  <div style={{ width: 60, height: 60, borderRadius: "50%", border: "4px solid #af52de20", borderTopColor: "#af52de", margin: "0 auto 16px", animation: "spin 1s linear infinite" }} />
                  <style>{`@keyframes spin { to { transform: rotate(360deg) } }`}</style>
                  <div style={{ fontSize: 15, fontWeight: 700, color: "#af52de" }}>Analisi AI in corso...</div>
                  <div style={{ fontSize: 11, color: T.sub, marginTop: 4 }}>Rilevamento bordi ¬∑ Edge detection ¬∑ Stima dimensioni</div>
                  <div style={{ fontSize: 10, color: T.sub, marginTop: 8 }}>Analizzando "{selectedVano?.nome}"...</div>
                </div>
              )}
              {aiPhotoStep === 2 && (
                <>
                  <div style={{ textAlign: "center", marginBottom: 16 }}>
                    <div style={{ fontSize: 36, marginBottom: 8 }}>‚úÖ</div>
                    <div style={{ fontSize: 15, fontWeight: 800, color: T.grn }}>Analisi completata!</div>
                    <div style={{ fontSize: 11, color: T.sub, marginTop: 4 }}>Misure suggerite per "{selectedVano?.nome}" (verifica con metro)</div>
                  </div>
                  <div style={{ borderRadius: 10, border: `1px solid ${T.bdr}`, overflow: "hidden", marginBottom: 12 }}>
                    {[["Larghezza stimata", `~${_aiBaseW} mm`, T.acc], ["Altezza stimata", `~${_aiBaseH} mm`, T.blue], ["Tipo rilevato", _aiTip, T.purple]].map(([l, val, col]) => (
                      <div key={String(l)} style={{ display: "flex", justifyContent: "space-between", padding: "10px 14px", borderBottom: `1px solid ${T.bdr}`, alignItems: "center" }}>
                        <span style={{ fontSize: 12, color: T.sub }}>{l}</span>
                        <span style={{ fontSize: 14, fontWeight: 700, fontFamily: FM, color: String(col) }}>{val}</span>
                      </div>
                    ))}
                  </div>
                  <div style={{ padding: "8px 12px", borderRadius: 8, background: "#fff3e0", border: "1px solid #ffe0b2", marginBottom: 12, fontSize: 10, color: "#e65100" }}>
                    ‚ö†Ô∏è Le misure AI sono approssimative. Usa sempre il metro laser per le misure definitive.
                  </div>
                  <button onClick={() => {
                    if (selectedVano) {
                      updateMisura(selectedVano.id, "lAlto", _aiBaseW + Math.floor(Math.random() * 5 - 2));
                      updateMisura(selectedVano.id, "lCentro", _aiBaseW);
                      updateMisura(selectedVano.id, "lBasso", _aiBaseW - Math.floor(Math.random() * 4));
                      updateMisura(selectedVano.id, "hSx", _aiBaseH);
                      updateMisura(selectedVano.id, "hCentro", _aiBaseH + Math.floor(Math.random() * 3 - 1));
                      updateMisura(selectedVano.id, "hDx", _aiBaseH - Math.floor(Math.random() * 4));
                    }
                    setShowAIPhoto(false);
                  }} style={{ width: "100%", padding: 12, borderRadius: 10, border: "none", background: "linear-gradient(135deg, #af52de, #007aff)", color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: FF, marginBottom: 8 }}>
                    ‚úÖ Applica misure suggerite
                  </button>
                  <button onClick={() => setShowAIPhoto(false)} style={{ width: "100%", padding: 10, borderRadius: 8, border: `1px solid ${T.bdr}`, background: T.card, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: FF, color: T.sub }}>Solo anteprima, non applicare</button>
                </>
              )}
            </div>
          </div>
        )}
      {/* === PAYWALL MODAL === */}
      {showPaywall && (
        <div onClick={() => setShowPaywall(null)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 10000, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}>
          <div onClick={e => e.stopPropagation()} style={{ background: T.card, borderRadius: 16, maxWidth: 360, width: "100%", overflow: "hidden" }}>
            <div style={{ padding: "20px 20px 12px", textAlign: "center" as const }}>
              <div style={{ fontSize: 40, marginBottom: 8 }}>üíé</div>
              <div style={{ fontSize: 18, fontWeight: 800, color: T.text, marginBottom: 6 }}>Passa a un piano superiore</div>
              <div style={{ fontSize: 13, color: T.sub, lineHeight: 1.5 }}>{showPaywall}</div>
            </div>
            <div style={{ padding: "12px 20px 20px", display: "flex", flexDirection: "column" as const, gap: 8 }}>
              <div onClick={() => { setShowPaywall(null); setSettingsTab("piano"); setTab("settings"); }}
                style={{ padding: 12, borderRadius: 10, background: T.acc, textAlign: "center" as const, fontSize: 14, fontWeight: 700, color: "#fff", cursor: "pointer" }}>
                Vedi piani disponibili
              </div>
              <div onClick={() => setShowPaywall(null)}
                style={{ padding: 10, borderRadius: 8, textAlign: "center" as const, fontSize: 12, fontWeight: 600, color: T.sub, cursor: "pointer" }}>
                Non ora
              </div>
            </div>
          </div>
        </div>
      )}
      {/* === üì• INBOX DOCUMENTI ‚Äî Modal globale === */}
      {showContabilita && renderContabilita()}
        {showInboxDoc && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.6)", zIndex: 10001, display: "flex", alignItems: "flex-end", justifyContent: "center" }}>
          <style>{`@keyframes spin { to { transform: rotate(360deg) } }`}</style>
          <div style={{ background: T.card, borderRadius: "20px 20px 0 0", maxWidth: 500, width: "100%", maxHeight: "85vh", overflowY: "auto", padding: "20px 20px 30px" }}>
            {/* Header */}
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
              <div style={{ fontSize: 18, fontWeight: 800, color: T.text }}>üì• Documento in Arrivo</div>
              <div onClick={() => { setShowInboxDoc(false); setInboxResult(null); }} style={{ width: 30, height: 30, borderRadius: "50%", background: T.bg, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", fontSize: 14 }}>‚úï</div>
            </div>

            {/* Loading */}
            {inboxResult?.stato === "caricamento" && (
              <div style={{ textAlign: "center", padding: 30 }}>
                <div style={{ fontSize: 36, animation: "spin 1s linear infinite", display: "inline-block" }}>üìÑ</div>
                <div style={{ fontSize: 14, fontWeight: 700, color: T.text, marginTop: 8 }}>Caricamento...</div>
                <div style={{ fontSize: 12, color: T.sub, marginTop: 4 }}>{inboxResult.file}</div>
              </div>
            )}

            {/* AI Analysis */}
            {inboxResult?.stato === "analisi" && (
              <div style={{ textAlign: "center", padding: 30 }}>
                <div style={{ fontSize: 36, animation: "spin 1s linear infinite", display: "inline-block" }}>ü§ñ</div>
                <div style={{ fontSize: 14, fontWeight: 700, color: "#af52de", marginTop: 8 }}>AI sta leggendo il documento...</div>
                <div style={{ fontSize: 11, color: T.sub, marginTop: 4 }}>Estraggo: totale, consegna, pagamento, articoli</div>
              </div>
            )}

            {/* Results */}
            {inboxResult?.stato === "completato" && (
              <div>
                {/* File info + classification */}
                <div style={{ ...S.card, padding: 12, marginBottom: 12, display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ fontSize: 28 }}>{inboxResult.tipo?.includes("pdf") ? "üìÑ" : "üì∑"}</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: T.text }}>{inboxResult.file}</div>
                    {inboxResult.fileUrl && <div onClick={() => window.open(inboxResult.fileUrl, "_blank")} style={{ fontSize: 10, color: "#007aff", cursor: "pointer", marginTop: 2 }}>üîó Apri originale</div>}
                  </div>
                </div>

                {/* AI Classification badge */}
                {(() => {
                  const tipoLabels: any = { firma: "‚úçÔ∏è Preventivo Firmato", conferma: "üìÑ Conferma Fornitore", fattura: "üí∞ Fattura", ricevuta: "üè¶ Ricevuta Pagamento", foto: "üì∑ Foto Cantiere", sconosciuto: "‚ùì Documento" };
                  const tipoColors: any = { firma: "#34c759", conferma: "#af52de", fattura: "#007aff", ricevuta: "#ff9500", foto: "#5856d6", sconosciuto: "#86868b" };
                  const col = tipoColors[inboxResult.docTipo] || "#86868b";
                  return (
                    <div style={{ ...S.card, padding: 12, marginBottom: 12, background: col + "10", border: `2px solid ${col}30` }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                        <span style={{ fontSize: 11, fontWeight: 800, color: col, textTransform: "uppercase" }}>ü§ñ MASTRO ha classificato:</span>
                        <span style={{ fontSize: 10, color: T.sub }}>{inboxResult.confidence}% sicuro</span>
                      </div>
                      <div style={{ fontSize: 16, fontWeight: 900, color: col }}>{tipoLabels[inboxResult.docTipo] || "Documento"}</div>
                      {inboxResult.matchedCommessa && (
                        <div style={{ fontSize: 12, color: T.text, marginTop: 4 }}>
                          ‚Üí <b>{inboxResult.matchedCommessa.code} ‚Äî {inboxResult.matchedCommessa.cliente} {inboxResult.matchedCommessa.cognome || ""}</b>
                        </div>
                      )}
                    </div>
                  );
                })()}

                {/* Extracted data (for conferma) */}
                {inboxResult.dati && (inboxResult.dati.fornitoreNome || inboxResult.dati.totale > 0 || inboxResult.dati.settimane > 0) && (
                  <div style={{ ...S.card, padding: 12, marginBottom: 12, background: "#af52de08", border: `1px solid #af52de20` }}>
                    <div style={{ fontSize: 11, fontWeight: 800, color: "#af52de", textTransform: "uppercase", marginBottom: 8 }}>ü§ñ Dati Estratti</div>
                    {inboxResult.dati.fornitoreNome && <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "3px 0" }}><span style={{ color: T.sub }}>Fornitore</span><b>{inboxResult.dati.fornitoreNome}</b></div>}
                    {inboxResult.dati.totale > 0 && <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "3px 0" }}><span style={{ color: T.sub }}>Totale</span><b style={{ color: "#af52de" }}>‚Ç¨{inboxResult.dati.totale.toLocaleString("it-IT", { minimumFractionDigits: 2 })}</b></div>}
                    {inboxResult.dati.settimane > 0 && <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "3px 0" }}><span style={{ color: T.sub }}>Produzione</span><b>{inboxResult.dati.settimane} settimane</b></div>}
                    {inboxResult.dati.dataConsegna && <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, padding: "3px 0" }}><span style={{ color: T.sub }}>Consegna</span><b>{new Date(inboxResult.dati.dataConsegna).toLocaleDateString("it-IT")}</b></div>}
                  </div>
                )}

                {/* === CONFERMA type: assign to ordine === */}
                {inboxResult.docTipo === "conferma" && inboxResult.matchedOrdine && (
                  <div style={{ ...S.card, padding: 12, marginBottom: 12, background: "#34c75908", border: `2px solid #34c759` }}>
                    <div style={{ fontSize: 11, fontWeight: 800, color: "#34c759", marginBottom: 6 }}>‚úÖ ORDINE TROVATO</div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>{inboxResult.matchedCommessa?.code} ‚Äî {inboxResult.matchedCommessa?.cliente}</div>
                    <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{inboxResult.matchedOrdine.fornitore?.nome || "‚Äî"} ¬∑ ‚Ç¨{(inboxResult.matchedOrdine.totaleIva || 0).toLocaleString("it-IT")}</div>
                    <button onClick={() => confermaInboxDoc(inboxResult.matchedOrdine.id)} style={{ width: "100%", marginTop: 10, padding: 14, borderRadius: 12, border: "none", background: "#34c759", color: "#fff", fontSize: 15, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                      ‚úÖ ASSEGNA A QUESTO ORDINE
                    </button>
                  </div>
                )}
                {inboxResult.docTipo === "conferma" && inboxResult.tuttiOrdini?.filter(o => o.id !== inboxResult.matchedOrdine?.id).length > 0 && (
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>{inboxResult.matchedOrdine ? "Oppure scegli un altro ordine:" : "A quale ordine appartiene?"}</div>
                    {inboxResult.tuttiOrdini.filter(o => o.id !== inboxResult.matchedOrdine?.id).map(o => {
                      const cm = cantieri.find(c => c.id === o.cmId);
                      return (
                        <div key={o.id} onClick={() => confermaInboxDoc(o.id)} style={{ ...S.card, padding: "10px 12px", marginBottom: 6, cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center", border: `1px solid ${T.bdr}` }}>
                          <div><div style={{ fontSize: 12, fontWeight: 700 }}>{cm?.code} ‚Äî {cm?.cliente}</div><div style={{ fontSize: 10, color: T.sub }}>{o.fornitore?.nome || "‚Äî"}</div></div>
                          <div style={{ fontSize: 11, fontWeight: 700, color: T.acc }}>‚Ç¨{(o.totaleIva || 0).toLocaleString("it-IT")}</div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* === FIRMA / RICEVUTA / FOTO type: assign to commessa === */}
                {(inboxResult.docTipo === "firma" || inboxResult.docTipo === "ricevuta" || inboxResult.docTipo === "foto" || inboxResult.docTipo === "sconosciuto") && (
                  <div>
                    {inboxResult.matchedCommessa && (
                      <div style={{ ...S.card, padding: 12, marginBottom: 12, background: "#34c75908", border: `2px solid #34c759` }}>
                        <div style={{ fontSize: 11, fontWeight: 800, color: "#34c759", marginBottom: 6 }}>‚úÖ COMMESSA TROVATA</div>
                        <div style={{ fontSize: 14, fontWeight: 700 }}>{inboxResult.matchedCommessa.code} ‚Äî {inboxResult.matchedCommessa.cliente} {inboxResult.matchedCommessa.cognome || ""}</div>
                        <div style={{ fontSize: 11, color: T.sub, marginTop: 2 }}>{inboxResult.matchedCommessa.indirizzo || "‚Äî"}</div>
                        <button onClick={() => assegnaDocUniversale(inboxResult.matchedCommessa.id, inboxResult.docTipo)} style={{ width: "100%", marginTop: 10, padding: 14, borderRadius: 12, border: "none", background: "#34c759", color: "#fff", fontSize: 15, fontWeight: 800, cursor: "pointer", fontFamily: "inherit" }}>
                          ‚úÖ ASSEGNA QUI
                        </button>
                      </div>
                    )}
                    {/* All commesse for manual selection */}
                    <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 8 }}>
                      {inboxResult.matchedCommessa ? "Oppure scegli un'altra commessa:" : "A quale commessa appartiene?"}
                    </div>
                    {(inboxResult.commesseAttive || cantieri).filter(cm => cm.id !== inboxResult.matchedCommessa?.id).map(cm => (
                      <div key={cm.id} onClick={() => assegnaDocUniversale(cm.id, inboxResult.docTipo)} style={{ ...S.card, padding: "10px 12px", marginBottom: 6, cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center", border: `1px solid ${T.bdr}` }}>
                        <div>
                          <div style={{ fontSize: 12, fontWeight: 700 }}>{cm.code} ‚Äî {cm.cliente} {cm.cognome || ""}</div>
                          <div style={{ fontSize: 10, color: T.sub }}>{cm.fase} ¬∑ {cm.indirizzo || "‚Äî"}</div>
                        </div>
                        <span style={{ fontSize: 16 }}>‚Üí</span>
                      </div>
                    ))}
                  </div>
                )}

                {/* Change classification */}
                <div style={{ marginTop: 12, padding: 10, borderRadius: 10, background: T.bg, textAlign: "center" }}>
                  <div style={{ fontSize: 10, fontWeight: 700, color: T.sub, marginBottom: 6 }}>Classificazione sbagliata? Scegli il tipo:</div>
                  <div style={{ display: "flex", gap: 4, justifyContent: "center", flexWrap: "wrap" as any }}>
                    {[
                      { id: "firma", label: "‚úçÔ∏è Firma", col: "#34c759" },
                      { id: "conferma", label: "üìÑ Conferma", col: "#af52de" },
                      { id: "ricevuta", label: "üè¶ Ricevuta", col: "#ff9500" },
                      { id: "foto", label: "üì∑ Foto", col: "#5856d6" },
                    ].map(t => (
                      <span key={t.id} onClick={() => setInboxResult(prev => ({ ...prev, docTipo: t.id, confidence: 100 }))} style={{
                        padding: "6px 10px", borderRadius: 8, fontSize: 10, fontWeight: 700, cursor: "pointer",
                        background: inboxResult.docTipo === t.id ? t.col : T.card,
                        color: inboxResult.docTipo === t.id ? "#fff" : T.text,
                        border: `1px solid ${inboxResult.docTipo === t.id ? t.col : T.bdr}`,
                      }}>{t.label}</span>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
      </div>

      {/* ===== DOCUMENT VIEWER MODAL ===== */}
      {docViewer && (
        <div onClick={() => setDocViewer(null)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.5)", zIndex: 10000, display: "flex", alignItems: "center", justifyContent: "center", padding: 16 }}>
          <div onClick={e => e.stopPropagation()} style={{ background: T.card, borderRadius: 16, width: "100%", maxWidth: 500, maxHeight: "80vh", overflow: "auto" }}>
            {/* Header */}
            <div style={{ padding: "16px 20px", borderBottom: `1px solid ${T.bdr}`, display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 20 }}>üìã</span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 15, fontWeight: 800, color: T.text }}>{docViewer.title}</div>
                <div style={{ fontSize: 11, color: T.sub }}>{docViewer.docs.length} document{docViewer.docs.length !== 1 ? "i" : "o"}</div>
              </div>
              <span onClick={() => setDocViewer(null)} style={{ fontSize: 24, cursor: "pointer", color: T.sub, lineHeight: 1 }}>‚úï</span>
            </div>
            {/* Document list */}
            <div style={{ padding: 12 }}>
              {docViewer.docs.map((doc, di) => {
                const tipoColors: any = { firma: "#34c759", fattura: "#007aff", ordine: "#ff9500", conferma: "#af52de", rilievo: "#5856d6", preventivo: "#ff2d55", montaggio: "#007aff", verbale: "#34c759" };
                const col = tipoColors[doc.tipo] || T.acc;
                return (
                  <div key={di} style={{ padding: 14, marginBottom: 8, borderRadius: 12, border: `1px solid ${T.bdr}`, background: T.bg }}>
                    <div style={{ display: "flex", alignItems: "flex-start", gap: 10 }}>
                      <div style={{ width: 40, height: 40, borderRadius: 10, background: col + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, flexShrink: 0 }}>
                        {doc.tipo === "firma" ? "‚úçÔ∏è" : doc.tipo === "fattura" ? "üí∞" : doc.tipo === "ordine" ? "üì¶" : doc.tipo === "conferma" ? "üìÑ" : doc.tipo === "rilievo" ? "üìê" : doc.tipo === "preventivo" ? "üìã" : doc.tipo === "montaggio" ? "üîß" : "üìé"}
                      </div>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontSize: 13, fontWeight: 700, color: T.text, marginBottom: 2 }}>{doc.nome}</div>
                        <div style={{ fontSize: 11, color: T.sub }}>{doc.detail || ""}</div>
                        {doc.data && <div style={{ fontSize: 10, color: T.sub, marginTop: 2 }}>üìÖ {doc.data}</div>}
                      </div>
                      <span style={{ fontSize: 10, fontWeight: 700, color: col, background: col + "15", padding: "2px 8px", borderRadius: 6, textTransform: "uppercase" as any }}>{doc.tipo}</span>
                    </div>
                    {/* Action buttons */}
                    <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
                      {doc.dataUrl ? (
                        <a href={doc.dataUrl} download={doc.nome} style={{ flex: 1, padding: 8, borderRadius: 8, border: `1px solid ${col}`, background: col + "08", color: col, fontSize: 11, fontWeight: 700, cursor: "pointer", textAlign: "center", textDecoration: "none" }}>
                          ‚¨áÔ∏è Scarica
                        </a>
                      ) : (
                        <button onClick={() => { alert(`In produzione questo aprir√† il file "${doc.nome}" da Supabase Storage.\n\nNella demo i documenti sono simulati.`); }} style={{ flex: 1, padding: 8, borderRadius: 8, border: `1px solid ${col}`, background: col + "08", color: col, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                          üëÅ Visualizza
                        </button>
                      )}
                      <button onClick={() => {
                        const tel = (selectedCM?.telefono || "").replace(/\D/g, "");
                        window.open(`https://wa.me/${tel.startsWith("39") ? tel : "39" + tel}?text=${encodeURIComponent(`Ecco il documento: ${doc.nome}`)}`, "_blank");
                      }} style={{ flex: 1, padding: 8, borderRadius: 8, border: `1px solid #25d366`, background: "#25d36608", color: "#25d366", fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>
                        üí¨ WhatsApp
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
            {/* All attachments */}
            
                {/* ‚ïê‚ïê‚ïê CRONOLOGIA ‚ïê‚ïê‚ïê */}
                <div style={{ marginTop: 12 }}>
                  <div onClick={() => setShowCronologia(!showCronologia)} style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer", padding: "8px 0" }}>
                    <span style={{ fontSize: 11 }}>üìú</span>
                    <span style={{ fontSize: 11, fontWeight: 700, color: T.text }}>Cronologia ({(c.log || []).length})</span>
                    <span style={{ marginLeft: "auto", fontSize: 10, color: T.sub }}>{showCronologia ? "‚ñ≤" : "‚ñº"}</span>
                  </div>
                  {showCronologia && (c.log || []).slice().reverse().map((l, i) => (
                    <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0", borderBottom: `1px solid ${T.bg}`, fontSize: 11 }}>
                      <div style={{ width: 5, height: 5, borderRadius: "50%", background: l.color || T.acc, marginTop: 5, flexShrink: 0 }} />
                      <div><b>{l.chi}</b> {l.cosa} <span style={{ color: T.sub, fontSize: 9 }}>{l.quando}</span></div>
                    </div>
                  ))}
                </div>

                {selectedCM && (selectedCM.allegati || []).length > 0 && (
              <div style={{ padding: "0 12px 16px" }}>
                <div style={{ fontSize: 11, fontWeight: 700, color: T.sub, marginBottom: 6 }}>üìé TUTTI GLI ALLEGATI COMMESSA ({selectedCM.allegati.length})</div>
                {(selectedCM.allegati || []).map((a: any, ai: number) => (
                  <div key={ai} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", borderBottom: ai < selectedCM.allegati.length - 1 ? `1px solid ${T.bdr}` : "none" }}>
                    <span style={{ fontSize: 14 }}>{a.tipo === "firma" ? "‚úçÔ∏è" : a.tipo === "fattura" ? "üí∞" : a.tipo === "ordine" ? "üì¶" : "üìé"}</span>
                    <div style={{ flex: 1, fontSize: 11, color: T.text, fontWeight: 600 }}>{a.nome}</div>
                    <span style={{ fontSize: 10, color: T.sub }}>{a.data}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </>
  );
}


